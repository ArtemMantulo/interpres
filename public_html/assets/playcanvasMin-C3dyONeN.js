var R3=(m,on)=>()=>(on||m((on={exports:{}}).exports,on),on.exports);var O3=R3((bh,LC)=>{/**
 * @license
 * PlayCanvas Engine v2.8.2 revision 9dcece8 (RELEASE)
 * Copyright 2011-2025 PlayCanvas Ltd. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Im,xh,Lm;function Q(m,on){return on!=null&&typeof Symbol<"u"&&on[Symbol.hasInstance]?!!on[Symbol.hasInstance](m):m instanceof on}Im=void 0,xh=function(m){var on,Dm,Nl,Mm,Rm,Om,km,Nm,ja,ln,Th,Fl,Xa,Eh,wh,Ah,Ul,As,Bl,Vl,Ya,Zi,Ch,zl,xt,Sn,Pr,Cs,Ps,Vt,be,xn,Is,ci,hi,Gl,Ph,Ct,Qi,Ji,Ih=typeof document<"u"?document.currentScript:null;function fi(o,a,i){o.prototype[a]||Object.defineProperty(o.prototype,a,{value:i,configurable:!0,enumerable:!1,writable:!0})}if(fi(Array,"fill",function(o){if(this==null)throw TypeError("this is null or not defined");for(var a=Object(this),i=a.length>>>0,t=arguments[1],e=0|t,n=e<0?Math.max(i+e,0):Math.min(e,i),r=arguments[2],s=r===void 0?i:0|r,l=s<0?Math.max(i+s,0):Math.min(s,i);n<l;)a[n]=o,n++;return a}),fi(Array,"find",function(o){if(this==null)throw TypeError('"this" is null or not defined');var a=Object(this),i=a.length>>>0;if(typeof o!="function")throw TypeError("predicate must be a function");for(var t=arguments[1],e=0;e<i;){var n=a[e];if(o.call(t,n,e,a))return n;e++}}),fi(Array,"findIndex",function(o){if(this==null)throw TypeError('"this" is null or not defined');var a=Object(this),i=a.length>>>0;if(typeof o!="function")throw TypeError("predicate must be a function");for(var t=arguments[1],e=0;e<i;){var n=a[e];if(o.call(t,n,e,a))return e;e++}return-1}),Math.log2=Math.log2||function(o){return Math.log(o)*Math.LOG2E},Math.sign||(Math.sign=function(o){return(o>0)-(o<0)||+o}),Number.isFinite===void 0&&(Number.isFinite=function(o){return typeof o=="number"&&isFinite(o)}),typeof Object.assign!="function"&&Object.defineProperty(Object,"assign",{value:function(o,a){if(o==null)throw TypeError("Cannot convert undefined or null to object");for(var i=Object(o),t=1;t<arguments.length;t++){var e=arguments[t];if(e!=null)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(i[n]=e[n])}return i},writable:!0,configurable:!0}),Object.fromEntries=Object.fromEntries||function(o){if(!o||!o[Symbol.iterator])throw Error("Object.fromEntries() requires a single iterable argument");for(var a={},i=0;i<o.length;i++)a[o[i][0]]=o[i][1];return a},Object.entries=Object.entries||function(o){for(var a=Object.keys(o),i=a.length,t=Array(i);i--;)t[i]=[a[i],o[a[i]]];return t},Object.values=Object.values||function(o){return Object.keys(o).map(function(a){return o[a]})},typeof navigator<"u"&&typeof document<"u"){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var qa=function(){var o=document.createEvent("CustomEvent");o.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(o)},Lh=function(){var o=document.createEvent("CustomEvent");o.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(o)};document.addEventListener("webkitpointerlockchange",qa,!1),document.addEventListener("webkitpointerlocklost",qa,!1),document.addEventListener("mozpointerlockchange",qa,!1),document.addEventListener("mozpointerlocklost",qa,!1),document.addEventListener("webkitpointerlockerror",Lh,!1),document.addEventListener("mozpointerlockerror",Lh,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,qa,Lh)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}function Fm(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}fi(String,"endsWith",function(o,a){return(a===void 0||a>this.length)&&(a=this.length),this.substring(a-o.length,a)===o}),fi(String,"includes",function(o,a){return typeof a!="number"&&(a=0),!(a+o.length>this.length)&&this.indexOf(o,a)!==-1}),fi(String,"startsWith",function(o,a){var i=a>0?0|a:0;return this.substring(i,i+o.length)===o}),fi(String,"trimEnd",function(){return this.replace(RegExp(/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/.source+"$","g"),"")});for(var Um,DC=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],MC=function(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return Fm(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Fm(e,void 0)}}(o))){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(DC);!(Um=MC()).done;){var Bm=Um.value;fi(Bm,"fill",Array.prototype.fill),fi(Bm,"join",Array.prototype.join)}var Vm="GpuTimings",Dh="2.8.2",zm="9dcece8";function Ka(o,a){for(var i in a){var t=a[i];Array.isArray(t)?o[i]=Ka([],t):t&&(t===void 0?"undefined":t&&typeof Symbol<"u"&&t.constructor===Symbol?"symbol":typeof t)=="object"?o[i]=Ka({},t):o[i]=t}return o}var Gm={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var a=16*Math.random()|0;return(o==="x"?a:3&a|8).toString(16)})}},ce={delimiter:"/",join:function(){for(var o=arguments.length,a=Array(o),i=0;i<o;i++)a[i]=arguments[i];for(var t=a[0],e=0;e<a.length-1;e++){var n=a[e],r=a[e+1];if(r[0]===ce.delimiter){t=r;continue}n&&r&&n[n.length-1]!==ce.delimiter&&r[0]!==ce.delimiter?t+=ce.delimiter+r:t+=r}return t},normalize:function(o){for(var a=o.startsWith(ce.delimiter),i=o.endsWith(ce.delimiter),t=o.split("/"),e="",n=[],r=0;r<t.length;r++)if(t[r]!==""&&t[r]!=="."){if(t[r]===".."&&n.length>0){n=n.slice(0,n.length-2);continue}r>0&&n.push(ce.delimiter),n.push(t[r])}return e=n.join(""),a||e[0]!==ce.delimiter||(e=e.slice(1)),i&&e[e.length-1]!==ce.delimiter&&(e+=ce.delimiter),e},split:function(o){var a=o.lastIndexOf(ce.delimiter);return a!==-1?[o.substring(0,a),o.substring(a+1)]:["",o]},getBasename:function(o){return ce.split(o)[1]},getDirectory:function(o){return ce.split(o)[0]},getExtension:function(o){var a=o.split("?")[0].split(".").pop();return a!==o?"."+a:""},isRelativePath:function(o){return o.charAt(0)!=="/"&&o.match(/:\/\//)===null},extractPath:function(o){var a="",i=o.split("/"),t=0;if(i.length>1)if(ce.isRelativePath(o))if(i[0]===".")for(t=0;t<i.length-1;++t)a+=t===0?i[t]:"/"+i[t];else if(i[0]==="..")for(t=0;t<i.length-1;++t)a+=t===0?i[t]:"/"+i[t];else for(t=0,a=".";t<i.length-1;++t)a+="/"+i[t];else for(t=0;t<i.length-1;++t)a+=t===0?i[t]:"/"+i[t];return a}},Bn=typeof navigator<"u"?navigator.userAgent:"",di=typeof window<"u"?"browser":typeof global<"u"?"node":"worker",Za=/android/i.test(Bn)?"android":/ip(?:[ao]d|hone)/i.test(Bn)?"ios":/windows/i.test(Bn)?"windows":/mac os/i.test(Bn)?"osx":/linux/i.test(Bn)?"linux":/cros/i.test(Bn)?"cros":null,RC=di!=="browser"?null:/Chrome\/|Chromium\/|Edg.*\//.test(Bn)?"chrome":/Safari\//.test(Bn)?"safari":/Firefox\//.test(Bn)?"firefox":"other",OC=/xbox/i.test(Bn),kC=di==="browser"&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),NC=di==="browser"&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),FC=typeof Worker<"u",UC=function(){var o=!1;try{var a=Object.defineProperty({},"passive",{get:function(){return o=!0,!1}});window.addEventListener("testpassive",null,a),window.removeEventListener("testpassive",null,a)}catch{}return o}(),fe={name:Za,environment:di,global:(Nm=(km=(Om=typeof globalThis<"u"&&globalThis)!=null?Om:di==="browser"&&window)!=null?km:di==="node"&&global)!=null?Nm:di==="worker"&&self,browser:di==="browser",worker:di==="worker",desktop:["windows","osx","linux","cros"].includes(Za),mobile:["android","ios"].includes(Za),ios:Za==="ios",android:Za==="android",xbox:OC,gamepads:NC,touch:kC,workers:FC,passiveEvents:UC,browserName:RC},Hm="abcdefghijklmnopqrstuvwxyz",Wm="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function Mh(o,a){a===void 0&&(a=0);var i=o.length;if(a<0||a>=i)return null;var t=o.charCodeAt(a);if(i>1&&t>=55296&&t<=56319){var e=o.charCodeAt(a+1);if(e>=56320&&e<=57343)return{code:(t-55296)*1024+e-56320+65536,long:!0}}return{code:t,long:!1}}function $i(o,a,i){if(!o)return!1;var t=Mh(o);if(t){var e=t.code;return e>=a&&e<=i}return!1}var er={ASCII_LOWERCASE:Hm,ASCII_UPPERCASE:Wm,ASCII_LETTERS:Hm+Wm,format:function(o){for(var a=arguments.length,i=Array(a>1?a-1:0),t=1;t<a;t++)i[t-1]=arguments[t];for(var e=0;e<i.length;e++)o=o.replace("{"+e+"}",i[e]);return o},getCodePoint:function(o,a){var i=Mh(o,a);return i&&i.code},getCodePoints:function(o){if(typeof o!="string")throw TypeError("Not a string");for(var a,i=0,t=[];a=Mh(o,i);)t.push(a.code),i+=a.long?2:1;return t},getSymbols:function(o){if(typeof o!="string")throw TypeError("Not a string");for(var a,i=0,t=o.length,e=[],n=0;i<t;){if(n+=function(s,l){if(l===s.length-1)return 1;if($i(s[l],55296,56319)){var u=s.substring(l,l+2),c=s.substring(l+2,l+4);return $i(c,127995,127999)||$i(u,127462,127487)&&$i(c,127462,127487)?4:$i(c,65024,65039)?3:2}return $i(s[l+1],65024,65039)?2:1}(o,i+n),$i(a=o[i+n],8400,8447)&&(a=o[i+n++]),$i(a,65024,65039)&&(a=o[i+n++]),a&&a.charCodeAt(0)===8205){a=o[i+n++];continue}var r=o.substring(i,i+n);e.push(r),i+=n,n=0}return e},fromCodePoint:function(){for(var o=arguments.length,a=Array(o),i=0;i<o;i++)a[i]=arguments[i];return a.map(function(t){return t>65535?String.fromCharCode(((t-=65536)>>10)+55296,t%1024+56320):String.fromCharCode(t)}).join("")}},jm=function(){function o(t,e,n,r,s){s===void 0&&(s=!1),this._removed=!1,this.handler=t,this.name=e,this.callback=n,this.scope=r,this._once=s}var a,i=o.prototype;return i.off=function(){this._removed||this.handler.offByHandle(this)},i.on=function(t,e,n){return n===void 0&&(n=this),this.handler._addCallback(t,e,n,!1)},i.once=function(t,e,n){return n===void 0&&(n=this),this.handler._addCallback(t,e,n,!0)},i.toJSON=function(t){},a=[{key:"removed",get:function(){return this._removed},set:function(t){t&&(this._removed=!0)}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function Xm(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Ym(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return Xm(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Xm(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var se=function(){function o(){this._callbacks=new Map,this._callbackActive=new Map}var a=o.prototype;return a.initEventHandler=function(){this._callbacks=new Map,this._callbackActive=new Map},a._addCallback=function(i,t,e,n){if(this._callbacks.has(i)||this._callbacks.set(i,[]),this._callbackActive.has(i)){var r=this._callbackActive.get(i);r&&r===this._callbacks.get(i)&&this._callbackActive.set(i,r.slice())}var s=new jm(this,i,t,e,n);return this._callbacks.get(i).push(s),s},a.on=function(i,t,e){return e===void 0&&(e=this),this._addCallback(i,t,e,!1)},a.once=function(i,t,e){return e===void 0&&(e=this),this._addCallback(i,t,e,!0)},a.off=function(i,t,e){if(i)this._callbackActive.has(i)&&this._callbackActive.get(i)===this._callbacks.get(i)&&this._callbackActive.set(i,this._callbackActive.get(i).slice());else for(var n,r=Ym(this._callbackActive);!(n=r()).done;){var s=n.value,l=s[0],u=s[1];this._callbacks.has(l)&&this._callbacks.get(l)===u&&this._callbackActive.set(l,u.slice())}if(i)if(t){var c=this._callbacks.get(i);if(!c)return this;for(var h=0;h<c.length;h++)c[h].callback===t&&(!e||c[h].scope===e)&&(c[h].removed=!0,c.splice(h,1),h--);c.length===0&&this._callbacks.delete(i)}else{var f=this._callbacks.get(i);if(f){for(var d=0;d<f.length;d++)f[d].removed=!0;this._callbacks.delete(i)}}else{for(var p,_=Ym(this._callbacks.values());!(p=_()).done;)for(var g=p.value,y=0;y<g.length;y++)g[y].removed=!0;this._callbacks.clear()}return this},a.offByHandle=function(i){var t=i.name;i.removed=!0,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());var e=this._callbacks.get(t);if(!e)return this;var n=e.indexOf(i);return n!==-1&&(e.splice(n,1),e.length===0&&this._callbacks.delete(t)),this},a.fire=function(i,t,e,n,r,s,l,u,c){if(!i)return this;var h,f=this._callbacks.get(i);if(!f)return this;this._callbackActive.has(i)?this._callbackActive.get(i)!==f&&(h=f.slice()):this._callbackActive.set(i,f);for(var d=0;(h||this._callbackActive.get(i))&&d<(h||this._callbackActive.get(i)).length;d++){var p=(h||this._callbackActive.get(i))[d];if(p.callback&&(p.callback.call(p.scope,t,e,n,r,s,l,u,c),p._once)){var _=this._callbacks.get(i),g=_?_.indexOf(p):-1;if(g!==-1){this._callbackActive.get(i)===_&&this._callbackActive.set(i,this._callbackActive.get(i).slice());var y=this._callbacks.get(i);if(!y)continue;y[g].removed=!0,y.splice(g,1),y.length===0&&this._callbacks.delete(i)}}}return h||this._callbackActive.delete(i),this},a.hasEvent=function(i){var t;return!!((t=this._callbacks.get(i))!=null&&t.length)},o}(),qm=function(){function o(){this._list=[],this._index={}}var a=o.prototype;return a.push=function(i,t){if(this._index[i])throw Error("Key already in index "+i);var e=this._list.push(t)-1;this._index[i]=e},a.has=function(i){return this._index[i]!==void 0},a.get=function(i){var t=this._index[i];return t!==void 0?this._list[t]:null},a.remove=function(i){var t=this._index[i];if(t!==void 0){for(i in this._list.splice(t,1),delete this._index[i],this._index){var e=this._index[i];e>t&&(this._index[i]=e-1)}return!0}return!1},a.list=function(){return this._list},a.clear=function(){for(var i in this._list.length=0,this._index)delete this._index[i]},o}();function Km(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var Ir=function(){function o(){}return o.loadScript=function(a,i){var t=document.createElement("script");t.setAttribute("src",a),t.onload=function(){i(null)},t.onerror=function(){i("Failed to load script='"+a+"'")},document.body.appendChild(t)},o.loadWasm=function(a,i,t){var e=o.wasmSupported()&&i.glueUrl&&i.wasmUrl?i.glueUrl:i.fallbackUrl;e?o.loadScript(e,function(n){if(n)t(n,null);else{var r=window[a];window[a]=void 0,r({locateFile:function(){return i.wasmUrl},onAbort:function(){t("wasm module aborted.")}}).then(function(s){t(null,s)})}}):t("No supported wasm modules found.",null)},o.getModule=function(a){return o.modules.hasOwnProperty(a)||(o.modules[a]={config:null,initializing:!1,instance:null,callbacks:[]}),o.modules[a]},o.initialize=function(a,i){if(!i.initializing){var t=i.config;(t.glueUrl||t.wasmUrl||t.fallbackUrl)&&(i.initializing=!0,o.loadWasm(a,t,function(e,n){e?t.errorHandler&&t.errorHandler(e):(i.instance=n,i.callbacks.forEach(function(r){r(n)}))}))}},o}();Ir.modules={},on=function(){try{var o;if((typeof WebAssembly>"u"?"undefined":(o=WebAssembly)&&typeof Symbol<"u"&&o.constructor===Symbol?"symbol":typeof o)=="object"&&typeof WebAssembly.instantiate=="function"){var a=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(Km(a,WebAssembly.Module))return Km(new WebAssembly.Instance(a),WebAssembly.Instance)}}catch{}return!1},Nl=Dm={},Ir.wasmSupported=function(){return Nl===Dm&&(Nl=on()),Nl};var Rh=function(){function o(){}return o.setConfig=function(a,i){var t=Ir.getModule(a);t.config=i,t.callbacks.length>0&&Ir.initialize(a,t)},o.getConfig=function(a){var i,t;return(t=Ir.modules)==null||(i=t[a])==null?void 0:i.config},o.getInstance=function(a,i){var t=Ir.getModule(a);t.instance?i(t.instance):(t.callbacks.push(i),t.config&&Ir.initialize(a,t))},o}(),Oh=function(){function o(t){this.offset=0,this.arraybuffer=t,this.dataView=new DataView(t)}var a,i=o.prototype;return i.reset=function(t){t===void 0&&(t=0),this.offset=t},i.skip=function(t){this.offset+=t},i.align=function(t){this.offset=this.offset+t-1&~(t-1)},i._inc=function(t){return this.offset+=t,this.offset-t},i.readChar=function(){return String.fromCharCode(this.dataView.getUint8(this.offset++))},i.readChars=function(t){for(var e="",n=0;n<t;++n)e+=this.readChar();return e},i.readU8=function(){return this.dataView.getUint8(this.offset++)},i.readU16=function(){return this.dataView.getUint16(this._inc(2),!0)},i.readU32=function(){return this.dataView.getUint32(this._inc(4),!0)},i.readU64=function(){return this.readU32()+4294967296*this.readU32()},i.readU32be=function(){return this.dataView.getUint32(this._inc(4),!1)},i.readArray=function(t){for(var e=0;e<t.length;++e)t[e]=this.readU8()},i.readLine=function(){for(var t=this.dataView,e="";!(this.offset>=t.byteLength);){var n=String.fromCharCode(this.readU8());if(n===`
`)break;e+=n}return e},a=[{key:"remainingBytes",get:function(){return this.dataView.byteLength-this.offset}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),Qa=function(){function o(i){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=i.sortBy,this._sortHandler=this._doSort.bind(this)}var a=o.prototype;return a._binarySearch=function(i){for(var t,e,n=0,r=this.items.length-1,s=i[this._sortBy];n<=r;)t=Math.floor((n+r)/2),(e=this.items[t][this._sortBy])<=s?n=t+1:e>s&&(r=t-1);return n},a._doSort=function(i,t){var e=this._sortBy;return i[e]-t[e]},a.insert=function(i){var t=this._binarySearch(i);this.items.splice(t,0,i),this.length++,this.loopIndex>=t&&this.loopIndex++},a.append=function(i){this.items.push(i),this.length++},a.remove=function(i){var t=this.items.indexOf(i);!(t<0)&&(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)},a.sort=function(){var i=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),i!==null&&(this.loopIndex=this.items.indexOf(i))},o}();function Zm(o,a){return(Zm=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ls=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._index={},n._list=[],n._parent=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Zm(a,o);var i,t=a.prototype;return t.add=function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];var s=!1,l=this._processArguments(n,!0);if(!l.length)return s;for(var u=0;u<l.length;u++)this._index[l[u]]||(s=!0,this._index[l[u]]=!0,this._list.push(l[u]),this.fire("add",l[u],this._parent));return s&&this.fire("change",this._parent),s},t.remove=function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];var s=!1;if(!this._list.length)return s;var l=this._processArguments(n,!0);if(!l.length)return s;for(var u=0;u<l.length;u++)this._index[l[u]]&&(s=!0,delete this._index[l[u]],this._list.splice(this._list.indexOf(l[u]),1),this.fire("remove",l[u],this._parent));return s&&this.fire("change",this._parent),s},t.clear=function(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var n=0;n<e.length;n++)this.fire("remove",e[n],this._parent);this.fire("change",this._parent)}},t.has=function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];return!!this._list.length&&this._has(this._processArguments(n))},t._has=function(e){if(!this._list.length||!e.length)return!1;for(var n=0;n<e.length;n++)if(e[n].length===1){if(this._index[e[n][0]])return!0}else{for(var r=!0,s=0;s<e[n].length;s++)if(!this._index[e[n][s]]){r=!1;break}if(r)return!0}return!1},t.list=function(){return this._list.slice(0)},t._processArguments=function(e,n){var r,s,l=[],u=[];if(!e||!e.length)return l;for(var c=0;c<e.length;c++)if(r=e[c],(s=Array)!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](r):Q(r,s)){n||(u=[]);for(var h=0;h<e[c].length;h++)typeof e[c][h]=="string"&&(n?l.push(e[c][h]):u.push(e[c][h]));!n&&u.length&&l.push(u)}else typeof e[c]=="string"&&(n?l.push(e[c]):l.push([e[c]]));return l},i=[{key:"size",get:function(){return this._list.length}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);Ls.EVENT_ADD="add",Ls.EVENT_REMOVE="remove",Ls.EVENT_CHANGE="change";var un=typeof window<"u"&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now;function Qm(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}var BC=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,Hl=function(){function o(i){var t=i.match(BC);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}var a=o.prototype;return a.toString=function(){var i="";return this.scheme&&(i+=""+this.scheme+":"),this.authority&&(i+="//"+this.authority),i+=this.path,this.query&&(i+="?"+this.query),this.fragment&&(i+="#"+this.fragment),i},a.getQuery=function(){var i={};if(this.query)for(var t,e=decodeURIComponent(this.query).split("&"),n=function(s,l){var u=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(u)return(u=u.call(s)).next.bind(u);if(Array.isArray(s)||(u=function(h,f){if(h){if(typeof h=="string")return Qm(h,void 0);var d=Object.prototype.toString.call(h).slice(8,-1);if(d==="Object"&&h.constructor&&(d=h.constructor.name),d==="Map"||d==="Set")return Array.from(d);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return Qm(h,void 0)}}(s))){u&&(s=u);var c=0;return function(){return c>=s.length?{done:!0}:{done:!1,value:s[c++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e);!(t=n()).done;){var r=t.value.split("=");i[r[0]]=r[1]}return i},a.setQuery=function(i){var t="";for(var e in i)i.hasOwnProperty(e)&&(t!==""&&(t+="&"),t+=encodeURIComponent(e)+"="+encodeURIComponent(i[e]));this.query=t},o}(),Wl=function(){function o(){}return o.set=function(a,i){},o.get=function(a){return o._traceChannels.has(a)},o}();Wl._traceChannels=new Set,Wl.stack=!1;var U={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(o,a,i){return o>=i?i:o<=a?a:o},intToBytes24:function(o){return[o>>16&255,o>>8&255,255&o]},intToBytes32:function(o){return[o>>24&255,o>>16&255,o>>8&255,255&o]},bytesToInt24:function(o,a,i){return o.length&&(i=o[2],a=o[1],o=o[0]),o<<16|a<<8|i},bytesToInt32:function(o,a,i,t){return o.length&&(t=o[3],i=o[2],a=o[1],o=o[0]),(o<<24|a<<16|i<<8|t)>>>0},lerp:function(o,a,i){return o+(a-o)*U.clamp(i,0,1)},lerpAngle:function(o,a,i){return a-o>180&&(a-=360),a-o<-180&&(a+=360),U.lerp(o,a,U.clamp(i,0,1))},powerOfTwo:function(o){return o!==0&&!(o&o-1)},nextPowerOfTwo:function(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,++o},nearestPowerOfTwo:function(o){return Math.pow(2,Math.round(Math.log2(o)))},random:function(o,a){return Math.random()*(a-o)+o},smoothstep:function(o,a,i){return i<=o?0:i>=a?1:(i=(i-o)/(a-o))*i*(3-2*i)},smootherstep:function(o,a,i){return i<=o?0:i>=a?1:(i=(i-o)/(a-o))*i*i*(i*(6*i-15)+10)},roundUp:function(o,a){return a===0?o:Math.ceil(o/a)*a},between:function(o,a,i,t){var e=Math.min(a,i),n=Math.max(a,i);return t?o>=e&&o<=n:o>e&&o<n}},B=function(){function o(i,t,e,n){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),n===void 0&&(n=1);var r,s=i.length;s===3||s===4?(this.r=i[0],this.g=i[1],this.b=i[2],this.a=(r=i[3])!=null?r:1):(this.r=i,this.g=t,this.b=e,this.a=n)}var a=o.prototype;return a.clone=function(){return new this.constructor(this.r,this.g,this.b,this.a)},a.copy=function(i){return this.r=i.r,this.g=i.g,this.b=i.b,this.a=i.a,this},a.equals=function(i){return this.r===i.r&&this.g===i.g&&this.b===i.b&&this.a===i.a},a.set=function(i,t,e,n){return n===void 0&&(n=1),this.r=i,this.g=t,this.b=e,this.a=n,this},a.lerp=function(i,t,e){return this.r=i.r+e*(t.r-i.r),this.g=i.g+e*(t.g-i.g),this.b=i.b+e*(t.b-i.b),this.a=i.a+e*(t.a-i.a),this},a.linear=function(i){return i===void 0&&(i=this),this.r=Math.pow(i.r,2.2),this.g=Math.pow(i.g,2.2),this.b=Math.pow(i.b,2.2),this.a=i.a,this},a.gamma=function(i){return i===void 0&&(i=this),this.r=Math.pow(i.r,1/2.2),this.g=Math.pow(i.g,1/2.2),this.b=Math.pow(i.b,1/2.2),this.a=i.a,this},a.mulScalar=function(i){return this.r*=i,this.g*=i,this.b*=i,this},a.fromString=function(i){var t,e=parseInt(i.replace("#","0x"),16);return i.length>7?t=U.intToBytes32(e):(t=U.intToBytes24(e))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this},a.fromArray=function(i,t){var e,n,r,s;return t===void 0&&(t=0),this.r=(e=i[t])!=null?e:this.r,this.g=(n=i[t+1])!=null?n:this.g,this.b=(r=i[t+2])!=null?r:this.b,this.a=(s=i[t+3])!=null?s:this.a,this},a.toString=function(i,t){var e=this.r,n=this.g,r=this.b,s=this.a;if(t||e>1||n>1||r>1)return e.toFixed(3)+", "+n.toFixed(3)+", "+r.toFixed(3)+", "+s.toFixed(3);var l="#"+(16777216+(Math.round(255*e)<<16)+(Math.round(255*n)<<8)+Math.round(255*r)).toString(16).slice(1);if(i===!0){var u=Math.round(255*s).toString(16);this.a<16/255?l+="0"+u:l+=u}return l},a.toArray=function(i,t,e){return i===void 0&&(i=[]),t===void 0&&(t=0),e===void 0&&(e=!0),i[t]=this.r,i[t+1]=this.g,i[t+2]=this.b,e&&(i[t+3]=this.a),i},o}();B.BLACK=Object.freeze(new B(0,0,0,1)),B.BLUE=Object.freeze(new B(0,0,1,1)),B.CYAN=Object.freeze(new B(0,1,1,1)),B.GRAY=Object.freeze(new B(.5,.5,.5,1)),B.GREEN=Object.freeze(new B(0,1,0,1)),B.MAGENTA=Object.freeze(new B(1,0,1,1)),B.RED=Object.freeze(new B(1,0,0,1)),B.WHITE=Object.freeze(new B(1,1,1,1)),B.YELLOW=Object.freeze(new B(1,1,0,1));var Jm=function(){function o(i,t){t===void 0&&(t=0),this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=i,this._reset(t)}var a=o.prototype;return a.evaluate=function(i,t){t===void 0&&(t=!1),(t||i<this._left||i>=this._right)&&this._reset(i);var e,n=this._curve.type;if(n===5)e=this._p0;else{var r=this._recip===0?0:(i-this._left)*this._recip;e=n===0?U.lerp(this._p0,this._p1,r):n===1?U.lerp(this._p0,this._p1,r*r*(3-2*r)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,r)}return e},a._reset=function(i){var t=this._curve.keys,e=t.length;if(e)if(i<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(i>=t[e-1][0])this._left=t[e-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[e-1][1],this._m0=this._m1=0;else{for(var n=0;i>=t[n+1][0];)n++;this._left=t[n][0],this._right=t[n+1][0];var r=1/(this._right-this._left);this._recip=isFinite(r)?r:0,this._p0=t[n][1],this._p1=t[n+1][1],this._curve.type===4&&this._calcTangents(t,n)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0},a._calcTangents=function(i,t){var e,n,r=i[t],s=i[t+1];if(e=t===0?[i[0][0]+(i[0][0]-i[1][0]),i[0][1]+(i[0][1]-i[1][1])]:i[t-1],n=t===i.length-2?[i[t+1][0]+(i[t+1][0]-i[t][0]),i[t+1][1]+(i[t+1][1]-i[t][1])]:i[t+2],this._curve.type===4){var l=2*(s[0]-r[0])/(s[0]-e[0]),u=2*(s[0]-r[0])/(n[0]-r[0]);this._m0=this._curve.tension*(isFinite(l)?l:0)*(s[1]-e[1]),this._m1=this._curve.tension*(isFinite(u)?u:0)*(n[1]-r[1])}else{var c=(s[0]-r[0])/(r[0]-e[0]),h=(s[0]-r[0])/(n[0]-s[0]),f=r[1]+(e[1]-r[1])*(isFinite(c)?c:0),d=s[1]+(n[1]-s[1])*(isFinite(h)?h:0),p=this._curve.tension;this._m0=p*(s[1]-f),this._m1=p*(d-r[1])}},a._evaluateHermite=function(i,t,e,n,r){var s=r*r,l=r+r,u=1-r,c=u*u;return(1+l)*c*i+r*c*e+s*(3-l)*t+s*(r-1)*n},o}(),cn=function(){function o(t){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new Jm(this),t)for(var e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}var a,i=o.prototype;return i.add=function(t,e){for(var n=this.keys,r=n.length,s=0;s<r&&!(n[s][0]>t);s++);var l=[t,e];return this.keys.splice(s,0,l),l},i.get=function(t){return this.keys[t]},i.sort=function(){this.keys.sort(function(t,e){return t[0]-e[0]})},i.value=function(t){return this._eval.evaluate(t,!0)},i.closest=function(t){for(var e=this.keys,n=e.length,r=2,s=null,l=0;l<n;l++){var u=Math.abs(t-e[l][0]);if(r>=u)r=u,s=e[l];else break}return s},i.clone=function(){var t=new this.constructor;return t.keys=this.keys.map(function(e){return[].concat(e)}),t.type=this.type,t.tension=this.tension,t},i.quantize=function(t){var e=new Float32Array(t=Math.max(t,2)),n=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(var r=1;r<t;r++)e[r]=this._eval.evaluate(n*r);return e},i.quantizeClamped=function(t,e,n){for(var r=this.quantize(t),s=0;s<r.length;++s)r[s]=Math.min(n,Math.max(e,r[s]));return r},a=[{key:"length",get:function(){return this.keys.length}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),tr=function(){function o(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];if(this.curves=[],this._type=1,e.length>1)for(var r=0;r<e.length;r++)this.curves.push(new cn(e[r]));else if(e.length===0)this.curves.push(new cn);else{var s=e[0];if(typeof s=="number")for(var l=0;l<s;l++)this.curves.push(new cn);else for(var u=0;u<s.length;u++)this.curves.push(new cn(s[u]))}}var a,i=o.prototype;return i.get=function(t){return this.curves[t]},i.value=function(t,e){e===void 0&&(e=[]);var n=this.curves.length;e.length=n;for(var r=0;r<n;r++)e[r]=this.curves[r].value(t);return e},i.clone=function(){var t=new this.constructor;t.curves=[];for(var e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t},i.quantize=function(t){t=Math.max(t,2);for(var e=this.curves.length,n=new Float32Array(t*e),r=1/(t-1),s=0;s<e;s++)for(var l=new Jm(this.curves[s]),u=0;u<t;u++)n[u*e+s]=l.evaluate(r*u);return n},i.quantizeClamped=function(t,e,n){for(var r=this.quantize(t),s=0;s<r.length;++s)r[s]=Math.min(n,Math.max(e,r[s]));return r},a=[{key:"length",get:function(){return this.curves.length}},{key:"type",get:function(){return this._type},set:function(t){this._type=t;for(var e=0;e<this.curves.length;e++)this.curves[e].type=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),kh=new Float32Array(1),$m=new Int32Array(kh.buffer),pi=function(){function o(){}return o.float2Half=function(a){kh[0]=a;var i=$m[0],t=i>>16&32768,e=i>>12&2047,n=i>>23&255;return n<103?t:n>142?(t|=31744,t|=+(n!==255)&&8388607&i):n<113?(e|=2048,t|=(e>>114-n)+(e>>113-n&1)):(t|=n-112<<10|e>>1,t+=1&e)},o.float2RGBA8=function(a,i){kh[0]=a;var t=$m[0];i.r=(t>>24&255)/255,i.g=(t>>16&255)/255,i.b=(t>>8&255)/255,i.a=(255&t)/255},o}(),e_=function(){function o(){}return o.concentric=function(a,i){var t=[];t.push(0,0);for(var e=2*Math.PI/a/i,n=1;n<=a;n++)for(var r=n/a,s=Math.max(1,Math.floor(2*Math.PI*r/e)),l=2*Math.PI/s,u=0;u<s;u++){var c=u*l,h=r*Math.cos(c),f=r*Math.sin(c);t.push(h,f)}return t},o}(),E=function(){function o(i,t,e){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),i.length===3?(this.x=i[0],this.y=i[1],this.z=i[2]):(this.x=i,this.y=t,this.z=e)}var a=o.prototype;return a.add=function(i){return this.x+=i.x,this.y+=i.y,this.z+=i.z,this},a.add2=function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this},a.addScalar=function(i){return this.x+=i,this.y+=i,this.z+=i,this},a.addScaled=function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this},a.clone=function(){return new this.constructor(this.x,this.y,this.z)},a.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this},a.cross=function(i,t){var e=i.x,n=i.y,r=i.z,s=t.x,l=t.y,u=t.z;return this.x=n*u-l*r,this.y=r*s-u*e,this.z=e*l-s*n,this},a.distance=function(i){var t=this.x-i.x,e=this.y-i.y,n=this.z-i.z;return Math.sqrt(t*t+e*e+n*n)},a.div=function(i){return this.x/=i.x,this.y/=i.y,this.z/=i.z,this},a.div2=function(i,t){return this.x=i.x/t.x,this.y=i.y/t.y,this.z=i.z/t.z,this},a.divScalar=function(i){return this.x/=i,this.y/=i,this.z/=i,this},a.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z},a.equals=function(i){return this.x===i.x&&this.y===i.y&&this.z===i.z},a.equalsApprox=function(i,t){return t===void 0&&(t=1e-6),Math.abs(this.x-i.x)<t&&Math.abs(this.y-i.y)<t&&Math.abs(this.z-i.z)<t},a.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},a.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},a.lerp=function(i,t,e){return this.x=i.x+e*(t.x-i.x),this.y=i.y+e*(t.y-i.y),this.z=i.z+e*(t.z-i.z),this},a.mul=function(i){return this.x*=i.x,this.y*=i.y,this.z*=i.z,this},a.mul2=function(i,t){return this.x=i.x*t.x,this.y=i.y*t.y,this.z=i.z*t.z,this},a.mulScalar=function(i){return this.x*=i,this.y*=i,this.z*=i,this},a.normalize=function(i){i===void 0&&(i=this);var t=i.x*i.x+i.y*i.y+i.z*i.z;if(t>0){var e=1/Math.sqrt(t);this.x=i.x*e,this.y=i.y*e,this.z=i.z*e}return this},a.floor=function(i){return i===void 0&&(i=this),this.x=Math.floor(i.x),this.y=Math.floor(i.y),this.z=Math.floor(i.z),this},a.ceil=function(i){return i===void 0&&(i=this),this.x=Math.ceil(i.x),this.y=Math.ceil(i.y),this.z=Math.ceil(i.z),this},a.round=function(i){return i===void 0&&(i=this),this.x=Math.round(i.x),this.y=Math.round(i.y),this.z=Math.round(i.z),this},a.min=function(i){return i.x<this.x&&(this.x=i.x),i.y<this.y&&(this.y=i.y),i.z<this.z&&(this.z=i.z),this},a.max=function(i){return i.x>this.x&&(this.x=i.x),i.y>this.y&&(this.y=i.y),i.z>this.z&&(this.z=i.z),this},a.project=function(i){var t=(this.x*i.x+this.y*i.y+this.z*i.z)/(i.x*i.x+i.y*i.y+i.z*i.z);return this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},a.set=function(i,t,e){return this.x=i,this.y=t,this.z=e,this},a.sub=function(i){return this.x-=i.x,this.y-=i.y,this.z-=i.z,this},a.sub2=function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this},a.subScalar=function(i){return this.x-=i,this.y-=i,this.z-=i,this},a.fromArray=function(i,t){var e,n,r;return t===void 0&&(t=0),this.x=(e=i[t])!=null?e:this.x,this.y=(n=i[t+1])!=null?n:this.y,this.z=(r=i[t+2])!=null?r:this.z,this},a.toString=function(){return"["+this.x+", "+this.y+", "+this.z+"]"},a.toArray=function(i,t){return i===void 0&&(i=[]),t===void 0&&(t=0),i[t]=this.x,i[t+1]=this.y,i[t+2]=this.z,i},o}();E.ZERO=Object.freeze(new E(0,0,0)),E.HALF=Object.freeze(new E(.5,.5,.5)),E.ONE=Object.freeze(new E(1,1,1)),E.UP=Object.freeze(new E(0,1,0)),E.DOWN=Object.freeze(new E(0,-1,0)),E.RIGHT=Object.freeze(new E(1,0,0)),E.LEFT=Object.freeze(new E(-1,0,0)),E.FORWARD=Object.freeze(new E(0,0,-1)),E.BACK=Object.freeze(new E(0,0,1));var zt=function(){function o(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}var a=o.prototype;return a.clone=function(){return new this.constructor().copy(this)},a.copy=function(i){var t=i.data,e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},a.set=function(i){var t=this.data;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},a.getX=function(i){return i===void 0&&(i=new E),i.set(this.data[0],this.data[1],this.data[2])},a.getY=function(i){return i===void 0&&(i=new E),i.set(this.data[3],this.data[4],this.data[5])},a.getZ=function(i){return i===void 0&&(i=new E),i.set(this.data[6],this.data[7],this.data[8])},a.equals=function(i){var t=this.data,e=i.data;return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},a.isIdentity=function(){var i=this.data;return i[0]===1&&i[1]===0&&i[2]===0&&i[3]===0&&i[4]===1&&i[5]===0&&i[6]===0&&i[7]===0&&i[8]===1},a.setIdentity=function(){var i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=0,i[7]=0,i[8]=1,this},a.toString=function(){return"["+this.data.join(", ")+"]"},a.transpose=function(i){i===void 0&&(i=this);var t,e=i.data,n=this.data;return e===n?(t=e[1],n[1]=e[3],n[3]=t,t=e[2],n[2]=e[6],n[6]=t,t=e[5],n[5]=e[7],n[7]=t):(n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8]),this},a.setFromMat4=function(i){var t=i.data,e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],this},a.setFromQuat=function(i){var t=i.x,e=i.y,n=i.z,r=i.w,s=t+t,l=e+e,u=n+n,c=t*s,h=t*l,f=t*u,d=e*l,p=e*u,_=n*u,g=r*s,y=r*l,v=r*u,x=this.data;return x[0]=1-(d+_),x[1]=h+v,x[2]=f-y,x[3]=h-v,x[4]=1-(c+_),x[5]=p+g,x[6]=f+y,x[7]=p-g,x[8]=1-(c+d),this},a.invertMat4=function(i){var t=i.data,e=t[0],n=t[1],r=t[2],s=t[4],l=t[5],u=t[6],c=t[8],h=t[9],f=t[10],d=f*l-u*h,p=-f*s+u*c,_=h*s-l*c,g=e*d+n*p+r*_;if(g===0)this.setIdentity();else{var y=1/g,v=this.data;v[0]=d*y,v[1]=(-f*n+r*h)*y,v[2]=(u*n-r*l)*y,v[3]=p*y,v[4]=(f*e-r*c)*y,v[5]=(-u*e+r*s)*y,v[6]=_*y,v[7]=(-h*e+n*c)*y,v[8]=(l*e-n*s)*y}return this},a.transformVector=function(i,t){t===void 0&&(t=new E);var e=this.data,n=i.x,r=i.y,s=i.z;return t.x=n*e[0]+r*e[3]+s*e[6],t.y=n*e[1]+r*e[4]+s*e[7],t.z=n*e[2]+r*e[5]+s*e[8],t},o}();zt.IDENTITY=Object.freeze(new zt),zt.ZERO=Object.freeze(new zt().set([0,0,0,0,0,0,0,0,0]));var G=function(){function o(i,t){i===void 0&&(i=0),t===void 0&&(t=0),i.length===2?(this.x=i[0],this.y=i[1]):(this.x=i,this.y=t)}var a=o.prototype;return a.add=function(i){return this.x+=i.x,this.y+=i.y,this},a.add2=function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this},a.addScalar=function(i){return this.x+=i,this.y+=i,this},a.addScaled=function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this},a.clone=function(){return new this.constructor(this.x,this.y)},a.copy=function(i){return this.x=i.x,this.y=i.y,this},a.cross=function(i){return this.x*i.y-this.y*i.x},a.distance=function(i){var t=this.x-i.x,e=this.y-i.y;return Math.sqrt(t*t+e*e)},a.div=function(i){return this.x/=i.x,this.y/=i.y,this},a.div2=function(i,t){return this.x=i.x/t.x,this.y=i.y/t.y,this},a.divScalar=function(i){return this.x/=i,this.y/=i,this},a.dot=function(i){return this.x*i.x+this.y*i.y},a.equals=function(i){return this.x===i.x&&this.y===i.y},a.equalsApprox=function(i,t){return t===void 0&&(t=1e-6),Math.abs(this.x-i.x)<t&&Math.abs(this.y-i.y)<t},a.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.lengthSq=function(){return this.x*this.x+this.y*this.y},a.lerp=function(i,t,e){return this.x=i.x+e*(t.x-i.x),this.y=i.y+e*(t.y-i.y),this},a.mul=function(i){return this.x*=i.x,this.y*=i.y,this},a.mul2=function(i,t){return this.x=i.x*t.x,this.y=i.y*t.y,this},a.mulScalar=function(i){return this.x*=i,this.y*=i,this},a.normalize=function(i){i===void 0&&(i=this);var t=i.x*i.x+i.y*i.y;if(t>0){var e=1/Math.sqrt(t);this.x=i.x*e,this.y=i.y*e}return this},a.rotate=function(i){var t=Math.atan2(this.x,this.y)+i*U.DEG_TO_RAD,e=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*e,this.y=Math.cos(t)*e,this},a.angle=function(){return Math.atan2(this.x,this.y)*U.RAD_TO_DEG},a.angleTo=function(i){return Math.atan2(this.x*i.y+this.y*i.x,this.x*i.x+this.y*i.y)*U.RAD_TO_DEG},a.floor=function(i){return i===void 0&&(i=this),this.x=Math.floor(i.x),this.y=Math.floor(i.y),this},a.ceil=function(i){return i===void 0&&(i=this),this.x=Math.ceil(i.x),this.y=Math.ceil(i.y),this},a.round=function(i){return i===void 0&&(i=this),this.x=Math.round(i.x),this.y=Math.round(i.y),this},a.min=function(i){return i.x<this.x&&(this.x=i.x),i.y<this.y&&(this.y=i.y),this},a.max=function(i){return i.x>this.x&&(this.x=i.x),i.y>this.y&&(this.y=i.y),this},a.set=function(i,t){return this.x=i,this.y=t,this},a.sub=function(i){return this.x-=i.x,this.y-=i.y,this},a.sub2=function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this},a.subScalar=function(i){return this.x-=i,this.y-=i,this},a.fromArray=function(i,t){var e,n;return t===void 0&&(t=0),this.x=(e=i[t])!=null?e:this.x,this.y=(n=i[t+1])!=null?n:this.y,this},a.toString=function(){return"["+this.x+", "+this.y+"]"},a.toArray=function(i,t){return i===void 0&&(i=[]),t===void 0&&(t=0),i[t]=this.x,i[t+1]=this.y,i},o.angleRad=function(i,t){return Math.atan2(i.x*t.y-i.y*t.x,i.x*t.x+i.y*t.y)},o}();G.ZERO=Object.freeze(new G(0,0)),G.HALF=Object.freeze(new G(.5,.5)),G.ONE=Object.freeze(new G(1,1)),G.UP=Object.freeze(new G(0,1)),G.DOWN=Object.freeze(new G(0,-1)),G.RIGHT=Object.freeze(new G(1,0)),G.LEFT=Object.freeze(new G(-1,0));var q=function(){function o(i,t,e,n){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),n===void 0&&(n=0),i.length===4?(this.x=i[0],this.y=i[1],this.z=i[2],this.w=i[3]):(this.x=i,this.y=t,this.z=e,this.w=n)}var a=o.prototype;return a.add=function(i){return this.x+=i.x,this.y+=i.y,this.z+=i.z,this.w+=i.w,this},a.add2=function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this.w=i.w+t.w,this},a.addScalar=function(i){return this.x+=i,this.y+=i,this.z+=i,this.w+=i,this},a.addScaled=function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this.w+=i.w*t,this},a.clone=function(){return new this.constructor(this.x,this.y,this.z,this.w)},a.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},a.div=function(i){return this.x/=i.x,this.y/=i.y,this.z/=i.z,this.w/=i.w,this},a.div2=function(i,t){return this.x=i.x/t.x,this.y=i.y/t.y,this.z=i.z/t.z,this.w=i.w/t.w,this},a.divScalar=function(i){return this.x/=i,this.y/=i,this.z/=i,this.w/=i,this},a.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z+this.w*i.w},a.equals=function(i){return this.x===i.x&&this.y===i.y&&this.z===i.z&&this.w===i.w},a.equalsApprox=function(i,t){return t===void 0&&(t=1e-6),Math.abs(this.x-i.x)<t&&Math.abs(this.y-i.y)<t&&Math.abs(this.z-i.z)<t&&Math.abs(this.w-i.w)<t},a.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},a.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a.lerp=function(i,t,e){return this.x=i.x+e*(t.x-i.x),this.y=i.y+e*(t.y-i.y),this.z=i.z+e*(t.z-i.z),this.w=i.w+e*(t.w-i.w),this},a.mul=function(i){return this.x*=i.x,this.y*=i.y,this.z*=i.z,this.w*=i.w,this},a.mul2=function(i,t){return this.x=i.x*t.x,this.y=i.y*t.y,this.z=i.z*t.z,this.w=i.w*t.w,this},a.mulScalar=function(i){return this.x*=i,this.y*=i,this.z*=i,this.w*=i,this},a.normalize=function(i){i===void 0&&(i=this);var t=i.x*i.x+i.y*i.y+i.z*i.z+i.w*i.w;if(t>0){var e=1/Math.sqrt(t);this.x=i.x*e,this.y=i.y*e,this.z=i.z*e,this.w=i.w*e}return this},a.floor=function(i){return i===void 0&&(i=this),this.x=Math.floor(i.x),this.y=Math.floor(i.y),this.z=Math.floor(i.z),this.w=Math.floor(i.w),this},a.ceil=function(i){return i===void 0&&(i=this),this.x=Math.ceil(i.x),this.y=Math.ceil(i.y),this.z=Math.ceil(i.z),this.w=Math.ceil(i.w),this},a.round=function(i){return i===void 0&&(i=this),this.x=Math.round(i.x),this.y=Math.round(i.y),this.z=Math.round(i.z),this.w=Math.round(i.w),this},a.min=function(i){return i.x<this.x&&(this.x=i.x),i.y<this.y&&(this.y=i.y),i.z<this.z&&(this.z=i.z),i.w<this.w&&(this.w=i.w),this},a.max=function(i){return i.x>this.x&&(this.x=i.x),i.y>this.y&&(this.y=i.y),i.z>this.z&&(this.z=i.z),i.w>this.w&&(this.w=i.w),this},a.set=function(i,t,e,n){return this.x=i,this.y=t,this.z=e,this.w=n,this},a.sub=function(i){return this.x-=i.x,this.y-=i.y,this.z-=i.z,this.w-=i.w,this},a.sub2=function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this.w=i.w-t.w,this},a.subScalar=function(i){return this.x-=i,this.y-=i,this.z-=i,this.w-=i,this},a.fromArray=function(i,t){var e,n,r,s;return t===void 0&&(t=0),this.x=(e=i[t])!=null?e:this.x,this.y=(n=i[t+1])!=null?n:this.y,this.z=(r=i[t+2])!=null?r:this.z,this.w=(s=i[t+3])!=null?s:this.w,this},a.toString=function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},a.toArray=function(i,t){return i===void 0&&(i=[]),t===void 0&&(t=0),i[t]=this.x,i[t+1]=this.y,i[t+2]=this.z,i[t+3]=this.w,i},o}();q.ZERO=Object.freeze(new q(0,0,0,0)),q.HALF=Object.freeze(new q(.5,.5,.5,.5)),q.ONE=Object.freeze(new q(1,1,1,1));var Ja=new G,bn=new E,Vn=new E,zn=new E,jl=new E,X=function(){function o(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}var a,i=o.prototype;return i.add2=function(t,e){var n=t.data,r=e.data,s=this.data;return s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s[3]=n[3]+r[3],s[4]=n[4]+r[4],s[5]=n[5]+r[5],s[6]=n[6]+r[6],s[7]=n[7]+r[7],s[8]=n[8]+r[8],s[9]=n[9]+r[9],s[10]=n[10]+r[10],s[11]=n[11]+r[11],s[12]=n[12]+r[12],s[13]=n[13]+r[13],s[14]=n[14]+r[14],s[15]=n[15]+r[15],this},i.add=function(t){return this.add2(this,t)},i.clone=function(){return new this.constructor().copy(this)},i.copy=function(t){var e=t.data,n=this.data;return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],this},i.equals=function(t){var e=this.data,n=t.data;return e[0]===n[0]&&e[1]===n[1]&&e[2]===n[2]&&e[3]===n[3]&&e[4]===n[4]&&e[5]===n[5]&&e[6]===n[6]&&e[7]===n[7]&&e[8]===n[8]&&e[9]===n[9]&&e[10]===n[10]&&e[11]===n[11]&&e[12]===n[12]&&e[13]===n[13]&&e[14]===n[14]&&e[15]===n[15]},i.isIdentity=function(){var t=this.data;return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1},i.mul2=function(t,e){var n,r,s,l,u=t.data,c=e.data,h=this.data,f=u[0],d=u[1],p=u[2],_=u[3],g=u[4],y=u[5],v=u[6],x=u[7],S=u[8],T=u[9],b=u[10],w=u[11],A=u[12],C=u[13],L=u[14],I=u[15];return n=c[0],r=c[1],s=c[2],l=c[3],h[0]=f*n+g*r+S*s+A*l,h[1]=d*n+y*r+T*s+C*l,h[2]=p*n+v*r+b*s+L*l,h[3]=_*n+x*r+w*s+I*l,n=c[4],r=c[5],s=c[6],l=c[7],h[4]=f*n+g*r+S*s+A*l,h[5]=d*n+y*r+T*s+C*l,h[6]=p*n+v*r+b*s+L*l,h[7]=_*n+x*r+w*s+I*l,n=c[8],r=c[9],s=c[10],l=c[11],h[8]=f*n+g*r+S*s+A*l,h[9]=d*n+y*r+T*s+C*l,h[10]=p*n+v*r+b*s+L*l,h[11]=_*n+x*r+w*s+I*l,n=c[12],r=c[13],s=c[14],l=c[15],h[12]=f*n+g*r+S*s+A*l,h[13]=d*n+y*r+T*s+C*l,h[14]=p*n+v*r+b*s+L*l,h[15]=_*n+x*r+w*s+I*l,this},i.mulAffine2=function(t,e){var n,r,s,l=t.data,u=e.data,c=this.data,h=l[0],f=l[1],d=l[2],p=l[4],_=l[5],g=l[6],y=l[8],v=l[9],x=l[10],S=l[12],T=l[13],b=l[14];return n=u[0],r=u[1],s=u[2],c[0]=h*n+p*r+y*s,c[1]=f*n+_*r+v*s,c[2]=d*n+g*r+x*s,c[3]=0,n=u[4],r=u[5],s=u[6],c[4]=h*n+p*r+y*s,c[5]=f*n+_*r+v*s,c[6]=d*n+g*r+x*s,c[7]=0,n=u[8],r=u[9],s=u[10],c[8]=h*n+p*r+y*s,c[9]=f*n+_*r+v*s,c[10]=d*n+g*r+x*s,c[11]=0,n=u[12],r=u[13],s=u[14],c[12]=h*n+p*r+y*s+S,c[13]=f*n+_*r+v*s+T,c[14]=d*n+g*r+x*s+b,c[15]=1,this},i.mul=function(t){return this.mul2(this,t)},i.transformPoint=function(t,e){e===void 0&&(e=new E);var n=this.data,r=t.x,s=t.y,l=t.z;return e.x=r*n[0]+s*n[4]+l*n[8]+n[12],e.y=r*n[1]+s*n[5]+l*n[9]+n[13],e.z=r*n[2]+s*n[6]+l*n[10]+n[14],e},i.transformVector=function(t,e){e===void 0&&(e=new E);var n=this.data,r=t.x,s=t.y,l=t.z;return e.x=r*n[0]+s*n[4]+l*n[8],e.y=r*n[1]+s*n[5]+l*n[9],e.z=r*n[2]+s*n[6]+l*n[10],e},i.transformVec4=function(t,e){e===void 0&&(e=new q);var n=this.data,r=t.x,s=t.y,l=t.z,u=t.w;return e.x=r*n[0]+s*n[4]+l*n[8]+u*n[12],e.y=r*n[1]+s*n[5]+l*n[9]+u*n[13],e.z=r*n[2]+s*n[6]+l*n[10]+u*n[14],e.w=r*n[3]+s*n[7]+l*n[11]+u*n[15],e},i.setLookAt=function(t,e,n){zn.sub2(t,e).normalize(),Vn.copy(n).normalize(),bn.cross(Vn,zn).normalize(),Vn.cross(zn,bn);var r=this.data;return r[0]=bn.x,r[1]=bn.y,r[2]=bn.z,r[3]=0,r[4]=Vn.x,r[5]=Vn.y,r[6]=Vn.z,r[7]=0,r[8]=zn.x,r[9]=zn.y,r[10]=zn.z,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1,this},i.setFrustum=function(t,e,n,r,s,l){var u=2*s,c=e-t,h=r-n,f=l-s,d=this.data;return d[0]=u/c,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=u/h,d[6]=0,d[7]=0,d[8]=(e+t)/c,d[9]=(r+n)/h,d[10]=(-l-s)/f,d[11]=-1,d[12]=0,d[13]=0,d[14]=-u*l/f,d[15]=0,this},i.setPerspective=function(t,e,n,r,s){return o._getPerspectiveHalfSize(Ja,t,e,n,s),this.setFrustum(-Ja.x,Ja.x,-Ja.y,Ja.y,n,r)},i.setOrtho=function(t,e,n,r,s,l){var u=this.data;return u[0]=2/(e-t),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(r-n),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=-2/(l-s),u[11]=0,u[12]=-(e+t)/(e-t),u[13]=-(r+n)/(r-n),u[14]=-(l+s)/(l-s),u[15]=1,this},i.setFromAxisAngle=function(t,e){e*=U.DEG_TO_RAD;var n=t.x,r=t.y,s=t.z,l=Math.cos(e),u=Math.sin(e),c=1-l,h=c*n,f=c*r,d=this.data;return d[0]=h*n+l,d[1]=h*r+u*s,d[2]=h*s-u*r,d[3]=0,d[4]=h*r-u*s,d[5]=f*r+l,d[6]=f*s+u*n,d[7]=0,d[8]=h*s+u*r,d[9]=f*s-n*u,d[10]=c*s*s+l,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this},i.setTranslate=function(t,e,n){var r=this.data;return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t,r[13]=e,r[14]=n,r[15]=1,this},i.setScale=function(t,e,n){var r=this.data;return r[0]=t,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,this},i.setViewport=function(t,e,n,r){var s=this.data;return s[0]=.5*n,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=.5*r,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=.5,s[11]=0,s[12]=t+.5*n,s[13]=e+.5*r,s[14]=.5,s[15]=1,this},i.setReflection=function(t,e){var n=t.x,r=t.y,s=t.z,l=this.data;return l[0]=1-2*n*n,l[1]=-2*n*r,l[2]=-2*n*s,l[3]=0,l[4]=-2*n*r,l[5]=1-2*r*r,l[6]=-2*r*s,l[7]=0,l[8]=-2*n*s,l[9]=-2*r*s,l[10]=1-2*s*s,l[11]=0,l[12]=-2*n*e,l[13]=-2*r*e,l[14]=-2*s*e,l[15]=1,this},i.invert=function(t){t===void 0&&(t=this);var e=t.data,n=e[0],r=e[1],s=e[2],l=e[3],u=e[4],c=e[5],h=e[6],f=e[7],d=e[8],p=e[9],_=e[10],g=e[11],y=e[12],v=e[13],x=e[14],S=e[15],T=n*c-r*u,b=n*h-s*u,w=n*f-l*u,A=r*h-s*c,C=r*f-l*c,L=s*f-l*h,I=d*v-p*y,P=d*x-_*y,M=d*S-g*y,R=p*x-_*v,k=p*S-g*v,D=_*S-g*x,O=T*D-b*k+w*R+A*M-C*P+L*I;if(O===0)this.setIdentity();else{var F=1/O,N=this.data;N[0]=(c*D-h*k+f*R)*F,N[1]=(-r*D+s*k-l*R)*F,N[2]=(v*L-x*C+S*A)*F,N[3]=(-p*L+_*C-g*A)*F,N[4]=(-u*D+h*M-f*P)*F,N[5]=(n*D-s*M+l*P)*F,N[6]=(-y*L+x*w-S*b)*F,N[7]=(d*L-_*w+g*b)*F,N[8]=(u*k-c*M+f*I)*F,N[9]=(-n*k+r*M-l*I)*F,N[10]=(y*C-v*w+S*T)*F,N[11]=(-d*C+p*w-g*T)*F,N[12]=(-u*R+c*P-h*I)*F,N[13]=(n*R-r*P+s*I)*F,N[14]=(-y*A+v*b-x*T)*F,N[15]=(d*A-p*b+_*T)*F}return this},i.set=function(t){var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this},i.setIdentity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},i.setTRS=function(t,e,n){var r=e.x,s=e.y,l=e.z,u=e.w,c=n.x,h=n.y,f=n.z,d=r+r,p=s+s,_=l+l,g=r*d,y=r*p,v=r*_,x=s*p,S=s*_,T=l*_,b=u*d,w=u*p,A=u*_,C=this.data;return C[0]=(1-(x+T))*c,C[1]=(y+A)*c,C[2]=(v-w)*c,C[3]=0,C[4]=(y-A)*h,C[5]=(1-(g+T))*h,C[6]=(S+b)*h,C[7]=0,C[8]=(v+w)*f,C[9]=(S-b)*f,C[10]=(1-(g+x))*f,C[11]=0,C[12]=t.x,C[13]=t.y,C[14]=t.z,C[15]=1,this},i.transpose=function(t){t===void 0&&(t=this);var e,n=t.data,r=this.data;return n===r?(e=n[1],r[1]=n[4],r[4]=e,e=n[2],r[2]=n[8],r[8]=e,e=n[3],r[3]=n[12],r[12]=e,e=n[6],r[6]=n[9],r[9]=e,e=n[7],r[7]=n[13],r[13]=e,e=n[11],r[11]=n[14],r[14]=e):(r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15]),this},i.getTranslation=function(t){return t===void 0&&(t=new E),t.set(this.data[12],this.data[13],this.data[14])},i.getX=function(t){return t===void 0&&(t=new E),t.set(this.data[0],this.data[1],this.data[2])},i.getY=function(t){return t===void 0&&(t=new E),t.set(this.data[4],this.data[5],this.data[6])},i.getZ=function(t){return t===void 0&&(t=new E),t.set(this.data[8],this.data[9],this.data[10])},i.getScale=function(t){return t===void 0&&(t=new E),this.getX(bn),this.getY(Vn),this.getZ(zn),t.set(bn.length(),Vn.length(),zn.length()),t},i.setFromEulerAngles=function(t,e,n){t*=U.DEG_TO_RAD,e*=U.DEG_TO_RAD,n*=U.DEG_TO_RAD;var r=Math.sin(-t),s=Math.cos(-t),l=Math.sin(-e),u=Math.cos(-e),c=Math.sin(-n),h=Math.cos(-n),f=this.data;return f[0]=u*h,f[1]=-u*c,f[2]=l,f[3]=0,f[4]=s*c+h*r*l,f[5]=s*h-r*l*c,f[6]=-u*r,f[7]=0,f[8]=r*c-s*h*l,f[9]=h*r+s*l*c,f[10]=s*u,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,this},i.getEulerAngles=function(t){t===void 0&&(t=new E),this.getScale(jl);var e,n,r=jl.x,s=jl.y,l=jl.z;if(r===0||s===0||l===0)return t.set(0,0,0);var u=this.data,c=Math.asin(-u[2]/r),h=.5*Math.PI;return c<h?c>-h?(e=Math.atan2(u[6]/s,u[10]/l),n=Math.atan2(u[1]/r,u[0]/r)):(n=0,e=-Math.atan2(u[4]/s,u[5]/s)):(n=0,e=Math.atan2(u[4]/s,u[5]/s)),t.set(e,c,n).mulScalar(U.RAD_TO_DEG)},i.toString=function(){return"["+this.data.join(", ")+"]"},o._getPerspectiveHalfSize=function(t,e,n,r,s){s?(t.x=r*Math.tan(e*Math.PI/360),t.y=t.x/n):(t.y=r*Math.tan(e*Math.PI/360),t.x=t.y*n)},a=[{key:"scaleSign",get:function(){return this.getX(bn),this.getY(Vn),this.getZ(zn),bn.cross(bn,Vn),0>bn.dot(zn)?-1:1}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();X.IDENTITY=Object.freeze(new X),X.ZERO=Object.freeze(new X().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var Z=function(){function o(i,t,e,n){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),n===void 0&&(n=1),i.length===4?(this.x=i[0],this.y=i[1],this.z=i[2],this.w=i[3]):(this.x=i,this.y=t,this.z=e,this.w=n)}var a=o.prototype;return a.clone=function(){return new this.constructor(this.x,this.y,this.z,this.w)},a.conjugate=function(i){return i===void 0&&(i=this),this.x=-1*i.x,this.y=-1*i.y,this.z=-1*i.z,this.w=i.w,this},a.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},a.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z+this.w*i.w},a.equals=function(i){return this.x===i.x&&this.y===i.y&&this.z===i.z&&this.w===i.w},a.equalsApprox=function(i,t){return t===void 0&&(t=1e-6),Math.abs(this.x-i.x)<t&&Math.abs(this.y-i.y)<t&&Math.abs(this.z-i.z)<t&&Math.abs(this.w-i.w)<t},a.getAxisAngle=function(i){var t=2*Math.acos(this.w),e=Math.sin(t/2);return e!==0?(i.x=this.x/e,i.y=this.y/e,i.z=this.z/e,(i.x<0||i.y<0||i.z<0)&&(i.x*=-1,i.y*=-1,i.z*=-1,t*=-1)):(i.x=1,i.y=0,i.z=0),t*U.RAD_TO_DEG},a.getEulerAngles=function(i){i===void 0&&(i=new E);var t,e,n,r=this.x,s=this.y,l=this.z,u=this.w,c=2*(u*s-r*l);return c<=-.99999?(t=2*Math.atan2(r,u),e=-Math.PI/2,n=0):c>=.99999?(t=2*Math.atan2(r,u),e=Math.PI/2,n=0):(t=Math.atan2(2*(u*r+s*l),1-2*(r*r+s*s)),e=Math.asin(c),n=Math.atan2(2*(u*l+r*s),1-2*(s*s+l*l))),i.set(t,e,n).mulScalar(U.RAD_TO_DEG)},a.invert=function(i){return i===void 0&&(i=this),this.conjugate(i).normalize()},a.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},a.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a.lerp=function(i,t,e){var n=(1-e)*(0>i.dot(t)?-1:1);return this.x=i.x*n+t.x*e,this.y=i.y*n+t.y*e,this.z=i.z*n+t.z*e,this.w=i.w*n+t.w*e,this.normalize()},a.mul=function(i){var t=this.x,e=this.y,n=this.z,r=this.w,s=i.x,l=i.y,u=i.z,c=i.w;return this.x=r*s+t*c+e*u-n*l,this.y=r*l+e*c+n*s-t*u,this.z=r*u+n*c+t*l-e*s,this.w=r*c-t*s-e*l-n*u,this},a.mulScalar=function(i,t){return t===void 0&&(t=this),this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=t.w*i,this},a.mul2=function(i,t){var e=i.x,n=i.y,r=i.z,s=i.w,l=t.x,u=t.y,c=t.z,h=t.w;return this.x=s*l+e*h+n*c-r*u,this.y=s*u+n*h+r*l-e*c,this.z=s*c+r*h+e*u-n*l,this.w=s*h-e*l-n*u-r*c,this},a.normalize=function(i){i===void 0&&(i=this);var t=i.length();return t===0?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this.w=i.w*t),this},a.set=function(i,t,e,n){return this.x=i,this.y=t,this.z=e,this.w=n,this},a.setFromAxisAngle=function(i,t){var e=Math.sin(t*=.5*U.DEG_TO_RAD),n=Math.cos(t);return this.x=e*i.x,this.y=e*i.y,this.z=e*i.z,this.w=n,this},a.setFromEulerAngles=function(i,t,e){if(n=i,E!=null&&typeof Symbol<"u"&&E[Symbol.hasInstance]?!!E[Symbol.hasInstance](n):Q(n,E)){var n,r=i;i=r.x,t=r.y,e=r.z}var s=.5*U.DEG_TO_RAD,l=Math.sin(i*=s),u=Math.cos(i),c=Math.sin(t*=s),h=Math.cos(t),f=Math.sin(e*=s),d=Math.cos(e);return this.x=l*h*d-u*c*f,this.y=u*c*d+l*h*f,this.z=u*h*f-l*c*d,this.w=u*h*d+l*c*f,this},a.setFromMat4=function(i){var t,e=i.data,n=e[0],r=e[1],s=e[2],l=e[4],u=e[5],c=e[6],h=e[8],f=e[9],d=e[10];return(t=n*n+r*r+s*s)==0||(n*=t=1/Math.sqrt(t),r*=t,s*=t,(t=l*l+u*u+c*c)==0||(l*=t=1/Math.sqrt(t),u*=t,c*=t,(t=h*h+f*f+d*d)==0))?this.set(0,0,0,1):(h*=t=1/Math.sqrt(t),f*=t,(d*=t)<0?n>u?this.set(1+n-u-d,r+l,h+s,c-f):this.set(r+l,1-n+u-d,c+f,h-s):n<-u?this.set(h+s,c+f,1-n-u+d,r-l):this.set(c-f,h-s,r-l,1+n+u+d),this.mulScalar(1/this.length()))},a.setFromDirections=function(i,t){var e=1+i.dot(t);return e<Number.EPSILON?(Math.abs(i.x)>Math.abs(i.y)?(this.x=-i.z,this.y=0,this.z=i.x):(this.x=0,this.y=-i.z,this.z=i.y),this.w=0):(this.x=i.y*t.z-i.z*t.y,this.y=i.z*t.x-i.x*t.z,this.z=i.x*t.y-i.y*t.x,this.w=e),this.normalize()},a.slerp=function(i,t,e){var n=i.x,r=i.y,s=i.z,l=i.w,u=t.x,c=t.y,h=t.z,f=t.w,d=l*f+n*u+r*c+s*h;if(d<0&&(f=-f,u=-u,c=-c,h=-h,d=-d),Math.abs(d)>=1)return this.w=l,this.x=n,this.y=r,this.z=s,this;var p=Math.acos(d),_=Math.sqrt(1-d*d);if(.001>Math.abs(_))return this.w=.5*l+.5*f,this.x=.5*n+.5*u,this.y=.5*r+.5*c,this.z=.5*s+.5*h,this;var g=Math.sin((1-e)*p)/_,y=Math.sin(e*p)/_;return this.w=l*g+f*y,this.x=n*g+u*y,this.y=r*g+c*y,this.z=s*g+h*y,this},a.transformVector=function(i,t){t===void 0&&(t=new E);var e=i.x,n=i.y,r=i.z,s=this.x,l=this.y,u=this.z,c=this.w,h=c*e+l*r-u*n,f=c*n+u*e-s*r,d=c*r+s*n-l*e,p=-s*e-l*n-u*r;return t.x=h*c+-(p*s)+-(f*u)- -(d*l),t.y=f*c+-(p*l)+-(d*s)- -(h*u),t.z=d*c+-(p*u)+-(h*l)- -(f*s),t},a.fromArray=function(i,t){var e,n,r,s;return t===void 0&&(t=0),this.x=(e=i[t])!=null?e:this.x,this.y=(n=i[t+1])!=null?n:this.y,this.z=(r=i[t+2])!=null?r:this.z,this.w=(s=i[t+3])!=null?s:this.w,this},a.toString=function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},a.toArray=function(i,t){return i===void 0&&(i=[]),t===void 0&&(t=0),i[t]=this.x,i[t+1]=this.y,i[t+2]=this.z,i[t+3]=this.w,i},o}();Z.IDENTITY=Object.freeze(new Z(0,0,0,1)),Z.ZERO=Object.freeze(new Z(0,0,0,0));var Tn=new E,Gt=new E,$a=new E,eo=new E,Lr=new E,Se=function(){function o(i,t){this.center=new E,this.halfExtents=new E(.5,.5,.5),this._min=new E,this._max=new E,i&&this.center.copy(i),t&&this.halfExtents.copy(t)}var a=o.prototype;return a.add=function(i){var t=this.center,e=t.x,n=t.y,r=t.z,s=this.halfExtents,l=s.x,u=s.y,c=s.z,h=e-l,f=e+l,d=n-u,p=n+u,_=r-c,g=r+c,y=i.center,v=y.x,x=y.y,S=y.z,T=i.halfExtents,b=T.x,w=T.y,A=T.z,C=v-b,L=v+b,I=x-w,P=x+w,M=S-A,R=S+A;C<h&&(h=C),L>f&&(f=L),I<d&&(d=I),P>p&&(p=P),M<_&&(_=M),R>g&&(g=R),t.x=(h+f)*.5,t.y=(d+p)*.5,t.z=(_+g)*.5,s.x=(f-h)*.5,s.y=(p-d)*.5,s.z=(g-_)*.5},a.copy=function(i){this.center.copy(i.center),this.halfExtents.copy(i.halfExtents)},a.clone=function(){return new o(this.center,this.halfExtents)},a.intersects=function(i){var t=this.getMax(),e=this.getMin(),n=i.getMax(),r=i.getMin();return e.x<=n.x&&t.x>=r.x&&e.y<=n.y&&t.y>=r.y&&e.z<=n.z&&t.z>=r.z},a._intersectsRay=function(i,t){var e=Tn.copy(this.getMin()).sub(i.origin),n=Gt.copy(this.getMax()).sub(i.origin),r=i.direction;r.x===0?(e.x=e.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.x=n.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(e.x/=r.x,n.x/=r.x),r.y===0?(e.y=e.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.y=n.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(e.y/=r.y,n.y/=r.y),r.z===0?(e.z=e.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.z=n.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(e.z/=r.z,n.z/=r.z);var s=$a.set(Math.min(e.x,n.x),Math.min(e.y,n.y),Math.min(e.z,n.z)),l=eo.set(Math.max(e.x,n.x),Math.max(e.y,n.y),Math.max(e.z,n.z)),u=Math.min(Math.min(l.x,l.y),l.z),c=Math.max(Math.max(s.x,s.y),s.z),h=u>=c&&c>=0;return h&&t.copy(i.direction).mulScalar(c).add(i.origin),h},a._fastIntersectsRay=function(i){var t=i.direction;return Tn.sub2(i.origin,this.center),eo.set(Math.abs(Tn.x),Math.abs(Tn.y),Math.abs(Tn.z)),$a.mul2(Tn,t),(!(eo.x>this.halfExtents.x)||!($a.x>=0))&&(!(eo.y>this.halfExtents.y)||!($a.y>=0))&&(!(eo.z>this.halfExtents.z)||!($a.z>=0))&&(Lr.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),Gt.cross(t,Tn),Gt.set(Math.abs(Gt.x),Math.abs(Gt.y),Math.abs(Gt.z)),!(Gt.x>this.halfExtents.y*Lr.z+this.halfExtents.z*Lr.y)&&!(Gt.y>this.halfExtents.x*Lr.z+this.halfExtents.z*Lr.x)&&!(Gt.z>this.halfExtents.x*Lr.y+this.halfExtents.y*Lr.x))},a.intersectsRay=function(i,t){return t?this._intersectsRay(i,t):this._fastIntersectsRay(i)},a.setMinMax=function(i,t){this.center.add2(t,i).mulScalar(.5),this.halfExtents.sub2(t,i).mulScalar(.5)},a.getMin=function(){return this._min.copy(this.center).sub(this.halfExtents)},a.getMax=function(){return this._max.copy(this.center).add(this.halfExtents)},a.containsPoint=function(i){var t=this.getMin(),e=this.getMax();return!(i.x<t.x)&&!(i.x>e.x)&&!(i.y<t.y)&&!(i.y>e.y)&&!(i.z<t.z)&&!(i.z>e.z)},a.setFromTransformedAabb=function(i,t,e){e===void 0&&(e=!1);var n=i.center,r=i.halfExtents,s=t.data,l=s[0],u=s[4],c=s[8],h=s[1],f=s[5],d=s[9],p=s[2],_=s[6],g=s[10];if(e){var y=l*l+u*u+c*c;if(y>0){var v=1/Math.sqrt(y);l*=v,u*=v,c*=v}if((y=h*h+f*f+d*d)>0){var x=1/Math.sqrt(y);h*=x,f*=x,d*=x}if((y=p*p+_*_+g*g)>0){var S=1/Math.sqrt(y);p*=S,_*=S,g*=S}}this.center.set(s[12]+l*n.x+u*n.y+c*n.z,s[13]+h*n.x+f*n.y+d*n.z,s[14]+p*n.x+_*n.y+g*n.z),this.halfExtents.set(Math.abs(l)*r.x+Math.abs(u)*r.y+Math.abs(c)*r.z,Math.abs(h)*r.x+Math.abs(f)*r.y+Math.abs(d)*r.z,Math.abs(p)*r.x+Math.abs(_)*r.y+Math.abs(g)*r.z)},a.compute=function(i,t){o.computeMinMax(i,Tn,Gt,t),this.setMinMax(Tn,Gt)},a.intersectsBoundingSphere=function(i){return this._distanceToBoundingSphereSq(i)<=i.radius*i.radius},a._distanceToBoundingSphereSq=function(i){for(var t=this.getMin(),e=this.getMax(),n=0,r=["x","y","z"],s=0;s<3;++s){var l=0,u=i.center[r[s]],c=t[r[s]],h=e[r[s]],f=0;u<c&&(l+=(f=c-u)*f),u>h&&(l+=(f=u-h)*f),n+=l}return n},a._expand=function(i,t){Tn.add2(this.getMin(),i),Gt.add2(this.getMax(),t),this.setMinMax(Tn,Gt)},o.computeMinMax=function(i,t,e,n){if(n===void 0&&(n=i.length/3),n>0){for(var r=i[0],s=i[1],l=i[2],u=r,c=s,h=l,f=3*n,d=3;d<f;d+=3){var p=i[d],_=i[d+1],g=i[d+2];p<r&&(r=p),_<s&&(s=_),g<l&&(l=g),p>u&&(u=p),_>c&&(c=_),g>h&&(h=g)}t.set(r,s,l),e.set(u,c,h)}},o}(),Xl=new E,VC=new E,to=function(){function o(i,t){i===void 0&&(i=new E),t===void 0&&(t=.5),this.center=i,this.radius=t}var a=o.prototype;return a.containsPoint=function(i){var t=Xl.sub2(i,this.center).lengthSq(),e=this.radius;return t<e*e},a.intersectsRay=function(i,t){var e=Xl.copy(i.origin).sub(this.center),n=e.dot(VC.copy(i.direction).normalize()),r=e.dot(e)-this.radius*this.radius;if(r>0&&n>0)return!1;var s=n*n-r;if(s<0)return!1;var l=Math.abs(-n-Math.sqrt(s));return t&&t.copy(i.direction).mulScalar(l).add(i.origin),!0},a.intersectsBoundingSphere=function(i){Xl.sub2(i.center,this.center);var t=i.radius+this.radius;return Xl.lengthSq()<=t*t},o}(),Yl=function(){function o(i,t){i===void 0&&(i=E.UP),t===void 0&&(t=0),this.normal=new E,this.normal.copy(i),this.distance=t}var a=o.prototype;return a.clone=function(){return new this.constructor().copy(this)},a.copy=function(i){return this.normal.copy(i.normal),this.distance=i.distance,this},a.intersectsLine=function(i,t,e){var n=this.distance,r=this.normal.dot(i)+n,s=r/(r-(this.normal.dot(t)+n)),l=s>=0&&s<=1;return l&&e&&e.lerp(i,t,s),l},a.intersectsRay=function(i,t){var e=this.normal.dot(i.direction);if(e===0)return!1;var n=-(this.normal.dot(i.origin)+this.distance)/e;return n>=0&&t&&t.copy(i.direction).mulScalar(n).add(i.origin),n>=0},a.normalize=function(){var i=1/this.normal.length();return this.normal.mulScalar(i),this.distance*=i,this},a.set=function(i,t,e,n){return this.normal.set(i,t,e),this.distance=n,this},a.setFromPointNormal=function(i,t){return this.normal.copy(t),this.distance=-this.normal.dot(i),this},o}(),t_=function(){function o(){this.planes=[];for(var i=0;i<6;i++)this.planes[i]=new Yl}var a=o.prototype;return a.clone=function(){return new this.constructor().copy(this)},a.copy=function(i){for(var t=0;t<6;t++)this.planes[t].copy(i.planes[t]);return this},a.setFromMat4=function(i){var t=i.data,e=t[0],n=t[1],r=t[2],s=t[3],l=t[4],u=t[5],c=t[6],h=t[7],f=t[8],d=t[9],p=t[10],_=t[11],g=t[12],y=t[13],v=t[14],x=t[15],S=this.planes;S[0].set(s-e,h-l,_-f,x-g).normalize(),S[1].set(s+e,h+l,_+f,x+g).normalize(),S[2].set(s+n,h+u,_+d,x+y).normalize(),S[3].set(s-n,h-u,_-d,x-y).normalize(),S[4].set(s-r,h-c,_-p,x-v).normalize(),S[5].set(s+r,h+c,_+p,x+v).normalize()},a.containsPoint=function(i){for(var t=0;t<6;t++){var e=this.planes[t],n=e.normal,r=e.distance;if(n.dot(i)+r<=0)return!1}return!0},a.containsSphere=function(i){for(var t=i.center,e=i.radius,n=0,r=0;r<6;r++){var s=this.planes[r],l=s.normal,u=s.distance,c=l.dot(t)+u;if(c<=-e)return 0;c>e&&n++}return n===6?2:1},o}(),Gn=function(){function o(i,t){this.origin=new E,this.direction=E.FORWARD.clone(),i&&this.origin.copy(i),t&&this.direction.copy(t)}var a=o.prototype;return a.set=function(i,t){return this.origin.copy(i),this.direction.copy(t),this},a.copy=function(i){return this.set(i.origin,i.direction)},a.clone=function(){return new this.constructor(this.origin,this.direction)},o}(),ql=new Gn,n_=new E,Nh=new to,zC=new X,GC=function(){function o(t,e){t===void 0&&(t=new X),this.halfExtents=new E(.5,.5,.5),e&&this.halfExtents.copy(e),this._modelTransform=t.clone().invert(),this._worldTransform=t.clone(),this._aabb=new Se(new E,this.halfExtents)}var a,i=o.prototype;return i.intersectsRay=function(t,e){if(this._modelTransform.transformPoint(t.origin,ql.origin),this._modelTransform.transformVector(t.direction,ql.direction),e){var n=this._aabb._intersectsRay(ql,e);return zC.copy(this._modelTransform).invert().transformPoint(e,e),n}return this._aabb._fastIntersectsRay(ql)},i.containsPoint=function(t){return this._modelTransform.transformPoint(t,n_),this._aabb.containsPoint(n_)},i.intersectsBoundingSphere=function(t){return this._modelTransform.transformPoint(t.center,Nh.center),Nh.radius=t.radius,!!this._aabb.intersectsBoundingSphere(Nh)},a=[{key:"worldTransform",get:function(){return this._worldTransform},set:function(t){this._worldTransform.copy(t),this._modelTransform.copy(t).invert()}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),Fh=new E,Uh=new E,Bh=new E,Vh=new E,zh=new E,i_=function(){function o(i,t,e){i===void 0&&(i=E.ZERO),t===void 0&&(t=E.ZERO),e===void 0&&(e=E.ZERO),this.v0=new E,this.v1=new E,this.v2=new E,this.set(i,t,e)}var a=o.prototype;return a.set=function(i,t,e){return this.v0.copy(i),this.v1.copy(t),this.v2.copy(e),this},a.intersectsRay=function(i,t){Fh.sub2(this.v1,this.v0),Uh.sub2(this.v2,this.v0),Bh.cross(i.direction,Uh);var e=Fh.dot(Bh);if(e>-1e-6&&e<1e-6)return!1;var n=1/e;Vh.sub2(i.origin,this.v0);var r=n*Vh.dot(Bh);if(r<0||r>1)return!1;zh.cross(Vh,Fh);var s=n*i.direction.dot(zh);if(s<0||r+s>1)return!1;var l=n*Uh.dot(zh);return l>1e-6&&((E!=null&&typeof Symbol<"u"&&E[Symbol.hasInstance]?E[Symbol.hasInstance](t):Q(t,E))&&t.copy(i.direction).mulScalar(l).add(i.origin),!0)},a.toString=function(){return"["+this.v0.toString()+", "+this.v1.toString()+", "+this.v2.toString()+"]"},o}(),no="linear",Kl="inverse",Gh="exponential";function r_(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}var Ht=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:20}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[12,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[14,{name:"RGBA32F",size:16}],[15,{name:"R32F",size:4}],[16,{name:"DEPTH",size:4}],[69,{name:"DEPTH16",size:2}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[20,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[10,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[24,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[37,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[49,{name:"RGBA32U",size:16,isInt:!0}]]),io=function(o){var a;return((a=Ht.get(o))==null?void 0:a.blockSize)!==void 0},ro=function(o){var a;return((a=Ht.get(o))==null?void 0:a.srgb)===!0},mi=function(o){var a;return((a=Ht.get(o))==null?void 0:a.isInt)===!0},so=function(o){var a;return((a=Ht.get(o))==null?void 0:a.srgbFormat)||o},s_=function(o){for(var a,i=function(n,r){var s=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(s)return(s=s.call(n)).next.bind(s);if(Array.isArray(n)||(s=function(u,c){if(u){if(typeof u=="string")return r_(u,void 0);var h=Object.prototype.toString.call(u).slice(8,-1);if(h==="Object"&&u.constructor&&(h=u.constructor.name),h==="Map"||h==="Set")return Array.from(h);if(h==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(h))return r_(u,void 0)}}(n))){s&&(n=s);var l=0;return function(){return l>=n.length?{done:!0}:{done:!1,value:n[l++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Ht);!(a=i()).done;){var t=a.value,e=t[0];if(t[1].srgbFormat===o)return e}return o},a_=function(o){var a=Ht.get(o);return!!(a!=null&&a.ldr&&!(a!=null&&a.srgb))},Hh=function(o){switch(o){case 15:case 13:case 14:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case 49:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case 12:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},oe="POSITION",bt="NORMAL",hn="TANGENT",fn="BLENDWEIGHT",Pt="BLENDINDICES",st="COLOR",Wh="TEXCOORD",mt="TEXCOORD0",Hn="TEXCOORD1",Dr="TEXCOORD2",Mr="TEXCOORD3",Rr="TEXCOORD4",Or="TEXCOORD5",kr="TEXCOORD6",Nr="TEXCOORD7",Zl="ATTR0",Ql="ATTR1",jh="ATTR2",Xh="ATTR3",Yh="ATTR4",o_="ATTR5",l_="ATTR6",u_="ATTR7",Ds="ATTR8",Ms="ATTR9",c_="ATTR10",h_="ATTR11",Jl="ATTR12",Rs="ATTR13",$l="ATTR14",Fr="ATTR15",Wt="default",Wn="rgbm",ao="rgbe",Os="rgbp",ks="swizzleGGGR",jn="2d-array",Xn="cube",oo="cube-array",f_="none",eu="cube",qh="equirect",d_="octahedral",ue="glsl",he="wgsl",Kh=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],Zh=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],Qh=new Map;Zh.forEach(function(o,a){o.forEach(function(i){return Qh.set(i,a)})});var HC=new Uint8Array([4,4,6,6,6,6,4,4,4,4,4,4,6,6,6,4,4,6,4,4,4,6,6,6,6,4,5,5,5,5,4,5,4,4,5,4,4,5,4,4,5,4,4,5,4,5,4,5,4,5]),lo="webgl2",Jh="webgpu",uo="null",co="ldr_srgb",$h=["view","mesh","mesh_ub"],ho="default",tu="_unused_float_uniform",Ur=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],Ns=[1,1,2,2,4,4,4,2],fo=[Uint8Array,Uint16Array,Uint32Array],p_=[1,2,4],me={};function nu(o,a){if(typeof a!="function"&&a!==null)throw TypeError("Super expression must either be null or a function");o.prototype=Object.create(a&&a.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),a&&m_(o,a)}function po(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function m_(o,a){return(m_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}me[oe]=0,me[bt]=1,me[fn]=2,me[Pt]=3,me[st]=4,me[mt]=5,me[Hn]=6,me[Dr]=7,me[Mr]=8,me[Rr]=9,me[Or]=10,me[kr]=11,me[Nr]=12,me[hn]=13,me[Zl]=0,me[Ql]=1,me[jh]=2,me[Xh]=3,me[Yh]=4,me[o_]=5,me[l_]=6,me[u_]=7,me[Ds]=8,me[Ms]=9,me[c_]=10,me[h_]=11,me[Jl]=12,me[Rs]=13,me[$l]=14,me[Fr]=15;var WC=0,iu=function(o,a){this.slot=-1,this.scopeId=null,this.name=o,this.visibility=a},mo=function(o){function a(){return o.apply(this,arguments)||this}return nu(a,o),a}(iu),ef=function(o){function a(i,t,e){var n;return e===void 0&&(e=!1),(n=o.call(this,i,t)||this).format="",n.readOnly=e,n}return nu(a,o),a}(iu),_o=function(o){function a(i,t,e,n,r,s){var l;return e===void 0&&(e="2d"),n===void 0&&(n=0),r===void 0&&(r=!0),s===void 0&&(s=null),(l=o.call(this,i,t)||this).textureDimension=e,l.sampleType=n,l.hasSampler=r,l.samplerName=s??""+i+"_sampler",l}return nu(a,o),a}(iu),__=function(o){function a(i,t,e,n,r){var s;return t===void 0&&(t=7),e===void 0&&(e="2d"),n===void 0&&(n=!0),r===void 0&&(r=!1),(s=o.call(this,i,4)||this).format=t,s.textureDimension=e,s.write=n,s.read=r,s}return nu(a,o),a}(iu),Br=function(){function o(i,t){var e=this;this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=WC++;var n=0;t.forEach(function(s){s.slot=n++,po(s,_o)&&s.hasSampler&&n++,po(s,mo)?e.uniformBufferFormats.push(s):po(s,_o)?e.textureFormats.push(s):po(s,__)?e.storageTextureFormats.push(s):po(s,ef)&&e.storageBufferFormats.push(s)}),this.device=i;var r=i.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach(function(s,l){return e.bufferFormatsMap.set(s.name,l)}),this.textureFormatsMap=new Map,this.textureFormats.forEach(function(s,l){e.textureFormatsMap.set(s.name,l),s.scopeId=r.resolve(s.name)}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach(function(s,l){e.storageTextureFormatsMap.set(s.name,l),s.scopeId=r.resolve(s.name)}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach(function(s,l){e.storageBufferFormatsMap.set(s.name,l),s.scopeId=r.resolve(s.name)}),this.impl=i.createBindGroupFormatImpl(this)}var a=o.prototype;return a.destroy=function(){this.impl.destroy()},a.getTexture=function(i){var t=this.textureFormatsMap.get(i);return t!==void 0?this.textureFormats[t]:null},a.getStorageTexture=function(i){var t=this.storageTextureFormatsMap.get(i);return t!==void 0?this.storageTextureFormats[t]:null},a.loseContext=function(){},o}(),It=function(){function o(){this._cache=new Map}var a=o.prototype;return a.get=function(i,t){var e=this;return this._cache.has(i)||(this._cache.set(i,t()),i.on("destroy",function(){e.remove(i)}),i.on("devicelost",function(){var n,r;(r=e._cache.get(i))==null||(n=r.loseContext)==null||n.call(r,i)})),this._cache.get(i)},a.remove=function(i){var t,e;(e=this._cache.get(i))==null||(t=e.destroy)==null||t.call(e,i),this._cache.delete(i)},o}(),En=function(){function o(){}return o.calcLevelDimension=function(a,i){return Math.max(a>>i,1)},o.calcMipLevelsCount=function(a,i,t){return t===void 0&&(t=1),1+Math.floor(Math.log2(Math.max(a,i,t)))},o.calcLevelGpuSize=function(a,i,t,e){var n,r,s,l=Ht.get(e),u=(r=(n=Ht.get(e))==null?void 0:n.size)!=null?r:0;if(u>0)return a*i*t*u;var c=(s=l.blockSize)!=null?s:0,h=Math.floor((a+3)/4),f=Math.floor((i+3)/4),d=Math.floor((t+3)/4);return(e===24||e===25)&&(h=Math.max(Math.floor(h/2),1)),h*f*d*c},o.calcGpuSize=function(a,i,t,e,n,r){for(var s=0;s+=o.calcLevelGpuSize(a,i,t,e),n&&(a!==1||i!==1||t!==1);)a=Math.max(a>>1,1),i=Math.max(i>>1,1),t=Math.max(t>>1,1);return s*(r?6:1)},o}(),jC=0,ee=function(){function o(t,e){e===void 0&&(e={}),this._gpuSize=0,this.id=jC++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=t,this.name=(n=e.name)!=null?n:"",this._width=Math.floor((r=e.width)!=null?r:4),this._height=Math.floor((s=e.height)!=null?s:4),this._format=(l=e.format)!=null?l:7,this._compressed=io(this._format),this._integerFormat=mi(this._format),this._integerFormat&&(e.minFilter=0,e.magFilter=0),this._volume=(u=e.volume)!=null&&u,this._depth=Math.floor((c=e.depth)!=null?c:1),this._arrayLength=Math.floor((h=e.arrayLength)!=null?h:0),this._storage=(f=e.storage)!=null&&f,this._cubemap=(d=e.cubemap)!=null&&d,this._flipY=(p=e.flipY)!=null&&p,this._premultiplyAlpha=(_=e.premultiplyAlpha)!=null&&_,this._mipmaps=(g=e.mipmaps)==null||g,this._numLevelsRequested=e.numLevels,e.numLevels!==void 0&&(this._numLevels=e.numLevels),this._updateNumLevel(),this._minFilter=(y=e.minFilter)!=null?y:5,this._magFilter=(v=e.magFilter)!=null?v:1,this._anisotropy=(x=e.anisotropy)!=null?x:1,this._addressU=(S=e.addressU)!=null?S:0,this._addressV=(T=e.addressV)!=null?T:0,this._addressW=(b=e.addressW)!=null?b:0,this._compareOnRead=(w=e.compareOnRead)!=null&&w,this._compareFunc=(A=e.compareFunc)!=null?A:1,this._type=(C=e.type)!=null?C:Wt,this.projection=f_,this._cubemap?this.projection=eu:e.projection&&e.projection!==eu&&(this.projection=e.projection),this._levels=e.levels;var n,r,s,l,u,c,h,f,d,p,_,g,y,v,x,S,T,b,w,A,C,L=!!e.levels;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.recreateImpl(L),t.textures.push(this)}var a,i=o.prototype;return i.destroy=function(){var t=this.device;if(t){var e=t.textures.indexOf(this);e!==-1&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}},i.recreateImpl=function(t){t===void 0&&(t=!0);var e,n=this.device;(e=this.impl)==null||e.destroy(n),this.impl=null,this.impl=n.createTextureImpl(this),this.dirtyAll(),t&&this.upload()},i.resize=function(t,e,n){n===void 0&&(n=1);var r=this.device;this.adjustVramSizeTracking(r._vram,-this._gpuSize),this.impl.destroy(r),this._width=Math.floor(t),this._height=Math.floor(e),this._depth=Math.floor(n),this._updateNumLevel(),this.impl=r.createTextureImpl(this),this.dirtyAll()},i.loseContext=function(){this.impl.loseContext(),this.dirtyAll()},i.adjustVramSizeTracking=function(t,e){t.tex+=e},i.propertyChanged=function(t){this.impl.propertyChanged(t),this.renderVersionDirty=this.device.renderVersion},i._updateNumLevel=function(){var t=this.mipmaps?En.calcMipLevelsCount(this.width,this.height):1,e=this._numLevelsRequested;this._numLevels=Math.min(e??t,t),this._mipmaps=this._numLevels>1},i.dirtyAll=function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)},i.lock=function(t){t===void 0&&(t={}),(e=t).level!=null||(e.level=0),(n=t).face!=null||(n.face=0),(r=t).mode!=null||(r.mode=2),this._lockedMode=t.mode,this._lockedLevel=t.level;var e,n,r,s=this.cubemap?this._levels[t.face]:this._levels;if(s[t.level]===null){var l=Math.max(1,this._width>>t.level),u=Math.max(1,this._height>>t.level),c=Math.max(1,this._depth>>t.level),h=new ArrayBuffer(En.calcLevelGpuSize(l,u,c,this._format));s[t.level]=new(Hh(this._format))(h)}return s[t.level]},i.setSource=function(t,e){e===void 0&&(e=0);var n,r,s,l=!1;if(this._cubemap){if(t[0]){r=t[0].width||0,s=t[0].height||0;for(var u=0;u<6;u++){var c=t[u];if(!c||c.width!==r||c.height!==s||!this.device._isBrowserInterface(c)){l=!0;break}}}else l=!0;if(!l)for(var h=0;h<6;h++)this._levels[e][h]!==t[h]&&(this._levelsUpdated[e][h]=!0)}else this.device._isBrowserInterface(t)||(l=!0),l||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),((n=HTMLVideoElement)!=null&&typeof Symbol<"u"&&n[Symbol.hasInstance]?!!n[Symbol.hasInstance](t):Q(t,n))?(r=t.videoWidth,s=t.videoHeight):(r=t.width,s=t.height));if(l)if(this._width=4,this._height=4,this._cubemap)for(var f=0;f<6;f++)this._levels[e][f]=null,this._levelsUpdated[e][f]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else e===0&&(this._width=r,this._height=s),this._levels[e]=t;this._invalid===l&&l||(this._invalid=l,this.upload())},i.getSource=function(t){return t===void 0&&(t=0),this._levels[t]},i.unlock=function(){this._lockedMode,this._lockedMode===2&&this.upload(),this._lockedLevel=-1,this._lockedMode=0},i.upload=function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this.impl.uploadImmediate==null||this.impl.uploadImmediate.call(this.impl,this.device,this)},i.read=function(t,e,n,r,s){return s===void 0&&(s={}),this.impl.read==null?void 0:this.impl.read.call(this.impl,t,e,n,r,s)},i.write=function(t,e,n,r,s){return this.impl.write==null?void 0:this.impl.write.call(this.impl,t,e,n,r,s)},a=[{key:"lockedMode",get:function(){return this._lockedMode}},{key:"minFilter",get:function(){return this._minFilter},set:function(t){this._minFilter!==t&&(mi(this._format)||(this._minFilter=t,this.propertyChanged(1)))}},{key:"magFilter",get:function(){return this._magFilter},set:function(t){this._magFilter!==t&&(mi(this._format)||(this._magFilter=t,this.propertyChanged(2)))}},{key:"addressU",get:function(){return this._addressU},set:function(t){this._addressU!==t&&(this._addressU=t,this.propertyChanged(4))}},{key:"addressV",get:function(){return this._addressV},set:function(t){this._addressV!==t&&(this._addressV=t,this.propertyChanged(8))}},{key:"addressW",get:function(){return this._addressW},set:function(t){this._volume&&t!==this._addressW&&(this._addressW=t,this.propertyChanged(16))}},{key:"compareOnRead",get:function(){return this._compareOnRead},set:function(t){this._compareOnRead!==t&&(this._compareOnRead=t,this.propertyChanged(32))}},{key:"compareFunc",get:function(){return this._compareFunc},set:function(t){this._compareFunc!==t&&(this._compareFunc=t,this.propertyChanged(64))}},{key:"anisotropy",get:function(){return this._anisotropy},set:function(t){this._anisotropy!==t&&(this._anisotropy=t,this.propertyChanged(128))}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){this._mipmaps!==t&&(this.device.isWebGPU||mi(this._format)||(this._mipmaps=t),t&&(this._needsMipmapsUpload=!0))}},{key:"numLevels",get:function(){return this._numLevels}},{key:"storage",get:function(){return this._storage}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"format",get:function(){return this._format}},{key:"cubemap",get:function(){return this._cubemap}},{key:"gpuSize",get:function(){var t=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return En.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}},{key:"array",get:function(){return this._arrayLength>0}},{key:"arrayLength",get:function(){return this._arrayLength}},{key:"volume",get:function(){return this._volume}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.device._shadersDirty=!0)}},{key:"srgb",get:function(){return ro(this.format)},set:function(t){if(t!==ro(this.format))if(t){var e=so(this.format);this._format!==e&&(this._format=e,this.recreateImpl(),this.device._shadersDirty=!0)}else{var n=s_(this.format);this._format!==n&&(this._format=n,this.recreateImpl(),this.device._shadersDirty=!0)}}},{key:"flipY",get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}},{key:"premultiplyAlpha",get:function(){return this._premultiplyAlpha},set:function(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}},{key:"pot",get:function(){return U.powerOfTwo(this._width)&&U.powerOfTwo(this._height)}},{key:"encoding",get:function(){switch(this.type){case Wn:return"rgbm";case ao:return"rgbe";case Os:return"rgbp"}return a_(this.format)?"srgb":"linear"}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),XC={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]},YC=function(){function o(){this.map=new Map}return o.prototype.destroy=function(){this.map.forEach(function(a){a.destroy()})},o}(),qC=new It,Vr=function(o,a){var i=qC.get(o,function(){return new YC});if(!i.map.has(a)){var t=new ee(o,{name:"built-in-texture-"+a,width:1,height:1,format:7}),e=t.lock(),n=XC[a];e.set(n),t.unlock(),i.map.set(a,t)}return i.map.get(a)},KC=0,tf=function(){this.offsets=[]},Fs=function(){function o(i,t,e){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=KC++,this.device=i,this.format=t,this.dirty=!0,this.impl=i.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=e,e&&this.setUniformBuffer(ho,e)}var a=o.prototype;return a.destroy=function(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null},a.setUniformBuffer=function(i,t){var e=this.format.bufferFormatsMap.get(i);this.uniformBuffers[e]!==t&&(this.uniformBuffers[e]=t,this.dirty=!0)},a.setStorageBuffer=function(i,t){var e=this.format.storageBufferFormatsMap.get(i);this.storageBuffers[e]!==t&&(this.storageBuffers[e]=t,this.dirty=!0)},a.setTexture=function(i,t){var e=this.format.textureFormatsMap.get(i);this.textures[e]!==t?(this.textures[e]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)},a.setStorageTexture=function(i,t){var e=this.format.storageTextureFormatsMap.get(i);this.storageTextures[e]!==t?(this.storageTextures[e]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)},a.updateUniformBuffers=function(){for(var i=0;i<this.uniformBuffers.length;i++)this.uniformBuffers[i].update()},a.update=function(){for(var i=this.format,t=i.textureFormats,e=i.storageTextureFormats,n=i.storageBufferFormats,r=0;r<t.length;r++){var s=t[r],l=s.scopeId.value;!l&&(s.name==="uSceneDepthMap"&&(l=Vr(this.device,"white")),s.name==="uSceneColorMap"&&(l=Vr(this.device,"pink")),l||(l=Vr(this.device,"pink"))),this.setTexture(s.name,l)}for(var u=0;u<e.length;u++){var c=e[u],h=c.scopeId.value;this.setStorageTexture(c.name,h)}for(var f=0;f<n.length;f++){var d=n[f],p=d.scopeId.value;this.setStorageBuffer(d.name,p)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(var _=0;_<this.uniformBuffers.length;_++){var g=this.uniformBuffers[_];this.uniformBufferOffsets[_]=g.offset,this.renderVersionUpdated<g.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))},o}(),jt=function(o,a,i,t){return t===void 0&&(t=1),o&~(t<<i)|a<<i},nr=function(o,a,i){return i===void 0&&(i=1),o>>a&i},Us=function(o,a,i){i===void 0&&(i=1);var t=i<<a;return(o&t)===t},ge=function(){function o(t,e,n,r,s,l,u,c,h,f,d){t===void 0&&(t=!1),e===void 0&&(e=0),n===void 0&&(n=1),r===void 0&&(r=0),c===void 0&&(c=!0),h===void 0&&(h=!0),f===void 0&&(f=!0),d===void 0&&(d=!0),this.target0=0,this.setColorBlend(e,n,r),this.setAlphaBlend(s??e,l??n,u??r),this.setColorWrite(c,h,f,d),this.blend=t}var a,i=o.prototype;return i.setColorBlend=function(t,e,n){this.target0=jt(this.target0,t,0,7),this.target0=jt(this.target0,e,3,15),this.target0=jt(this.target0,n,7,15)},i.setAlphaBlend=function(t,e,n){this.target0=jt(this.target0,t,11,7),this.target0=jt(this.target0,e,14,15),this.target0=jt(this.target0,n,18,15)},i.setColorWrite=function(t,e,n,r){this.redWrite=t,this.greenWrite=e,this.blueWrite=n,this.alphaWrite=r},i.copy=function(t){return this.target0=t.target0,this},i.clone=function(){return new this.constructor().copy(this)},i.equals=function(t){return this.target0===t.target0},a=[{key:"blend",get:function(){return Us(this.target0,26)},set:function(t){this.target0=jt(this.target0,+!!t,26)}},{key:"colorOp",get:function(){return nr(this.target0,0,7)}},{key:"colorSrcFactor",get:function(){return nr(this.target0,3,15)}},{key:"colorDstFactor",get:function(){return nr(this.target0,7,15)}},{key:"alphaOp",get:function(){return nr(this.target0,11,7)}},{key:"alphaSrcFactor",get:function(){return nr(this.target0,14,15)}},{key:"alphaDstFactor",get:function(){return nr(this.target0,18,15)}},{key:"redWrite",get:function(){return Us(this.target0,22)},set:function(t){this.target0=jt(this.target0,+!!t,22)}},{key:"greenWrite",get:function(){return Us(this.target0,23)},set:function(t){this.target0=jt(this.target0,+!!t,23)}},{key:"blueWrite",get:function(){return Us(this.target0,24)},set:function(t){this.target0=jt(this.target0,+!!t,24)}},{key:"alphaWrite",get:function(){return Us(this.target0,25)},set:function(t){this.target0=jt(this.target0,+!!t,25)}},{key:"allWrite",get:function(){return nr(this.target0,22,15)}},{key:"key",get:function(){return this.target0}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();ge.NOBLEND=Object.freeze(new ge),ge.NOWRITE=Object.freeze(new ge(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),ge.ALPHABLEND=Object.freeze(new ge(!0,0,6,8)),ge.ADDBLEND=Object.freeze(new ge(!0,0,1,1));var vo=function(){function o(){this.map=new Map,this.id=0}return o.prototype.get=function(a){var i=this.map.get(a);return i===void 0&&(i=this.id++,this.map.set(a,i)),i},o}(),ZC=new vo,Xe=function(){function o(t,e){t===void 0&&(t=3),e===void 0&&(e=!0),this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=t,this.write=e}var a,i=o.prototype;return i.copy=function(t){return this.data=t.data,this._depthBias=t._depthBias,this._depthBiasSlope=t._depthBiasSlope,this.key=t.key,this},i.clone=function(){return new this.constructor().copy(this)},i.updateKey=function(){var t=this.data,e=this._depthBias,n=this._depthBiasSlope;this.key=ZC.get(t+"-"+e+"-"+n)},i.equals=function(t){return this.key===t.key},a=[{key:"test",get:function(){return this.func!==7},set:function(t){this.func=t?3:7,this.updateKey()}},{key:"write",get:function(){return Us(this.data,3)},set:function(t){this.data=jt(this.data,+!!t,3),this.updateKey()}},{key:"func",get:function(){return nr(this.data,0,7)},set:function(t){this.data=jt(this.data,t,0,7),this.updateKey()}},{key:"depthBias",get:function(){return this._depthBias},set:function(t){this._depthBias=t,this.updateKey()}},{key:"depthBiasSlope",get:function(){return this._depthBiasSlope},set:function(t){this._depthBiasSlope=t,this.updateKey()}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();Xe.DEFAULT=Object.freeze(new Xe),Xe.NODEPTH=Object.freeze(new Xe(7,!1)),Xe.WRITEDEPTH=Object.freeze(new Xe(7,!0));var v_=function(){function o(){this.globalId=0,this.revision=0}var a=o.prototype;return a.equals=function(i){return this.globalId===i.globalId&&this.revision===i.revision},a.copy=function(i){this.globalId=i.globalId,this.revision=i.revision},a.reset=function(){this.globalId=0,this.revision=0},o}(),g_=0,QC=function(){function o(){g_++,this.version=new v_,this.version.globalId=g_}return o.prototype.increment=function(){this.version.revision++},o}(),y_=function(){function o(i){this.name=i,this.value=null,this.versionObject=new QC}var a=o.prototype;return a.toJSON=function(i){},a.setValue=function(i){this.value=i,this.versionObject.increment()},a.getValue=function(){return this.value},o}(),S_=function(){function o(i){this.name=i,this.variables=new Map}var a=o.prototype;return a.resolve=function(i){return this.variables.has(i)||this.variables.set(i,new y_(i)),this.variables.get(i)},a.removeValue=function(i){for(var t in this.variables){var e=this.variables[t];e.value===i&&(e.value=null)}},o}(),JC=0,Rt=function(){function o(i,t,e,n){this.usage=0,this.usage=(r=n==null?void 0:n.usage)!=null?r:0,this.device=i,this.format=t,this.numVertices=e,this.id=JC++,this.impl=i.createVertexBufferImpl(this,t,n),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*e,this.adjustVramSizeTracking(i._vram,this.numBytes);var r,s=n==null?void 0:n.data;s?this.setData(s):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}var a=o.prototype;return a.destroy=function(){var i=this.device,t=i.buffers.indexOf(this);t!==-1&&i.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(i),this.adjustVramSizeTracking(i._vram,-this.storage.byteLength))},a.adjustVramSizeTracking=function(i,t){i.vb+=t},a.loseContext=function(){this.impl.loseContext()},a.getFormat=function(){return this.format},a.getUsage=function(){return this.usage},a.getNumVertices=function(){return this.numVertices},a.lock=function(){return this.storage},a.unlock=function(){this.impl.unlock(this)},a.setData=function(i){return i.byteLength===this.numBytes&&(this.storage=i,this.unlock(),!0)},o}();function dn(o){if(o==null)return 0;for(var a=0,i=0,t=o.length;i<t;i++)a=(a<<5)-a+o.charCodeAt(i)|0;return a}function nf(o){for(var a=2166136261,i=0;i<o.length;i++)a^=o[i],a*=16777619;return a>>>0}var $C=new vo,eP=[2,4,8,12,16],tP=new It,Ot=function(){function o(t,e,n){this.device=t,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=n,this.interleaved=n===void 0,this.instancing=!1,this.size=e.reduce(function(g,y){return g+4*Math.ceil(y.components*Ns[y.type]/4)},0);for(var r,s=0,l=0,u=e.length;l<u;l++){var c,h,f=e[l];r=f.components*Ns[f.type],n&&(s=U.roundUp(s,r));var d=(c=f.asInt)!=null&&c,p=!d&&(h=f.normalize)!=null&&h,_={name:f.semantic,offset:n?s:f.hasOwnProperty("offset")?f.offset:s,stride:n?r:f.hasOwnProperty("stride")?f.stride:this.size,dataType:f.type,numComponents:f.components,normalize:p,size:r,asInt:d};this._elements.push(_),n?s+=r*n:s+=4*Math.ceil(r/4),f.semantic===mt?this.hasUv0=!0:f.semantic===Hn?this.hasUv1=!0:f.semantic===st?this.hasColor=!0:f.semantic===hn&&(this.hasTangents=!0)}n&&(this.verticesByteSize=s),this._evaluateHash()}var a,i=o.prototype;return i.update=function(){this._evaluateHash()},i._evaluateHash=function(){for(var t=[],e=[],n=this._elements.length,r=0;r<n;r++){var s=this._elements[r],l=s.name,u=s.dataType,c=s.numComponents,h=s.normalize,f=s.offset,d=s.stride,p=s.size,_=l+u+c+h+s.asInt;t.push(_);var g=_+f+d+p;e.push(g)}t.sort();var y=t.join();this.batchingHash=dn(y),this.shaderProcessingHashString=y,this.renderingHashString=e.join("_"),this.renderingHash=$C.get(this.renderingHashString)},o.getDefaultInstancingFormat=function(t){return tP.get(t,function(){return new o(t,[{semantic:Jl,components:4,type:6},{semantic:Rs,components:4,type:6},{semantic:$l,components:4,type:6},{semantic:Fr,components:4,type:6}])})},o.isElementValid=function(t,e){var n=e.components*Ns[e.type];return!t.isWebGPU||!!eP.includes(n)},a=[{key:"elements",get:function(){return this._elements}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),nP=new vo,Xt=function(){function o(t){var e,n,r,s,l,u,c;t===void 0&&(t={}),this._dirty=!0,this._func=(e=t.func)!=null?e:7,this._ref=(n=t.ref)!=null?n:0,this._readMask=(r=t.readMask)!=null?r:255,this._writeMask=(s=t.writeMask)!=null?s:255,this._fail=(l=t.fail)!=null?l:0,this._zfail=(u=t.zfail)!=null?u:0,this._zpass=(c=t.zpass)!=null?c:0,this._evalKey()}var a,i=o.prototype;return i._evalKey=function(){var t=this._func+","+this._ref+","+this._fail+","+this._zfail+","+this._zpass+","+this._readMask+","+this._writeMask;this._key=nP.get(t),this._dirty=!1},i.copy=function(t){return this._func=t._func,this._ref=t._ref,this._readMask=t._readMask,this._writeMask=t._writeMask,this._fail=t._fail,this._zfail=t._zfail,this._zpass=t._zpass,this._dirty=t._dirty,this._key=t._key,this},i.clone=function(){return new this.constructor().copy(this)},a=[{key:"func",get:function(){return this._func},set:function(t){this._func=t,this._dirty=!0}},{key:"ref",get:function(){return this._ref},set:function(t){this._ref=t,this._dirty=!0}},{key:"fail",get:function(){return this._fail},set:function(t){this._fail=t,this._dirty=!0}},{key:"zfail",get:function(){return this._zfail},set:function(t){this._zfail=t,this._dirty=!0}},{key:"zpass",get:function(){return this._zpass},set:function(t){this._zpass=t,this._dirty=!0}},{key:"readMask",get:function(){return this._readMask},set:function(t){this._readMask=t,this._dirty=!0}},{key:"writeMask",get:function(){return this._writeMask},set:function(t){this._writeMask=t,this._dirty=!0}},{key:"key",get:function(){return this._dirty&&this._evalKey(),this._key}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function x_(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function b_(){return(b_=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function ru(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function T_(o,a){return(T_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function su(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return x_(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return x_(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Xt.DEFAULT=Object.freeze(new Xt);var Ie=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){(r=o.call(this)||this).backBuffer=null,r.backBufferSize=new G,r.backBufferAntialias=!1,r.isWebGPU=!1,r.isWebGL2=!1,r.isHdr=!1,r.maxColorAttachments=1,r.maxSamples=1,r.supportsCompute=!1,r.supportsStorageTextureRead=!1,r.renderTarget=null,r.shaders=[],r.textures=[],r.targets=new Set,r.renderVersion=0,r.insideRenderPass=!1,r.supportsUniformBuffers=!1,r.supportsClipDistances=!1,r.textureRG11B10Renderable=!1,r.textureFloatFilterable=!1,r.blendState=new ge,r.depthState=new Xe,r.stencilEnabled=!1,r.stencilFront=new Xt,r.stencilBack=new Xt,r.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},r.clientRect={width:0,height:0},r._shadersDirty=!1,r.capsDefines=new Map,r.canvas=e,"setAttribute"in e&&e.setAttribute("data-engine","PlayCanvas "+Dh),r.initOptions=b_({},n),(s=r.initOptions).alpha!=null||(s.alpha=!0),(l=r.initOptions).depth!=null||(l.depth=!0),(u=r.initOptions).stencil!=null||(u.stencil=!0),(c=r.initOptions).antialias!=null||(c.antialias=!0),(h=r.initOptions).powerPreference!=null||(h.powerPreference="high-performance"),(f=r.initOptions).displayFormat!=null||(f.displayFormat="ldr"),r._maxPixelRatio=fe.browser?Math.min(1,window.devicePixelRatio):1,r.buffers=[],r._vram={tex:0,vb:0,ib:0,ub:0,sb:0},r._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},r.initializeContextCaches(),r._drawCallsPerFrame=0,r._shaderSwitchesPerFrame=0,r._primsPerFrame=[];for(var r,s,l,u,c,h,f,d=0;d<=6;d++)r._primsPerFrame[d]=0;return r._renderTargetCreationTime=0,r.scope=new S_("Device"),r.textureBias=r.scope.resolve("textureBias"),r.textureBias.setValue(0),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&T_(a,o);var i,t=a.prototype;return t.postInit=function(){var e=new Ot(this,[{semantic:oe,components:2,type:6}]),n=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new Rt(this,e,4,{data:n})},t.initCapsDefines=function(){var e=this.capsDefines;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE","")},t.destroy=function(){var e,n,r;this.fire("destroy"),(e=this.quadVertexBuffer)==null||e.destroy(),this.quadVertexBuffer=null,(n=this.dynamicBuffers)==null||n.destroy(),this.dynamicBuffers=null,(r=this.gpuProfiler)==null||r.destroy(),this.gpuProfiler=null},t.onDestroyShader=function(e){this.fire("destroy:shader",e);var n=this.shaders.indexOf(e);n!==-1&&this.shaders.splice(n,1)},t.postDestroy=function(){this.scope=null,this.canvas=null},t.loseContext=function(){this.contextLost=!0,this.backBufferSize.set(-1,-1);for(var e,n,r=su(this.textures);!(n=r()).done;)n.value.loseContext();for(var s,l=su(this.buffers);!(s=l()).done;)s.value.loseContext();for(var u,c=su(this.targets);!(u=c()).done;)u.value.loseContext();(e=this.gpuProfiler)==null||e.loseContext()},t.restoreContext=function(){this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches();for(var e,n,r,s=su(this.buffers);!(r=s()).done;)r.value.unlock();(n=this.gpuProfiler)==null||(e=n.restoreContext)==null||e.call(n)},t.toJSON=function(e){},t.initializeContextCaches=function(){this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null},t.initializeRenderState=function(){this.blendState=new ge,this.depthState=new Xe,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new B(0,0,0,0)},t.setStencilState=function(e,n){},t.setBlendState=function(e){},t.setBlendColor=function(e,n,r,s){},t.setDepthState=function(e){},t.setCullMode=function(e){},t.setRenderTarget=function(e){this.renderTarget=e},t.setVertexBuffer=function(e){e&&this.vertexBuffers.push(e)},t.clearVertexBuffer=function(){this.vertexBuffers.length=0},t.getRenderTarget=function(){return this.renderTarget},t.initRenderTarget=function(e){e.initialized||(e.init(),this.targets.add(e))},t.draw=function(e,n,r,s,l){},t._isBrowserInterface=function(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)},t._isImageBrowserInterface=function(e){return typeof ImageBitmap<"u"&&ru(e,ImageBitmap)||typeof HTMLImageElement<"u"&&ru(e,HTMLImageElement)},t._isImageCanvasInterface=function(e){return typeof HTMLCanvasElement<"u"&&ru(e,HTMLCanvasElement)},t._isImageVideoInterface=function(e){return typeof HTMLVideoElement<"u"&&ru(e,HTMLVideoElement)},t.resizeCanvas=function(e,n){var r=Math.min(this._maxPixelRatio,fe.browser?window.devicePixelRatio:1),s=Math.floor(e*r),l=Math.floor(n*r);(s!==this.canvas.width||l!==this.canvas.height)&&this.setResolution(s,l)},t.setResolution=function(e,n){this.canvas.width=e,this.canvas.height=n,this.fire(a.EVENT_RESIZE,e,n)},t.updateClientRect=function(){if(fe.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{var e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height}},t.startRenderPass=function(e){},t.endRenderPass=function(e){},t.startComputePass=function(e){},t.endComputePass=function(){},t.frameStart=function(){this.renderPassIndex=0,this.renderVersion++},t.frameEnd=function(){},t.computeDispatch=function(e,n){},t.getRenderableHdrFormat=function(e,n,r){e===void 0&&(e=[18,12,14]),n===void 0&&(n=!0),r===void 0&&(r=1);for(var s=0;s<e.length;s++){var l=e[s];switch(l){case 18:if(this.textureRG11B10Renderable)return l;break;case 12:if(this.textureHalfFloatRenderable)return l;break;case 14:if(this.isWebGPU&&r>1)continue;if(this.textureFloatRenderable&&(!n||this.textureFloatFilterable))return l}}},t.validateAttributes=function(e,n,r){},i=[{key:"width",get:function(){return this.canvas.width}},{key:"height",get:function(){return this.canvas.height}},{key:"fullscreen",get:function(){return!1},set:function(e){}},{key:"maxPixelRatio",get:function(){return this._maxPixelRatio},set:function(e){this._maxPixelRatio=e}},{key:"deviceType",get:function(){return this._deviceType}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);Ie.EVENT_RESIZE="resizecanvas";var iP=0,Ee=function(){function o(t){t===void 0&&(t={}),this.id=iP++;var e,n,r,s,l,u,c,h,f,d,p,_,g,y,v,x=(u=(l=(s=(e=t.colorBuffer)==null?void 0:e.device)!=null?s:(n=t.colorBuffers)==null?void 0:n[0].device)!=null?l:(r=t.depthBuffer)==null?void 0:r.device)!=null?u:t.graphicsDevice;this._device=x;var S=this._device.maxSamples;if(this._samples=Math.min((c=t.samples)!=null?c:1,S),x.isWebGPU&&(this._samples=this._samples>1?S:1),this._colorBuffer=t.colorBuffer,t.colorBuffer&&(this._colorBuffers=[t.colorBuffer]),this._depthBuffer=t.depthBuffer,this._face=(h=t.face)!=null?h:0,this._depthBuffer){var T=this._depthBuffer._format;T===16||T===69?(this._depth=!0,this._stencil=!1):T===17?(this._depth=!0,this._stencil=!0):(T===15&&this._depthBuffer.device.isWebGPU&&this._samples>1?this._depth=!0:this._depth=!1,this._stencil=!1)}else this._depth=(f=t.depth)==null||f,this._stencil=(d=t.stencil)!=null&&d;t.colorBuffers&&!this._colorBuffers&&(this._colorBuffers=[].concat(t.colorBuffers),this._colorBuffer=t.colorBuffers[0]),this.autoResolve=(p=t.autoResolve)==null||p,this.name=t.name,this.name||(this.name=(_=this._colorBuffer)==null?void 0:_.name),this.name||(this.name=(g=this._depthBuffer)==null?void 0:g.name),this.name||(this.name="Untitled"),this.flipY=(y=t.flipY)!=null&&y,this._mipLevel=(v=t.mipLevel)!=null?v:0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=t.mipLevel===void 0,this.validateMrt(),this.impl=x.createRenderTargetImpl(this)}var a,i=o.prototype;return i.destroy=function(){var t=this._device;t&&(t.targets.delete(this),t.renderTarget===this&&t.setRenderTarget(null),this.destroyFrameBuffers())},i.destroyFrameBuffers=function(){var t=this._device;t&&this.impl.destroy(t)},i.destroyTextureBuffers=function(){var t,e;(t=this._depthBuffer)==null||t.destroy(),this._depthBuffer=null,(e=this._colorBuffers)==null||e.forEach(function(n){n.destroy()}),this._colorBuffers=null,this._colorBuffer=null},i.resize=function(t,e){if((this.width!==t||this.height!==e)&&!(this.mipLevel>0)){var n,r,s=this._device;this.destroyFrameBuffers(),s.renderTarget===this&&s.setRenderTarget(null),(n=this._depthBuffer)==null||n.resize(t,e),(r=this._colorBuffers)==null||r.forEach(function(l){l.resize(t,e)}),this.validateMrt(),this.impl=s.createRenderTargetImpl(this)}},i.validateMrt=function(){},i.init=function(){this.impl.init(this._device,this)},i.loseContext=function(){this.impl.loseContext()},i.resolve=function(t,e){t===void 0&&(t=!0),e===void 0&&(e=!!this._depthBuffer),this._device&&this._samples>1&&this.impl.resolve(this._device,this,t,e)},i.copy=function(t,e,n){if(!this._device)if(t._device)this._device=t._device;else return!1;return this._device.copyRenderTarget(t,this,e,n)},i.getColorBuffer=function(t){var e;return(e=this._colorBuffers)==null?void 0:e[t]},i.isColorBufferSrgb=function(t){if(t===void 0&&(t=0),this.device.backBuffer===this)return ro(this.device.backBufferFormat);var e=this.getColorBuffer(t);return!!e&&ro(e.format)},a=[{key:"initialized",get:function(){return this.impl.initialized}},{key:"device",get:function(){return this._device}},{key:"samples",get:function(){return this._samples}},{key:"depth",get:function(){return this._depth}},{key:"stencil",get:function(){return this._stencil}},{key:"colorBuffer",get:function(){return this._colorBuffer}},{key:"depthBuffer",get:function(){return this._depthBuffer}},{key:"face",get:function(){return this._face}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"mipmaps",get:function(){return this._mipmaps}},{key:"width",get:function(){var t,e,n=((t=this._colorBuffer)==null?void 0:t.width)||((e=this._depthBuffer)==null?void 0:e.width)||this._device.width;return this._mipLevel>0&&(n=En.calcLevelDimension(n,this._mipLevel)),n}},{key:"height",get:function(){var t,e,n=((t=this._colorBuffer)==null?void 0:t.height)||((e=this._depthBuffer)==null?void 0:e.height)||this._device.height;return this._mipLevel>0&&(n=En.calcLevelDimension(n,this._mipLevel)),n}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),rP=function(){function o(){}var a=o.prototype;return a.update=function(i){this.destroy();var t=i.device,e=this.createDescriptor(t,i);this.bindGroup=t.wgpu.createBindGroup(e)},a.destroy=function(){this.bindGroup=null},a.createDescriptor=function(i,t){var e=[],n=t.format,r=t.format.uniformBufferFormats;t.uniformBuffers.forEach(function(c,h){var f=r[h].slot,d=c.persistent?c.impl.buffer:c.allocation.gpuBuffer.buffer;e.push({binding:f,resource:{buffer:d,offset:0,size:c.format.byteSize}})});var s=t.format.textureFormats;t.textures.forEach(function(c,h){var f=c.impl,d=n.textureFormats[h],p=s[h].slot,_=f.getView(i);if(e.push({binding:p,resource:_}),d.hasSampler){var g=f.getSampler(i,d.sampleType);e.push({binding:p+1,resource:g})}});var l=t.format.storageTextureFormats;t.storageTextures.forEach(function(c,h){var f=c.impl,d=l[h].slot,p=f.getView(i);e.push({binding:d,resource:p})});var u=t.format.storageBufferFormats;return t.storageBuffers.forEach(function(c,h){var f=c.impl.buffer,d=u[h].slot;e.push({binding:d,resource:{buffer:f}})}),{layout:t.format.impl.bindGroupLayout,entries:e}},o}(),rf=function(){function o(){}return o.shaderStage=function(a){var i=0;return 1&a&&(i|=GPUShaderStage.VERTEX),2&a&&(i|=GPUShaderStage.FRAGMENT),4&a&&(i|=GPUShaderStage.COMPUTE),i},o}(),J=[];J[0]="",J[1]="",J[2]="",J[52]="r8unorm",J[53]="rg8unorm",J[3]="",J[4]="",J[5]="",J[6]="rgba8unorm",J[7]="rgba8unorm",J[8]="bc1-rgba-unorm",J[9]="bc2-rgba-unorm",J[10]="bc3-rgba-unorm",J[11]="",J[12]="rgba16float",J[50]="r16float",J[51]="rg16float",J[13]="",J[14]="rgba32float",J[15]="r32float",J[16]="depth32float",J[69]="depth16unorm",J[17]="depth24plus-stencil8",J[18]="rg11b10ufloat",J[19]="",J[20]="rgba8unorm-srgb",J[21]="",J[22]="etc2-rgb8unorm",J[23]="etc2-rgba8unorm",J[24]="",J[25]="",J[26]="",J[27]="",J[28]="astc-4x4-unorm",J[29]="",J[30]="",J[31]="bgra8unorm",J[64]="bgra8unorm-srgb",J[32]="r8sint",J[33]="r8uint",J[34]="r16sint",J[35]="r16uint",J[36]="r32sint",J[37]="r32uint",J[38]="rg8sint",J[39]="rg8uint",J[40]="rg16sint",J[41]="rg16uint",J[42]="rg32sint",J[43]="rg32uint",J[44]="rgba8sint",J[45]="rgba8uint",J[46]="rgba16sint",J[47]="rgba16uint",J[48]="rgba32sint",J[49]="rgba32uint",J[65]="bc6h-rgb-float",J[66]="bc6h-rgb-ufloat",J[67]="bc7-rgba-unorm",J[54]="bc1-rgba-unorm-srgb",J[55]="bc2-rgba-unorm-srgb",J[56]="bc3-rgba-unorm-srgb",J[61]="etc2-rgb8unorm-srgb",J[62]="etc2-rgba8unorm-srgb",J[68]="bc7-rgba-unorm-srgb",J[63]="astc-4x4-unorm-srgb";var Bs=[];Bs[0]="filtering",Bs[1]="non-filtering",Bs[2]="comparison",Bs[3]="comparison",Bs[4]="comparison";var Vs=[];Vs[0]="float",Vs[1]="unfilterable-float",Vs[2]="depth",Vs[3]="sint",Vs[4]="uint";var sP=new vo,aP=function(){function o(i){var t=i.device,e=this.createDescriptor(i),n=e.key,r=e.desc;this.key=sP.get(n),this.bindGroupLayout=t.wgpu.createBindGroupLayout(r)}var a=o.prototype;return a.destroy=function(){this.bindGroupLayout=null},a.loseContext=function(){},a.createDescriptor=function(i){var t=[],e="";return i.uniformBufferFormats.forEach(function(n){var r=rf.shaderStage(n.visibility);e+="#"+n.slot+"U:"+r,t.push({binding:n.slot,visibility:r,buffer:{type:"uniform",hasDynamicOffset:!0}})}),i.textureFormats.forEach(function(n){var r=rf.shaderStage(n.visibility),s=n.sampleType,l=n.textureDimension,u=Vs[s];if(e+="#"+n.slot+"T:"+r+"-"+u+"-"+l+"-false",t.push({binding:n.slot,visibility:r,texture:{sampleType:u,viewDimension:l,multisampled:!1}}),n.hasSampler){var c=Bs[s];e+="#"+(n.slot+1)+"S:"+r+"-"+c,t.push({binding:n.slot+1,visibility:r,sampler:{type:c}})}}),i.storageTextureFormats.forEach(function(n){var r=n.format,s=n.textureDimension,l=n.read,u=n.write;e+="#"+n.slot+"ST:"+r+"-"+s+"-"+(l?"r1":"r0")+"-"+(u?"w1":"w0"),t.push({binding:n.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:l?u?"read-write":"read-only":"write-only",format:J[r],viewDimension:s}})}),i.storageBufferFormats.forEach(function(n){var r=n.readOnly,s=rf.shaderStage(n.visibility);e+="#"+n.slot+"SB:"+s+"-"+(r?"ro":"rw"),t.push({binding:n.slot,visibility:s,buffer:{type:r?"read-only-storage":"storage"}})}),{key:e,desc:{entries:t}}},o}(),au=function(){function o(t){t===void 0&&(t=0),this.buffer=null,this.usageFlags=0,this.usageFlags=t}var a,i=o.prototype;return i.destroy=function(t){this.buffer&&(this.buffer.destroy(),this.buffer=null)},i.loseContext=function(){},i.allocate=function(t,e){this.buffer=t.wgpu.createBuffer({size:e,usage:this.usageFlags})},i.unlock=function(t,e){var n,r,s=t.wgpu;if(!this.buffer){var l=e.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(t,l)}var u=(n=e.byteOffset)!=null?n:0,c=new Uint8Array((r=e.buffer)!=null?r:e,u,e.byteLength),h=new Uint8Array(this.buffer.size);h.set(c),s.queue.writeBuffer(this.buffer,0,h,0,h.length)},i.read=function(t,e,n,r){return t.readStorageBuffer(this,e,n,r)},i.write=function(t,e,n,r,s){t.writeStorageBuffer(this,e,n,r,s)},i.clear=function(t,e,n){t.clearStorageBuffer(this,e,n)},a=[{key:"initialized",get:function(){return!!this.buffer}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function E_(o,a){return(E_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var oP=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t){var e;return(e=o.call(this,16|128*(t!=null&&!!t.storage))||this).format=null,e.format=i.format===1?"uint16":"uint32",e}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&E_(a,o),a.prototype.unlock=function(i){var t=i.device;o.prototype.unlock.call(this,t,i.storage)},a}(au),lP={equals:function(o,a){if(o.length!==a.length)return!1;for(var i=0;i<o.length;i++)if(o[i]!==a[i])return!1;return!0}},_i=[];_i[0]="sint8",_i[1]="uint8",_i[2]="sint16",_i[3]="uint16",_i[4]="sint32",_i[5]="uint32",_i[6]="float32",_i[7]="float16";var vi=[];vi[0]="snorm8",vi[1]="unorm8",vi[2]="snorm16",vi[3]="unorm16",vi[4]="sint32",vi[5]="uint32",vi[6]="float32",vi[7]="float16";var uP=function(){function o(){this.cache=new Map}var a=o.prototype;return a.get=function(i,t){t===void 0&&(t=null);var e=this.getKey(i,t),n=this.cache.get(e);return n||(n=this.create(i,t),this.cache.set(e,n)),n},a.getKey=function(i,t){return t===void 0&&(t=null),(i==null?void 0:i.renderingHashString)+"-"+(t==null?void 0:t.renderingHashString)},a.create=function(i,t){var e=[],n=function(r){for(var s=r.interleaved,l=r.instancing?"instance":"vertex",u=[],c=r.elements.length,h=0;h<c;h++){var f=r.elements[h],d=me[f.name],p=f.normalize?vi:_i;u.push({shaderLocation:d,offset:s?f.offset:0,format:""+p[f.dataType]+(f.numComponents>1?"x"+f.numComponents:"")}),s&&h!==c-1||(e.push({attributes:u,arrayStride:f.stride,stepMode:l}),u=[])}};return i&&n(i),t&&n(t),e},o}(),w_=function(){function o(a){this.device=a}return o.prototype.getPipelineLayout=function(a){var i=[];return a.forEach(function(t){i.push(t.bindGroupLayout)}),this.device.wgpu.createPipelineLayout({bindGroupLayouts:i})},o}();function A_(o,a){return(A_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var cP=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],C_=["add","subtract","reverse-subtract","min","max"],ou=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],sf=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],hP=["none","back","front"],zs=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],fP=["","uint16","uint32"],dP=function(){},pP=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).lookupHashes=new Uint32Array(14),e.vertexBufferLayout=new uP,e.cache=new Map,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&A_(a,o);var i=a.prototype;return i.get=function(t,e,n,r,s,l,u,c,h,f,d,p,_){var g,y,v,x,S,T,b,w,A=t.type;r&&A!==3&&A!==5&&(r=void 0);var C=this.lookupHashes;C[0]=A,C[1]=s.id,C[2]=f,C[3]=h.key,C[4]=c.key,C[5]=(x=e==null?void 0:e.renderingHash)!=null?x:0,C[6]=(S=n==null?void 0:n.renderingHash)!=null?S:0,C[7]=l.impl.key,C[8]=(T=(g=u[0])==null?void 0:g.key)!=null?T:0,C[9]=(b=(y=u[1])==null?void 0:y.key)!=null?b:0,C[10]=(w=(v=u[2])==null?void 0:v.key)!=null?w:0,C[11]=d?p.key:0,C[12]=d?_.key:0,C[13]=r??0;var L=nf(C),I=this.cache.get(L);if(I)for(var P=0;P<I.length;P++){var M=I[P];if(lP.equals(M.hashes,C))return M.pipeline}var R=cP[A],k=this.getPipelineLayout(u),D=this.vertexBufferLayout.get(e,n),O=new dP;return O.hashes=new Uint32Array(C),O.pipeline=this.create(R,r,s,l,k,c,h,D,f,d,p,_),I?I.push(O):I=[O],this.cache.set(L,I),O.pipeline},i.getBlend=function(t){var e;return t.blend&&(e={color:{operation:C_[t.colorOp],srcFactor:ou[t.colorSrcFactor],dstFactor:ou[t.colorDstFactor]},alpha:{operation:C_[t.alphaOp],srcFactor:ou[t.alphaSrcFactor],dstFactor:ou[t.alphaDstFactor]}}),e},i.getDepthStencil=function(t,e,n,r,s,l){var u,c=e.depth,h=e.stencil;if(c||h){if(u={format:e.impl.depthAttachment.format},c){u.depthWriteEnabled=t.write,u.depthCompare=sf[t.func];var f=l==="triangle-list"||l==="triangle-strip";u.depthBias=f?t.depthBias:0,u.depthBiasSlopeScale=f?t.depthBiasSlope:0}else u.depthWriteEnabled=!1,u.depthCompare="always";h&&n&&(u.stencilReadMas=r.readMask,u.stencilWriteMask=r.writeMask,u.stencilFront={compare:sf[r.func],failOp:zs[r.fail],passOp:zs[r.zpass],depthFailOp:zs[r.zfail]},u.stencilBack={compare:sf[s.func],failOp:zs[s.fail],passOp:zs[s.zpass],depthFailOp:zs[s.zfail]})}return u},i.create=function(t,e,n,r,s,l,u,c,h,f,d,p){var _=this.device.wgpu,g=n.impl,y={vertex:{module:g.getVertexShaderModule(),entryPoint:g.vertexEntryPoint,buffers:c},primitive:{topology:t,frontFace:"ccw",cullMode:hP[h]},depthStencil:this.getDepthStencil(u,r,f,d,p,t),multisample:{count:r.samples},layout:s};e&&(y.primitive.stripIndexFormat=fP[e]),y.fragment={module:g.getFragmentShaderModule(),entryPoint:g.fragmentEntryPoint,targets:[]};var v=r.impl.colorAttachments;if(v.length>0){var x=0;l.redWrite&&(x|=GPUColorWrite.RED),l.greenWrite&&(x|=GPUColorWrite.GREEN),l.blueWrite&&(x|=GPUColorWrite.BLUE),l.alphaWrite&&(x|=GPUColorWrite.ALPHA);var S=this.getBlend(l);v.forEach(function(T){y.fragment.targets.push({format:T.format,writeMask:x,blend:S})})}return _.createRenderPipeline(y)},a}(w_);function P_(o,a){return(P_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var mP=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&P_(a,o);var i=a.prototype;return i.get=function(t,e){var n=this.getPipelineLayout([e.impl]);return this.create(t,n)},i.create=function(t,e){var n=this.device.wgpu,r=t.impl,s={compute:{module:r.getComputeShaderModule(),entryPoint:r.computeEntryPoint},layout:e};return n.createComputePipeline(s)},a}(w_),lu=function(){function o(){this._refCount=0}var a,i=o.prototype;return i.incRefCount=function(){this._refCount++},i.decRefCount=function(){this._refCount--},a=[{key:"refCount",get:function(){return this._refCount}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function I_(o,a){return(I_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var _P=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){var t;return(t=o.call(this)||this).object=i,t.incRefCount(),t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&I_(a,o),a}(lu);function L_(o,a){return(L_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var vP=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&L_(a,o),a.prototype.loseContext=function(i){this.clear()},a}(function(){function o(){this.cache=new Map}var a=o.prototype;return a.destroy=function(){this.cache.forEach(function(i){var t;(t=i.object)==null||t.destroy()}),this.cache.clear()},a.clear=function(){this.cache.clear()},a.get=function(i){var t=this.cache.get(i);return t?(t.incRefCount(),t.object):null},a.set=function(i,t){this.cache.set(i,new _P(t))},a.release=function(i){var t,e=this.cache.get(i);e&&(e.decRefCount(),e.refCount===0&&(this.cache.delete(i),(t=e.object)==null||t.destroy()))},o}()),gP=new It,go=function(o){return gP.get(o,function(){return new vP})},yP=new vo,SP=function(){function o(){}return o.prototype.destroy=function(){var a;(a=this.multisampledBuffer)==null||a.destroy(),this.multisampledBuffer=null},o}(),D_=function(){function o(a){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=a,this.hasStencil=a==="depth24plus-stencil8"}return o.prototype.destroy=function(a){if(this.depthTextureInternal){var i;(i=this.depthTexture)==null||i.destroy(),this.depthTexture=null}this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,go(a).release(this.multisampledDepthBufferKey))},o}(),xP=function(){function o(i){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=i}var a=o.prototype;return a.destroy=function(i){var t;this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach(function(e){e.destroy()}),this.colorAttachments.length=0,(t=this.depthAttachment)==null||t.destroy(i),this.depthAttachment=null},a.updateKey=function(){var i=this.renderTarget.samples+":"+(this.depthAttachment?this.depthAttachment.format:"nodepth");this.colorAttachments.forEach(function(t){i+=":"+t.format}),this.key=yP.get(i)},a.assignColorTexture=function(i,t){this.assignedColorTexture=t;var e=t.createView({format:i.backBufferViewFormat}),n=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?n.resolveTarget=e:n.view=e,this.setColorAttachment(0,void 0,i.backBufferViewFormat),this.updateKey()},a.setColorAttachment=function(i,t,e){this.colorAttachments[i]||(this.colorAttachments[i]=new SP),t&&(this.colorAttachments[i].multisampledBuffer=t),e&&(this.colorAttachments[i].format=e)},a.init=function(i,t){var e=this,n=i.wgpu;this.initDepthStencil(i,n,t),t._colorBuffers&&t._colorBuffers.forEach(function(d,p){e.setColorAttachment(p,void 0,d.impl.format)}),this.renderPassDescriptor.colorAttachments=[];for(var r=this.isBackbuffer?1:(u=(l=t._colorBuffers)==null?void 0:l.length)!=null?u:0,s=0;s<r;++s){var l,u,c,h=this.initColor(i,n,t,s),f=s===0&&((c=this.colorAttachments[0])==null?void 0:c.format);(h.view||f)&&this.renderPassDescriptor.colorAttachments.push(h)}this.updateKey(),this.initialized=!0},a.initDepthStencil=function(i,t,e){var n,r=e.samples,s=e.width,l=e.height,u=e.depth,c=e.depthBuffer;if(u||c){if(c)if(this.depthAttachment=new D_(c.impl.format),r>1){var h="depth24plus-stencil8";this.depthAttachment.format=h,this.depthAttachment.hasStencil=!0;var f=c.id+":"+s+":"+l+":"+r+":"+h,d=go(i),p=d.get(f);if(!p){var _={size:[s,l,1],dimension:"2d",sampleCount:r,format:h,usage:GPUTextureUsage.RENDER_ATTACHMENT|(h!==c.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};p=t.createTexture(_),d.set(f,p)}this.depthAttachment.multisampledDepthBuffer=p,this.depthAttachment.multisampledDepthBufferKey=f,n=p.createView()}else{var g=c.impl.gpuTexture;this.depthAttachment.depthTexture=g,n=g.createView()}else{this.depthAttachment=new D_("depth24plus-stencil8");var y={size:[s,l,1],dimension:"2d",sampleCount:r,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};r>1?y.usage|=GPUTextureUsage.TEXTURE_BINDING:y.usage|=GPUTextureUsage.COPY_SRC;var v=t.createTexture(y);this.depthAttachment.depthTexture=v,this.depthAttachment.depthTextureInternal=!0,n=v.createView()}this.renderPassDescriptor.depthStencilAttachment={view:n}}},a.initColor=function(i,t,e,n){var r={},s=e.samples,l=e.width,u=e.height,c=e.mipLevel,h=e.getColorBuffer(n),f=null;if(h&&(f=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:e.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:c}):h.impl.createView({mipLevelCount:1,baseMipLevel:c})),s>1){var d={size:[l,u,1],dimension:"2d",sampleCount:s,format:this.isBackbuffer?i.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},p=t.createTexture(d);this.setColorAttachment(n,p,d.format),r.view=p.createView(),r.resolveTarget=f}else r.view=f;return r},a.setupForRenderPass=function(i,t){for(var e,n,r=(n=(e=this.renderPassDescriptor.colorAttachments)==null?void 0:e.length)!=null?n:0,s=0;s<r;++s){var l=this.renderPassDescriptor.colorAttachments[s],u=i.colorArrayOps[s];l.clearValue=t.isColorBufferSrgb(s)?u.clearValueLinear:u.clearValue,l.loadOp=u.clear?"clear":"load",l.storeOp=u.store?"store":"discard"}var c=this.renderPassDescriptor.depthStencilAttachment;c&&(c.depthClearValue=i.depthStencilOps.clearDepthValue,c.depthLoadOp=i.depthStencilOps.clearDepth?"clear":"load",c.depthStoreOp=i.depthStencilOps.storeDepth?"store":"discard",c.depthReadOnly=!1,this.depthAttachment.hasStencil&&(c.stencilClearValue=i.depthStencilOps.clearStencilValue,c.stencilLoadOp=i.depthStencilOps.clearStencil?"clear":"load",c.stencilStoreOp=i.depthStencilOps.storeStencil?"store":"discard",c.stencilReadOnly=!1))},a.loseContext=function(){this.initialized=!1},a.resolve=function(i,t,e,n){},o}(),nt=[];nt[2]=1,nt[3]=2,nt[4]=3,nt[5]=4,nt[1]=1,nt[6]=2,nt[7]=3,nt[8]=4,nt[0]=1,nt[9]=2,nt[10]=3,nt[11]=4,nt[12]=8,nt[13]=12,nt[14]=16,nt[26]=1,nt[27]=2,nt[28]=3,nt[29]=4;var Le=function(){var o;function a(i,t,e){if(e===void 0&&(e=0),this.shortName=i,this.name=e?""+i+"[0]":i,this.type=t,this.numComponents=nt[t],this.updateType=t,e>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=30;break;case 26:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=33;break;case 27:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=36;break;case 28:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case 29:this.updateType=40;break;case 11:this.updateType=41;break;case 14:this.updateType=24}this.count=e;var n=this.numComponents;e&&(n=U.roundUp(n,4)),this.byteSize=4*n,e&&(this.byteSize*=e)}return a.prototype.calculateOffset=function(i){var t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),i=U.roundUp(i,t),this.offset=i/4},o=[{key:"isArrayType",get:function(){return this.count>0}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),Gs=function(){function o(a,i){this.byteSize=0,this.map=new Map,this.scope=a.scope,this.uniforms=i;for(var t=0,e=0;e<i.length;e++){var n=i[e];n.calculateOffset(t),t=4*n.offset+n.byteSize,n.scopeId=this.scope.resolve(n.name),this.map.set(n.name,n)}this.byteSize=U.roundUp(t,16)}return o.prototype.get=function(a){return this.map.get(a)},o}(),M_=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,af=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,bP=/([\w-]+)\[(.*?)\]/,TP=new Set(["highp","mediump","lowp"]),EP=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),wP={sampler2D:"2d",sampler3D:"3d",samplerCube:Xn,samplerCubeShadow:Xn,sampler2DShadow:"2d",sampler2DArray:jn,sampler2DArrayShadow:jn,isampler2D:"2d",usampler2D:"2d",isampler3D:"3d",usampler3D:"3d",isamplerCube:Xn,usamplerCube:Xn,isampler2DArray:jn,usampler2DArray:jn},AP=((ja={})["2d"]="texture2D",ja[Xn]="textureCube",ja["3d"]="texture3D",ja[jn]="texture2DArray",ja),CP=function(o,a){this.line=o;var i=o.trim().split(/\s+/);if(TP.has(i[0])&&(this.precision=i.shift()),this.type=i.shift(),o.includes(","),o.includes("[")){var t=i.join(" "),e=bP.exec(t);this.name=e[1],this.arraySize=Number(e[2]),isNaN(this.arraySize)&&(a.failed=!0)}else this.name=i.shift(),this.arraySize=0;this.isSampler=this.type.indexOf("sampler")!==-1,this.isSignedInt=this.type.indexOf("isampler")!==-1,this.isUnsignedInt=this.type.indexOf("usampler")!==-1},PP=function(){function o(){}return o.run=function(a,i,t){var e=new Map,n=o.extract(i.vshader),r=o.extract(i.fshader),s=new Map,l=o.processAttributes(n.attributes,i.attributes,s,i.processingOptions),u=o.processVaryings(n.varyings,e,!0),c=o.processVaryings(r.varyings,e,!1),h=o.processOuts(r.outs),f=Array.from(new Set(n.uniforms.concat(r.uniforms))).map(function(y){return new CP(y,t)}),d=o.processUniforms(a,f,i.processingOptions,t),p=l+`
`+u+`
`+d.code,_=n.src.replace("@@@",p),g=c+`
`+h+`
`+d.code;return{vshader:_,fshader:r.src.replace("@@@",g),attributes:s,meshUniformBufferFormat:d.meshUniformBufferFormat,meshBindGroupFormat:d.meshBindGroupFormat}},o.extract=function(a){for(var i,t=[],e=[],n=[],r=[],s=`@@@
`;(i=M_.exec(a))!==null;){var l=i[1];switch(l){case"attribute":case"varying":case"uniform":case"out":af.lastIndex=i.index;var u=af.exec(a);l==="attribute"?t.push(u[2]):l==="varying"?e.push(u[2]):l==="out"?n.push(u[2]):l==="uniform"&&r.push(u[2]),a=o.cutOut(a,i.index,af.lastIndex,s),M_.lastIndex=i.index+s.length,s=""}}return{src:a,attributes:t,varyings:e,outs:n,uniforms:r}},o.processUniforms=function(a,i,t,e){var n=[],r=[];i.forEach(function(f){f.isSampler?n.push(f):r.push(f)});var s=[];r.forEach(function(f){if(!t.hasUniform(f.name)){var d=Kh.indexOf(f.type),p=new Le(f.name,d,f.arraySize);s.push(p)}}),s.length===0&&s.push(new Le(tu,2));var l=s.length?new Gs(a,s):null,u=[];n.forEach(function(f){if(!t.hasTexture(f.name)){var d=0;f.isSignedInt?d=3:f.isUnsignedInt?d=4:(f.precision==="highp"&&(d=1),EP.has(f.type)&&(d=2));var p=wP[f.type];u.push(new _o(f.name,3,p,d))}});var c=new Br(a,u),h="";return t.uniformFormats.forEach(function(f,d){f&&(h+=o.getUniformShaderDeclaration(f,d,0))}),l&&(h+=o.getUniformShaderDeclaration(l,2,0)),t.bindGroupFormats.forEach(function(f,d){f&&(h+=o.getTexturesShaderDeclaration(f,d))}),{code:h+=o.getTexturesShaderDeclaration(c,1),meshUniformBufferFormat:l,meshBindGroupFormat:c}},o.processVaryings=function(a,i,t){var e="",n=t?"out":"in";return a.forEach(function(r,s){var l=o.splitToWords(r),u=l.slice(0,-1).join(" "),c=l[l.length-1];t?i.set(c,s):s=i.get(c),e+="layout(location = "+s+") "+n+" "+u+" "+c+`;
`}),e},o.processOuts=function(a){var i="";return a.forEach(function(t,e){i+="layout(location = "+e+") out "+t+`;
`}),i},o.getTypeCount=function(a){var i=parseInt(a.substring(a.length-1),10);return isNaN(i)?1:i},o.processAttributes=function(a,i,t,e){var n="";return a.forEach(function(r){var s=o.splitToWords(r),l=s[0],u=s[1];if(i.hasOwnProperty(u)){var c,h=i[u],f=me[h];t.set(f,u);var d=e.getVertexElement(h);if(d){var p=d.dataType;if(p!==6&&p!==7&&!d.normalize&&!d.asInt){var _=o.getTypeCount(l),g="_private_"+u;c="vec"+_+" "+u+" = vec"+_+"("+g+`);
`,u=g;var y=p===0||p===2||p===4;l=_===1?y?"int":"uint":y?"ivec"+_:"uvec"+_}}n+="layout(location = "+f+") in "+l+" "+u+`;
`,c&&(n+=c)}}),n},o.splitToWords=function(a){return(a=a.replace(/\s+/g," ").trim()).split(" ")},o.cutOut=function(a,i,t,e){return a.substring(0,i)+e+a.substring(t)},o.getUniformShaderDeclaration=function(a,i,t){var e=$h[i],n="layout(set = "+i+", binding = "+t+", std140) uniform ub_"+e+` {
`;return a.uniforms.forEach(function(r){var s=Kh[r.type];n+="    "+s+" "+r.shortName+(r.count?"["+r.count+"]":"")+`;
`}),""+n+`};
`},o.getTexturesShaderDeclaration=function(a,i){var t="";return a.textureFormats.forEach(function(e){var n=AP[e.textureDimension],r=n==="texture2DArray",s=e.sampleType===4?"u":e.sampleType===3?"i":"";n=""+s+n;var l="",u="";r&&(l="_texture",u="#define "+e.name+" "+s+"sampler2DArray("+e.name+l+", "+e.name+`_sampler)
`),t+="layout(set = "+i+", binding = "+e.slot+") uniform "+n+" "+e.name+l+`;
`,e.hasSampler&&(t+="layout(set = "+i+", binding = "+(e.slot+1)+") uniform sampler "+e.name+`_sampler;
`),t+=u}),t},o}(),R_=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,of=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,lf=/^[ \t]*var\s*(?:(<storage,[^>]*>)\s*([\w\d_]+)\s*:\s*(.*?)\s*;|(<(?!storage,)[^>]*>)?\s*([\w\d_]+)\s*:\s*(texture_.*|storage_texture_.*|storage\w.*|external_texture|sampler(?:_comparison)?)\s*;)\s*$/gm,IP=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,LP=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,DP={texture_1d:{viewDimension:"1d",baseSampleType:0},texture_2d:{viewDimension:"2d",baseSampleType:0},texture_2d_array:{viewDimension:jn,baseSampleType:0},texture_3d:{viewDimension:"3d",baseSampleType:0},texture_cube:{viewDimension:Xn,baseSampleType:0},texture_cube_array:{viewDimension:oo,baseSampleType:0},texture_multisampled_2d:{viewDimension:"2d",baseSampleType:0},texture_depth_2d:{viewDimension:"2d",baseSampleType:2},texture_depth_2d_array:{viewDimension:jn,baseSampleType:2},texture_depth_cube:{viewDimension:Xn,baseSampleType:2},texture_depth_cube_array:{viewDimension:oo,baseSampleType:2},texture_external:{viewDimension:"2d",baseSampleType:1}},MP=function(o,a){var i=DP[o],t=i.baseSampleType;if(i.baseSampleType===0&&o!=="texture_multisampled_2d")switch(a){case"u32":t=4;break;case"i32":t=3;break;case"f32":t=0;break;case"uff":t=1}return{viewDimension:i.viewDimension,sampleType:t}},RP=function(o,a){var i,t;if(a===2)switch(o){case"2d":return"texture_depth_2d";case jn:return"texture_depth_2d_array";case Xn:return"texture_depth_cube";case oo:return"texture_depth_cube_array"}switch(o){case"1d":i="texture_1d";break;case"2d":i="texture_2d";break;case jn:i="texture_2d_array";break;case"3d":i="texture_3d";break;case Xn:i="texture_cube";break;case oo:i="texture_cube_array"}switch(a){case 0:case 1:t="f32";break;case 4:t="u32";break;case 3:t="i32"}return i+"<"+t+">"},O_={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},k_=function(o){return(o=o.replace(/\s+/g," ").trim()).split(/[\s:]+/)},OP=/array<([^,]+),\s*([^>]+)>/,kP=function(o,a){this.ubName=null,this.arraySize=0,this.line=o;var i=k_(o);if(i.length<2){a.failed=!0;return}if(this.name=i[0],this.type=i.slice(1).join(" "),this.type.includes("array<")){var t=OP.exec(this.type);this.type=t[1].trim(),this.arraySize=Number(t[2]),isNaN(this.arraySize)&&(a.failed=!0)}},NP=/^\s*var\s+(\w+)\s*:\s*(texture_\w+)(?:<(\w+)>)?;\s*$/,FP=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,UP=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,BP=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,VP=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/,N_=function(){function o(a,i){this.originalLine=a,this.line=a,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.type="",this.matchedElements=[];var t,e,n,r,s=this.line.match(NP);if(s){this.name=s[1],this.type=s[2],this.textureFormat=s[3],this.isTexture=!0,(l=this.matchedElements).push.apply(l,[].concat(s));var l,u=MP(this.type,this.textureFormat);this.textureDimension=u.viewDimension,this.sampleType=u.sampleType}var c=this.line.match(FP);c&&(this.isStorageTexture=!0,this.name=c[1],this.textureType=c[2],this.format=c[3],this.access=c[4],(t=this.matchedElements).push.apply(t,[].concat(c)));var h=this.line.match(UP);h&&(this.isStorageBuffer=!0,this.accessMode=h[1]||"none",this.name=h[2],this.type=h[3],(e=this.matchedElements).push.apply(e,[].concat(h)));var f=this.line.match(BP);f&&(this.name=f[1],this.isExternalTexture=!0,(n=this.matchedElements).push.apply(n,[].concat(h)));var d=this.line.match(VP);d&&(this.name=d[1],this.samplerType=d[2],this.isSampler=!0,(r=this.matchedElements).push.apply(r,[].concat(d))),this.matchedElements.length===0&&(i.failed=!0)}return o.prototype.equals=function(a){return this.name===a.name&&this.type===a.type&&this.isTexture===a.isTexture&&this.isSampler===a.isSampler&&this.isStorageTexture===a.isStorageTexture&&this.isStorageBuffer===a.isStorageBuffer&&this.isExternalTexture===a.isExternalTexture&&this.textureFormat===a.textureFormat&&this.textureDimension===a.textureDimension&&this.sampleType===a.sampleType&&this.textureType===a.textureType&&this.format===a.format&&this.access===a.access&&this.accessMode===a.accessMode&&this.samplerType===a.samplerType&&!0},o}(),zP=function(){function o(){}return o.run=function(a,i,t){var e=new Map,n=o.extract(i.vshader),r=o.extract(i.fshader),s=new Map,l=o.processAttributes(n.attributes,i.attributes,s,i.processingOptions,t),u=o.processVaryings(n.varyings,e,!0),c=o.processVaryings(r.varyings,e,!1),h=Array.from(new Set(n.uniforms.concat(r.uniforms))).map(function(x){return new kP(x,t)}),f=o.processUniforms(a,h,i.processingOptions,t);n.src=o.renameUniformAccess(n.src,h),r.src=o.renameUniformAccess(r.src,h);var d=o.mergeResources(n.resources,r.resources,t),p=o.processResources(a,d,i.processingOptions,t),_=o.generateFragmentOutputStruct(r.src,a.maxColorAttachments);n.src=o.copyInputs(n.src,t),r.src=o.copyInputs(r.src,t);var g=l+`
`+u+`
`+f.code+`
`+p.code+`
`,y=n.src.replace("@@@",g),v=c+`
`+_+`
`+f.code+`
`+p.code+`
`;return{vshader:y,fshader:r.src.replace("@@@",v),attributes:s,meshUniformBufferFormat:f.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}},o.extract=function(a){for(var i,t=[],e=[],n=[],r=[],s=`@@@
`;(i=R_.exec(a))!==null;){var l=i[1];of.lastIndex=i.index;var u=of.exec(a);l==="attribute"?t.push(u[2]):l==="varying"?e.push(u[2]):l==="uniform"&&n.push(u[2]),a=o.cutOut(a,i.index,of.lastIndex,s),R_.lastIndex=i.index+s.length,s=""}for(;(i=lf.exec(a))!==null;)r.push(i[0]),a=o.cutOut(a,i.index,lf.lastIndex,s),lf.lastIndex=i.index+s.length,s="";return{src:a,attributes:t,varyings:e,uniforms:n,resources:r}},o.processUniforms=function(a,i,t,e){var n=[];i.forEach(function(l){if(t.hasUniform(l.name))l.ubName="ub_view";else{l.ubName="ub_mesh_ub";var u=Qh.get(l.type),c=new Le(l.name,u,l.arraySize);n.push(c)}}),n.length===0&&n.push(new Le(tu,2));var r=new Gs(a,n),s="";return t.uniformFormats.forEach(function(l,u){l&&(s+=o.getUniformShaderDeclaration(l,u,0))}),r&&(s+=o.getUniformShaderDeclaration(r,2,0)),{code:s,meshUniformBufferFormat:r}},o.renameUniformAccess=function(a,i){return i.forEach(function(t){var e="uniform."+t.name,n=t.ubName+"."+t.name,r=RegExp("\\b"+e+"\\b","g");a=a.replace(r,n)}),a},o.mergeResources=function(a,i,t){var e=a.map(function(n){return new N_(n,t)});return i.map(function(n){return new N_(n,t)}).forEach(function(n){var r=e.find(function(s){return s.name===n.name});r?r.equals(n)||(t.failed=!0):e.push(n)}),e},o.processResources=function(a,i,t,e){for(var n=[],r=0;r<i.length;r++){var s=i[r];if(s.isTexture){var l=i[r+1],u=l==null?void 0:l.isSampler,c=s.sampleType,h=s.textureDimension;n.push(new _o(s.name,3,h,c,u,u?l.name:null)),u&&r++}if(s.isStorageBuffer){var f=s.accessMode!=="read_write",d=new ef(s.name,3,f);d.format=s.type,n.push(d)}}var p=new Br(a,n),_="";return t.bindGroupFormats.forEach(function(g,y){g&&(_+=o.getTextureShaderDeclaration(g,y,1))}),{code:_+=o.getTextureShaderDeclaration(p,1,0),meshBindGroupFormat:p}},o.getUniformShaderDeclaration=function(a,i,t){var e=$h[i],n="struct_ub_"+e,r="struct "+n+` {
`;return a.uniforms.forEach(function(s){var l=Zh[s.type][0];s.count>0?(O_.hasOwnProperty(l)&&(l=O_[l]),r+="    "+s.shortName+": array<"+l+", "+s.count+`>,
`):r+="    "+s.shortName+": "+l+`,
`}),r+=`};
`+("@group("+i+") @binding("+t+") var<uniform> ub_"+e+" : "+n)+`;

`},o.getTextureShaderDeclaration=function(a,i,t){var e="",n=t;return a.textureFormats.forEach(function(r){var s=RP(r.textureDimension,r.sampleType);if(e+="@group("+i+") @binding("+n+") var "+r.name+": "+s+`;
`,n++,r.hasSampler){var l=r.sampleType===2?"sampler_comparison":"sampler";e+="@group("+i+") @binding("+n+") var "+r.samplerName+": "+l+`;
`,n++}}),a.storageBufferFormats.forEach(function(r){var s=r.readOnly?"read":"read_write";e+="@group("+i+") @binding("+n+") var<storage, "+s+"> "+r.name+" : "+r.format+`;
`,n++}),e},o.processVaryings=function(a,i,t){var e="",n="",r="";a.forEach(function(l,u){var c=l.match(IP);if(c){var h=c[1];t?i.set(h,u):u=i.get(h),e+="    @location("+u+") "+l+`,
`,t||(n+="    var<private> "+l+`;
`,r+="    "+h+" = input."+h+`;
`)}}),t?e+=`    @builtin(position) position : vec4f,
`:e+=`    @builtin(position) position : vec4f,
    @builtin(front_facing) frontFacing : bool,
    @builtin(sample_index) sampleIndex : u32
`;var s=t?"":`
            var<private> pcPosition: vec4f;
            var<private> pcFrontFacing: bool;
            var<private> pcSampleIndex: u32;
            `+n+`
            
            // function to copy inputs (varyings) to private global variables
            fn _pcCopyInputs(input: FragmentInput) {
                `+r+`
                pcPosition = input.position;
                pcFrontFacing = input.frontFacing;
                pcSampleIndex = input.sampleIndex;
            }
        `;return`
            struct `+(t?"VertexOutput":"FragmentInput")+` {
                `+e+`
            };
            `+s+`
        `},o.generateFragmentOutputStruct=function(a,i){for(var t=`struct FragmentOutput {
`,e=0;e<i;e++)t+="    @location("+e+") color"+(e>0?e:"")+` : vec4f,
`;return a.search(/\.fragDepth\s*=/)!==-1&&(t+=`    @builtin(frag_depth) fragDepth : f32
`),""+t+`};
`},o.floatAttributeToInt=function(a,i){return{f32:i?"i32":"u32",vec2f:i?"vec2i":"vec2u",vec3f:i?"vec3i":"vec3u",vec4f:i?"vec4i":"vec4u"}[{f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"}[a]||a]||null},o.processAttributes=function(a,i,t,e,n){i===void 0&&(i={});var r="",s="",l="";return a.forEach(function(u){var c=k_(u),h=c[0],f=c[1],d=f;if(i.hasOwnProperty(h)){var p=i[h],_=me[p];t.set(_,h);var g=e.getVertexElement(p);if(g){var y=g.dataType;y===6||y===7||g.normalize||g.asInt||(f=o.floatAttributeToInt(f,y===0||y===2||y===4))}r+="    @location("+_+") "+h+": "+f+`,
`,s+="    var<private> "+u+`;
`,l+="    "+h+" = "+d+"(input."+h+`);
`}}),`
            struct VertexInput {
                `+r+`
                @builtin(vertex_index) vertexIndex : u32,       // built-in vertex index
                @builtin(instance_index) instanceIndex : u32    // built-in instance index
            };

            `+s+`
            var<private> pcVertexIndex: u32;
            var<private> pcInstanceIndex: u32;

            fn _pcCopyInputs(input: VertexInput) {
                `+l+`
                pcVertexIndex = input.vertexIndex;
                pcInstanceIndex = input.instanceIndex;
            }
        `},o.copyInputs=function(a,i){var t=a.match(LP);if(!t||!t[2])return a;var e=t[2],n=t.index+t[0].length-1;return a.slice(0,n+1)+`
    _pcCopyInputs(`+e+");"+a.slice(n+1)},o.cutOut=function(a,i,t,e){return a.substring(0,i)+e+a.substring(t)},o}(),GP=function(){function o(t){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=t;var e,n,r,s=t.definition;s.shaderLanguage===he?(s.cshader?(this._computeCode=(e=s.cshader)!=null?e:null,this.computeUniformBufferFormats=s.computeUniformBufferFormats,this.computeBindGroupFormat=s.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",s.processingOptions?this.processWGSL():(this._vertexCode=(n=s.vshader)!=null?n:null,this._fragmentCode=(r=s.fshader)!=null?r:null,t.meshUniformBufferFormat=s.meshUniformBufferFormat,t.meshBindGroupFormat=s.meshBindGroupFormat)),t.ready=!0):s.processingOptions&&this.processGLSL()}var a,i=o.prototype;return i.destroy=function(t){this._vertexCode=null,this._fragmentCode=null},i.createShaderModule=function(t,e){return this.shader.device.wgpu.createShaderModule({code:t})},i.getVertexShaderModule=function(){return this.createShaderModule(this._vertexCode,"Vertex")},i.getFragmentShaderModule=function(){return this.createShaderModule(this._fragmentCode,"Fragment")},i.getComputeShaderModule=function(){return this.createShaderModule(this._computeCode,"Compute")},i.processGLSL=function(){var t=this.shader,e=PP.run(t.device,t.definition,t);this._vertexCode=this.transpile(e.vshader,"vertex",t.definition.vshader),this._fragmentCode=this.transpile(e.fshader,"fragment",t.definition.fshader),this._vertexCode&&this._fragmentCode?t.ready=!0:t.failed=!0,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat,t.attributes=e.attributes},i.processWGSL=function(){var t=this.shader,e=zP.run(t.device,t.definition,t);this._vertexCode=e.vshader,this._fragmentCode=e.fshader,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat,t.attributes=e.attributes},i.transpile=function(t,e,n){var r=this.shader.device;if(!r.glslang||!r.twgsl)return null;try{var s=r.glslang.compileGLSL(t,e);return r.twgsl.convertSpirV2WGSL(s)}catch{}},i.loseContext=function(){},i.restoreContext=function(t,e){},a=[{key:"vertexCode",get:function(){return this._vertexCode}},{key:"fragmentCode",get:function(){return this._fragmentCode}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function yo(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var Hs=[];Hs[0]="repeat",Hs[1]="clamp-to-edge",Hs[2]="mirror-repeat";var gi=[];gi[0]={level:"nearest",mip:"nearest"},gi[1]={level:"linear",mip:"nearest"},gi[2]={level:"nearest",mip:"nearest"},gi[3]={level:"nearest",mip:"linear"},gi[4]={level:"linear",mip:"nearest"},gi[5]={level:"linear",mip:"linear"};var HP=function(o){},WP=function(){function o(i){this.samplers=[],this.texture=i,this.format=J[i.format],this.create(i.device)}var a=o.prototype;return a.create=function(i){var t,e=this.texture,n=i.wgpu,r=e.numLevels;this.desc={size:{width:e.width,height:e.height,depthOrArrayLayers:e.cubemap?6:e.array?e.arrayLength:1},format:this.format,mipLevelCount:r,sampleCount:1,dimension:e.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(io(e.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(e.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=n.createTexture(this.desc),this.texture.format===17&&(t={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(t)},a.destroy=function(i){},a.propertyChanged=function(i){this.samplers.length=0},a.getView=function(i){return this.uploadImmediate(i,this.texture),this.view},a.createView=function(i){var t,e,n,r,s,l,u,c=i??{},h=this.desc,f=this.texture,d={format:(t=c.format)!=null?t:h.format,dimension:(e=c.dimension)!=null?e:f.cubemap?"cube":f.volume?"3d":f.array?"2d-array":"2d",aspect:(n=c.aspect)!=null?n:"all",baseMipLevel:(r=c.baseMipLevel)!=null?r:0,mipLevelCount:(s=c.mipLevelCount)!=null?s:h.mipLevelCount,baseArrayLayer:(l=c.baseArrayLayer)!=null?l:0,arrayLayerCount:(u=c.arrayLayerCount)!=null?u:h.depthOrArrayLayers};return this.gpuTexture.createView(d)},a.getSampler=function(i,t){var e=this.samplers[t];if(!e){var n=this.texture,r={addressModeU:Hs[n.addressU],addressModeV:Hs[n.addressV],addressModeW:Hs[n.addressW]};!t&&n.compareOnRead&&(t=2),t===2||t===3||t===4?(r.compare="less",r.magFilter="linear",r.minFilter="linear"):t===1||!i.textureFloatFilterable&&(n.format===14||n.format===12)||this.texture.format===17||mi(this.texture.format)?(r.magFilter="nearest",r.minFilter="nearest",r.mipmapFilter="nearest"):(r.magFilter=gi[n.magFilter].level,r.minFilter=gi[n.minFilter].level,r.mipmapFilter=gi[n.minFilter].mip);var s=r.minFilter==="linear"&&r.magFilter==="linear"&&r.mipmapFilter==="linear";r.maxAnisotropy=s?U.clamp(Math.round(n._anisotropy),1,i.maxTextureAnisotropy):1,e=i.wgpu.createSampler(r),this.samplers[t]=e}return e},a.loseContext=function(){},a.uploadImmediate=function(i,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(i),t._needsUpload=!1,t._needsMipmapsUpload=!1)},a.uploadData=function(i){var t=this.texture;if(t._levels){for(var e=!1,n=!1,r=t.numLevels,s=0;s<r;s++){var l=t._levels[s];if(l){if(t.cubemap)for(var u=0;u<6;u++){var c=l[u];c?this.isExternalImage(c)?(this.uploadExternalImage(i,c,s,u),e=!0):ArrayBuffer.isView(c)&&(this.uploadTypedArrayData(i,c,s,u),e=!0):n=!0}else if(!t._volume)if(t.array)if(t.arrayLength===l.length)for(var h=0;h<t._arrayLength;h++){var f=l[h];this.isExternalImage(f)?(this.uploadExternalImage(i,f,s,h),e=!0):ArrayBuffer.isView(f)&&(this.uploadTypedArrayData(i,f,s,h),e=!0)}else n=!0;else this.isExternalImage(l)?(this.uploadExternalImage(i,l,s,0),e=!0):ArrayBuffer.isView(l)&&(this.uploadTypedArrayData(i,l,s,0),e=!0)}else n=!0}e&&n&&t.mipmaps&&!io(t.format)&&!mi(t.format)&&i.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(i._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(i._vram,t._gpuSize)}},a.isExternalImage=function(i){return typeof ImageBitmap<"u"&&yo(i,ImageBitmap)||typeof HTMLVideoElement<"u"&&yo(i,HTMLVideoElement)||typeof HTMLCanvasElement<"u"&&yo(i,HTMLCanvasElement)||typeof OffscreenCanvas<"u"&&yo(i,OffscreenCanvas)},a.uploadExternalImage=function(i,t,e,n){var r={texture:this.gpuTexture,mipLevel:e,origin:[0,0,n],aspect:"all"},s={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};i.submit(),HP(yo(t,HTMLCanvasElement)&&t.getContext("2d")),i.wgpu.queue.copyExternalImageToTexture({source:t,origin:[0,0],flipY:!1},r,s)},a.uploadTypedArrayData=function(i,t,e,n){var r,s,l=this.texture,u=i.wgpu,c={texture:this.gpuTexture,origin:[0,0,n],mipLevel:e},h=En.calcLevelDimension(l.width,e),f=En.calcLevelDimension(l.height,e);En.calcLevelGpuSize(h,f,1,l.format);var d=Ht.get(l.format);if(d.size)r={offset:0,bytesPerRow:d.size*h,rowsPerImage:f},s={width:h,height:f};else if(d.blockSize){var p=function(_){return Math.floor((_+3)/4)};r={offset:0,bytesPerRow:d.blockSize*p(h),rowsPerImage:p(f)},s={width:Math.max(4,h),height:Math.max(4,f)}}i.submit(),u.queue.writeTexture(c,t,r,s)},a.read=function(i,t,e,n,r){var s,l,u,c,h=(s=r.mipLevel)!=null?s:0,f=(l=r.face)!=null?l:0,d=(u=r.data)!=null?u:null,p=(c=r.immediate)!=null&&c,_=this.texture,g=e*Ht.get(_.format).size,y=U.roundUp(g,256),v=y*n,x=_.device,S=x.createBufferImpl(9);S.allocate(x,v);var T={texture:this.gpuTexture,mipLevel:h,origin:[i,t,f]},b={buffer:S.buffer,offset:0,bytesPerRow:y};return x.getCommandEncoder().copyTextureToBuffer(T,b,{width:e,height:n,depthOrArrayLayers:1}),x.readBuffer(S,v,null,p).then(function(w){for(var A,C=(d==null?void 0:d.constructor)===Uint8Array?d:new Uint8Array((A=d==null?void 0:d.buffer)!=null?A:n*g),L=0;L<n;L++){var I=L*y,P=L*g,M=w.subarray(I,I+g);C.set(M,P)}return d??C})},o}();function F_(o,a){return(F_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var jP=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){return o.call(this,64)||this}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&F_(a,o),a.prototype.unlock=function(i){var t=i.device;o.prototype.unlock.call(this,t,i.storageInt32.buffer)},a}(au);function U_(o,a){return(U_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var XP=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e){return o.call(this,32|128*(e!=null&&!!e.storage))||this}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&U_(a,o),a.prototype.unlock=function(i){var t=i.device;o.prototype.unlock.call(this,t,i.storage)},a}(au);function B_(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function V_(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return B_(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return B_(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var wn=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,uf=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,z_=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,cf=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,hf=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,ff=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,G_=/\{?[\w-]+\}?/,YP=/(!|\s)?defined\(([\w-]+)\)/,qP=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,KP=/[+\-]/g,df=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"/g,ZP=/\{i\}/g,H_=/(pcFragColor[1-8])\b/g,W_=function(){function o(){}return o.run=function(a,i,t){i===void 0&&(i=new Map),t===void 0&&(t={}),o.sourceName=t.sourceName,a=(a=this.stripComments(a)).split(/\r?\n/).map(function(s){return s.trimEnd()}).join(`
`);var e=new Map,n=new Map;if((a=this._preprocess(a,e,n,i,t.stripDefines))===null)return null;var r=new Map;return e.forEach(function(s,l){Number.isInteger(parseFloat(s))&&!s.includes(".")&&r.set(l,s)}),a=this.stripComments(a),a=this.stripUnusedColorAttachments(a,t),a=this.RemoveEmptyLines(a),a=this.processArraySize(a,r),a=this.injectDefines(a,n)},o.stripUnusedColorAttachments=function(a,i){if(i.stripUnusedColorAttachments){var t=new Map,e=a.match(H_);if(e==null||e.forEach(function(c){var h,f=parseInt(c.charAt(c.length-1),10);t.set(f,((h=t.get(f))!=null?h:0)+1)}),Array.from(t.values()).some(function(c){return c===1})){for(var n=a.split(`
`),r=[],s=0;s<n.length;s++){var l=n[s].match(H_);if(l){var u=parseInt(l[0].charAt(l[0].length-1),10);if(u>0&&t.get(u)===1)continue}r.push(n[s])}a=r.join(`
`)}}return a},o.stripComments=function(a){return a.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")},o.processArraySize=function(a,i){return a!==null&&i.forEach(function(t,e){a=a.replace(RegExp("\\["+e+"\\]","g"),"["+t+"]")}),a},o.injectDefines=function(a,i){if(a!==null&&i.size>0){var t=a.split(`
`);i.forEach(function(e,n){for(var r=RegExp(n,"g"),s=0;s<t.length;s++)t[s].includes("#")||(t[s]=t[s].replace(r,e))}),a=t.join(`
`)}return a},o.RemoveEmptyLines=function(a){return a!==null&&(a=(a=a.split(/\r?\n/).map(function(i){return i.trim()===""?"":i}).join(`
`)).replace(/(\n\n){3,}/g,`

`)),a},o._preprocess=function(a,i,t,e,n){i===void 0&&(i=new Map);for(var r=[],s=!1;(R=wn.exec(a))!==null&&!s;){var l=R[1];switch(l){case"define":uf.lastIndex=R.index;var u=uf.exec(a);s||(s=u===null);var c=u[1];G_.lastIndex=u.index;var h=G_.exec(c)[0],f=c.substring(h.length).trim();f===""&&(f="true");var d=o._keep(r),p=n;if(d){var _=h.startsWith("{")&&h.endsWith("}");_&&(p=!0),_?t.set(h,f):i.set(h,f),p&&(a=a.substring(0,u.index-1)+a.substring(uf.lastIndex),wn.lastIndex=u.index-1)}p||(wn.lastIndex=u.index+u[0].length);break;case"undef":cf.lastIndex=R.index;var g=cf.exec(a),y=g[1].trim();o._keep(r)&&(i.delete(y),n&&(a=a.substring(0,g.index-1)+a.substring(cf.lastIndex),wn.lastIndex=g.index-1)),n||(wn.lastIndex=g.index+g[0].length);break;case"extension":z_.lastIndex=R.index;var v=z_.exec(a);if(s||(s=v===null),v){var x=v[1];o._keep(r)&&i.set(x,"true")}wn.lastIndex=v.index+v[0].length;break;case"ifdef":case"ifndef":case"if":hf.lastIndex=R.index;var S=hf.exec(a),T=S[2],b=o.evaluate(T,i);s||(s=b.error);var w=b.result;l==="ifndef"&&(w=!w),r.push({anyKeep:w,keep:w,start:R.index,end:hf.lastIndex}),wn.lastIndex=S.index+S[0].length;break;case"endif":case"else":case"elif":ff.lastIndex=R.index;var A=ff.exec(a),C=r.pop();if(!C){s=!0;continue}var L=C.keep?a.substring(C.end,R.index):"";a=a.substring(0,C.start)+L+a.substring(ff.lastIndex),wn.lastIndex=C.start+L.length;var I=A[1];if(I==="else"||I==="elif"){var P=!1;if(!C.anyKeep)if(I==="else")P=!C.keep;else{var M=o.evaluate(A[2],i);P=M.result,s||(s=M.error)}r.push({anyKeep:C.anyKeep||P,keep:P,start:wn.lastIndex,end:wn.lastIndex})}break;case"include":df.lastIndex=R.index;var R,k,D=df.exec(a);if(s||(s=D===null),!D){s=!0;continue}var O=D[1].trim(),F=(k=D[2])==null?void 0:k.trim();if(o._keep(r)){var N=e==null?void 0:e.get(O);if(N!==void 0){if(N=this.stripComments(N),F){var j=parseFloat(i.get(F));if(Number.isInteger(j)){for(var z="",V=0;V<j;V++)z+=N.replace(ZP,String(V));N=z}else s=!0}a=a.substring(0,D.index-1)+N+a.substring(df.lastIndex),wn.lastIndex=D.index-1}else{s=!0;continue}}}}return r.length>0&&(s=!0),s?null:a},o._keep=function(a){for(var i=0;i<a.length;i++)if(!a[i].keep)return!1;return!0},o.evaluateAtomicExpression=function(a,i){var t=!1;a=a.trim();var e=!1,n=YP.exec(a);if(n){e=n[1]==="!",a=n[2].trim();var r=i.has(a);return{result:e?!r:r,error:t}}var s=qP.exec(a);if(s){var l,u,c=(l=i.get(s[1].trim()))!=null?l:s[1].trim(),h=(u=i.get(s[3].trim()))!=null?u:s[3].trim(),f=s[2].trim(),d=!1;switch(f){case"==":d=c===h;break;case"!=":d=c!==h;break;case"<":d=c<h;break;case"<=":d=c<=h;break;case">":d=c>h;break;case">=":d=c>=h;break;default:t=!0}return{result:d,error:t}}return{result:i.has(a),error:t}},o.evaluate=function(a,i){for(var t,e=KP.exec(a)===null,n=a.split("||"),r=V_(n);!(t=r()).done;){for(var s,l=t.value.split("&&"),u=!0,c=V_(l);!(s=c()).done;){var h=s.value,f=o.evaluateAtomicExpression(h.trim(),i),d=f.result,p=f.error;if(!d||p){u=!1;break}}if(u)return{result:!0,error:!e}}return{result:!1,error:!e}},o}(),j_=`
#ifndef outType_0
#define outType_0 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
#if COLOR_ATTACHMENT_1
layout(location = 1) out highp outType_1 pcFragColor1;
#endif
#if COLOR_ATTACHMENT_2
layout(location = 2) out highp outType_2 pcFragColor2;
#endif
#if COLOR_ATTACHMENT_3
layout(location = 3) out highp outType_3 pcFragColor3;
#endif
#if COLOR_ATTACHMENT_4
layout(location = 4) out highp outType_4 pcFragColor4;
#endif
#if COLOR_ATTACHMENT_5
layout(location = 5) out highp outType_5 pcFragColor5;
#endif
#if COLOR_ATTACHMENT_6
layout(location = 6) out highp outType_6 pcFragColor6;
#endif
#if COLOR_ATTACHMENT_7
layout(location = 7) out highp outType_7 pcFragColor7;
#endif
#define gl_FragColor pcFragColor0
#define varying in
#define texture2D texture
#define texture2DBias texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLod textureLod
#define texture2DProjLod textureProjLod
#define textureCubeLod textureLod
#define texture2DGrad textureGrad
#define texture2DProjGrad textureProjGrad
#define textureCubeGrad textureGrad
#define utexture2D texture
#define itexture2D texture
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2DShadow name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
#define GL2
`,X_=`
#define attribute in
#define varying out
#define texture2D texture
#define utexture2D texture
#define itexture2D texture
#define GL2
#define VERTEXSHADER
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
`,Y_=`
#extension GL_EXT_samplerless_texture_functions : require
#ifndef outType_0
#define outType_0 vec4
#endif
#ifndef outType_1
#define outType_1 vec4
#endif
#ifndef outType_2
#define outType_2 vec4
#endif
#ifndef outType_3
#define outType_3 vec4
#endif
#ifndef outType_4
#define outType_4 vec4
#endif
#ifndef outType_5
#define outType_5 vec4
#endif
#ifndef outType_6
#define outType_6 vec4
#endif
#ifndef outType_7
#define outType_7 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
layout(location = 1) out highp outType_1 pcFragColor1;
layout(location = 2) out highp outType_2 pcFragColor2;
layout(location = 3) out highp outType_3 pcFragColor3;
layout(location = 4) out highp outType_4 pcFragColor4;
layout(location = 5) out highp outType_5 pcFragColor5;
layout(location = 6) out highp outType_6 pcFragColor6;
layout(location = 7) out highp outType_7 pcFragColor7;
#define gl_FragColor pcFragColor0
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)
#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)
#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)
#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)
#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define SHADOWMAP_PASS(name) name, name ## _sampler
#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
`,q_=`
#extension GL_EXT_samplerless_texture_functions : require
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
#define VERTEXSHADER
#define gl_VertexID gl_VertexIndex
#define gl_InstanceID gl_InstanceIndex
`,K_=`
#define VERTEXSHADER
`,Z_=`
vec2 getGrabScreenPos(vec4 clipPos) {
	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
vec2 getImageEffectUV(vec2 uv) {
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
`,Q_=`
fn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {
	var uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);
	uv.y = 1.0 - uv.y;
	return uv;
}
fn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {
	var modifiedUV: vec2<f32> = uv;
	modifiedUV.y = 1.0 - modifiedUV.y;
	return modifiedUV;
}
struct WrappedF32 { @size(16) element: f32 }
struct WrappedI32 { @size(16) element: i32 }
struct WrappedU32 { @size(16) element: u32 }
struct WrappedVec2F { @size(16) element: vec2f }
struct WrappedVec2I { @size(16) element: vec2i }
struct WrappedVec2U { @size(16) element: vec2u }
`,QP={vertex_position:oe,vertex_normal:bt,vertex_tangent:hn,vertex_texCoord0:mt,vertex_texCoord1:Hn,vertex_texCoord2:Dr,vertex_texCoord3:Mr,vertex_texCoord4:Rr,vertex_texCoord5:Or,vertex_texCoord6:kr,vertex_texCoord7:Nr,vertex_color:st,vertex_boneIndices:Pt,vertex_boneWeights:fn},ir=function(){function o(){}return o.createDefinition=function(a,i){var t,e,n,r,s=function(h,f,d,p){var _=a.isWebGPU?h:f,g="";if(!d){var y=(x=p.fragmentOutputTypes)!=null?x:"vec4";Array.isArray(y)||(y=[y]);for(var v=0;v<a.maxColorAttachments;v++){g+="#define COLOR_ATTACHMENT_"+v+`
`;var x,S,T=(S=y[v])!=null?S:"vec4";g+="#define outType_"+v+" "+T+`
`}}return g+_},l=(t=i.name)!=null?t:"Untitled",u=o.getDefinesCode(a,i.vertexDefines),c=o.getDefinesCode(a,i.fragmentDefines);return i.shaderLanguage===he?(e=`
                `+K_+`
                `+Q_+`
                `+u+`
                `+i.vertexCode+`
            `,n=`
                

                `+Q_+`
                `+c+`
                `+i.fragmentCode+`
            `):(e=o.versionCode(a)+s(q_,X_,!0,i)+u+o.precisionCode(a)+`
                `+Z_+`
                `+o.getShaderNameCode(l)+`
                `+i.vertexCode,n=(i.fragmentPreamble||"")+o.versionCode(a)+s(Y_,j_,!1,i)+c+o.precisionCode(a)+`
                `+Z_+`
                `+o.getShaderNameCode(l)+`
                `+i.fragmentCode),{name:l,shaderLanguage:(r=i.shaderLanguage)!=null?r:ue,attributes:i.attributes,vshader:e,vincludes:i.vertexIncludes,fincludes:i.fragmentIncludes,fshader:n,useTransformFeedback:i.useTransformFeedback,meshUniformBufferFormat:i.meshUniformBufferFormat,meshBindGroupFormat:i.meshBindGroupFormat}},o.getDefinesCode=function(a,i){var t="";return a.capsDefines.forEach(function(e,n){t+="#define "+n+" "+e+`
`}),t+=`
`,i==null||i.forEach(function(e,n){t+="#define "+n+" "+e+`
`}),t+=`
`},o.getShaderNameCode=function(a){return"#define SHADER_NAME "+a+`
`},o.versionCode=function(a){return a.isWebGPU?`#version 450
`:`#version 300 es
`},o.precisionCode=function(a,i){i&&i!=="highp"&&i!=="mediump"&&i!=="lowp"&&(i=null),i&&(i==="highp"&&a.maxPrecision!=="highp"&&(i="mediump"),i==="mediump"&&a.maxPrecision==="lowp"&&(i="lowp"));var t=i||a.precision;return`
            precision `+t+` float;
            precision `+t+` int;
            precision `+t+` usampler2D;
            precision `+t+` isampler2D;
            precision `+t+` sampler2DShadow;
            precision `+t+` samplerCubeShadow;
            precision `+t+` sampler2DArray;
        `},o.collectAttributes=function(a){for(var i={},t=0,e=a.indexOf("attribute");e>=0&&(!(e>0)||a[e-1]!=="/");){var n=!1;if(e>0){var r=a.lastIndexOf(`
`,e);r=r!==-1?r+1:0,a.substring(r,e).includes("#")&&(n=!0)}if(!n){var s=a.indexOf(";",e),l=a.lastIndexOf(" ",s),u=a.substring(l+1,s);if(!i[u]){var c=QP[u];c!==void 0?i[u]=c:(i[u]="ATTR"+t,t++)}}e=a.indexOf("attribute",e+1)}return i},o}(),JP=0,rr=function(){function o(t,e){if(this.attributes=new Map,this.id=JP++,this.device=t,this.definition=e,this.name=e.name||"Untitled",this.init(),!e.cshader){var n=e.shaderLanguage===he;e.vshader=W_.run(e.vshader,e.vincludes,{sourceName:"vertex shader for "+this.label,stripDefines:n}),e.shaderLanguage===ue&&(e.attributes!=null||(e.attributes=ir.collectAttributes(e.vshader)));var r=t.isWebGL2&&(fe.name==="osx"||fe.name==="ios");if(e.fshader=W_.run(e.fshader,e.fincludes,{stripUnusedColorAttachments:r,stripDefines:n,sourceName:"fragment shader for "+this.label}),!e.vshader||!e.fshader){this.failed=!0;return}}this.impl=t.createShaderImpl(this)}var a,i=o.prototype;return i.init=function(){this.ready=!1,this.failed=!1},i.destroy=function(){this.device.onDestroyShader(this),this.impl.destroy(this)},i.loseContext=function(){this.init(),this.impl.loseContext()},i.restoreContext=function(){this.impl.restoreContext(this.device,this)},a=[{key:"label",get:function(){return"Shader Id "+this.id+" ("+(this.definition.shaderLanguage===he?"WGSL":"GLSL")+") "+this.name}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),$P=function(){},e1=function(){},t1=function(){function o(i,t,e){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=i,this.bufferSize=t,this.bufferAlignment=e}var a=o.prototype;return a.destroy=function(){var i=this;this.gpuBuffers.forEach(function(t){t.destroy(i.device)}),this.gpuBuffers=null,this.stagingBuffers.forEach(function(t){t.destroy(i.device)}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null},a.alloc=function(i,t){if(this.activeBuffer){var e=U.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-e<t&&this.scheduleSubmit()}if(!this.activeBuffer){var n=this.gpuBuffers.pop();n||(n=this.createBuffer(this.device,this.bufferSize,!1));var r=this.stagingBuffers.pop();r||(r=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new $P,this.activeBuffer.stagingBuffer=r,this.activeBuffer.gpuBuffer=n,this.activeBuffer.offset=0,this.activeBuffer.size=0}var s=this.activeBuffer,l=U.roundUp(s.size,this.bufferAlignment);i.gpuBuffer=s.gpuBuffer,i.offset=l,i.storage=s.stagingBuffer.alloc(l,t),s.size=l+t},a.scheduleSubmit=function(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)},a.submit=function(){this.scheduleSubmit()},o}(),we=[];we[2]=function(o,a,i){o.storageFloat32[i]=a},we[3]=function(o,a,i){var t=o.storageFloat32;t[i]=a[0],t[i+1]=a[1]},we[4]=function(o,a,i){var t=o.storageFloat32;t[i]=a[0],t[i+1]=a[1],t[i+2]=a[2]},we[5]=function(o,a,i){var t=o.storageFloat32;t[i]=a[0],t[i+1]=a[1],t[i+2]=a[2],t[i+3]=a[3]},we[1]=function(o,a,i){o.storageInt32[i]=a},we[6]=function(o,a,i){var t=o.storageInt32;t[i]=a[0],t[i+1]=a[1]},we[7]=function(o,a,i){var t=o.storageInt32;t[i]=a[0],t[i+1]=a[1],t[i+2]=a[2]},we[8]=function(o,a,i){var t=o.storageInt32;t[i]=a[0],t[i+1]=a[1],t[i+2]=a[2],t[i+3]=a[3]},we[12]=function(o,a,i){var t=o.storageFloat32;t[i]=a[0],t[i+1]=a[1],t[i+4]=a[2],t[i+5]=a[3],t[i+8]=a[4],t[i+9]=a[5]},we[13]=function(o,a,i){var t=o.storageFloat32;t[i]=a[0],t[i+1]=a[1],t[i+2]=a[2],t[i+4]=a[3],t[i+5]=a[4],t[i+6]=a[5],t[i+8]=a[6],t[i+9]=a[7],t[i+10]=a[8]},we[17]=function(o,a,i,t){for(var e=o.storageFloat32,n=0;n<t;n++)e[i+4*n]=a[n]},we[21]=function(o,a,i,t){for(var e=o.storageFloat32,n=0;n<t;n++)e[i+4*n]=a[2*n],e[i+4*n+1]=a[2*n+1]},we[22]=function(o,a,i,t){for(var e=o.storageFloat32,n=0;n<t;n++)e[i+4*n]=a[3*n],e[i+4*n+1]=a[3*n+1],e[i+4*n+2]=a[3*n+2]},we[26]=function(o,a,i,t){o.storageUint32[i]=a},we[27]=function(o,a,i,t){var e=o.storageUint32;e[i]=a[0],e[i+1]=a[1]},we[28]=function(o,a,i,t){var e=o.storageUint32;e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2]},we[29]=function(o,a,i,t){var e=o.storageUint32;e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2],e[i+3]=a[3]},we[30]=function(o,a,i,t){for(var e=o.storageInt32,n=0;n<t;n++)e[i+4*n]=a[n]},we[32]=we[30],we[31]=function(o,a,i,t){for(var e=o.storageUint32,n=0;n<t;n++)e[i+4*n]=a[n]},we[33]=function(o,a,i,t){for(var e=o.storageInt32,n=0;n<t;n++)e[i+4*n]=a[2*n],e[i+4*n+1]=a[2*n+1]},we[35]=we[33],we[34]=function(o,a,i,t){for(var e=o.storageUint32,n=0;n<t;n++)e[i+4*n]=a[2*n],e[i+4*n+1]=a[2*n+1]},we[36]=function(o,a,i,t){for(var e=o.storageInt32,n=0;n<t;n++)e[i+4*n]=a[3*n],e[i+4*n+1]=a[3*n+1],e[i+4*n+2]=a[3*n+2]},we[38]=we[36],we[37]=function(o,a,i,t){for(var e=o.storageUint32,n=0;n<t;n++)e[i+4*n]=a[3*n],e[i+4*n+1]=a[3*n+1],e[i+4*n+2]=a[3*n+2]};var So=function(){function o(t,e,n){if(n===void 0&&(n=!0),this.renderVersionDirty=0,this.device=t,this.format=e,this.persistent=n,n){this.impl=t.createUniformBufferImpl(this);var r=new ArrayBuffer(e.byteSize);this.assignStorage(new Int32Array(r)),t._vram.ub+=this.format.byteSize}else this.allocation=new e1}var a,i=o.prototype;return i.destroy=function(){if(this.persistent){var t=this.device;this.impl.destroy(t),t._vram.ub-=this.format.byteSize}},i.assignStorage=function(t){this.storageInt32=t,this.storageUint32=new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4),this.storageFloat32=new Float32Array(t.buffer,t.byteOffset,t.byteLength/4)},i.loseContext=function(){var t;(t=this.impl)==null||t.loseContext()},i.setUniform=function(t,e){var n=t.offset;if(e!=null){var r=we[t.updateType];r?r(this,e,n,t.count):this.storageFloat32.set(e,n)}},i.set=function(t,e){var n=this.format.map.get(t);n&&this.setUniform(n,e)},i.startUpdate=function(t){if(!this.persistent){var e=this.allocation,n=e.gpuBuffer;this.device.dynamicBuffers.alloc(e,this.format.byteSize),this.assignStorage(e.storage),t&&(t.bindGroup=e.gpuBuffer.getBindGroup(this),t.offsets[0]=e.offset),n!==e.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}},i.endUpdate=function(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)},i.update=function(t){this.startUpdate(t);for(var e=this.format.uniforms,n=0;n<e.length;n++){var r=e[n].scopeId.value;this.setUniform(e[n],r)}this.endUpdate()},a=[{key:"offset",get:function(){return this.persistent?0:this.allocation.offset}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),n1={type:5,base:0,count:4,indexed:!1},i1=function(){function o(i){var t=`

            struct ub_mesh {
                color : vec4f,
                depth: f32
            }

            @group(2) @binding(0) var<uniform> ubMesh : ub_mesh;

            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
                vec2(-1.0, 1.0), vec2(1.0, 1.0),
                vec2(-1.0, -1.0), vec2(1.0, -1.0)
            );

            struct VertexOutput {
                @builtin(position) position : vec4f
            }

            @vertex
            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
                var output : VertexOutput;
                output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);
                return output;
            }

            @fragment
            fn fragmentMain() -> @location(0) vec4f {
                return ubMesh.color;
            }
        `;this.shader=new rr(i,{name:"WebGPUClearRendererShader",shaderLanguage:he,vshader:t,fshader:t}),this.uniformBuffer=new So(i,new Gs(i,[new Le("color",5),new Le("depth",2)]),!1),this.dynamicBindGroup=new tf,this.colorData=new Float32Array(4)}var a=o.prototype;return a.destroy=function(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null},a.clear=function(i,t,e,n){var r=(u=(e=e||n).flags)!=null?u:n.flags;if(r!==0){var s=this.uniformBuffer,l=this.dynamicBindGroup;if(s.startUpdate(l),i.setBindGroup(2,l.bindGroup,l.offsets),i.setBindGroup(1,i.emptyBindGroup),1&r&&(t.colorBuffer||t.impl.assignedColorTexture)){var u,c,h=(c=e.color)!=null?c:n.color;this.colorData.set(h),i.setBlendState(ge.NOBLEND)}else i.setBlendState(ge.NOWRITE);if(s.set("color",this.colorData),2&r&&t.depth){var f,d=(f=e.depth)!=null?f:n.depth;s.set("depth",d),i.setDepthState(Xe.WRITEDEPTH)}else s.set("depth",1),i.setDepthState(Xe.NODEPTH);4&r&&t.stencil,s.endUpdate(),i.setCullMode(0),i.setShader(this.shader),i.draw(n1)}},o}(),r1=function(){function o(i){this.device=i;var t=`
 
            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
                vec2(-1.0, 1.0), vec2(1.0, 1.0),
                vec2(-1.0, -1.0), vec2(1.0, -1.0)
            );

            struct VertexOutput {
                @builtin(position) position : vec4f,
                @location(0) texCoord : vec2f
            };

            @vertex
            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
              var output : VertexOutput;
              output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);
              output.position = vec4f(pos[vertexIndex], 0, 1);
              return output;
            }

            @group(0) @binding(0) var imgSampler : sampler;
            @group(0) @binding(1) var img : texture_2d<f32>;

            @fragment
            fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {
              return textureSample(img, imgSampler, texCoord);
            }
        `;this.shader=new rr(i,{name:"WebGPUMipmapRendererShader",shaderLanguage:he,vshader:t,fshader:t}),this.minSampler=i.wgpu.createSampler({minFilter:"linear"})}var a=o.prototype;return a.destroy=function(){this.shader.destroy(),this.shader=null},a.generate=function(i){var t=i.desc;if(!(t.mipLevelCount<=1)&&!i.texture.volume){for(var e=this.device,n=e.wgpu,r=this.shader.impl,s=n.createRenderPipeline({layout:"auto",vertex:{module:r.getVertexShaderModule(),entryPoint:r.vertexEntryPoint},fragment:{module:r.getFragmentShaderModule(),entryPoint:r.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),l=i.texture,u=l.cubemap?6:l.array?l.arrayLength:1,c=[],h=0;h<u;h++)c.push(i.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:h}));for(var f=e.getCommandEncoder(),d=1;d<t.mipLevelCount;d++)for(var p=0;p<u;p++){var _=i.createView({dimension:"2d",baseMipLevel:d,mipLevelCount:1,baseArrayLayer:p}),g=f.beginRenderPass({colorAttachments:[{view:_,loadOp:"clear",storeOp:"store"}]}),y=n.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:c[p]}]});g.setPipeline(s),g.setBindGroup(0,y),g.draw(4),g.end(),c[p]=_}e.pipeline=null}},o}();function J_(o,a){return(J_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var s1=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){var r;return(r=o.call(this,t)||this).buffer=null,r.mappedRange=null,r.buffer=t.wgpu.createBuffer({size:e,usage:n?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:n}),n&&r.onAvailable(),t._vram.ub+=e,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&J_(a,o);var i=a.prototype;return i.destroy=function(t){t._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null},i.onAvailable=function(){this.mappedRange=this.buffer.getMappedRange()},i.alloc=function(t,e){return new Int32Array(this.mappedRange,t,e/4)},a}(function(){function o(a){this.bindGroupCache=new Map,this.device=a,this.bindGroupFormat=new Br(this.device,[new mo(ho,3)])}return o.prototype.getBindGroup=function(a){var i=a.format.byteSize,t=this.bindGroupCache.get(i);return t||((t=new Fs(this.device,this.bindGroupFormat,a)).update(),this.bindGroupCache.set(i,t)),t},o}());function $_(o,a){return($_=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var a1=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return t=o.apply(this,arguments)||this,t.pendingStagingBuffers=[],t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&$_(a,o);var i=a.prototype;return i.createBuffer=function(t,e,n){return new s1(t,e,n)},i.submit=function(){o.prototype.submit.call(this);var t=this.usedBuffers.length;if(t){for(var e=this.device,n=this.gpuBuffers,r=e.wgpu.createCommandEncoder(),s=t-1;s>=0;s--){var l=this.usedBuffers[s],u=l.stagingBuffer,c=l.gpuBuffer,h=l.offset,f=l.size,d=u.buffer;d.unmap(),r.copyBufferToBuffer(d,h,c.buffer,h,f),n.push(c)}var p=r.finish();e.addCommandBuffer(p,!0);for(var _=0;_<t;_++){var g=this.usedBuffers[_].stagingBuffer;this.pendingStagingBuffers.push(g)}this.usedBuffers.length=0}},i.onCommandBuffersSubmitted=function(){var t=this,e=this.pendingStagingBuffers.length;if(e){for(var n,r=0;r<e;r++)n=this,function(s){var l=n.pendingStagingBuffers[s];l.buffer.mapAsync(GPUMapMode.WRITE).then(function(){t.stagingBuffers&&(l.onAvailable(),t.stagingBuffers.push(l))})}(r);this.pendingStagingBuffers.length=0}},a}(t1),ev=function(){function o(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}var a,i=o.prototype;return i.loseContext=function(){this.pastFrameAllocations.clear()},i.processEnableRequest=function(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))},i.request=function(t){this.pastFrameAllocations.set(t,this.frameAllocations),this.frameAllocations=[]},i.report=function(t,e){if(e){var n=this.pastFrameAllocations.get(t);if(e.length>0&&(this._frameTime=e[0]),Wl.get(Vm))for(var r=0;r<n.length;++r)n[r],e[r]}this.pastFrameAllocations.delete(t)},i.getSlot=function(t){var e=this.frameAllocations.length;return this.frameAllocations.push(t),e},a=[{key:"enabled",get:function(){return this._enableRequest},set:function(t){this._enableRequest=t}},{key:"slotCount",get:function(){return this.frameAllocations.length}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),o1=function(){function o(i,t,e){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=i,this.capacity=e,this.bytesPerSlot=t?8:4;var n=i.wgpu;this.querySet=n.createQuerySet({type:t?"timestamp":"occlusion",count:e}),this.queryBuffer=n.createBuffer({size:this.bytesPerSlot*e,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}var a=o.prototype;return a.destroy=function(){var i,t;(i=this.querySet)==null||i.destroy(),this.querySet=null,(t=this.queryBuffer)==null||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(function(e){e.destroy()}),this.stagingBuffers=null},a.getStagingBuffer=function(){var i=this.stagingBuffers.pop();return i||(i=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),i},a.resolve=function(i){var t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,i,this.queryBuffer,0);var e=this.getStagingBuffer();this.activeStagingBuffer=e,t.copyBufferToBuffer(this.queryBuffer,0,e,0,this.bytesPerSlot*i)},a.request=function(i,t){var e=this,n=this.activeStagingBuffer;return this.activeStagingBuffer=null,n.mapAsync(GPUMapMode.READ).then(function(){for(var r,s=new BigInt64Array(n.getMappedRange()),l=[],u=0;u<i;u++)l.push(1e-6*Number(s[2*u+1]-s[2*u]));return n.unmap(),(r=e.stagingBuffers)==null||r.push(n),{renderVersion:t,timings:l}})},o}();function tv(o,a){return(tv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var l1=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this).device=t,e.timestampQueriesSet=t.supportsTimestampQuery?new o1(t,!0,512):null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&tv(a,o);var i=a.prototype;return i.destroy=function(){var t;(t=this.timestampQueriesSet)==null||t.destroy(),this.timestampQueriesSet=null},i.frameStart=function(){this.processEnableRequest()},i.frameEnd=function(){if(this._enabled){var t;(t=this.timestampQueriesSet)==null||t.resolve(2*this.slotCount)}},i.request=function(){var t=this;if(this._enabled){var e,n=this.device.renderVersion;(e=this.timestampQueriesSet)==null||e.request(this.slotCount,n).then(function(r){t.report(r.renderVersion,r.timings)}),o.prototype.request.call(this,n)}},a}(ev),u1=function(){function o(i){this.pipelineCache=new Map,this.device=i;var t=`
 
            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
                vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
            );

            struct VertexOutput {
                @builtin(position) position : vec4f,
            };

            @vertex
            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
              var output : VertexOutput;
              output.position = vec4f(pos[vertexIndex], 0, 1);
              return output;
            }

            @group(0) @binding(0) var img : texture_depth_multisampled_2d;

            @fragment
            fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {
                // load th depth value from sample index 0
                var depth = textureLoad(img, vec2i(fragColor.xy), 0u);
                return vec4f(depth, 0.0, 0.0, 0.0);
            }
        `;this.shader=new rr(i,{name:"WebGPUResolverDepthShader",shaderLanguage:he,vshader:t,fshader:t})}var a=o.prototype;return a.destroy=function(){this.shader.destroy(),this.shader=null,this.pipelineCache=null},a.getPipeline=function(i){var t=this.pipelineCache.get(i);return t||(t=this.createPipeline(i),this.pipelineCache.set(i,t)),t},a.createPipeline=function(i){var t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:i}]},primitive:{topology:"triangle-strip"}})},a.resolveDepth=function(i,t,e){for(var n=this.device,r=n.wgpu,s=this.getPipeline(e.format),l=t.depthOrArrayLayers,u=0;u<l;u++){var c=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:u}),h=e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:u}),f=i.beginRenderPass({colorAttachments:[{view:h,loadOp:"clear",storeOp:"store"}]}),d=r.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:c}]});f.setPipeline(s),f.setBindGroup(0,d),f.draw(4),f.end()}n.pipeline=null},o}(),c1=function(){function o(i){this.uniformBuffers=[],this.bindGroup=null,this.compute=i;var t=i.device,e=i.shader,n=e.impl,r=n.computeBindGroupFormat,s=n.computeUniformBufferFormats;if(this.bindGroup=new Fs(t,r),s){for(var l in s)if(s.hasOwnProperty(l)){var u=new So(t,s[l],!0);this.uniformBuffers.push(u),this.bindGroup.setUniformBuffer(l,u)}}this.pipeline=t.computePipeline.get(e,r)}var a=o.prototype;return a.destroy=function(){this.uniformBuffers.forEach(function(i){return i.destroy()}),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null},a.updateBindGroup=function(){var i=this.bindGroup;i.updateUniformBuffers(),i.update()},a.dispatch=function(i,t,e){var n=this.compute.device;n.setBindGroup(0,this.bindGroup);var r=n.passEncoder;r.setPipeline(this.pipeline),r.dispatchWorkgroups(i,t,e)},o}();function nv(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function pf(o){return function(){var a=this,i=arguments;return new Promise(function(t,e){var n=o.apply(a,i);function r(l){nv(n,t,e,r,s,"next",l)}function s(l){nv(n,t,e,r,s,"throw",l)}r(void 0)})}}function iv(o,a){return(iv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function mf(o,a){var i,t,e,n={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]},r=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return r.next=s(0),r.throw=s(1),r.return=s(2),typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function s(l){return function(u){var c=[l,u];if(i)throw TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(n=0)),n;)try{if(i=1,t&&(e=2&c[0]?t.return:c[0]?t.throw||((e=t.return)&&e.call(t),0):t.next)&&!(e=e.call(t,c[1])).done)return e;switch(t=0,e&&(c=[2&c[0],e.value]),c[0]){case 0:case 1:e=c;break;case 4:return n.label++,{value:c[1],done:!1};case 5:n.label++,t=c[1],c=[0];continue;case 7:c=n.ops.pop(),n.trys.pop();continue;default:if(!(e=(e=n.trys).length>0&&e[e.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!e||c[1]>e[0]&&c[1]<e[3])){n.label=c[1];break}if(c[0]===6&&n.label<e[1]){n.label=e[1],e=c;break}if(e&&n.label<e[2]){n.label=e[2],n.ops.push(c);break}e[2]&&n.ops.pop(),n.trys.pop();continue}c=a.call(o,n)}catch(h){c=[6,h],t=0}finally{i=e=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var _f=new Map,rv=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n,r,s;return e===void 0&&(e={}),(n=o.call(this,t,e)||this).renderPipeline=new pP(n),n.computePipeline=new mP(n),n.pipeline=null,n.bindGroupFormats=[],n.commandEncoder=null,n.commandBuffers=[],n.glslang=null,n.twgsl=null,(e=n.initOptions).alpha=(r=e.alpha)==null||r,n.backBufferAntialias=(s=e.antialias)!=null&&s,n.isWebGPU=!0,n._deviceType=Jh,n.scope.resolve(tu).setValue(0),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&iv(a,o);var i=a.prototype;return i.destroy=function(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,o.prototype.destroy.call(this)},i.initDeviceCaps=function(){var t,e=(t=this.wgpu)==null?void 0:t.limits;this.limits=e,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=e.maxTextureDimension2D,this.maxCubeMapSize=e.maxTextureDimension2D,this.maxVolumeSize=e.maxTextureDimension3D,this.maxColorAttachments=e.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=e.maxUniformBufferBindingSize/16,this.vertexUniformsCount=e.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;var n=window.navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=n==null?void 0:n.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines()},i.initWebGpu=function(t,e){var n=this;return pf(function(){var r,s;return mf(this,function(l){switch(l.label){case 0:if(!window.navigator.gpu)throw Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");return t&&e?(r=function(u){return new URL(u,window.location.href).toString()},[4,Promise.all([Function("modulePath","return import(modulePath)")(""+r(e)).then(function(u){return twgsl(e.replace(".js",".wasm"))}),Function("modulePath","return import(modulePath)")(""+r(t)).then(function(u){return u.default()})])]):[3,2];case 1:n.twgsl=(s=l.sent())[0],n.glslang=s[1],l.label=2;case 2:return[2,n.createDevice()]}})})()},i.createDevice=function(){var t=this;return pf(function(){var e,n,r,s,l,u,c,h,f,d,p,_,g;return mf(this,function(y){switch(y.label){case 0:return s={powerPreference:t.initOptions.powerPreference!=="default"?t.initOptions.powerPreference:void 0,xrCompatible:t.initOptions.xrCompatible},[4,window.navigator.gpu.requestAdapter(s)];case 1:if(t.gpuAdapter=y.sent(),l=[],u=function(x){var S=t.gpuAdapter.features.has(x);return S&&l.push(x),S},t.textureFloatFilterable=u("float32-filterable"),t.textureFloatBlendable=u("float32-blendable"),t.extCompressedTextureS3TC=u("texture-compression-bc"),t.extCompressedTextureETC=u("texture-compression-etc2"),t.extCompressedTextureASTC=u("texture-compression-astc"),t.supportsTimestampQuery=u("timestamp-query"),t.supportsDepthClip=u("depth-clip-control"),t.supportsDepth32Stencil=u("depth32float-stencil8"),t.supportsIndirectFirstInstance=u("indirect-first-instance"),t.supportsShaderF16=u("shader-f16"),t.supportsStorageRGBA8=u("bgra8unorm-storage"),t.textureRG11B10Renderable=u("rg11b10ufloat-renderable"),t.supportsClipDistances=u("clip-distances"),c=(e=t.gpuAdapter)==null?void 0:e.limits,h={},c)for(var v in c)v!=="minSubgroupSize"&&v!=="maxSubgroupSize"&&(h[v]=c[v]);return f={requiredFeatures:l,requiredLimits:h,defaultQueue:{label:"Default Queue"}},[4,t.gpuAdapter.requestDevice(f)];case 2:return t.wgpu=y.sent(),(n=t.wgpu.lost)==null||n.then(t.handleDeviceLost.bind(t)),t.initDeviceCaps(),t.gpuContext=t.canvas.getContext("webgpu"),d="standard",p=window.navigator.gpu.getPreferredCanvasFormat(),_=t.initOptions.displayFormat,t.backBufferFormat=p==="rgba8unorm"?_===co?20:7:_===co?64:31,t.backBufferViewFormat=_===co?""+p+"-srgb":p,_==="hdr"&&t.textureFloatFilterable&&((g=window.matchMedia("(dynamic-range: high)"))!=null&&g.matches)&&(t.backBufferFormat=12,t.backBufferViewFormat="rgba16float",p="rgba16float",t.isHdr=!0,d="extended"),t.canvasConfig={device:t.wgpu,colorSpace:"srgb",alphaMode:t.initOptions.alpha?"premultiplied":"opaque",format:p,toneMapping:{mode:d},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:_===co?[t.backBufferViewFormat]:[]},(r=t.gpuContext)==null||r.configure(t.canvasConfig),t.createBackbuffer(),t.clearRenderer=new i1(t),t.mipmapRenderer=new r1(t),t.resolver=new u1(t),t.postInit(),[2,t]}})})()},i.handleDeviceLost=function(t){var e=this;return pf(function(){return mf(this,function(n){switch(n.label){case 0:return t.reason==="destroyed"?[3,2]:(o.prototype.loseContext.call(e),[4,e.createDevice()]);case 1:n.sent(),o.prototype.restoreContext.call(e),n.label=2;case 2:return[2]}})})()},i.postInit=function(){o.prototype.postInit.call(this),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new l1(this),this.dynamicBuffers=new a1(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new Fs(this,new Br(this,[])),this.emptyBindGroup.update()},i.createBackbuffer=function(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Ee({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0},i.frameStart=function(){o.prototype.frameStart.call(this),this.gpuProfiler.frameStart(),this.submit();var t,e,n,r,s=(r=(e=this.gpuContext)==null||(t=e.getCurrentTexture)==null?void 0:t.call(e))!=null?r:(n=this.externalBackbuffer)==null?void 0:n.impl.gpuTexture;(this.backBufferSize.x!==s.width||this.backBufferSize.y!==s.height)&&(this.backBufferSize.set(s.width,s.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());var l=this.backBuffer,u=l.impl;u.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(l),u.assignColorTexture(this,s)},i.frameEnd=function(){o.prototype.frameEnd.call(this),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request()},i.createBufferImpl=function(t){return new au(t)},i.createUniformBufferImpl=function(t){return new jP(t)},i.createVertexBufferImpl=function(t,e,n){return new XP(t,e,n)},i.createIndexBufferImpl=function(t,e){return new oP(t,e)},i.createShaderImpl=function(t){return new GP(t)},i.createTextureImpl=function(t){return new WP(t)},i.createRenderTargetImpl=function(t){return new xP(t)},i.createBindGroupFormatImpl=function(t){return new aP(t)},i.createBindGroupImpl=function(t){return new rP},i.createComputeImpl=function(t){return new c1(t)},i.setBindGroup=function(t,e,n){this.passEncoder&&(this.passEncoder.setBindGroup(t,e.impl.bindGroup,n??e.uniformBufferOffsets),this.bindGroupFormats[t]=e.format.impl)},i.submitVertexBuffer=function(t,e){var n=t.format,r=n.interleaved,s=n.elements,l=s.length,u=t.impl.buffer;if(r)return this.passEncoder.setVertexBuffer(e,u),1;for(var c=0;c<l;c++)this.passEncoder.setVertexBuffer(e+c,u,s[c].offset);return l},i.validateVBLocations=function(t,e){var n=function(r){for(var s=r.format.elements,l=0;l<s.length;l++){var u=s[l].name,c=me[u];_f.has(c),_f.set(c,u)}};n(t),n(e),_f.clear()},i.draw=function(t,e,n,r,s){if(n===void 0&&(n=1),r===void 0&&(r=!0),s===void 0&&(s=!0),this.shader.ready&&!this.shader.failed){var l=this.passEncoder,u=this.pipeline,c=this.vertexBuffers[0],h=this.vertexBuffers[1];if(r){if(c){var f=this.submitVertexBuffer(c,0);h&&this.submitVertexBuffer(h,f)}u=this.renderPipeline.get(t,c==null?void 0:c.format,h==null?void 0:h.format,e==null?void 0:e.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack),this.pipeline!==u&&(this.pipeline=u,l.setPipeline(u))}e?(l.setIndexBuffer(e.impl.buffer,e.impl.format),l.drawIndexed(t.count,n,t.base,0,0)):l.draw(t.count,n,t.base,0)}s&&(this.clearVertexBuffer(),this.pipeline=null)},i.setShader=function(t,e){t!==this.shader&&(this.shader=t)},i.setBlendState=function(t){this.blendState.copy(t)},i.setDepthState=function(t){this.depthState.copy(t)},i.setStencilState=function(t,e){if(t||e){this.stencilEnabled=!0,this.stencilFront.copy(t??Xt.DEFAULT),this.stencilBack.copy(e??Xt.DEFAULT);var n=this.stencilFront.ref;this.stencilRef!==n&&(this.stencilRef=n,this.passEncoder.setStencilReference(n))}else this.stencilEnabled=!1},i.setBlendColor=function(t,e,n,r){var s=this.blendColor;(t!==s.r||e!==s.g||n!==s.b||r!==s.a)&&(s.set(t,e,n,r),this.passEncoder.setBlendConstant(s))},i.setCullMode=function(t){this.cullMode=t},i.setAlphaToCoverage=function(t){},i.initializeContextCaches=function(){o.prototype.initializeContextCaches.call(this)},i.setupPassEncoderDefaults=function(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)},i._uploadDirtyTextures=function(){this.textures.forEach(function(t){(t._needsUpload||t._needsMipmaps)&&t.upload()})},i.setupTimeStampWrites=function(t,e){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){var n=this.gpuProfiler.getSlot(e);(t=t??{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*n,endOfPassWriteIndex:2*n+1}}return t},i.startRenderPass=function(t){this._uploadDirtyTextures();var e=t.renderTarget||this.backBuffer;this.renderTarget=e;var n=e.impl;e!==this.backBuffer&&this.initRenderTarget(e),n.setupForRenderPass(t,e);var r=n.renderPassDescriptor;this.setupTimeStampWrites(r,t.name);var s=this.getCommandEncoder();this.passEncoder=s.beginRenderPass(r),this.passEncoder.label=t.name+"-PassEncoder RT:"+e.name,this.setupPassEncoderDefaults();var l=e.width,u=e.height;this.setViewport(0,0,l,u),this.setScissor(0,0,l,u),this.insideRenderPass=!0},i.endRenderPass=function(t){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;var e=this.renderTarget;if(e&&e.depthBuffer&&t.depthStencilOps.resolveDepth&&t.samples>1&&e.autoResolve){var n=e.impl.depthAttachment,r=e.depthBuffer.impl.gpuTexture;n&&r&&this.resolver.resolveDepth(this.commandEncoder,n.multisampledDepthBuffer,r)}for(var s=0;s<t.colorArrayOps.length;s++)t.colorArrayOps[s].genMipmaps&&this.mipmapRenderer.generate(t.renderTarget._colorBuffers[s].impl)},i.startComputePass=function(t){this.pipeline=null;var e=this.setupTimeStampWrites(void 0,t),n=this.getCommandEncoder();this.passEncoder=n.beginComputePass(e),this.insideRenderPass=!0},i.endComputePass=function(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0},i.computeDispatch=function(t,e){e===void 0&&(e="Unnamed"),this.startComputePass(e);for(var n=0;n<t.length;n++){var r=t[n];r.applyParameters(),r.impl.updateBindGroup()}for(var s=0;s<t.length;s++){var l=t[s];l.impl.dispatch(l.countX,l.countY,l.countZ)}this.endComputePass()},i.getCommandEncoder=function(){var t=this.commandEncoder;return t||(t=this.wgpu.createCommandEncoder(),this.commandEncoder=t),t},i.endCommandEncoder=function(){var t=this.commandEncoder;if(t){var e=t.finish();this.addCommandBuffer(e),this.commandEncoder=null}},i.addCommandBuffer=function(t,e){e===void 0&&(e=!1),e?this.commandBuffers.unshift(t):this.commandBuffers.push(t)},i.submit=function(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())},i.clear=function(t){t.flags&&this.clearRenderer.clear(this,this.renderTarget,t,this.defaultClearOptions)},i.setViewport=function(t,e,n,r){this.passEncoder&&(this.renderTarget.flipY||(e=this.renderTarget.height-e-r),this.vx=t,this.vy=e,this.vw=n,this.vh=r,this.passEncoder.setViewport(t,e,n,r,0,1))},i.setScissor=function(t,e,n,r){this.passEncoder&&(this.renderTarget.flipY||(e=this.renderTarget.height-e-r),this.sx=t,this.sy=e,this.sw=n,this.sh=r,this.passEncoder.setScissorRect(t,e,n,r))},i.clearStorageBuffer=function(t,e,n){e===void 0&&(e=0),n===void 0&&(n=t.byteSize),this.getCommandEncoder().clearBuffer(t.buffer,e,n)},i.readStorageBuffer=function(t,e,n,r,s){e===void 0&&(e=0),n===void 0&&(n=t.byteSize-e),r===void 0&&(r=null),s===void 0&&(s=!1);var l=this.createBufferImpl(9);l.allocate(this,n);var u=l.buffer;return this.getCommandEncoder().copyBufferToBuffer(t.buffer,e,u,0,n),this.readBuffer(l,n,r,s)},i.readBuffer=function(t,e,n,r){var s=this;n===void 0&&(n=null),r===void 0&&(r=!1);var l=t.buffer;return new Promise(function(u,c){var h=function(){l==null||l.mapAsync(GPUMapMode.READ).then(function(){n!=null||(n=new Uint8Array(e));var f=l.getMappedRange(0,e),d=n.constructor;n.set(new d(f)),l.unmap(),t.destroy(s),u(n)})};r?(s.submit(),h()):setTimeout(function(){h()})})},i.writeStorageBuffer=function(t,e,n,r,s){e===void 0&&(e=0),r===void 0&&(r=0),this.wgpu.queue.writeBuffer(t.buffer,e,n,r,s)},i.copyRenderTarget=function(t,e,n,r){var s={width:t?t.width:e.width,height:t?t.height:e.height,depthOrArrayLayers:1},l=this.getCommandEncoder();if(n){var u={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},c={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};l.copyTextureToTexture(u,c,s)}if(r){var h=(t||this.renderTarget).impl.depthAttachment.depthTexture;if(t.samples>1){var f=e.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(l,h,f)}else{var d=e?e.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture;l.copyTextureToTexture({texture:h,mipLevel:0},{texture:d,mipLevel:0},s)}}return!0},a}(Ie),sv=function(){function o(){this.bufferId=null}var a,i=o.prototype;return i.destroy=function(t){this.bufferId&&(t.gl.deleteBuffer(this.bufferId),this.bufferId=null)},i.loseContext=function(){this.bufferId=null},i.unlock=function(t,e,n,r){var s,l=t.gl;if(this.bufferId)l.bindBuffer(n,this.bufferId),l.bufferSubData(n,0,r);else{switch(e){case 0:s=l.STATIC_DRAW;break;case 1:s=l.DYNAMIC_DRAW;break;case 2:s=l.STREAM_DRAW;break;case 3:s=l.DYNAMIC_COPY}this.bufferId=l.createBuffer(),l.bindBuffer(n,this.bufferId),l.bufferData(n,r,s)}},a=[{key:"initialized",get:function(){return!!this.bufferId}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function av(o,a){return(av=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var h1=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return t=o.apply(this,arguments)||this,t.vao=null,t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&av(a,o);var i=a.prototype;return i.destroy=function(t){o.prototype.destroy.call(this,t),t.unbindVertexArray()},i.loseContext=function(){o.prototype.loseContext.call(this),this.vao=null},i.unlock=function(t){var e=t.device;o.prototype.unlock.call(this,e,t.usage,e.gl.ARRAY_BUFFER,t.storage)},a}(sv);function ov(o,a){return(ov=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var f1=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){var t=o.call(this)||this,e=i.device.gl,n=i.format;return n===0?t.glFormat=e.UNSIGNED_BYTE:n===1?t.glFormat=e.UNSIGNED_SHORT:n===2&&(t.glFormat=e.UNSIGNED_INT),t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ov(a,o),a.prototype.unlock=function(i){var t=i.device;o.prototype.unlock.call(this,t,i.usage,t.gl.ELEMENT_ARRAY_BUFFER,i.storage)},a}(sv),d1=function(o,a,i,t){if(this.locationId=t,this.scopeId=o.scope.resolve(a),this.version=new v_,a.substring(a.length-3)==="[0]")switch(i){case 2:i=17;break;case 1:i=30;break;case 26:i=31;break;case 0:i=32;break;case 3:i=21;break;case 6:i=33;break;case 27:i=34;break;case 9:i=35;break;case 4:i=22;break;case 7:i=36;break;case 28:i=37;break;case 10:i=38;break;case 5:i=23;break;case 8:i=39;break;case 29:i=40;break;case 11:i=41}this.dataType=i,this.value=[null,null,null,null],this.array=[]},p1=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]),m1=function(){function o(){this.map=new Map}var a=o.prototype;return a.destroy=function(i){this.map.forEach(function(t){i.gl.deleteShader(t)})},a.loseContext=function(i){this.map.clear()},o}(),_1=new It,v1=new It,g1=function(){function o(i){this.compileDuration=0,this.init(),this.compile(i.device,i),this.link(i.device,i),i.device.shaders.push(i)}var a=o.prototype;return a.destroy=function(i){this.glProgram&&(i.device.gl.deleteProgram(this.glProgram),this.glProgram=null)},a.init=function(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null},a.loseContext=function(){this.init()},a.restoreContext=function(i,t){this.compile(i,t),this.link(i,t)},a.compile=function(i,t){var e=t.definition;this.glVertexShader=this._compileShaderSource(i,e.vshader,!0),this.glFragmentShader=this._compileShaderSource(i,e.fshader,!1)},a.link=function(i,t){if(!this.glProgram){var e=i.gl;if(!e.isContextLost()){var n=e.createProgram();this.glProgram=n,e.attachShader(n,this.glVertexShader),e.attachShader(n,this.glFragmentShader);var r=t.definition,s=r.attributes;if(r.useTransformFeedback){var l=[];for(var u in s)s.hasOwnProperty(u)&&l.push("out_"+u);e.transformFeedbackVaryings(n,l,e.INTERLEAVED_ATTRIBS)}for(var c in s)if(s.hasOwnProperty(c)){var h=me[s[c]];e.bindAttribLocation(n,h,c)}e.linkProgram(n)}}},a._compileShaderSource=function(i,t,e){var n=i.gl;if(n.isContextLost())return null;var r=(e?_1:v1).get(i,function(){return new m1}),s=r.map.get(t);return s||(s=n.createShader(e?n.VERTEX_SHADER:n.FRAGMENT_SHADER),n.shaderSource(s,t),n.compileShader(s),r.map.set(t,s)),s},a.finalize=function(i,t){var e=i.gl;if(e.isContextLost())return!0;var n=this.glProgram,r=t.definition;if(!e.getProgramParameter(n,e.LINK_STATUS))return!!this._isCompiled(i,t,this.glVertexShader,r.vshader,"vertex")&&!!this._isCompiled(i,t,this.glFragmentShader,r.fshader,"fragment")&&(e.getProgramInfoLog(n),!1);var s=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES);t.attributes.clear();for(var l=0;l<s;l++){var u=e.getActiveAttrib(n,l),c=e.getAttribLocation(n,u.name);p1.has(u.name)||(r.attributes[u.name]===void 0?t.failed=!0:t.attributes.set(c,u.name))}for(var h=i._samplerTypes,f=e.getProgramParameter(n,e.ACTIVE_UNIFORMS),d=0;d<f;d++){var p=e.getActiveUniform(n,d),_=e.getUniformLocation(n,p.name),g=new d1(i,p.name,i.pcUniformType[p.type],_);h.has(p.type)?this.samplers.push(g):this.uniforms.push(g)}return t.ready=!0,!0},a._isCompiled=function(i,t,e,n,r){var s=i.gl;if(!s.getShaderParameter(e,s.COMPILE_STATUS)){var l=s.getShaderInfoLog(e),u=this._processError(n,l);return u[0],u[1],!1}return!0},a.isLinked=function(i){var t=i.extParallelShaderCompile;return!t||i.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)},a._processError=function(i,t){var e={},n="";if(i){var r=i.split(`
`),s=0,l=r.length;if(t&&t.startsWith("ERROR:")){var u=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);u&&(e.message=u[3],e.line=parseInt(u[2],10),s=Math.max(0,e.line-6),l=Math.min(r.length,e.line+5))}for(var c=s;c<l;c++)n+=(c+1===e.line?"> ":"  ")+(c+1)+":	"+r[c]+`
`;e.source=i}return[n,e]},o}();function lv(o,a){var i=o.width,t=o.height;if(i>a||t>a){var e=a/Math.max(i,t),n=Math.floor(i*e),r=Math.floor(t*e),s=document.createElement("canvas");return s.width=n,s.height=r,s.getContext("2d").drawImage(o,0,0,i,t,0,0,n,r),s}return o}var y1=function(){function o(i){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=i}var a=o.prototype;return a.destroy=function(i){if(this._glTexture){for(var t=0;t<i.textureUnits.length;t++)for(var e=i.textureUnits[t],n=0;n<e.length;n++)e[n]===this._glTexture&&(e[n]=null);i.gl.deleteTexture(this._glTexture),this._glTexture=null}},a.loseContext=function(){this._glTexture=null},a.propertyChanged=function(i){this.dirtyParameterFlags|=i},a.initialize=function(i,t){var e=i.gl;switch(this._glTexture=e.createTexture(),this._glTarget=t._cubemap?e.TEXTURE_CUBE_MAP:t._volume?e.TEXTURE_3D:t.array?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D,t._format){case 0:this._glFormat=e.ALPHA,this._glInternalFormat=e.ALPHA,this._glPixelType=e.UNSIGNED_BYTE;break;case 1:this._glFormat=e.LUMINANCE,this._glInternalFormat=e.LUMINANCE,this._glPixelType=e.UNSIGNED_BYTE;break;case 2:this._glFormat=e.LUMINANCE_ALPHA,this._glInternalFormat=e.LUMINANCE_ALPHA,this._glPixelType=e.UNSIGNED_BYTE;break;case 52:this._glFormat=e.RED,this._glInternalFormat=e.R8,this._glPixelType=e.UNSIGNED_BYTE;break;case 53:this._glFormat=e.RG,this._glInternalFormat=e.RG8,this._glPixelType=e.UNSIGNED_BYTE;break;case 3:this._glFormat=e.RGB,this._glInternalFormat=e.RGB565,this._glPixelType=e.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=e.RGBA,this._glInternalFormat=e.RGB5_A1,this._glPixelType=e.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=e.RGBA,this._glInternalFormat=e.RGBA4,this._glPixelType=e.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=e.RGB,this._glInternalFormat=e.RGB8,this._glPixelType=e.UNSIGNED_BYTE;break;case 7:this._glFormat=e.RGBA,this._glInternalFormat=e.RGBA8,this._glPixelType=e.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=e.RGB,this._glInternalFormat=i.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=e.RGB,this._glInternalFormat=i.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=e.RGB,this._glInternalFormat=i.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=e.RGB,this._glInternalFormat=i.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=e.RGB,this._glInternalFormat=i.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=e.RGB,this._glInternalFormat=i.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=e.RGBA,this._glInternalFormat=i.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=e.RGB,this._glInternalFormat=i.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=e.RGB,this._glInternalFormat=i.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=e.RGBA,this._glInternalFormat=i.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=e.SRGB,this._glInternalFormat=i.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=e.SRGB_ALPHA,this._glInternalFormat=i.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=e.SRGB_ALPHA,this._glInternalFormat=i.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=e.SRGB,this._glInternalFormat=i.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=e.SRGB_ALPHA,this._glInternalFormat=i.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=e.SRGB_ALPHA,this._glInternalFormat=i.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=e.RGBA,this._glInternalFormat=i.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=e.RED,this._glInternalFormat=e.R16F,this._glPixelType=e.HALF_FLOAT;break;case 51:this._glFormat=e.RG,this._glInternalFormat=e.RG16F,this._glPixelType=e.HALF_FLOAT;break;case 11:this._glFormat=e.RGB,this._glInternalFormat=e.RGB16F,this._glPixelType=e.HALF_FLOAT;break;case 12:this._glFormat=e.RGBA,this._glInternalFormat=e.RGBA16F,this._glPixelType=e.HALF_FLOAT;break;case 13:this._glFormat=e.RGB,this._glInternalFormat=e.RGB32F,this._glPixelType=e.FLOAT;break;case 14:this._glFormat=e.RGBA,this._glInternalFormat=e.RGBA32F,this._glPixelType=e.FLOAT;break;case 15:this._glFormat=e.RED,this._glInternalFormat=e.R32F,this._glPixelType=e.FLOAT;break;case 16:this._glFormat=e.DEPTH_COMPONENT,this._glInternalFormat=e.DEPTH_COMPONENT32F,this._glPixelType=e.FLOAT;break;case 69:this._glFormat=e.DEPTH_COMPONENT,this._glInternalFormat=e.DEPTH_COMPONENT16,this._glPixelType=e.UNSIGNED_SHORT;break;case 17:this._glFormat=e.DEPTH_STENCIL,this._glInternalFormat=e.DEPTH24_STENCIL8,this._glPixelType=e.UNSIGNED_INT_24_8;break;case 18:this._glFormat=e.RGB,this._glInternalFormat=e.R11F_G11F_B10F,this._glPixelType=e.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=e.RGB,this._glInternalFormat=e.SRGB8,this._glPixelType=e.UNSIGNED_BYTE;break;case 20:this._glFormat=e.RGBA,this._glInternalFormat=e.SRGB8_ALPHA8,this._glPixelType=e.UNSIGNED_BYTE;break;case 32:this._glFormat=e.RED_INTEGER,this._glInternalFormat=e.R8I,this._glPixelType=e.BYTE;break;case 33:this._glFormat=e.RED_INTEGER,this._glInternalFormat=e.R8UI,this._glPixelType=e.UNSIGNED_BYTE;break;case 34:this._glFormat=e.RED_INTEGER,this._glInternalFormat=e.R16I,this._glPixelType=e.SHORT;break;case 35:this._glFormat=e.RED_INTEGER,this._glInternalFormat=e.R16UI,this._glPixelType=e.UNSIGNED_SHORT;break;case 36:this._glFormat=e.RED_INTEGER,this._glInternalFormat=e.R32I,this._glPixelType=e.INT;break;case 37:this._glFormat=e.RED_INTEGER,this._glInternalFormat=e.R32UI,this._glPixelType=e.UNSIGNED_INT;break;case 38:this._glFormat=e.RG_INTEGER,this._glInternalFormat=e.RG8I,this._glPixelType=e.BYTE;break;case 39:this._glFormat=e.RG_INTEGER,this._glInternalFormat=e.RG8UI,this._glPixelType=e.UNSIGNED_BYTE;break;case 40:this._glFormat=e.RG_INTEGER,this._glInternalFormat=e.RG16I,this._glPixelType=e.SHORT;break;case 41:this._glFormat=e.RG_INTEGER,this._glInternalFormat=e.RG16UI,this._glPixelType=e.UNSIGNED_SHORT;break;case 42:this._glFormat=e.RG_INTEGER,this._glInternalFormat=e.RG32I,this._glPixelType=e.INT;break;case 43:this._glFormat=e.RG_INTEGER,this._glInternalFormat=e.RG32UI,this._glPixelType=e.UNSIGNED_INT;break;case 44:this._glFormat=e.RGBA_INTEGER,this._glInternalFormat=e.RGBA8I,this._glPixelType=e.BYTE;break;case 45:this._glFormat=e.RGBA_INTEGER,this._glInternalFormat=e.RGBA8UI,this._glPixelType=e.UNSIGNED_BYTE;break;case 46:this._glFormat=e.RGBA_INTEGER,this._glInternalFormat=e.RGBA16I,this._glPixelType=e.SHORT;break;case 47:this._glFormat=e.RGBA_INTEGER,this._glInternalFormat=e.RGBA16UI,this._glPixelType=e.UNSIGNED_SHORT;break;case 48:this._glFormat=e.RGBA_INTEGER,this._glInternalFormat=e.RGBA32I,this._glPixelType=e.INT;break;case 49:this._glFormat=e.RGBA_INTEGER,this._glInternalFormat=e.RGBA32UI,this._glPixelType=e.UNSIGNED_INT}this._glCreated=!1},a.upload=function(i,t){var e,n,r=i.gl;if(t._needsUpload||(!t._needsMipmapsUpload||!t._mipmapsUploaded)&&t.pot){var s=0,l=t.numLevels;for(t.array&&r.texStorage3D(r.TEXTURE_2D_ARRAY,l,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[s]||s===0;){if(t._needsUpload||s!==0){if(s&&(!t._needsMipmapsUpload||!t._mipmaps))break}else{s++;continue}if(e=t._levels[s],n=1/Math.pow(2,s),s!==1||t._compressed||t._integerFormat||!(t._levels.length<l)||(r.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){var u,c=void 0;if(i._isBrowserInterface(e[0])){for(c=0;c<6;c++)if(t._levelsUpdated[0][c]){var h=e[c];i._isImageBrowserInterface(h)&&(h.width>i.maxCubeMapSize||h.height>i.maxCubeMapSize)&&(h=lv(h,i.maxCubeMapSize),s===0&&(t._width=h.width,t._height=h.height)),i.setUnpackFlipY(!1),i.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,0,0,this._glFormat,this._glPixelType,h):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,this._glInternalFormat,this._glFormat,this._glPixelType,h)}}else for(c=0,n=1/Math.pow(2,s);c<6;c++)if(t._levelsUpdated[0][c]){var f=e[c];t._compressed?this._glCreated&&f?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glInternalFormat,f):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,f):(i.setUnpackFlipY(!1),i.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&f?r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,f):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,f))}}else if(t._volume)t._compressed?r.compressedTexImage3D(r.TEXTURE_3D,s,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,e):(i.setUnpackFlipY(!1),i.setUnpackPremultiplyAlpha(t._premultiplyAlpha),r.texImage3D(r.TEXTURE_3D,s,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,this._glFormat,this._glPixelType,e));else if(t.array&&(e===void 0?"undefined":(u=e)&&typeof Symbol<"u"&&u.constructor===Symbol?"symbol":typeof u)=="object"){if(t._arrayLength===e.length)if(t._compressed)for(var d=0;d<t._arrayLength;d++)r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,s,0,0,d,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glInternalFormat,e[d]);else for(var p=0;p<t._arrayLength;p++)r.texSubImage3D(r.TEXTURE_2D_ARRAY,s,0,0,p,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glFormat,this._glPixelType,e[p])}else{if(i._isBrowserInterface(e)){i._isImageBrowserInterface(e)&&(e.width>i.maxTextureSize||e.height>i.maxTextureSize)&&(e=lv(e,i.maxTextureSize),s===0&&(t._width=e.width,t._height=e.height));var _=e.width||e.videoWidth,g=e.height||e.videoHeight;i.setUnpackFlipY(t._flipY),i.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===_&&t._height===g&&!i._isImageVideoInterface(e)?r.texSubImage2D(r.TEXTURE_2D,s,0,0,this._glFormat,this._glPixelType,e):(r.texImage2D(r.TEXTURE_2D,s,this._glInternalFormat,this._glFormat,this._glPixelType,e),s===0&&(t._width=_,t._height=g))}else n=1/Math.pow(2,s),t._compressed?this._glCreated&&e?r.compressedTexSubImage2D(r.TEXTURE_2D,s,0,0,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),this._glInternalFormat,e):r.compressedTexImage2D(r.TEXTURE_2D,s,this._glInternalFormat,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),0,e):(i.setUnpackFlipY(!1),i.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&e?r.texSubImage2D(r.TEXTURE_2D,s,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,e):r.texImage2D(r.TEXTURE_2D,s,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,e));s===0?t._mipmapsUploaded=!1:t._mipmapsUploaded=!0}s++}if(t._needsUpload)if(t._cubemap)for(var y=0;y<6;y++)t._levelsUpdated[0][y]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&t._levels.length===1&&(r.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(i._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(i._vram,t._gpuSize),this._glCreated=!0}},a.read=function(i,t,e,n,r){var s=this.texture;return s.device.readTextureAsync(s,i,t,e,n,r)},a.write=function(i,t,e,n,r){var s=this.texture,l=s.device;return l.setTexture(s,0),l.writeTextureAsync(s,i,t,e,n,r)},o}(),S1=function(){function o(a,i){this.msaaFB=a,this.resolveFB=i}return o.prototype.destroy=function(a){this.msaaFB&&(a.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(a.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)},o}(),x1=function(){function o(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}var a,i=o.prototype;return i.destroy=function(t){var e,n=t.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&n.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(n.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&n.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(function(r){n.deleteRenderbuffer(r)}),this._glMsaaColorBuffers.length=0,(e=this.colorMrtFramebuffers)==null||e.forEach(function(r){r.destroy(n)}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&go(t).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0},i.init=function(t,e){var n=t.gl;this._isInitialized=!0;var r=[];if(this.suppliedColorFramebuffer!==void 0)this._glFrameBuffer=this.suppliedColorFramebuffer;else{this._glFrameBuffer=n.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);for(var s,l,u=(l=(s=e._colorBuffers)==null?void 0:s.length)!=null?l:0,c=n.COLOR_ATTACHMENT0,h=0;h<u;++h){var f=e.getColorBuffer(h);f&&(f.impl._glTexture||(f._width=Math.min(f.width,t.maxRenderBufferSize),f._height=Math.min(f.height,t.maxRenderBufferSize),t.setTexture(f,0)),n.framebufferTexture2D(n.FRAMEBUFFER,c+h,f._cubemap?n.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:n.TEXTURE_2D,f.impl._glTexture,e.mipLevel),r.push(c+h))}n.drawBuffers(r);var d=e._depthBuffer;if(d||e._depth){var p=e._stencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;if(d)d.impl._glTexture||(d._width=Math.min(d.width,t.maxRenderBufferSize),d._height=Math.min(d.height,t.maxRenderBufferSize),t.setTexture(d,0)),n.framebufferTexture2D(n.FRAMEBUFFER,p,d._cubemap?n.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:n.TEXTURE_2D,e._depthBuffer.impl._glTexture,e.mipLevel);else if(!(e._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=n.createRenderbuffer());var _=e._stencil?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT32F;n.bindRenderbuffer(n.RENDERBUFFER,this._glDepthBuffer),n.renderbufferStorage(n.RENDERBUFFER,_,e.width,e.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,p,n.RENDERBUFFER,this._glDepthBuffer),n.bindRenderbuffer(n.RENDERBUFFER,null)}}}if(e._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=n.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);var g=(w=(b=e._colorBuffers)==null?void 0:b.length)!=null?w:0;if(this.suppliedColorFramebuffer!==void 0){var y=n.createRenderbuffer();this._glMsaaColorBuffers.push(y);var v=t.backBufferFormat===7?n.RGBA8:n.RGB8;n.bindRenderbuffer(n.RENDERBUFFER,y),n.renderbufferStorageMultisample(n.RENDERBUFFER,e._samples,v,e.width,e.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.RENDERBUFFER,y)}else for(var x=0;x<g;++x){var S=e.getColorBuffer(x);if(S){var T=n.createRenderbuffer();this._glMsaaColorBuffers.push(T),n.bindRenderbuffer(n.RENDERBUFFER,T),n.renderbufferStorageMultisample(n.RENDERBUFFER,e._samples,S.impl._glInternalFormat,e.width,e.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+x,n.RENDERBUFFER,T)}}if(e._depth){var b,w,A,C=e._stencil?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT32F,L=e._stencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT,I=e._depthBuffer;I&&(A=I.id+":"+e.width+":"+e.height+":"+e._samples+":"+C+":"+L,this._glMsaaDepthBuffer=go(t).get(A)),!this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=n.createRenderbuffer(),n.bindRenderbuffer(n.RENDERBUFFER,this._glMsaaDepthBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e._samples,C,e.width,e.height),this._glMsaaDepthBuffer.destroy=function(){n.deleteRenderbuffer(this)},I&&go(t).set(A,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=A,n.framebufferRenderbuffer(n.FRAMEBUFFER,L,n.RENDERBUFFER,this._glMsaaDepthBuffer)}g>1&&(this._createMsaaMrtFramebuffers(t,e,g),t.setFramebuffer(this._glFrameBuffer),n.drawBuffers(r))}},i._createMsaaMrtFramebuffers=function(t,e,n){var r=t.gl;this.colorMrtFramebuffers=[];for(var s=0;s<n;++s){var l=e.getColorBuffer(s),u=r.createFramebuffer();t.setFramebuffer(u);var c=this._glMsaaColorBuffers[s];r.bindRenderbuffer(r.RENDERBUFFER,c),r.renderbufferStorageMultisample(r.RENDERBUFFER,e._samples,l.impl._glInternalFormat,e.width,e.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,c),r.drawBuffers([r.COLOR_ATTACHMENT0]);var h=r.createFramebuffer();t.setFramebuffer(h),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,l._cubemap?r.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:r.TEXTURE_2D,l.impl._glTexture,0),this.colorMrtFramebuffers[s]=new S1(u,h)}},i._checkFbo=function(t,e,n){var r=t.gl;switch(r.checkFramebufferStatus(r.FRAMEBUFFER)){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:case r.FRAMEBUFFER_UNSUPPORTED:}},i.loseContext=function(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1},i.internalResolve=function(t,e,n,r,s){t.setScissor(0,0,r.width,r.height);var l=t.gl;l.bindFramebuffer(l.READ_FRAMEBUFFER,e),l.bindFramebuffer(l.DRAW_FRAMEBUFFER,n),l.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,s,l.NEAREST)},i.resolve=function(t,e,n,r){var s=t.gl;if(this.colorMrtFramebuffers){if(n)for(var l=0;l<this.colorMrtFramebuffers.length;l++){var u=this.colorMrtFramebuffers[l];this.internalResolve(t,u.msaaFB,u.resolveFB,e,s.COLOR_BUFFER_BIT)}r&&this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,s.DEPTH_BUFFER_BIT)}else this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,(n?s.COLOR_BUFFER_BIT:0)|(r?s.DEPTH_BUFFER_BIT:0));s.bindFramebuffer(s.FRAMEBUFFER,this._glFrameBuffer)},a=[{key:"initialized",get:function(){return this._isInitialized}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function uv(o,a){return(uv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var b1=function(){function o(){this.queries=[]}return o.prototype.destroy=function(a){this.queries.forEach(function(i){return a.deleteQuery(i)}),this.queries=null},o}(),T1=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this).freeQueries=[],e.frameQueries=[],e.previousFrameQueries=[],e.timings=[],e.device=t,e.ext=t.extDisjointTimerQuery,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&uv(a,o);var i=a.prototype;return i.destroy=function(){var t=this;this.freeQueries.forEach(function(e){return t.device.gl.deleteQuery(e)}),this.frameQueries.forEach(function(e){return t.device.gl.deleteQuery(e)}),this.previousFrameQueries.forEach(function(e){return e.destroy(t.device.gl)}),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null},i.loseContext=function(){o.prototype.loseContext.call(this),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]},i.restoreContext=function(){this.ext=this.device.extDisjointTimerQuery},i.getQuery=function(){var t;return(t=this.freeQueries.pop())!=null?t:this.device.gl.createQuery()},i.start=function(t){if(this.ext){var e=this.getSlot(t),n=this.getQuery();return this.frameQueries[e]=n,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,n),e}},i.end=function(t){t!==void 0&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)},i.frameStart=function(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))},i.frameEnd=function(){this._enabled&&this.end(this.frameGPUMarkerSlot)},i.request=function(){var t=this;if(this._enabled){var e=this.ext,n=this.device.gl,r=this.device.renderVersion,s=this.frameQueries;if(s.length>0){this.frameQueries=[];var l=new b1;l.queries=s,l.renderVersion=r,this.previousFrameQueries.push(l)}if(this.previousFrameQueries.length>0){var u=this.previousFrameQueries[0],c=u.queries,h=c[c.length-1],f=n.getQueryParameter(h,n.QUERY_RESULT_AVAILABLE),d=n.getParameter(e.GPU_DISJOINT_EXT);if(f&&!d){this.previousFrameQueries.shift();var p=this.timings;p.length=0;for(var _=0;_<c.length;_++){var g=c[_],y=n.getQueryParameter(g,n.QUERY_RESULT);p[_]=1e-6*y,this.freeQueries.push(g)}this.report(u.renderVersion,p)}d&&(this.previousFrameQueries.forEach(function(v){t.report(v.renderVersion,null),v.destroy(n)}),this.previousFrameQueries.length=0)}o.prototype.request.call(this,r)}},a}(ev);function cv(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function hv(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function fv(o){return function(){var a=this,i=arguments;return new Promise(function(t,e){var n=o.apply(a,i);function r(l){hv(n,t,e,r,s,"next",l)}function s(l){hv(n,t,e,r,s,"throw",l)}r(void 0)})}}function dv(o,a){return(dv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function pv(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return cv(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return cv(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function mv(o,a){var i,t,e,n={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]},r=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return r.next=s(0),r.throw=s(1),r.return=s(2),typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function s(l){return function(u){var c=[l,u];if(i)throw TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(n=0)),n;)try{if(i=1,t&&(e=2&c[0]?t.return:c[0]?t.throw||((e=t.return)&&e.call(t),0):t.next)&&!(e=e.call(t,c[1])).done)return e;switch(t=0,e&&(c=[2&c[0],e.value]),c[0]){case 0:case 1:e=c;break;case 4:return n.label++,{value:c[1],done:!1};case 5:n.label++,t=c[1],c=[0];continue;case 7:c=n.ops.pop(),n.trys.pop();continue;default:if(!(e=(e=n.trys).length>0&&e[e.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!e||c[1]>e[0]&&c[1]<e[3])){n.label=c[1];break}if(c[0]===6&&n.label<e[1]){n.label=e[1],e=c;break}if(e&&n.label<e[2]){n.label=e[2],n.ops.push(c);break}e[2]&&n.ops.pop(),n.trys.pop();continue}c=a.call(o,n)}catch(h){c=[6,h],t=0}finally{i=e=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var Ws=[],vf=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){n===void 0&&(n={}),(r=o.call(this,e,n)||this)._defaultFramebuffer=null,r._defaultFramebufferChanged=!1,n=r.initOptions,r.updateClientRect(),r.initTextureUnits(),r.contextLost=!1,r._contextLostHandler=function(b){b.preventDefault(),r.loseContext(),r.fire("devicelost")},r._contextRestoredHandler=function(){r.restoreContext(),r.fire("devicerestored")};var r,s,l,u,c,h,f,d,p=typeof navigator<"u"&&navigator.userAgent;if(r.forceDisableMultisampling=p&&p.includes("AppleWebKit")&&(p.includes("15.4")||p.includes("15_4")),r.forceDisableMultisampling&&(n.antialias=!1),fe.browserName==="firefox"){var _=(typeof navigator<"u"?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),g=_?_[1]:null;if(g){var y=parseFloat(g);(fe.name==="windows"&&(y>=120||y===115)||fe.name==="android"&&y>=132)&&(n.antialias=!1)}}r.backBufferAntialias=(s=n.antialias)!=null&&s,n.antialias=!1;var v=(l=n.gl)!=null?l:e.getContext("webgl2",n);if(!v)throw Error("WebGL not supported");r.gl=v,r.isWebGL2=!0,r._deviceType=lo,r.updateBackbufferFormat(null);var x=fe.browserName==="chrome",S=fe.browserName==="safari",T=fe.browser&&navigator.appVersion.indexOf("Mac")!==-1;return r._tempEnableSafariTextureUnitWorkaround=S,r._tempMacChromeBlitFramebufferWorkaround=T&&x&&!n.alpha,e.addEventListener("webglcontextlost",r._contextLostHandler,!1),e.addEventListener("webglcontextrestored",r._contextRestoredHandler,!1),r.initializeExtensions(),r.initializeCapabilities(),r.initializeRenderState(),r.initializeContextCaches(),r.createBackbuffer(null),r.supportsImageBitmap=!S&&typeof ImageBitmap<"u",r._samplerTypes=new Set([v.SAMPLER_2D,v.SAMPLER_CUBE,v.UNSIGNED_INT_SAMPLER_2D,v.INT_SAMPLER_2D,v.SAMPLER_2D_SHADOW,v.SAMPLER_CUBE_SHADOW,v.SAMPLER_3D,v.INT_SAMPLER_3D,v.UNSIGNED_INT_SAMPLER_3D,v.SAMPLER_2D_ARRAY,v.INT_SAMPLER_2D_ARRAY,v.UNSIGNED_INT_SAMPLER_2D_ARRAY]),r.glAddress=[v.REPEAT,v.CLAMP_TO_EDGE,v.MIRRORED_REPEAT],r.glBlendEquation=[v.FUNC_ADD,v.FUNC_SUBTRACT,v.FUNC_REVERSE_SUBTRACT,v.MIN,v.MAX],r.glBlendFunctionColor=[v.ZERO,v.ONE,v.SRC_COLOR,v.ONE_MINUS_SRC_COLOR,v.DST_COLOR,v.ONE_MINUS_DST_COLOR,v.SRC_ALPHA,v.SRC_ALPHA_SATURATE,v.ONE_MINUS_SRC_ALPHA,v.DST_ALPHA,v.ONE_MINUS_DST_ALPHA,v.CONSTANT_COLOR,v.ONE_MINUS_CONSTANT_COLOR],r.glBlendFunctionAlpha=[v.ZERO,v.ONE,v.SRC_COLOR,v.ONE_MINUS_SRC_COLOR,v.DST_COLOR,v.ONE_MINUS_DST_COLOR,v.SRC_ALPHA,v.SRC_ALPHA_SATURATE,v.ONE_MINUS_SRC_ALPHA,v.DST_ALPHA,v.ONE_MINUS_DST_ALPHA,v.CONSTANT_ALPHA,v.ONE_MINUS_CONSTANT_ALPHA],r.glComparison=[v.NEVER,v.LESS,v.EQUAL,v.LEQUAL,v.GREATER,v.NOTEQUAL,v.GEQUAL,v.ALWAYS],r.glStencilOp=[v.KEEP,v.ZERO,v.REPLACE,v.INCR,v.INCR_WRAP,v.DECR,v.DECR_WRAP,v.INVERT],r.glClearFlag=[0,v.COLOR_BUFFER_BIT,v.DEPTH_BUFFER_BIT,v.COLOR_BUFFER_BIT|v.DEPTH_BUFFER_BIT,v.STENCIL_BUFFER_BIT,v.STENCIL_BUFFER_BIT|v.COLOR_BUFFER_BIT,v.STENCIL_BUFFER_BIT|v.DEPTH_BUFFER_BIT,v.STENCIL_BUFFER_BIT|v.COLOR_BUFFER_BIT|v.DEPTH_BUFFER_BIT],r.glCull=[0,v.BACK,v.FRONT,v.FRONT_AND_BACK],r.glFilter=[v.NEAREST,v.LINEAR,v.NEAREST_MIPMAP_NEAREST,v.NEAREST_MIPMAP_LINEAR,v.LINEAR_MIPMAP_NEAREST,v.LINEAR_MIPMAP_LINEAR],r.glPrimitive=[v.POINTS,v.LINES,v.LINE_LOOP,v.LINE_STRIP,v.TRIANGLES,v.TRIANGLE_STRIP,v.TRIANGLE_FAN],r.glType=[v.BYTE,v.UNSIGNED_BYTE,v.SHORT,v.UNSIGNED_SHORT,v.INT,v.UNSIGNED_INT,v.FLOAT,v.HALF_FLOAT],r.pcUniformType={},r.pcUniformType[v.BOOL]=0,r.pcUniformType[v.INT]=1,r.pcUniformType[v.FLOAT]=2,r.pcUniformType[v.FLOAT_VEC2]=3,r.pcUniformType[v.FLOAT_VEC3]=4,r.pcUniformType[v.FLOAT_VEC4]=5,r.pcUniformType[v.INT_VEC2]=6,r.pcUniformType[v.INT_VEC3]=7,r.pcUniformType[v.INT_VEC4]=8,r.pcUniformType[v.BOOL_VEC2]=9,r.pcUniformType[v.BOOL_VEC3]=10,r.pcUniformType[v.BOOL_VEC4]=11,r.pcUniformType[v.FLOAT_MAT2]=12,r.pcUniformType[v.FLOAT_MAT3]=13,r.pcUniformType[v.FLOAT_MAT4]=14,r.pcUniformType[v.SAMPLER_2D]=15,r.pcUniformType[v.SAMPLER_CUBE]=16,r.pcUniformType[v.UNSIGNED_INT]=26,r.pcUniformType[v.UNSIGNED_INT_VEC2]=27,r.pcUniformType[v.UNSIGNED_INT_VEC3]=28,r.pcUniformType[v.UNSIGNED_INT_VEC4]=29,r.pcUniformType[v.SAMPLER_2D_SHADOW]=18,r.pcUniformType[v.SAMPLER_CUBE_SHADOW]=19,r.pcUniformType[v.SAMPLER_2D_ARRAY]=25,r.pcUniformType[v.SAMPLER_3D]=20,r.pcUniformType[v.INT_SAMPLER_2D]=42,r.pcUniformType[v.UNSIGNED_INT_SAMPLER_2D]=43,r.pcUniformType[v.INT_SAMPLER_CUBE]=44,r.pcUniformType[v.UNSIGNED_INT_SAMPLER_2D]=45,r.pcUniformType[v.INT_SAMPLER_3D]=46,r.pcUniformType[v.UNSIGNED_INT_SAMPLER_3D]=47,r.pcUniformType[v.INT_SAMPLER_2D_ARRAY]=48,r.pcUniformType[v.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,r.targetToSlot={},r.targetToSlot[v.TEXTURE_2D]=0,r.targetToSlot[v.TEXTURE_CUBE_MAP]=1,r.targetToSlot[v.TEXTURE_3D]=2,r.commitFunction=[],r.commitFunction[0]=function(b,w){b.value!==w&&(v.uniform1i(b.locationId,w),b.value=w)},r.commitFunction[1]=r.commitFunction[0],r.commitFunction[2]=function(b,w){b.value!==w&&(v.uniform1f(b.locationId,w),b.value=w)},r.commitFunction[3]=function(b,w){d=b.value,u=w[0],c=w[1],(d[0]!==u||d[1]!==c)&&(v.uniform2fv(b.locationId,w),d[0]=u,d[1]=c)},r.commitFunction[4]=function(b,w){d=b.value,u=w[0],c=w[1],h=w[2],(d[0]!==u||d[1]!==c||d[2]!==h)&&(v.uniform3fv(b.locationId,w),d[0]=u,d[1]=c,d[2]=h)},r.commitFunction[5]=function(b,w){d=b.value,u=w[0],c=w[1],h=w[2],f=w[3],(d[0]!==u||d[1]!==c||d[2]!==h||d[3]!==f)&&(v.uniform4fv(b.locationId,w),d[0]=u,d[1]=c,d[2]=h,d[3]=f)},r.commitFunction[6]=function(b,w){d=b.value,u=w[0],c=w[1],(d[0]!==u||d[1]!==c)&&(v.uniform2iv(b.locationId,w),d[0]=u,d[1]=c)},r.commitFunction[9]=r.commitFunction[6],r.commitFunction[7]=function(b,w){d=b.value,u=w[0],c=w[1],h=w[2],(d[0]!==u||d[1]!==c||d[2]!==h)&&(v.uniform3iv(b.locationId,w),d[0]=u,d[1]=c,d[2]=h)},r.commitFunction[10]=r.commitFunction[7],r.commitFunction[8]=function(b,w){d=b.value,u=w[0],c=w[1],h=w[2],f=w[3],(d[0]!==u||d[1]!==c||d[2]!==h||d[3]!==f)&&(v.uniform4iv(b.locationId,w),d[0]=u,d[1]=c,d[2]=h,d[3]=f)},r.commitFunction[11]=r.commitFunction[8],r.commitFunction[12]=function(b,w){v.uniformMatrix2fv(b.locationId,!1,w)},r.commitFunction[13]=function(b,w){v.uniformMatrix3fv(b.locationId,!1,w)},r.commitFunction[14]=function(b,w){v.uniformMatrix4fv(b.locationId,!1,w)},r.commitFunction[17]=function(b,w){v.uniform1fv(b.locationId,w)},r.commitFunction[21]=function(b,w){v.uniform2fv(b.locationId,w)},r.commitFunction[22]=function(b,w){v.uniform3fv(b.locationId,w)},r.commitFunction[23]=function(b,w){v.uniform4fv(b.locationId,w)},r.commitFunction[26]=function(b,w){b.value!==w&&(v.uniform1ui(b.locationId,w),b.value=w)},r.commitFunction[27]=function(b,w){d=b.value,u=w[0],c=w[1],(d[0]!==u||d[1]!==c)&&(v.uniform2uiv(b.locationId,w),d[0]=u,d[1]=c)},r.commitFunction[28]=function(b,w){d=b.value,u=w[0],c=w[1],h=w[2],(d[0]!==u||d[1]!==c||d[2]!==h)&&(v.uniform3uiv(b.locationId,w),d[0]=u,d[1]=c,d[2]=h)},r.commitFunction[29]=function(b,w){d=b.value,u=w[0],c=w[1],h=w[2],f=w[3],(d[0]!==u||d[1]!==c||d[2]!==h||d[3]!==f)&&(v.uniform4uiv(b.locationId,w),d[0]=u,d[1]=c,d[2]=h,d[3]=f)},r.commitFunction[30]=function(b,w){v.uniform1iv(b.locationId,w)},r.commitFunction[31]=function(b,w){v.uniform1uiv(b.locationId,w)},r.commitFunction[32]=r.commitFunction[30],r.commitFunction[33]=function(b,w){v.uniform2iv(b.locationId,w)},r.commitFunction[34]=function(b,w){v.uniform2uiv(b.locationId,w)},r.commitFunction[35]=r.commitFunction[33],r.commitFunction[36]=function(b,w){v.uniform3iv(b.locationId,w)},r.commitFunction[37]=function(b,w){v.uniform3uiv(b.locationId,w)},r.commitFunction[38]=r.commitFunction[36],r.commitFunction[39]=function(b,w){v.uniform4iv(b.locationId,w)},r.commitFunction[40]=function(b,w){v.uniform4uiv(b.locationId,w)},r.commitFunction[41]=r.commitFunction[39],r.commitFunction[24]=function(b,w){v.uniformMatrix4fv(b.locationId,!1,w)},r.constantTexSource=r.scope.resolve("source"),r.postInit(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&dv(a,o);var i,t=a.prototype;return t.postInit=function(){o.prototype.postInit.call(this),this.gpuProfiler=new T1(this)},t.destroy=function(){o.prototype.destroy.call(this);var e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,o.prototype.postDestroy.call(this)},t.createBackbuffer=function(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Ee({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e},t.updateBackbufferFormat=function(e){var n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,e);var r=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=r?7:6},t.updateBackbuffer=function(){var e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))},t.createVertexBufferImpl=function(e,n){return new h1},t.createIndexBufferImpl=function(e){return new f1(e)},t.createShaderImpl=function(e){return new g1(e)},t.createTextureImpl=function(e){return new y1(e)},t.createRenderTargetImpl=function(e){return new x1},t.getPrecision=function(){var e=this.gl,n="highp";if(e.getShaderPrecisionFormat){var r=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),l=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),u=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(r&&s&&l&&u){var c=r.precision>0&&l.precision>0,h=s.precision>0&&u.precision>0;c||(n=h?"mediump":"lowp")}}return n},t.getExtension=function(){for(var e=0;e<arguments.length;e++)if(this.supportedExtensions.indexOf(arguments[e])!==-1)return this.gl.getExtension(arguments[e]);return null},t.initializeExtensions=function(){var e,n=this.gl;this.supportedExtensions=(e=n.getSupportedExtensions())!=null?e:[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc")},t.initializeCapabilities=function(){var e,n,r,s=this.gl,l=typeof navigator<"u"?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();var u=s.getContextAttributes();this.supportsMsaa=(n=u==null?void 0:u.antialias)!=null&&n,this.supportsStencil=(r=u==null?void 0:u.stencil)!=null&&r,this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),this.maxCubeMapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=s.getParameter(s.MAX_RENDERBUFFER_SIZE),this.maxTextures=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=s.getParameter(s.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=s.getParameter(s.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=s.getParameter(s.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=s.getParameter(s.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?s.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?s.getParameter(e.UNMASKED_VENDOR_WEBGL):"",this.supportsGpuParticles=!(this.unmaskedVendor==="ARM"&&l.match(/SM-[a-zA-Z0-9]+/))&&!this.unmaskedRenderer.match(/\bMali-G52+/),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?s.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;var c=!this.forceDisableMultisampling;this.maxSamples=c?s.getParameter(s.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=c&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!fe.android,this.maxTextures<=8&&(this.supportsAreaLights=!1),this.initCapsDefines()},t.initializeRenderState=function(){o.prototype.initializeRenderState.call(this);var e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new B(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)},t.initTextureUnits=function(e){e===void 0&&(e=16),this.textureUnits=[];for(var n=0;n<e;n++)this.textureUnits.push([null,null,null])},t.initializeContextCaches=function(){o.prototype.initializeContextCaches.call(this),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)},t.loseContext=function(){o.prototype.loseContext.call(this);for(var e,n=pv(this.shaders);!(e=n()).done;)e.value.loseContext()},t.restoreContext=function(){this.initializeExtensions(),this.initializeCapabilities(),o.prototype.restoreContext.call(this);for(var e,n=pv(this.shaders);!(e=n()).done;)e.value.restoreContext()},t.setViewport=function(e,n,r,s){(this.vx!==e||this.vy!==n||this.vw!==r||this.vh!==s)&&(this.gl.viewport(e,n,r,s),this.vx=e,this.vy=n,this.vw=r,this.vh=s)},t.setScissor=function(e,n,r,s){(this.sx!==e||this.sy!==n||this.sw!==r||this.sh!==s)&&(this.gl.scissor(e,n,r,s),this.sx=e,this.sy=n,this.sw=r,this.sh=s)},t.setFramebuffer=function(e){if(this.activeFramebuffer!==e){var n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,e),this.activeFramebuffer=e}},t.copyRenderTarget=function(e,n,r,s){var l,u,c=this.gl;if(e===this.backBuffer&&(e=null),r){if(n){if(e&&(!e._colorBuffer||!n._colorBuffer||e._colorBuffer._format!==n._colorBuffer._format))return!1}else if(!e._colorBuffer)return!1}if(s&&e&&!e._depth&&(!e._depthBuffer||!n._depthBuffer||e._depthBuffer._format!==n._depthBuffer._format))return!1;var h=this.renderTarget;this.renderTarget=n,this.updateBegin();var f=e?e.impl._glFrameBuffer:(l=this.backBuffer)==null?void 0:l.impl._glFrameBuffer,d=n?n.impl._glFrameBuffer:(u=this.backBuffer)==null?void 0:u.impl._glFrameBuffer;c.bindFramebuffer(c.READ_FRAMEBUFFER,f),c.bindFramebuffer(c.DRAW_FRAMEBUFFER,d);var p=e?e.width:n?n.width:this.width,_=e?e.height:n?n.height:this.height;return c.blitFramebuffer(0,0,p,_,0,0,p,_,(r?c.COLOR_BUFFER_BIT:0)|(s?c.DEPTH_BUFFER_BIT:0),c.NEAREST),this.renderTarget=h,c.bindFramebuffer(c.FRAMEBUFFER,h?h.impl._glFrameBuffer:null),!0},t.frameStart=function(){o.prototype.frameStart.call(this),this.updateBackbuffer(),this.gpuProfiler.frameStart()},t.frameEnd=function(){o.prototype.frameEnd.call(this),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()},t.startRenderPass=function(e){var n,r=(n=e.renderTarget)!=null?n:this.backBuffer;this.renderTarget=r,this.updateBegin();var s=r.width,l=r.height;this.setViewport(0,0,s,l),this.setScissor(0,0,s,l);var u=e.colorOps,c=e.depthStencilOps;if(u!=null&&u.clear||c.clearDepth||c.clearStencil){var h=0,f={};u!=null&&u.clear&&(h|=1,f.color=[u.clearValue.r,u.clearValue.g,u.clearValue.b,u.clearValue.a]),c.clearDepth&&(h|=2,f.depth=c.clearDepthValue),c.clearStencil&&(h|=4,f.stencil=c.clearStencilValue),f.flags=h,this.clear(f)}this.insideRenderPass=!0},t.endRenderPass=function(e){this.unbindVertexArray();var n=this.renderTarget,r=e.colorArrayOps.length;if(n){Ws.length=0;for(var s,l=this.gl,u=0;u<r;u++){var c=e.colorArrayOps[u];c.store||c.resolve||Ws.push(l.COLOR_ATTACHMENT0+u)}n!==this.backBuffer&&(e.depthStencilOps.storeDepth||Ws.push(l.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||Ws.push(l.STENCIL_ATTACHMENT)),Ws.length>0&&e.fullSizeClearRect&&l.invalidateFramebuffer(l.DRAW_FRAMEBUFFER,Ws),r&&((s=e.colorOps)!=null&&s.resolve)&&e.samples>1&&n.autoResolve&&n.resolve(!0,!1),n.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&n.autoResolve&&n.resolve(!1,!0);for(var h=0;h<r;h++)if(e.colorArrayOps[h].genMipmaps){var f=n._colorBuffers[h];f&&f.impl._glTexture&&f.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(f),this.gl.generateMipmap(f.impl._glTarget))}}this.insideRenderPass=!1},t.updateBegin=function(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var e,n=0;n<this.textureUnits.length;++n)for(var r=0;r<3;++r)this.textureUnits[n][r]=null;var s=(e=this.renderTarget)!=null?e:this.backBuffer,l=s.impl;l.initialized||this.initRenderTarget(s),this.setFramebuffer(l._glFrameBuffer)},t.updateEnd=function(){this.unbindVertexArray();var e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();var n=e._colorBuffer;n&&n.impl._glTexture&&n.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(n),this.gl.generateMipmap(n.impl._glTarget))}},t.setUnpackFlipY=function(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,e)}},t.setUnpackPremultiplyAlpha=function(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}},t.activeTexture=function(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)},t.bindTexture=function(e){var n=e.impl,r=n._glTarget,s=n._glTexture,l=this.textureUnit,u=this.targetToSlot[r];this.textureUnits[l][u]!==s&&(this.gl.bindTexture(r,s),this.textureUnits[l][u]=s)},t.bindTextureOnUnit=function(e,n){var r=e.impl,s=r._glTarget,l=r._glTexture,u=this.targetToSlot[s];this.textureUnits[n][u]!==l&&(this.activeTexture(n),this.gl.bindTexture(s,l),this.textureUnits[n][u]=l)},t.setTextureParameters=function(e){var n=this.gl,r=e.impl.dirtyParameterFlags,s=e.impl._glTarget;if(1&r){var l=e._minFilter;(!e._mipmaps||e._compressed&&e._levels.length===1)&&(l===2||l===3?l=0:(l===4||l===5)&&(l=1)),n.texParameteri(s,n.TEXTURE_MIN_FILTER,this.glFilter[l])}if(2&r&&n.texParameteri(s,n.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&r&&n.texParameteri(s,n.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&r&&n.texParameteri(s,n.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&r&&n.texParameteri(s,n.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&r&&n.texParameteri(s,n.TEXTURE_COMPARE_MODE,e._compareOnRead?n.COMPARE_REF_TO_TEXTURE:n.NONE),64&r&&n.texParameteri(s,n.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&r){var u=this.extTextureFilterAnisotropic;u&&n.texParameterf(s,u.TEXTURE_MAX_ANISOTROPY_EXT,U.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}},t.setTexture=function(e,n){var r=e.impl;r._glTexture||r.initialize(this,e),r.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(n),this.bindTexture(e),r.dirtyParameterFlags&&(this.setTextureParameters(e),r.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(r.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,n)},t.createVertexArray=function(e){var n,r,s=e.length>1;if(s){n="";for(var l=0;l<e.length;l++){var u=e[l];n+=u.id+u.format.renderingHash}r=this._vaoMap.get(n)}if(!r){var c=this.gl;r=c.createVertexArray(),c.bindVertexArray(r),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);for(var h=0;h<e.length;h++){var f=e[h];c.bindBuffer(c.ARRAY_BUFFER,f.impl.bufferId);for(var d=f.format.elements,p=0;p<d.length;p++){var _=d[p],g=me[_.name];_.asInt?c.vertexAttribIPointer(g,_.numComponents,this.glType[_.dataType],_.stride,_.offset):c.vertexAttribPointer(g,_.numComponents,this.glType[_.dataType],_.normalize,_.stride,_.offset),c.enableVertexAttribArray(g),f.format.instancing&&c.vertexAttribDivisor(g,1)}}c.bindVertexArray(null),c.bindBuffer(c.ARRAY_BUFFER,null),s&&this._vaoMap.set(n,r)}return r},t.unbindVertexArray=function(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))},t.setBuffers=function(e){var n,r=this.gl;if(this.vertexBuffers.length===1){var s=this.vertexBuffers[0];s.impl.vao||(s.impl.vao=this.createVertexArray(this.vertexBuffers)),n=s.impl.vao}else n=this.createVertexArray(this.vertexBuffers);this.boundVao!==n&&(this.boundVao=n,r.bindVertexArray(n));var l=e?e.impl.bufferId:null;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,l)},t.draw=function(e,n,r,s,l){s===void 0&&(s=!0),l===void 0&&(l=!0);var u=this.shader;if(u&&(this.activateShader(),this.shaderValid)){var c=this.gl;s&&this.setBuffers(n);for(var h=0,f=u.impl.samplers,d=0,p=f.length;d<p;d++){var _,g=f[d],y=g.scopeId.value;if(!y){var v=g.scopeId.name;v==="uSceneDepthMap"&&(y=Vr(this,"white")),v==="uSceneColorMap"&&(y=Vr(this,"pink")),y||(y=Vr(this,"pink"))}if(_=y,ee!=null&&typeof Symbol<"u"&&ee[Symbol.hasInstance]?!!ee[Symbol.hasInstance](_):Q(_,ee)){var x=y;this.setTexture(x,h),g.slot!==h&&(c.uniform1i(g.locationId,h),g.slot=h),h++}else{g.array.length=0;for(var S=y.length,T=0;T<S;T++){var b=y[T];this.setTexture(b,h),g.array[T]=h,h++}c.uniform1iv(g.locationId,g.array)}}for(var w=u.impl.uniforms,A=0,C=w.length;A<C;A++){var L=w[A],I=L.scopeId,P=L.version,M=I.versionObject.version;if(P.globalId!==M.globalId||P.revision!==M.revision){P.globalId=M.globalId,P.revision=M.revision;var R=I.value;R!=null&&this.commitFunction[L.dataType](L,R)}}this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),c.beginTransformFeedback(c.POINTS));var k=this.glPrimitive[e.type],D=e.count;if(e.indexed){var O=n.impl.glFormat,F=e.base*n.bytesPerIndex;r>0?c.drawElementsInstanced(k,D,O,F,r):c.drawElements(k,D,O,F)}else{var N=e.base;r>0?c.drawArraysInstanced(k,N,D,r):c.drawArrays(k,N,D)}this.transformFeedbackBuffer&&(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}l&&this.clearVertexBuffer()},t.clear=function(e){var n=this.defaultClearOptions,r=(l=(e=e||n).flags)!=null?l:n.flags;if(r!==0){var s=this.gl;if(1&r){var l,u,c=(u=e.color)!=null?u:n.color,h=c[0],f=c[1],d=c[2],p=c[3],_=this.clearColor;(h!==_.r||f!==_.g||d!==_.b||p!==_.a)&&(this.gl.clearColor(h,f,d,p),this.clearColor.set(h,f,d,p)),this.setBlendState(ge.NOBLEND)}if(2&r){var g,y=(g=e.depth)!=null?g:n.depth;y!==this.clearDepth&&(this.gl.clearDepth(y),this.clearDepth=y),this.setDepthState(Xe.WRITEDEPTH)}if(4&r){var v,x=(v=e.stencil)!=null?v:n.stencil;x!==this.clearStencil&&(this.gl.clearStencil(x),this.clearStencil=x),s.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}s.clear(this.glClearFlag[r])}},t.submit=function(){this.gl.flush()},t.readPixels=function(e,n,r,s,l){var u=this.gl;u.readPixels(e,n,r,s,u.RGBA,u.UNSIGNED_BYTE,l)},t.clientWaitAsync=function(e,n){var r=this.gl,s=r.fenceSync(r.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise(function(l,u){(function c(){var h=r.clientWaitSync(s,e,0);h===r.TIMEOUT_EXPIRED?setTimeout(c,n):(r.deleteSync(s),h===r.WAIT_FAILED?u(Error("webgl clientWaitSync sync failed")):l())})()})},t.readPixelsAsync=function(e,n,r,s,l){var u=this;return fv(function(){var c,h,f,d,p,_,g,y;return mv(this,function(v){switch(v.label){case 0:return h=u.gl,p=(d=(f=(c=u.renderTarget.colorBuffer)==null?void 0:c.impl)==null?void 0:f._glFormat)!=null?d:h.RGBA,g=(_=f==null?void 0:f._glPixelType)!=null?_:h.UNSIGNED_BYTE,y=h.createBuffer(),h.bindBuffer(h.PIXEL_PACK_BUFFER,y),h.bufferData(h.PIXEL_PACK_BUFFER,l.byteLength,h.STREAM_READ),h.readPixels(e,n,r,s,p,g,0),h.bindBuffer(h.PIXEL_PACK_BUFFER,null),[4,u.clientWaitAsync(0,16)];case 1:return v.sent(),h.bindBuffer(h.PIXEL_PACK_BUFFER,y),h.getBufferSubData(h.PIXEL_PACK_BUFFER,0,l),h.bindBuffer(h.PIXEL_PACK_BUFFER,null),h.deleteBuffer(y),[2,l]}})})()},t.readTextureAsync=function(e,n,r,s,l,u){var c,h,f,d=this,p=(c=u.face)!=null?c:0,_=(h=u.renderTarget)!=null?h:new Ee({colorBuffer:e,depth:!1,face:p}),g=new ArrayBuffer(En.calcLevelGpuSize(s,l,1,e._format)),y=(f=u.data)!=null?f:new(Hh(e._format))(g);return this.setRenderTarget(_),this.initRenderTarget(_),new Promise(function(v,x){d.readPixelsAsync(n,r,s,l,y).then(function(S){u.renderTarget||_.destroy(),v(S)}).catch(x)})},t.writeTextureAsync=function(e,n,r,s,l,u){var c=this;return fv(function(){var h,f,d,p,_,g,y;return mv(this,function(v){switch(v.label){case 0:return h=c.gl,p=(d=(f=e.impl)==null?void 0:f._glFormat)!=null?d:h.RGBA,g=(_=f==null?void 0:f._glPixelType)!=null?_:h.UNSIGNED_BYTE,y=h.createBuffer(),h.bindBuffer(h.PIXEL_UNPACK_BUFFER,y),h.bufferData(h.PIXEL_UNPACK_BUFFER,u,h.STREAM_DRAW),h.bindTexture(h.TEXTURE_2D,f._glTexture),h.texSubImage2D(h.TEXTURE_2D,0,n,r,s,l,p,g,0),h.bindBuffer(h.PIXEL_UNPACK_BUFFER,null),e._needsUpload=!1,e._mipmapsUploaded=!1,[4,c.clientWaitAsync(0,16)];case 1:return v.sent(),[2]}})})()},t.setAlphaToCoverage=function(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},t.setTransformFeedbackBuffer=function(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;var n=this.gl;e?(this.feedback||(this.feedback=n.createTransformFeedback()),n.bindTransformFeedback(n.TRANSFORM_FEEDBACK,this.feedback)):n.bindTransformFeedback(n.TRANSFORM_FEEDBACK,null)}},t.setRaster=function(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))},t.setStencilTest=function(e){if(this.stencil!==e){var n=this.gl;e?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.stencil=e}},t.setStencilFunc=function(e,n,r){(this.stencilFuncFront!==e||this.stencilRefFront!==n||this.stencilMaskFront!==r||this.stencilFuncBack!==e||this.stencilRefBack!==n||this.stencilMaskBack!==r)&&(this.gl.stencilFunc(this.glComparison[e],n,r),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=n,this.stencilMaskFront=this.stencilMaskBack=r)},t.setStencilFuncFront=function(e,n,r){if(this.stencilFuncFront!==e||this.stencilRefFront!==n||this.stencilMaskFront!==r){var s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[e],n,r),this.stencilFuncFront=e,this.stencilRefFront=n,this.stencilMaskFront=r}},t.setStencilFuncBack=function(e,n,r){if(this.stencilFuncBack!==e||this.stencilRefBack!==n||this.stencilMaskBack!==r){var s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[e],n,r),this.stencilFuncBack=e,this.stencilRefBack=n,this.stencilMaskBack=r}},t.setStencilOperation=function(e,n,r,s){(this.stencilFailFront!==e||this.stencilZfailFront!==n||this.stencilZpassFront!==r||this.stencilFailBack!==e||this.stencilZfailBack!==n||this.stencilZpassBack!==r)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[n],this.glStencilOp[r]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=n,this.stencilZpassFront=this.stencilZpassBack=r),(this.stencilWriteMaskFront!==s||this.stencilWriteMaskBack!==s)&&(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s)},t.setStencilOperationFront=function(e,n,r,s){(this.stencilFailFront!==e||this.stencilZfailFront!==n||this.stencilZpassFront!==r)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[n],this.glStencilOp[r]),this.stencilFailFront=e,this.stencilZfailFront=n,this.stencilZpassFront=r),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)},t.setStencilOperationBack=function(e,n,r,s){(this.stencilFailBack!==e||this.stencilZfailBack!==n||this.stencilZpassBack!==r)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[n],this.glStencilOp[r]),this.stencilFailBack=e,this.stencilZfailBack=n,this.stencilZpassBack=r),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)},t.setBlendState=function(e){var n=this.blendState;if(!n.equals(e)){var r=this.gl,s=e.blend,l=e.colorOp,u=e.alphaOp,c=e.colorSrcFactor,h=e.colorDstFactor,f=e.alphaSrcFactor,d=e.alphaDstFactor;if(n.blend!==s&&(s?r.enable(r.BLEND):r.disable(r.BLEND)),n.colorOp!==l||n.alphaOp!==u){var p=this.glBlendEquation;r.blendEquationSeparate(p[l],p[u])}(n.colorSrcFactor!==c||n.colorDstFactor!==h||n.alphaSrcFactor!==f||n.alphaDstFactor!==d)&&r.blendFuncSeparate(this.glBlendFunctionColor[c],this.glBlendFunctionColor[h],this.glBlendFunctionAlpha[f],this.glBlendFunctionAlpha[d]),n.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),n.copy(e)}},t.setBlendColor=function(e,n,r,s){var l=this.blendColor;(e!==l.r||n!==l.g||r!==l.b||s!==l.a)&&(this.gl.blendColor(e,n,r,s),l.set(e,n,r,s))},t.setStencilState=function(e,n){e||n?(this.setStencilTest(!0),e===n?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(e!=null||(e=Xt.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),n!=null||(n=Xt.DEFAULT),this.setStencilFuncBack(n.func,n.ref,n.readMask),this.setStencilOperationBack(n.fail,n.zfail,n.zpass,n.writeMask))):this.setStencilTest(!1)},t.setDepthState=function(e){var n=this.depthState;if(!n.equals(e)){var r=this.gl,s=e.write;n.write!==s&&r.depthMask(s);var l=e.func,u=e.test;!u&&s&&(u=!0,l=7),n.func!==l&&r.depthFunc(this.glComparison[l]),n.test!==u&&(u?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST));var c=e.depthBias,h=e.depthBiasSlope;c||h?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),r.polygonOffset(h,c)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),n.copy(e)}},t.setCullMode=function(e){if(this.cullMode!==e){if(e===0)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===0&&this.gl.enable(this.gl.CULL_FACE);var n=this.glCull[e];this.cullFace!==n&&(this.gl.cullFace(n),this.cullFace=n)}this.cullMode=e}},t.setShader=function(e,n){n===void 0&&(n=!1),e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=n,this.shaderValid=void 0)},t.activateShader=function(){var e=this.shader,n=e.impl;this.shaderValid===void 0&&(e.failed?this.shaderValid=!1:!e.ready&&(this.shaderAsyncCompile?n.isLinked(this)?n.finalize(this,e)||(e.failed=!0,this.shaderValid=!1):this.shaderValid=!1:n.finalize(this,e)||(e.failed=!0,this.shaderValid=!1))),this.shaderValid===void 0&&(this.gl.useProgram(n.glProgram),this.shaderValid=!0)},t.clearVertexArrayObjectCache=function(){var e=this.gl;this._vaoMap.forEach(function(n,r,s){e.deleteVertexArray(n)}),this._vaoMap.clear()},i=[{key:"extDisjointTimerQuery",get:function(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}},{key:"defaultFramebuffer",get:function(){return this._defaultFramebuffer},set:function(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}},{key:"fullscreen",get:function(){return!!document.fullscreenElement},set:function(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ie),E1=function(){function o(){}return o.prototype.unlock=function(a){},o}(),w1=function(){function o(){}var a=o.prototype;return a.destroy=function(i){},a.init=function(i,t){},a.loseContext=function(){},a.resolve=function(i,t,e,n){},o}(),A1=function(){function o(){}var a=o.prototype;return a.destroy=function(i){},a.loseContext=function(){},a.restoreContext=function(i,t){},o}(),C1=function(){function o(){}var a=o.prototype;return a.destroy=function(i){},a.propertyChanged=function(i){},a.loseContext=function(){},o}(),P1=function(){function o(){}var a=o.prototype;return a.destroy=function(i){},a.unlock=function(i){},o}();function _v(o,a){return(_v=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var vv=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return e===void 0&&(e={}),e=(n=o.call(this,t,e)||this).initOptions,n.isNull=!0,n._deviceType=uo,n.samples=1,n.backBuffer=new Ee({name:"Framebuffer",graphicsDevice:n,depth:n.initOptions.depth,stencil:n.supportsStencil,samples:n.samples}),n.initDeviceCaps(),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&_v(a,o);var i=a.prototype;return i.destroy=function(){o.prototype.destroy.call(this)},i.initDeviceCaps=function(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!1},i.postInit=function(){o.prototype.postInit.call(this)},i.frameStart=function(){o.prototype.frameStart.call(this)},i.frameEnd=function(){o.prototype.frameEnd.call(this)},i.updateBegin=function(){},i.updateEnd=function(){},i.readPixels=function(t,e,n,r,s){},i.createVertexBufferImpl=function(t,e){return new P1(t,e)},i.createIndexBufferImpl=function(t){return new E1(t)},i.createShaderImpl=function(t){return new A1(t)},i.createTextureImpl=function(t){return new C1(t)},i.createRenderTargetImpl=function(t){return new w1(t)},i.draw=function(t,e,n,r,s){},i.setShader=function(t,e){},i.setBlendState=function(t){},i.setDepthState=function(t){},i.setStencilState=function(t,e){},i.setBlendColor=function(t,e,n,r){},i.setCullMode=function(t){},i.setAlphaToCoverage=function(t){},i.initializeContextCaches=function(){o.prototype.initializeContextCaches.call(this)},i.clear=function(t){},i.setViewport=function(t,e,n,r){},i.setScissor=function(t,e,n,r){},i.copyRenderTarget=function(t,e,n,r){return!0},a}(Ie);function gv(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}var I1=function(){this.scopeId=null},L1=function(){function o(i,t,e){e===void 0&&(e="Unnamed"),this.shader=null,this.parameters=new Map,this.countX=1,this.device=i,this.shader=t,this.name=e,i.supportsCompute&&(this.impl=i.createComputeImpl(this))}var a=o.prototype;return a.setParameter=function(i,t){var e=this.parameters.get(i);e||((e=new I1).scopeId=this.device.scope.resolve(i),this.parameters.set(i,e)),e.value=t},a.getParameter=function(i){var t;return(t=this.parameters.get(i))==null?void 0:t.value},a.deleteParameter=function(i){this.parameters.delete(i)},a.applyParameters=function(){for(var i,t=function(n,r){var s=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(s)return(s=s.call(n)).next.bind(s);if(Array.isArray(n)||(s=function(u,c){if(u){if(typeof u=="string")return gv(u,void 0);var h=Object.prototype.toString.call(u).slice(8,-1);if(h==="Object"&&u.constructor&&(h=u.constructor.name),h==="Map"||h==="Set")return Array.from(h);if(h==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(h))return gv(u,void 0)}}(n))){s&&(n=s);var l=0;return function(){return l>=n.length?{done:!0}:{done:!1,value:n[l++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.parameters);!(i=t()).done;){var e=i.value[1];e.scopeId.setValue(e.value)}},a.setupDispatch=function(i,t,e){this.countX=i,this.countY=t,this.countZ=e},o}(),D1=0,Yn=function(){function o(i,t,e,n,r,s){n===void 0&&(n=0),this.device=i,this.format=t,this.numIndices=e,this.usage=n,this.id=D1++,this.impl=i.createIndexBufferImpl(this,s);var l=p_[t];this.bytesPerIndex=l,this.numBytes=this.numIndices*l,r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(i._vram,this.numBytes),this.device.buffers.push(this)}var a=o.prototype;return a.destroy=function(){var i=this.device,t=i.buffers.indexOf(this);t!==-1&&i.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(i),this.adjustVramSizeTracking(i._vram,-this.storage.byteLength))},a.adjustVramSizeTracking=function(i,t){i.ib+=t},a.loseContext=function(){this.impl.loseContext()},a.getFormat=function(){return this.format},a.getNumIndices=function(){return this.numIndices},a.lock=function(){return this.storage},a.unlock=function(){this.impl.unlock(this)},a.setData=function(i){return i.byteLength===this.numBytes&&(this.storage=i,this.unlock(),!0)},a._lockTypedArray=function(){var i=this.lock();return this.format===2?new Uint32Array(i):this.format===1?new Uint16Array(i):new Uint8Array(i)},a.writeData=function(i,t){var e=this._lockTypedArray();if(i.length>t)if(ArrayBuffer.isView(i))i=i.subarray(0,t),e.set(i);else for(var n=0;n<t;n++)e[n]=i[n];else e.set(i);this.unlock()},a.readData=function(i){var t=this._lockTypedArray(),e=this.numIndices;if(ArrayBuffer.isView(i))i.set(t);else{i.length=0;for(var n=0;n<e;n++)i[n]=t[n]}return e},o}(),M1=function(){this.clearValue=new B(0,0,0,1),this.clearValueLinear=new B(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1},R1=function(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1},ct=function(){function o(t){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=t}var a,i=o.prototype;return i.init=function(t,e){t===void 0&&(t=null),this.options=e,this.renderTarget=t,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()},i.allocateAttachments=function(){var t=this.renderTarget;this.depthStencilOps=new R1,t!=null&&t.depthBuffer&&(this.depthStencilOps.storeDepth=!0);var e=t?(s=(r=t._colorBuffers)==null?void 0:r.length)!=null?s:0:1;this.colorArrayOps.length=0;for(var n=0;n<e;n++){var r,s,l,u,c,h=new M1;this.colorArrayOps[n]=h,this.samples===1&&(h.store=!0,h.resolve=!1);var f=(u=this.renderTarget)==null||(l=u._colorBuffers)==null?void 0:l[n];(c=this.renderTarget)!=null&&c.mipmaps&&(f!=null&&f.mipmaps)&&(h.genMipmaps=!mi(f._format))}},i.destroy=function(){},i.postInit=function(){},i.frameUpdate=function(){if(this._options&&this.renderTarget){var t,e=(t=this._options.resizeSource)!=null?t:this.device.backBuffer,n=Math.floor(e.width*this.scaleX),r=Math.floor(e.height*this.scaleY);this.renderTarget.resize(n,r)}},i.before=function(){},i.execute=function(){},i.after=function(){},i.onEnable=function(){},i.onDisable=function(){},i.setClearColor=function(t){for(var e=this.colorArrayOps.length,n=0;n<e;n++){var r=this.colorArrayOps[n];t&&(r.clearValue.copy(t),r.clearValueLinear.linear(t)),r.clear=!!t}},i.setClearDepth=function(t){t&&(this.depthStencilOps.clearDepthValue=t),this.depthStencilOps.clearDepth=t!==void 0},i.setClearStencil=function(t){t&&(this.depthStencilOps.clearStencilValue=t),this.depthStencilOps.clearStencil=t!==void 0},i.render=function(){if(this.enabled){var t=this.device,e=this.renderTarget!==void 0;this.before(),this.executeEnabled&&(e&&!this._skipStart&&t.startRenderPass(this),this.execute(),e&&!this._skipEnd&&t.endRenderPass(this)),this.after(),t.renderPassIndex++}},a=[{key:"colorOps",get:function(){return this.colorArrayOps[0]}},{key:"name",get:function(){return this._name||(this._name=this.constructor.name),this._name},set:function(t){this._name=t}},{key:"scaleX",get:function(){return this._options.scaleX},set:function(t){this._options.scaleX=t}},{key:"scaleY",get:function(){return this._options.scaleY},set:function(t){this._options.scaleY=t}},{key:"options",get:function(){return this._options},set:function(t){if(this._options=t,t){var e,n;this.scaleX=(e=this.scaleX)!=null?e:1,this.scaleY=(n=this.scaleY)!=null?n:1}}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,t?this.onEnable():this.onDisable())}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),O1=0,k1=function(){function o(i,t,e){e===void 0&&(e=0),this.id=O1++,this.device=i,this.byteSize=t,this.bufferUsage=e,this.impl=i.createBufferImpl(128|e),this.impl.allocate(i,t),this.device.buffers.push(this),this.adjustVramSizeTracking(i._vram,this.byteSize)}var a=o.prototype;return a.destroy=function(){var i=this.device,t=i.buffers.indexOf(this);t!==-1&&i.buffers.splice(t,1),this.adjustVramSizeTracking(i._vram,-this.byteSize),this.impl.destroy(i)},a.adjustVramSizeTracking=function(i,t){i.sb+=t},a.read=function(i,t,e){return i===void 0&&(i=0),t===void 0&&(t=this.byteSize),e===void 0&&(e=null),this.impl.read(this.device,i,t,e)},a.write=function(i,t,e,n){i===void 0&&(i=0),e===void 0&&(e=0),this.impl.write(this.device,i,t,e,n)},a.clear=function(i,t){i===void 0&&(i=0),t===void 0&&(t=this.byteSize),this.impl.clear(this.device,i,t)},o}(),N1=function(){function o(t,e){e===void 0&&(e=3),this.device=t.device;var n=this.device.gl;this._inputBuffer=t,e===3&&t.usage!==e&&(n.bindBuffer(n.ARRAY_BUFFER,t.impl.bufferId),n.bufferData(n.ARRAY_BUFFER,t.storage,n.DYNAMIC_COPY)),this._outputBuffer=new Rt(t.device,t.format,t.numVertices,{usage:e,data:t.storage})}var a,i=o.prototype;return i.destroy=function(){this._outputBuffer.destroy()},i.process=function(t,e){e===void 0&&(e=!0);var n=this.device,r=n.getRenderTarget();if(n.setRenderTarget(null),n.updateBegin(),n.setVertexBuffer(this._inputBuffer,0),n.setRaster(!1),n.setTransformFeedbackBuffer(this._outputBuffer),n.setShader(t),n.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),n.setTransformFeedbackBuffer(null),n.setRaster(!0),n.updateEnd(),n.setRenderTarget(r),e){var s=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=s,s=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=s}},o.createShader=function(t,e,n){return new rr(t,ir.createDefinition(t,{name:n,vertexCode:e,useTransformFeedback:!0,fragmentCode:"void main(void) {gl_FragColor = vec4(0.0);}"}))},a=[{key:"inputBuffer",get:function(){return this._inputBuffer}},{key:"outputBuffer",get:function(){return this._outputBuffer}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function F1(o){this.array[this.index]=o}function U1(o,a){this.array[this.index]=o,this.array[this.index+1]=a}function B1(o,a,i){this.array[this.index]=o,this.array[this.index+1]=a,this.array[this.index+2]=i}function V1(o,a,i,t){this.array[this.index]=o,this.array[this.index+1]=a,this.array[this.index+2]=i,this.array[this.index+3]=t}function z1(o,a,i){this.array[o]=a[i]}function G1(o,a,i){this.array[o]=a[i],this.array[o+1]=a[i+1]}function H1(o,a,i){this.array[o]=a[i],this.array[o+1]=a[i+1],this.array[o+2]=a[i+2]}function W1(o,a,i){this.array[o]=a[i],this.array[o+1]=a[i+1],this.array[o+2]=a[i+2],this.array[o+3]=a[i+3]}function j1(o,a,i){a[i]=this.array[o]}function X1(o,a,i){a[i]=this.array[o],a[i+1]=this.array[o+1]}function Y1(o,a,i){a[i]=this.array[o],a[i+1]=this.array[o+1],a[i+2]=this.array[o+2]}function q1(o,a,i){a[i]=this.array[o],a[i+1]=this.array[o+1],a[i+2]=this.array[o+2],a[i+3]=this.array[o+3]}var K1=function(){function o(i,t,e){switch(this.index=0,this.numComponents=t.numComponents,e.interleaved?this.array=new Ur[t.dataType](i,t.offset):this.array=new Ur[t.dataType](i,t.offset,e.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=F1,this.getToArray=j1,this.setFromArray=z1;break;case 2:this.set=U1,this.getToArray=X1,this.setFromArray=G1;break;case 3:this.set=B1,this.getToArray=Y1,this.setFromArray=H1;break;case 4:this.set=V1,this.getToArray=q1,this.setFromArray=W1}}var a=o.prototype;return a.get=function(i){return this.array[this.index+i]},a.set=function(i,t,e,n){},a.getToArray=function(i,t,e){},a.setFromArray=function(i,t,e){},o}(),js=function(){function o(i){this.vertexBuffer=i,this.vertexFormatSize=i.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var t=this.vertexBuffer.getFormat(),e=0;e<t.elements.length;e++){var n=t.elements[e];this.accessors[e]=new K1(this.buffer,n,t),this.element[n.name]=this.accessors[e]}}var a=o.prototype;return a.next=function(i){i===void 0&&(i=1);for(var t=0,e=this.accessors,n=this.accessors.length;t<n;){var r=e[t++];r.index+=i*r.stride}},a.end=function(){this.vertexBuffer.unlock()},a.writeData=function(i,t,e){var n=this.element[i];if(n){e>this.vertexBuffer.numVertices&&(e=this.vertexBuffer.numVertices);var r=n.numComponents;if(this.vertexBuffer.getFormat().interleaved)for(var s=0,l=0;l<e;l++)n.setFromArray(s,t,l*r),s+=n.stride;else if(t.length>e*r){var u=e*r;if(ArrayBuffer.isView(t))t=t.subarray(0,u),n.array.set(t);else for(var c=0;c<u;c++)n.array[c]=t[c]}else n.array.set(t)}},a.readData=function(i,t){var e=this.element[i],n=0;if(e){n=this.vertexBuffer.numVertices;var r,s=e.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),e.index=0;var l=0;for(r=0;r<n;r++)e.getToArray(l,t,r*s),l+=e.stride}else if(ArrayBuffer.isView(t))t.set(e.array);else{t.length=0;var u=n*s;for(r=0;r<u;r++)t[r]=e.array[r]}}return n},o}(),uu="mouse",cu="keyboard",hu="gamepad",yv=function(o,a){this.key=null,this.element=null,this.event=null,a&&(this.key=a.keyCode,this.element=a.target,this.event=a)};function Sv(o,a){return(Sv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var fu=new yv;function gf(o){return fu.key=o.keyCode,fu.element=o.target,fu.event=o,fu}function du(o){return typeof o=="string"?o.toUpperCase().charCodeAt(0):o}var Z1={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},pu=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return e===void 0&&(e={}),(n=o.call(this)||this)._element=null,n._keymap={},n._lastmap={},n._keyDownHandler=n._handleKeyDown.bind(n),n._keyUpHandler=n._handleKeyUp.bind(n),n._keyPressHandler=n._handleKeyPress.bind(n),n._visibilityChangeHandler=n._handleVisibilityChange.bind(n),n._windowBlurHandler=n._handleWindowBlur.bind(n),t&&n.attach(t),n.preventDefault=e.preventDefault||!1,n.stopPropagation=e.stopPropagation||!1,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Sv(a,o);var i=a.prototype;return i.attach=function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)},i.detach=function(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))},i.toKeyIdentifier=function(t){var e=Z1[(t=du(t)).toString()];if(e)return e;for(var n=t.toString(16).toUpperCase(),r=n.length,s=0;s<4-r;s++)n="0"+n;return"U+"+n},i._handleKeyDown=function(t){var e=t.keyCode||t.charCode;if(e!==void 0){var n=this.toKeyIdentifier(e);this._keymap[n]=!0,this.fire("keydown",gf(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}},i._handleKeyUp=function(t){var e=t.keyCode||t.charCode;if(e!==void 0){var n=this.toKeyIdentifier(e);delete this._keymap[n],this.fire("keyup",gf(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}},i._handleKeyPress=function(t){this.fire("keypress",gf(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()},i._handleVisibilityChange=function(){document.visibilityState==="hidden"&&this._handleWindowBlur()},i._handleWindowBlur=function(){this._keymap={},this._lastmap={}},i.update=function(){for(var t in this._lastmap)delete this._lastmap[t];for(var e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])},i.isPressed=function(t){var e=du(t),n=this.toKeyIdentifier(e);return!!this._keymap[n]},i.wasPressed=function(t){var e=du(t),n=this.toKeyIdentifier(e);return!!this._keymap[n]&&!this._lastmap[n]},i.wasReleased=function(t){var e=du(t),n=this.toKeyIdentifier(e);return!this._keymap[n]&&!!this._lastmap[n]},a}(se);function yf(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}pu.EVENT_KEYDOWN="keydown",pu.EVENT_KEYUP="keyup";var Xs=function o(a,i){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1;var t,e,n,r,s,l,u={x:0,y:0};if(i){if(t=i,(e=o)!=null&&typeof Symbol<"u"&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):Q(t,e))throw Error("Expected MouseEvent");u=a._getTargetCoords(i)}else i={};if(u)this.x=u.x,this.y=u.y;else{if(!yf())return;this.x=0,this.y=0}i.type==="wheel"&&(i.deltaY>0?this.wheelDelta=1:i.deltaY<0&&(this.wheelDelta=-1)),yf()?(this.dx=i.movementX||i.webkitMovementX||i.mozMovementX||0,this.dy=i.movementY||i.webkitMovementY||i.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY),(i.type==="mousedown"||i.type==="mouseup")&&(this.button=i.button),this.buttons=a._buttons.slice(0),this.element=i.target,this.ctrlKey=(n=i.ctrlKey)!=null&&n,this.altKey=(r=i.altKey)!=null&&r,this.shiftKey=(s=i.shiftKey)!=null&&s,this.metaKey=(l=i.metaKey)!=null&&l,this.event=i};function xv(o,a){return(xv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var yi=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this)._lastX=0,e._lastY=0,e._buttons=[!1,!1,!1],e._lastbuttons=[!1,!1,!1],e._target=null,e._attached=!1,e._upHandler=e._handleUp.bind(e),e._downHandler=e._handleDown.bind(e),e._moveHandler=e._handleMove.bind(e),e._wheelHandler=e._handleWheel.bind(e),e._contextMenuHandler=function(n){n.preventDefault()},e.attach(t),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&xv(a,o);var i=a.prototype;return i.attach=function(t){if(this._target=t,!this._attached){this._attached=!0;var e=!!fe.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}},i.detach=function(){if(this._attached){this._attached=!1,this._target=null;var t=!!fe.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}},i.disableContextMenu=function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},i.enableContextMenu=function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},i.enablePointerLock=function(t,e){if(!document.body.requestPointerLock){e&&e();return}var n=function(){t(),document.removeEventListener("pointerlockchange",n)},r=function(){e(),document.removeEventListener("pointerlockerror",r)};t&&document.addEventListener("pointerlockchange",n,!1),e&&document.addEventListener("pointerlockerror",r,!1),document.body.requestPointerLock()},i.disablePointerLock=function(t){if(document.exitPointerLock){var e=function(){t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}},i.update=function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},i.isPressed=function(t){return this._buttons[t]},i.wasPressed=function(t){return this._buttons[t]&&!this._lastbuttons[t]},i.wasReleased=function(t){return!this._buttons[t]&&this._lastbuttons[t]},i._handleUp=function(t){this._buttons[t.button]=!1;var e=new Xs(this,t);e.event&&this.fire("mouseup",e)},i._handleDown=function(t){this._buttons[t.button]=!0;var e=new Xs(this,t);e.event&&this.fire("mousedown",e)},i._handleMove=function(t){var e=new Xs(this,t);e.event&&(this.fire("mousemove",e),this._lastX=e.x,this._lastY=e.y)},i._handleWheel=function(t){var e=new Xs(this,t);e.event&&this.fire("mousewheel",e)},i._getTargetCoords=function(t){var e=this._target.getBoundingClientRect(),n=Math.floor(e.left),r=Math.floor(e.top);return t.clientX<n||t.clientX>=n+this._target.clientWidth||t.clientY<r||t.clientY>=r+this._target.clientHeight?null:{x:t.clientX-n,y:t.clientY-r}},a.isPointerLocked=function(){return yf()},a}(se);yi.EVENT_MOUSEMOVE="mousemove",yi.EVENT_MOUSEDOWN="mousedown",yi.EVENT_MOUSEUP="mouseup",yi.EVENT_MOUSEWHEEL="mousewheel";var Q1=function(){function o(i,t){t===void 0&&(t={}),this._element=null,this._actions={},this._axes={},this._axesValues={},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,i&&this.attach(i)}var a=o.prototype;return a.attach=function(i){this._element=i,this._keyboard&&this._keyboard.attach(i),this._mouse&&this._mouse.attach(i)},a.detach=function(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null},a.disableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()},a.enableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()},a.update=function(i){for(var t in this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={},this._axes)this._axesValues[t]=[]},a.appendAction=function(i,t){this._actions[i]=this._actions[i]||[],this._actions[i].push(t)},a.registerKeys=function(i,t){if(this._keyboard||this._enableKeyboard(),this._actions[i])throw Error("Action: "+i+" already registered");if(t===void 0)throw Error("Invalid button");t.length||(t=[t]),this.appendAction(i,{type:cu,keys:t})},a.registerMouse=function(i,t){if(this._mouse||this._enableMouse(),t===void 0)throw Error("Invalid button");this.appendAction(i,{type:uu,button:t})},a.registerPadButton=function(i,t,e){if(e===void 0)throw Error("Invalid button");this.appendAction(i,{type:hu,button:e,pad:t})},a.registerAxis=function(i){var t=i.name;this._axes[t]||(this._axes[t]=[]);var e=this._axes[t].push(t);(i=i||{}).pad=i.pad||0;var n=function(r,s,l,u){switch(s){case"mousex":r._mouse.on("mousemove",function(c){r._axesValues[t][e]=c.dx/10});break;case"mousey":r._mouse.on("mousemove",function(c){r._axesValues[t][e]=c.dy/10});break;case"key":r._axes[t].push(function(){return r._keyboard.isPressed(u)?l:0});break;case"padrx":r._axes[t].push(function(){return r._gamepads.getAxis(i.pad,2)});break;case"padry":r._axes[t].push(function(){return r._gamepads.getAxis(i.pad,3)});break;case"padlx":r._axes[t].push(function(){return r._gamepads.getAxis(i.pad,0)});break;case"padly":r._axes[t].push(function(){return r._gamepads.getAxis(i.pad,1)});break;default:throw Error("Unknown axis")}};n(this,i.positive,1,i.positiveKey),(i.negativeKey||i.negative!==i.positive)&&n(this,i.negative,-1,i.negativeKey)},a.isPressed=function(i){if(!this._actions[i])return!1;for(var t=this._actions[i].length,e=0;e<t;++e){var n=this._actions[i][e];switch(n.type){case cu:if(this._keyboard){for(var r=n.keys.length,s=0;s<r;s++)if(this._keyboard.isPressed(n.keys[s]))return!0}break;case uu:if(this._mouse&&this._mouse.isPressed(n.button))return!0;break;case hu:if(this._gamepads&&this._gamepads.isPressed(n.pad,n.button))return!0}}return!1},a.wasPressed=function(i){if(!this._actions[i])return!1;for(var t=this._actions[i].length,e=0;e<t;++e){var n=this._actions[i][e];switch(n.type){case cu:if(this._keyboard){for(var r=n.keys.length,s=0;s<r;s++)if(this._keyboard.wasPressed(n.keys[s]))return!0}break;case uu:if(this._mouse&&this._mouse.wasPressed(n.button))return!0;break;case hu:if(this._gamepads&&this._gamepads.wasPressed(n.pad,n.button))return!0}}return!1},a.getAxis=function(i){var t=0;if(this._axes[i])for(var e=this._axes[i].length,n=0;n<e;n++)if(typeof this._axes[i][n]=="function"){var r=this._axes[i][n]();Math.abs(r)>Math.abs(t)&&(t=r)}else this._axesValues[i]&&Math.abs(this._axesValues[i][n])>Math.abs(t)&&(t=this._axesValues[i][n]);return t},a._enableMouse=function(){if(this._mouse=new yi,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)},a._enableKeyboard=function(){if(this._keyboard=new pu,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)},o}();function bv(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function Tv(o){return function(){var a=this,i=arguments;return new Promise(function(t,e){var n=o.apply(a,i);function r(l){bv(n,t,e,r,s,"next",l)}function s(l){bv(n,t,e,r,s,"throw",l)}r(void 0)})}}function Ev(o,a,i){return a&&function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}function wv(o,a){return(wv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Av(o,a){var i,t,e,n={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]},r=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return r.next=s(0),r.throw=s(1),r.return=s(2),typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function s(l){return function(u){var c=[l,u];if(i)throw TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(n=0)),n;)try{if(i=1,t&&(e=2&c[0]?t.return:c[0]?t.throw||((e=t.return)&&e.call(t),0):t.next)&&!(e=e.call(t,c[1])).done)return e;switch(t=0,e&&(c=[2&c[0],e.value]),c[0]){case 0:case 1:e=c;break;case 4:return n.label++,{value:c[1],done:!1};case 5:n.label++,t=c[1],c=[0];continue;case 7:c=n.ops.pop(),n.trys.pop();continue;default:if(!(e=(e=n.trys).length>0&&e[e.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!e||c[1]>e[0]&&c[1]<e[3])){n.label=c[1];break}if(c[0]===6&&n.label<e[1]){n.label=e[1],e=c;break}if(e&&n.label<e[2]){n.label=e[2],n.ops.push(c);break}e[2]&&n.ops.pop(),n.trys.pop();continue}c=a.call(o,n)}catch(h){c=[6,h],t=0}finally{i=e=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var Cv=Object.freeze([]),Sf=function(){return Cv};typeof navigator<"u"&&(Sf=(navigator.getGamepads||navigator.webkitGetGamepads||Sf).bind(navigator));var Pv={PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,XRPAD_TRIGGER:0,XRPAD_SQUEEZE:1,XRPAD_TOUCHPAD_BUTTON:2,XRPAD_STICK_BUTTON:3,XRPAD_A:4,XRPAD_B:5},J1={PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,XRPAD_TOUCHPAD_X:0,XRPAD_TOUCHPAD_Y:1,XRPAD_STICK_X:2,XRPAD_STICK_Y:3},xo={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},Iv={"Product: 0268":"PS3"},mu={};function Lv(o){var a=mu[o.id];if(a)return a;for(var i in Iv)if(o.id.indexOf(i)!==-1){var t=Iv[i];if(!o.mapping){var e=xo["RAW_"+t];if(e)return e}return xo[t]}if(o.mapping==="xr-standard")return xo.DEFAULT_XR;var n=xo.DEFAULT,r=o.buttons.length<n.buttons.length?xo.DEFAULT_DUAL:n;return r.mapping=o.mapping,r}var xf=.25,bf=function(){function o(a,i){var t,e;this.value=0,this.pressed=!1,this.touched=!1,this.wasPressed=!1,this.wasReleased=!1,this.wasTouched=!1,typeof a=="number"?(this.value=a,this.pressed=a===1,this.touched=a>0):(this.value=a.value,this.pressed=a.pressed,this.touched=(t=a.touched)!=null?t:a.value>0),i&&(typeof i=="number"?(this.wasPressed=i!==1&&this.pressed,this.wasReleased=i===1&&!this.pressed,this.wasTouched=i===0&&this.touched):(this.wasPressed=!i.pressed&&this.pressed,this.wasReleased=i.pressed&&!this.pressed,this.wasTouched=!((e=i.touched)!=null?e:i.value>0)&&this.touched))}return o.prototype.update=function(a){var i,t=a.value,e=a.pressed,n=(i=a.touched)!=null?i:t>0;this.wasPressed=!this.pressed&&e,this.wasReleased=this.pressed&&!e,this.wasTouched=!this.touched&&n,this.value=t,this.pressed=e,this.touched=n},o}(),Tf=Object.freeze(new bf(0)),Dv=function(){function o(i,t){this._compiledMapping={buttons:[],axes:[]},this.id=i.id,this.index=i.index,this._buttons=i.buttons.map(function(e){return new bf(e)}),this._axes=[].concat(i.axes),this._previousAxes=[].concat(i.axes),this.mapping=t.mapping,this.map=t,this.hand=i.hand||"none",this.pad=i,this._compileMapping()}var a=o.prototype;return a._compileMapping=function(){var i=this,t=this._compiledMapping,e=t.axes,n=t.buttons;e.length=0,n.length=0,this.map.axes&&this.map.axes.forEach(function(f,d){e[J1[f]]=function(){return i.pad.axes[d]||0}});for(var r=0,s=e.length;r<s;r++)e[r]||(e[r]=function(){return 0});var l=this.map.buttons;l&&l.forEach(function(f,d){n[Pv[f]]=function(){return i._buttons[d]||Tf}});var u=this.map.synthesizedButtons;u&&Object.entries(u).forEach(function(f){var d=f[1],p=d.axis,_=d.max,g=d.min;n[Pv[f[0]]]=function(){var y,v;return new bf(Math.abs(U.clamp((y=i._axes[p])!=null?y:0,g,_)),Math.abs(U.clamp((v=i._previousAxes[p])!=null?v:0,g,_)))}});for(var c=0,h=n.length;c<h;c++)n[c]||(n[c]=function(){return Tf})},a.update=function(i){this.pad=i;var t=this._previousAxes,e=this._axes;t.length=0,t.push.apply(t,[].concat(e)),e.length=0,e.push.apply(e,[].concat(i.axes));for(var n=this._buttons,r=0,s=n.length;r<s;r++)n[r].update(i.buttons[r]);return this},a.updateMap=function(i){i.mapping="custom",mu[this.id]=i,this.map=i,this.mapping="custom",this._compileMapping()},a.resetMap=function(){if(mu[this.id]){delete mu[this.id];var i=Lv(this.pad);this.map=i,this.mapping=i.mapping,this._compileMapping()}},a.pulse=function(i,t,e){var n=this;return Tv(function(){var r,s,l,u,c,h,f;return Av(this,function(d){switch(d.label){case 0:return(r=n.pad.vibrationActuator?[n.pad.vibrationActuator]:n.pad.hapticActuators||Cv).length?(l=(s=e==null?void 0:e.startDelay)!=null?s:0,c=(u=e==null?void 0:e.strongMagnitude)!=null?u:i,f=(h=e==null?void 0:e.weakMagnitude)!=null?h:i,[4,Promise.all(r.map(Tv(function(p){return Av(this,function(_){switch(_.label){case 0:return p?p.playEffect?[2,p.playEffect(p.type,{duration:t,startDelay:l,strongMagnitude:c,weakMagnitude:f})]:[3,1]:[2,!0];case 1:return p.pulse?[4,new Promise(function(g){setTimeout(g,l)})]:[3,3];case 2:return _.sent(),[2,p.pulse(i,t)];case 3:return[2,!1]}})})))]):[3,2];case 1:return[2,d.sent().some(function(p){return p===!0||p==="complete"})];case 2:return[2,!1]}})})()},a.getButton=function(i){var t=this._compiledMapping.buttons[i];return t?t():Tf},a.isPressed=function(i){return this.getButton(i).pressed},a.wasPressed=function(i){return this.getButton(i).wasPressed},a.wasReleased=function(i){return this.getButton(i).wasReleased},a.isTouched=function(i){return this.getButton(i).touched},a.wasTouched=function(i){return this.getButton(i).wasTouched},a.getValue=function(i){return this.getButton(i).value},a.getAxis=function(i){var t=this.axes[i];return t&&Math.abs(t)>xf?t:0},Ev(o,[{key:"connected",get:function(){return this.pad.connected}},{key:"axes",get:function(){return this._compiledMapping.axes.map(function(i){return i()})}},{key:"buttons",get:function(){return this._compiledMapping.buttons.map(function(i){return i()})}}]),o}(),Ef=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return(t=o.call(this)||this).gamepadsSupported=fe.gamepads,t.current=[],t._previous=[],t._ongamepadconnectedHandler=t._ongamepadconnected.bind(t),t._ongamepaddisconnectedHandler=t._ongamepaddisconnected.bind(t),window.addEventListener("gamepadconnected",t._ongamepadconnectedHandler,!1),window.addEventListener("gamepaddisconnected",t._ongamepaddisconnectedHandler,!1),t.poll(),t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&wv(a,o);var i=a.prototype;return i._ongamepadconnected=function(t){for(var e=new Dv(t.gamepad,this.getMap(t.gamepad)),n=this.current,r=n.findIndex(function(s){return s.index===e.index});r!==-1;)n.splice(r,1),r=n.findIndex(function(s){return s.index===e.index});n.push(e),this.fire("gamepadconnected",e)},i._ongamepaddisconnected=function(t){var e=this.current,n=e.findIndex(function(r){return r.index===t.gamepad.index});n!==-1&&(this.fire("gamepaddisconnected",e[n]),e.splice(n,1))},i.update=function(){this.poll()},i.poll=function(t){t===void 0&&(t=[]),t.length>0&&(t.length=0);for(var e=Sf(),n=0,r=e.length;n<r;n++)if(e[n]){var s=this.findByIndex(e[n].index);if(s)t.push(s.update(e[n]));else{var l=new Dv(e[n],this.getMap(e[n]));this.current.push(l),t.push(l)}}return t},i.destroy=function(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1)},i.getMap=function(t){return Lv(t)},i.isPressed=function(t,e){var n;return((n=this.current[t])==null?void 0:n.isPressed(e))||!1},i.wasPressed=function(t,e){var n;return((n=this.current[t])==null?void 0:n.wasPressed(e))||!1},i.wasReleased=function(t,e){var n;return((n=this.current[t])==null?void 0:n.wasReleased(e))||!1},i.getAxis=function(t,e){var n;return((n=this.current[t])==null?void 0:n.getAxis(e))||0},i.pulse=function(t,e,n,r){var s=this.current[t];return s?s.pulse(e,n,r):Promise.resolve(!1)},i.pulseAll=function(t,e,n){return Promise.all(this.current.map(function(r){return r.pulse(t,e,n)}))},i.findById=function(t){return this.current.find(function(e){return e&&e.id===t})||null},i.findByIndex=function(t){return this.current.find(function(e){return e&&e.index===t})||null},Ev(a,[{key:"deadZone",get:function(){return xf},set:function(t){xf=t}},{key:"previous",get:function(){for(var t=this.current,e=0,n=t.length;e<n;e++){var r=t[e]._buttons;this._previous[e]||(this._previous[e]=[]);for(var s=0,l=r.length;s<l;s++){var u=r[e];this.previous[e][s]=!!u&&(!u.wasPressed&&u.pressed||u.wasReleased)}}return this._previous.length=this.current.length,this._previous}}]),a}(se);function bo(o){for(var a,i,t=0,e=0,n=o.target;a=n,((i=HTMLElement)!=null&&typeof Symbol<"u"&&i[Symbol.hasInstance]?!i[Symbol.hasInstance](a):!Q(a,i))&&n;)n=n.parentNode;for(;n;)t+=n.offsetLeft-n.scrollLeft,e+=n.offsetTop-n.scrollTop,n=n.offsetParent;return{x:o.pageX-t,y:o.pageY-e}}Ef.EVENT_GAMEPADCONNECTED="gamepadconnected",Ef.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";var wf=function(o){var a=bo(o);this.id=o.identifier,this.x=a.x,this.y=a.y,this.target=o.target,this.touch=o},To=function(){function o(a,i){this.touches=[],this.changedTouches=[],this.element=i.target,this.event=i,this.touches=Array.from(i.touches).map(function(t){return new wf(t)}),this.changedTouches=Array.from(i.changedTouches).map(function(t){return new wf(t)})}return o.prototype.getTouchById=function(a,i){return i.find(function(t){return t.id===a})||null},o}();function Mv(o,a){return(Mv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Eo=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this)._element=null,e._startHandler=e._handleTouchStart.bind(e),e._endHandler=e._handleTouchEnd.bind(e),e._moveHandler=e._handleTouchMove.bind(e),e._cancelHandler=e._handleTouchCancel.bind(e),e.attach(t),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Mv(a,o);var i=a.prototype;return i.attach=function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},i.detach=function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},i._handleTouchStart=function(t){this.fire("touchstart",new To(this,t))},i._handleTouchEnd=function(t){this.fire("touchend",new To(this,t))},i._handleTouchMove=function(t){t.preventDefault(),this.fire("touchmove",new To(this,t))},i._handleTouchCancel=function(t){this.fire("touchcancel",new To(this,t))},a}(se);function Af(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}Eo.EVENT_TOUCHSTART="touchstart",Eo.EVENT_TOUCHEND="touchend",Eo.EVENT_TOUCHMOVE="touchmove",Eo.EVENT_TOUCHCANCEL="touchcancel";var Tt=function(){function o(){}var a=o.prototype;return a.get=function(i,t,e){return typeof t=="function"&&(e=t,t={}),this.request("GET",i,t,e)},a.post=function(i,t,e,n){return typeof e=="function"&&(n=e,e={}),e.postdata=t,this.request("POST",i,e,n)},a.put=function(i,t,e,n){return typeof e=="function"&&(n=e,e={}),e.postdata=t,this.request("PUT",i,e,n)},a.del=function(i,t,e){return typeof t=="function"&&(e=t,t={}),this.request("DELETE",i,t,e)},a.request=function(i,t,e,n){var r,s,l,u=this,c=!1;if(typeof e=="function"&&(n=e,e={}),e.retry&&(e=Object.assign({retries:0,maxRetries:5},e)),e.callback=n,e.async==null&&(e.async=!0),e.headers==null&&(e.headers={}),e.postdata!=null)if(Af(e.postdata,Document))l=e.postdata;else if(Af(e.postdata,FormData))l=e.postdata;else if(Af(e.postdata,Object)){var h=e.headers["Content-Type"];switch(h===void 0&&(e.headers["Content-Type"]=o.ContentType.FORM_URLENCODED,h=e.headers["Content-Type"]),h){case o.ContentType.FORM_URLENCODED:l="";var f=!0;for(var d in e.postdata)e.postdata.hasOwnProperty(d)&&(f?f=!1:l+="&",l+=encodeURIComponent(d)+"="+encodeURIComponent(e.postdata[d]));break;default:case o.ContentType.JSON:h==null&&(e.headers["Content-Type"]=o.ContentType.JSON),l=JSON.stringify(e.postdata)}}else l=e.postdata;if(e.cache===!1){var p=un();(r=new Hl(t)).query?r.query=r.query+"&ts="+p:r.query="ts="+p,t=r.toString()}e.query&&(s=Ka((r=new Hl(t)).getQuery(),e.query),r.setQuery(s),t=r.toString());var _=new XMLHttpRequest;for(var g in _.open(i,t,e.async),_.withCredentials=e.withCredentials!==void 0&&e.withCredentials,_.responseType=e.responseType||this._guessResponseType(t),e.headers)e.headers.hasOwnProperty(g)&&_.setRequestHeader(g,e.headers[g]);_.onreadystatechange=function(){u._onReadyStateChange(i,t,e,_)},_.onerror=function(){u._onError(i,t,e,_),c=!0};try{_.send(l)}catch(y){c||e.error(_.status,_,y)}return _},a._guessResponseType=function(i){var t=new Hl(i),e=ce.getExtension(t.path).toLowerCase();return o.binaryExtensions.indexOf(e)>=0?o.ResponseType.ARRAY_BUFFER:e===".json"?o.ResponseType.JSON:e===".xml"?o.ResponseType.DOCUMENT:o.ResponseType.TEXT},a._isBinaryContentType=function(i){return[o.ContentType.BASIS,o.ContentType.BIN,o.ContentType.DDS,o.ContentType.GLB,o.ContentType.MP3,o.ContentType.MP4,o.ContentType.OGG,o.ContentType.OPUS,o.ContentType.WAV].indexOf(i)>=0},a._isBinaryResponseType=function(i){return i===o.ResponseType.ARRAY_BUFFER||i===o.ResponseType.BLOB||i===o.ResponseType.JSON},a._onReadyStateChange=function(i,t,e,n){if(n.readyState===4)switch(n.status){case 0:n.responseURL&&n.responseURL.startsWith("file:///")?this._onSuccess(i,t,e,n):this._onError(i,t,e,n);break;case 200:case 201:case 206:case 304:this._onSuccess(i,t,e,n);break;default:this._onError(i,t,e,n)}},a._onSuccess=function(i,t,e,n){var r,s,l=n.getResponseHeader("Content-Type");l&&(s=l.split(";")[0].trim());try{r=this._isBinaryContentType(s)||this._isBinaryResponseType(n.responseType)?n.response:s===o.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(n.responseText):n.responseType===o.ResponseType.DOCUMENT||s===o.ContentType.XML?n.responseXML:n.responseText,e.callback(null,r)}catch(u){e.callback(u)}},a._onError=function(i,t,e,n){var r=this;e.retrying||(e.retry&&e.retries<e.maxRetries?(e.retries++,e.retrying=!0,setTimeout(function(){e.retrying=!1,r.request(i,t,e,e.callback)},U.clamp(Math.pow(2,e.retries)*o.retryDelay,0,e.maxRetryDelay||5e3))):e.callback(n.status===0?"Network error":n.status,null))},o}();Tt.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},Tt.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Tt.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],Tt.retryDelay=100;var Fe=new Tt;function Si(){return typeof AudioContext<"u"||typeof webkitAudioContext<"u"}var _u=function(){function o(i,t,e){if(e===void 0&&(e={}),this.volume=(n=e.volume)!=null?n:1,this.loop=(r=e.loop)!=null&&r,this.pitch=(s=e.pitch)!=null?s:1,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=i,this.source=null,Si()){this.startTime=0,this.startOffset=0;var n,r,s,l=i.context;this.gain=l.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}var a=o.prototype;return a.getVolume=function(){return this.volume},a.getLoop=function(){return this.loop},a.setLoop=function(i){this.loop=i,this.source&&(this.source.loop=i)},a.getPitch=function(){return this.pitch},a.onManagerVolumeChange=function(){this.setVolume(this.getVolume())},a.onManagerSuspend=function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},a.onManagerResume=function(){this.suspended&&(this.suspended=!1,this.unpause())},a.play=function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())},a.pause=function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},a.unpause=function(){!this.source&&this.paused&&(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},a.stop=function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},a.setVolume=function(i){i=U.clamp(i,0,1),this.volume=i,this.gain&&(this.gain.gain.value=i*this.manager.volume)},a.setPitch=function(i){this.pitch=i,this.source&&(this.source.playbackRate.value=i)},a.isPlaying=function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},a.getDuration=function(){return this.source?this.source.buffer.duration:0},a._createSource=function(){var i=this.manager.context;this.sound.buffer&&(this.source=i.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(i.destination),this.loop||(this.source.onended=this.pause.bind(this)))},o}();function Rv(o,a){return(Rv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Si()||Object.assign(_u.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(o){o=U.clamp(o,0,1),this.volume=o,this.source&&(this.source.volume=o*this.manager.volume)},setPitch:function(o){this.pitch=o,this.source&&(this.source.playbackRate=o)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});var Cf=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){var r;return(r=o.call(this,t,e,n)||this).position=new E,r.velocity=new E,Si()?r.panner=t.context.createPanner():(r.maxDistance=1e4,r.minDistance=1,r.rollOffFactor=1,r.distanceModel=Kl),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Rv(a,o);var i=a.prototype;return i.getPosition=function(){return this.position},i.setPosition=function(t){this.position.copy(t);var e=this.panner;"positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z)},i.getVelocity=function(){return this.velocity},i.setVelocity=function(t){this.velocity.copy(t)},i.getMaxDistance=function(){return this.panner.maxDistance},i.setMaxDistance=function(t){this.panner.maxDistance=t},i.getMinDistance=function(){return this.panner.refDistance},i.setMinDistance=function(t){this.panner.refDistance=t},i.getRollOffFactor=function(){return this.panner.rolloffFactor},i.setRollOffFactor=function(t){this.panner.rolloffFactor=t},i.getDistanceModel=function(){return this.panner.distanceModel},i.setDistanceModel=function(t){this.panner.distanceModel=t},i._createSource=function(){var t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))},a}(_u);if(!Si()){var Ov=new E,$1=function(o,a,i,t,e,n){var r=(Ov=Ov.sub2(o,a)).length();if(r<i)return 1;if(r>t)return 0;var s=0;return n===no?s=1-e*(r-i)/(t-i):n===Kl?s=i/(i+e*(r-i)):n===Gh&&(s=Math.pow(r/i,-e)),U.clamp(s,0,1)};Object.assign(Cf.prototype,{setPosition:function(o){if(this.position.copy(o),this.source){var a=$1(this.manager.listener.getPosition(),this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*a}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(o){this.maxDistance=o},getMinDistance:function(){return this.minDistance},setMinDistance:function(o){this.minDistance=o},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(o){this.rollOffFactor=o},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(o){this.distanceModel=o}})}var e2=function(){function o(t){this.position=new E,this.orientation=new X,this._manager=t}var a,i=o.prototype;return i.getPosition=function(){return this.position},i.setPosition=function(t){this.position.copy(t);var e=this.listener;e&&("positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z))},i.setOrientation=function(t){this.orientation.copy(t);var e=this.listener;if(e){var n=t.data;"forwardX"in e?(e.forwardX.value=-n[8],e.forwardY.value=-n[9],e.forwardZ.value=-n[10],e.upX.value=n[4],e.upY.value=n[5],e.upZ.value=n[6]):e.setOrientation&&e.setOrientation(-n[8],-n[9],-n[10],n[4],n[5],n[6])}},i.getOrientation=function(){return this.orientation},a=[{key:"listener",get:function(){var t=this._manager.context;return t?t.listener:null}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function kv(o,a){return(kv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var vu="running",Nv=["click","touchstart","mousedown"],Fv=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return(e=o.call(this)||this)._context=null,e.AudioContext=typeof AudioContext<"u"&&AudioContext||typeof webkitAudioContext<"u"&&webkitAudioContext,e.AudioContext,e._unlockHandlerFunc=e._unlockHandler.bind(e),e._userSuspended=!1,e.listener=new e2(e),e._volume=1,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&kv(a,o);var i,t=a.prototype;return t.suspend=function(){!this._userSuspended&&(this._userSuspended=!0,this._context&&this._context.state===vu&&this._suspend())},t.resume=function(){this._userSuspended&&(this._userSuspended=!1,this._context&&this._context.state!==vu&&this._resume())},t.destroy=function(){if(this.fire("destroy"),this._context){var e;this._removeUnlockListeners(),(e=this._context)==null||e.close(),this._context=null}},t.playSound=function(e,n){n===void 0&&(n={});var r=null;return _u&&(r=new _u(this,e,n)).play(),r},t.playSound3d=function(e,n,r){r===void 0&&(r={});var s=null;return Cf&&((s=new Cf(this,e,r)).setPosition(n),r.volume&&s.setVolume(r.volume),r.loop&&s.setLoop(r.loop),r.maxDistance&&s.setMaxDistance(r.maxDistance),r.minDistance&&s.setMinDistance(r.minDistance),r.rollOffFactor&&s.setRollOffFactor(r.rollOffFactor),r.distanceModel&&s.setDistanceModel(r.distanceModel),s.play()),s},t._resume=function(){var e=this;this._context.resume().then(function(){var n=e._context.createBufferSource();n.buffer=e._context.createBuffer(1,1,e._context.sampleRate),n.connect(e._context.destination),n.start(0),n.onended=function(r){n.disconnect(0),e.fire("resume")}},function(n){}).catch(function(n){})},t._suspend=function(){var e=this;this._context.suspend().then(function(){e.fire("suspend")},function(n){}).catch(function(n){})},t._unlockHandler=function(){this._removeUnlockListeners(),this._userSuspended||this._context.state===vu||this._resume()},t._registerUnlockListeners=function(){var e=this;Nv.forEach(function(n){window.addEventListener(n,e._unlockHandlerFunc,!1)})},t._removeUnlockListeners=function(){var e=this;Nv.forEach(function(n){window.removeEventListener(n,e._unlockHandlerFunc,!1)})},i=[{key:"volume",get:function(){return this._volume},set:function(e){e=U.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}},{key:"suspended",get:function(){return this._userSuspended}},{key:"context",get:function(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==vu&&this._registerUnlockListeners()),this._context}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se),Uv=function(){var o;function a(i){var t;((t=Audio)!=null&&typeof Symbol<"u"&&t[Symbol.hasInstance]?t[Symbol.hasInstance](i):Q(i,t))?this.audio=i:this.buffer=i}return o=[{key:"duration",get:function(){var i=0;return this.buffer?i=this.buffer.duration:this.audio&&(i=this.audio.duration),i||0}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function Bv(o,a){return(Bv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Yt=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r){var s;return(s=o.call(this)||this).source=null,s._manager=e,s._volume=r.volume!==void 0?U.clamp(Number(r.volume)||0,0,1):1,s._pitch=r.pitch!==void 0?Math.max(.01,Number(r.pitch)||0):1,s._loop=!!(r.loop!==void 0&&r.loop),s._sound=n,s._state=2,s._suspended=!1,s._suspendEndEvent=0,s._suspendInstanceEvents=!1,s._playWhenLoaded=!0,s._startTime=Math.max(0,Number(r.startTime)||0),s._duration=Math.max(0,Number(r.duration)||0),s._startOffset=null,s._onPlayCallback=r.onPlay,s._onPauseCallback=r.onPause,s._onResumeCallback=r.onResume,s._onStopCallback=r.onStop,s._onEndCallback=r.onEnd,Si()?(s._startedAt=0,s._currentTime=0,s._currentOffset=0,s._inputNode=null,s._connectorNode=null,s._firstNode=null,s._lastNode=null,s._waitingContextSuspension=!1,s._initializeNodes(),s._endedHandler=s._onEnded.bind(s)):(s._isReady=!1,s._loadedMetadataHandler=s._onLoadedMetadata.bind(s),s._timeUpdateHandler=s._onTimeUpdate.bind(s),s._endedHandler=s._onEnded.bind(s),s._createSource()),s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Bv(a,o);var i,t=a.prototype;return t._onPlay=function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},t._onPause=function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},t._onResume=function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},t._onStop=function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},t._onEnded=function(){if(this._suspendEndEvent>0)return void this._suspendEndEvent--;this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()},t._onManagerVolumeChange=function(){this.volume=this._volume},t._onManagerSuspend=function(){this._state!==0||this._suspended||(this._suspended=!0,this.pause())},t._onManagerResume=function(){this._suspended&&(this._suspended=!1,this.resume())},t._initializeNodes=function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},t.play=function(){return this._state!==2&&this.stop(),this._state=0,this._playWhenLoaded=!1,!this._waitingContextSuspension&&(this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0))},t._playAudioImmediate=function(){if(this._waitingContextSuspension=!1,this._state===0){this.source||this._createSource();var e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}},t.pause=function(){return this._playWhenLoaded=!1,this._state===0&&(this._state=1,!!this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0))},t.resume=function(){if(this._state!==1)return!1;var e=this.currentTime;return this._state=0,!!this._waitingContextSuspension||(this.source||this._createSource(),this._startOffset!==null&&(e=this._startOffset%this.duration||0,e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0)},t.stop=function(){if(this._playWhenLoaded=!1,this._state===2)return!1;var e=this._state===0;return this._state=2,!!this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop(),!0)},t.setExternalNodes=function(e,n){if(e){n||(n=e);var r=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(r),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==n&&(this._lastNode&&this._lastNode.disconnect(r),this._lastNode=n,this._lastNode.connect(r))}},t.clearExternalNodes=function(){var e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)},t.getExternalNodes=function(){return[this._firstNode,this._lastNode]},t._createSource=function(){if(!this._sound)return null;var e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0))),this.source},t._updateCurrentTime=function(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},t._onManagerDestroy=function(){this.source&&this._state===0&&(this.source.stop(0),this.source=null)},i=[{key:"currentTime",get:function(){return this._startOffset!==null?this._startOffset:this._state===1?this._currentTime:this._state!==2&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(e){if(!(e<0))if(this._state===0){var n=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=n}else this._startOffset=e,this._currentTime=e}},{key:"duration",get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(e){this._duration=Math.max(0,Number(e)||0);var n=this._state===0;this.stop(),n&&this.play()}},{key:"isPaused",get:function(){return this._state===1}},{key:"isPlaying",get:function(){return this._state===0}},{key:"isStopped",get:function(){return this._state===2}},{key:"isSuspended",get:function(){return this._suspended}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}},{key:"pitch",get:function(){return this._pitch},set:function(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}},{key:"sound",get:function(){return this._sound},set:function(e){this._sound=e,this._state!==2?this.stop():this._createSource()}},{key:"startTime",get:function(){return this._startTime},set:function(e){this._startTime=Math.max(0,Number(e)||0);var n=this._state===0;this.stop(),n&&this.play()}},{key:"volume",get:function(){return this._volume},set:function(e){e=U.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Vv(o,a){return(Vv=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Yt.EVENT_PLAY="play",Yt.EVENT_PAUSE="pause",Yt.EVENT_RESUME="resume",Yt.EVENT_STOP="stop",Yt.EVENT_END="end",Si()||(Object.assign(Yt.prototype,{play:function(){return this._state!==2&&this.stop(),(!!this.source||!!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!!this.source&&this._state===0&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!!this.source&&this._state===1&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!!this.source&&this._state!==2&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var o=this._startOffset%this.duration||0;o=(this._startTime+o)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=o},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(Yt.prototype,"volume",{get:function(){return this._volume},set:function(o){o=U.clamp(o,0,1),this._volume=o,this.source&&(this.source.volume=o*this._manager.volume)}}),Object.defineProperty(Yt.prototype,"pitch",{get:function(){return this._pitch},set:function(o){this._pitch=Math.max(Number(o)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(Yt.prototype,"sound",{get:function(){return this._sound},set:function(o){this.stop(),this._sound=o}}),Object.defineProperty(Yt.prototype,"currentTime",{get:function(){return this._startOffset!==null?this._startOffset:this._state!==2&&this.source?this.source.currentTime-this._startTime:0},set:function(o){!(o<0)&&(this._startOffset=o,this.source&&this._isReady)&&(this.source.currentTime=(this._startTime+(o%this.duration||0))%this._sound.duration||0,this._startOffset=null)}}));var zr=function(o){var a;if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function i(t,e,n){var r;return n===void 0&&(n={}),(r=o.call(this,t,e,n)||this)._position=new E,r._velocity=new E,n.position&&(r.position=n.position),r.maxDistance=n.maxDistance!==void 0?Number(n.maxDistance):1e4,r.refDistance=n.refDistance!==void 0?Number(n.refDistance):1,r.rollOffFactor=n.rollOffFactor!==void 0?Number(n.rollOffFactor):1,r.distanceModel=n.distanceModel!==void 0?n.distanceModel:no,r}return i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),o&&Vv(i,o),i.prototype._initializeNodes=function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},a=[{key:"position",get:function(){return this._position},set:function(t){this._position.copy(t);var e=this.panner;"positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z)}},{key:"velocity",get:function(){return this._velocity},set:function(t){this._velocity.copy(t)}},{key:"maxDistance",get:function(){return this.panner.maxDistance},set:function(t){this.panner.maxDistance=t}},{key:"refDistance",get:function(){return this.panner.refDistance},set:function(t){this.panner.refDistance=t}},{key:"rollOffFactor",get:function(){return this.panner.rolloffFactor},set:function(t){this.panner.rolloffFactor=t}},{key:"distanceModel",get:function(){return this.panner.distanceModel},set:function(t){this.panner.distanceModel=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(i.prototype,a),i}(Yt);if(!Si()){var zv=new E,t2=function(o,a,i,t,e,n){var r=(zv=zv.sub2(o,a)).length();if(r<i)return 1;if(r>t)return 0;var s=0;return n===no?s=1-e*(r-i)/(t-i):n===Kl?s=i/(i+e*(r-i)):n===Gh&&(s=Math.pow(r/i,-e)),U.clamp(s,0,1)};Object.defineProperty(zr.prototype,"position",{get:function(){return this._position},set:function(o){if(this._position.copy(o),this.source){var a=t2(this._manager.listener.getPosition(),this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*a*this._manager.volume}}}),Object.defineProperty(zr.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(o){this._maxDistance=o}}),Object.defineProperty(zr.prototype,"refDistance",{get:function(){return this._refDistance},set:function(o){this._refDistance=o}}),Object.defineProperty(zr.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(o){this._rollOffFactor=o}}),Object.defineProperty(zr.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(o){this._distanceModel=o}})}var Pf=((ln={})[0]="SUBTRACTIVE",ln[1]="ADDITIVE",ln[2]="NORMAL",ln[3]="NONE",ln[4]="PREMULTIPLIED",ln[5]="MULTIPLICATIVE",ln[6]="ADDITIVEALPHA",ln[7]="MULTIPLICATIVE2X",ln[8]="SCREEN",ln[9]="MIN",ln[10]="MAX",ln),Gr="none",Gv="linear",Hv=((Th={})[0]="NONE",Th[2]="SCHLICK",Th),If=((Fl={})[0]="DIRECTIONAL",Fl[1]="OMNI",Fl[2]="SPOT",Fl),Wv=((Xa={})[0]="PUNCTUAL",Xa[1]="RECT",Xa[2]="DISK",Xa[3]="SPHERE",Xa),jv=((Eh={})[0]="LINEAR",Eh[1]="INVERSESQUARED",Eh),qn=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:16,pcf:!0}],[0,{name:"PCF3_32F",kind:"PCF3",format:16,pcf:!0}],[4,{name:"PCF5_32F",kind:"PCF5",format:16,pcf:!0}],[7,{name:"PCF1_16F",kind:"PCF1",format:69,pcf:!0}],[8,{name:"PCF3_16F",kind:"PCF3",format:69,pcf:!0}],[9,{name:"PCF5_16F",kind:"PCF5",format:69,pcf:!0}],[2,{name:"VSM_16F",kind:"VSM",format:12,vsm:!0}],[3,{name:"VSM_32F",kind:"VSM",format:14,vsm:!0}],[6,{name:"PCSS_32F",kind:"PCSS",format:15,pcss:!0}]]),Xv=((wh={})[0]="NONE",wh[1]="BOX",wh),Lf=((Ah={})[0]="NONE",Ah[1]="SRGB",Ah),gu=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],Yv=((Ul={})[0]="NONE",Ul[1]="AO",Ul[2]="GLOSSDEPENDENT",Ul),xi="none",wo="envAtlas",Ao="envAtlasHQ",Co="cubeMap",Df="sphereMap",qv=((As={})[xi]="NONE",As[wo]="ENVATLAS",As[Ao]="ENVATLASHQ",As[Co]="CUBEMAP",As[Df]="SPHEREMAP",As),yu="ambientSH",Su="envAtlas",xu="constant",Kv=((Bl={})[yu]="AMBIENTSH",Bl[Su]="ENVALATLAS",Bl[xu]="CONSTANT",Bl),Zv=((Vl={})[0]="SIMPLE",Vl[1]="SLICED",Vl[2]="TILED",Vl),Po="infinite",Qv="dome",Kn="none",Jv="bayer8",$v="bluenoise",eg="ignnoise",tg=((Ya={})[Kn]="NONE",Ya[Jv]="BAYER8",Ya[$v]="BLUENOISE",Ya[eg]="IGNNOISE",Ya),ng="prerender",ig="postrender",rg="prerender:layer",sg="postrender:layer",ag="precull",og="postcull",Io=function(){function o(i,t,e){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=i,this.bindGroupFormats[0]=t,this.vertexFormat=e}var a=o.prototype;return a.hasUniform=function(i){for(var t=0;t<this.uniformFormats.length;t++){var e=this.uniformFormats[t];if(e!=null&&e.get(i))return!0}return!1},a.hasTexture=function(i){for(var t=0;t<this.bindGroupFormats.length;t++){var e=this.bindGroupFormats[t];if(e!=null&&e.getTexture(i))return!0}return!1},a.getVertexElement=function(i){var t;return(t=this.vertexFormat)==null?void 0:t.elements.find(function(e){return e.name===i})},a.generateKey=function(i){var t,e=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return i.isWebGPU&&(e+=(t=this.vertexFormat)==null?void 0:t.shaderProcessingHashString),e},o}(),lg=new It;function sr(o){return lg.get(o)}var bi=function(){function o(){}return o.definesHash=function(a){return dn(JSON.stringify(Array.from(a).sort(function(i,t){return i[0]>t[0]?1:-1})))},o}(),n2=new It,i2=function(){function o(a,i,t){t===void 0&&(t={}),this.defines=new Map,this.name=a,this.index=i,Object.assign(this,t),this.buildShaderDefines()}return o.prototype.buildShaderDefines=function(){var a;this.isShadow?a="SHADOW":this.isForward?a="FORWARD":this.index===3&&(a="PICK"),this.defines.set(""+a+"_PASS",""),this.defines.set(""+this.name.toUpperCase()+"_PASS","")},o}(),Ti=function(){function o(){var i=this;this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;var t=function(e,n,r){i.allocate(e,r)};t("forward",0,{isForward:!0}),t("prepass"),t("shadow"),t("pick")}var a=o.prototype;return a.allocate=function(i,t){var e=this.passesNamed.get(i);return e===void 0&&(e=new i2(i,this.nextIndex,t),this.passesNamed.set(e.name,e),this.passesIndexed[e.index]=e,this.nextIndex++),e},a.getByIndex=function(i){return this.passesIndexed[i]},a.getByName=function(i){return this.passesNamed.get(i)},o.get=function(i){return n2.get(i,function(){return new o})},o}();function ug(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function cg(o,a,i){return(cg=dg()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var s=new(Function.bind.apply(t,r));return n&&bu(s,n.prototype),s}).apply(null,arguments)}function hg(o){return(hg=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)})(o)}function bu(o,a){return(bu=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function fg(o){var a=typeof Map=="function"?new Map:void 0;return(fg=function(i){if(i===null||Function.toString.call(i).indexOf("[native code]")===-1)return i;if(typeof i!="function")throw TypeError("Super expression must either be null or a function");if(a!==void 0){if(a.has(i))return a.get(i);a.set(i,t)}function t(){return cg(i,arguments,hg(this).constructor)}return t.prototype=Object.create(i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),bu(t,i)})(o)}function dg(){try{var o=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(dg=function(){return!!o})()}function pg(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return ug(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ug(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var mg=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._keyDirty=!1,e._key="",e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&bu(a,o);var i,t=a.prototype;return t.set=function(e,n){return this.has(e)&&this.get(e)===n||this.markDirty(),o.prototype.set.call(this,e,n)},t.add=function(e){for(var n,r=pg(Object.entries(e));!(n=r()).done;){var s=n.value,l=s[0],u=s[1];this.set(l,u)}return this},t.delete=function(e){var n=this.has(e),r=o.prototype.delete.call(this,e);return n&&r&&this.markDirty(),r},t.clear=function(){this.size>0&&this.markDirty(),o.prototype.clear.call(this)},t.markDirty=function(){this._dirty=!0,this._keyDirty=!0},t.isDirty=function(){return this._dirty},t.resetDirty=function(){this._dirty=!1},t.copy=function(e){this.clear();for(var n,r=pg(e);!(n=r()).done;){var s=n.value,l=s[0],u=s[1];this.set(l,u)}return this},i=[{key:"key",get:function(){return this._keyDirty&&(this._keyDirty=!1,this._key=Array.from(this.entries()).sort(function(e,n){var r=e[0],s=n[0];return r<s?-1:+(r>s)}).map(function(e){return e[0]+"="+dn(e[1])}).join(",")),this._key}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(fg(Map)),r2=new It,re=function(){function o(){this.glsl=new mg,this.wgsl=new mg,this.version=""}var a,i=o.prototype;return i.isDirty=function(){return this.glsl.isDirty()||this.wgsl.isDirty()},i.resetDirty=function(){this.glsl.resetDirty(),this.wgsl.resetDirty()},i.copy=function(t){return this.version=t.version,this.glsl.copy(t.glsl),this.wgsl.copy(t.wgsl),this},o.get=function(t,e){e===void 0&&(e=ue);var n=r2.get(t,function(){return new o});return e===ue?n.glsl:n.wgsl},a=[{key:"useWGSL",get:function(){return this.glsl.size===0||this.wgsl.size>0}},{key:"key",get:function(){return"GLSL:"+this.glsl.key+"|WGSL:"+this.wgsl.key+"|API:"+this.version}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function _g(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}var Lo=function(){function o(){}return o.merge=function(){for(var a=arguments.length,i=Array(a),t=0;t<a;t++)i[t]=arguments[t];for(var e=new Map((s=i[0])!=null?s:[]),n=1;n<i.length;n++){var r=i[n];if(r)for(var s,l,u=function(d,p){var _=typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(_)return(_=_.call(d)).next.bind(_);if(Array.isArray(d)||(_=function(y,v){if(y){if(typeof y=="string")return _g(y,void 0);var x=Object.prototype.toString.call(y).slice(8,-1);if(x==="Object"&&y.constructor&&(x=y.constructor.name),x==="Map"||x==="Set")return Array.from(x);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return _g(y,void 0)}}(d))){_&&(d=_);var g=0;return function(){return g>=d.length?{done:!0}:{done:!1,value:d[g++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(r);!(l=u()).done;){var c=l.value,h=c[0],f=c[1];e.set(h,f)}}return e},o}();function Mf(){return(Mf=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function vg(o,a){return(vg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var s2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this)||this).key=t,n.shaderDefinition=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&vg(a,o);var i=a.prototype;return i.generateKey=function(t){return this.key},i.createShaderDefinition=function(t,e){return this.shaderDefinition},a}(bi),Te=function(){function o(){}return o.createShader=function(a,i){var t=sr(a),e=t.getCachedShader(i.uniqueName);if(!e){var n=a.isWebGPU&&(!!i.vertexWGSL||!!i.vertexChunk)&&(!!i.fragmentWGSL||!!i.fragmentChunk),r=re.get(a,n?he:ue),s=i.vertexChunk?r.get(i.vertexChunk):n?i.vertexWGSL:i.vertexGLSL,l=i.fragmentChunk?r.get(i.fragmentChunk):n?i.fragmentWGSL:i.fragmentGLSL,u=Lo.merge(r,i.fragmentIncludes),c=Lo.merge(r,i.vertexIncludes);e=new rr(a,ir.createDefinition(a,{name:i.uniqueName,shaderLanguage:n?he:ue,attributes:i.attributes,vertexCode:s,fragmentCode:l,useTransformFeedback:i.useTransformFeedback,vertexIncludes:c,vertexDefines:i.vertexDefines,fragmentIncludes:u,fragmentDefines:i.fragmentDefines,fragmentOutputTypes:i.fragmentOutputTypes})),t.setCachedShader(i.uniqueName,e)}return e},o.getCoreDefines=function(a,i){var t=new Map(a.defines);return i.cameraShaderParams.defines.forEach(function(e,n){return t.set(n,e)}),Ti.get(i.device).getByIndex(i.pass).defines.forEach(function(e,n){return t.set(n,e)}),t},o.processShader=function(a,i){var t,e=a.definition,n=new s2(((t=e.name)!=null?t:"shader")+"-id-"+a.id,e),r="shader",s=sr(a.device);s.register(r,n);var l=s.getProgram(r,{},i);return s.unregister(r),l},o.addScreenDepthChunkDefines=function(a,i,t){i.sceneDepthMapLinear&&t.set("SCENE_DEPTHMAP_LINEAR",""),a.textureFloatRenderable&&t.set("SCENE_DEPTHMAP_FLOAT","")},o}(),a2={type:5,base:0,count:4,indexed:!1},Do=new q,Mo=new q,Rf=new tf,Ys=function(){function o(i){var t=i.device;if(this.shader=i,t.supportsUniformBuffers){var e=new Io;this.shader=Te.processShader(i,e);var n=this.shader.meshUniformBufferFormat;n&&(this.uniformBuffer=new So(t,n,!1));var r=this.shader.meshBindGroupFormat;this.bindGroup=new Fs(t,r)}}var a=o.prototype;return a.destroy=function(){var i,t;(i=this.uniformBuffer)==null||i.destroy(),this.uniformBuffer=null,(t=this.bindGroup)==null||t.destroy(),this.bindGroup=null},a.render=function(i,t){var e=this.shader.device;i&&(Do.set(e.vx,e.vy,e.vw,e.vh),Mo.set(e.sx,e.sy,e.sw,e.sh),t=t??i,e.setViewport(i.x,i.y,i.z,i.w),e.setScissor(t.x,t.y,t.z,t.w)),e.setVertexBuffer(e.quadVertexBuffer,0);var n=this.shader;if(e.setShader(n),e.supportsUniformBuffers){e.setBindGroup(0,e.emptyBindGroup);var r=this.bindGroup;r.update(),e.setBindGroup(1,r);var s=this.uniformBuffer;s?(s.update(Rf),e.setBindGroup(2,Rf.bindGroup,Rf.offsets)):e.setBindGroup(2,e.emptyBindGroup)}e.draw(a2),i&&(e.setViewport(Do.x,Do.y,Do.z,Do.w),e.setScissor(Mo.x,Mo.y,Mo.z,Mo.w))},o}();function gg(o,a){return(gg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var o2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e,n){var r;return(r=o.call(this,i)||this).quad=t,r.rect=e,r.scissorRect=n,r}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&gg(a,o),a.prototype.execute=function(){var i=this.device;i.setCullMode(0),i.setDepthState(Xe.NODEPTH),i.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)},a}(ct),l2=new q;function kt(o,a,i,t,e){var n=new Ys(i);t||((t=l2).x=0,t.y=0,t.z=a?a.width:o.width,t.w=a?a.height:o.height);var r=new o2(o,n,t,e);r.init(a),r.colorOps.clear=!1,r.depthStencilOps.clearDepth=!1,o.isWebGPU&&a===null&&o.samples>1&&(r.colorOps.store=!0),r.render(),n.destroy()}var Of=function(){function o(t,e,n){this._aabb=new Se,this.meshInstance=null,this.origMeshInstances=t,this.dynamic=e,this.batchGroupId=n}var a,i=o.prototype;return i.destroy=function(t,e){this.meshInstance&&(this.removeFromLayers(t,e),this.meshInstance.destroy(),this.meshInstance=null)},i.addToLayers=function(t,e){for(var n=0;n<e.length;n++){var r=t.layers.getLayerById(e[n]);r&&r.addMeshInstances([this.meshInstance])}},i.removeFromLayers=function(t,e){for(var n=0;n<e.length;n++){var r=t.layers.getLayerById(e[n]);r&&r.removeMeshInstances([this.meshInstance])}},i.updateBoundingBox=function(){this._aabb.copy(this.origMeshInstances[0].aabb);for(var t=1;t<this.origMeshInstances.length;t++)this._aabb.add(this.origMeshInstances[t].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0},a=[{key:"model",get:function(){}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),qe=function(o,a,i,t,e){e===void 0&&(e=[0]),this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=o,this.name=a,this.dynamic=i,this.maxAabbSize=t,this.layers=e};qe.MODEL="model",qe.ELEMENT="element",qe.SPRITE="sprite",qe.RENDER="render";var yg=new X,qs=function(){function o(t){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}var a,i=o.prototype;return i.init=function(t,e){var n=3*e,r=Math.ceil(Math.sqrt(n)),s=Math.ceil(n/(r=U.roundUp(r,3)));this.boneTexture=new ee(t,{width:r,height:s,format:14,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()},i.destroy=function(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)},i.resolve=function(t,e){this.rootBone=t;for(var n=this.skin,r=[],s=0;s<n.boneNames.length;s++){var l=n.boneNames[s],u=t.findByName(l);u||(u=e),r.push(u)}this.bones=r},i.initSkin=function(t){this.skin=t,this.bones=[];var e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(var n=0;n<e;n++)this.matrices[n]=new X},i.uploadBones=function(t){this.boneTexture.upload()},i._updateMatrices=function(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,yg.copy(t.getWorldTransform()).invert();for(var n=this.bones.length-1;n>=0;n--)this.matrices[n].mulAffine2(yg,this.bones[n].getWorldTransform()),this.matrices[n].mulAffine2(this.matrices[n],this.skin.inverseBindPose[n])}},i.updateMatrices=function(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)},i.updateMatrixPalette=function(t,e){this._updateMatrices(t,e);for(var n=this.matrixPalette,r=this.bones.length,s=0;s<r;s++){var l=this.matrices[s].data,u=12*s;n[u]=l[0],n[u+1]=l[4],n[u+2]=l[8],n[u+3]=l[12],n[u+4]=l[1],n[u+5]=l[5],n[u+6]=l[9],n[u+7]=l[13],n[u+8]=l[2],n[u+9]=l[6],n[u+10]=l[10],n[u+11]=l[14]}this.uploadBones(this.skin.device)},a=[{key:"rootBone",get:function(){return this._rootBone},set:function(t){this._rootBone=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function Sg(o,a){return(Sg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var kf=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){var r=o.call(this)||this,s=e.length;return r.init(t,s),r.device=t,r.rootNode=n,r.bones=e,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Sg(a,o);var i=a.prototype;return i.updateMatrices=function(t,e){},i.updateMatrixPalette=function(t,e){for(var n=this.matrixPalette,r=this.bones.length,s=0;s<r;s++){var l=this.bones[s].getWorldTransform().data,u=12*s;n[u]=l[0],n[u+1]=l[4],n[u+2]=l[8],n[u+3]=l[12],n[u+4]=l[1],n[u+5]=l[5],n[u+6]=l[9],n[u+7]=l[13],n[u+8]=l[2],n[u+9]=l[6],n[u+10]=l[10],n[u+11]=l[14]}this.uploadBones(this.device)},a}(qs);function xg(o,a){return(xg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var u2=0,Zn=function(){function o(){this.initDefaults()}var a=o.prototype;return a.initDefaults=function(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null},a._changeVertexCount=function(i,t){this.vertexCount||(this.vertexCount=i)},o}();Zn.DEFAULT_COMPONENTS_POSITION=3,Zn.DEFAULT_COMPONENTS_NORMAL=3,Zn.DEFAULT_COMPONENTS_UV=2,Zn.DEFAULT_COMPONENTS_COLORS=4;var c2=function(o,a,i,t,e){this.data=o,this.componentCount=a,this.dataType=i,this.dataTypeNormalize=t,this.asInt=e},ye=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this).indexBuffer=[null],r.vertexBuffer=null,r.primitive=[{type:0,base:0,count:0}],r.skin=null,r.boneAabb=null,r._aabbVer=0,r._aabb=new Se,r._geometryData=null,r._morph=null,r._storageIndex=!1,r._storageVertex=!1,r.id=u2++,r.device=e,r._storageIndex=(n==null?void 0:n.storageIndex)||!1,r._storageVertex=(n==null?void 0:n.storageVertex)||!1,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&xg(a,o);var i,t=a.prototype;return t.destroy=function(){var e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(var n=0;n<this.indexBuffer.length;n++)this._destroyIndexBuffer(n);this.indexBuffer.length=0,this._geometryData=null},t._destroyIndexBuffer=function(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)},t._initBoneAabbs=function(e){this.boneAabb=[],this.boneUsed=[];for(var n,r,s,l,u,c,h,f,d=[],p=[],_=this.boneUsed,g=this.skin.boneNames.length,y=0;y<g;y++)d[y]=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),p[y]=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var v=new js(this.vertexBuffer),x=v.element[oe],S=v.element[fn],T=v.element[Pt],b=this.vertexBuffer.numVertices,w=0;w<b;w++){for(var A=0;A<4;A++)if(S.array[S.index+A]>0){var C=T.array[T.index+A];if(_[C]=!0,n=x.array[x.index],r=x.array[x.index+1],s=x.array[x.index+2],l=p[C],(u=d[C]).x>n&&(u.x=n),u.y>r&&(u.y=r),u.z>s&&(u.z=s),l.x<n&&(l.x=n),l.y<r&&(l.y=r),l.z<s&&(l.z=s),e){for(var L=c=n,I=h=r,P=f=s,M=0;M<e.length;M++){var R=e[M],k=R.deltaPositions[3*w],D=R.deltaPositions[3*w+1],O=R.deltaPositions[3*w+2];k<0?L+=k:c+=k,D<0?I+=D:h+=D,O<0?P+=O:f+=O}u.x>L&&(u.x=L),u.y>I&&(u.y=I),u.z>P&&(u.z=P),l.x<c&&(l.x=c),l.y<h&&(l.y=h),l.z<f&&(l.z=f)}}v.next()}var F=this.vertexBuffer.getFormat().elements.find(function(W){return W.name===oe});if(F&&F.normalize){for(var N=function(){switch(F.dataType){case 0:return function(W){return Math.max(W/127,-1)};case 1:return function(W){return W/255};case 2:return function(W){return Math.max(W/32767,-1)};case 3:return function(W){return W/65535};default:return function(W){return W}}}(),j=0;j<g;j++)if(_[j]){var z=d[j],V=p[j];z.set(N(z.x),N(z.y),N(z.z)),V.set(N(V.x),N(V.y),N(V.z))}}for(var H=0;H<g;H++){var Y=new Se;Y.setMinMax(d[H],p[H]),this.boneAabb.push(Y)}},t._initGeometryData=function(){!this._geometryData&&(this._geometryData=new Zn,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},t.clear=function(e,n,r,s){r===void 0&&(r=0),s===void 0&&(s=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=r,this._geometryData.maxIndices=s,this._geometryData.verticesUsage=+!e,this._geometryData.indicesUsage=+!n},t.setVertexStream=function(e,n,r,s,l,u,c){l===void 0&&(l=6),u===void 0&&(u=!1),c===void 0&&(c=!1),this._initGeometryData();var h=s||n.length/r;this._geometryData._changeVertexCount(h,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new c2(n,r,l,u,c)},t.getVertexStream=function(e,n){var r=0,s=!1;if(this._geometryData){var l=this._geometryData.vertexStreamDictionary[e];l&&(s=!0,r=this._geometryData.vertexCount,ArrayBuffer.isView(n)?n.set(l.data):(n.length=0,n.push(l.data)))}return!s&&this.vertexBuffer&&(r=new js(this.vertexBuffer).readData(e,n)),r},t.setPositions=function(e,n,r){n===void 0&&(n=Zn.DEFAULT_COMPONENTS_POSITION),this.setVertexStream(oe,e,n,r,6,!1)},t.setNormals=function(e,n,r){n===void 0&&(n=Zn.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream(bt,e,n,r,6,!1)},t.setUvs=function(e,n,r,s){r===void 0&&(r=Zn.DEFAULT_COMPONENTS_UV),this.setVertexStream(Wh+e,n,r,s,6,!1)},t.setColors=function(e,n,r){n===void 0&&(n=Zn.DEFAULT_COMPONENTS_COLORS),this.setVertexStream(st,e,n,r,6,!1)},t.setColors32=function(e,n){this.setVertexStream(st,e,Zn.DEFAULT_COMPONENTS_COLORS,n,1,!0)},t.setIndices=function(e,n){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=n||e.length},t.getPositions=function(e){return this.getVertexStream(oe,e)},t.getNormals=function(e){return this.getVertexStream(bt,e)},t.getUvs=function(e,n){return this.getVertexStream(Wh+e,n)},t.getColors=function(e){return this.getVertexStream(st,e)},t.getIndices=function(e){var n=0;if(this._geometryData&&this._geometryData.indices){var r=this._geometryData.indices;if(n=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(r);else{e.length=0;for(var s=0,l=r.length;s<l;s++)e.push(r[s])}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(n=this.indexBuffer[0].readData(e));return n},t.update=function(e,n){if(e===void 0&&(e=4),n===void 0&&(n=!0),this._geometryData){if(n){var r=this._geometryData.vertexStreamDictionary[oe];r&&r.componentCount===3&&(this._aabb.compute(r.data,this._geometryData.vertexCount),this._aabbVer++)}var s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var l=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(l=!0,this._geometryData.maxIndices=this._geometryData.indexCount),l&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}},t._buildVertexFormat=function(e){var n=[];for(var r in this._geometryData.vertexStreamDictionary){var s=this._geometryData.vertexStreamDictionary[r];n.push({semantic:r,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize,asInt:s.asInt})}return new Ot(this.device,n,e)},t._updateVertexBuffer=function(){if(!this.vertexBuffer){var e=this._geometryData.maxVertices,n=this._buildVertexFormat(e);this.vertexBuffer=new Rt(this.device,n,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}var r=new js(this.vertexBuffer),s=this._geometryData.vertexCount;for(var l in this._geometryData.vertexStreamDictionary){var u=this._geometryData.vertexStreamDictionary[l];r.writeData(l,u.data,s),delete this._geometryData.vertexStreamDictionary[l]}r.end()},t._updateIndexBuffer=function(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var e=this._geometryData.maxVertices,n=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new Yn(this.device,e>65535||e===0?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,n)}var r=this._geometryData.indices;r&&(this.indexBuffer[0].writeData(r,this._geometryData.indexCount),this._geometryData.indices=null)},t.prepareRenderState=function(e){e===1?this.generateWireframe():e===2&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})},t.updateRenderStates=function(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)},t.generateWireframe=function(){this._destroyIndexBuffer(1);var e,n=this.vertexBuffer.numVertices,r=[];if(this.indexBuffer.length>0&&this.indexBuffer[0]){for(var s=[[0,1],[1,2],[2,0]],l=this.primitive[0].base,u=this.primitive[0].count,c=this.indexBuffer[0],h=new fo[c.format](c.storage),f=new Set,d=l;d<l+u;d+=3)for(var p=0;p<3;p++){var _=h[d+s[p][0]],g=h[d+s[p][1]],y=_>g?g*n+_:_*n+g;f.has(y)||(f.add(y),r.push(_,g))}e=c.format}else{for(var v=0;v<n;v+=3)r.push(v,v+1,v+1,v+2,v+2,v);e=r.length>65535?2:1}var x=new Yn(this.vertexBuffer.device,e,r.length);new fo[x.format](x.storage).set(r),x.unlock(),this.primitive[1]={type:1,base:0,count:r.length,indexed:!0},this.indexBuffer[1]=x},a.fromGeometry=function(e,n,r){r===void 0&&(r={});var s=new a(e,r),l=n.positions,u=n.normals,c=n.tangents,h=n.colors,f=n.uvs,d=n.uvs1,p=n.blendIndices,_=n.blendWeights,g=n.indices;return l&&s.setPositions(l),u&&s.setNormals(u),c&&s.setVertexStream(hn,c,4),h&&s.setColors32(h),f&&s.setUvs(0,f),d&&s.setUvs(1,d),p&&s.setVertexStream(Pt,p,4,p.length/4,1),_&&s.setVertexStream(fn,_,4),g&&s.setIndices(g),s.update(),s},i=[{key:"morph",get:function(){return this._morph},set:function(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}},{key:"aabb",get:function(){return this._aabb},set:function(e){this._aabb=e,this._aabbVer++}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(lu),bg=new It;function Ks(o){return bg.get(o)}var h2=function(){function o(){this.cache=new Map}var a=o.prototype;return a.destroy=function(){this.cache.forEach(function(i,t){t.destroy()}),this.cache.clear()},a.incRef=function(i){var t=(this.cache.get(i)||0)+1;this.cache.set(i,t)},a.decRef=function(i){if(i){var t=this.cache.get(i);t&&(--t==0?(this.cache.delete(i),i.destroy()):this.cache.set(i,t))}},o}(),Ei=function(){function o(){}return o.incRef=function(a){this.cache.incRef(a)},o.decRef=function(a){this.cache.decRef(a)},o.destroy=function(){this.cache.destroy()},o}();Ei.cache=new h2;var f2=0,d2=new Se,Tu=new Se,Nf=new to,Ff=new Set,Zs=new Uint32Array(4),p2=function(){function o(a){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=a}return o.prototype.destroy=function(){if(this._destroyVertexBuffer){var a;(a=this.vertexBuffer)==null||a.destroy()}this.vertexBuffer=null},o}(),m2=function(){function o(){this.bindGroup=null,this.uniformBuffer=null}var a=o.prototype;return a.getBindGroup=function(i){if(!this.bindGroup){var t=this.shader.meshBindGroupFormat;this.bindGroup=new Fs(i,t)}return this.bindGroup},a.getUniformBuffer=function(i){if(!this.uniformBuffer){var t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new So(i,t,!1)}return this.uniformBuffer},a.destroy=function(){var i,t;(i=this.bindGroup)==null||i.destroy(),this.bindGroup=null,(t=this.uniformBuffer)==null||t.destroy(),this.uniformBuffer=null},o}(),De=function(){function o(t,e,n){if(n===void 0&&(n=null),this.castShadow=!1,this.cull=!0,this.drawOrder=0,this._drawBucket=127,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=f2++,this.isVisibleFunc=null,this.instancingData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new Se,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=n,this._mesh=t,t.incRefCount(),this.material=e,t.vertexBuffer){var r=t.vertexBuffer.format;this._shaderDefs|=4*!!r.hasUv0,this._shaderDefs|=8*!!r.hasUv1,this._shaderDefs|=16*!!r.hasColor,this._shaderDefs|=512*!!r.hasTangents}this.updateKey()}var a,i=o.prototype;return i.clearShaders=function(){this._shaderCache.forEach(function(t){t.destroy()}),this._shaderCache.clear()},i.getShaderInstance=function(t,e,n,r,s,l,u){var c=this._shaderDefs;Zs[0]=t,Zs[1]=e,Zs[2]=c,Zs[3]=r.hash;var h=nf(Zs),f=this._shaderCache.get(h);if(!f){var d=this._material;if((f=new m2).shader=d.variants.get(h),f.hashes=new Uint32Array(Zs),!f.shader){var p,_=d.getShaderVariant({device:this.mesh.device,scene:n,objDefs:c,cameraShaderParams:r,pass:t,sortedLights:u,viewUniformFormat:s,viewBindGroupFormat:l,vertexFormat:(p=this.mesh.vertexBuffer)==null?void 0:p.format});d.variants.set(h,_),f.shader=_}this._shaderCache.set(h,f)}return f},i._updateShaderDefs=function(t){t!==this._shaderDefs&&(this._shaderDefs=t,this.clearShaders())},i.destroy=function(){var t,e,n,r=this.mesh;r&&(this.mesh=null,r.refCount<1&&r.destroy()),this.setRealtimeLightmap(o.lightmapParamNames[0],null),this.setRealtimeLightmap(o.lightmapParamNames[1],null),(t=this._skinInstance)==null||t.destroy(),this._skinInstance=null,(e=this.morphInstance)==null||e.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,(n=this.instancingData)==null||n.destroy()},i._isVisible=function(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(Nf.center=this.aabb.center,Nf.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(Nf)>0))},i.updateKey=function(){var t=this.material;this._sortKeyForward=this._drawBucket<<25|(t.alphaToCoverage||t.alphaTest?16777216:0)|16777215&t.id},i.setInstancing=function(t,e){e===void 0&&(e=!1),t?(this.instancingData=new p2(t.numVertices),this.instancingData.vertexBuffer=t,t.format.instancing=!0,this.cull=e):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(t?32|this._shaderDefs:-33&this._shaderDefs)},i.ensureMaterial=function(t){this.material||(this.material=Ks(t))},i.clearParameters=function(){this.parameters={}},i.getParameters=function(){return this.parameters},i.getParameter=function(t){return this.parameters[t]},i.setParameter=function(t,e,n){n===void 0&&(n=4294967295);var r=this.parameters[t];r?(r.data=e,r.passFlags=n):this.parameters[t]={scopeId:null,data:e,passFlags:n}},i.setRealtimeLightmap=function(t,e){var n=this.getParameter(t);n!==e&&(n&&Ei.decRef(n.data),e?(Ei.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))},i.deleteParameter=function(t){this.parameters[t]&&delete this.parameters[t]},i.setParameters=function(t,e){var n=this.parameters;for(var r in n){var s=n[r];s.passFlags&e&&(s.scopeId||(s.scopeId=t.scope.resolve(r)),s.scopeId.setValue(s.data))}},i.setLightmapped=function(t){t?this.mask=(2|this.mask)&-6:(this.setRealtimeLightmap(o.lightmapParamNames[0],null),this.setRealtimeLightmap(o.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=(1|this.mask)&-7)},i.setCustomAabb=function(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()},i._setupSkinUpdate=function(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)},o._prepareRenderStyleForArray=function(t,e){if(t){for(var n=0;n<t.length;n++){t[n]._renderStyle=e;var r=t[n].mesh;Ff.has(r)||(Ff.add(r),r.prepareRenderState(e))}Ff.clear()}},a=[{key:"drawBucket",get:function(){return this._drawBucket},set:function(t){this._drawBucket=255&Math.floor(t),this.updateKey()}},{key:"renderStyle",get:function(){return this._renderStyle},set:function(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}},{key:"mesh",get:function(){return this._mesh},set:function(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}},{key:"aabb",get:function(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);var t=this._customAabb,e=!!t;if(!t){if(t=d2,this.skinInstance){if(!this.mesh.boneAabb){var n=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(n)}for(var r=this.mesh.boneUsed,s=!0,l=0;l<this.mesh.boneAabb.length;l++)r[l]&&(Tu.setFromTransformedAabb(this.mesh.boneAabb[l],this.skinInstance.matrices[l]),s?(s=!1,t.center.copy(Tu.center),t.halfExtents.copy(Tu.halfExtents)):t.add(Tu));e=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){var u=this.mesh.morph.aabb;t._expand(u.getMin(),u.getMax())}e=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}}return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb},set:function(t){this._aabb=t}},{key:"material",get:function(){return this._material},set:function(t){this.clearShaders();var e=this._material;e&&e.removeMeshInstanceRef(this),this._material=t,t&&(t.addMeshInstanceRef(this),this.transparent=t.transparent,this.updateKey())}},{key:"calculateSortDistance",get:function(){return this._calculateSortDistance},set:function(t){this._calculateSortDistance=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow!==t&&(this._receiveShadow=t,this._updateShaderDefs(t?-2&this._shaderDefs:1|this._shaderDefs))}},{key:"batching",get:function(){return(16384&this._shaderDefs)!=0},set:function(t){this._updateShaderDefs(t?16384|this._shaderDefs:-16385&this._shaderDefs)}},{key:"skinInstance",get:function(){return this._skinInstance},set:function(t){this._skinInstance=t,this._updateShaderDefs(t?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}},{key:"morphInstance",get:function(){return this._morphInstance},set:function(t){(e=this._morphInstance)==null||e.destroy(),this._morphInstance=t;var e,n=this._shaderDefs;n=t&&t.morph.morphPositions?1024|n:-1025&n,n=t&&t.morph.morphNormals?2048|n:-2049&n,n=t&&t.morph.intRenderFormat?8192|n:-8193&n,this._updateShaderDefs(n)}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(t){this._screenSpace!==t&&(this._screenSpace=t,this._updateShaderDefs(t?256|this._shaderDefs:-257&this._shaderDefs))}},{key:"key",get:function(){return this._sortKeyForward},set:function(t){this._sortKeyForward=t}},{key:"mask",get:function(){return this._shaderDefs>>16},set:function(t){var e=65535&this._shaderDefs;this._updateShaderDefs(e|t<<16)}},{key:"instancingCount",get:function(){return this.instancingData?this.instancingData.count:0},set:function(t){this.instancingData&&(this.instancingData.count=t)}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function Tg(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}De.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];var _2=[0,1,3,2,3,1],v2=[0,1,3,0,3,2],Eg=new zt;function wg(o,a){if(o&&!a||!o&&a)return!1;if((o=o.data)===(a=a.data))return!0;if(Tg(o,Float32Array)&&Tg(a,Float32Array)){if(o.length!==a.length)return!1;for(var i=0;i<o.length;i++)if(o[i]!==a[i])return!1;return!0}return!1}function Uf(o){return o.node.worldTransform.scaleSign}var Ag=function(){function o(i,t,e){this.device=i,this.rootNode=t,this.scene=e,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}var a=o.prototype;return a.destroy=function(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]},a.addGroup=function(i,t,e,n,r){if(n===void 0&&(n=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[n]){var s=new qe(n,i,t,e,r);return this._batchGroups[n]=s,s}},a.removeGroup=function(i){if(this._batchGroups[i]){for(var t=[],e=0;e<this._batchList.length;e++)this._batchList[e].batchGroupId===i?this.destroyBatch(this._batchList[e]):t.push(this._batchList[e]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,i),delete this._batchGroups[i]}},a.markGroupDirty=function(i){0>this._dirtyGroups.indexOf(i)&&this._dirtyGroups.push(i)},a.getGroupByName=function(i){var t=this._batchGroups;for(var e in t)if(t.hasOwnProperty(e)&&t[e].name===i)return t[e];return null},a.getBatches=function(i){for(var t=[],e=this._batchList.length,n=0;n<e;n++){var r=this._batchList[n];r.batchGroupId===i&&t.push(r)}return t},a._removeModelsFromBatchGroup=function(i,t){if(i.enabled){i.model&&i.model.batchGroupId===t&&(i.model.batchGroupId=-1),i.render&&i.render.batchGroupId===t&&(i.render.batchGroupId=-1),i.element&&i.element.batchGroupId===t&&(i.element.batchGroupId=-1),i.sprite&&i.sprite.batchGroupId===t&&(i.sprite.batchGroupId=-1);for(var e=0;e<i._children.length;e++)this._removeModelsFromBatchGroup(i._children[e],t)}},a.insert=function(i,t,e){var n=this._batchGroups[t];n&&0>n._obj[i].indexOf(e)&&(n._obj[i].push(e),this.markGroupDirty(t))},a.remove=function(i,t,e){var n=this._batchGroups[t];if(n){var r=n._obj[i].indexOf(e);r>=0&&(n._obj[i].splice(r,1),this.markGroupDirty(t))}},a._extractRender=function(i,t,e,n){return i.render&&(t=n[i.render.batchGroupId]=t.concat(i.render.meshInstances),i.render.removeFromLayers()),t},a._extractModel=function(i,t,e,n){return i.model&&i.model.model&&(t=n[i.model.batchGroupId]=t.concat(i.model.meshInstances),i.model.removeModelFromLayers()),t},a._extractElement=function(i,t,e){if(i.element){var n=!1;i.element._text&&i.element._text._model.meshInstances.length>0?(t.push(i.element._text._model.meshInstances[0]),i.element.removeModelFromLayers(i.element._text._model),n=!0):i.element._image&&(t.push(i.element._image._renderable.meshInstance),i.element.removeModelFromLayers(i.element._image._renderable.model),i.element._image._renderable.unmaskMeshInstance&&(t.push(i.element._image._renderable.unmaskMeshInstance),i.element._image._renderable.unmaskMeshInstance.stencilFront&&i.element._image._renderable.unmaskMeshInstance.stencilBack||(i.element._dirtifyMask(),i.element._onPrerender())),n=!0),n&&(e._ui=!0)}},a._collectAndRemoveMeshInstances=function(i,t){for(var e=0;e<t.length;e++){var n=t[e],r=this._batchGroups[n];if(r){var s=i[n];s||(s=i[n]=[]);for(var l=0;l<r._obj.model.length;l++)s=this._extractModel(r._obj.model[l],s,r,i);for(var u=0;u<r._obj.render.length;u++)s=this._extractRender(r._obj.render[u],s,r,i);for(var c=0;c<r._obj.element.length;c++)this._extractElement(r._obj.element[c],s,r);for(var h=0;h<r._obj.sprite.length;h++){var f=r._obj.sprite[h];f.sprite&&f.sprite._meshInstance&&(r.dynamic||f.sprite.sprite._renderMode===0)&&(s.push(f.sprite._meshInstance),f.sprite.removeModelFromLayers(),r._sprite=!0,f.sprite._batchGroup=r)}}}},a.generate=function(i){var t,e,n,r,s={};i||(i=Object.keys(this._batchGroups));for(var l=[],u=0;u<this._batchList.length;u++){if(0>i.indexOf(this._batchList[u].batchGroupId)){l.push(this._batchList[u]);continue}this.destroyBatch(this._batchList[u])}if(this._batchList=l,this._collectAndRemoveMeshInstances(s,i),i===this._dirtyGroups)this._dirtyGroups.length=0;else{for(var c=[],h=0;h<this._dirtyGroups.length;h++)0>i.indexOf(this._dirtyGroups[h])&&c.push(this._dirtyGroups[h]);this._dirtyGroups=c}for(var f in s)if(s.hasOwnProperty(f)&&(t=s[f],n=this._batchGroups[f])){e=this.prepare(t,n.dynamic,n.maxAabbSize,n._ui||n._sprite);for(var d=0;d<e.length;d++)(r=this.create(e[d],n.dynamic,parseInt(f,10)))&&r.addToLayers(this.scene,n.layers)}},a.prepare=function(i,t,e,n){if(e===void 0&&(e=Number.POSITIVE_INFINITY),i.length===0)return[];var r,s,l=.5*e,u=new Se,c=new Se,h=null,f=[],d=0;n&&i.sort(function(P,M){return P.drawOrder-M.drawOrder});for(var p=i,_=n?function(P){h?h.add(P.aabb):h=P.aabb.clone(),s.push(P)}:function(P){s.push(P)};p.length>0;){f[d]=[p[0]],s=[];var g=p[0].material,y=p[0].layer,v=p[0]._shaderDefs,x=p[0].parameters,S=p[0].stencilFront,T=p[0].mesh.vertexBuffer.getNumVertices(),b=p[0].drawOrder;u.copy(p[0].aabb);var w=Uf(p[0]),A=p[0].mesh.vertexBuffer.format.batchingHash,C=p[0].mesh.primitive[0].indexed;h=null;for(var L=1;L<p.length;L++){var I=p[L];if(t&&f[d].length>=1024){s=s.concat(p.slice(L));break}if(g!==I.material||y!==I.layer||A!==I.mesh.vertexBuffer.format.batchingHash||C!==I.mesh.primitive[0].indexed||v!==I._shaderDefs||T+I.mesh.vertexBuffer.getNumVertices()>4294967295||(c.copy(u),c.add(I.aabb),c.halfExtents.x>l||c.halfExtents.y>l||c.halfExtents.z>l||S&&(!(r=I.stencilFront)||S.func!==r.func||S.zpass!==r.zpass)||w!==Uf(I)||!function(P,M){for(var R in P)if(P.hasOwnProperty(R)&&!wg(P[R],M[R]))return!1;for(var k in M)if(M.hasOwnProperty(k)&&!wg(M[k],P[k]))return!1;return!0}(x,I.parameters)||n&&h&&h.intersects(I.aabb)&&I.drawOrder!==b)){_(I);continue}u.add(I.aabb),T+=I.mesh.vertexBuffer.getNumVertices(),f[d].push(I)}d++,p=s}return f},a.collectBatchedMeshData=function(i,t){for(var e=null,n=0,r=0,s=null,l=0;l<i.length;l++)if(i[l].visible){var u=i[l].mesh;if(n+=u.vertexBuffer.numVertices,u.primitive[0].indexed)r+=u.primitive[0].count;else{var c=u.primitive[0].type;(c===6||c===5)&&u.primitive[0].count===4&&(r+=6)}if(!e){s=i[l].material,e={};for(var h=u.vertexBuffer.format.elements,f=0;f<h.length;f++)e[h[f].name]={numComponents:h[f].numComponents,dataType:h[f].dataType,normalize:h[f].normalize,count:0};t&&(e[Pt]={numComponents:1,dataType:6,normalize:!1,count:0})}}return{streams:e,batchNumVerts:n,batchNumIndices:r,material:s}},a.create=function(i,t,e){this._init||(this.vertexFormats={},this._init=!0);var n=null,r=null,s=this.collectBatchedMeshData(i,t);if(s.streams){var l,u,c,h,f,d,p,_=s.streams,g=s.material,y=s.batchNumVerts,v=s.batchNumIndices;r=new Of(i,t,e),this._batchList.push(r);var x=0,S=0,T=new(y<=65535?Uint16Array:Uint32Array)(v);for(l in _)(n=_[l]).typeArrayType=Ur[n.dataType],n.elementByteSize=Ns[n.dataType],n.buffer=new n.typeArrayType(y*n.numComponents);for(var b=0;b<i.length;b++)if(i[b].visible){for(l in c=(u=i[b].mesh).vertexBuffer.numVertices,t||(p=i[b].node.getWorldTransform()),_)if(l!==Pt){var w=new(n=_[l]).typeArrayType(n.buffer.buffer,n.elementByteSize*n.count),A=u.getVertexStream(l,w)*n.numComponents;if(n.count+=A,!t&&n.numComponents>=3){if(l===oe)for(var C=p.data,L=C[0],I=C[1],P=C[2],M=C[4],R=C[5],k=C[6],D=C[8],O=C[9],F=C[10],N=C[12],j=C[13],z=C[14],V=void 0,H=void 0,Y=void 0,W=0;W<A;W+=n.numComponents)V=w[W],H=w[W+1],Y=w[W+2],w[W]=V*L+H*M+Y*D+N,w[W+1]=V*I+H*R+Y*O+j,w[W+2]=V*P+H*k+Y*F+z;else if(l===bt||l===hn){Eg.invertMat4(p).transpose();for(var ie=Eg.data,te=ie[0],ae=ie[1],_e=ie[2],xe=ie[3],je=ie[4],Qe=ie[5],rt=ie[6],Pe=ie[7],wt=ie[8],tt=void 0,At=void 0,K=void 0,dt=0;dt<A;dt+=n.numComponents)tt=w[dt],At=w[dt+1],K=w[dt+2],w[dt]=tt*te+At*xe+K*rt,w[dt+1]=tt*ae+At*je+K*Pe,w[dt+2]=tt*_e+At*Qe+K*wt}}}if(t){n=_[Pt];for(var ri=0;ri<c;ri++)n.buffer[n.count++]=b}if(u.primitive[0].indexed)h=u.primitive[0].base,f=u.primitive[0].count,d=new fo[u.indexBuffer[0].getFormat()](u.indexBuffer[0].storage);else{var Nn=u.primitive[0].type;if(Nn===6||Nn===5)if(u.primitive[0].count===4)h=0,f=6,d=Nn===6?_2:v2;else{f=0;continue}}for(var Fn=0;Fn<f;Fn++)T[Fn+S]=d[h+Fn]+x;S+=f,x+=c}for(l in u=new ye(this.device),_)n=_[l],u.setVertexStream(l,n.buffer,n.numComponents,void 0,n.dataType,n.normalize);T.length>0&&u.setIndices(T),u.update(4,!1),t&&(g=g.clone()).update();var Re=new De(u,g,this.rootNode);Re.castShadow=r.origMeshInstances[0].castShadow,Re.parameters=r.origMeshInstances[0].parameters,Re.layer=r.origMeshInstances[0].layer,Re._shaderDefs=r.origMeshInstances[0]._shaderDefs,Re.batching=!0,Re.cull=r.origMeshInstances[0].cull;var Dt=this._batchGroups[e];if(Dt&&Dt._ui&&(Re.cull=!1),t){for(var Mt=[],si=0;si<r.origMeshInstances.length;si++)Mt.push(r.origMeshInstances[si].node);Re.skinInstance=new kf(this.device,Mt,this.rootNode)}Re._updateAabb=!1,Re.drawOrder=r.origMeshInstances[0].drawOrder,Re.stencilFront=r.origMeshInstances[0].stencilFront,Re.stencilBack=r.origMeshInstances[0].stencilBack,Re.flipFacesFactor=Uf(r.origMeshInstances[0]),Re.castShadow=r.origMeshInstances[0].castShadow,r.meshInstance=Re,r.updateBoundingBox()}return r},a.updateAll=function(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(var i=0;i<this._batchList.length;i++)this._batchList[i].dynamic&&this._batchList[i].updateBoundingBox()},a.clone=function(i,t){var e=new Of(t,i.dynamic,i.batchGroupId);this._batchList.push(e);for(var n=[],r=0;r<t.length;r++)n.push(t[r].node);return e.meshInstance=new De(i.meshInstance.mesh,i.meshInstance.material,i.meshInstance.node),e.meshInstance._updateAabb=!1,e.meshInstance.parameters=t[0].parameters,e.meshInstance.cull=t[0].cull,e.meshInstance.layer=t[0].layer,i.dynamic&&(e.meshInstance.skinInstance=new kf(this.device,n,this.rootNode)),e.meshInstance.castShadow=i.meshInstance.castShadow,e},a.destroyBatch=function(i){i.destroy(this.scene,this._batchGroups[i.batchGroupId].layers)},o}();function Cg(o,a){return(Cg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Pg="uSceneColorMap",Bf=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return t=o.apply(this,arguments)||this,t.colorRenderTarget=null,t.source=null,t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Cg(a,o);var i=a.prototype;return i.destroy=function(){o.prototype.destroy.call(this),this.releaseRenderTarget(this.colorRenderTarget)},i.shouldReallocate=function(t,e,n){if((t==null?void 0:t.colorBuffer.format)!==n)return!0;var r=(e==null?void 0:e.width)||this.device.width,s=(e==null?void 0:e.height)||this.device.height;return!t||r!==t.width||s!==t.height},i.allocateRenderTarget=function(t,e,n,r){var s=new ee(n,{name:Pg,format:r,width:e?e.colorBuffer.width:n.width,height:e?e.colorBuffer.height:n.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return t?(t.destroyFrameBuffers(),t._colorBuffer=s,t._colorBuffers=[s]):t=new Ee({name:"ColorGrabRT",colorBuffer:s,depth:!1,stencil:!1,autoResolve:!1}),t},i.releaseRenderTarget=function(t){t&&(t.destroyTextureBuffers(),t.destroy())},i.frameUpdate=function(){var t,e=this.device,n=this.source,r=(t=n==null?void 0:n.colorBuffer.format)!=null?t:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,n==null?void 0:n.colorBuffer,r)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,n,e,r));var s=this.colorRenderTarget.colorBuffer;e.scope.resolve(Pg).setValue(s)},i.execute=function(){var t=this.device,e=this.source,n=this.colorRenderTarget.colorBuffer;t.isWebGPU?(t.copyRenderTarget(e,this.colorRenderTarget,!0,!1),t.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(t.copyRenderTarget(e,this.colorRenderTarget,!0,!1),t.activeTexture(t.maxCombinedTextures-1),t.bindTexture(n),t.gl.generateMipmap(n.impl._glTarget))},a}(ct);function Ig(o,a){return(Ig=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Lg="uSceneDepthMap",g2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this,t)||this).depthRenderTarget=null,n.camera=null,n.camera=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ig(a,o);var i=a.prototype;return i.destroy=function(){o.prototype.destroy.call(this),this.releaseRenderTarget(this.depthRenderTarget)},i.shouldReallocate=function(t,e){var n=(e==null?void 0:e.width)||this.device.width,r=(e==null?void 0:e.height)||this.device.height;return!t||n!==t.width||r!==t.height},i.allocateRenderTarget=function(t,e,n,r,s){var l=new ee(n,{name:Lg,format:r,width:e?e.colorBuffer.width:n.width,height:e?e.colorBuffer.height:n.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return t?(t.destroyFrameBuffers(),s?t._depthBuffer=l:(t._colorBuffer=l,t._colorBuffers=[l])):t=new Ee({name:"DepthGrabRT",colorBuffer:s?null:l,depthBuffer:s?l:null,depth:!s,stencil:n.supportsStencil,autoResolve:!1}),t},i.releaseRenderTarget=function(t){t&&(t.destroyTextureBuffers(),t.destroy())},i.before=function(){var t,e,n,r,s=this.camera,l=this.device,u=(n=s==null?void 0:s.renderTarget)!=null?n:l.backBuffer,c=!0,h=u.stencil?17:16;l.isWebGPU&&u.samples>1&&(h=15,c=!1);var f=(r=(t=s.renderTarget)==null?void 0:t.depthBuffer)!=null?r:(e=s.renderTarget)==null?void 0:e.colorBuffer;this.shouldReallocate(this.depthRenderTarget,f)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,s.renderTarget,l,h,c));var d=c?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;l.scope.resolve(Lg).setValue(d)},i.execute=function(){var t=this.device;if(t.isWebGL2&&t.renderTarget.samples>1){var e=t.renderTarget.impl._glFrameBuffer,n=this.depthRenderTarget;t.renderTarget=n,t.updateBegin(),this.depthRenderTarget.impl.internalResolve(t,e,n.impl._glFrameBuffer,this.depthRenderTarget,t.gl.DEPTH_BUFFER_BIT)}else t.copyRenderTarget(t.renderTarget,this.depthRenderTarget,!1,!0)},a}(ct),Dg=function(){var o;function a(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=Gr,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}return a.prototype.markDirty=function(){this._hash=void 0,this._definesDirty=!0},o=[{key:"hash",get:function(){if(this._hash===void 0){var i=this.gammaCorrection+"_"+this.toneMapping+"_"+this.srgbRenderTarget+"_"+this.fog+"_"+this.ssaoEnabled+"_"+this.sceneDepthMapLinear;this._hash=dn(i)}return this._hash}},{key:"defines",get:function(){var i=this._defines;return this._definesDirty&&(this._definesDirty=!1,i.clear(),this._sceneDepthMapLinear&&i.set("SCENE_DEPTHMAP_LINEAR",!0),i.set("FOG",this._fog.toUpperCase()),i.set("TONEMAP",gu[this._toneMapping]),i.set("GAMMA",Lf[this.shaderOutputGamma])),i}},{key:"fog",get:function(){return this._fog},set:function(i){this._fog!==i&&(this._fog=i,this.markDirty())}},{key:"ssaoEnabled",get:function(){return this._ssaoEnabled},set:function(i){this._ssaoEnabled!==i&&(this._ssaoEnabled=i,this.markDirty())}},{key:"gammaCorrection",get:function(){return this._gammaCorrection},set:function(i){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==i&&(this._gammaCorrection=i,this.markDirty())}},{key:"toneMapping",get:function(){return this._toneMapping},set:function(i){this._toneMapping!==i&&(this._toneMapping=i,this.markDirty())}},{key:"srgbRenderTarget",get:function(){return this._srgbRenderTarget},set:function(i){this._srgbRenderTarget!==i&&(this._srgbRenderTarget=i,this.markDirty())}},{key:"sceneDepthMapLinear",get:function(){return this._sceneDepthMapLinear},set:function(i){this._sceneDepthMapLinear!==i&&(this._sceneDepthMapLinear=i,this.markDirty())}},{key:"shaderOutputGamma",get:function(){return+(this._gammaCorrection===1&&!this._srgbRenderTarget)}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),Qs=new E,Ro=new E,Mg=new E,Rg=new X,Ue=[new E,new E,new E,new E,new E,new E,new E,new E],Eu=function(){function o(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new Dg,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new B(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new q(0,0,1,1),this._renderTarget=null,this._scissorRect=new q(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new X,this._projMatDirty=!0,this._projMatSkybox=new X,this._viewMat=new X,this._viewMatDirty=!0,this._viewProjMat=new X,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new X,this._viewProjCurrent=null,this._viewProjPrevious=new X,this._jitters=[0,0,0,0],this.frustum=new t_,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}var a,i=o.prototype;return i.destroy=function(){var t,e;(t=this.renderPassColorGrab)==null||t.destroy(),this.renderPassColorGrab=null,(e=this.renderPassDepthGrab)==null||e.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0},i._storeShaderMatrices=function(t,e,n,r){if(this._shaderMatricesVersion!==r){var s;this._shaderMatricesVersion=r,this._viewProjPrevious.copy((s=this._viewProjCurrent)!=null?s:t),this._viewProjCurrent!=null||(this._viewProjCurrent=new X),this._viewProjCurrent.copy(t),this._viewProjInverse.invert(t),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=e,this._jitters[1]=n}},i.clone=function(){return new o().copy(this)},i.copy=function(t){return this._aspectRatio=t._aspectRatio,this._farClip=t._farClip,this._fov=t._fov,this._horizontalFov=t._horizontalFov,this._nearClip=t._nearClip,this._xrProperties.aspectRatio=t._xrProperties.aspectRatio,this._xrProperties.farClip=t._xrProperties.farClip,this._xrProperties.fov=t._xrProperties.fov,this._xrProperties.horizontalFov=t._xrProperties.horizontalFov,this._xrProperties.nearClip=t._xrProperties.nearClip,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.flipFaces=t.flipFaces,this.frustumCulling=t.frustumCulling,this.layers=t.layers,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.aperture=t.aperture,this.shutter=t.shutter,this.sensitivity=t.sensitivity,this.shaderPassInfo=t.shaderPassInfo,this.jitter=t.jitter,this._projMatDirty=!0,this},i._enableRenderPassColorGrab=function(t,e){if(e)this.renderPassColorGrab||(this.renderPassColorGrab=new Bf(t));else{var n;(n=this.renderPassColorGrab)==null||n.destroy(),this.renderPassColorGrab=null}},i._enableRenderPassDepthGrab=function(t,e,n){if(n)this.renderPassDepthGrab||(this.renderPassDepthGrab=new g2(t,this));else{var r;(r=this.renderPassDepthGrab)==null||r.destroy(),this.renderPassDepthGrab=null}},i._updateViewProjMat=function(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)},i.worldToScreen=function(t,e,n,r){r===void 0&&(r=new E),this._updateViewProjMat(),this._viewProjMat.transformPoint(t,r);var s=this._viewProjMat.data,l=t.x*s[3]+t.y*s[7]+t.z*s[11]+ +s[15];return r.x=(r.x/l+1)*.5*e,r.y=(1-r.y/l)*.5*n,r},i.screenToWorld=function(t,e,n,r,s,l){l===void 0&&(l=new E);var u=this.farClip-this.nearClip;if(Qs.set(t/r,(s-e)/s,n/u),Qs.mulScalar(2),Qs.sub(E.ONE),this._projection===0){X._getPerspectiveHalfSize(Ro,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),Ro.x*=Qs.x,Ro.y*=Qs.y;var c=this._node.getWorldTransform();Ro.z=-this.nearClip,c.transformPoint(Ro,Mg);var h=this._node.getPosition();l.sub2(Mg,h),l.normalize(),l.mulScalar(n),l.add(h)}else this._updateViewProjMat(),Rg.copy(this._viewProjMat).invert(),Rg.transformPoint(Qs,l);return l},i._evaluateProjectionMatrix=function(){if(this._projMatDirty){if(this._projection===0)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{var t=this._orthoHeight,e=t*this.aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}},i.getProjectionMatrixSkybox=function(){return this._evaluateProjectionMatrix(),this._projMatSkybox},i.getExposure=function(){return 1/(1.2*Math.pow(2,Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity)))},i.getScreenSize=function(t){if(this._projection===0){var e=this._node.getPosition().distance(t.center);return e<t.radius?1:Math.min(Math.tan(Math.asin(t.radius/e))/Math.tan(this.fov/2*U.DEG_TO_RAD),1)}return U.clamp(t.radius/this._orthoHeight,0,1)},i.getFrustumCorners=function(t,e){t===void 0&&(t=this.nearClip),e===void 0&&(e=this.farClip);var n,r,s=this.fov*Math.PI/180;return this.projection===0?this.horizontalFov?r=(n=t*Math.tan(s/2))/this.aspectRatio:n=(r=t*Math.tan(s/2))*this.aspectRatio:n=(r=this._orthoHeight)*this.aspectRatio,Ue[0].x=n,Ue[0].y=-r,Ue[0].z=-t,Ue[1].x=n,Ue[1].y=r,Ue[1].z=-t,Ue[2].x=-n,Ue[2].y=r,Ue[2].z=-t,Ue[3].x=-n,Ue[3].y=-r,Ue[3].z=-t,this._projection===0&&(this.horizontalFov?r=(n=e*Math.tan(s/2))/this.aspectRatio:n=(r=e*Math.tan(s/2))*this.aspectRatio),Ue[4].x=n,Ue[4].y=-r,Ue[4].z=-e,Ue[5].x=n,Ue[5].y=r,Ue[5].z=-e,Ue[6].x=-n,Ue[6].y=r,Ue[6].z=-e,Ue[7].x=-n,Ue[7].y=-r,Ue[7].z=-e,Ue},i.setXrProperties=function(t){Object.assign(this._xrProperties,t),this._projMatDirty=!0},a=[{key:"fullSizeClearRect",get:function(){var t=this._scissorRectClear?this.scissorRect:this._rect;return t.x===0&&t.y===0&&t.z===1&&t.w===1}},{key:"aspectRatio",get:function(){var t;return(t=this.xr)!=null&&t.active?this._xrProperties.aspectRatio:this._aspectRatio},set:function(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}},{key:"aspectRatioMode",get:function(){return this._aspectRatioMode},set:function(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}},{key:"calculateProjection",get:function(){return this._calculateProjection},set:function(t){this._calculateProjection=t,this._projMatDirty=!0}},{key:"calculateTransform",get:function(){return this._calculateTransform},set:function(t){this._calculateTransform=t}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.copy(t)}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(t){this._clearColorBuffer=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(t){this._clearDepthBuffer=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(t){this._clearStencilBuffer=t}},{key:"cullFaces",get:function(){return this._cullFaces},set:function(t){this._cullFaces=t}},{key:"farClip",get:function(){var t;return(t=this.xr)!=null&&t.active?this._xrProperties.farClip:this._farClip},set:function(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}},{key:"flipFaces",get:function(){return this._flipFaces},set:function(t){this._flipFaces=t}},{key:"fov",get:function(){var t;return(t=this.xr)!=null&&t.active?this._xrProperties.fov:this._fov},set:function(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}},{key:"frustumCulling",get:function(){return this._frustumCulling},set:function(t){this._frustumCulling=t}},{key:"horizontalFov",get:function(){var t;return(t=this.xr)!=null&&t.active?this._xrProperties.horizontalFov:this._horizontalFov},set:function(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}},{key:"layers",get:function(){return this._layers},set:function(t){this._layers=t.slice(0),this._layersSet=new Set(this._layers)}},{key:"layersSet",get:function(){return this._layersSet}},{key:"nearClip",get:function(){var t;return(t=this.xr)!=null&&t.active?this._xrProperties.nearClip:this._nearClip},set:function(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}},{key:"projectionMatrix",get:function(){return this._evaluateProjectionMatrix(),this._projMat}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.copy(t)}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(t){this._renderTarget=t}},{key:"scissorRect",get:function(){return this._scissorRect},set:function(t){this._scissorRect.copy(t)}},{key:"viewMatrix",get:function(){if(this._viewMatDirty){var t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t}},{key:"sensitivity",get:function(){return this._sensitivity},set:function(t){this._sensitivity=t}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t}},{key:"xr",get:function(){return this._xr},set:function(t){this._xr!==t&&(this._xr=t,this._projMatDirty=!0)}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function An(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Og(o,a){return(Og=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var kg=new X,Vf=new E,Ng=new Z,zf=new Z,Fg=new E,Ug=new E,y2=new X,S2=new Z,qt=new E,Oo=new X,Kt=new Z,Js=new Z,Bg=new X,Gf=new E,wu=new E;function Vg(o,a){return An(o,Function)?o:function(i){var t=i[o];return An(t,Function)&&(t=t()),t===a}}var pe=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return e===void 0&&(e="Untitled"),(n=o.call(this)||this).tags=new Ls(n),n.localPosition=new E,n.localRotation=new Z,n.localScale=new E(1,1,1),n.localEulerAngles=new E,n.position=new E,n.rotation=new Z,n.eulerAngles=new E,n._scale=null,n.localTransform=new X,n._dirtyLocal=!1,n._aabbVer=0,n._frozen=!1,n.worldTransform=new X,n._dirtyWorld=!1,n._worldScaleSign=0,n._normalMatrix=new zt,n._dirtyNormal=!0,n._right=null,n._up=null,n._forward=null,n._parent=null,n._children=[],n._graphDepth=0,n._enabled=!0,n._enabledInHierarchy=!1,n.scaleCompensation=!1,n.name=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Og(a,o);var i,t=a.prototype;return t._notifyHierarchyStateChanged=function(e,n){e._onHierarchyStateChanged(n);for(var r=e._children,s=0,l=r.length;s<l;s++)r[s]._enabled&&this._notifyHierarchyStateChanged(r[s],n)},t._onHierarchyStateChanged=function(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()},t._cloneInternal=function(e){e.name=this.name;var n=this.tags._list;e.tags.clear();for(var r=0;r<n.length;r++)e.tags.add(n[r]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1},t.clone=function(){var e=new this.constructor;return this._cloneInternal(e),e},t.copy=function(e){return e._cloneInternal(this),this},t.destroy=function(){this.remove();for(var e=this._children;e.length;){var n=e.pop();n._parent=null,n.destroy()}this.fire("destroy",this),this.off()},t.find=function(e,n){var r=[],s=Vg(e,n);return this.forEach(function(l){s(l)&&r.push(l)}),r},t.findOne=function(e,n){return function r(s,l){if(l(s))return s;for(var u=s._children,c=u.length,h=0;h<c;++h){var f=r(u[h],l);if(f)return f}return null}(this,Vg(e,n))},t.findByTag=function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];var s=[],l=function(u,c){var h;c&&(h=u.tags).has.apply(h,[].concat(n))&&s.push(u);for(var f=0;f<u._children.length;f++)l(u._children[f],!0)};return l(this,!1),s},t.findByName=function(e){return this.findOne("name",e)},t.findByPath=function(e){for(var n=function(h,f){if(!(s=s.children.find(function(d){return d.name===r[h]})))return{v:null}},r=Array.isArray(e)?e:e.split("/"),s=this,l=0,u=r.length;l<u;++l){var c=n(l);if((c&&typeof Symbol<"u"&&c.constructor===Symbol?"symbol":typeof c)=="object")return c.v}return s},t.forEach=function(e,n){e.call(n,this);for(var r=this._children,s=r.length,l=0;l<s;++l)r[l].forEach(e,n)},t.isDescendantOf=function(e){for(var n=this._parent;n;){if(n===e)return!0;n=n._parent}return!1},t.isAncestorOf=function(e){return e.isDescendantOf(this)},t.getEulerAngles=function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},t.getLocalEulerAngles=function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},t.getLocalPosition=function(){return this.localPosition},t.getLocalRotation=function(){return this.localRotation},t.getLocalScale=function(){return this.localScale},t.getLocalTransform=function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},t.getPosition=function(){return this.getWorldTransform().getTranslation(this.position),this.position},t.getRotation=function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},t.getScale=function(){return this._scale||(this._scale=new E),this.getWorldTransform().getScale(this._scale)},t.getWorldTransform=function(){return(this._dirtyLocal||this._dirtyWorld)&&(this._parent&&this._parent.getWorldTransform(),this._sync()),this.worldTransform},t.remove=function(){var e;(e=this._parent)==null||e.removeChild(this)},t.reparent=function(e,n){this.remove(),e&&(n>=0?e.insertChild(this,n):e.addChild(this))},t.setLocalEulerAngles=function(e,n,r){this.localRotation.setFromEulerAngles(e,n,r),this._dirtyLocal||this._dirtifyLocal()},t.setLocalPosition=function(e,n,r){An(e,E)?this.localPosition.copy(e):this.localPosition.set(e,n,r),this._dirtyLocal||this._dirtifyLocal()},t.setLocalRotation=function(e,n,r,s){An(e,Z)?this.localRotation.copy(e):this.localRotation.set(e,n,r,s),this._dirtyLocal||this._dirtifyLocal()},t.setLocalScale=function(e,n,r){An(e,E)?this.localScale.copy(e):this.localScale.set(e,n,r),this._dirtyLocal||this._dirtifyLocal()},t._dirtifyLocal=function(){!this._dirtyLocal&&(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},t._unfreezeParentToRoot=function(){for(var e=this._parent;e;)e._frozen=!1,e=e._parent},t._dirtifyWorld=function(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()},t._dirtifyWorldInternal=function(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++},t.setPosition=function(e,n,r){An(e,E)?qt.copy(e):qt.set(e,n,r),this._parent===null?this.localPosition.copy(qt):(Oo.copy(this._parent.getWorldTransform()).invert(),Oo.transformPoint(qt,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()},t.setRotation=function(e,n,r,s){if(An(e,Z)?Kt.copy(e):Kt.set(e,n,r,s),this._parent===null)this.localRotation.copy(Kt);else{var l=this._parent.getRotation();Js.copy(l).invert(),this.localRotation.copy(Js).mul(Kt)}this._dirtyLocal||this._dirtifyLocal()},t.setPositionAndRotation=function(e,n){if(this._parent===null)this.localPosition.copy(e),this.localRotation.copy(n);else{var r=this._parent.getWorldTransform();Oo.copy(r).invert(),Oo.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(Oo).mul(n)}this._dirtyLocal||this._dirtifyLocal()},t.setEulerAngles=function(e,n,r){if(this.localRotation.setFromEulerAngles(e,n,r),this._parent!==null){var s=this._parent.getRotation();Js.copy(s).invert(),this.localRotation.mul2(Js,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()},t.addChild=function(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)},t.addChildAndSaveTransform=function(e){var n=e.getPosition(),r=e.getRotation();this._prepareInsertChild(e),e.setPosition(y2.copy(this.worldTransform).invert().transformPoint(n)),e.setRotation(S2.copy(this.getRotation()).invert().mul(r)),this._children.push(e),this._onInsertChild(e)},t.insertChild=function(e,n){this._prepareInsertChild(e),this._children.splice(n,0,e),this._onInsertChild(e)},t._prepareInsertChild=function(e){e.remove()},t._fireOnHierarchy=function(e,n,r){this.fire(e,r);for(var s=0;s<this._children.length;s++)this._children[s]._fireOnHierarchy(n,n,r)},t._onInsertChild=function(e){e._parent=this;var n=e._enabled&&this.enabled;e._enabledInHierarchy!==n&&(e._enabledInHierarchy=n,e._notifyHierarchyStateChanged(e,n)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)},t._updateGraphDepth=function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var e=0,n=this._children.length;e<n;e++)this._children[e]._updateGraphDepth()},t.removeChild=function(e){var n=this._children.indexOf(e);n!==-1&&(this._children.splice(n,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))},t._sync=function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e,n=this._parent,r=this.localScale,s=n;if(s){for(;s&&s.scaleCompensation;)s=s._parent;s&&(s=s._parent)&&(e=s.worldTransform.getScale(),Fg.mul2(e,this.localScale),r=Fg)}zf.setFromMat4(n.worldTransform),Ng.mul2(zf,this.localRotation);var l=n.worldTransform;n.scaleCompensation&&(Ug.mul2(e,n.getLocalScale()),kg.setTRS(n.worldTransform.getTranslation(Vf),zf,Ug),l=kg),l.transformPoint(this.localPosition,Vf),this.worldTransform.setTRS(Vf,Ng,r)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},t.syncHierarchy=function(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,n=0,r=e.length;n<r;n++)e[n].syncHierarchy()}},t.lookAt=function(e,n,r,s,l,u){if(s===void 0&&(s=0),l===void 0&&(l=1),u===void 0&&(u=0),An(e,E))Gf.copy(e),An(n,E)?wu.copy(n):wu.copy(E.UP);else{if(r===void 0)return;Gf.set(e,n,r),wu.set(s,l,u)}Bg.setLookAt(this.getPosition(),Gf,wu),Kt.setFromMat4(Bg),this.setRotation(Kt)},t.translate=function(e,n,r){An(e,E)?qt.copy(e):qt.set(e,n,r),qt.add(this.getPosition()),this.setPosition(qt)},t.translateLocal=function(e,n,r){An(e,E)?qt.copy(e):qt.set(e,n,r),this.localRotation.transformVector(qt,qt),this.localPosition.add(qt),this._dirtyLocal||this._dirtifyLocal()},t.rotate=function(e,n,r){if(Kt.setFromEulerAngles(e,n,r),this._parent===null)this.localRotation.mul2(Kt,this.localRotation);else{var s=this.getRotation(),l=this._parent.getRotation();Js.copy(l).invert(),Kt.mul2(Js,Kt),this.localRotation.mul2(Kt,s)}this._dirtyLocal||this._dirtifyLocal()},t.rotateLocal=function(e,n,r){Kt.setFromEulerAngles(e,n,r),this.localRotation.mul(Kt),this._dirtyLocal||this._dirtifyLocal()},i=[{key:"right",get:function(){return this._right||(this._right=new E),this.getWorldTransform().getX(this._right).normalize()}},{key:"up",get:function(){return this._up||(this._up=new E),this.getWorldTransform().getY(this._up).normalize()}},{key:"forward",get:function(){return this._forward||(this._forward=new E),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}},{key:"normalMatrix",get:function(){var e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}},{key:"enabled",get:function(){return this._enabled&&this._enabledInHierarchy},set:function(e){if(this._enabled!==e){var n;this._enabled=e,(e&&((n=this._parent)!=null&&n.enabled)||!e)&&this._notifyHierarchyStateChanged(this,e)}}},{key:"parent",get:function(){return this._parent}},{key:"path",get:function(){var e=this._parent;if(!e)return"";for(var n=this.name;e&&e._parent;)n=e.name+"/"+n,e=e._parent;return n}},{key:"root",get:function(){for(var e=this;e._parent;)e=e._parent;return e}},{key:"children",get:function(){return this._children}},{key:"graphDepth",get:function(){return this._graphDepth}},{key:"worldScaleSign",get:function(){return this._worldScaleSign===0&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se),zg=new X,Gg=new X,Hg=new X,$s=function(){function o(){}return o.create=function(a,i,t){var e=new Eu;switch(e.node=new pe(a),e.aspectRatio=1,e.aspectRatioMode=1,e._scissorRectClear=!0,i){case 1:e.node.setRotation(o.pointLightRotations[t]),e.fov=90,e.projection=0;break;case 2:e.projection=0;break;case 0:e.projection=1}return e},o.evalSpotCookieMatrix=function(a){var i=o._spotCookieCamera;i||(i=o.create("SpotCookieCamera",2),o._spotCookieCamera=i),i.fov=2*a._outerConeAngle;var t=i._node;t.setPosition(a._node.getPosition()),t.setRotation(a._node.getRotation()),t.rotateLocal(-90,0,0),zg.setTRS(t.getPosition(),t.getRotation(),E.ONE).invert(),Gg.mul2(i.projectionMatrix,zg);var e=a.cookieMatrix,n=a.atlasViewport;return Hg.setViewport(n.x,n.y,n.z,n.w),e.mul2(Hg,Gg),e},o}();$s.pointLightRotations=[new Z().setFromEulerAngles(0,90,180),new Z().setFromEulerAngles(0,-90,180),new Z().setFromEulerAngles(90,0,0),new Z().setFromEulerAngles(-90,0,0),new Z().setFromEulerAngles(0,180,180),new Z().setFromEulerAngles(0,0,180)],$s._spotCookieCamera=null;var pn=new E,Hr=new Float32Array(6),x2=new E(-.5,0,0),b2=new E(0,0,.5),Ge={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},Wg=function(o,a){return Object.keys(o).map(function(i){return"#define {"+a+i+"} "+o[i]}).join(`
`)},jg=`

    `+Wg(Ge,"CLUSTER_TEXTURE_")+`
    `+Wg({LIGHTSHAPE_PUNCTUAL:"0u",LIGHTSHAPE_RECT:"1u",LIGHTSHAPE_DISK:"2u",LIGHTSHAPE_SPHERE:"3u",LIGHT_COLOR_DIVIDER:"100.0"},"")+`
`,T2=function(){function o(i){this.areaLightsEnabled=!1,this.device=i,re.get(i,ue).set("lightBufferDefinesPS",jg),re.get(i,he).set("lightBufferDefinesPS",jg),this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;var t=Ge.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,14,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new E,this.boundsDelta=new E}var a=o.prototype;return a.destroy=function(){var i;(i=this.lightsTexture)==null||i.destroy(),this.lightsTexture=null},a.createTexture=function(i,t,e,n,r){return new ee(i,{name:r,width:t,height:e,mipmaps:!1,format:n,addressU:1,addressV:1,type:Wt,magFilter:0,minFilter:0,anisotropy:1})},a.setBounds=function(i,t){this.boundsMin.copy(i),this.boundsDelta.copy(t)},a.uploadTextures=function(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock()},a.updateUniforms=function(){this._lightsTextureId.setValue(this.lightsTexture)},a.getSpotDirection=function(i,t){t._node.getWorldTransform().getY(i).mulScalar(-1),i.normalize()},a.getLightAreaSizes=function(i){var t=i._node.getWorldTransform();return t.transformVector(x2,pn),Hr[0]=pn.x,Hr[1]=pn.y,Hr[2]=pn.z,t.transformVector(b2,pn),Hr[3]=pn.x,Hr[4]=pn.y,Hr[5]=pn.z,Hr},a.addLightData=function(i,t){var e=i._type===2,n=i.atlasViewportAllocated,r=this.cookiesEnabled&&!!i._cookie&&n,s=this.areaLightsEnabled&&i.shape!==0,l=this.shadowsEnabled&&i.castShadows&&n,u=i._node.getPosition(),c=null,h=null;e?l?c=i.getRenderData(null,0).shadowMatrix:r&&(c=$s.evalSpotCookieMatrix(i)):(l||r)&&(h=i.atlasViewport);var f=this.lightsFloat,d=this.lightsUint,p=t*this.lightsTexture.width*4;f[p+4*Ge.POSITION_RANGE+0]=u.x,f[p+4*Ge.POSITION_RANGE+1]=u.y,f[p+4*Ge.POSITION_RANGE+2]=u.z,f[p+4*Ge.POSITION_RANGE+3]=i.attenuationEnd;var _=i.clusteredData;if(d[p+4*Ge.COLOR_ANGLES_BIAS+0]=_[0],d[p+4*Ge.COLOR_ANGLES_BIAS+1]=_[1],d[p+4*Ge.COLOR_ANGLES_BIAS+2]=_[2],i.castShadows){var g=i.getRenderData(null,0),y=i._getUniformBiasValues(g),v=pi.float2Half(y.bias),x=pi.float2Half(y.normalBias);d[p+4*Ge.COLOR_ANGLES_BIAS+3]=v|x<<16}if(e&&(this.getSpotDirection(pn,i),f[p+4*Ge.DIRECTION_FLAGS+0]=pn.x,f[p+4*Ge.DIRECTION_FLAGS+1]=pn.y,f[p+4*Ge.DIRECTION_FLAGS+2]=pn.z),d[p+4*Ge.DIRECTION_FLAGS+3]=i.getClusteredFlags(l,r),c)for(var S=c.data,T=0;T<16;T++)f[p+4*Ge.PROJ_MAT_0+T]=S[T];if(h&&(f[p+4*Ge.ATLAS_VIEWPORT+0]=h.x,f[p+4*Ge.ATLAS_VIEWPORT+1]=h.y,f[p+4*Ge.ATLAS_VIEWPORT+2]=h.z/3),s){var b=this.getLightAreaSizes(i);f[p+4*Ge.AREA_DATA_WIDTH+0]=b[0],f[p+4*Ge.AREA_DATA_WIDTH+1]=b[1],f[p+4*Ge.AREA_DATA_WIDTH+2]=b[2],f[p+4*Ge.AREA_DATA_HEIGHT+0]=b[3],f[p+4*Ge.AREA_DATA_HEIGHT+1]=b[4],f[p+4*Ge.AREA_DATA_HEIGHT+2]=b[5]}},o}(),Au=new E,Cu=new E,Pu=new E,Hf=new Se,Xg=function(){this.light=null,this.min=new E,this.max=new E},Iu=function(){function o(t){this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new E,this.boundsMax=new E,this.boundsDelta=new E,this._cells=new E(1,1,1),this._cellsLimit=new E,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new Xg),this.lightsBuffer=new T2(t),this.registerUniforms(t)}var a,i=o.prototype;return i.destroy=function(){this.lightsBuffer.destroy(),this.releaseClusterTexture()},i.releaseClusterTexture=function(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)},i.registerUniforms=function(t){this._clusterSkipId=t.scope.resolve("clusterSkip"),this._clusterMaxCellsId=t.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3)},i.updateParams=function(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)},i.updateCells=function(){if(this._cellsDirty){this._cellsDirty=!1;var t=this._cells.x,e=this._cells.y,n=this._cells.z,r=t*e*n,s=this.maxCellLightCount*r,l=Math.ceil(Math.sqrt(s)),u=Math.ceil(s/(l=U.roundUp(l,this.maxCellLightCount)));this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=n,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=t*n*this.maxCellLightCount,this._clusterCellsDotData[2]=t*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(s),this.counts=new Int32Array(r),this._clusterTextureSizeData[0]=l,this._clusterTextureSizeData[1]=1/l,this._clusterTextureSizeData[2]=1/u,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,l,u,52,"ClusterTexture")}},i.uploadTextures=function(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()},i.updateUniforms=function(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);var t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData)},i.evalLightCellMinMax=function(t,e,n){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),n.copy(t.max),n.sub(this.boundsMin),n.div(this.boundsDelta),n.mul2(n,this.cells),n.ceil(),e.max(E.ZERO),n.min(this._cellsLimit)},i.collectLights=function(t){var e=this.lightsBuffer.maxLights,n=this._usedLights,r=1;t.forEach(function(s){var l,u=!!(3&s.mask),c=s.type===2&&s._outerConeAngle===0;s.enabled&&s.type!==0&&s.visibleThisFrame&&s.intensity>0&&u&&!c&&r<e&&(r<n.length?l=n[r]:(l=new Xg,n.push(l)),l.light=s,s.getBoundingBox(Hf),l.min.copy(Hf.getMin()),l.max.copy(Hf.getMax()),r++)}),n.length=r},i.evaluateBounds=function(){var t=this._usedLights,e=this.boundsMin,n=this.boundsMax;if(t.length>1){e.copy(t[1].min),n.copy(t[1].max);for(var r=2;r<t.length;r++)e.min(t[r].min),n.max(t[r].max)}else e.set(0,0,0),n.set(1,1,1);this.boundsDelta.sub2(n,e),this.lightsBuffer.setBounds(e,this.boundsDelta)},i.updateClusters=function(t){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!t&&t.areaLightsEnabled;for(var e=this._cells.x,n=this._cells.z,r=this.counts,s=this._maxCellLightCount,l=this.clusters,u=this.maxCellLightCount,c=this._usedLights,h=1;h<c.length;h++){var f=c[h],d=f.light;this.lightsBuffer.addLightData(d,h),this.evalLightCellMinMax(f,Cu,Pu);for(var p=Cu.x,_=Pu.x,g=Cu.y,y=Pu.y,v=Cu.z,x=Pu.z,S=p;S<=_;S++)for(var T=v;T<=x;T++)for(var b=g;b<=y;b++){var w=S+e*(T+b*n),A=r[w];A<s&&(l[u*w+A]=h,r[w]=A+1)}}},i.update=function(t,e){e===void 0&&(e=null),this.updateParams(e),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.updateClusters(e),this.uploadTextures()},i.activate=function(){this.updateUniforms()},a=[{key:"maxCellLightCount",get:function(){return this._maxCellLightCount},set:function(t){t!==this._maxCellLightCount&&(this._maxCellLightCount=t,this._cellsDirty=!0)}},{key:"cells",get:function(){return this._cells},set:function(t){Au.copy(t).floor(),this._cells.equals(Au)||(this._cells.copy(Au),this._cellsLimit.copy(Au).sub(E.ONE),this._cellsDirty=!0)}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),wi=null,Yg=function(){if(!wi){var o=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");wi=Uint8Array.from(o,function(a){return a.charCodeAt(0)})}},qg=function(){function o(i){i===void 0&&(i=0),this.seed=0,this.seed=4*i,Yg()}var a=o.prototype;return a._next=function(){this.seed=(this.seed+4)%wi.length},a.value=function(){return this._next(),wi[this.seed]/255},a.vec4=function(i){return i===void 0&&(i=new q),this._next(),i.set(wi[this.seed],wi[this.seed+1],wi[this.seed+2],wi[this.seed+3]).mulScalar(1/255)},o}(),E2=[new E(-1,0,0),new E(1,0,0),new E(0,-1,0),new E(0,1,0),new E(0,0,-1),new E(0,0,1)],w2=function(){function o(){this.colors=new Float32Array(18)}return o.prototype.update=function(a,i){for(var t=this.colors,e=a.r,n=a.g,r=a.b,s=0;s<6;s++)t[3*s]=e,t[3*s+1]=n,t[3*s+2]=r;for(var l=0;l<i.length;l++){var u=i[l];if(u._type===0)for(var c=0;c<6;c++){var h=Math.max(E2[c].dot(u._direction),0)*u._intensity,f=u._color;t[3*c]+=f.r*h,t[3*c+1]+=f.g*h,t[3*c+2]+=f.b*h}}},o}(),A2=function(o,a,i,t){var e=new ee(o,{name:""+a+i,width:i,height:i,format:7,addressU:0,addressV:0,type:Wt,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return e.lock().set(t),e.unlock(),e},C2=new It,Lu=function(){function o(a,i){this.texture=a,this.cached=!1,this.renderTargets=i}return o.prototype.destroy=function(){this.texture&&(this.texture.destroy(),this.texture=null);for(var a=this.renderTargets,i=0;i<a.length;i++)a[i].destroy();this.renderTargets.length=0},o.create=function(a,i){return i._type===1?this.createCubemap(a,i._shadowResolution,i._shadowType):this.create2dMap(a,i._shadowResolution,i._shadowType)},o.createAtlas=function(a,i,t){for(var e=this.create2dMap(a,i,t),n=e.renderTargets,r=n[0],s=0;s<5;s++)n.push(r);return e},o.create2dMap=function(a,i,t){var e,n=qn.get(t),r=n.format;r===15&&!a.textureFloatRenderable&&a.textureHalfFloatRenderable&&(r=50);var s=(e=Ht.get(r))==null?void 0:e.name,l=1;t===3&&(l=+!!a.extTextureFloatLinear),t===6&&(l=0);var u=new ee(a,{format:r,width:i,height:i,mipmaps:!1,minFilter:l,magFilter:l,addressU:1,addressV:1,name:"ShadowMap2D_"+s}),c=null;return n!=null&&n.pcf?(u.compareOnRead=!0,u.compareFunc=1,c=new Ee({depthBuffer:u})):c=new Ee({colorBuffer:u,depth:!0}),a.isWebGPU&&(c.flipY=!0),new o(u,[c])},o.createCubemap=function(a,i,t){var e,n=qn.get(t),r=(e=Ht.get(n.format))==null?void 0:e.name,s=t===6,l=+!s,u=new ee(a,{format:n==null?void 0:n.format,width:i,height:i,cubemap:!0,mipmaps:!1,minFilter:l,magFilter:l,addressU:1,addressV:1,name:"ShadowMapCube_"+r});s||(u.compareOnRead=!0,u.compareFunc=1);for(var c=[],h=0;h<6;h++)s?c.push(new Ee({colorBuffer:u,face:h,depth:!0})):c.push(new Ee({depthBuffer:u,face:h}));return new o(u,c)},o}(),ko=[],P2=[],Ai=new q,Wf=new q,jf=function(o){this.size=Math.floor(1024*o.w),this.used=!1,this.lightId=-1,this.rect=o},I2=function(){function o(i){this.device=i,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new ee(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:20,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new Ee({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new G(0,0),new G(0,1),new G(1,0),new G(1,1),new G(2,0),new G(2,1)],this.scissorVec=new q,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}var a=o.prototype;return a.destroy=function(){this.destroyShadowAtlas(),this.destroyCookieAtlas()},a.destroyShadowAtlas=function(){var i;(i=this.shadowAtlas)==null||i.destroy(),this.shadowAtlas=null},a.destroyCookieAtlas=function(){var i,t;(i=this.cookieAtlas)==null||i.destroy(),this.cookieAtlas=null,(t=this.cookieRenderTarget)==null||t.destroy(),this.cookieRenderTarget=null},a.allocateShadowAtlas=function(i,t){t===void 0&&(t=0);var e,n=(e=this.shadowAtlas)==null?void 0:e.texture.format,r=qn.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==i||n!==r){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=Lu.createAtlas(this.device,i,t),this.shadowAtlas.cached=!0;var s=4/this.shadowAtlasResolution;this.scissorVec.set(s,s,-2*s,-2*s)}},a.allocateCookieAtlas=function(i){this.cookieAtlas.width!==i&&(this.cookieRenderTarget.resize(i,i),this.version++)},a.allocateUniforms=function(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")},a.updateUniforms=function(){var i=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(i),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)},a.subdivide=function(i,t){var e=t.atlasSplit;if(!e){var n=Math.ceil(Math.sqrt(i));(e=P2)[0]=n,e.length=1}if(r=e,s=this.atlasSplit,!(r.length===s.length&&r.every(function(x,S){return x===s[S]}))){this.version++,this.slots.length=0,this.atlasSplit.length=0,(l=this.atlasSplit).push.apply(l,[].concat(e));var r,s,l,u=this.atlasSplit[0];if(u>1)for(var c=1/u,h=0;h<u;h++)for(var f=0;f<u;f++){var d=new q(h*c,f*c,c,c),p=this.atlasSplit[1+h*u+f];if(p>1)for(var _=0;_<p;_++)for(var g=0;g<p;g++){var y=c/p,v=new q(d.x+_*y,d.y+g*y,y,y);this.slots.push(new jf(v))}else this.slots.push(new jf(d))}else this.slots.push(new jf(new q(0,0,1,1)));this.slots.sort(function(x,S){return S.size-x.size})}},a.collectLights=function(i,t){var e=t.cookiesEnabled,n=t.shadowsEnabled,r=!1,s=!1;return ko.length=0,(e||n)&&function(l){for(var u=0;u<l.length;u++){var c=l[u];if(c.visibleThisFrame){var h=n&&c.castShadows,f=e&&!!c.cookie;r||(r=h),s||(s=f),(h||f)&&ko.push(c)}}}(i),ko.sort(function(l,u){return u.maxScreenSize-l.maxScreenSize}),r&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),s&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||s)&&this.subdivide(ko.length,t),ko},a.setupSlot=function(i,t){i.atlasViewport.copy(t);for(var e=i.numShadowFaces,n=0;n<e;n++)if(i.castShadows||i._cookie){if(Ai.copy(t),Wf.copy(t),i._type===2&&Ai.add(this.scissorVec),i._type===1){var r=Ai.z/3,s=this.cubeSlotsOffsets[n];Ai.x+=r*s.x,Ai.y+=r*s.y,Ai.z=r,Ai.w=r,Wf.copy(Ai)}if(i.castShadows){var l=i.getRenderData(null,n);l.shadowViewport.copy(Ai),l.shadowScissor.copy(Wf)}}},a.assignSlot=function(i,t,e){i.atlasViewportAllocated=!0;var n=this.slots[t];n.lightId=i.id,n.used=!0,e&&(i.atlasSlotUpdated=!0,i.atlasVersion=this.version,i.atlasSlotIndex=t)},a.update=function(i,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;var e=this.collectLights(i,t);if(e.length>0){for(var n=this.slots,r=0;r<n.length;r++)n[r].used=!1;for(var s=Math.min(e.length,n.length),l=0;l<s;l++){var u=e[l];u.castShadows&&(u._shadowMap=this.shadowAtlas);var c=n[u.atlasSlotIndex];if(u.atlasVersion===this.version&&u.id===(c==null?void 0:c.lightId)){var h=n[u.atlasSlotIndex];h.size!==n[l].size||h.used||this.assignSlot(u,u.atlasSlotIndex,!1)}}for(var f=0,d=0;d<s;d++){for(;f<n.length&&n[f].used;)f++;var p=e[d];p.atlasViewportAllocated||this.assignSlot(p,f,!0);var _=n[p.atlasSlotIndex];this.setupSlot(p,_.rect)}}this.updateUniforms()},o}();function Kg(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}var Nt=[];Nt[0]={src:1,dst:1,op:2},Nt[3]={src:1,dst:0,op:0},Nt[2]={src:6,dst:8,op:0,alphaSrc:1},Nt[4]={src:1,dst:8,op:0},Nt[1]={src:1,dst:1,op:0},Nt[6]={src:6,dst:1,op:0},Nt[7]={src:4,dst:2,op:0},Nt[8]={src:5,dst:1,op:0},Nt[5]={src:4,dst:0,op:0},Nt[9]={src:1,dst:1,op:3},Nt[10]={src:1,dst:1,op:4};var L2=0,Ci=function(){function o(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=L2++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new ge,this._depthState=new Xe,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderChunks=null,this._oldChunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0,(o!=null&&typeof Symbol<"u"&&o[Symbol.hasInstance]?o[Symbol.hasInstance](this):Q(this,o))&&this.constructor}var a,i=o.prototype;return i.getShaderChunks=function(t){t===void 0&&(t=ue);var e=this.shaderChunks;return t===ue?e.glsl:e.wgsl},i._updateTransparency=function(){for(var t=this.transparent,e=this.meshInstances,n=0;n<e.length;n++)e[n].transparent=t},i.copy=function(t){var e,n,r=this;for(var s in this.name=t.name,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this._blendState.copy(t._blendState),this._depthState.copy(t._depthState),this.cull=t.cull,this.stencilFront=(e=t.stencilFront)==null?void 0:e.clone(),t.stencilBack&&(this.stencilBack=t.stencilFront===t.stencilBack?this.stencilFront:t.stencilBack.clone()),this.clearParameters(),t.parameters)t.parameters.hasOwnProperty(s)&&this._setParameterSimple(s,t.parameters[s].data);return this.defines.clear(),t.defines.forEach(function(l,u){return r.defines.set(u,l)}),this._shaderChunks=t.hasShaderChunks?new re:null,(n=this._shaderChunks)==null||n.copy(t._shaderChunks),this},i.clone=function(){return new this.constructor().copy(this)},i._updateMeshInstanceKeys=function(){for(var t=this.meshInstances,e=0;e<t.length;e++)t[e].updateKey()},i.updateUniforms=function(t,e){this._dirtyShader&&this.clearVariants()},i.getShaderVariant=function(t){},i.update=function(){if(Object.keys(this._oldChunks).length>0)for(var t,e,n,r=function(c,h){var f=typeof Symbol<"u"&&c[Symbol.iterator]||c["@@iterator"];if(f)return(f=f.call(c)).next.bind(f);if(Array.isArray(c)||(f=function(p,_){if(p){if(typeof p=="string")return Kg(p,void 0);var g=Object.prototype.toString.call(p).slice(8,-1);if(g==="Object"&&p.constructor&&(g=p.constructor.name),g==="Map"||g==="Set")return Array.from(g);if(g==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(g))return Kg(p,void 0)}}(c))){f&&(c=f);var d=0;return function(){return d>=c.length?{done:!0}:{done:!1,value:c[d++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Object.entries(this._oldChunks));!(n=r()).done;){var s=n.value,l=s[0],u=s[1];this.shaderChunks.glsl.set(l,u),delete this._oldChunks[l]}(this._definesDirty||(e=this._shaderChunks)!=null&&e.isDirty())&&(this._definesDirty=!1,(t=this._shaderChunks)==null||t.resetDirty(),this.clearVariants()),this.dirty=!0},i.clearParameters=function(){this.parameters={}},i.getParameters=function(){return this.parameters},i.clearVariants=function(){this.variants.clear();for(var t=this.meshInstances,e=t.length,n=0;n<e;n++)t[n].clearShaders()},i.getParameter=function(t){return this.parameters[t]},i._setParameterSimple=function(t,e){var n=this.parameters[t];n?n.data=e:this.parameters[t]={scopeId:null,data:e}},i.setParameter=function(t,e){var n;if(e===void 0&&(t===void 0?"undefined":(n=t)&&typeof Symbol<"u"&&n.constructor===Symbol?"symbol":typeof n)=="object"){var r=t;if(r.length){for(var s=0;s<r.length;s++)this.setParameter(r[s]);return}t=r.name,e=r.value}this._setParameterSimple(t,e)},i.deleteParameter=function(t){this.parameters[t]&&delete this.parameters[t]},i.setParameters=function(t,e){var n=this.parameters;for(var r in e===void 0&&(e=n),e){var s=n[r];s&&(s.scopeId||(s.scopeId=t.scope.resolve(r)),s.scopeId.setValue(s.data))}},i.setDefine=function(t,e){var n=!1,r=this.defines;e!==void 0&&e!==!1?(n=!r.has(t)||r.get(t)!==e,r.set(t,e)):(n=r.has(t),r.delete(t)),this._definesDirty||(this._definesDirty=n)},i.getDefine=function(t){return this.defines.has(t)},i.destroy=function(){this.variants.clear();for(var t=0;t<this.meshInstances.length;t++){var e=this.meshInstances[t];if(e.clearShaders(),e._material=null,e.mesh){var n=Ks(e.mesh.device);this!==n&&(e.material=n)}}this.meshInstances.length=0},i.addMeshInstanceRef=function(t){this.meshInstances.push(t)},i.removeMeshInstanceRef=function(t){var e=this.meshInstances,n=e.indexOf(t);n!==-1&&e.splice(n,1)},a=[{key:"hasShaderChunks",get:function(){return this._shaderChunks!=null}},{key:"shaderChunks",get:function(){return this._shaderChunks||(this._shaderChunks=new re),this._shaderChunks}},{key:"shaderChunksVersion",get:function(){return this.shaderChunks.version},set:function(t){this.shaderChunks.version=t}},{key:"chunks",get:function(){return Object.assign(this._oldChunks,Object.fromEntries(this.shaderChunks.glsl)),this._oldChunks},set:function(t){this._oldChunks=t}},{key:"depthBias",get:function(){return this._depthState.depthBias},set:function(t){this._depthState.depthBias=t}},{key:"slopeDepthBias",get:function(){return this._depthState.depthBiasSlope},set:function(t){this._depthState.depthBiasSlope=t}},{key:"redWrite",get:function(){return this._blendState.redWrite},set:function(t){this._blendState.redWrite=t}},{key:"greenWrite",get:function(){return this._blendState.greenWrite},set:function(t){this._blendState.greenWrite=t}},{key:"blueWrite",get:function(){return this._blendState.blueWrite},set:function(t){this._blendState.blueWrite=t}},{key:"alphaWrite",get:function(){return this._blendState.alphaWrite},set:function(t){this._blendState.alphaWrite=t}},{key:"transparent",get:function(){return this._blendState.blend}},{key:"blendState",get:function(){return this._blendState},set:function(t){this._blendState.copy(t),this._updateTransparency()}},{key:"blendType",get:function(){if(!this.transparent)return 3;for(var t=this._blendState,e=t.colorOp,n=t.colorSrcFactor,r=t.colorDstFactor,s=t.alphaOp,l=t.alphaSrcFactor,u=t.alphaDstFactor,c=0;c<Nt.length;c++){var h=Nt[c];if(h.src===n&&h.dst===r&&h.op===e&&h.src===l&&h.dst===u&&h.op===s)return c}return 2},set:function(t){var e,n,r,s=Nt[t];this._blendState.setColorBlend(s.op,s.src,s.dst),this._blendState.setAlphaBlend((e=s.alphaOp)!=null?e:s.op,(n=s.alphaSrc)!=null?n:s.src,(r=s.alphaDst)!=null?r:s.dst);var l=t!==3;this._blendState.blend!==l&&(this._blendState.blend=l,this._updateTransparency()),this._updateMeshInstanceKeys()}},{key:"depthState",get:function(){return this._depthState},set:function(t){this._depthState.copy(t)}},{key:"depthTest",get:function(){return this._depthState.test},set:function(t){this._depthState.test=t}},{key:"depthFunc",get:function(){return this._depthState.func},set:function(t){this._depthState.func=t}},{key:"depthWrite",get:function(){return this._depthState.write},set:function(t){this._depthState.write=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),D2=function(){function o(){this.cache=new Map}var a=o.prototype;return a.destroy=function(){this.clear(),this.cache=null},a.clear=function(){this.cache.forEach(function(i){i.forEach(function(t){t.destroy()})}),this.cache.clear()},a.getKey=function(i){return(i._type===1)+"-"+i._shadowType+"-"+i._shadowResolution},a.get=function(i,t){var e=this.getKey(t),n=this.cache.get(e);if(n&&n.length)return n.pop();var r=Lu.create(i,t);return r.cached=!0,r},a.add=function(i,t){var e=this.getKey(i),n=this.cache.get(e);n?n.push(t):this.cache.set(e,[t])},o}();function Zg(o,a){return(Zg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var M2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s){var l;return(l=o.call(this,t)||this).requiresCubemaps=!1,l.shadowRenderer=e,l.light=n,l.face=r,l.applyVsm=s,l.shadowCamera=e.prepareFace(n,null,r),e.setupRenderPass(l,l.shadowCamera,!0),l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Zg(a,o);var i=a.prototype;return i.execute=function(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)},i.after=function(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)},a}(ct),R2=function(){function o(i,t){this.shadowLights=[],this.renderer=i,this.shadowRenderer=t,this.device=i.device}var a=o.prototype;return a.cull=function(i,t,e){e===void 0&&(e=null);var n=this.renderer.scene.clusteredLightingEnabled;i.visibleThisFrame=!0,n||i._shadowMap||(i._shadowMap=Lu.create(this.device,i));for(var r=i._type,s=r===2?1:6,l=0;l<s;l++){var u=i.getRenderData(null,l),c=u.shadowCamera;c.nearClip=i.attenuationEnd/1e3,c.farClip=i.attenuationEnd;var h=c._node,f=i._node;h.setPosition(f.getPosition()),r===2?(c.fov=2*i._outerConeAngle,h.setRotation(f.getRotation()),h.rotateLocal(-90,0,0)):r===1&&(n?c.fov=Math.atan(1+2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*i.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels)*U.RAD_TO_DEG*2:c.fov=90),this.renderer.updateCameraFrustum(c),this.shadowRenderer.cullShadowCasters(t,i,u.visibleCasters,c,e)}},a.prepareLights=function(i,t){for(var e,n=0;n<t.length;n++){var r=t[n];if(this.shadowRenderer.needsShadowRendering(r)&&r.atlasViewportAllocated){i.push(r);for(var s=0;s<r.numShadowFaces;s++)e=this.shadowRenderer.prepareFace(r,null,s)}}return e},a.buildNonClusteredRenderPasses=function(i,t){for(var e=0;e<t.length;e++){var n=t[e];if(this.shadowRenderer.needsShadowRendering(n))for(var r=n._type===2,s=n.numShadowFaces,l=0;l<s;l++){var u=new M2(this.device,this.shadowRenderer,n,l,r);i.addRenderPass(u)}}},o}();function Qg(o,a){return(Qg=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var O2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s){var l;return(l=o.call(this,t)||this).shadowRenderer=e,l.light=n,l.camera=r,l.allCascadesRendering=s,l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Qg(a,o);var i=a.prototype;return i.execute=function(){for(var t=this.light,e=this.camera,n=this.shadowRenderer,r=this.allCascadesRendering,s=t.numShadowFaces,l=t.shadowUpdateOverrides,u=0;u<s;u++)(l==null?void 0:l[u])!==0&&n.renderFace(t,e,u,!r),(l==null?void 0:l[u])===1&&(l[u]=0)},i.after=function(){this.shadowRenderer.renderVsm(this.light,this.camera)},a}(ct),Du=new Se,Pi=new E,Jg=new X,Ne=[new E,new E,new E,new E,new E,new E,new E,new E],Xf={min:0,max:0},k2=function(){function o(i,t){this.renderer=i,this.shadowRenderer=t,this.device=i.device}var a=o.prototype;return a.cull=function(i,t,e,n){n===void 0&&(n=null),i.visibleThisFrame=!0,i._shadowMap||(i._shadowMap=Lu.create(this.device,i));var r=e._nearClip;this.generateSplitDistances(i,r,Math.min(e._farClip,i.shadowDistance));for(var s=i.shadowUpdateOverrides,l=0;l<i.numCascades&&(s==null?void 0:s[l])!==0;l++){var u=i.getRenderData(e,l),c=u.shadowCamera;c.renderTarget=i._shadowMap.renderTargets[0],u.shadowViewport.copy(i.cascades[l]),u.shadowScissor.copy(i.cascades[l]);var h=c._node,f=i._node;h.setPosition(f.getPosition()),h.setRotation(f.getRotation()),h.rotateLocal(-90,0,0);var d=l===0?r:i._shadowCascadeDistances[l-1],p=i._shadowCascadeDistances[l],_=e.getFrustumCorners(d,p);Pi.set(0,0,0);for(var g=e.node.getWorldTransform(),y=0;y<8;y++)g.transformPoint(_[y],_[y]),Pi.add(_[y]);Pi.mulScalar(1/8);for(var v=0,x=0;x<8;x++){var S=_[x].sub(Pi).length();S>v&&(v=S)}var T=h.right,b=h.up,w=h.forward,A=.25*i._shadowResolution/v,C=Math.ceil(Pi.dot(b)*A)/A,L=Math.ceil(Pi.dot(T)*A)/A,I=b.mulScalar(C),P=T.mulScalar(L),M=Pi.dot(w),R=w.mulScalar(M);Pi.add2(I,P).add(R),h.setPosition(Pi),h.translateLocal(0,0,1e6),c.nearClip=.01,c.farClip=2e6,c.orthoHeight=v,this.renderer.updateCameraFrustum(c),this.shadowRenderer.cullShadowCasters(t,i,u.visibleCasters,c,n);for(var k=!0,D=u.visibleCasters,O=0;O<D.length;O++){var F=D[O];k?(k=!1,Du.copy(F.aabb)):Du.add(F.aabb)}Jg.copy(h.getWorldTransform()).invert();var N=function(j,z,V){Ne[0].x=Ne[1].x=Ne[2].x=Ne[3].x=z.x,Ne[1].y=Ne[3].y=Ne[7].y=Ne[5].y=z.y,Ne[2].z=Ne[3].z=Ne[6].z=Ne[7].z=z.z,Ne[4].x=Ne[5].x=Ne[6].x=Ne[7].x=V.x,Ne[0].y=Ne[2].y=Ne[4].y=Ne[6].y=V.y,Ne[0].z=Ne[1].z=Ne[4].z=Ne[5].z=V.z;for(var H=9999999999,Y=-9999999999,W=0;W<8;++W){j.transformPoint(Ne[W],Ne[W]);var ie=Ne[W].z;ie<H&&(H=ie),ie>Y&&(Y=ie)}return Xf.min=H,Xf.max=Y,Xf}(Jg,Du.getMin(),Du.getMax());h.translateLocal(0,0,N.max+.1),c.farClip=N.max-N.min+.2,u.projectionCompensation=v}},a.generateSplitDistances=function(i,t,e){i._shadowCascadeDistances.fill(e);for(var n=1;n<i.numCascades;n++){var r=n/i.numCascades,s=t+(e-t)*r,l=t*Math.pow(e/t,r),u=U.lerp(s,l,i.cascadeDistribution);i._shadowCascadeDistances[n-1]=u}},a.getLightRenderPass=function(i,t){var e=null;if(this.shadowRenderer.needsShadowRendering(i)){for(var n,r=i.numShadowFaces,s=i.shadowUpdateOverrides,l=!0,u=0;u<r;u++)(s==null?void 0:s[u])===0&&(l=!1),n=this.shadowRenderer.prepareFace(i,t,u);e=new O2(this.device,this.shadowRenderer,i,t,l),this.shadowRenderer.setupRenderPass(e,n,l)}return e},o}(),Yf=new Set,$g=new X,ey=new X,Wr=new Float32Array(2),No=new q(1,1,0,0),ty=new X,ny=function(){function o(i,t){this.shadowPassCache=[],this.device=i.device,this.renderer=i,this.lightTextureAtlas=t;var e=this.device.scope;this.sourceId=e.resolve("source"),this.pixelOffsetId=e.resolve("pixelOffset"),this.weightId=e.resolve("weight[0]"),this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=e.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new ge,this.blendStateNoWrite=new ge,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}var a=o.prototype;return a._cullShadowCastersInternal=function(i,t,e){for(var n=i.length,r=0;r<n;r++){var s=i[r];s.castShadow&&(!s.cull||s._isVisible(e))&&(s.visibleThisFrame=!0,t.push(s))}},a.cullShadowCasters=function(i,t,e,n,r){if(e.length=0,r)this._cullShadowCastersInternal(r,e,n);else{for(var s=i.layerList,l=s.length,u=0;u<l;u++){var c=s[u];c._lightsSet.has(t)&&!Yf.has(c)&&(Yf.add(c),this._cullShadowCastersInternal(c.shadowCasters,e,n))}Yf.clear()}e.sort(this.sortCompareShader)},a.sortCompareShader=function(i,t){var e=i._sortKeyShadow,n=t._sortKeyShadow;return e===n?t.mesh.id-i.mesh.id:n-e},a.setupRenderState=function(i,t){var e=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&t._type!==1;i.setBlendState(e?this.blendStateNoWrite:this.blendStateWrite),i.setDepthState(t.shadowDepthState),i.setStencilState(null,null)},a.dispatchUniforms=function(i,t,e,n){var r=t._node;i._type!==0&&(this.renderer.dispatchViewPos(r.getPosition()),this.shadowMapLightRadiusId.setValue(i.attenuationEnd)),$g.setTRS(r.getPosition(),r.getRotation(),E.ONE).invert(),ey.mul2(t.projectionMatrix,$g);var s=e.shadowViewport;t.rect=s,t.scissorRect=e.shadowScissor,ty.setViewport(s.x,s.y,s.z,s.w),e.shadowMatrix.mul2(ty,ey),i._type===0&&i._shadowMatrixPalette.set(e.shadowMatrix.data,16*n)},a.getShadowPass=function(i){var t,e=i._type,n=i._shadowType,r=(t=this.shadowPassCache[e])==null?void 0:t[n];return r||(r=Ti.get(this.device).allocate("ShadowPass_"+e+"_"+n,{isShadow:!0,lightType:e,shadowType:n}),this.shadowPassCache[e]||(this.shadowPassCache[e]=[]),this.shadowPassCache[e][n]=r),r.index},a.submitCasters=function(i,t,e){for(var n=this.device,r=this.renderer,s=r.scene,l=this.getShadowPass(t),u=e.shaderParams,c=e.renderTarget.flipY?-1:1,h=i.length,f=0;f<h;f++){var d=i[f],p=d.mesh,_=d.instancingData;if(!_||!(_.count<=0)){d.ensureMaterial(n);var g=d.material;r.setBaseConstants(n,g),r.setSkinning(n,d),g.dirty&&(g.updateUniforms(n,s),g.dirty=!1),r.setupCullMode(!0,c,d),g.setParameters(n),d.setParameters(n,4);var y=d.getShaderInstance(l,0,s,u,this.viewUniformFormat,this.viewBindGroupFormat),v=y.shader;if(!v.failed){d._sortKeyShadow=v.id,n.setShader(v),r.setVertexBuffers(n,p),r.setMorphing(n,d.morphInstance),_&&n.setVertexBuffer(_.vertexBuffer),r.setMeshInstanceMatrices(d),r.setupMeshUniformBuffers(y);var x=d.renderStyle;n.draw(p.primitive[x],p.indexBuffer[x],_==null?void 0:_.count),r._shadowDrawCalls++,_&&r._instancedDrawCalls++}}}},a.needsShadowRendering=function(i){var t=i.enabled&&i.castShadows&&i.shadowUpdateMode!==0&&i.visibleThisFrame;return i.shadowUpdateMode===1&&(i.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=i.numShadowFaces),t},a.getLightRenderData=function(i,t,e){return i.getRenderData(i._type===0?t:null,e)},a.setupRenderPass=function(i,t,e){var n=t.renderTarget;i.init(n),i.depthStencilOps.clearDepthValue=1,i.depthStencilOps.clearDepth=e,n.depthBuffer?i.depthStencilOps.storeDepth=!0:(i.colorOps.clearValue.copy(t.clearColor),i.colorOps.clear=e,i.depthStencilOps.storeDepth=!1),i.requiresCubemaps=!1},a.prepareFace=function(i,t,e){var n=i._type,r=this.getLightRenderData(i,t,e).shadowCamera,s=n===0?0:e;return r.renderTarget=i._shadowMap.renderTargets[s],r},a.renderFace=function(i,t,e,n,r){r===void 0&&(r=!0);var s=this.device,l=this.getLightRenderData(i,t,e),u=l.shadowCamera;this.dispatchUniforms(i,u,l,e);var c=u.renderTarget,h=this.renderer;h.setCameraUniforms(u,c),s.supportsUniformBuffers&&h.setupViewUniformBuffers(l.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,null),r?(h.setupViewport(u,c),n&&h.clear(u)):h.clearView(u,c,!0,!1),this.setupRenderState(s,i),this.submitCasters(l.visibleCasters,i,u)},a.render=function(i,t,e){if(e===void 0&&(e=!0),this.needsShadowRendering(i)){for(var n=i.numShadowFaces,r=0;r<n;r++)this.prepareFace(i,t,r),this.renderFace(i,t,r,!0,e);this.renderVsm(i,t)}},a.renderVsm=function(i,t){i._isVsm&&i._vsmBlurSize>1&&(this.renderer.scene.clusteredLightingEnabled&&i._type!==0||this.applyVsmBlur(i,t))},a.getVsmBlurShader=function(i,t){var e=this.blurVsmShader,n=e[i][t];if(!n){this.blurVsmWeights[t]=function(s){for(var l,u=(s-1)/6,c=(s-1)*.5,h=Array(s),f=0,d=0;d<s;++d)h[d]=Math.exp(-((l=d-c)*l)/(2*u*u)),f+=h[d];for(var p=0;p<s;++p)h[p]/=f;return h}(t);var r=new Map;r.set("{SAMPLES}",t),i===1&&r.set("GAUSS",""),n=Te.createShader(this.device,{uniqueName:"blurVsm"+i+t,attributes:{vertex_position:oe},vertexChunk:"fullscreenQuadVS",fragmentChunk:"blurVSMPS",fragmentDefines:r}),e[i][t]=n}return n},a.applyVsmBlur=function(i,t){var e=this.device;e.setBlendState(ge.NOBLEND);var n=i.getRenderData(i._type===0?t:null,0).shadowCamera.renderTarget,r=this.renderer.shadowMapCache.get(e,i),s=r.renderTargets[0],l=i.vsmBlurMode,u=i._vsmBlurSize,c=this.getVsmBlurShader(l,u);No.z=i._shadowResolution-2,No.w=No.z,this.sourceId.setValue(n.colorBuffer),Wr[0]=1/i._shadowResolution,Wr[1]=0,this.pixelOffsetId.setValue(Wr),l===1&&this.weightId.setValue(this.blurVsmWeights[u]),kt(e,s,c,null,No),this.sourceId.setValue(s.colorBuffer),Wr[1]=Wr[0],Wr[0]=0,this.pixelOffsetId.setValue(Wr),kt(e,n,c,null,No),this.renderer.shadowMapCache.add(i,r)},a.initViewBindGroupFormat=function(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Gs(this.device,[new Le("matrix_viewProjection",14)]),this.viewBindGroupFormat=new Br(this.device,[new mo(ho,3)]))},a.frameUpdate=function(){this.initViewBindGroupFormat()},o.createShadowCamera=function(i,t,e){var n,r,s=$s.create("ShadowCamera",t,e),l=qn.get(i),u=(n=l==null?void 0:l.vsm)!=null&&n,c=(r=l==null?void 0:l.pcf)!=null&&r;return u?s.clearColor=new B(0,0,0,0):s.clearColor=new B(1,1,1,1),s.clearDepthBuffer=!0,s.clearStencilBuffer=!1,s.clearColorBuffer=!c,s},o}(),Fo=[],N2=function(){function o(t){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=t}var a,i=o.prototype;return i.destroy=function(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(function(t){t.destroy()}),this._allocated.length=0},i.assign=function(t){var e=this.empty;Fo.push.apply(Fo,[].concat(this._allocated)),this._allocated.length=0,this._clusters.clear();for(var n=t.length,r=0;r<n;r++){var s=t[r].renderActions;if(s)for(var l=s.length,u=0;u<l;u++){var c=s[u];c.lightClusters=null;var h=c.layer;if(h.hasClusteredLights&&h.meshInstances.length){var f,d=h.getLightIdHash(),p=this._clusters.get(d),_=p==null?void 0:p.lightClusters;_||(_=(f=Fo.pop())!=null?f:new Iu(this.device),this._allocated.push(_),this._clusters.set(d,c)),c.lightClusters=_}c.lightClusters||(c.lightClusters=e)}}Fo.forEach(function(g){return g.destroy()}),Fo.length=0},i.update=function(t,e){this.assign(t),this._clusters.forEach(function(n){var r=n.layer;n.lightClusters.update(r.clusteredLightsSet,e)})},a=[{key:"count",get:function(){return this._allocated.length}},{key:"empty",get:function(){if(!this._empty){var t=new Iu(this.device);t.name="ClusterEmpty",t.update([]),this._empty=t}return this._empty}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function iy(o,a){return(iy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ar=new q,qf=[],F2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e)||this)._quadRenderer2D=null,r._quadRendererCube=null,r._filteredLights=[],r._forceCopy=!1,r._evtDeviceRestored=null,r._cubeSlotsOffsets=n,r.requiresCubemaps=!1,r.blitTextureId=e.scope.resolve("blitTexture"),r.invViewProjId=e.scope.resolve("invViewProj"),r._evtDeviceRestored=e.on("devicerestored",r.onDeviceRestored,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&iy(a,o);var i,t=a.prototype;return t.destroy=function(){var e,n,r;(e=this._quadRenderer2D)==null||e.destroy(),this._quadRenderer2D=null,(n=this._quadRendererCube)==null||n.destroy(),this._quadRendererCube=null,(r=this._evtDeviceRestored)==null||r.off(),this._evtDeviceRestored=null},t.onDeviceRestored=function(){this._forceCopy=!0},t.update=function(e){var n=this._filteredLights;this.filter(e,n),this.executeEnabled=n.length>0},t.filter=function(e,n){for(var r=0;r<e.length;r++){var s=e[r];s._type!==0&&s.atlasViewportAllocated&&(s.atlasSlotUpdated||this._forceCopy)&&s.enabled&&s.cookie&&s.visibleThisFrame&&n.push(s)}this._forceCopy=!1},t.initInvViewProjMatrices=function(){if(!qf.length)for(var e=0;e<6;e++){var n=$s.create(null,1,e),r=n.projectionMatrix,s=n.node.getLocalTransform().clone().invert();qf[e]=new X().mul2(r,s).invert()}},t.execute=function(){var e=this.device;e.setBlendState(ge.NOBLEND),e.setCullMode(0),e.setDepthState(Xe.NODEPTH),e.setStencilState();for(var n=this.renderTarget.colorBuffer.width,r=this._cubeSlotsOffsets,s=this._filteredLights,l=0;l<s.length;l++){var u=s[l],c=u.numShadowFaces,h=c>1?this.quadRendererCube:this.quadRenderer2D;c>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(u.cookie);for(var f=0;f<c;f++){if(ar.copy(u.atlasViewport),c>1){var d=ar.z/3,p=r[f];ar.x+=d*p.x,ar.y+=d*p.y,ar.z=d,ar.w=d,this.invViewProjId.setValue(qf[f].data)}ar.mulScalar(n),h.render(ar)}}s.length=0},a.create=function(e,n){var r=new a(e.device,n);return r.init(e),r.colorOps.clear=!1,r.depthStencilOps.clearDepth=!1,r},i=[{key:"quadRenderer2D",get:function(){if(!this._quadRenderer2D){var e=Te.createShader(this.device,{uniqueName:"cookieRenderer2d",attributes:{vertex_position:oe},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlit2DPS"});this._quadRenderer2D=new Ys(e)}return this._quadRenderer2D}},{key:"quadRendererCube",get:function(){if(!this._quadRendererCube){var e=Te.createShader(this.device,{uniqueName:"cookieRendererCube",attributes:{vertex_position:oe},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlitCubePS"});this._quadRendererCube=new Ys(e)}return this._quadRendererCube}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(ct);function ry(o,a){return(ry=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var U2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){var r;return(r=o.call(this,t)||this).requiresCubemaps=!1,r.shadowRenderer=e,r.shadowRendererLocal=n,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ry(a,o);var i=a.prototype;return i.update=function(t){var e=this.shadowRendererLocal.shadowLights,n=this.shadowRendererLocal.prepareLights(e,t),r=e.length;this.enabled=r>0,r&&this.shadowRenderer.setupRenderPass(this,n,!1)},i.execute=function(){for(var t=this.shadowRendererLocal.shadowLights,e=t.length,n=0;n<e;n++)for(var r=t[n],s=0;s<r.numShadowFaces;s++)this.shadowRenderer.renderFace(r,null,s,!0);t.length=0},a}(ct);function sy(o,a){return(sy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var B2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s){var l;return(l=o.call(this,t)||this).renderer=e,l.frameGraph=null,l.cookiesRenderPass=F2.create(s.cookieRenderTarget,s.cubeSlotsOffsets),l.beforePasses.push(l.cookiesRenderPass),l.shadowRenderPass=new U2(t,n,r),l.beforePasses.push(l.shadowRenderPass),l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&sy(a,o);var i=a.prototype;return i.update=function(t,e,n,r,s){this.frameGraph=t,this.cookiesRenderPass.enabled=n,n&&this.cookiesRenderPass.update(r),this.shadowRenderPass.enabled=e,e&&this.shadowRenderPass.update(s)},i.destroy=function(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null},i.execute=function(){var t=this.renderer,e=t.scene;t.worldClustersAllocator.update(this.frameGraph.renderPasses,e.lighting)},a}(ct);function ay(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Kf(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return ay(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ay(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var Zf=0,or=new X,lr=new X,ea=new X,oy=new zt,Qf=new to,ly=new X().setScale(1,-1,1),Jf=new Set,$f=new Set,ed=new tf,uy=new X().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),cy=[new G(.5,.333333),new G(.25,.666667),new G(.75,.111111),new G(.125,.444444),new G(.625,.777778),new G(.375,.222222),new G(.875,.555556),new G(.0625,.888889),new G(.5625,.037037),new G(.3125,.37037),new G(.8125,.703704),new G(.1875,.148148),new G(.6875,.481481),new G(.4375,.814815),new G(.9375,.259259),new G(.03125,.592593)],V2=new X,z2=new X,G2=new X,H2=new X,W2=new X,j2=new X,ta=new Set,td=[],nd=[],X2=function(){function o(i){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new qg(123),this.device=i,this.scene=null,this.worldClustersAllocator=new N2(i),this.lightTextureAtlas=new I2(i),this.shadowMapCache=new D2,this.shadowRenderer=new ny(this,this.lightTextureAtlas),this._shadowRendererLocal=new R2(this,this.shadowRenderer),this._shadowRendererDirectional=new k2(this,this.shadowRenderer),this._renderPassUpdateClustered=new B2(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;var t=i.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.viewIndexId.setValue(0),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new q,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new w2,this.constantLightCube=t.resolve("lightCube[0]")}var a=o.prototype;return a.destroy=function(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null},a.setupViewport=function(i,t){var e=this.device,n=t?t.width:e.width,r=t?t.height:e.height,s=i.rect,l=Math.floor(s.x*n),u=Math.floor(s.y*r),c=Math.floor(s.z*n),h=Math.floor(s.w*r);if(e.setViewport(l,u,c,h),i._scissorRectClear){var f=i.scissorRect;l=Math.floor(f.x*n),u=Math.floor(f.y*r),c=Math.floor(f.z*n),h=Math.floor(f.w*r)}e.setScissor(l,u,c,h)},a.setCameraUniforms=function(i,t){var e=t==null?void 0:t.flipY,n=null;if(i.xr&&i.xr.session){var r,s,l=((s=i._node)==null||(r=s.parent)==null?void 0:r.getWorldTransform())||null;n=i.xr.views.list;for(var u=0;u<n.length;u++){var c=n[u];c.updateTransforms(l),i.frustum.setFromMat4(c.projViewOffMat)}}else{var h=i.projectionMatrix;i.calculateProjection&&i.calculateProjection(h,0);var f=i.getProjectionMatrixSkybox();e&&(h=V2.mul2(ly,h),f=z2.mul2(ly,f)),this.device.isWebGPU&&(h=G2.mul2(uy,h),f=H2.mul2(uy,f));var d=i.jitter,p=0,_=0;if(d>0){var g=t?t.width:this.device.width,y=t?t.height:this.device.height,v=cy[this.device.renderVersion%cy.length];p=d*(2*v.x-1)/g,_=d*(2*v.y-1)/y,(h=W2.copy(h)).data[8]=p,h.data[9]=_,(f=j2.copy(f)).data[8]=p,f.data[9]=_,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}var x=d>0?this.blueNoiseJitterVec:q.ZERO;if(this.blueNoiseJitterData[0]=x.x,this.blueNoiseJitterData[1]=x.y,this.blueNoiseJitterData[2]=x.z,this.blueNoiseJitterData[3]=x.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(h.data),this.projSkyboxId.setValue(f.data),i.calculateTransform)i.calculateTransform(lr,0);else{var S=i._node.getPosition(),T=i._node.getRotation();lr.setTRS(S,T,E.ONE)}this.viewInvId.setValue(lr.data),ea.copy(lr).invert(),this.viewId.setValue(ea.data),oy.setFromMat4(ea),this.viewId3.setValue(oy.data),or.mul2(h,ea),this.viewProjId.setValue(or.data),i._storeShaderMatrices(or,p,_,this.device.renderVersion),this.flipYId.setValue(e?-1:1),this.dispatchViewPos(i._node.getPosition()),i.frustum.setFromMat4(or)}this.tbnBasis.setValue(e?-1:1);var b=i._nearClip,w=i._farClip;return this.nearClipId.setValue(b),this.farClipId.setValue(w),this.cameraParams[0]=1/w,this.cameraParams[1]=w,this.cameraParams[2]=b,this.cameraParams[3]=+(i.projection===1),this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?i.getExposure():this.scene.exposure),n},a.clear=function(i,t,e,n){var r=(t!=null?!!t:!!i._clearColorBuffer)|2*(e!=null?!!e:!!i._clearDepthBuffer)|4*(n!=null?!!n:!!i._clearStencilBuffer);r&&this.device.clear({color:[i._clearColor.r,i._clearColor.g,i._clearColor.b,i._clearColor.a],depth:i._clearDepth,stencil:i._clearStencil,flags:r})},a.setCamera=function(i,t,e,n){this.setCameraUniforms(i,t),this.clearView(i,t,e,!1)},a.clearView=function(i,t,e,n){var r=this.device;if(r.setRenderTarget(t),r.updateBegin(),n&&(r.setColorWrite(!0,!0,!0,!0),r.setDepthWrite(!0)),this.setupViewport(i,t),e){var s=i._clearOptions;r.clear(s||{color:[i._clearColor.r,i._clearColor.g,i._clearColor.b,i._clearColor.a],depth:i._clearDepth,flags:!!i._clearColorBuffer|2*!!i._clearDepthBuffer|4*!!i._clearStencilBuffer,stencil:i._clearStencil})}},a.setupCullMode=function(i,t,e){var n=e.material,r=0;if(i){var s=1;(n.cull===2||n.cull===1)&&(s=t*e.flipFacesFactor*e.node.worldScaleSign),r=s<0?n.cull===2?1:2:n.cull}this.device.setCullMode(r),r===0&&n.cull===0&&this.twoSidedLightingNegScaleFactorId.setValue(e.node.worldScaleSign)},a.updateCameraFrustum=function(i){if(i.xr&&i.xr.views.list.length){var t=i.xr.views.list[0];or.mul2(t.projMat,t.viewOffMat),i.frustum.setFromMat4(or);return}var e=i.projectionMatrix;if(i.calculateProjection&&i.calculateProjection(e,0),i.calculateTransform)i.calculateTransform(lr,0);else{var n=i._node.getPosition(),r=i._node.getRotation();lr.setTRS(n,r,E.ONE),this.viewInvId.setValue(lr.data)}ea.copy(lr).invert(),or.mul2(e,ea),i.frustum.setFromMat4(or)},a.setBaseConstants=function(i,t){i.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)},a.updateCpuSkinMatrices=function(i){Zf++;var t=i.length;if(t!==0)for(var e=0;e<t;e++){var n=i[e].skinInstance;n&&(n.updateMatrices(i[e].node,Zf),n._dirty=!0)}},a.updateGpuSkinMatrices=function(i){for(var t,e=Kf(i);!(t=e()).done;){var n=t.value,r=n.skinInstance;r&&r._dirty&&(r.updateMatrixPalette(n.node,Zf),r._dirty=!1)}},a.updateMorphing=function(i){for(var t,e=Kf(i);!(t=e()).done;){var n=t.value.morphInstance;n&&n._dirty&&n.update()}},a.updateGSplats=function(i){for(var t,e,n=Kf(i);!(e=n()).done;)(t=e.value.gsplatInstance)==null||t.update()},a.gpuUpdate=function(i){this.updateGpuSkinMatrices(i),this.updateMorphing(i),this.updateGSplats(i)},a.setVertexBuffers=function(i,t){i.setVertexBuffer(t.vertexBuffer)},a.setMorphing=function(i,t){t&&(t.prepareRendering(i),i.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams))},a.setSkinning=function(i,t){var e=t.skinInstance;if(e){this._skinDrawCalls++;var n=e.boneTexture;this.boneTextureId.setValue(n)}},a.dispatchViewPos=function(i){var t=this.viewPos;t[0]=i.x,t[1]=i.y,t[2]=i.z,this.viewPosId.setValue(t)},a.initViewBindGroupFormat=function(i){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){var t=[new Le("matrix_view",14),new Le("matrix_viewInverse",14),new Le("matrix_projection",14),new Le("matrix_projectionSkybox",14),new Le("matrix_viewProjection",14),new Le("matrix_view3",13),new Le("cubeMapRotationMatrix",13),new Le("view_position",4),new Le("skyboxIntensity",2),new Le("exposure",2),new Le("textureBias",2),new Le("view_index",2)];i&&t.push.apply(t,[new Le("clusterCellsCountByBoundsSize",4),new Le("clusterTextureSize",4),new Le("clusterBoundsMin",4),new Le("clusterBoundsDelta",4),new Le("clusterCellsDot",4),new Le("clusterCellsMax",4),new Le("shadowAtlasParams",3),new Le("clusterMaxCells",1),new Le("clusterSkip",2)]),this.viewUniformFormat=new Gs(this.device,t);var e=[new mo(ho,3)];this.viewBindGroupFormat=new Br(this.device,e)}},a.setupViewUniforms=function(i,t){this.projId.setValue(i.projMat.data),this.projSkyboxId.setValue(i.projMat.data),this.viewId.setValue(i.viewOffMat.data),this.viewInvId.setValue(i.viewInvOffMat.data),this.viewId3.setValue(i.viewMat3.data),this.viewProjId.setValue(i.projViewOffMat.data),this.viewPosId.setValue(i.positionData),this.viewIndexId.setValue(t)},a.setupViewUniformBuffers=function(i,t,e,n){for(var r,s=this.device,l=(r=n==null?void 0:n.length)!=null?r:1;i.length<l;){var u=new So(s,t,!1),c=new Fs(s,e,u);i.push(c)}if(n)for(var h=0;h<l;h++){var f=n[h];this.setupViewUniforms(f,h);var d=i[h];d.defaultUniformBuffer.update(),d.update()}else{var p=i[0];p.defaultUniformBuffer.update(),p.update()}n||s.setBindGroup(0,i[0])},a.setupMeshUniformBuffers=function(i){var t=this.device;if(t.supportsUniformBuffers){var e=i.getBindGroup(t);e.update(),t.setBindGroup(1,e),i.getUniformBuffer(t).update(ed),t.setBindGroup(2,ed.bindGroup,ed.offsets)}},a.setMeshInstanceMatrices=function(i,t){t===void 0&&(t=!1);var e=i.node.worldTransform;this.modelMatrixId.setValue(e.data),t&&this.normalMatrixId.setValue(i.node.normalMatrix.data)},a.cull=function(i,t,e){var n=e.opaque;n.length=0;var r=e.transparent;r.length=0;for(var s=i.frustumCulling,l=t.length,u=0;u<l;u++){var c=t[u];c.visible&&(!s||!c.cull||c._isVisible(i))&&(c.visibleThisFrame=!0,(c.transparent?r:n).push(c),(c.skinInstance||c.morphInstance||c.gsplatInstance)&&(this.processingMeshInstances.add(c),c.gsplatInstance&&c.gsplatInstance.cameras.push(i)))}},a.collectLights=function(i){this.lights.length=0,this.localLights.length=0;for(var t=this.scene._stats,e=i.layerList.length,n=0;n<e;n++){var r=i.layerList[n];if(!$f.has(r)){$f.add(r);for(var s=r._lights,l=0;l<s.length;l++){var u=s[l];Jf.has(u)||(Jf.add(u),this.lights.push(u),u._type!==0&&this.localLights.push(u))}}}t.lights=this.lights.length,Jf.clear(),$f.clear()},a.cullLights=function(i,t){for(var e=this.scene.clusteredLightingEnabled,n=this.scene.physicalUnits,r=0;r<t.length;r++){var s=t[r];if(s.enabled)if(s._type!==0)if(s.getBoundingSphere(Qf),i.frustum.containsSphere(Qf)){s.visibleThisFrame=!0,s.usePhysicalUnits=n;var l=i.getScreenSize(Qf);s.maxScreenSize=Math.max(s.maxScreenSize,l)}else e||!s.castShadows||s.shadowMap||(s.visibleThisFrame=!0);else s.usePhysicalUnits=this.scene.physicalUnits}},a.cullShadowmaps=function(i){for(var t=this.scene.clusteredLightingEnabled,e=0;e<this.localLights.length;e++){var n=this.localLights[e];n._type!==0&&(t?n.atlasSlotUpdated&&n.shadowUpdateMode===0&&(n.shadowUpdateMode=1):n.shadowUpdateMode===0&&n.castShadows&&!n.getRenderData(null,0).shadowCamera.renderTarget&&(n.shadowUpdateMode=1),n.visibleThisFrame&&n.castShadows&&n.shadowUpdateMode!==0&&this._shadowRendererLocal.cull(n,i))}this.cameraDirShadowLights.clear();for(var r=i.cameras,s=0;s<r.length;s++){var l=r[s];if(l.enabled){for(var u=l.camera,c=void 0,h=u.layers,f=0;f<h.length;f++){var d=i.getLayerById(h[f]);if(d)for(var p=d.splitLights[0],_=0;_<p.length;_++){var g=p[_];g.castShadows&&!ta.has(g)&&(ta.add(g),(c=c??[]).push(g),this._shadowRendererDirectional.cull(g,i,u))}}c&&this.cameraDirShadowLights.set(u,c),ta.clear()}}},a.cullComposition=function(i){var t=this.scene;this.processingMeshInstances.clear();var e=i.cameras.length;this._camerasRendered+=e;for(var n=0;n<e;n++){var r=i.cameras[n];t==null||t.fire(ag,r);var s=r.renderTarget;r.frameUpdate(s),this.updateCameraFrustum(r.camera);for(var l=r.layers,u=0;u<l.length;u++){var c=i.getLayerById(l[u]);if(c&&c.enabled){this.cullLights(r.camera,c._lights);var h=c.getCulledInstances(r.camera);this.cull(r.camera,c.meshInstances,h)}}t==null||t.fire(og,r)}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(i)},a.updateShaders=function(i,t){for(var e=i.length,n=0;n<e;n++){var r=i[n].material;if(r&&!ta.has(r)&&(ta.add(r),r.getShaderVariant!==Ci.prototype.getShaderVariant)){if(t&&(!r.useLighting||r.emitter&&!r.emitter.lighting))continue;r.clearVariants()}}ta.clear()},a.updateFrameUniforms=function(){var i;this.blueNoiseTextureId.setValue((i=this.device,C2.get(i,function(){var t=(Yg(),wi);return A2(i,"BlueNoise",Math.sqrt(t.length/4),t)})))},a.beginFrame=function(i){for(var t=this.scene,e=t.updateShaders||this.device._shadersDirty,n=i.layerList,r=n.length,s=0;s<r;s++)for(var l=n[s].meshInstances,u=l.length,c=0;c<u;c++){var h=l[c];h.visibleThisFrame=!1,e&&td.push(h),h.skinInstance&&nd.push(h)}if(e){var f=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(td,f),t.updateShaders=!1,this.device._shadersDirty=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(nd),td.length=0,nd.length=0;for(var d=this.lights,p=d.length,_=0;_<p;_++)d[_].beginFrame()},a.updateLightTextureAtlas=function(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)},a.updateLayerComposition=function(i){for(var t=i.layerList.length,e=this.scene._shaderVersion,n=0;n<t;n++)i.layerList[n]._shaderVersion=e;i._update()},a.frameUpdate=function(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()},o}(),hy=function(){function o(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}var a=o.prototype;return a.destroy=function(){this.viewBindGroups.forEach(function(i){i.defaultUniformBuffer.destroy(),i.destroy()}),this.viewBindGroups.length=0},a.setupClears=function(i,t){this.clearColor=(i==null?void 0:i.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(i==null?void 0:i.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(i==null?void 0:i.clearStencilBuffer)||t.clearStencilBuffer},o}();function fy(o,a){return(fy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Uo=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r,s){var l;return(l=o.call(this,e)||this).renderActions=[],l.noDepthClear=!1,l.layerComposition=n,l.scene=r,l.renderer=s,l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&fy(a,o);var i,t=a.prototype;return t.addRenderAction=function(e){this.renderActions.push(e)},t.addLayer=function(e,n,r,s){s===void 0&&(s=!0);var l=new hy;if(l.renderTarget=this.renderTarget,l.camera=e,l.layer=n,l.transparent=r,s){var u=this.renderActions.length===0;l.setupClears(u?e:void 0,n)}this.addRenderAction(l)},t.addLayers=function(e,n,r,s,l,u){u===void 0&&(u=!0);for(var c=e.layerList,h=e.subLayerList,f=s,d=r;d<c.length;){var p=c[d],_=h[d];if(n.camera.layersSet.has(p.id)&&(this.addLayer(n,p,_,f),f=!1),d++,p.id===l&&_===u)break}return d},t.updateDirectionalShadows=function(){for(var e=this.renderer,n=this.renderActions,r=0;r<n.length;r++){var s=n[r].camera.camera,l=this.renderer.cameraDirShadowLights.get(s);if(l)for(var u=0;u<l.length;u++){var c=l[u];if(e.dirLightShadows.get(c)!==s){e.dirLightShadows.set(c,s);var h=e._shadowRendererDirectional.getLightRenderPass(c,s);h&&this.beforePasses.push(h)}}}},t.updateClears=function(){var e=this.renderActions[0];if(e){var n=e.camera.camera,r=n.fullSizeClearRect;this.setClearColor(r&&e.clearColor?n.clearColor:void 0),this.setClearDepth(r&&e.clearDepth&&!this.noDepthClear?n.clearDepth:void 0),this.setClearStencil(r&&e.clearStencil?n.clearStencil:void 0)}},t.frameUpdate=function(){o.prototype.frameUpdate.call(this),this.updateDirectionalShadows(),this.updateClears()},t.before=function(){for(var e=this.renderActions,n=0;n<e.length;n++){var r=e[n];r.firstCameraUse&&this.scene.fire(ng,r.camera)}},t.execute=function(){for(var e=this.layerComposition,n=this.renderActions,r=0;r<n.length;r++){var s=n[r],l=s.layer;e.isEnabled(l,s.transparent)&&this.renderRenderAction(s,r===0)}},t.after=function(){for(var e=0;e<this.renderActions.length;e++){var n=this.renderActions[e];n.lastCameraUse&&this.scene.fire(ig,n.camera)}this.beforePasses.length=0},t.renderRenderAction=function(e,n){var r=this.renderer,s=this.scene,l=r.device,u=e.layer,c=e.transparent,h=e.camera;if(h){var f,d,p,_=h.gammaCorrection,g=h.toneMapping;this.gammaCorrection!==void 0&&(h.gammaCorrection=this.gammaCorrection),this.toneMapping!==void 0&&(h.toneMapping=this.toneMapping),s.fire(rg,h,u,c);var y={lightClusters:e.lightClusters},v=(d=(f=h.camera.shaderPassInfo)==null?void 0:f.index)!=null?d:0;n&&h.camera.fullSizeClearRect||(y.clearColor=e.clearColor,y.clearDepth=e.clearDepth,y.clearStencil=e.clearStencil);var x=(p=e.renderTarget)!=null?p:l.backBuffer;r.renderForwardLayer(h.camera,x,u,c,v,e.viewBindGroups,y),l.setBlendState(ge.NOBLEND),l.setStencilState(null,null),l.setAlphaToCoverage(!1),s.fire(sg,h,u,c),this.gammaCorrection!==void 0&&(h.gammaCorrection=_),this.toneMapping!==void 0&&(h.toneMapping=g)}},i=[{key:"rendersAnything",get:function(){return this.renderActions.length>0}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(ct);function dy(o,a){return(dy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Y2=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e){var n;return(n=o.call(this,i)||this).renderer=t,n.renderAction=e,n.requiresCubemaps=!1,n}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&dy(a,o),a.prototype.execute=function(){this.renderAction.camera.onPostprocessing()},a}(ct);function py(o,a){return(py=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var q2=[[],[],[]],ur=new B,jr={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}},id=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e=o.call(this,t)||this,n=e.device;e._forwardDrawCalls=0,e._materialSwitches=0,e._depthMapTime=0,e._forwardTime=0,e._sortTime=0;var r=n.scope;return e.fogColorId=r.resolve("fog_color"),e.fogStartId=r.resolve("fog_start"),e.fogEndId=r.resolve("fog_end"),e.fogDensityId=r.resolve("fog_density"),e.ambientId=r.resolve("light_globalAmbient"),e.skyboxIntensityId=r.resolve("skyboxIntensity"),e.cubeMapRotationMatrixId=r.resolve("cubeMapRotationMatrix"),e.pcssDiskSamplesId=r.resolve("pcssDiskSamples[0]"),e.pcssSphereSamplesId=r.resolve("pcssSphereSamples[0]"),e.lightColorId=[],e.lightDir=[],e.lightDirId=[],e.lightShadowMapId=[],e.lightShadowMatrixId=[],e.lightShadowParamsId=[],e.lightShadowIntensity=[],e.lightRadiusId=[],e.lightPos=[],e.lightPosId=[],e.lightWidth=[],e.lightWidthId=[],e.lightHeight=[],e.lightHeightId=[],e.lightInAngleId=[],e.lightOutAngleId=[],e.lightCookieId=[],e.lightCookieIntId=[],e.lightCookieMatrixId=[],e.lightCookieOffsetId=[],e.lightShadowSearchAreaId=[],e.lightCameraParamsId=[],e.lightSoftShadowParamsId=[],e.shadowMatrixPaletteId=[],e.shadowCascadeDistancesId=[],e.shadowCascadeCountId=[],e.shadowCascadeBlendId=[],e.screenSizeId=r.resolve("uScreenSize"),e._screenSize=new Float32Array(4),e.fogColor=new Float32Array(3),e.ambientColor=new Float32Array(3),e.pcssDiskSamples=function(s){for(var l=[],u=0;u<16;++u){var c=Math.sqrt(u+.5)/Math.sqrt(16);l.push(c)}return l}(),e.pcssSphereSamples=function(s){for(var l=[],u=0;u<16;u++){var c=u/16,h=Math.sqrt(c*c);l.push(h)}return l}(),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&py(a,o);var i=a.prototype;return i.destroy=function(){o.prototype.destroy.call(this)},i.dispatchGlobalLights=function(t){var e=this.ambientColor;if(ur.linear(t.ambientLight),e[0]=ur.r,e[1]=ur.g,e[2]=ur.b,t.physicalUnits)for(var n=0;n<3;n++)e[n]*=t.ambientLuminance;this.ambientId.setValue(e),this.skyboxIntensityId.setValue(t.physicalUnits?t.skyboxLuminance:t.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(t._skyboxRotationMat3.data)},i._resolveLight=function(t,e){var n="light"+e;this.lightColorId[e]=t.resolve(""+n+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(""+n+"_direction"),this.lightShadowMapId[e]=t.resolve(""+n+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(""+n+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(""+n+"_shadowParams"),this.lightShadowIntensity[e]=t.resolve(""+n+"_shadowIntensity"),this.lightShadowSearchAreaId[e]=t.resolve(""+n+"_shadowSearchArea"),this.lightRadiusId[e]=t.resolve(""+n+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(""+n+"_position"),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(""+n+"_halfWidth"),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(""+n+"_halfHeight"),this.lightInAngleId[e]=t.resolve(""+n+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(""+n+"_outerConeAngle"),this.lightCookieId[e]=t.resolve(""+n+"_cookie"),this.lightCookieIntId[e]=t.resolve(""+n+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(""+n+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(""+n+"_cookieOffset"),this.lightCameraParamsId[e]=t.resolve(""+n+"_cameraParams"),this.lightSoftShadowParamsId[e]=t.resolve(""+n+"_softShadowParams"),this.shadowMatrixPaletteId[e]=t.resolve(""+n+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[e]=t.resolve(""+n+"_shadowCascadeDistances"),this.shadowCascadeCountId[e]=t.resolve(""+n+"_shadowCascadeCount"),this.shadowCascadeBlendId[e]=t.resolve(""+n+"_shadowCascadeBlend")},i.setLTCDirectionalLight=function(t,e,n,r,s){this.lightPos[e][0]=r.x-n.x*s,this.lightPos[e][1]=r.y-n.y*s,this.lightPos[e][2]=r.z-n.z*s,this.lightPosId[e].setValue(this.lightPos[e]);var l=t.transformVector(new E(-.5,0,0));this.lightWidth[e][0]=l.x*s,this.lightWidth[e][1]=l.y*s,this.lightWidth[e][2]=l.z*s,this.lightWidthId[e].setValue(this.lightWidth[e]);var u=t.transformVector(new E(0,0,.5));this.lightHeight[e][0]=u.x*s,this.lightHeight[e][1]=u.y*s,this.lightHeight[e][2]=u.z*s,this.lightHeightId[e].setValue(this.lightHeight[e])},i.dispatchDirectLights=function(t,e,n){for(var r=0,s=this.device.scope,l=0;l<t.length;l++)if(t[l].mask&e){var u=t[l],c=u._node.getWorldTransform();if(this.lightColorId[r]||this._resolveLight(s,r),this.lightColorId[r].setValue(u._colorLinear),c.getY(u._direction).mulScalar(-1),u._direction.normalize(),this.lightDir[r][0]=u._direction.x,this.lightDir[r][1]=u._direction.y,this.lightDir[r][2]=u._direction.z,this.lightDirId[r].setValue(this.lightDir[r]),u.shape!==0&&this.setLTCDirectionalLight(c,r,u._direction,n._node.getPosition(),n.farClip),u.castShadows){var h=u.getRenderData(n,0),f=u._getUniformBiasValues(h);this.lightShadowMapId[r].setValue(h.shadowBuffer),this.lightShadowMatrixId[r].setValue(h.shadowMatrix.data),this.shadowMatrixPaletteId[r].setValue(u._shadowMatrixPalette),this.shadowCascadeDistancesId[r].setValue(u._shadowCascadeDistances),this.shadowCascadeCountId[r].setValue(u.numCascades),this.shadowCascadeBlendId[r].setValue(1-u.cascadeBlend),this.lightShadowIntensity[r].setValue(u.shadowIntensity),this.lightSoftShadowParamsId[r].setValue(u._softShadowParams),h.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[r].setValue(u.penumbraSize/h.shadowCamera.renderTarget.width*h.projectionCompensation);var d=u._shadowCameraParams;d.length=4,d[0]=0,d[1]=h.shadowCamera._farClip,d[2]=h.shadowCamera._nearClip,d[3]=1,this.lightCameraParamsId[r].setValue(d);var p=u._shadowRenderParams;p.length=4,p[0]=u._shadowResolution,p[1]=f.normalBias,p[2]=f.bias,p[3]=0,this.lightShadowParamsId[r].setValue(p)}r++}return r},i.setLTCPositionalLight=function(t,e){var n=t.transformVector(new E(-.5,0,0));this.lightWidth[e][0]=n.x,this.lightWidth[e][1]=n.y,this.lightWidth[e][2]=n.z,this.lightWidthId[e].setValue(this.lightWidth[e]);var r=t.transformVector(new E(0,0,.5));this.lightHeight[e][0]=r.x,this.lightHeight[e][1]=r.y,this.lightHeight[e][2]=r.z,this.lightHeightId[e].setValue(this.lightHeight[e])},i.dispatchOmniLight=function(t,e,n){var r=e._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(t,n),this.lightRadiusId[n].setValue(e.attenuationEnd),this.lightColorId[n].setValue(e._colorLinear),r.getTranslation(e._position),this.lightPos[n][0]=e._position.x,this.lightPos[n][1]=e._position.y,this.lightPos[n][2]=e._position.z,this.lightPosId[n].setValue(this.lightPos[n]),e.shape!==0&&this.setLTCPositionalLight(r,n),e.castShadows){var s=e.getRenderData(null,0);this.lightShadowMapId[n].setValue(s.shadowBuffer);var l=e._getUniformBiasValues(s),u=e._shadowRenderParams;u.length=4,u[0]=e._shadowResolution,u[1]=l.normalBias,u[2]=l.bias,u[3]=1/e.attenuationEnd,this.lightShadowParamsId[n].setValue(u),this.lightShadowIntensity[n].setValue(e.shadowIntensity);var c=e.penumbraSize/s.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[n].setValue(c);var h=e._shadowCameraParams;h.length=4,h[0]=0,h[1]=s.shadowCamera._farClip,h[2]=s.shadowCamera._nearClip,h[3]=0,this.lightCameraParamsId[n].setValue(h)}e._cookie&&(this.lightCookieId[n].setValue(e._cookie),this.lightShadowMatrixId[n].setValue(r.data),this.lightCookieIntId[n].setValue(e.cookieIntensity))},i.dispatchSpotLight=function(t,e,n){var r=e._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(t,n),this.lightInAngleId[n].setValue(e._innerConeAngleCos),this.lightOutAngleId[n].setValue(e._outerConeAngleCos),this.lightRadiusId[n].setValue(e.attenuationEnd),this.lightColorId[n].setValue(e._colorLinear),r.getTranslation(e._position),this.lightPos[n][0]=e._position.x,this.lightPos[n][1]=e._position.y,this.lightPos[n][2]=e._position.z,this.lightPosId[n].setValue(this.lightPos[n]),e.shape!==0&&this.setLTCPositionalLight(r,n),r.getY(e._direction).mulScalar(-1),e._direction.normalize(),this.lightDir[n][0]=e._direction.x,this.lightDir[n][1]=e._direction.y,this.lightDir[n][2]=e._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),e.castShadows){var s=e.getRenderData(null,0);this.lightShadowMapId[n].setValue(s.shadowBuffer),this.lightShadowMatrixId[n].setValue(s.shadowMatrix.data);var l=e._getUniformBiasValues(s),u=e._shadowRenderParams;u.length=4,u[0]=e._shadowResolution,u[1]=l.normalBias,u[2]=l.bias,u[3]=1/e.attenuationEnd,this.lightShadowParamsId[n].setValue(u),this.lightShadowIntensity[n].setValue(e.shadowIntensity);var c=e.penumbraSize/s.shadowCamera.renderTarget.width,h=1/Math.tan(s.shadowCamera._fov*Math.PI/180/2);this.lightShadowSearchAreaId[n].setValue(c*h);var f=e._shadowCameraParams;f.length=4,f[0]=0,f[1]=s.shadowCamera._farClip,f[2]=s.shadowCamera._nearClip,f[3]=0,this.lightCameraParamsId[n].setValue(f)}if(e._cookie){if(!e.castShadows){var d=$s.evalSpotCookieMatrix(e);this.lightShadowMatrixId[n].setValue(d.data)}this.lightCookieId[n].setValue(e._cookie),this.lightCookieIntId[n].setValue(e.cookieIntensity),e._cookieTransform&&(e._cookieTransformUniform[0]=e._cookieTransform.x,e._cookieTransformUniform[1]=e._cookieTransform.y,e._cookieTransformUniform[2]=e._cookieTransform.z,e._cookieTransformUniform[3]=e._cookieTransform.w,this.lightCookieMatrixId[n].setValue(e._cookieTransformUniform),e._cookieOffsetUniform[0]=e._cookieOffset.x,e._cookieOffsetUniform[1]=e._cookieOffset.y,this.lightCookieOffsetId[n].setValue(e._cookieOffsetUniform))}},i.dispatchLocalLights=function(t,e,n){for(var r=n,s=this.device.scope,l=t[1],u=l.length,c=0;c<u;c++){var h=l[c];h.mask&e&&(this.dispatchOmniLight(s,h,r),r++)}for(var f=t[2],d=f.length,p=0;p<d;p++){var _=f[p];_.mask&e&&(this.dispatchSpotLight(s,_,r),r++)}},i.renderForwardPrepareMaterials=function(t,e,n,r,s,l){var u=(h=t.fogParams)!=null?h:this.scene.fog,c=t.shaderParams;c.fog=u.type,c.srgbRenderTarget=(f=e==null?void 0:e.isColorBufferSrgb(0))!=null&&f,jr.clear();for(var h,f,d,p,_,g=this.device,y=this.scene,v=y.clusteredLightingEnabled,x=(d=s==null?void 0:s.getLightHash(v))!=null?d:0,S=null,T=n.length,b=0;b<T;b++){var w=n[b],A=w.instancingData;if(!A||!(A.count<=0)){w.ensureMaterial(g);var C,L,I=w.material,P=w._shaderDefs,M=w.mask;I&&I===S&&P!==p&&(S=null),I!==S&&(this._materialSwitches++,I._scene=y,I.dirty&&(I.updateUniforms(g,y),I.dirty=!1));var R=w.getShaderInstance(l,x,y,c,this.viewUniformFormat,this.viewBindGroupFormat,r);C=I!==S,L=!S||M!==_,jr.drawCalls.push(w),jr.shaderInstances.push(R),jr.isNewMaterial.push(C),jr.lightMaskChanged.push(L),S=I,p=P,_=M}}return jr},i.renderForwardInternal=function(t,e,n,r,s,l,u){for(var c=this.device,h=this.scene,f=1<<r,d=l?-1:1,p=h.clusteredLightingEnabled,_=(v=t.xr)!=null&&v.session&&t.xr.views.list.length?t.xr.views.list:null,g=e.drawCalls.length,y=0;y<g;y++){var v,x,S,T=e.drawCalls[y],b=e.isNewMaterial[y],w=e.lightMaskChanged[y],A=e.shaderInstances[y],C=T.material,L=T.mask;if(!A.shader.failed){if(b){if(c.setShader(A.shader,!1),C.setParameters(c),w){var I=this.dispatchDirectLights(n[0],L,t);p||this.dispatchLocalLights(n,L,I)}this.alphaTestId.setValue(C.alphaTest),c.setBlendState(C.blendState),c.setDepthState(C.depthState),c.setAlphaToCoverage(C.alphaToCoverage)}this.setupCullMode(t._cullFaces,d,T);var P=(x=T.stencilFront)!=null?x:C.stencilFront,M=(S=T.stencilBack)!=null?S:C.stencilBack;c.setStencilState(P,M),T.setParameters(c,f),c.scope.resolve("meshInstanceId").setValue(T.id);var R=T.mesh;this.setVertexBuffers(c,R),this.setMorphing(c,T.morphInstance),this.setSkinning(c,T);var k=T.instancingData;k&&c.setVertexBuffer(k.vertexBuffer),this.setMeshInstanceMatrices(T,!0),this.setupMeshUniformBuffers(A);var D=T.renderStyle,O=R.indexBuffer[D];if(s==null||s(T,y),_)for(var F=0;F<_.length;F++){var N=_[F];if(c.setViewport(N.viewport.x,N.viewport.y,N.viewport.z,N.viewport.w),c.supportsUniformBuffers){var j=u[F];c.setBindGroup(0,j)}else this.setupViewUniforms(N,F);var z=F===0,V=F===_.length-1;c.draw(R.primitive[D],O,k==null?void 0:k.count,z,V),this._forwardDrawCalls++,T.instancingData&&this._instancedDrawCalls++}else c.draw(R.primitive[D],O,k==null?void 0:k.count),this._forwardDrawCalls++,T.instancingData&&this._instancedDrawCalls++;y<g-1&&!e.isNewMaterial[y+1]&&C.setParameters(c,T.parameters)}}},i.renderForward=function(t,e,n,r,s,l,u,c,h){var f=this.renderForwardPrepareMaterials(t,e,n,r,u,s);this.renderForwardInternal(t,f,r,s,l,c,h),jr.clear()},i.renderForwardLayer=function(t,e,n,r,s,l,u){u===void 0&&(u={});var c,h,f,d,p,_,g,y,v=this.scene,x=this.device,S=v.clusteredLightingEnabled;if(this.setupViewport(t,e),n){n.sortVisible(t,r);var T=n.getCulledInstances(t);c=r?T.transparent:T.opaque,v.immediate.onPreRenderLayer(n,c,r),n.requiresLightCube&&(this.lightCube.update(v.ambientLight,n._lights),this.constantLightCube.setValue(this.lightCube.colors)),h=n.splitLights}else c=u.meshInstances,h=(f=u.splitLights)!=null?f:q2;S&&(((d=u.lightClusters)!=null?d:this.worldClustersAllocator.empty).activate(),n&&!this.clustersDebugRendered&&v.lighting.debugLayer===n.id&&(this.clustersDebugRendered=!0)),v._activeCamera=t;var b=(p=t.fogParams)!=null?p:this.scene.fog;this.setFogConstants(b);var w=this.setCameraUniforms(t,e);x.supportsUniformBuffers&&this.setupViewUniformBuffers(l,this.viewUniformFormat,this.viewBindGroupFormat,w);var A=(_=u.clearColor)!=null&&_,C=(g=u.clearDepth)!=null&&g,L=(y=u.clearStencil)!=null&&y;(A||C||L)&&this.clear(t,A,C,L);var I=!!(t._flipFaces^(e==null?void 0:e.flipY)),P=this._forwardDrawCalls;this.renderForward(t,e,c,h,s,null,n,I,l),n&&(n._forwardDrawCalls+=this._forwardDrawCalls-P)},i.setFogConstants=function(t){if(t.type!==Gr){ur.linear(t.color);var e=this.fogColor;e[0]=ur.r,e[1]=ur.g,e[2]=ur.b,this.fogColorId.setValue(e),t.type===Gv?(this.fogStartId.setValue(t.start),this.fogEndId.setValue(t.end)):this.fogDensityId.setValue(t.density)}},i.setSceneConstants=function(){var t=this.scene;this.dispatchGlobalLights(t);var e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)},i.buildFrameGraph=function(t,e){var n=this.scene;if(t.reset(),n.clusteredLightingEnabled){var r=n.lighting,s=r.shadowsEnabled,l=r.cookiesEnabled;this._renderPassUpdateClustered.update(t,s,l,this.lights,this.localLights),t.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(t,this.localLights);for(var u=0,c=!0,h=null,f=e._renderActions,d=u;d<f.length;d++){var p=f[d],_=p.layer,g=p.camera;if(p.useCameraPasses)g.camera.renderPasses.forEach(function(A){t.addRenderPass(A)});else{var y=_.id===1,v=y&&(g.renderSceneColorMap||g.renderSceneDepthMap);c&&(c=!1,u=d,h=p.renderTarget);var x=f[d+1],S=!!x&&!x.useCameraPasses&&x.layer.id===1&&(g.renderSceneColorMap||g.renderSceneDepthMap),T=!!x&&x.firstCameraUse&&this.cameraDirShadowLights.has(x.camera.camera);if(!x||x.renderTarget!==h||T||S||v){if(y&&u===d||this.addMainRenderPass(t,e,h,u,d),y){if(g.renderSceneColorMap){var b=g.camera.renderPassColorGrab;b.source=g.renderTarget,t.addRenderPass(b)}g.renderSceneDepthMap&&t.addRenderPass(g.camera.renderPassDepthGrab)}if(p.triggerPostprocess&&(g!=null&&g.onPostprocessing)){var w=new Y2(this.device,this,p);t.addRenderPass(w)}c=!0}}}},i.addMainRenderPass=function(t,e,n,r,s){var l=new Uo(this.device,e,this.scene,this);l.init(n);for(var u=e._renderActions,c=r;c<=s;c++)l.addRenderAction(u[c]);t.addRenderPass(l)},i.update=function(t){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(t),this.collectLights(t),this.beginFrame(t),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(this.processingMeshInstances)},a}(X2),rd=0,Bo=[],Mu=new Set,K2=[null,function(o,a){return o.drawOrder-a.drawOrder},function(o,a){var i=o._sortKeyForward,t=a._sortKeyForward;return i===t?a.mesh.id-o.mesh.id:t-i},function(o,a){return a._sortKeyDynamic-o._sortKeyDynamic},function(o,a){return o._sortKeyDynamic-a._sortKeyDynamic}],Z2=function(){this.opaque=[],this.transparent=[]},Ye=function(){function o(t){var e,n,r;t===void 0&&(t={}),this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,t.id!==void 0?(this.id=t.id,rd=Math.max(this.id+1,rd)):this.id=rd++,this.name=t.name,this._enabled=(e=t.enabled)==null||e,this._refCounter=+!!this._enabled,this.opaqueSortMode=(n=t.opaqueSortMode)!=null?n:2,this.transparentSortMode=(r=t.transparentSortMode)!=null?r:3,t.renderTarget&&(this.renderTarget=t.renderTarget),this._clearColorBuffer=!!t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}var a,i=o.prototype;return i.incrementCounter=function(){this._refCounter===0&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++},i.decrementCounter=function(){if(this._refCounter===1)this._enabled=!1,this.onDisable&&this.onDisable();else if(this._refCounter===0)return;this._refCounter--},i.addMeshInstances=function(t,e){for(var n=this.meshInstances,r=this.meshInstancesSet,s=0;s<t.length;s++){var l=t[s];r.has(l)||(n.push(l),r.add(l),Mu.add(l.material))}if(e||this.addShadowCasters(t),Mu.size>0){var u=this._shaderVersion;Mu.forEach(function(c){u>=0&&c._shaderVersion!==u&&(c.getShaderVariant!==Ci.prototype.getShaderVariant&&c.clearVariants(),c._shaderVersion=u)}),Mu.clear()}},i.removeMeshInstances=function(t,e){for(var n=this.meshInstances,r=this.meshInstancesSet,s=0;s<t.length;s++){var l=t[s];if(r.has(l)){r.delete(l);var u=n.indexOf(l);u>=0&&n.splice(u,1)}}e||this.removeShadowCasters(t)},i.addShadowCasters=function(t){for(var e=this.shadowCasters,n=this.shadowCastersSet,r=0;r<t.length;r++){var s=t[r];s.castShadow&&!n.has(s)&&(n.add(s),e.push(s))}},i.removeShadowCasters=function(t){for(var e=this.shadowCasters,n=this.shadowCastersSet,r=0;r<t.length;r++){var s=t[r];if(n.has(s)){n.delete(s);var l=e.indexOf(s);l>=0&&e.splice(l,1)}}},i.clearMeshInstances=function(t){t===void 0&&(t=!1),this.meshInstances.length=0,this.meshInstancesSet.clear(),t||(this.shadowCasters.length=0,this.shadowCastersSet.clear())},i.markLightsDirty=function(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0},i.hasLight=function(t){return this._lightsSet.has(t)},i.addLight=function(t){var e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),this._lights.push(e),this.markLightsDirty()),e.type!==0&&this._clusteredLightsSet.add(e)},i.removeLight=function(t){var e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this.markLightsDirty()),e.type!==0&&this._clusteredLightsSet.delete(e)},i.clearLights=function(){var t=this;this._lightsSet.forEach(function(e){return e.removeLayer(t)}),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()},i.evaluateLightHash=function(t,e,n){for(var r=0,s=this._lights,l=0;l<s.length;l++){var u=s[l].type!==0;(t&&u||e&&!u)&&Bo.push(n?s[l].id:s[l].key)}return Bo.length>0&&(Bo.sort(),r=nf(Bo),Bo.length=0),r},i.getLightHash=function(t){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!t,!0,!1)),this._lightHash},i.getLightIdHash=function(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash},i.addCamera=function(t){this.camerasSet.has(t.camera)||(this.camerasSet.add(t.camera),this.cameras.push(t),this._dirtyComposition=!0)},i.removeCamera=function(t){if(this.camerasSet.has(t.camera)){this.camerasSet.delete(t.camera);var e=this.cameras.indexOf(t);this.cameras.splice(e,1),this._dirtyComposition=!0}},i.clearCameras=function(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0},i._calculateSortDistances=function(t,e,n){for(var r=t.length,s=e.x,l=e.y,u=e.z,c=n.x,h=n.y,f=n.z,d=0;d<r;d++){var p=t[d],_=void 0;if(p.calculateSortDistance)_=p.calculateSortDistance(p,e,n);else{var g=p.aabb.center;_=(g.x-s)*c+(g.y-l)*h+(g.z-u)*f}var y=1e9*p._drawBucket;p._sortKeyDynamic=y+_}},i.getCulledInstances=function(t){var e=this._visibleInstances.get(t);return e||(e=new Z2,this._visibleInstances.set(t,e)),e},i.sortVisible=function(t,e){var n=e?this.transparentSortMode:this.opaqueSortMode;if(n!==0){var r=this.getCulledInstances(t),s=e?r.transparent:r.opaque,l=t.node;if(n===5){var u=l.getPosition(),c=l.forward;this.customCalculateSortValues&&this.customCalculateSortValues(s,s.length,u,c),this.customSortCallback&&s.sort(this.customSortCallback)}else{if(n===3||n===4){var h=l.getPosition(),f=l.forward;this._calculateSortDistances(s,h,f)}s.sort(K2[n])}}},a=[{key:"enabled",get:function(){return this._enabled},set:function(t){t!==this._enabled&&(this._dirtyComposition=!0,this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(t){this._clearColorBuffer=t,this._dirtyComposition=!0}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(t){this._clearDepthBuffer=t,this._dirtyComposition=!0}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(t){this._clearStencilBuffer=t,this._dirtyComposition=!0}},{key:"hasClusteredLights",get:function(){return this._clusteredLightsSet.size>0}},{key:"clusteredLightsSet",get:function(){return this._clusteredLightsSet}},{key:"splitLights",get:function(){if(this._splitLightsDirty){this._splitLightsDirty=!1;for(var t=this._splitLights,e=0;e<t.length;e++)t[e].length=0;for(var n=this._lights,r=0;r<n.length;r++){var s=n[r];s.enabled&&t[s._type].push(s)}for(var l=0;l<t.length;l++)t[l].sort(function(u,c){return u.key-c.key})}return this._splitLights}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),Q2=function(o,a){return o.priority-a.priority},Vo=function(o){return o.sort(Q2)};function my(o,a){return(my=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ru=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return t===void 0&&(t="Untitled"),(e=o.call(this)||this).layerList=[],e.layerIdMap=new Map,e.layerNameMap=new Map,e.layerOpaqueIndexMap=new Map,e.layerTransparentIndexMap=new Map,e.subLayerList=[],e.subLayerEnabled=[],e.cameras=[],e._renderActions=[],e._dirty=!1,e.name=t,e._opaqueOrder={},e._transparentOrder={},e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&my(a,o);var i=a.prototype;return i.destroy=function(){this.destroyRenderActions()},i.destroyRenderActions=function(){this._renderActions.forEach(function(t){return t.destroy()}),this._renderActions.length=0},i.markDirty=function(){this._dirty=!0},i._update=function(){var t=this.layerList.length;if(!this._dirty){for(var e=0;e<t;e++)if(this.layerList[e]._dirtyComposition){this._dirty=!0;break}}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(var n=0;n<t;n++){var r=this.layerList[n];r._dirtyComposition=!1;for(var s=0;s<r.cameras.length;s++){var l=r.cameras[s];0>this.cameras.indexOf(l)&&this.cameras.push(l)}}this.cameras.length>1&&Vo(this.cameras);var u=[],c=0;this.destroyRenderActions();for(var h=0;h<this.cameras.length;h++){var f=this.cameras[h];if(u.length=0,f.camera.renderPasses.length>0){this.addDummyRenderAction(c,f),c++;continue}for(var d=!0,p=c,_=null,g=!1,y=0;y<t;y++){var v=this.layerList[y];if(v.enabled&&this.subLayerEnabled[y]&&v.cameras.length>0&&f.layers.indexOf(v.id)>=0){u.push(v),!g&&v.id===f.disablePostEffectsLayer&&(g=!0,_&&(_.triggerPostprocess=!0));var x=this.subLayerList[y];_=this.addRenderAction(c,v,x,f,d,g),c++,d=!1}}p<c&&(_.lastCameraUse=!0),!g&&_&&(_.triggerPostprocess=!0),f.renderTarget&&f.postEffectsEnabled&&this.propagateRenderTarget(p-1,f)}this._logRenderActions()}},i.getNextRenderAction=function(t){var e=new hy;return this._renderActions.push(e),e},i.addDummyRenderAction=function(t,e){var n=this.getNextRenderAction(t);n.camera=e,n.useCameraPasses=!0},i.addRenderAction=function(t,e,n,r,s,l){for(var u=e.id!==1?r.renderTarget:null,c=!1,h=this._renderActions,f=t-1;f>=0;f--)if(h[f].camera===r&&h[f].renderTarget===u){c=!0;break}l&&r.postEffectsEnabled&&(u=null);var d=this.getNextRenderAction(t);d.triggerPostprocess=!1,d.layer=e,d.transparent=n,d.camera=r,d.renderTarget=u,d.firstCameraUse=s,d.lastCameraUse=!1;var p=s||!c,_=e.clearColorBuffer||e.clearDepthBuffer||e.clearStencilBuffer;return(p||_)&&d.setupClears(p?r:void 0,e),d},i.propagateRenderTarget=function(t,e){for(var n=t;n>=0;n--){var r=this._renderActions[n],s=r.layer;if(r.renderTarget&&s.id!==1)break;if(s.id!==1){if(r.useCameraPasses)break;var l=r==null?void 0:r.camera.camera;if(l&&(!e.camera.rect.equals(l.rect)||!e.camera.scissorRect.equals(l.scissorRect)))break;r.renderTarget=e.renderTarget}}},i._logRenderActions=function(){},i._isLayerAdded=function(t){return this.layerIdMap.get(t.id)===t},i._isSublayerAdded=function(t,e){return(e?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(t)!==void 0},i.push=function(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))},i.insert=function(t,e){if(!this._isLayerAdded(t)){this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);var n=this.layerList.length;this._updateOpaqueOrder(e,n-1),this._updateTransparentOrder(e,n-1),this.subLayerEnabled.splice(e,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}},i.remove=function(t){var e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this.fire("remove",t);var n=this.layerList.length;this._updateOpaqueOrder(0,n-1),this._updateTransparentOrder(0,n-1),this._updateLayerMaps()},i.pushOpaque=function(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))},i.insertOpaque=function(t,e){if(!this._isSublayerAdded(t,!1)){this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);var n=this.subLayerList.length;this._updateOpaqueOrder(e,n-1),this.subLayerEnabled.splice(e,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}},i.removeOpaque=function(t){for(var e=0,n=this.layerList.length;e<n;e++)if(this.layerList[e]===t&&!this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),n--,this._updateOpaqueOrder(e,n-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,0>this.layerList.indexOf(t)&&this.fire("remove",t);break}this._updateLayerMaps()},i.pushTransparent=function(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))},i.insertTransparent=function(t,e){if(!this._isSublayerAdded(t,!0)){this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);var n=this.subLayerList.length;this._updateTransparentOrder(e,n-1),this.subLayerEnabled.splice(e,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}},i.removeTransparent=function(t){for(var e=0,n=this.layerList.length;e<n;e++)if(this.layerList[e]===t&&this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),n--,this._updateTransparentOrder(e,n-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,0>this.layerList.indexOf(t)&&this.fire("remove",t);break}this._updateLayerMaps()},i.getOpaqueIndex=function(t){var e;return(e=this.layerOpaqueIndexMap.get(t))!=null?e:-1},i.getTransparentIndex=function(t){var e;return(e=this.layerTransparentIndexMap.get(t))!=null?e:-1},i.isEnabled=function(t,e){if(t.enabled){var n=e?this.getTransparentIndex(t):this.getOpaqueIndex(t);if(n>=0)return this.subLayerEnabled[n]}return!1},i._updateLayerMaps=function(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(var t=0;t<this.layerList.length;t++){var e=this.layerList[t];this.layerIdMap.set(e.id,e),this.layerNameMap.set(e.name,e),(this.subLayerList[t]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(e,t)}},i.getLayerById=function(t){var e;return(e=this.layerIdMap.get(t))!=null?e:null},i.getLayerByName=function(t){var e;return(e=this.layerNameMap.get(t))!=null?e:null},i._updateOpaqueOrder=function(t,e){for(var n=t;n<=e;n++)this.subLayerList[n]===!1&&(this._opaqueOrder[this.layerList[n].id]=n)},i._updateTransparentOrder=function(t,e){for(var n=t;n<=e;n++)this.subLayerList[n]===!0&&(this._transparentOrder[this.layerList[n].id]=n)},i._sortLayersDescending=function(t,e,n){for(var r=-1,s=-1,l=0,u=t.length;l<u;l++){var c=t[l];n.hasOwnProperty(c)&&(r=Math.max(r,n[c]))}for(var h=0,f=e.length;h<f;h++){var d=e[h];n.hasOwnProperty(d)&&(s=Math.max(s,n[d]))}return r===-1&&s!==-1?1:s===-1&&r!==-1?-1:s-r},i.sortTransparentLayers=function(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)},i.sortOpaqueLayers=function(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)},a}(se);function _y(o,a,i){return a&&function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}var Ou=new E,Ii={bias:0,normalBias:0},zo=new B,sd={r:0,g:1,b:2,a:3},ad={directional:0,omni:1,point:1,spot:2},J2=[[new q(0,0,1,1)],[new q(0,0,.5,.5),new q(0,.5,.5,.5)],[new q(0,0,.5,.5),new q(0,.5,.5,.5),new q(.5,0,.5,.5)],[new q(0,0,.5,.5),new q(0,.5,.5,.5),new q(.5,0,.5,.5),new q(.5,.5,.5,.5)]],$2={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7},eI=0,tI=function(){function o(a,i,t){this.light=t,this.camera=a,this.shadowCamera=ny.createShadowCamera(t._shadowType,t._type,i),this.shadowMatrix=new X,this.shadowViewport=new q(0,0,1,1),this.shadowScissor=new q(0,0,1,1),this.projectionCompensation=0,this.face=i,this.visibleCasters=[],this.viewBindGroups=[]}return o.prototype.destroy=function(){this.viewBindGroups.forEach(function(a){a.defaultUniformBuffer.destroy(),a.destroy()}),this.viewBindGroups.length=0},_y(o,[{key:"shadowBuffer",get:function(){var a=this.shadowCamera.renderTarget;return a?this.light._isPcf?a.depthBuffer:a.colorBuffer:null}}]),o}(),od=function(){function o(i,t){this.layers=new Set,this.shadowDepthState=Xe.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this._evtDeviceRestored=null,this.device=i,this.clusteredLighting=t,this.id=eI++,this._evtDeviceRestored=i.on("devicerestored",this.onDeviceRestored,this),this._type=0,this._color=new B(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new E(0,0,0),this._direction=new E(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}var a=o.prototype;return a.destroy=function(){var i;(i=this._evtDeviceRestored)==null||i.off(),this._evtDeviceRestored=null,this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null},a.onDeviceRestored=function(){this.shadowUpdateMode===0&&(this.shadowUpdateMode=1)},a.releaseRenderData=function(){if(this._renderData){for(var i=0;i<this._renderData.length;i++)this._renderData[i].destroy();this._renderData.length=0}},a.addLayer=function(i){this.layers.add(i)},a.removeLayer=function(i){this.layers.delete(i)},a._updateOuterAngle=function(i){var t=i*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(!1,!0)},a.beginFrame=function(){this.visibleThisFrame=this._type===0&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1},a._destroyShadowMap=function(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===0&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(var i=0;i<this.shadowUpdateOverrides.length;i++)this.shadowUpdateOverrides[i]===0&&(this.shadowUpdateOverrides[i]=1)},a.getRenderData=function(i,t){for(var e=0;e<this._renderData.length;e++){var n=this._renderData[e];if(n.camera===i&&n.face===t)return n}var r=new tI(i,t,this);return this._renderData.push(r),r},a.clone=function(){var i=new o(this.device,this.clusteredLighting);return i.type=this._type,i.setColor(this._color),i.intensity=this._intensity,i.affectSpecularity=this._affectSpecularity,i.luminance=this._luminance,i.castShadows=this.castShadows,i._enabled=this._enabled,i.attenuationStart=this.attenuationStart,i.attenuationEnd=this.attenuationEnd,i.falloffMode=this._falloffMode,i.shadowType=this._shadowType,i.vsmBlurSize=this._vsmBlurSize,i.vsmBlurMode=this.vsmBlurMode,i.vsmBias=this.vsmBias,i.shadowUpdateMode=this.shadowUpdateMode,i.mask=this.mask,this.shadowUpdateOverrides&&(i.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),i.innerConeAngle=this._innerConeAngle,i.outerConeAngle=this._outerConeAngle,i.numCascades=this.numCascades,i.cascadeDistribution=this.cascadeDistribution,i.cascadeBlend=this._cascadeBlend,i.shape=this._shape,i.shadowDepthState.copy(this.shadowDepthState),i.shadowBias=this.shadowBias,i.normalOffsetBias=this._normalOffsetBias,i.shadowResolution=this._shadowResolution,i.shadowDistance=this.shadowDistance,i.shadowIntensity=this.shadowIntensity,i.shadowSamples=this.shadowSamples,i.shadowBlockerSamples=this.shadowBlockerSamples,i.penumbraSize=this.penumbraSize,i.penumbraFalloff=this.penumbraFalloff,i},a._getUniformBiasValues=function(i){var t=i.shadowCamera._farClip;switch(this._type){case 1:Ii.bias=this.shadowBias,Ii.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?Ii.bias=-2e-4:Ii.bias=20*this.shadowBias,Ii.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?Ii.bias=-2e-4:Ii.bias=this.shadowBias/t*100,Ii.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias}return Ii},a.getColor=function(){return this._color},a.getBoundingSphere=function(i){if(this._type===2){var t=this.attenuationEnd,e=this._outerConeAngle,n=this._outerConeAngleCos,r=this._node;Ou.copy(r.up),e>45?(i.radius=t*this._outerConeAngleSin,Ou.mulScalar(-t*n)):(i.radius=t/(2*n),Ou.mulScalar(-i.radius)),i.center.add2(r.getPosition(),Ou)}else this._type===1&&(i.center=this._node.getPosition(),i.radius=this.attenuationEnd)},a.getBoundingBox=function(i){if(this._type===2){var t=this.attenuationEnd,e=this._outerConeAngle,n=this._node,r=Math.abs(Math.sin(e*U.DEG_TO_RAD)*t);i.center.set(0,-(.5*t),0),i.halfExtents.set(r,.5*t,r),i.setFromTransformedAabb(i,n.getWorldTransform(),!0)}else this._type===1&&(i.center.copy(this._node.getPosition()),i.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},a._updateShadowBias=function(){if(this._type!==1||this.clusteredLighting){var i=-1e3*this.shadowBias;this.shadowDepthState.depthBias=i,this.shadowDepthState.depthBiasSlope=i}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0},a._updateLinearColor=function(){var i=this._intensity;this._usePhysicalUnits&&(i=this._luminance/o.getLightUnitConversion(this._type,this._outerConeAngle*U.DEG_TO_RAD,this._innerConeAngle*U.DEG_TO_RAD));var t=this._color,e=this._colorLinear;i>=1?zo.linear(t).mulScalar(i):zo.copy(t).mulScalar(i).linear(),e[0]=zo.r,e[1]=zo.g,e[2]=zo.b,this.updateClusterData(!0)},a.setColor=function(){arguments.length==1?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):arguments.length==3&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()},a.layersDirty=function(){var i=this;this.layers.forEach(function(t){t.hasLight(i)&&t.markLightsDirty()})},a.updateKey=function(){var i=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0)<<22|!!this._cookie<<21|!!this._cookieFalloff<<20|sd[this._cookieChannel.charAt(0)]<<18|!!this._cookieTransform<<12|this._shape<<10|(this.numCascades>0)<<9|(this._cascadeBlend>0)<<8|!!this.affectSpecularity<<7|this.mask<<6|!!this._castShadows<<3;this._cookieChannel.length===3&&(i|=sd[this._cookieChannel.charAt(1)]<<16,i|=sd[this._cookieChannel.charAt(2)]<<14),i!==this.key&&this.layersDirty(),this.key=i},a.updateClusteredFlags=function(){var i,t=!!(1&this.mask),e=!!(2&this.mask);this.clusteredFlags=(this.type===2)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|((i=$2[this._cookieChannel])!=null?i:0)<<23|!!t<<22|!!e<<21},a.getClusteredFlags=function(i,t){return this.clusteredFlags|(i?Math.floor(255*this.shadowIntensity):0)&255|((t?Math.floor(255*this.cookieIntensity):0)&255)<<8},a.updateClusterData=function(i,t){var e=this.clusteredData16,n=pi.float2Half;i&&(e[0]=n(U.clamp(this._colorLinear[0]/100,0,65504)),e[1]=n(U.clamp(this._colorLinear[1]/100,0,65504)),e[2]=n(U.clamp(this._colorLinear[2]/100,0,65504))),t&&(e[4]=n(this._innerConeAngleCos),e[5]=n(this._outerConeAngleCos))},o.getLightUnitConversion=function(i,t,e){switch(t===void 0&&(t=Math.PI/4),e===void 0&&(e=0),i){case 2:var n=Math.cos(e);return 2*Math.PI*(1-n+(n-Math.cos(t))/2);case 1:return 4*Math.PI;case 0:return 1}},_y(o,[{key:"shadowSamples",get:function(){return this._softShadowParams[0]},set:function(i){this._softShadowParams[0]=i}},{key:"shadowBlockerSamples",get:function(){return this._softShadowParams[1]},set:function(i){this._softShadowParams[1]=i}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(i){this._shadowBias!==i&&(this._shadowBias=i,this._updateShadowBias())}},{key:"numCascades",get:function(){return this.cascades.length},set:function(i){this.cascades&&this.numCascades===i||(this.cascades=J2[i-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}},{key:"cascadeBlend",get:function(){return this._cascadeBlend},set:function(i){this._cascadeBlend!==i&&(this._cascadeBlend=i,this.updateKey())}},{key:"shadowMap",get:function(){return this._shadowMap},set:function(i){this._shadowMap!==i&&(this._destroyShadowMap(),this._shadowMap=i)}},{key:"mask",get:function(){return this._mask},set:function(i){this._mask!==i&&(this._mask=i,this.updateKey(),this.updateClusteredFlags())}},{key:"numShadowFaces",get:function(){var i=this._type;return i===0?this.numCascades:i===1?6:1}},{key:"type",get:function(){return this._type},set:function(i){if(this._type!==i){this._type=i,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();var t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}}},{key:"shape",get:function(){return this._shape},set:function(i){if(this._shape!==i){this._shape=i,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();var t=this._shadowType;this._shadowType=null,this.shadowType=t}}},{key:"usePhysicalUnits",get:function(){return this._usePhysicalUnits},set:function(i){this._usePhysicalUnits!==i&&(this._usePhysicalUnits=i,this._updateLinearColor())}},{key:"shadowType",get:function(){return this._shadowType},set:function(i){if(this._shadowType!==i){var t,e,n=qn.get(i);n||(i=0);var r=this.device;i!==6||r.textureFloatRenderable||r.textureHalfFloatRenderable||(i=0),this._type===1&&i!==5&&i!==0&&i!==7&&i!==8&&i!==6&&(i=0),i!==3||r.textureFloatRenderable&&r.textureFloatFilterable||(i=2),i!==2||r.textureHalfFloatRenderable||(i=0),n=qn.get(i),this._isVsm=(t=n==null?void 0:n.vsm)!=null&&t,this._isPcf=(e=n==null?void 0:n.pcf)!=null&&e,this._shadowType=i,this._destroyShadowMap(),this.updateKey()}}},{key:"enabled",get:function(){return this._enabled},set:function(i){this._enabled!==i&&(this._enabled=i,this.layersDirty())}},{key:"castShadows",get:function(){return this._castShadows&&this._mask!==4&&this._mask!==0},set:function(i){this._castShadows!==i&&(this._castShadows=i,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}},{key:"shadowIntensity",get:function(){return this._shadowIntensity},set:function(i){this._shadowIntensity!==i&&(this._shadowIntensity=i,this.updateKey())}},{key:"bakeShadows",get:function(){return this._castShadows&&this._mask===4}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(i){this._shadowResolution!==i&&(i=this._type===1?Math.min(i,this.device.maxCubeMapSize):Math.min(i,this.device.maxTextureSize),this._shadowResolution=i,this._destroyShadowMap())}},{key:"vsmBlurSize",get:function(){return this._vsmBlurSize},set:function(i){this._vsmBlurSize!==i&&(i%2==0&&i++,this._vsmBlurSize=i)}},{key:"normalOffsetBias",get:function(){return this._normalOffsetBias},set:function(i){if(this._normalOffsetBias!==i){var t=!this._normalOffsetBias&&i||this._normalOffsetBias&&!i;this._normalOffsetBias=i,t&&this.updateKey()}}},{key:"falloffMode",get:function(){return this._falloffMode},set:function(i){this._falloffMode!==i&&(this._falloffMode=i,this.updateKey(),this.updateClusteredFlags())}},{key:"innerConeAngle",get:function(){return this._innerConeAngle},set:function(i){this._innerConeAngle!==i&&(this._innerConeAngle=i,this._innerConeAngleCos=Math.cos(i*Math.PI/180),this.updateClusterData(!1,!0),this._usePhysicalUnits&&this._updateLinearColor())}},{key:"outerConeAngle",get:function(){return this._outerConeAngle},set:function(i){this._outerConeAngle!==i&&(this._outerConeAngle=i,this._updateOuterAngle(i),this._usePhysicalUnits&&this._updateLinearColor())}},{key:"penumbraSize",get:function(){return this._penumbraSize},set:function(i){this._penumbraSize=i,this._softShadowParams[2]=i}},{key:"penumbraFalloff",get:function(){return this._softShadowParams[3]},set:function(i){this._softShadowParams[3]=i}},{key:"intensity",get:function(){return this._intensity},set:function(i){this._intensity!==i&&(this._intensity=i,this._updateLinearColor())}},{key:"affectSpecularity",get:function(){return this._affectSpecularity},set:function(i){this._type===0&&(this._affectSpecularity=i,this.updateKey())}},{key:"luminance",get:function(){return this._luminance},set:function(i){this._luminance!==i&&(this._luminance=i,this._updateLinearColor())}},{key:"cookieMatrix",get:function(){return this._cookieMatrix||(this._cookieMatrix=new X),this._cookieMatrix}},{key:"atlasViewport",get:function(){return this._atlasViewport||(this._atlasViewport=new q(0,0,1,1)),this._atlasViewport}},{key:"cookie",get:function(){return this._cookie},set:function(i){this._cookie!==i&&(this._cookie=i,this.updateKey())}},{key:"cookieFalloff",get:function(){return this._cookieFalloff},set:function(i){this._cookieFalloff!==i&&(this._cookieFalloff=i,this.updateKey())}},{key:"cookieChannel",get:function(){return this._cookieChannel},set:function(i){if(this._cookieChannel!==i){if(i.length<3)for(var t=i.charAt(i.length-1),e=3-i.length,n=0;n<e;n++)i+=t;this._cookieChannel=i,this.updateKey(),this.updateClusteredFlags()}}},{key:"cookieTransform",get:function(){return this._cookieTransform},set:function(i){this._cookieTransform!==i&&(this._cookieTransform=i,this._cookieTransformSet=!!i,i&&!this._cookieOffset&&(this.cookieOffset=new G,this._cookieOffsetSet=!1),this.updateKey())}},{key:"cookieOffset",get:function(){return this._cookieOffset},set:function(i){this._cookieOffset!==i&&((this._cookieTransformSet||i)&&!i&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=i,this._cookieOffsetSet=!!i,i&&!this._cookieTransform&&(this.cookieTransform=new q(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}]),o}(),ld=function(){var o;function a(i,t,e){this._areaLightsEnabled=!1,this._cells=new E(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=i,this._maxTextureSize=t,this._dirtyLightsFnc=e}return a.prototype.applySettings=function(i){var t,e,n,r,s,l,u;this.shadowsEnabled=(t=i.lightingShadowsEnabled)!=null?t:this.shadowsEnabled,this.cookiesEnabled=(e=i.lightingCookiesEnabled)!=null?e:this.cookiesEnabled,this.areaLightsEnabled=(n=i.lightingAreaLightsEnabled)!=null?n:this.areaLightsEnabled,this.shadowAtlasResolution=(r=i.lightingShadowAtlasResolution)!=null?r:this.shadowAtlasResolution,this.cookieAtlasResolution=(s=i.lightingCookieAtlasResolution)!=null?s:this.cookieAtlasResolution,this.maxLightsPerCell=(l=i.lightingMaxLightsPerCell)!=null?l:this.maxLightsPerCell,this.shadowType=(u=i.lightingShadowType)!=null?u:this.shadowType,i.lightingCells&&(this.cells=new E(i.lightingCells))},o=[{key:"cells",get:function(){return this._cells},set:function(i){this._cells.copy(i)}},{key:"maxLightsPerCell",get:function(){return this._maxLightsPerCell},set:function(i){this._maxLightsPerCell=U.clamp(i,1,255)}},{key:"cookieAtlasResolution",get:function(){return this._cookieAtlasResolution},set:function(i){this._cookieAtlasResolution=U.clamp(i,32,this._maxTextureSize)}},{key:"shadowAtlasResolution",get:function(){return this._shadowAtlasResolution},set:function(i){this._shadowAtlasResolution=U.clamp(i,32,this._maxTextureSize)}},{key:"shadowType",get:function(){return this._shadowType},set:function(i){this._shadowType!==i&&(this._shadowType=i,this._dirtyLightsFnc())}},{key:"cookiesEnabled",get:function(){return this._cookiesEnabled},set:function(i){this._cookiesEnabled!==i&&(this._cookiesEnabled=i,this._dirtyLightsFnc())}},{key:"areaLightsEnabled",get:function(){return this._areaLightsEnabled},set:function(i){this._supportsAreaLights&&this._areaLightsEnabled!==i&&(this._areaLightsEnabled=i,this._dirtyLightsFnc())}},{key:"shadowsEnabled",get:function(){return this._shadowsEnabled},set:function(i){this._shadowsEnabled!==i&&(this._shadowsEnabled=i,this._dirtyLightsFnc())}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),na=function(){function o(i){var t=this;this.morph=i,i.incRefCount(),this.device=i.device;var e=i._targets.length;this.shader=this._createShader(e),this._weights=[],this._weightMap=new Map;for(var n=0;n<i._targets.length;n++){var r=i._targets[n];r.name&&this._weightMap.set(r.name,n),this.setWeight(n,r.defaultWeight)}this._shaderMorphWeights=new Float32Array(e),this._shaderMorphIndex=new Uint32Array(e);var s=function(c,h){return t[h]=i._createTexture(c,i._renderTextureFormat),new Ee({colorBuffer:t[h],depth:!1})};i.morphPositions&&(this.rtPositions=s("MorphRTPos","texturePositions")),i.morphNormals&&(this.rtNormals=s("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([i.morphTextureWidth,i.morphTextureHeight]);var l=i.aabb.halfExtents;this._aabbSize=new Float32Array([4*l.x,4*l.y,4*l.z]);var u=i.aabb.getMin();this._aabbMin=new Float32Array([2*u.x,2*u.y,2*u.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin"),this.morphTextureId=this.device.scope.resolve("morphTexture"),this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.morphIndex=this.device.scope.resolve("morphIndex[0]"),this.countId=this.device.scope.resolve("count"),this.zeroTextures=!1}var a=o.prototype;return a.destroy=function(){this.shader=null;var i,t,e,n,r=this.morph;r&&(this.morph=null,r.decRefCount(),r.refCount<1&&r.destroy()),(i=this.rtPositions)==null||i.destroy(),this.rtPositions=null,(t=this.texturePositions)==null||t.destroy(),this.texturePositions=null,(e=this.rtNormals)==null||e.destroy(),this.rtNormals=null,(n=this.textureNormals)==null||n.destroy(),this.textureNormals=null},a.clone=function(){return new o(this.morph)},a._getWeightIndex=function(i){return typeof i=="string"?this._weightMap.get(i):i},a.getWeight=function(i){var t=this._getWeightIndex(i);return this._weights[t]},a.setWeight=function(i,t){var e=this._getWeightIndex(i);this._weights[e]=t,this._dirty=!0},a._createShader=function(i){var t=new Map;t.set("{MORPH_TEXTURE_MAX_COUNT}",i),this.morph.intRenderFormat&&t.set("MORPH_INT","");var e=this.morph.intRenderFormat?"uvec4":"vec4";return Te.createShader(this.device,{uniqueName:"TextureMorphShader",attributes:{vertex_position:oe},vertexChunk:"morphVS",fragmentChunk:"morphPS",fragmentDefines:t,fragmentOutputTypes:[e]})},a._updateTextureRenderTarget=function(i,t,e){var n=this.morph,r=this.device;this.setAabbUniforms(e),this.morphTextureId.setValue(e?n.targetsTexturePositions:n.targetsTextureNormals),r.setBlendState(ge.NOBLEND),this.countId.setValue(t),this.morphFactor.setValue(this._shaderMorphWeights),this.morphIndex.setValue(this._shaderMorphIndex),kt(r,i,this.shader)},a._updateTextureMorph=function(i){this.device,(i>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,i,!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,i,!1),this.zeroTextures=i===0)},a.setAabbUniforms=function(i){i===void 0&&(i=!0),this.aabbSizeId.setValue(i?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(i?this._aabbMin:this._aabbNrmMin)},a.prepareRendering=function(i){this.setAabbUniforms()},a.update=function(){this._dirty=!1;for(var i=this.morph._targets,t=this._shaderMorphWeights,e=this._shaderMorphIndex,n=0,r=0;r<i.length;r++)Math.abs(this.getWeight(r))>1e-5&&(t[n]=this.getWeight(r),e[n]=r,n++);this._updateTextureMorph(n)},o}(),cr=function(){function o(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}var a=o.prototype;return a.getGraph=function(){return this.graph},a.setGraph=function(i){this.graph=i},a.getCameras=function(){return this.cameras},a.setCameras=function(i){this.cameras=i},a.getLights=function(){return this.lights},a.setLights=function(i){this.lights=i},a.getMaterials=function(){for(var i=[],t=0;t<this.meshInstances.length;t++){var e=this.meshInstances[t];i.indexOf(e.material)===-1&&i.push(e.material)}return i},a.clone=function(){for(var i=[],t=[],e=function(w){var A=w.clone();i.push(w),t.push(A);for(var C=0;C<w._children.length;C++)A.addChild(e(w._children[C]));return A},n=e(this.graph),r=[],s=[],l=[],u=0;u<this.skinInstances.length;u++){for(var c=this.skinInstances[u].skin,h=new qs(c),f=[],d=0;d<c.boneNames.length;d++){var p=c.boneNames[d],_=n.findByName(p);f.push(_)}h.bones=f,s.push(h)}for(var g=0;g<this.morphInstances.length;g++){var y=new na(this.morphInstances[g].morph);l.push(y)}for(var v=0;v<this.meshInstances.length;v++){var x=this.meshInstances[v],S=i.indexOf(x.node),T=new De(x.mesh,x.material,t[S]);x.skinInstance&&(T.skinInstance=s[this.skinInstances.indexOf(x.skinInstance)]),x.morphInstance&&(T.morphInstance=l[this.morphInstances.indexOf(x.morphInstance)]),r.push(T)}var b=new o;return b.graph=n,b.meshInstances=r,b.skinInstances=s,b.morphInstances=l,b.getGraph().syncHierarchy(),b},a.destroy=function(){for(var i=this.meshInstances,t=0;t<i.length;t++)i[t].destroy();this.meshInstances.length=0},a.generateWireframe=function(){De._prepareRenderStyleForArray(this.meshInstances,1)},o}();function vy(o,a){return(vy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ku=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r){var s,l,u=(r===void 0?{}:r).preferHighPrecision;(s=o.call(this)||this).device=n,s.preferHighPrecision=u!==void 0&&u,s._targets=e.slice();var c=n.textureHalfFloatRenderable?12:void 0,h=n.textureFloatRenderable?14:void 0;return s._renderTextureFormat=s.preferHighPrecision?h??c:c??h,s._renderTextureFormat=(l=s._renderTextureFormat)!=null?l:47,s.intRenderFormat=mi(s._renderTextureFormat),s._textureFormat=s.preferHighPrecision?14:12,s._init(),s._updateMorphFlags(),s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&vy(a,o);var i,t=a.prototype;return t.destroy=function(){var e,n,r;(e=this.vertexBufferIds)==null||e.destroy(),this.vertexBufferIds=null,(n=this.targetsTexturePositions)==null||n.destroy(),this.targetsTexturePositions=null,(r=this.targetsTextureNormals)==null||r.destroy(),this.targetsTextureNormals=null},t._init=function(){this._initTextureBased();for(var e=0;e<this._targets.length;e++)this._targets[e]._postInit()},t._findSparseSet=function(e,n,r){for(var s=1,l=e[0].length,u=0;u<l;u+=3){for(var c=!1,h=0;h<e.length;h++){var f=e[h];if(f[u]!==0||f[u+1]!==0||f[u+2]!==0){c=!0;break}}c?(n.push(s),r.push(u/3),s++):n.push(0)}return s},t._initTextureBased=function(){for(var e=[],n=[],r=this._targets,s=0;s<r.length;s++){var l=r[s];l.options.deltaPositions&&(e.push(l.options.deltaPositions),n.push(!0)),l.options.deltaNormals&&(e.push(l.options.deltaNormals),n.push(!1))}var u=[],c=[],h=this._findSparseSet(e,u,c),f=this.device.maxTextureSize,d=Math.ceil(Math.sqrt(h)),p=Math.ceil(h/(d=Math.min(d,f)));if(!(p>f)){this.morphTextureWidth=d,this.morphTextureHeight=p;var _=!1,g=pi.float2Half;this._textureFormat===12&&(_=!0);for(var y=[],v=[],x=d*p*4,S=0;S<e.length;S++){var T=e[S],b=this._textureFormat===12?new Uint16Array(x):new Float32Array(x);if((n[S]?y:v).push(b),_)for(var w=0;w<c.length;w++){var A=3*c[w],C=4*w+4;b[C]=g(T[A]),b[C+1]=g(T[A+1]),b[C+2]=g(T[A+2])}else for(var L=0;L<c.length;L++){var I=3*c[L],P=4*L+4;b[P]=T[I],b[P+1]=T[I+1],b[P+2]=T[I+2]}}y.length>0&&(this.targetsTexturePositions=this._createTexture("MorphPositionsTexture",this._textureFormat,r.length,[y]),this.targetsTexturePositions.upload()),v.length>0&&(this.targetsTextureNormals=this._createTexture("MorphNormalsTexture",this._textureFormat,r.length,[v]),this.targetsTextureNormals.upload());var M=[{semantic:Fr,components:1,type:5,asInt:!0}];return this.vertexBufferIds=new Rt(this.device,new Ot(this.device,M,u.length),u.length,{data:new Uint32Array(u)}),!0}},t._updateMorphFlags=function(){this._morphPositions=!1,this._morphNormals=!1;for(var e=0;e<this._targets.length;e++){var n=this._targets[e];n.morphPositions&&(this._morphPositions=!0),n.morphNormals&&(this._morphNormals=!0)}},t._createTexture=function(e,n,r,s){return new ee(this.device,{levels:s,arrayLength:r,width:this.morphTextureWidth,height:this.morphTextureHeight,format:n,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})},i=[{key:"aabb",get:function(){if(!this._aabb){for(var e=new E,n=new E,r=0;r<this._targets.length;r++){var s=this._targets[r].aabb;e.min(s.getMin()),n.max(s.getMax())}this._aabb=new Se,this._aabb.setMinMax(e,n)}return this._aabb}},{key:"morphPositions",get:function(){return this._morphPositions}},{key:"morphNormals",get:function(){return this._morphNormals}},{key:"targets",get:function(){return this._targets}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(lu),ud=function(){function o(t){this.used=!1,this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this._aabb=t.aabb,this.deltaPositions=t.deltaPositions,this.morphPositions=!!t.deltaPositions,this.morphNormals=!!t.deltaNormals}var a,i=o.prototype;return i.clone=function(){return new o(this.options)},i._postInit=function(){this.options.preserveData||(this.options=null),this.used=!0},a=[{key:"name",get:function(){return this._name}},{key:"defaultWeight",get:function(){return this._defaultWeight}},{key:"aabb",get:function(){return!this._aabb&&(this._aabb=new Se,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),gy=1,cd=new X,hd=new X,Qn=new E,Be=new E,Cn=new E,ia=new E,Zt=new E,Je=new E,ra=new E,sa=new E,Go=new E,yy=new E,Et=new E,Nu=new E,Xr=new E;function aa(o){return o-Math.floor(o)}function fd(o,a){return o-a*Math.floor(o/a)}function Fu(o){var a=aa(o),i=aa(255*o);return[a-=i/255,i-=i/255]}var nI=function(){function o(i){this._emitter=i}var a=o.prototype;return a.calcSpawnPosition=function(i,t,e,n,r){var s=this._emitter,l=Math.random(),u=Math.random(),c=Math.random(),h=Math.random();if(s.useCpu&&(i[4*r+0+2*s.numParticlesPot*4]=l,i[4*r+1+2*s.numParticlesPot*4]=u,i[4*r+2+2*s.numParticlesPot*4]=c),Be.x=l-.5,Be.y=u-.5,Be.z=c-.5,s.emitterShape===0){var f=Math.max(Math.abs(Be.x),Math.max(Math.abs(Be.y),Math.abs(Be.z))),d=f+(.5-f)*e[0],p=f+(.5-f)*e[1],_=f+(.5-f)*e[2];Be.x=d*(f===Math.abs(Be.x)?Math.sign(Be.x):2*Be.x),Be.y=p*(f===Math.abs(Be.y)?Math.sign(Be.y):2*Be.y),Be.z=_*(f===Math.abs(Be.z)?Math.sign(Be.z):2*Be.z),s.localSpace?Qn.copy(t.transformPoint(Be)):Qn.copy(n).add(t.transformPoint(Be))}else{Be.normalize();var g=s.emitterRadius===0?0:s.emitterRadiusInner/s.emitterRadius,y=h*(1-g)+g;s.localSpace?Qn.copy(Be.mulScalar(y*s.emitterRadius)):Qn.copy(n).add(Be.mulScalar(y*s.emitterRadius))}var v=-U.lerp(s.rate,s.rate2,l)*r;if(s.pack8){var x,S,T,b,w,A=(Qn.x-s.worldBounds.center.x)/s.worldBoundsSize.x+.5,C=(Qn.y-s.worldBounds.center.y)/s.worldBoundsSize.y+.5,L=(Qn.z-s.worldBounds.center.z)/s.worldBoundsSize.z+.5,I=U.lerp(s.startAngle*U.DEG_TO_RAD,s.startAngle2*U.DEG_TO_RAD,l);I=I%(2*Math.PI)/(2*Math.PI);var P=Fu(A);i[4*r]=P[0],i[4*r+1]=P[1];var M=Fu(C);i[4*r+2]=M[0],i[4*r+3]=M[1];var R=Fu(L);i[4*r+0+4*s.numParticlesPot]=R[0],i[4*r+1+4*s.numParticlesPot]=R[1];var k=Fu(I);i[4*r+2+4*s.numParticlesPot]=k[0],i[4*r+3+4*s.numParticlesPot]=k[1],i[4*r+3+4*s.numParticlesPot*2]=1;var D=Math.max(s.lifetime,(s.numParticles-1)*Math.max(s.rate,s.rate2)),O=(S=aa(x=v=(v+D)/(D+(s.lifetime+1))),T=aa(255*x),b=aa(65025*x),w=aa(160581375*x),[S-=T/255,T-=b/255,b-=w/255,w-=w/255]);i[4*r+0+4*s.numParticlesPot*3]=O[0],i[4*r+1+4*s.numParticlesPot*3]=O[1],i[4*r+2+4*s.numParticlesPot*3]=O[2],i[4*r+3+4*s.numParticlesPot*3]=O[3]}else i[4*r]=Qn.x,i[4*r+1]=Qn.y,i[4*r+2]=Qn.z,i[4*r+3]=U.lerp(s.startAngle*U.DEG_TO_RAD,s.startAngle2*U.DEG_TO_RAD,l),i[4*r+3+4*s.numParticlesPot]=v},a.update=function(i,t,e,n,r,s,l,u){var c,h,f,d,p,_,g,y,v,x,S,T,b=this._emitter;if(b.meshInstance.node){for(var w=b.meshInstance.node.worldTransform,A=0;A<12;A++)cd.data[A]=w.data[A];hd.copy(cd),hd.invert(),gy=Math.max(Math.max((Zi=b.meshInstance.node.localScale).x,Zi.y),Zi.z)}s=b.meshInstance.node===null||b.localSpace?E.ZERO:b.meshInstance.node.getPosition();for(var C=b.camera?b.camera._node.getPosition():E.ZERO,L=b.useMesh?17:15,I=b.precision-1,P=0;P<b.numParticles;P++){var M=Math.floor(b.vbCPU[P*b.numParticleVerts*(b.useMesh?6:4)+3]),R=e[4*M+0+2*b.numParticlesPot*4];Cn.x=R,Cn.y=e[4*M+1+2*b.numParticlesPot*4],Cn.z=e[4*M+2+2*b.numParticlesPot*4];var k=b.rate+(b.rate2-b.rate)*R,D=b.lifetime,O=e[4*M+3+4*b.numParticlesPot]+l,F=Math.max(Math.min(O/D,1),0),N=0,j=0;(O-l<=0||O>=D)&&this.calcSpawnPosition(e,n,r,s,M);var z=O>0&&O<D;z&&(d=Math.floor(f=F*I),p=Math.ceil(f),f%=1,_=(c=b.qRotSpeed[d])+((h=b.qRotSpeed[p])-c)*f,g=(c=b.qRotSpeed2[d])+((h=b.qRotSpeed2[p])-c)*f,N=(c=b.qScale[d])+((h=b.qScale[p])-c)*f,y=(c=b.qScale2[d])+((h=b.qScale2[p])-c)*f,v=(c=b.qAlpha[d])+((h=b.qAlpha[p])-c)*f,x=(c=b.qAlpha2[d])+((h=b.qAlpha2[p])-c)*f,S=(c=b.qRadialSpeed[d])+((h=b.qRadialSpeed[p])-c)*f,T=(c=b.qRadialSpeed2[d])+((h=b.qRadialSpeed2[p])-c)*f,S+=100*R%1*(T-S),ia.x=e[4*M],ia.y=e[4*M+1],ia.z=e[4*M+2],b.localSpace?Go.copy(ia):Go.copy(ia).sub(s),Go.normalize().mulScalar(S),d*=3,p*=3,c=b.qLocalVelocity[d],h=b.qLocalVelocity[p],Je.x=c+(h-c)*f,c=b.qLocalVelocity[d+1],h=b.qLocalVelocity[p+1],Je.y=c+(h-c)*f,c=b.qLocalVelocity[d+2],h=b.qLocalVelocity[p+2],Je.z=c+(h-c)*f,c=b.qLocalVelocity2[d],h=b.qLocalVelocity2[p],sa.x=c+(h-c)*f,c=b.qLocalVelocity2[d+1],h=b.qLocalVelocity2[p+1],sa.y=c+(h-c)*f,c=b.qLocalVelocity2[d+2],h=b.qLocalVelocity2[p+2],sa.z=c+(h-c)*f,c=b.qVelocity[d],h=b.qVelocity[p],Zt.x=c+(h-c)*f,c=b.qVelocity[d+1],h=b.qVelocity[p+1],Zt.y=c+(h-c)*f,c=b.qVelocity[d+2],h=b.qVelocity[p+2],Zt.z=c+(h-c)*f,c=b.qVelocity2[d],h=b.qVelocity2[p],ra.x=c+(h-c)*f,c=b.qVelocity2[d+1],h=b.qVelocity2[p+1],ra.y=c+(h-c)*f,c=b.qVelocity2[d+2],h=b.qVelocity2[p+2],ra.z=c+(h-c)*f,Je.x+=(sa.x-Je.x)*Cn.x,Je.y+=(sa.y-Je.y)*Cn.y,Je.z+=(sa.z-Je.z)*Cn.z,b.initialVelocity>0&&(b.emitterShape===1?(Be.copy(Cn).mulScalar(2).sub(E.ONE).normalize(),Je.add(Be.mulScalar(b.initialVelocity))):Je.add(E.FORWARD.mulScalar(b.initialVelocity))),Zt.x+=(ra.x-Zt.x)*Cn.x,Zt.y+=(ra.y-Zt.y)*Cn.y,Zt.z+=(ra.z-Zt.z)*Cn.z,_+=(g-_)*Cn.y,N=(N+1e4*R%1*(y-N))*gy,j=1e3*R%1*(x-v),b.meshInstance.node&&(b.localSpace?(Je.x/=Zi.x,Je.y/=Zi.y,Je.z/=Zi.z):cd.transformPoint(Je,Je)),b.localSpace?(hd.transformPoint(Zt,Zt),Je.add(Zt).add(Go)):(Je.add(Zt.mul(Zi)),Je.add(Go.mul(Zi))),Nu.copy(Je),yy.copy(ia).add(Je.mulScalar(l)),Et.copy(yy),e[4*M]=Et.x,e[4*M+1]=Et.y,e[4*M+2]=Et.z,e[4*M+3]+=_*l,b.wrap&&b.wrapBounds&&(b.localSpace||Et.sub(s),Et.x=fd(Et.x,b.wrapBounds.x)-.5*b.wrapBounds.x,Et.y=fd(Et.y,b.wrapBounds.y)-.5*b.wrapBounds.y,Et.z=fd(Et.z,b.wrapBounds.z)-.5*b.wrapBounds.z,b.localSpace||Et.add(s)),b.sort>0&&(b.sort===1?(Xr.copy(Et).sub(C),b.particleDistance[M]=-(Xr.x*Xr.x+Xr.y*Xr.y+Xr.z*Xr.z)):b.sort===2?b.particleDistance[M]=O:b.sort===3&&(b.particleDistance[M]=-O))),u?O<0&&(e[4*M+3+2*b.numParticlesPot*4]=-1):(O>=D&&(O-=Math.max(D,(b.numParticles-1)*k),e[4*M+3+2*b.numParticlesPot*4]=b.loop?1:-1),O<0&&b.loop&&(e[4*M+3+2*b.numParticlesPot*4]=1)),e[4*M+3+2*b.numParticlesPot*4]<0&&(z=!1),e[4*M+3+4*b.numParticlesPot]=O;for(var V=0;V<b.numParticleVerts;V++){var H=(P*b.numParticleVerts+V)*(b.useMesh?6:4),Y=b.vbCPU[H],W=b.vbCPU[H+1],ie=b.vbCPU[H+2];z||(Y=W=ie=0);var te=P*b.numParticleVerts*L+V*L;i[te]=Et.x,i[te+1]=Et.y,i[te+2]=Et.z,i[te+3]=F,i[te+4]=b.alignToMotion?0:e[4*M+3],i[te+5]=N,i[te+6]=j,i[te+7]=Nu.x,i[te+8]=Y,i[te+9]=W,i[te+10]=ie,i[te+11]=Nu.y,i[te+12]=M,i[te+13]=Nu.z,i[te+14]=b.vbCPU[H+3],b.useMesh&&(i[te+15]=b.vbCPU[H+4],i[te+16]=b.vbCPU[H+5])}}if(b.sort>0&&b.camera){for(var ae=b.useMesh?6:4,_e=b.particleDistance,xe=0;xe<b.numParticles;xe++)t[xe][0]=xe,t[xe][1]=_e[Math.floor(b.vbCPU[xe*b.numParticleVerts*ae+3])];b.vbOld.set(b.vbCPU),t.sort(function(wt,tt){return wt[1]-tt[1]});for(var je=0;je<b.numParticles;je++)for(var Qe=t[je][0]*b.numParticleVerts*ae,rt=je*b.numParticleVerts*ae,Pe=0;Pe<b.numParticleVerts*ae;Pe++)b.vbCPU[rt+Pe]=b.vbOld[Qe+Pe]}},o}(),Sy=new zt,xy=new zt,by=new zt,iI=function(){function o(i,t){this._emitter=i,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}var a=o.prototype;return a._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)},a.randomize=function(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()},a.update=function(i,t,e,n,r){var s=this._emitter;i.setBlendState(ge.NOBLEND),i.setDepthState(Xe.NODEPTH),i.setCullMode(0),this.randomize(),this.constantGraphSampleSize.setValue(1/s.precision),this.constantGraphNumSamples.setValue(s.precision),this.constantNumParticles.setValue(s.numParticles),this.constantNumParticlesPot.setValue(s.numParticlesPot),this.constantInternalTex0.setValue(s.internalTex0),this.constantInternalTex1.setValue(s.internalTex1),this.constantInternalTex2.setValue(s.internalTex2),this.constantInternalTex3.setValue(s.internalTex3);var l=s.meshInstance.node,u=l===null?E.ONE:l.localScale;if(s.pack8){this.worldBoundsMulUniform[0]=s.worldBoundsMul.x,this.worldBoundsMulUniform[1]=s.worldBoundsMul.y,this.worldBoundsMulUniform[2]=s.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=s.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=s.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=s.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var c=s.maxVel*Math.max(Math.max(u.x,u.y),u.z);c=Math.max(c,1),this.constantMaxVel.setValue(c)}var h=l===null||s.localSpace?E.ZERO:l.getPosition(),f=l===null?X.IDENTITY:l.getWorldTransform();s.emitterShape===0?(Sy.setFromMat4(t),this.constantSpawnBounds.setValue(Sy.data),this.constantSpawnPosInnerRatio.setValue(e)):(this.constantSpawnBoundsSphere.setValue(s.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(s.emitterRadius===0?0:s.emitterRadiusInner/s.emitterRadius)),this.constantInitialVelocity.setValue(s.initialVelocity),xy.setFromMat4(f),by.invertMat4(f),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(n),this.constantRate.setValue(s.rate),this.constantRateDiv.setValue(s.rate2-s.rate),this.constantStartAngle.setValue(s.startAngle*U.DEG_TO_RAD),this.constantStartAngle2.setValue(s.startAngle2*U.DEG_TO_RAD),this.constantSeed.setValue(s.seed),this.constantLifetime.setValue(s.lifetime),this.emitterScaleUniform[0]=u.x,this.emitterScaleUniform[1]=u.y,this.emitterScaleUniform[2]=u.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(xy.data),this.constantEmitterMatrixInv.setValue(by.data),this.constantLocalVelocityDivMult.setValue(s.localVelocityUMax),this.constantVelocityDivMult.setValue(s.velocityUMax),this.constantRotSpeedDivMult.setValue(s.rotSpeedUMax[0]);var d=s.swapTex?s.particleTexOUT:s.particleTexIN;d=s.beenReset?s.particleTexStart:d;var p=s.swapTex?s.particleTexIN:s.particleTexOUT;this.constantParticleTexIN.setValue(d),kt(i,s.swapTex?s.rtParticleTexIN:s.rtParticleTexOUT,r?s.shaderParticleUpdateOnStop:s.loop?s.shaderParticleUpdateRespawn:s.shaderParticleUpdateNoRespawn),s.material.setParameter("particleTexOUT",d),s.material.setParameter("particleTexIN",p),s.beenReset=!1,s.swapTex=!s.swapTex,s.prevWorldBoundsSize.copy(s.worldBoundsSize),s.prevWorldBoundsCenter.copy(s.worldBounds.center),s.pack8&&this._setInputBounds()},o}();function Ty(o,a){return(Ty=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ey=["NONE","VERTEX","MAP"],rI=new(function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ty(a,o);var i=a.prototype;return i.generateKey=function(t){var e="particle_"+bi.definesHash(t.defines)+"_";for(var n in t)t.hasOwnProperty(n)&&(e+=t[n]);return e},i.createVertexDefines=function(t,e){var n=new Map(t.defines);return t.mesh&&n.set("USE_MESH",""),t.meshUv&&n.set("USE_MESH_UV",""),t.localSpace&&n.set("LOCAL_SPACE",""),t.screenSpace&&n.set("SCREEN_SPACE",""),t.animTex&&n.set("ANIMTEX",""),t.soft>0&&n.set("SOFT",""),t.stretch>0&&n.set("STRETCH",""),t.customFace&&n.set("CUSTOM_FACE",""),t.pack8&&n.set("PACK8",""),t.localSpace&&n.set("LOCAL_SPACE",""),t.animTexLoop&&n.set("ANIMTEX_LOOP",""),t.wrap&&n.set("WRAP",""),t.alignToMotion&&n.set("ALIGN_TO_MOTION",""),n.set("NORMAL",Ey[t.normal]),e.particle_vertexData=oe,t.mesh&&t.meshUv&&(e.particle_uv=mt),n},i.createFragmentDefines=function(t){var e=new Map(t.defines);return t.soft>0&&e.set("SOFT",""),t.halflambert&&e.set("HALF_LAMBERT",""),e.set("NORMAL",Ey[t.normal]),e.set("BLEND",Pf[t.blend]),e},i.createShaderDefinition=function(t,e){var n=t.isWebGPU?he:ue,r=re.get(t,n),s={},l=this.createVertexDefines(e,s),u=this.createFragmentDefines(e),c="PARTICLE_"+(e.useCpu?"CPU":"GPU")+`
`;l.set(c,""),u.set(c,"");var h=new Map(r);return ir.createDefinition(t,{name:"ParticleShader",shaderLanguage:n,attributes:s,vertexCode:r.get("particle_shaderVS"),fragmentCode:r.get("particle_shaderPS"),fragmentDefines:u,fragmentIncludes:h,vertexIncludes:h,vertexDefines:l})},a}(bi));function wy(o,a){return(wy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var sI=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){var t;return(t=o.call(this)||this).emitter=null,t.emitter=i,t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&wy(a,o),a.prototype.getShaderVariant=function(i){var t,e,n=i.device,r=i.scene,s=i.cameraShaderParams,l=i.objDefs,u=this.emitter,c={defines:Te.getCoreDefines(this,i),pass:0,useCpu:this.emitter.useCpu,normal:u.lighting?u.normalMap!==null?2:1:0,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,meshUv:4&l,gamma:(t=s==null?void 0:s.shaderOutputGamma)!=null?t:0,toneMap:(e=s==null?void 0:s.toneMapping)!=null?e:0,fog:r&&!this.emitter.noFog?r.fog.type:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!u.inTools&&this.emitter.screenSpace,blend:this.emitter.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==0},h=new Io(i.viewUniformFormat,i.viewBindGroupFormat,i.vertexFormat),f=sr(n);return f.register("particle",rI),f.getProgram("particle",c,h,this.userId)},a}(Ci),Ay=[[-1,-1],[1,-1],[1,1],[-1,1]];function mn(o,a,i,t,e,n,r){e===void 0&&(e=14);var s=0;r&&(e===7||e===20)&&(s=1);var l=new ee(o,{width:a,height:i,format:e,cubemap:!1,mipmaps:!1,minFilter:s,magFilter:s,addressU:1,addressV:1,name:"ParticleSystemTexture"}),u=l.lock();if(e===7||e===20){for(var c=new Uint8Array(t.length),h=0;h<t.length;h++)c[h]=t[h]*n*255;t=c}return u.set(t),l.unlock(),l}function Cy(o){return Math.max(Math.min(o,1),0)}var Py=new cn([0,0,1,0]),Iy=new cn([0,1,1,1]),Ly=new tr([0,0,1,0],[0,0,1,0],[0,0,1,0]),aI=new tr([0,1,1,1],[0,1,1,1],[0,1,1,1]),Li=2,Di=new Float32Array(3),Yr=new X,Dy=new E,Uu=new E,Bu=new E;function ne(o,a){zl[o]!==void 0&&zl[o]!==null?Ch[o]=zl[o]:Ch[o]=a}function My(o,a,i){return(255*o<<16|255*a<<8|255*i)/16777216}function Ry(o,a){for(var i=o.length/3,t=Array(4*i),e=0;e<i;e++)t[4*e]=o[3*e],t[4*e+1]=o[3*e+1],t[4*e+2]=o[3*e+2],t[4*e+3]=My(a[3*e],a[3*e+1],a[3*e+2]);return t}function qr(o,a){for(var i=a.length,t=o.length/i,e=0;e<t;e++)for(var n=0;n<i;n++){var r=Math.abs(o[e*i+n]);a[n]=Math.max(a[n],r)}}function Kr(o,a,i){var t=function(l,u){for(var c=new Float32Array(l.length),h=0;h<l.length;h++)c[h]=l[h]-u[h];return c}(a,o);qr(t,i);for(var e=i.length,n=t.length/e,r=0;r<n;r++)for(var s=0;s<e;s++)t[r*e+s]/=i[s]===0?1:i[s],t[r*e+s]*=.5,t[r*e+s]+=.5;return t}var oI=new It,Oy=function(){function o(t,e){this.material=null,this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.graphicsDevice=t,this.precision=32,this._addTimeTime=0,Ch=this,zl=e,ne("numParticles",1),this.numParticles>t.maxTextureSize&&(this.numParticles=t.maxTextureSize),ne("rate",1),ne("rate2",this.rate),ne("lifetime",50),ne("emitterExtents",new E(0,0,0)),ne("emitterExtentsInner",new E(0,0,0)),ne("emitterRadius",0),ne("emitterRadiusInner",0),ne("emitterShape",0),ne("initialVelocity",1),ne("wrap",!1),ne("localSpace",!1),ne("screenSpace",!1),ne("wrapBounds",null),ne("colorMap",this.defaultParamTexture),ne("normalMap",null),ne("loop",!0),ne("preWarm",!1),ne("sort",0),ne("mode",0),ne("scene",null),ne("lighting",!1),ne("halfLambert",!1),ne("intensity",1),ne("stretch",0),ne("alignToMotion",!1),ne("depthSoftening",0),ne("mesh",null),ne("particleNormal",new E(0,1,0)),ne("orientation",0),ne("depthWrite",!1),ne("noFog",!1),ne("blendType",2),ne("node",null),ne("startAngle",0),ne("startAngle2",this.startAngle),ne("animTilesX",1),ne("animTilesY",1),ne("animStartFrame",0),ne("animNumFrames",1),ne("animNumAnimations",1),ne("animIndex",0),ne("randomizeAnimIndex",!1),ne("animSpeed",1),ne("animLoop",!0),this._gpuUpdater=new iI(this,t),this._cpuUpdater=new nI(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),ne("colorGraph",aI),ne("colorGraph2",this.colorGraph),ne("scaleGraph",Iy),ne("scaleGraph2",this.scaleGraph),ne("alphaGraph",Iy),ne("alphaGraph2",this.alphaGraph),ne("localVelocityGraph",Ly),ne("localVelocityGraph2",this.localVelocityGraph),ne("velocityGraph",Ly),ne("velocityGraph2",this.velocityGraph),ne("rotationSpeedGraph",Py),ne("rotationSpeedGraph2",this.rotationSpeedGraph),ne("radialSpeedGraph",Py),ne("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!t.supportsGpuParticles,this.pack8=!0,this.localBounds=new Se,this.worldBoundsNoTrail=new Se,this.worldBoundsTrail=[new Se,new Se],this.worldBounds=new Se,this.worldBoundsSize=new E,this.prevWorldBoundsSize=new E,this.prevWorldBoundsCenter=new E,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new E,this.worldBoundsAdd=new E,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}var a,i=o.prototype;return i.onChangeCamera=function(){this.resetMaterial()},i.calculateBoundsMad=function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5},i.calculateWorldBounds=function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu&&((this.emitterShape===0?this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius===this.prevEmitterRadius)||this.calculateLocalBounds());var t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var e=this.simTimeTotal;e>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=e+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}},i.resetWorldBounds=function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?X.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)},i.calculateLocalBounds=function(){for(var t,e,n,r=Number.MAX_VALUE,s=Number.MAX_VALUE,l=Number.MAX_VALUE,u=-Number.MAX_VALUE,c=-Number.MAX_VALUE,h=-Number.MAX_VALUE,f=0,d=0,p=this.lifetime/this.precision,_=[this.qVelocity,this.qVelocity2],g=[this.qLocalVelocity,this.qLocalVelocity2],y=[0,0],v=[0,0],x=[0,0],S=[0,0],T=[0,0],b=0;b<this.precision+1;b++){for(var w=Math.min(b,this.precision-1),A=0;A<2;A++)t=g[A][3*w+0]*p+y[A],e=g[A][3*w+1]*p+v[A],n=g[A][3*w+2]*p+x[A],r=Math.min(t,r),s=Math.min(e,s),l=Math.min(n,l),u=Math.max(t,u),c=Math.max(e,c),h=Math.max(n,h),y[A]=t,v[A]=e,x[A]=n;for(var C=0;C<2;C++)T[C]+=p*Math.sqrt(_[C][3*w+0]*_[C][3*w+0]+_[C][3*w+1]*_[C][3*w+1]+_[C][3*w+2]*_[C][3*w+2]);S[0]+=this.qRadialSpeed[w]*p,S[1]+=this.qRadialSpeed2[w]*p,f=Math.max(f,Math.max(Math.abs(S[0]),Math.abs(S[1]))),d=Math.max(d,this.qScale[w])}this.emitterShape===0?(t=.5*this.emitterExtents.x,e=.5*this.emitterExtents.y,n=.5*this.emitterExtents.z):(t=this.emitterRadius,e=this.emitterRadius,n=this.emitterRadius);var L=Math.max(T[0],T[1]);Uu.x=r-d-t-f-L,Uu.y=s-d-e-f-L,Uu.z=l-d-n-f-L,Bu.x=u+d+t+f+L,Bu.y=c+d+e+f+L,Bu.z=h+d+n+f+L,this.localBounds.setMinMax(Uu,Bu)},i.rebuild=function(){var t=this.graphicsDevice;this.colorMap===null&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=this.emitterShape===0?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,Li=this.useCpu||this.pack8?4:2,this.useMesh=!!this.mesh,this.numParticlesPot=U.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?X.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles);for(var e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Li*4);var n=this.node===null||this.localSpace?E.ZERO:this.node.getPosition();this.emitterShape===0&&(this.node===null||this.localSpace?Yr.setTRS(E.ZERO,Z.IDENTITY,this.spawnBounds):Yr.setTRS(E.ZERO,this.node.getRotation(),Dy.copy(this.spawnBounds).mul(this.node.localScale)),Di[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,Di[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,Di[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(var r=0;r<this.numParticles;r++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Yr,Di,n,r),this.useCpu&&(this.particleTex[4*r+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Li*4);for(var s=0;s<this.particleTexStart.length;s++)this.particleTexStart[s]=this.particleTex[s];this.useCpu||(this.pack8?(this.particleTexIN=mn(t,this.numParticlesPot,Li,this.particleTex,7,1,!1),this.particleTexOUT=mn(t,this.numParticlesPot,Li,this.particleTex,7,1,!1),this.particleTexStart=mn(t,this.numParticlesPot,Li,this.particleTexStart,7,1,!1)):(this.particleTexIN=mn(t,this.numParticlesPot,Li,this.particleTex),this.particleTexOUT=mn(t,this.numParticlesPot,Li,this.particleTex),this.particleTexStart=mn(t,this.numParticlesPot,Li,this.particleTexStart)),this.rtParticleTexIN=new Ee({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new Ee({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);var l=new Map;this.localSpace&&l.set("LOCAL_SPACE",""),this.pack8&&l.set("PACK8",""),this.emitterShape===0&&l.set("EMITTERSHAPE_BOX","");var u="Shape:"+this.emitterShape+"-Pack:"+this.pack8+"-Local:"+this.localSpace,c={attributes:{vertex_position:oe},vertexChunk:"fullscreenQuadVS",fragmentChunk:"particle_simulationPS",fragmentDefines:l,fragmentIncludes:new Map(re.get(t,t.isWebGPU?he:ue))};c.uniqueName="ParticleUpdateRespawn-"+u,l.set("RESPAWN",""),this.shaderParticleUpdateRespawn=Te.createShader(t,c),l.delete("RESPAWN"),c.uniqueName="ParticleUpdateNoRespawn-"+u,l.set("NO_RESPAWN",""),this.shaderParticleUpdateNoRespawn=Te.createShader(t,c),l.delete("NO_RESPAWN"),c.uniqueName="ParticleUpdateStop-"+u,l.set("ON_STOP",""),this.shaderParticleUpdateOnStop=Te.createShader(t,c),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);var h=new ye(t);h.vertexBuffer=this.vertexBuffer,h.indexBuffer[0]=this.indexBuffer,h.primitive[0].type=4,h.primitive[0].base=0,h.primitive[0].count=this.numParticles*this.numParticleIndices,h.primitive[0].indexed=!0,this.material=this._createMaterial(),this.resetMaterial();var f=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new De(h,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=f,this._setMaterialTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)},i._isAnimated=function(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)},i.rebuildGraphs=function(){var t=this.precision,e=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t);for(var n=0;n<t;n++)this.qRotSpeed[n]*=U.DEG_TO_RAD,this.qRotSpeed2[n]*=U.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=Kr(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=Kr(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=Kr(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=Kr(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=Kr(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=Kr(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=Kr(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var r=[0,0,0];qr(this.qVelocity,r);var s=[0,0,0];qr(this.qVelocity2,s);var l=[0,0,0];qr(this.qLocalVelocity,l);var u=[0,0,0];qr(this.qLocalVelocity2,u);var c=[0];qr(this.qRadialSpeed,c);var h=[0];qr(this.qRadialSpeed2,h);var f=Math.max(r[0],s[0]);f=Math.max(f=Math.max(f=Math.max(f=Math.max(f,r[1]),s[1]),r[2]),s[2]);var d=Math.max(l[0],u[0]);d=Math.max(d=Math.max(d=Math.max(d=Math.max(d,l[1]),u[1]),l[2]),u[2]);var p=Math.max(c[0],h[0]);this.maxVel=f+d+p}this.useCpu||(this.internalTex0=mn(e,t,1,Ry(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=mn(e,t,1,Ry(this.qVelocity,this.qVelocityDiv)),this.internalTex2=mn(e,t,1,function(_,g,y,v,x){for(var S=Array(4*_.length),T=0;T<_.length;T++)S[4*T]=_[T],S[4*T+1]=g[T],S[4*T+2]=0,S[4*T+3]=My(y[T],v[T],x[T]);return S}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=mn(e,t,1,function(_,g){for(var y=Array(4*_.length),v=0;v<_.length;v++)y[4*v]=_[v],y[4*v+1]=g[v],y[4*v+2]=0,y[4*v+3]=0;return y}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=mn(e,t,1,function(_,g){for(var y=Array(4*g.length),v=0;v<g.length;v++)y[4*v]=_[3*v],y[4*v+1]=_[3*v+1],y[4*v+2]=_[3*v+2],y[4*v+3]=g[v];return y}(this.qColor,this.qAlpha),20,1,!0)},i._setMaterialTextures=function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},i._createMaterial=function(){var t=new sI(this);return t.name="EmitterMaterial:"+this.node.name,t.cull=0,t.alphaWrite=!1,t.blendType=this.blendType,t.depthWrite=this.depthWrite,t},i.resetMaterial=function(){var t=this.material;t.setParameter("stretch",this.stretch),this._isAnimated()&&(t.setParameter("animTexTilesParams",this.animTilesParams),t.setParameter("animTexParams",this.animParams),t.setParameter("animTexIndexParams",this.animIndexParams)),t.setParameter("colorMult",this.intensity),this.useCpu||(t.setParameter("internalTex0",this.internalTex0),t.setParameter("internalTex1",this.internalTex1),t.setParameter("internalTex2",this.internalTex2),t.setParameter("internalTex3",this.internalTex3)),t.setParameter("colorParam",this.colorParam),t.setParameter("numParticles",this.numParticles),t.setParameter("numParticlesPot",this.numParticlesPot),t.setParameter("lifetime",this.lifetime),t.setParameter("rate",this.rate),t.setParameter("rateDiv",this.rate2-this.rate),t.setParameter("seed",this.seed),t.setParameter("scaleDivMult",this.scaleUMax[0]),t.setParameter("alphaDivMult",this.alphaUMax[0]),t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),t.setParameter("graphNumSamples",this.precision),t.setParameter("graphSampleSize",1/this.precision),t.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),t.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,t.setParameter("wrapBounds",this.wrapBoundsUniform)),this._setMaterialTextures(),this.depthSoftening>0&&t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(t.cull=0),this._compParticleFaceParams()},i._compParticleFaceParams=function(){if(this.orientation===0)t=new Float32Array([1,0,0]),e=new Float32Array([0,0,1]);else{var t,e,n=this.orientation===1?this.particleNormal.normalize():(this.node===null?X.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize(),r=new E(1,0,0);Math.abs(r.dot(n))===1&&r.set(0,0,1);var s=new E().cross(n,r).normalize();r.cross(s,n).normalize(),t=new Float32Array([r.x,r.y,r.z]),e=new Float32Array([s.x,s.y,s.z])}this.material.setParameter("faceTangent",t),this.material.setParameter("faceBinorm",e)},i.getVertexInfo=function(){var t=[];return this.useCpu?t.push({semantic:Zl,components:4,type:6},{semantic:Ql,components:4,type:6},{semantic:jh,components:4,type:6},{semantic:Xh,components:1,type:6},{semantic:Yh,components:this.useMesh?4:2,type:6}):(t.push({semantic:Zl,components:4,type:6}),this.useMesh&&t.push({semantic:Ql,components:2,type:6})),t},i._allocate=function(t){var e=t*this.numParticleVerts,n=t*this.numParticleIndices;if(this.vertexBuffer===void 0||this.vertexBuffer.getNumVertices()!==e){var r,s,l,u=this.getVertexInfo(),c=new Ot(this.graphicsDevice,u);this.vertexBuffer=new Rt(this.graphicsDevice,c,e,{usage:1}),this.indexBuffer=new Yn(this.graphicsDevice,2,n);var h=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){s=(r=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices;for(var f=0;f<this.mesh.vertexBuffer.format.elements.length;f++)if(this.mesh.vertexBuffer.format.elements[f].name===mt){l=this.mesh.vertexBuffer.format.elements[f].offset/4;break}}for(var d=0;d<e;d++){var p=Math.floor(d/this.numParticleVerts);if(this.useMesh){var _=d%this.numParticleVerts;h[6*d]=r[_*s],h[6*d+1]=r[_*s+1],h[6*d+2]=r[_*s+2],h[6*d+3]=p,h[6*d+4]=r[_*s+l+0],h[6*d+5]=1-r[_*s+l+1]}else{var g=d%4;h[4*d]=Ay[g][0],h[4*d+1]=Ay[g][1],h[4*d+2]=0,h[4*d+3]=p}}this.useCpu&&(this.vbCPU=new Float32Array(h),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();var y=0,v=new Uint32Array(this.indexBuffer.lock());if(this.useMesh){var x=this.mesh.indexBuffer[0];r=new fo[x.format](x.lock())}for(var S=0;S<t;S++)if(this.useMesh)for(var T=0;T<this.numParticleIndices;T++)v[S*this.numParticleIndices+T]=r[T]+S*this.numParticleVerts;else{var b=4*S;v[y++]=b,v[y++]=b+1,v[y++]=b+2,v[y++]=b,v[y++]=b+2,v[y++]=b+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}},i.reset=function(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._setMaterialTextures();this.resetWorldBounds(),this.resetTime();var e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)},i.prewarm=function(t){for(var e=Math.min(Math.floor(t/this.lifetime*this.precision),this.precision),n=t/e,r=0;r<e;r++)this.addTime(n,!1)},i.resetTime=function(){var t;this.endTime=(t=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime,Date.now()+1e3*t)},i.finishFrame=function(){this.useCpu&&this.vertexBuffer.unlock()},i.addTime=function(t,e){var n,r=this.graphicsDevice;if(this.simTimeTotal+=t,this.calculateWorldBounds(),this._isAnimated()){var s=this.animTilesParams;s[0]=1/this.animTilesX,s[1]=1/this.animTilesY;var l=this.animParams;l[0]=this.animStartFrame,l[1]=this.animNumFrames*this.animSpeed,l[2]=this.animNumFrames-1,l[3]=this.animNumAnimations-1;var u=this.animIndexParams;u[0]=this.animIndex,u[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===0&&(Di[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,Di[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,Di[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0,this.meshInstance.node===null?Yr.setTRS(E.ZERO,Z.IDENTITY,this.emitterExtents):Yr.setTRS(E.ZERO,this.meshInstance.node.getRotation(),Dy.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));var c=this.meshInstance.node===null?E.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=c.x,this.emitterScaleUniform[1]=c.y,this.emitterScaleUniform[2]=c.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(n=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=n.x,this.emitterPosUniform[1]=n.y,this.emitterPosUniform[2]=n.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){var h=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(h,this.vbToSort,this.particleTex,Yr,Di,n,t,e)}else this._gpuUpdater.update(r,Yr,Di,t,e);!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)},i._destroyResources=function(){var t,e,n,r,s,l,u,c,h,f,d,p;(t=this.particleTexIN)==null||t.destroy(),this.particleTexIN=null,(e=this.particleTexOUT)==null||e.destroy(),this.particleTexOUT=null,this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),(n=this.rtParticleTexIN)==null||n.destroy(),this.rtParticleTexIN=null,(r=this.rtParticleTexOUT)==null||r.destroy(),this.rtParticleTexOUT=null,(s=this.internalTex0)==null||s.destroy(),this.internalTex0=null,(l=this.internalTex1)==null||l.destroy(),this.internalTex1=null,(u=this.internalTex2)==null||u.destroy(),this.internalTex2=null,(c=this.internalTex3)==null||c.destroy(),this.internalTex3=null,(h=this.colorParam)==null||h.destroy(),this.colorParam=null,(f=this.vertexBuffer)==null||f.destroy(),this.vertexBuffer=void 0,(d=this.indexBuffer)==null||d.destroy(),this.indexBuffer=void 0,(p=this.material)==null||p.destroy(),this.material=null},i.destroy=function(){this.camera=null,this._destroyResources()},a=[{key:"defaultParamTexture",get:function(){var t=this;return oI.get(this.graphicsDevice,function(){for(var e=new Float32Array(1024),n=0;n<16;n++)for(var r=0;r<16;r++){var s=r+1-8.5,l=n+1-8.5,u=Cy(1-Cy(Math.sqrt(s*s+l*l)/16)-.5),c=16*n+r;e[4*c]=1,e[4*c+1]=1,e[4*c+2]=1,e[4*c+3]=u}var h=mn(t.graphicsDevice,16,16,e,20,1,!0);return h.minFilter=1,h.magFilter=1,h})}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function ky(){return(ky=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function Ny(o,a){return(Ny=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var lI=new(function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ny(a,o);var i=a.prototype;return i.generateKey=function(t){var e,n,r=t.shaderDesc,s=r.vertexGLSL?dn(r.vertexGLSL):0,l=r.fragmentGLSL?dn(r.fragmentGLSL):0,u=r.vertexWGSL?dn(r.vertexWGSL):0,c=r.fragmentWGSL?dn(r.fragmentWGSL):0,h=bi.definesHash(t.defines),f=(n=(e=t.shaderChunks)==null?void 0:e.key)!=null?n:"",d=r.uniqueName+"_"+h+"_"+s+"_"+l+"_"+u+"_"+c+"_"+f;return t.skin&&(d+="_skin"),t.useInstancing&&(d+="_inst"),t.useMorphPosition&&(d+="_morphp"),t.useMorphNormal&&(d+="_morphn"),t.useMorphTextureBasedInt&&(d+="_morphi"),d},i.createAttributesDefinition=function(t,e){var n=e.shaderDesc.attributes,r=n?ky({},n):void 0;e.skin&&(r.vertex_boneWeights=fn,r.vertex_boneIndices=Pt),(e.useMorphPosition||e.useMorphNormal)&&(r.morph_vertex_id=Fr),t.attributes=r},i.createVertexDefinition=function(t,e,n,r){var s=e.shaderDesc,l=new Map(n);l.set("transformInstancingVS","");var u=new Map(e.defines);e.skin&&u.set("SKIN",!0),e.useInstancing&&u.set("INSTANCING",!0),(e.useMorphPosition||e.useMorphNormal)&&(u.set("MORPHING",!0),e.useMorphTextureBasedInt&&u.set("MORPHING_INT",!0),e.useMorphPosition&&u.set("MORPHING_POSITION",!0),e.useMorphNormal&&u.set("MORPHING_NORMAL",!0)),t.vertexCode=r?s.vertexWGSL:s.vertexGLSL,t.vertexIncludes=l,t.vertexDefines=u},i.createFragmentDefinition=function(t,e,n,r){var s=e.shaderDesc,l=new Map(n),u=new Map(e.defines);t.fragmentCode=r?s.fragmentWGSL:s.fragmentGLSL,t.fragmentIncludes=l,t.fragmentDefines=u},i.createShaderDefinition=function(t,e){var n,r,s=e.shaderDesc,l=t.isWebGPU&&!!s.vertexWGSL&&!!s.fragmentWGSL&&((r=(n=e.shaderChunks)==null?void 0:n.useWGSL)==null||r),u={name:"ShaderMaterial-"+s.uniqueName,shaderLanguage:l?he:ue,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},c=l?he:ue,h=Lo.merge(re.get(t,c),e.shaderChunks[c]);return this.createAttributesDefinition(u,e),this.createVertexDefinition(u,e,h,l),this.createFragmentDefinition(u,e,h,l),ir.createDefinition(t,u)},a}(bi));function Fy(o,a){return(Fy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var hr=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this).shaderDesc=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Fy(a,o);var i,t=a.prototype;return t.copy=function(e){return o.prototype.copy.call(this,e),this.shaderDesc=e.shaderDesc,this},t.getShaderVariant=function(e){var n=e.objDefs,r={defines:Te.getCoreDefines(this,e),skin:(2&n)!=0,useInstancing:(32&n)!=0,useMorphPosition:(1024&n)!=0,useMorphNormal:(2048&n)!=0,useMorphTextureBasedInt:(8192&n)!=0,pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,shaderChunks:this.shaderChunks},s=new Io(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),l=sr(e.device);return l.register("shader-material",lI),l.getProgram("shader-material",r,s,this.userId)},i=[{key:"shaderDesc",get:function(){return this._shaderDesc},set:function(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){var n,r=(n=e.shaderLanguage)!=null?n:ue;r===ue?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):r===he&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode)}this.clearVariants()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ci),uI={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},cI={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"},Mi=function(){function o(){}return o.decodeFunc=function(a){var i;return(i=uI[a])!=null?i:"decodeGamma"},o.encodeFunc=function(a){var i;return(i=cI[a])!=null?i:"encodeGamma"},o}(),dd=function(o,a){for(var i=a.length/3,t=o.length/3,e=new E,n=new E,r=new E,s=new E,l=new E,u=new E,c=[],h=0;h<o.length;h++)c[h]=0;for(var f=0;f<i;f++){var d=a[3*f],p=a[3*f+1],_=a[3*f+2];e.set(o[3*d],o[3*d+1],o[3*d+2]),n.set(o[3*p],o[3*p+1],o[3*p+2]),r.set(o[3*_],o[3*_+1],o[3*_+2]),s.sub2(n,e),l.sub2(r,e),u.cross(s,l).normalize(),c[3*d]+=u.x,c[3*d+1]+=u.y,c[3*d+2]+=u.z,c[3*p]+=u.x,c[3*p+1]+=u.y,c[3*p+2]+=u.z,c[3*_]+=u.x,c[3*_+1]+=u.y,c[3*_+2]+=u.z}for(var g=0;g<t;g++){var y=c[3*g],v=c[3*g+1],x=c[3*g+2],S=1/Math.sqrt(y*y+v*v+x*x);c[3*g]*=S,c[3*g+1]*=S,c[3*g+2]*=S}return c},Ri=function(o,a,i,t){for(var e=t.length/3,n=o.length/3,r=new E,s=new E,l=new E,u=new G,c=new G,h=new G,f=new E,d=new E,p=new Float32Array(3*n),_=new Float32Array(3*n),g=[],y=0;y<e;y++){var v=t[3*y],x=t[3*y+1],S=t[3*y+2];r.set(o[3*v],o[3*v+1],o[3*v+2]),s.set(o[3*x],o[3*x+1],o[3*x+2]),l.set(o[3*S],o[3*S+1],o[3*S+2]),u.set(i[2*v],i[2*v+1]),c.set(i[2*x],i[2*x+1]),h.set(i[2*S],i[2*S+1]);var T=s.x-r.x,b=l.x-r.x,w=s.y-r.y,A=l.y-r.y,C=s.z-r.z,L=l.z-r.z,I=c.x-u.x,P=h.x-u.x,M=c.y-u.y,R=h.y-u.y,k=I*R-P*M;if(k===0)f.set(0,1,0),d.set(1,0,0);else{var D=1/k;f.set((R*T-M*b)*D,(R*w-M*A)*D,(R*C-M*L)*D),d.set((I*b-P*T)*D,(I*A-P*w)*D,(I*L-P*C)*D)}p[3*v+0]+=f.x,p[3*v+1]+=f.y,p[3*v+2]+=f.z,p[3*x+0]+=f.x,p[3*x+1]+=f.y,p[3*x+2]+=f.z,p[3*S+0]+=f.x,p[3*S+1]+=f.y,p[3*S+2]+=f.z,_[3*v+0]+=d.x,_[3*v+1]+=d.y,_[3*v+2]+=d.z,_[3*x+0]+=d.x,_[3*x+1]+=d.y,_[3*x+2]+=d.z,_[3*S+0]+=d.x,_[3*S+1]+=d.y,_[3*S+2]+=d.z}for(var O=new E,F=new E,N=new E,j=new E,z=0;z<n;z++){N.set(a[3*z],a[3*z+1],a[3*z+2]),O.set(p[3*z],p[3*z+1],p[3*z+2]),F.set(_[3*z],_[3*z+1],_[3*z+2]);var V=N.dot(O);j.copy(N).mulScalar(V),j.sub2(O,j).normalize(),g[4*z]=j.x,g[4*z+1]=j.y,g[4*z+2]=j.z,j.cross(N,O),g[4*z+3]=0>j.dot(F)?-1:1}return g},Ft=function(){function o(){}var a=o.prototype;return a.calculateNormals=function(){this.normals=dd(this.positions,this.indices)},a.calculateTangents=function(){this.tangents=Ri(this.positions,this.normals,this.uvs,this.indices)},o}();function Uy(o,a){return(Uy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var fr=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});var t,e,n,r,s,l=o.call(this)||this,u=(t=i.halfExtents)!=null?t:new E(.5,.5,.5),c=(e=i.widthSegments)!=null?e:1,h=(n=i.lengthSegments)!=null?n:1,f=(r=i.heightSegments)!=null?r:1,d=(s=i.yOffset)!=null?s:0,p=-u.y+d,_=u.y+d,g=[new E(-u.x,p,u.z),new E(u.x,p,u.z),new E(u.x,_,u.z),new E(-u.x,_,u.z),new E(u.x,p,-u.z),new E(-u.x,p,-u.z),new E(-u.x,_,-u.z),new E(u.x,_,-u.z)],y=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],v=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],x=[],S=[],T=[],b=[],w=0,A=function(C,L,I){for(var P=new E,M=new E,R=new E,k=new E,D=0;D<=L;D++)for(var O=0;O<=I;O++){P.lerp(g[y[C][0]],g[y[C][1]],D/L),M.lerp(g[y[C][0]],g[y[C][2]],O/I),R.sub2(M,g[y[C][0]]),k.add2(P,R);var F=D/L,N=O/I;x.push(k.x,k.y,k.z),S.push(v[C][0],v[C][1],v[C][2]),T.push(F,1-N),N=(.875*N+.0625)/3,F=(.875*F+.0625)/3+C%3/3,N+=Math.floor(C/3)/3,D<L&&O<I&&(b.push(w+I+1,w+1,w),b.push(w+I+1,w+I+2,w+1)),w++}};return A(0,c,f),A(1,c,f),A(2,c,h),A(3,c,h),A(4,h,f),A(5,h,f),l.positions=x,l.normals=S,l.uvs=T,l.uvs1=T,l.indices=b,i.calculateTangents&&(l.tangents=Ri(x,S,T,b)),l}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Uy(a,o),a}(Ft);function By(o,a){return(By=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var oa=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});for(var t,e,n,r=o.call(this)||this,s=(t=i.radius)!=null?t:.5,l=(e=i.latitudeBands)!=null?e:16,u=(n=i.longitudeBands)!=null?n:16,c=[],h=[],f=[],d=[],p=0;p<=l;p++)for(var _=p*Math.PI/l,g=Math.sin(_),y=Math.cos(_),v=0;v<=u;v++){var x=2*v*Math.PI/u-Math.PI/2,S=Math.sin(x),T=Math.cos(x)*g,b=S*g,w=1-v/u,A=1-p/l;c.push(T*s,y*s,b*s),h.push(T,y,b),f.push(w,1-A)}for(var C=0;C<l;++C)for(var L=0;L<u;++L){var I=C*(u+1)+L,P=I+u+1;d.push(I+1,P,I),d.push(I+1,P+1,P)}return r.positions=c,r.normals=h,r.uvs=f,r.uvs1=f,r.indices=d,i.calculateTangents&&(r.tangents=Ri(c,h,f,d)),r}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&By(a,o),a}(Ft);function Vy(o,a){return(Vy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var zy=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});var t,e,n,r=(e=i.latitudeBands)!=null?e:16,s=(n=i.longitudeBands)!=null?n:16;t=o.call(this,{radius:.5,latitudeBands:r,longitudeBands:s})||this;for(var l=t.positions,u=0;u<l.length;u+=3){var c=l[u]/.5,h=l[u+1]/.5,f=l[u+2]/.5;h<0&&(h*=.3,c*c+f*f<.9025&&(h=-.1)),h+=.1,h*=.5,l[u+1]=h}return t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Vy(a,o),a}(oa),hI=function(){function o(){}return o.create=function(a,i){switch(i){case"box":return o.box(a);case Qv:return o.dome(a)}return o.infinite(a)},o.infinite=function(a){return ye.fromGeometry(a,new fr(a))},o.box=function(a){return ye.fromGeometry(a,new fr({yOffset:.5}))},o.dome=function(a){var i=new zy({latitudeBands:50,longitudeBands:50});return i.normals=void 0,i.uvs=void 0,ye.fromGeometry(a,i)},o}(),fI=function(){var o;function a(i,t,e,n,r){this.meshInstance=null,this._depthWrite=!1;var s=new hr({uniqueName:"SkyMaterial",vertexGLSL:re.get(i,ue).get("skyboxVS"),fragmentGLSL:re.get(i,ue).get("skyboxPS"),vertexWGSL:re.get(i,he).get("skyboxVS"),fragmentWGSL:re.get(i,he).get("skyboxPS"),attributes:{aPosition:oe}});s.setDefine("{SKYBOX_DECODE_FNC}",Mi.decodeFunc(n.encoding)),r!==Po&&s.setDefine("SKYMESH",""),n.cubemap&&s.setDefine("SKY_CUBEMAP",""),s.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),n.cubemap?s.setParameter("texture_cubeMap",n):(s.setParameter("texture_envAtlas",n),s.setParameter("mipLevel",t.skyboxMip)),s.cull=2,s.depthWrite=this._depthWrite;var l=t.layers.getLayerById(2);if(l){var u=new De(hI.create(i,r),s,e);this.meshInstance=u,u.cull=!1,u.pick=!1,l.addMeshInstances([u]),this.skyLayer=l}}return a.prototype.destroy=function(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)},o=[{key:"depthWrite",get:function(){return this._depthWrite},set:function(i){this._depthWrite=i,this.meshInstance&&(this.meshInstance.material.depthWrite=i)}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),Gy=function(){function o(t){this._type=Po,this._center=new E(0,1,0),this.skyMesh=null,this._depthWrite=!1,this.node=new pe("SkyMeshNode"),this.device=t.device,this.scene=t,this.center=new E(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}var a,i=o.prototype;return i.applySettings=function(t){var e,n,r,s;this.type=(e=t.skyType)!=null?e:Po,this.node.setLocalPosition(new E((n=t.skyMeshPosition)!=null?n:[0,0,0])),this.node.setLocalEulerAngles(new E((r=t.skyMeshRotation)!=null?r:[0,0,0])),this.node.setLocalScale(new E((s=t.skyMeshScale)!=null?s:[1,1,1])),t.skyCenter&&(this._center=new E(t.skyCenter))},i.updateSkyMesh=function(){var t=this.scene._getSkyboxTex();t&&(this.resetSkyMesh(),this.skyMesh=new fI(this.device,this.scene,this.node,t,this.type),this.skyMesh.depthWrite=this._depthWrite,this.scene.fire("set:skybox",t))},i.resetSkyMesh=function(){var t;(t=this.skyMesh)==null||t.destroy(),this.skyMesh=null},i.update=function(){if(this.type!==Po){var t=this.center,e=this.centerArray,n=new E;this.node.getWorldTransform().transformPoint(t,n),e[0]=n.x,e[1]=n.y,e[2]=n.z,this.projectedSkydomeCenterId.setValue(e)}},a=[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.scene.updateShaders=!0,this.updateSkyMesh())}},{key:"center",get:function(){return this._center},set:function(t){this._center.copy(t)}},{key:"depthWrite",get:function(){return this._depthWrite},set:function(t){this._depthWrite!==t&&(this._depthWrite=t,this.skyMesh&&(this.skyMesh.depthWrite=t))}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),Vu=new pe;Vu.worldTransform=X.IDENTITY,Vu._dirtyWorld=Vu._dirtyNormal=!1;var dI=function(){function o(i,t,e){this.material=t,this.layer=e,this.positions=[],this.colors=[],this.mesh=new ye(i),this.meshInstance=null}var a=o.prototype;return a.addLines=function(i,t){for(var e=this.positions,n=i.length,r=0;r<n;r++){var s=i[r];e.push(s.x,s.y,s.z)}var l=this.colors;if(t.length)for(var u=0;u<n;u++){var c=t[u];l.push(c.r,c.g,c.b,c.a)}else for(var h=0;h<n;h++)l.push(t.r,t.g,t.b,t.a)},a.addLinesArrays=function(i,t){for(var e=this.positions,n=0;n<i.length;n+=3)e.push(i[n],i[n+1],i[n+2]);var r=this.colors;if(t.length)for(var s=0;s<t.length;s+=4)r.push(t[s],t[s+1],t[s+2],t[s+3]);else for(var l=i.length/3,u=0;u<l;u++)r.push(t.r,t.g,t.b,t.a)},a.onPreRender=function(i,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new De(this.mesh,this.material,Vu)),i.push(this.meshInstance))},a.clear=function(){this.positions.length=0,this.colors.length=0},o}(),pI=function(){function o(i){this.device=i,this.map=new Map}var a=o.prototype;return a.getBatch=function(i,t){var e=this.map.get(i);return e||(e=new dI(this.device,i,t),this.map.set(i,e)),e},a.onPreRender=function(i,t){this.map.forEach(function(e){e.onPreRender(i,t)})},a.clear=function(){this.map.forEach(function(i){return i.clear()})},o}(),_n=[],la=new E,mI=function(){function o(t){this.shaderDescs=new Map,this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}var a,i=o.prototype;return i.createMaterial=function(t){var e=new hr({uniqueName:"ImmediateLine",vertexGLSL:re.get(this.device,ue).get("immediateLineVS"),fragmentGLSL:re.get(this.device,ue).get("immediateLinePS"),vertexWGSL:re.get(this.device,he).get("immediateLineVS"),fragmentWGSL:re.get(this.device,he).get("immediateLinePS"),attributes:{vertex_position:oe,vertex_color:st}});return e.blendType=2,e.depthTest=t,e.update(),e},i.getBatch=function(t,e){var n=this.batchesMap.get(t);n||(n=new pI(this.device),this.batchesMap.set(t,n)),this.allBatches.add(n);var r=e?this.materialDepth:this.materialNoDepth;return n.getBatch(r,t)},i.getShaderDesc=function(t,e,n){return this.shaderDescs.has(t)||this.shaderDescs.set(t,{uniqueName:"DebugShader:"+t,vertexGLSL:`
					attribute vec2 vertex_position;
					uniform mat4 matrix_model;
					varying vec2 uv0;
					void main(void) {
						gl_Position = matrix_model * vec4(vertex_position, 0, 1);
						uv0 = vertex_position.xy + 0.5;
					}
				`,vertexWGSL:`
					attribute vertex_position: vec2f;
					uniform matrix_model: mat4x4f;
					varying uv0: vec2f;
					@vertex fn vertexMain(input: VertexInput) -> VertexOutput {
						var output: VertexOutput;
						output.position = uniform.matrix_model * vec4f(input.vertex_position, 0.0, 1.0);
						output.uv0 = input.vertex_position.xy + vec2f(0.5);
						return output;
					}
				`,fragmentGLSL:e,fragmentWGSL:n,attributes:{vertex_position:oe}}),this.shaderDescs.get(t)},i.getTextureShaderDesc=function(t){var e=Mi.decodeFunc(t);return this.getShaderDesc("textureShader-"+t,`
			#include "gammaPS"
			varying vec2 uv0;
			uniform sampler2D colorMap;
			void main (void) {
				vec3 linearColor = `+e+`(texture2D(colorMap, uv0));
				gl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);
			}
		`,`
			#include "gammaPS"
			varying uv0: vec2f;
			var colorMap: texture_2d<f32>;
			var colorMapSampler: sampler;
			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let sampledTex = textureSample(colorMap, colorMapSampler, input.uv0);
				let linearColor: vec3f = `+e+`(sampledTex);
				output.color = vec4f(gammaCorrectOutput(linearColor), 1.0);
				return output;
			}
		`)},i.getUnfilterableTextureShaderDesc=function(){return this.getShaderDesc("textureShaderUnfilterable",`
			varying vec2 uv0;
			uniform highp sampler2D colorMap;
			void main (void) {
				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));
				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);
			}
		`,`
			varying uv0: vec2f;
			var colorMap: texture_2d<uff>;
			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let uv : vec2<i32> = vec2<i32>(input.uv0 * vec2f(textureDimensions(colorMap, 0)));
				let fetchedColor : vec4f = textureLoad(colorMap, uv, 0);
				output.color = vec4f(fetchedColor.xyz, 1.0);
				return output;
			}
		`)},i.getDepthTextureShaderDesc=function(){return this.getShaderDesc("depthTextureShader",`
			#include "screenDepthPS"
			#include "gammaPS"
			varying vec2 uv0;
			void main() {
				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;
				gl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);
			}
		`,`
			#include "screenDepthPS"
			#include "gammaPS"
			varying uv0: vec2f;
			@fragment fn fragmentMain(input: FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let depth: f32 = getLinearScreenDepth(getImageEffectUV(input.uv0)) * uniform.camera_params.x;
				output.color = vec4f(gammaCorrectOutput(vec3f(depth)), 1.0);
				return output;
			}
		`)},i.getQuadMesh=function(){return this.quadMesh||(this.quadMesh=new ye(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh},i.drawMesh=function(t,e,n,r,s){r||(r=new De(n,t,this.getGraphNode(e)));var l=this.layerMeshInstances.get(s);l||(l=[],this.layerMeshInstances.set(s,l)),l.push(r)},i.drawWireAlignedBox=function(t,e,n,r,s,l){if(l){var u=function(c,h,f){la.set(c,h,f),l.transformPoint(la,la),_n.push(la.x,la.y,la.z)};u(t.x,t.y,t.z),u(t.x,e.y,t.z),u(t.x,e.y,t.z),u(e.x,e.y,t.z),u(e.x,e.y,t.z),u(e.x,t.y,t.z),u(e.x,t.y,t.z),u(t.x,t.y,t.z),u(t.x,t.y,e.z),u(t.x,e.y,e.z),u(t.x,e.y,e.z),u(e.x,e.y,e.z),u(e.x,e.y,e.z),u(e.x,t.y,e.z),u(e.x,t.y,e.z),u(t.x,t.y,e.z),u(t.x,t.y,t.z),u(t.x,t.y,e.z),u(t.x,e.y,t.z),u(t.x,e.y,e.z),u(e.x,e.y,t.z),u(e.x,e.y,e.z),u(e.x,t.y,t.z),u(e.x,t.y,e.z)}else _n.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(s,r).addLinesArrays(_n,n),_n.length=0},i.drawWireSphere=function(t,e,n,r,s,l){for(var u=2*Math.PI/r,c=0,h=0;h<r;h++){var f=Math.sin(c),d=Math.cos(c),p=Math.sin(c+=u),_=Math.cos(c);_n.push(t.x+e*f,t.y,t.z+e*d),_n.push(t.x+e*p,t.y,t.z+e*_),_n.push(t.x+e*f,t.y+e*d,t.z),_n.push(t.x+e*p,t.y+e*_,t.z),_n.push(t.x,t.y+e*f,t.z+e*d),_n.push(t.x,t.y+e*p,t.z+e*_)}this.getBatch(l,s).addLinesArrays(_n,n),_n.length=0},i.getGraphNode=function(t){var e=new pe("ImmediateDebug");return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e},i.onPreRenderLayer=function(t,e,n){if(this.batchesMap.forEach(function(l,u){u===t&&l.onPreRender(e,n)}),!this.updatedLayers.has(t)){this.updatedLayers.add(t);var r=this.layerMeshInstances.get(t);if(r){for(var s=0;s<r.length;s++)e.push(r[s]);r.length=0}}},i.onPostRender=function(){this.allBatches.forEach(function(t){return t.clear()}),this.allBatches.clear(),this.updatedLayers.clear()},a=[{key:"materialDepth",get:function(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}},{key:"materialNoDepth",get:function(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),Ho={circlePointDeterministic:function(o,a,i){var t=2.399963229728653*a,e=Math.sqrt(a)/Math.sqrt(i);o.x=e*Math.cos(t),o.y=e*Math.sin(t)},spherePointDeterministic:function(o,a,i,t,e){t===void 0&&(t=0),e===void 0&&(e=1),t=1-2*t,e=1-2*e;var n=U.lerp(t,e,a/i),r=Math.sqrt(1-n*n),s=2.399963229728653*a;o.x=Math.cos(s)*r,o.y=n,o.z=Math.sin(s)*r},radicalInverse:function(o){var a=(o<<16|o>>>16)>>>0;return 23283064365386963e-26*(a=((16711935&(a=((252645135&(a=((858993459&(a=((1431655765&a)<<1|(2863311530&a)>>>1)>>>0))<<2|(3435973836&a)>>>2)>>>0))<<4|(4042322160&a)>>>4)>>>0))<<8|(4278255360&a)>>>8)>>>0)}},Hy=function(o){switch(o){case eu:return"Cubemap";case d_:return"Octahedral";default:return"Equirect"}},zu=function(o,a,i){if(o<=0)a[i+0]=0,a[i+1]=0,a[i+2]=0,a[i+3]=0;else if(o>=1)a[i+0]=255,a[i+1]=0,a[i+2]=0,a[i+3]=0;else{var t=o%1,e=255*o%1,n=65025*o%1,r=16581375*o%1;t-=e/255,e-=n/255,n-=r/255,a[i+0]=Math.min(255,Math.floor(256*t)),a[i+1]=Math.min(255,Math.floor(256*e)),a[i+2]=Math.min(255,Math.floor(256*n)),a[i+3]=Math.min(255,Math.floor(256*r))}},_I=function(o){for(var a=o.length,i=Math.min(a,512),t=Math.ceil(a/i),e=new Uint8Array(i*t*4),n=0,r=0;r<a;r+=4)zu(.5*o[r+0]+.5,e,n+0),zu(.5*o[r+1]+.5,e,n+4),zu(.5*o[r+2]+.5,e,n+8),zu(o[r+3]/8,e,n+12),n+=16;return{width:i,height:t,data:e}},vI=function(o,a,i,t){var e=2*i*Math.PI,n=Math.pow(1-a,1/(t+1)),r=Math.sqrt(1-n*n);o.set(Math.cos(e)*r,Math.sin(e)*r,n).normalize()},gI=function(o,a,i){var t=2*i*Math.PI,e=Math.sqrt(1-a),n=Math.sqrt(a);o.set(Math.cos(t)*n,Math.sin(t)*n,e).normalize()},yI=function(o,a,i,t){var e=2*i*Math.PI,n=Math.sqrt((1-a)/(1+(t*t-1)*a)),r=Math.sqrt(1-n*n);o.set(Math.cos(e)*r,Math.sin(e)*r,n).normalize()},SI=function(o,a){var i=o*a,t=a/(1-o*o+i*i);return t*t*(1/Math.PI)},xI=function(o,a){for(var i=new E,t=[],e=0;e<o;++e)vI(i,e/o,Ho.radicalInverse(e),a),t.push(i.x,i.y,i.z,0);return t},bI=function(o,a){for(var i=a/o,t=new E,e=[],n=0;n<o;++n){gI(t,n/o,Ho.radicalInverse(n));var r=.5*Math.log2(i/(t.z/Math.PI));e.push(t.x,t.y,t.z,r)}return e},TI={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},EI=function(o,a){var i=TI[o];return i&&i[a]||o},wI=function(o,a,i){for(var t=i/o,e=1-Math.log2(a)/11,n=e*e,r=new E,s=new E,l=new E(0,0,1),u=[],c=EI(o,a),h=0;h<c;++h){yI(r,h/c,Ho.radicalInverse(h),n);var f=r.z;if(s.set(r.x,r.y,r.z).mulScalar(2*f).sub(l),s.z>0){var d=.5*Math.log2(t/(SI(Math.min(1,f),n)/4+.001));u.push(s.x,s.y,s.z,d)}}for(;u.length<4*o;)u.push(0,0,0,0);return u},AI=function(o,a,i){var t=_I(i);return new ee(o,{name:a,width:t.width,height:t.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[t.data]})},Wy=function(){function o(i){i===void 0&&(i=!0),this.map=new Map,this.destroyContent=i}var a=o.prototype;return a.destroy=function(){this.destroyContent&&this.map.forEach(function(i,t){i.destroy()})},a.get=function(i,t){if(!this.map.has(i)){var e=t();return this.map.set(i,e),e}return this.map.get(i)},o}(),CI=new Wy(!1),PI=new It,pd=function(o,a,i){return PI.get(o,function(){return new Wy}).get(a,function(){return AI(o,a,CI.get(a,i))})};function Jn(o,a,i){i===void 0&&(i={});var t,e,n,r,s,l=(n=i.seamPixels)!=null?n:0,u=((r=(t=i.rect)==null?void 0:t.z)!=null?r:a.width)-2*l,c=((s=(e=i.rect)==null?void 0:e.w)!=null?s:a.height)-2*l;if(u<1||c<1)return!1;var h=i.hasOwnProperty("specularPower")?i.specularPower:1,f=i.hasOwnProperty("face")?i.face:null,d=i.hasOwnProperty("distribution")?i.distribution:h===1?"none":"phong",p={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[d]||"reproject",_=p.startsWith("prefilterSamples"),g=Mi.decodeFunc(o.encoding),y=Mi.encodeFunc(a.encoding),v="sample"+Hy(o.projection),x="getDirection"+Hy(a.projection),S=i.hasOwnProperty("numSamples")?i.numSamples:1024,T="ReprojectShader:"+p+"_"+g+"_"+y+"_"+v+"_"+x+"_"+S,b=o.device,w=sr(b).getCachedShader(T);if(!w){var A=new Map;_&&A.set("USE_SAMPLES_TEX",""),o.cubemap&&A.set("CUBEMAP_SOURCE",""),A.set("{PROCESS_FUNC}",p),A.set("{DECODE_FUNC}",g),A.set("{ENCODE_FUNC}",y),A.set("{SOURCE_FUNC}",v),A.set("{TARGET_FUNC}",x),A.set("{NUM_SAMPLES}",S),A.set("{NUM_SAMPLES_SQRT}",Math.round(Math.sqrt(S)).toFixed(1));var C=b.isWebGPU,L=re.get(b,C?he:ue),I=new Map;I.set("decodePS",L.get("decodePS")),I.set("encodePS",L.get("encodePS")),w=Te.createShader(b,{uniqueName:T,attributes:{vertex_position:oe},vertexChunk:"reprojectVS",fragmentChunk:"reprojectPS",fragmentIncludes:I,fragmentDefines:A})}b.setBlendState(ge.NOBLEND),b.scope.resolve(o.cubemap?"sourceCube":"sourceTex").setValue(o);var P=b.scope.resolve("params"),M=b.scope.resolve("uvMod");l>0?M.setValue([(u+2*l)/u,(c+2*l)/c,-l/u,-l/c]):M.setValue([1,1,0,0]);var R=[0,a.width*a.height*(a.cubemap?6:1),o.width*o.height*(o.cubemap?6:1)];if(_){var k=o.width*o.height*(o.cubemap?6:1),D=d==="ggx"?pd(b,"ggx-samples-"+S+"-"+h+"-"+k,function(){return wI(S,h,k)}):d==="lambert"?pd(b,"lambert-samples-"+S+"-"+k,function(){return bI(S,k)}):pd(b,"phong-samples-"+S+"-"+h,function(){return xI(S,h)});b.scope.resolve("samplesTex").setValue(D),b.scope.resolve("samplesTexInverseSize").setValue([1/D.width,1/D.height])}for(var O=0;O<(a.cubemap?6:1);O++)if(f===null||O===f){var F=new Ee({colorBuffer:a,face:O,depth:!1,flipY:b.isWebGPU});R[0]=O,P.setValue(R),kt(b,F,w,i==null?void 0:i.rect),F.destroy()}return!0}var md=function(o,a){return a===void 0&&(a=0),1+Math.floor(Math.log2(Math.max(o,a)))},_d=function(){function o(){}return o.generateSkyboxCubemap=function(a,i){var t,e,n=(t=a.device,e=i||(a.cubemap?a.width:a.width/4),new ee(t,{name:"lighting-"+e,cubemap:!0,width:e,height:e,format:7,type:Os,addressU:1,addressV:1,mipmaps:!1}));return Jn(a,n,{numSamples:1024}),n},o.generateLightingSource=function(a,i){var t,e=a.device,n=(t=e).textureHalfFloatRenderable?12:t.textureFloatRenderable?14:7,r=(i==null?void 0:i.target)||new ee(e,{name:"lighting-source",cubemap:!0,width:(i==null?void 0:i.size)||128,height:(i==null?void 0:i.size)||128,format:n,type:n===7?Os:Wt,addressU:1,addressV:1,mipmaps:!0});return Jn(a,r,{numSamples:a.mipmaps?1:1024}),r},o.generateAtlas=function(a,i){for(var t=a.device,e=(i==null?void 0:i.target)||new ee(t,{name:"envAtlas",width:(i==null?void 0:i.size)||512,height:(i==null?void 0:i.size)||512,format:7,type:Os,projection:qh,addressU:1,addressV:1,mipmaps:!1}),n=e.width/512,r=new q(0,0,512*n,256*n),s=md(256)-md(4),l=0;l<s;++l)Jn(a,e,{numSamples:1,rect:r,seamPixels:n}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));r.set(0,256*n,256*n,128*n);for(var u=1;u<7;++u)Jn(a,e,{numSamples:(i==null?void 0:i.numReflectionSamples)||1024,distribution:(i==null?void 0:i.distribution)||"ggx",specularPower:Math.max(1,2048>>2*u),rect:r,seamPixels:n}),r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));return r.set(128*n,384*n,64*n,32*n),Jn(a,e,{numSamples:(i==null?void 0:i.numAmbientSamples)||2048,distribution:"lambert",rect:r,seamPixels:n}),e},o.generatePrefilteredAtlas=function(a,i){for(var t=a[0].device,e=a[0].format,n=a[0].type,r=(i==null?void 0:i.target)||new ee(t,{name:"envPrefilteredAtlas",width:(i==null?void 0:i.size)||512,height:(i==null?void 0:i.size)||512,format:e,type:n,projection:qh,addressU:1,addressV:1,mipmaps:!1}),s=r.width/512,l=new q(0,0,512*s,256*s),u=md(512),c=0;c<u;++c)Jn(a[0],r,{numSamples:1,rect:l,seamPixels:s}),l.x+=l.w,l.y+=l.w,l.z=Math.max(1,Math.floor(.5*l.z)),l.w=Math.max(1,Math.floor(.5*l.w));l.set(0,256*s,256*s,128*s);for(var h=1;h<a.length;++h)Jn(a[h],r,{numSamples:1,rect:l,seamPixels:s}),l.y+=l.w,l.z=Math.max(1,Math.floor(.5*l.z)),l.w=Math.max(1,Math.floor(.5*l.w));return l.set(128*s,384*s,64*s,32*s),i!=null&&i.legacyAmbient?Jn(a[5],r,{numSamples:1,rect:l,seamPixels:s}):Jn(a[0],r,{numSamples:(i==null?void 0:i.numSamples)||2048,distribution:"lambert",rect:l,seamPixels:s}),r},o}(),jy=function(){this.type=Gr,this.color=new B(0,0,0),this.density=0,this.start=1,this.end=1e3};function Xy(o,a){return(Xy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var $e=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this).ambientBake=!1,n.ambientBakeOcclusionBrightness=0,n.ambientBakeOcclusionContrast=0,n.ambientLight=new B(0,0,0),n.ambientLuminance=0,n.exposure=1,n.lightmapSizeMultiplier=1,n.lightmapMaxResolution=2048,n.lightmapMode=1,n.lightmapFilterEnabled=!1,n.lightmapHDR=!1,n.root=null,n.physicalUnits=!1,n._envAtlas=null,n._skyboxCubeMap=null,n._fogParams=new jy,n.forcePassThroughSpecular=!1,n.device=e,n._gravity=new E(0,-9.8,0),n._layers=null,n._prefilteredCubemaps=[],n._internalEnvAtlas=null,n._skyboxIntensity=1,n._skyboxLuminance=0,n._skyboxMip=0,n._skyboxHighlightMultiplier=1,n._skyboxRotationShaderInclude=!1,n._skyboxRotation=new Z,n._skyboxRotationMat3=new zt,n._skyboxRotationMat4=new X,n._ambientBakeNumSamples=1,n._ambientBakeSpherePart=.4,n._lightmapFilterRange=10,n._lightmapFilterSmoothness=.2,n._clusteredLightingEnabled=!0,n._lightingParams=new ld(n.device.supportsAreaLights,n.device.maxTextureSize,function(){n.updateShaders=!0}),n._sky=new Gy(n),n._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},n.updateShaders=!0,n._shaderVersion=0,n.immediate=new mI(n.device),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Xy(a,o);var i,t=a.prototype;return t.destroy=function(){this._resetSkyMesh(),this.root=null,this.off()},t.drawLine=function(e,n,r,s,l){r===void 0&&(r=B.WHITE),s===void 0&&(s=!0),l===void 0&&(l=this.defaultDrawLayer),this.immediate.getBatch(l,s).addLines([e,n],[r,r])},t.drawLines=function(e,n,r,s){r===void 0&&(r=!0),s===void 0&&(s=this.defaultDrawLayer),this.immediate.getBatch(s,r).addLines(e,n)},t.drawLineArrays=function(e,n,r,s){r===void 0&&(r=!0),s===void 0&&(s=this.defaultDrawLayer),this.immediate.getBatch(s,r).addLinesArrays(e,n)},t.applySettings=function(e){var n,r,s,l,u=this,c=e.physics,h=e.render;this._gravity.set(c.gravity[0],c.gravity[1],c.gravity[2]),this.ambientLight.set(h.global_ambient[0],h.global_ambient[1],h.global_ambient[2]),this.ambientLuminance=h.ambientLuminance,this.fog.type=h.fog,this.fog.color.set(h.fog_color[0],h.fog_color[1],h.fog_color[2]),this.fog.start=h.fog_start,this.fog.end=h.fog_end,this.fog.density=h.fog_density,this.lightmapSizeMultiplier=h.lightmapSizeMultiplier,this.lightmapMaxResolution=h.lightmapMaxResolution,this.lightmapMode=h.lightmapMode,this.exposure=h.exposure,this._skyboxIntensity=(n=h.skyboxIntensity)!=null?n:1,this._skyboxLuminance=(r=h.skyboxLuminance)!=null?r:2e4,this._skyboxMip=(s=h.skyboxMip)!=null?s:0,h.skyboxRotation&&(this.skyboxRotation=new Z().setFromEulerAngles(h.skyboxRotation[0],h.skyboxRotation[1],h.skyboxRotation[2])),this.sky.applySettings(h),this.clusteredLightingEnabled=(l=h.clusteredLightingEnabled)!=null&&l,this.lighting.applySettings(h),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(function(f){h.hasOwnProperty(f)&&(u[f]=h[f])}),this._resetSkyMesh()},t._getSkyboxTex=function(){var e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas},t._updateSkyMesh=function(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()},t._resetSkyMesh=function(){this.sky.resetSkyMesh(),this.updateShaders=!0},t.setSkybox=function(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)},i=[{key:"defaultDrawLayer",get:function(){return this.layers.getLayerById(3)}},{key:"ambientBakeNumSamples",get:function(){return this._ambientBakeNumSamples},set:function(e){this._ambientBakeNumSamples=U.clamp(Math.floor(e),1,255)}},{key:"ambientBakeSpherePart",get:function(){return this._ambientBakeSpherePart},set:function(e){this._ambientBakeSpherePart=U.clamp(e,.001,1)}},{key:"clusteredLightingEnabled",get:function(){return this._clusteredLightingEnabled},set:function(e){(!this.device.isWebGPU||e)&&(this._clusteredLightingEnabled||!e)&&(this._clusteredLightingEnabled=e)}},{key:"envAtlas",get:function(){return this._envAtlas},set:function(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}},{key:"layers",get:function(){return this._layers},set:function(e){var n=this._layers;this._layers=e,this.fire("set:layers",n,e)}},{key:"sky",get:function(){return this._sky}},{key:"lighting",get:function(){return this._lightingParams}},{key:"fog",get:function(){return this._fogParams}},{key:"lightmapFilterRange",get:function(){return this._lightmapFilterRange},set:function(e){this._lightmapFilterRange=Math.max(e,.001)}},{key:"lightmapFilterSmoothness",get:function(){return this._lightmapFilterSmoothness},set:function(e){this._lightmapFilterSmoothness=Math.max(e,.001)}},{key:"prefilteredCubemaps",get:function(){return this._prefilteredCubemaps},set:function(e){e=e||[];var n=this._prefilteredCubemaps;(n.length!==e.length||n.some(function(r,s){return r!==e[s]}))&&(e.length===6&&e.every(function(r){return!!r})?(this._internalEnvAtlas=_d.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh())}},{key:"skybox",get:function(){return this._skyboxCubeMap},set:function(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}},{key:"skyboxIntensity",get:function(){return this._skyboxIntensity},set:function(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}},{key:"skyboxLuminance",get:function(){return this._skyboxLuminance},set:function(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}},{key:"skyboxMip",get:function(){return this._skyboxMip},set:function(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}},{key:"skyboxHighlightMultiplier",get:function(){return this._skyboxHighlightMultiplier},set:function(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh())}},{key:"skyboxRotation",get:function(){return this._skyboxRotation},set:function(e){if(!this._skyboxRotation.equals(e)){var n=e.equals(Z.IDENTITY);this._skyboxRotation.copy(e),n?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(E.ZERO,e,E.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||n||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}},{key:"lightmapPixelFormat",get:function(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);$e.EVENT_SETLAYERS="set:layers",$e.EVENT_SETSKYBOX="set:skybox",$e.EVENT_PRERENDER="prerender",$e.EVENT_POSTRENDER="postrender",$e.EVENT_PRERENDER_LAYER="prerender:layer",$e.EVENT_POSTRENDER_LAYER="postrender:layer",$e.EVENT_PRECULL="precull",$e.EVENT_POSTCULL="postcull";var vd=function(o,a,i){this.device=o,this.inverseBindPose=a,this.boneNames=i};function Yy(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function qy(o,a){return(qy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var II=[0,0,1,0,0,1,0,0,1,0,0,1],LI=[0,1,3,2,3,1],Ky=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._device=e,r._pixelsPerUnit=n&&n.pixelsPerUnit!==void 0?n.pixelsPerUnit:1,r._renderMode=n&&n.renderMode!==void 0?n.renderMode:0,r._atlas=n&&n.atlas!==void 0?n.atlas:null,r._frameKeys=n&&n.frameKeys!==void 0?n.frameKeys:null,r._meshes=[],r._updatingProperties=!1,r._meshesDirty=!1,r._atlas&&r._frameKeys&&r._createMeshes(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&qy(a,o);var i,t=a.prototype;return t._createMeshes=function(){for(var e=this._meshes.length,n=0;n<e;n++){var r=this._meshes[n];r&&r.destroy()}var s=this._frameKeys.length;this._meshes=Array(s);for(var l=this.renderMode===1||this._renderMode===2?this._create9SliceMesh:this._createSimpleMesh,u=0;u<s;u++){var c=this._atlas.frames[this._frameKeys[u]];this._meshes[u]=c?l.call(this,c):null}this.fire("set:meshes")},t._createSimpleMesh=function(e){var n=e.rect,r=this._atlas.texture.width,s=this._atlas.texture.height,l=n.z/this._pixelsPerUnit,u=n.w/this._pixelsPerUnit,c=e.pivot.x,h=e.pivot.y,f=n.x/r,d=1-n.y/s,p=(n.x+n.z)/r,_=1-(n.y+n.w)/s,g=new Ft;return g.positions=[-c*l,-h*u,0,(1-c)*l,-h*u,0,(1-c)*l,(1-h)*u,0,-c*l,(1-h)*u,0],g.normals=II,g.uvs=[f,d,p,d,p,_,f,_],g.indices=LI,ye.fromGeometry(this._device,g)},t._create9SliceMesh=function(){for(var e=G.ONE,n=[],r=[],s=[],l=[],u=0,c=0;c<=3;c++)for(var h=+(c!==0&&c!==3),f=0;f<=3;f++){var d=-e.x+2*e.x*(c<=1?0:3)/3,p=-(-e.y+2*e.y*(f<=1?0:3)/3),_=+(f!==0&&f!==3);n.push(-d,0,p),r.push(0,1,0),s.push(h,_),c<3&&f<3&&(l.push(u+3+1,u+1,u),l.push(u+3+1,u+3+2,u+1)),u++}var g=new Ft;return g.positions=n,g.normals=r,g.uvs=s,g.indices=l,ye.fromGeometry(this._device,g)},t._onSetFrames=function(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()},t._onFrameChanged=function(e,n){var r=this._frameKeys.indexOf(e);r<0||(n?this.renderMode===0&&(this._meshes[r]=this._createSimpleMesh(n)):this._meshes[r]=null,this.fire("set:meshes"))},t._onFrameRemoved=function(e){var n=this._frameKeys.indexOf(e);n<0||(this._meshes[n]=null,this.fire("set:meshes"))},t.startUpdate=function(){this._updatingProperties=!0,this._meshesDirty=!1},t.endUpdate=function(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1},t.destroy=function(){for(var e,n=function(s,l){var u=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(u)return(u=u.call(s)).next.bind(u);if(Array.isArray(s)||(u=function(h,f){if(h){if(typeof h=="string")return Yy(h,void 0);var d=Object.prototype.toString.call(h).slice(8,-1);if(d==="Object"&&h.constructor&&(d=h.constructor.name),d==="Map"||d==="Set")return Array.from(d);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return Yy(h,void 0)}}(s))){u&&(s=u);var c=0;return function(){return c>=s.length?{done:!0}:{done:!1,value:s[c++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this._meshes);!(e=n()).done;){var r=e.value;r&&r.destroy()}this._meshes.length=0},i=[{key:"frameKeys",get:function(){return this._frameKeys},set:function(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}},{key:"atlas",get:function(){return this._atlas},set:function(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&this.renderMode===0&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var n=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(n===0||e===0)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}},{key:"meshes",get:function(){return this._meshes}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Zy(o,a){return(Zy=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Qy=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return(e=o.call(this)||this)._texture=null,e._frames=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Zy(a,o);var i,t=a.prototype;return t.setFrame=function(e,n){var r=this._frames[e];r?(r.rect.copy(n.rect),r.pivot.copy(n.pivot),r.border.copy(n.border)):(r={rect:n.rect.clone(),pivot:n.pivot.clone(),border:n.border.clone()},this._frames[e]=r),this.fire("set:frame",e.toString(),r)},t.removeFrame=function(e){var n=this._frames[e];n&&(delete this._frames[e],this.fire("remove:frame",e.toString(),n))},t.destroy=function(){this._texture&&this._texture.destroy()},i=[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this.fire("set:texture",e)}},{key:"frames",get:function(){return this._frames},set:function(e){this._frames=e,this.fire("set:frames",e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se),Gu=function(o,a,i,t){this.time=o,this.position=a,this.rotation=i,this.scale=t},Hu=function(){this._name="",this._keys=[]},gd=function(){function o(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}var a,i=o.prototype;return i.getNode=function(t){return this._nodeDict[t]},i.addNode=function(t){this._nodes.push(t),this._nodeDict[t._name]=t},a=[{key:"nodes",get:function(){return this._nodes}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),DI=function(){function o(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new Z,this._pos=new E,this._scale=new E,this._targetNode=null}var a=o.prototype;return a.getTarget=function(){return this._targetNode},a.setTarget=function(i){this._targetNode=i},o}(),Wu=function(){function o(t){var e=this;this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var n=function(r){var s=new DI;s._name=r.name,e._interpolatedKeys.push(s),e._interpolatedKeyDict[r.name]=s,e._currKeyIndices[r.name]=0;for(var l=0;l<r._children.length;l++)n(r._children[l])};n(t)}var a,i=o.prototype;return i.addTime=function(t){if(this._animation!==null){var e=this._animation._nodes,n=this._animation.duration;if(this._time!==n||this.looping){if(this._time+=t,this._time>n){this._time=this.looping?0:n;for(var r=0;r<e.length;r++){var s=e[r]._name;this._currKeyIndices[s]=0}}else if(this._time<0){this._time=this.looping?n:0;for(var l=0;l<e.length;l++){var u=e[l],c=u._name;this._currKeyIndices[c]=u._keys.length-2}}for(var h=t>=0?1:-1,f=0;f<e.length;f++){var d=e[f],p=d._name,_=d._keys,g=this._interpolatedKeyDict[p];if(g!==void 0){var y=!1;if(_.length!==1)for(var v=this._currKeyIndices[p];v<_.length-1&&v>=0;v+=h){var x=_[v],S=_[v+1];if(x.time<=this._time&&S.time>=this._time){var T=(this._time-x.time)/(S.time-x.time);g._pos.lerp(x.position,S.position,T),g._quat.slerp(x.rotation,S.rotation,T),g._scale.lerp(x.scale,S.scale,T),g._written=!0,this._currKeyIndices[p]=v,y=!0;break}}(_.length===1||!y&&this._time===0&&this.looping)&&(g._pos.copy(_[0].position),g._quat.copy(_[0].rotation),g._scale.copy(_[0].scale),g._written=!0)}}}}},i.blend=function(t,e,n){for(var r=this._interpolatedKeys.length,s=0;s<r;s++){var l=t._interpolatedKeys[s],u=e._interpolatedKeys[s],c=this._interpolatedKeys[s];l._written&&u._written?(c._quat.slerp(l._quat,e._interpolatedKeys[s]._quat,n),c._pos.lerp(l._pos,e._interpolatedKeys[s]._pos,n),c._scale.lerp(l._scale,u._scale,n),c._written=!0):l._written?(c._quat.copy(l._quat),c._pos.copy(l._pos),c._scale.copy(l._scale),c._written=!0):u._written&&(c._quat.copy(u._quat),c._pos.copy(u._pos),c._scale.copy(u._scale),c._written=!0)}},i.setGraph=function(t){if(this.graph=t,t)for(var e=0;e<this._interpolatedKeys.length;e++){var n=this._interpolatedKeys[e],r=t.findByName(n._name);this._interpolatedKeys[e].setTarget(r)}else for(var s=0;s<this._interpolatedKeys.length;s++)this._interpolatedKeys[s].setTarget(null)},i.updateGraph=function(){if(this.graph)for(var t=0;t<this._interpolatedKeys.length;t++){var e=this._interpolatedKeys[t];if(e._written){var n=e.getTarget();n.localPosition.copy(e._pos),n.localRotation.copy(e._quat),n.localScale.copy(e._scale),n._dirtyLocal||n._dirtifyLocal(),e._written=!1}}},a=[{key:"animation",get:function(){return this._animation},set:function(t){this._animation=t,this.currentTime=0}},{key:"currentTime",get:function(){return this._time},set:function(t){this._time=t;for(var e=this._interpolatedKeys.length,n=0;n<e;n++){var r=this._interpolatedKeys[n]._name;this._currKeyIndices[r]=0}this.addTime(0),this.updateGraph()}},{key:"numNodes",get:function(){return this._interpolatedKeys.length}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),MI=new q,Jy=function(){function o(i){this.device=i,this.needsDepthBuffer=!1}var a=o.prototype;return a.render=function(i,t,e){},a.drawQuad=function(i,t,e){var n;if(e){var r=i?i.width:this.device.width,s=i?i.height:this.device.height;n=MI.set(e.x*r,e.y*s,e.z*r,e.w*s)}this.device.setBlendState(ge.NOBLEND),kt(this.device,i,t,n)},o}();function $y(o,a){return($y=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Jy.quadVertexShader=`
        attribute vec2 aPosition;
        varying vec2 vUv0;
        void main(void)
        {
            gl_Position = vec4(aPosition, 0.0, 1.0);
            vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
        }
    `;var Oi=function(o){var a;if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function i(){var t;return t=o.apply(this,arguments)||this,t._shader=null,t.quadRender=null,t.cullMode=0,t.blendState=ge.NOBLEND,t.depthState=Xe.NODEPTH,t.stencilFront=null,t.stencilBack=null,t}return i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),o&&$y(i,o),i.prototype.execute=function(){var t=this.device;t.setBlendState(this.blendState),t.setCullMode(this.cullMode),t.setDepthState(this.depthState),t.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()},a=[{key:"shader",get:function(){return this._shader},set:function(t){var e;(e=this.quadRender)==null||e.destroy(),this.quadRender=null,this._shader=t,t&&(this.quadRender=new Ys(t))}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(i.prototype,a),i}(ct),Wo=function(){this.hasTangents=!1,this.shaderChunks=null,this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=Kn,this.opacityShadowDither=Kn,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=Gr,this.gamma=0,this.toneMap=-1,this.reflectionSource=xi,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1,this.shadowCatcher=!1},ju=function(){function o(){}return o.update=function(a,i,t,e,n,r,s){o.updateSharedOptions(a,i,t,n,r),o.updateMaterialOptions(a,i),o.updateEnvOptions(a,i,t,e),o.updateLightingOptions(a,i,t,n,s)},o.updateSharedOptions=function(a,i,t,e,n){a.shaderChunks=i.shaderChunks,a.pass=n,a.alphaTest=i.alphaTest>0,a.blendType=i.blendType,a.screenSpace=e&&(256&e)!=0,a.skin=e&&(2&e)!=0,a.useInstancing=e&&(32&e)!=0,a.useMorphPosition=e&&(1024&e)!=0,a.useMorphNormal=e&&(2048&e)!=0,a.useMorphTextureBasedInt=e&&(8192&e)!=0,a.hasTangents=e&&(512&e)!=0,a.nineSlicedMode=i.nineSlicedMode||0,i.useLighting&&t.clusteredLightingEnabled?(a.clusteredLightingEnabled=!0,a.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,a.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,a.clusteredLightingShadowType=t.lighting.shadowType,a.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(a.clusteredLightingEnabled=!1,a.clusteredLightingCookiesEnabled=!1,a.clusteredLightingShadowsEnabled=!1,a.clusteredLightingAreaLightsEnabled=!1)},o.updateMaterialOptions=function(a,i){a.separateAmbient=!1,a.pixelSnap=i.pixelSnap,a.ambientSH=i.ambientSH,a.twoSidedLighting=i.twoSidedLighting,a.occludeDirect=i.occludeDirect,a.occludeSpecular=i.occludeSpecular,a.occludeSpecularFloat=i.occludeSpecularIntensity!==1,a.useMsdf=!1,a.msdfTextAttribute=!1,a.alphaToCoverage=i.alphaToCoverage,a.opacityFadesSpecular=i.opacityFadesSpecular,a.opacityDither=i.opacityDither,a.cubeMapProjection=0,a.useSpecular=i.hasSpecular,a.useSpecularityFactor=i.hasSpecularityFactor,a.enableGGXSpecular=i.ggxSpecular,a.fresnelModel=i.fresnelModel,a.useRefraction=i.hasRefraction,a.useClearCoat=i.hasClearCoat,a.useSheen=i.hasSheen,a.useIridescence=i.hasIrridescence,a.useMetalness=i.hasMetalness,a.useDynamicRefraction=i.dynamicRefraction,a.dispersion=i.dispersion>0,a.vertexColors=!1,a.lightMapEnabled=i.hasLighting,a.dirLightMapEnabled=i.dirLightMap,a.useHeights=i.hasHeights,a.useNormals=i.hasNormals,a.useClearCoatNormals=i.hasClearCoatNormals,a.useAo=i.hasAo,a.diffuseMapEnabled=i.hasDiffuseMap},o.updateEnvOptions=function(a,i,t,e){a.fog=i.useFog?e.fog:Gr,a.gamma=e.shaderOutputGamma,a.toneMap=i.useTonemap?e.toneMapping:6,i.useSkybox&&t.envAtlas&&t.skybox?(a.reflectionSource=Ao,a.reflectionEncoding=t.envAtlas.encoding,a.reflectionCubemapEncoding=t.skybox.encoding):i.useSkybox&&t.envAtlas?(a.reflectionSource=wo,a.reflectionEncoding=t.envAtlas.encoding):i.useSkybox&&t.skybox?(a.reflectionSource=Co,a.reflectionEncoding=t.skybox.encoding):(a.reflectionSource=xi,a.reflectionEncoding=null),i.ambientSH?(a.ambientSource=yu,a.ambientEncoding=null):a.reflectionSource!==xi&&t.envAtlas?(a.ambientSource=Su,a.ambientEncoding=t.envAtlas.encoding):(a.ambientSource=xu,a.ambientEncoding=null);var n=a.reflectionSource!==xi;a.skyboxIntensity=n,a.useCubeMapRotation=n&&t._skyboxRotationShaderInclude},o.updateLightingOptions=function(a,i,t,e,n){if(a.lightMapWithoutAmbient=!1,i.useLighting){var r=[],s=e?e>>16:1;a.lightMaskDynamic=!!(1&s),a.lightMapWithoutAmbient=!1,n&&(o.collectLights(0,n[0],r,s),t.clusteredLightingEnabled||(o.collectLights(1,n[1],r,s),o.collectLights(2,n[2],r,s))),a.lights=r}else a.lights=[];(a.lights.length!==0||t.clusteredLightingEnabled)&&!(1&e)||(a.noShadow=!0)},o.collectLights=function(a,i,t,e){for(var n=0;n<i.length;n++){var r=i[n];r.enabled&&r.mask&e&&t.push(r)}},o}();function eS(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}var yd={vertex_normal:bt,vertex_tangent:hn,vertex_texCoord0:mt,vertex_texCoord1:Hn,vertex_color:st,vertex_boneWeights:fn,vertex_boneIndices:Pt},RI=new Map([["vec4","vec4f"],["vec3","vec3f"],["vec2","vec2f"],["float","f32"]]),tS=function(){function o(i,t,e){var n=this;e===void 0&&(e=!0),this.varyingsCode="",this.vDefines=new Map,this.fDefines=new Map,this.includes=new Map,this.chunks=null,this.device=i,this.options=t;var r=t.shaderChunks;if(this.shaderLanguage=i.isWebGPU&&e&&(r!=null&&r.useWGSL)?he:ue,this.attributes={vertex_position:oe},t.userAttributes)for(var s,l=function(d,p){var _=typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(_)return(_=_.call(d)).next.bind(_);if(Array.isArray(d)||(_=function(y,v){if(y){if(typeof y=="string")return eS(y,void 0);var x=Object.prototype.toString.call(y).slice(8,-1);if(x==="Object"&&y.constructor&&(x=y.constructor.name),x==="Map"||x==="Set")return Array.from(x);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return eS(y,void 0)}}(d))){_&&(d=_);var g=0;return function(){return g>=d.length?{done:!0}:{done:!1,value:d[g++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Object.entries(t.userAttributes));!(s=l()).done;){var u=s.value,c=u[0],h=u[1];this.attributes[h]=c}var f=re.get(i,this.shaderLanguage);this.chunks=new Map(f),r&&(this.shaderLanguage===ue?r.glsl:r.wgsl).forEach(function(d,p){for(var _ in yd)yd.hasOwnProperty(_)&&d.indexOf(_)>=0&&(n.attributes[_]=yd[_]);n.chunks.set(p,d)}),this.shaderPassInfo=Ti.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==xi,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.fshader=null}var a=o.prototype;return a.fDefineSet=function(i,t,e){e===void 0&&(e=""),i&&this.fDefines.set(t,e)},a.generateVertexShader=function(i,t,e){var n=this,r=this.options,s=this.vDefines,l=this.attributes,u=new Map;if(u.set("vPositionW","vec3"),(r.nineSlicedMode===1||r.nineSlicedMode===2)&&s.set("NINESLICED",!0),this.options.linearDepth&&(s.set("LINEAR_DEPTH",!0),u.set("vLinearDepth","float")),this.needsNormal&&s.set("NORMALS",!0),this.options.useInstancing){var c=re.get(this.device,this.shaderLanguage);this.chunks.get("transformInstancingVS")===c.get("transformInstancingVS")&&(l.instance_line1=Jl,l.instance_line2=Rs,l.instance_line3=$l,l.instance_line4=Fr)}this.needsNormal&&(l.vertex_normal=bt,u.set("vNormalW","vec3"),r.hasTangents&&(r.useHeights||r.useNormals||r.useClearCoatNormals||r.enableGGXSpecular)?(s.set("TANGENTS",!0),l.vertex_tangent=hn,u.set("vTangentW","vec3"),u.set("vBinormalW","vec3")):r.enableGGXSpecular&&(s.set("GGX_SPECULAR",!0),u.set("vObjectSpaceUpW","vec3")));for(var h=0;h<2;h++)i[h]&&(s.set("UV"+h,!0),l["vertex_texCoord"+h]="TEXCOORD"+h),t[h]&&(s.set("UV"+h+"_UNMODIFIED",!0),u.set("vUv"+h,"vec2"));var f=0,d=new Set;e.forEach(function(p){var _=p.id,g=p.uv,y=p.name,v=_+100*g;!d.has(v)&&(d.add(v),u.set("vUV"+g+"_"+_,"vec2"),s.set("{TRANSFORM_NAME_"+f+"}","texture_"+y+"MapTransform"),s.set("{TRANSFORM_UV_"+f+"}",g),s.set("{TRANSFORM_ID_"+f+"}",_),f++)}),s.set("UV_TRANSFORMS_COUNT",f),r.vertexColors&&(l.vertex_color=st,s.set("VERTEX_COLOR",!0),u.set("vVertexColor","vec4")),r.useMsdf&&r.msdfTextAttribute&&(l.vertex_outlineParameters=Ds,l.vertex_shadowParameters=Ms,s.set("MSDF",!0)),(r.useMorphPosition||r.useMorphNormal)&&(s.set("MORPHING",!0),r.useMorphTextureBasedInt&&s.set("MORPHING_INT",!0),r.useMorphPosition&&s.set("MORPHING_POSITION",!0),r.useMorphNormal&&s.set("MORPHING_NORMAL",!0),l.morph_vertex_id=Fr),r.skin&&(l.vertex_boneIndices=Pt,r.batch?s.set("BATCH",!0):(l.vertex_boneWeights=fn,s.set("SKIN",!0))),r.useInstancing&&s.set("INSTANCING",!0),r.screenSpace&&s.set("SCREENSPACE",!0),r.pixelSnap&&s.set("PIXELSNAP",!0),u.forEach(function(p,_){n.varyingsCode+="#define VARYING_"+_.toUpperCase()+`
`,n.varyingsCode+=n.shaderLanguage===he?"varying "+_+": "+RI.get(p)+`;
`:"varying "+p+" "+_+`;
`}),this.includes.set("varyingsVS",this.varyingsCode),this.includes.set("varyingsPS",this.varyingsCode),this.vshader=`
            #include "litMainVS"
        `},a._setupLightingDefines=function(i,t){var e=this.fDefines,n=this.options;if(this.fDefines.set("LIGHT_COUNT",n.lights.length),i&&e.set("AREA_LIGHTS",!0),t&&this.lighting&&(e.set("LIT_CLUSTERED_LIGHTS",!0),n.clusteredLightingCookiesEnabled&&e.set("CLUSTER_COOKIES",!0),n.clusteredLightingAreaLightsEnabled&&e.set("CLUSTER_AREALIGHTS",!0),n.lightMaskDynamic&&e.set("CLUSTER_MESH_DYNAMIC_LIGHTS",!0),n.clusteredLightingShadowsEnabled&&!n.noShadow)){var r=qn.get(n.clusteredLightingShadowType);e.set("CLUSTER_SHADOWS",!0),e.set("SHADOW_KIND_"+r.kind,!0),e.set("CLUSTER_SHADOW_TYPE_"+r.kind,!0)}for(var s=0;s<n.lights.length;s++){var l=n.lights[s],u=l._type;if(!t||u===0){var c=i&&l._shape?l._shape:0,h=l._shadowType,f=l.castShadows&&!n.noShadow,d=qn.get(h);e.set("LIGHT"+s,!0),e.set("LIGHT"+s+"TYPE",""+If[u]),e.set("LIGHT"+s+"SHADOWTYPE",""+d.name),e.set("LIGHT"+s+"SHAPE",""+Wv[c]),e.set("LIGHT"+s+"FALLOFF",""+jv[l._falloffMode]),l.affectSpecularity&&e.set("LIGHT"+s+"AFFECT_SPECULARITY",!0),l._cookie&&(u===2&&!l._cookie._cubemap||u===1&&l._cookie._cubemap)&&(e.set("LIGHT"+s+"COOKIE",!0),e.set("{LIGHT"+s+"COOKIE_CHANNEL}",l._cookieChannel),u===2&&(l._cookieTransform&&e.set("LIGHT"+s+"COOKIE_TRANSFORM",!0),l._cookieFalloff&&e.set("LIGHT"+s+"COOKIE_FALLOFF",!0))),f&&(e.set("LIGHT"+s+"CASTSHADOW",!0),d.pcf&&e.set("LIGHT"+s+"SHADOW_PCF",!0),l._normalOffsetBias&&!l._isVsm&&e.set("LIGHT"+s+"_SHADOW_SAMPLE_NORMAL_OFFSET",!0),u===0&&(e.set("LIGHT"+s+"_SHADOW_SAMPLE_ORTHO",!0),l.cascadeBlend>0&&e.set("LIGHT"+s+"_SHADOW_CASCADE_BLEND",!0),l.numCascades>1&&e.set("LIGHT"+s+"_SHADOW_CASCADES",!0)),(d.pcf||d.pcss||this.device.isWebGPU)&&e.set("LIGHT"+s+"_SHADOW_SAMPLE_SOURCE_ZBUFFER",!0),u===1&&e.set("LIGHT"+s+"_SHADOW_SAMPLE_POINT",!0)),f&&(e.set("SHADOW_KIND_"+d.kind,!0),u===0&&e.set("SHADOW_DIRECTIONAL",!0))}}},a.prepareForwardPass=function(i){var t=this.options,e=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some(function(s){return s._shape&&s._shape!==0}),n=!t.lightMapEnabled||t.lightMapWithoutAmbient,r=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(!0,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(r,"LIT_TBN"),this.fDefineSet(n,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(!0,"LIT_FRESNEL_MODEL",Hv[t.fresnelModel]),this.fDefineSet(!0,"LIT_NONE_SLICE_MODE",Zv[t.nineSlicedMode]),this.fDefineSet(!0,"LIT_BLEND_TYPE",Pf[t.blendType]),this.fDefineSet(!0,"LIT_CUBEMAP_PROJECTION",Xv[t.cubeMapProjection]),this.fDefineSet(!0,"LIT_OCCLUDE_SPECULAR",Yv[t.occludeSpecular]),this.fDefineSet(!0,"LIT_REFLECTION_SOURCE",qv[t.reflectionSource]),this.fDefineSet(!0,"LIT_AMBIENT_SOURCE",Kv[t.ambientSource]),this.fDefineSet(!0,"{lightingUv}",i??""),this.fDefineSet(!0,"{reflectionDecode}",Mi.decodeFunc(t.reflectionEncoding)),this.fDefineSet(!0,"{reflectionCubemapDecode}",Mi.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(!0,"{ambientDecode}",Mi.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(e,t.clusteredLightingEnabled)},a.prepareShadowPass=function(){var i=this.options,t=this.shaderPassInfo.lightType,e=this.shaderPassInfo.shadowType,n=qn.get(e),r=t===0||!n.vsm&&t===2;this.fDefineSet(r,"PERSPECTIVE_DEPTH"),this.fDefineSet(!0,"LIGHT_TYPE",""+If[t]),this.fDefineSet(!0,"SHADOW_TYPE",""+n.name),this.fDefineSet(i.alphaTest,"LIT_ALPHA_TEST")},a.generateFragmentShader=function(i,t,e){var n=this.options;this.includes.set("frontendDeclPS",i??""),this.includes.set("frontendCodePS",t??""),n.pass===3||n.pass===1||(this.shadowPass?this.prepareShadowPass():this.prepareForwardPass(e)),this.fshader=`
            #include "litMainPS"
        `},o}(),Sd={generateKey:function(o){return"lit"+Object.keys(o).sort().map(function(a){if(a==="shaderChunks"){var i,t;return(t=(i=o.shaderChunks)==null?void 0:i.key)!=null?t:""}return a==="lights"?Sd.generateLightsKey(o):a+o[a]}).join(`
`)},generateLightsKey:function(o){return"lights:"+o.lights.map(function(a){return o.clusteredLightingEnabled&&a._type!==0?"":""+a.key+","}).join("")}};function nS(o,a){return(nS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var OI=[0,1,2,3,4,5,6,7],kI=new(function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&nS(a,o);var i=a.prototype;return i.generateKey=function(t){var e,n,r=bi.definesHash(t.defines),s=dn((e=t.shaderChunkGLSL)!=null?e:""),l=dn((n=t.shaderChunkWGSL)!=null?n:""),u=Sd.generateKey(t.litOptions);return"lit_"+r+"_"+OI.map(function(c,h){return t.usedUvs[h]?"1":"0"}).join("")+"_"+s+"_"+l+"_"+u},i.createShaderDefinition=function(t,e){var n=!!e.shaderChunkWGSL,r=new tS(t,e.litOptions,n),s={name:"LitShader",shaderLanguage:r.shaderLanguage,tag:r.shaderPassInfo.isForward?1:void 0},l=e.usedUvs||[!0];r.generateVertexShader(l,l,[]),r.generateFragmentShader("",r.shaderLanguage===he?e.shaderChunkWGSL:e.shaderChunkGLSL,"vUv0");var u=Lo.merge(r.chunks,r.includes),c=r.vDefines;e.defines.forEach(function(f,d){return c.set(d,f)});var h=r.fDefines;return e.defines.forEach(function(f,d){return h.set(d,f)}),s.attributes=r.attributes,s.vertexCode=r.vshader,s.vertexIncludes=u,s.vertexDefines=c,s.fragmentCode=r.fshader,s.fragmentIncludes=u,s.fragmentDefines=h,ir.createDefinition(t,s)},a}(bi));function iS(o,a){return(iS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ua=new function(){this.litOptions=new Wo},NI=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var i;return i=o.apply(this,arguments)||this,i.usedUvs=[!0],i.shaderChunkGLSL=null,i.shaderChunkWGSL=null,i.useLighting=!0,i.useFog=!0,i.useTonemap=!0,i.useSkybox=!0,i.ambientSH=null,i.pixelSnap=!1,i.nineSlicedMode=null,i.twoSidedLighting=!1,i.occludeDirect=!1,i.occludeSpecular=1,i.occludeSpecularIntensity=1,i.opacityFadesSpecular=!0,i.opacityDither=Kn,i.opacityShadowDither=Kn,i.shadowCatcher=!1,i.ggxSpecular=!1,i.fresnelModel=2,i.dynamicRefraction=!1,i.hasAo=!1,i.hasSpecular=!1,i.hasSpecularityFactor=!1,i.hasLighting=!1,i.hasHeights=!1,i.hasNormals=!1,i.hasSheen=!1,i.hasRefraction=!1,i.hasIrridescence=!1,i.hasMetalness=!1,i.hasClearCoat=!1,i.hasClearCoatNormals=!1,i}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&iS(a,o),a.prototype.getShaderVariant=function(i){ua.usedUvs=this.usedUvs.slice(),ua.shaderChunkGLSL=this.shaderChunkGLSL,ua.shaderChunkWGSL=this.shaderChunkWGSL,ua.defines=Te.getCoreDefines(this,i),ju.update(ua.litOptions,this,i.scene,i.cameraShaderParams,i.objDefs,i.pass,i.sortedLights);var t=new Io(i.viewUniformFormat,i.viewBindGroupFormat,i.vertexFormat),e=sr(i.device);return e.register("lit",kI),e.getProgram("lit",ua,t,this.userId)},a}(Ci),Zr=function(){var o;function a(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.normalDetailPackedNormal=!1,this.clearCoatPackedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new Wo}return o=[{key:"pass",get:function(){return this.litOptions.pass}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function rS(o,a){return(rS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ca=[],xd=function(o){return Object.keys(o).filter(function(a){return a!=="litOptions"}).sort()},bd=new(function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return t=o.apply(this,arguments)||this,t.optionsContext=new Zr,t.optionsContextMin=new Zr,t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&rS(a,o);var i=a.prototype;return i.generateKey=function(t){var e;return t===this.optionsContextMin?(this.propsMin||(this.propsMin=xd(t)),e=this.propsMin):t===this.optionsContext?(this.props||(this.props=xd(t)),e=this.props):e=xd(t),`standard:
`+bi.definesHash(t.defines)+`
`+e.map(function(n){return n+t[n]}).join(`
`)+Sd.generateKey(t.litOptions)},i._getUvSourceExpression=function(t,e,n){var r,s=n[t],l=n[e],u=n.litOptions.pass===0;return u&&n.litOptions.nineSlicedMode===1||u&&n.litOptions.nineSlicedMode===2?r="nineSlicedUv":(r=s===0?"vUv"+l:"vUV"+l+"_"+s,n.heightMap&&t!=="heightMapTransform"&&(r+=" + dUvOffset")),r},i._validateMapChunk=function(t,e,n){},i._addMapDefines=function(t,e,n,r,s,l,u){u===void 0&&(u=null);var c=""+e+"Map",h=e.toUpperCase(),f=""+c+"Channel",d=""+e+"VertexColorChannel",p=""+e+"Tint",_=""+e+"VertexColor",g=""+e+"Mode",y=""+e+"Invert",v=r[p],x=r[_],S=r[c],T=r[""+c+"Identifier"],b=r[g],w=s.get(n);if(S){t.set("STD_"+h+"_TEXTURE","");var A=this._getUvSourceExpression(""+c+"Transform",""+c+"Uv",r);t.set("{STD_"+h+"_TEXTURE_UV}",A),t.set("{STD_"+h+"_TEXTURE_CHANNEL}",r[f]);var C="{STD_"+h+"_TEXTURE_NAME}";if(w.includes(C)){var L="texture_"+c,I=l[T];I?L=I:(l[T]=L,t.set("STD_"+h+"_TEXTURE_ALLOCATE","")),t.set(C,L)}if(u){var P=r[f]==="aaa"?"passThrough":Mi.decodeFunc(u);t.set("{STD_"+h+"_TEXTURE_DECODE}",P)}}x&&(t.set("STD_"+h+"_VERTEX",""),t.set("{STD_"+h+"_VERTEX_CHANNEL}",r[d])),b&&t.set("{STD_"+h+"_DETAILMODE}",b),v&&t.set("STD_"+h+"_CONSTANT",""),r[y]&&t.set("STD_"+h+"_INVERT","")},i._correctChannel=function(t,e,n){if(n[t]>0){if(n[t]<e.length)return e.substring(0,n[t]);if(n[t]>e.length){for(var r=e,s=r.charAt(r.length-1),l=n[t]-r.length,u=0;u<l;u++)r+=s;return r}return e}},i.createVertexShader=function(t,e){var n=[],r=[],s=[];for(var l in ca){var u=""+l+"Map";if(e[""+l+"VertexColor"]){var c=""+l+"VertexColorChannel";e[c]=this._correctChannel(l,e[c],ca)}if(e[u]){var h=""+u+"Channel",f=""+u+"Transform",d=""+u+"Uv";e[d]=Math.min(e[d],1),e[h]=this._correctChannel(l,e[h],ca);var p=e[d];n[p]=!0,r[p]=r[p]||e[u]&&!e[f],e[f]&&s.push({name:l,id:e[f],uv:e[d]})}}e.forceUv1&&(n[1]=!0,r[1]=r[1]===void 0||r[1]),t.generateVertexShader(n,r,s)},i.prepareFragmentDefines=function(t,e,n){var r=function(s,l,u){u===void 0&&(u=""),s&&e.set(l,u)};r(t.lightMap,"STD_LIGHTMAP",""),r(t.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),r(t.dirLightMap&&t.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),r(t.heightMap,"STD_HEIGHT_MAP",""),r(t.useSpecularColor,"STD_SPECULAR_COLOR",""),r(t.aoMap||t.aoVertexColor||t.useAO,"STD_AO",""),r(!0,"STD_OPACITY_DITHER",tg[n.isForward?t.litOptions.opacityDither:t.litOptions.opacityShadowDither])},i.createShaderDefinition=function(t,e){var n=Ti.get(t).getByIndex(e.litOptions.pass),r=n.isForward,s=new tS(t,e.litOptions);this.createVertexShader(s,e);var l={};e.litOptions.fresnelModel=e.litOptions.fresnelModel===0?2:e.litOptions.fresnelModel;var u=s.fDefines;this.prepareFragmentDefines(e,u,n);var c="";if(r){if(e.heightMap&&this._addMapDefines(u,"height","parallaxPS",e,s.chunks,l),(e.litOptions.blendType!==3||e.litOptions.alphaTest||e.litOptions.alphaToCoverage||e.litOptions.opacityDither!==Kn)&&this._addMapDefines(u,"opacity","opacityPS",e,s.chunks,l),s.needsNormal){if((e.normalMap||e.clearCoatNormalMap)&&!e.litOptions.hasTangents){var h=e.normalMap?"normalMap":"clearCoatNormalMap";c=this._getUvSourceExpression(""+h+"Transform",""+h+"Uv",e)}this._addMapDefines(u,"normalDetail","normalMapPS",e,s.chunks,l,e.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(u,"normal","normalMapPS",e,s.chunks,l,e.packedNormal?"xy":"xyz")}e.diffuseDetail&&this._addMapDefines(u,"diffuseDetail","diffusePS",e,s.chunks,l,e.diffuseDetailEncoding),this._addMapDefines(u,"diffuse","diffusePS",e,s.chunks,l,e.diffuseEncoding),e.litOptions.useRefraction&&(this._addMapDefines(u,"refraction","transmissionPS",e,s.chunks,l),this._addMapDefines(u,"thickness","thicknessPS",e,s.chunks,l)),e.litOptions.useIridescence&&(this._addMapDefines(u,"iridescence","iridescencePS",e,s.chunks,l),this._addMapDefines(u,"iridescenceThickness","iridescenceThicknessPS",e,s.chunks,l)),(s.lighting&&e.litOptions.useSpecular||s.reflections)&&(e.litOptions.useSheen&&(this._addMapDefines(u,"sheen","sheenPS",e,s.chunks,l,e.sheenEncoding),this._addMapDefines(u,"sheenGloss","sheenGlossPS",e,s.chunks,l)),e.litOptions.useMetalness&&(this._addMapDefines(u,"metalness","metalnessPS",e,s.chunks,l),this._addMapDefines(u,"ior","iorPS",e,s.chunks,l)),e.litOptions.useSpecularityFactor&&this._addMapDefines(u,"specularityFactor","specularityFactorPS",e,s.chunks,l),e.useSpecularColor&&this._addMapDefines(u,"specular","specularPS",e,s.chunks,l,e.specularEncoding),this._addMapDefines(u,"gloss","glossPS",e,s.chunks,l)),e.aoDetail&&this._addMapDefines(u,"aoDetail","aoPS",e,s.chunks,l),(e.aoMap||e.aoVertexColor||e.useAO)&&this._addMapDefines(u,"ao","aoPS",e,s.chunks,l),this._addMapDefines(u,"emissive","emissivePS",e,s.chunks,l,e.emissiveEncoding),e.litOptions.useClearCoat&&(this._addMapDefines(u,"clearCoat","clearCoatPS",e,s.chunks,l),this._addMapDefines(u,"clearCoatGloss","clearCoatGlossPS",e,s.chunks,l),this._addMapDefines(u,"clearCoatNormal","clearCoatNormalPS",e,s.chunks,l,e.clearCoatPackedNormal?"xy":"xyz")),e.litOptions.enableGGXSpecular&&this._addMapDefines(u,"anisotropy","anisotropyPS",e,s.chunks,l),(e.lightMap||e.lightVertexColor)&&this._addMapDefines(u,"light","lightmapPS",e,s.chunks,l,e.lightMapEncoding)}else{var f=e.litOptions.opacityShadowDither;(e.litOptions.alphaTest||f)&&this._addMapDefines(u,"opacity","opacityPS",e,s.chunks,l)}s.generateFragmentShader(s.chunks.get("stdDeclarationPS"),s.chunks.get("stdFrontEndPS"),c);var d=Lo.merge(s.chunks,s.includes),p=s.vDefines;e.defines.forEach(function(g,y){return p.set(y,g)}),e.defines.forEach(function(g,y){return u.set(y,g)});var _=ir.createDefinition(t,{name:"StandardShader",attributes:s.attributes,shaderLanguage:s.shaderLanguage,vertexCode:s.vshader,fragmentCode:s.fshader,vertexIncludes:d,fragmentIncludes:d,fragmentDefines:u,vertexDefines:p});return s.shaderPassInfo.isForward&&(_.tag=1),_},a}(bi)),sS=function(o,a){if(o.length!==a.length)return!1;for(var i=0;i<o.length;++i)if(o[i]!==a[i])return!1;return!0},FI=function(){function o(){this._mapXForms=null}var a=o.prototype;return a.updateMinRef=function(i,t,e,n,r,s){this._updateSharedOptions(i,t,e,n,r),this._updateMinOptions(i,e,r),this._updateUVOptions(i,e,n,!0)},a.updateRef=function(i,t,e,n,r,s,l){this._updateSharedOptions(i,t,n,r,s),this._updateEnvOptions(i,n,t,e),this._updateMaterialOptions(i,n,t),i.litOptions.hasTangents=r&&(512&r)!=0,this._updateLightOptions(i,t,n,r,l),this._updateUVOptions(i,n,r,!1,e)},a._updateSharedOptions=function(i,t,e,n,r){i.forceUv1=e.forceUv1,e.userAttributes&&(i.litOptions.userAttributes=Object.fromEntries(e.userAttributes.entries())),i.litOptions.shaderChunks=e.shaderChunks,i.litOptions.pass=r,i.litOptions.alphaTest=e.alphaTest>0,i.litOptions.blendType=e.blendType,i.litOptions.screenSpace=n&&(256&n)!=0,i.litOptions.skin=n&&(2&n)!=0,i.litOptions.batch=n&&(16384&n)!=0,i.litOptions.useInstancing=n&&(32&n)!=0,i.litOptions.useMorphPosition=n&&(1024&n)!=0,i.litOptions.useMorphNormal=n&&(2048&n)!=0,i.litOptions.useMorphTextureBasedInt=n&&(8192&n)!=0,i.litOptions.nineSlicedMode=e.nineSlicedMode||0,t.clusteredLightingEnabled&&e.useLighting?(i.litOptions.clusteredLightingEnabled=!0,i.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,i.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,i.litOptions.clusteredLightingShadowType=t.lighting.shadowType,i.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(i.litOptions.clusteredLightingEnabled=!1,i.litOptions.clusteredLightingCookiesEnabled=!1,i.litOptions.clusteredLightingShadowsEnabled=!1,i.litOptions.clusteredLightingAreaLightsEnabled=!1)},a._updateUVOptions=function(i,t,e,n,r){var s=!1,l=!1,u=!1;e&&(s=(4&e)!=0,l=(8&e)!=0,u=(16&e)!=0),i.litOptions.vertexColors=!1,this._mapXForms=[];var c={};for(var h in ca)this._updateTexOptions(i,t,h,s,l,u,n,c);this._mapXForms=null,i.litOptions.ssao=r==null?void 0:r.ssaoEnabled,i.useAO=i.litOptions.ssao,i.litOptions.lightMapEnabled=i.lightMap,i.litOptions.dirLightMapEnabled=i.dirLightMap,i.litOptions.useHeights=i.heightMap,i.litOptions.useNormals=i.normalMap,i.litOptions.useClearCoatNormals=i.clearCoatNormalMap,i.litOptions.useAo=i.aoMap||i.aoVertexColor||i.litOptions.ssao,i.litOptions.diffuseMapEnabled=i.diffuseMap},a._updateTexOptions=function(i,t,e,n,r,s,l,u){var c=e==="opacity";if(!l||c){var h=""+e+"Map",f=""+e+"VertexColor",d=""+e+"VertexColorChannel",p=""+h+"Channel",_=""+h+"Transform",g=""+h+"Uv",y=""+h+"Identifier";if(e!=="light"&&(i[h]=!1,i[y]=void 0,i[p]="",i[_]=0,i[g]=0),i[f]=!1,i[d]="",c&&t.blendType===3&&t.alphaTest===0&&!t.alphaToCoverage&&t.opacityDither===Kn)return;if(e!=="height"&&t[f]&&s&&(i[f]=t[f],i[d]=t[d],i.litOptions.vertexColors=!0),t[h]){var v=!0;if(t[g]!==0||n||(v=!1),t[g]!==1||r||(v=!1),v){var x=t[h].id,S=u[x];S===void 0&&(u[x]=e,S=e),i[h]=!!t[h],i[y]=S,i[_]=this._getMapTransformID(t.getUniform(_),t[g]),i[p]=t[p],i[g]=t[g]}}}},a._updateMinOptions=function(i,t,e){var n=e===1;i.litOptions.opacityShadowDither=n?t.opacityDither:t.opacityShadowDither,i.litOptions.linearDepth=n,i.litOptions.lights=[]},a._updateMaterialOptions=function(i,t,e){var n,r,s,l,u,c,h,f,d=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||(r=t.specular).r!==0||r.g!==0||r.b!==0||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),p=!t.useMetalness||t.useMetalnessSpecularColor,_=d&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&((n=t.specular).r!==1||n.g!==1||n.b!==1),g=d&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),y=function(x){return!!x&&(x.format===10||x.type===ks)},v=function(x,S){return 1e-4>Math.abs(x-S)};i.specularTint=_,i.specularityFactorTint=g,i.metalnessTint=t.useMetalness&&t.metalness<1,i.glossTint=!0,i.diffuseEncoding=(s=t.diffuseMap)==null?void 0:s.encoding,i.diffuseDetailEncoding=(l=t.diffuseDetailMap)==null?void 0:l.encoding,i.emissiveEncoding=(u=t.emissiveMap)==null?void 0:u.encoding,i.lightMapEncoding=(c=t.lightMap)==null?void 0:c.encoding,i.packedNormal=y(t.normalMap),i.refractionTint=v(t.refraction,1),i.refractionIndexTint=v(t.refractionIndex,1/1.5),i.thicknessTint=t.useDynamicRefraction&&t.thickness!==1,i.specularEncoding=(h=t.specularMap)==null?void 0:h.encoding,i.sheenEncoding=(f=t.sheenMap)==null?void 0:f.encoding,i.aoMapUv=t.aoUvSet,i.aoDetail=!!t.aoDetailMap,i.diffuseDetail=!!t.diffuseDetailMap,i.normalDetail=!!t.normalMap,i.normalDetailPackedNormal=y(t.normalDetailMap),i.diffuseDetailMode=t.diffuseDetailMode,i.aoDetailMode=t.aoDetailMode,i.clearCoatTint=v(t.clearCoat,1),i.clearCoatGloss=!!t.clearCoatGloss,i.clearCoatGlossTint=t.clearCoatGloss!==1,i.clearCoatPackedNormal=y(t.clearCoatNormalMap),i.iorTint=v(t.refractionIndex,1/1.5),e.forcePassThroughSpecular&&(i.specularEncoding="linear",i.sheenEncoding="linear"),i.iridescenceTint=t.iridescence!==1,i.glossInvert=t.glossInvert,i.sheenGlossInvert=t.sheenGlossInvert,i.clearCoatGlossInvert=t.clearCoatGlossInvert,i.useSpecularColor=p,i.litOptions.separateAmbient=!1,i.litOptions.pixelSnap=t.pixelSnap,i.litOptions.ambientSH=!!t.ambientSH,i.litOptions.twoSidedLighting=t.twoSidedLighting,i.litOptions.occludeSpecular=t.occludeSpecular,i.litOptions.occludeSpecularFloat=t.occludeSpecularIntensity!==1,i.litOptions.useMsdf=!!t.msdfMap,i.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,i.litOptions.alphaToCoverage=t.alphaToCoverage,i.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,i.litOptions.opacityDither=t.opacityDither,i.litOptions.cubeMapProjection=t.cubeMapProjection,i.litOptions.occludeDirect=t.occludeDirect,i.litOptions.useSpecular=d,i.litOptions.useSpecularityFactor=(g||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,i.litOptions.enableGGXSpecular=t.enableGGXSpecular,i.litOptions.fresnelModel=t.fresnelModel,i.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||i.litOptions.reflectionSource!==xi),i.litOptions.useClearCoat=!!t.clearCoat,i.litOptions.useSheen=t.useSheen,i.litOptions.useIridescence=t.useIridescence&&t.iridescence!==0,i.litOptions.useMetalness=t.useMetalness,i.litOptions.useDynamicRefraction=t.useDynamicRefraction,i.litOptions.dispersion=t.dispersion>0,i.litOptions.shadowCatcher=t.shadowCatcher},a._updateEnvOptions=function(i,t,e,n){i.litOptions.fog=t.useFog?n.fog:Gr,i.litOptions.gamma=n.shaderOutputGamma,i.litOptions.toneMap=t.useTonemap?n.toneMapping:6;var r=!1;if(t.envAtlas&&t.cubeMap?(i.litOptions.reflectionSource=Ao,i.litOptions.reflectionEncoding=t.envAtlas.encoding,i.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(i.litOptions.reflectionSource=wo,i.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(i.litOptions.reflectionSource=Co,i.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(i.litOptions.reflectionSource=Df,i.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&e.envAtlas&&e.skybox?(i.litOptions.reflectionSource=Ao,i.litOptions.reflectionEncoding=e.envAtlas.encoding,i.litOptions.reflectionCubemapEncoding=e.skybox.encoding,r=!0):t.useSkybox&&e.envAtlas?(i.litOptions.reflectionSource=wo,i.litOptions.reflectionEncoding=e.envAtlas.encoding,r=!0):t.useSkybox&&e.skybox?(i.litOptions.reflectionSource=Co,i.litOptions.reflectionEncoding=e.skybox.encoding,r=!0):(i.litOptions.reflectionSource=xi,i.litOptions.reflectionEncoding=null),t.ambientSH)i.litOptions.ambientSource=yu,i.litOptions.ambientEncoding=null;else{var s=t.envAtlas||(t.useSkybox&&e.envAtlas?e.envAtlas:null);s&&!t.sphereMap?(i.litOptions.ambientSource=Su,i.litOptions.ambientEncoding=s.encoding):(i.litOptions.ambientSource=xu,i.litOptions.ambientEncoding=null)}i.litOptions.skyboxIntensity=r,i.litOptions.useCubeMapRotation=r&&e._skyboxRotationShaderInclude},a._updateLightOptions=function(i,t,e,n,r){if(i.lightMap=!1,i.lightMapChannel="",i.lightMapUv=0,i.lightMapTransform=0,i.litOptions.lightMapWithoutAmbient=!1,i.dirLightMap=!1,n&&(i.litOptions.noShadow=(1&n)!=0,64&n&&(i.lightMapEncoding=t.lightmapPixelFormat===7?"rgbm":"linear",i.lightMap=!0,i.lightMapChannel="rgb",i.lightMapUv=1,i.lightMapTransform=0,i.litOptions.lightMapWithoutAmbient=!e.lightMap,128&n&&(i.dirLightMap=!0),4096&n&&(i.litOptions.lightMapWithoutAmbient=!1))),e.useLighting){var s=[],l=n?n>>16:1;i.litOptions.lightMaskDynamic=!!(1&l),r&&(ju.collectLights(0,r[0],s,l),t.clusteredLightingEnabled||(ju.collectLights(1,r[1],s,l),ju.collectLights(2,r[2],s,l))),i.litOptions.lights=s}else i.litOptions.lights=[];i.litOptions.lights.length!==0||t.clusteredLightingEnabled||(i.litOptions.noShadow=!0)},a._getMapTransformID=function(i,t){if(!i)return 0;var e=this._mapXForms[t];e||(e=[],this._mapXForms[t]=e);for(var n=0;n<e.length;n++)if(sS(e[n][0].value,i[0].value)&&sS(e[n][1].value,i[1].value))return n+1;return e.push(i)},o}();function aS(){return(aS=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function He(o,a,i){a===void 0&&(a=!0),i===void 0&&(i=!0);var t={};return t[""+o+"Map"]="texture",t[""+o+"MapTiling"]="vec2",t[""+o+"MapOffset"]="vec2",t[""+o+"MapRotation"]="number",t[""+o+"MapUv"]="number",a&&(t[""+o+"MapChannel"]="string",i&&(t[""+o+"VertexColor"]="boolean",t[""+o+"VertexColorChannel"]="string")),t}var ha=aS({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb"},He("ao"),He("aoDetail",!0,!1),{aoDetailMode:"string",aoIntensity:"number",diffuse:"rgb"},He("diffuse"),He("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},He("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},He("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",metalnessTint:"boolean"},He("metalness"),{useMetalnessSpecularColor:"boolean",anisotropyIntensity:"number",anisotropyRotation:"number"},He("anisotropy"),{shininess:"number",gloss:"number",glossInvert:"boolean"},He("gloss"),{clearCoat:"number"},He("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},He("clearCoatGloss"),{clearCoatBumpiness:"number"},He("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb"},He("sheen"),{sheenGloss:"number",sheenGlossInvert:"boolean"},He("sheenGloss"),{fresnelModel:"number",emissive:"rgb"},He("emissive"),{emissiveIntensity:"number"},He("normal",!1),{bumpiness:"number"},He("normalDetail",!1),{normalDetailMapBumpiness:"number"},He("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},He("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},He("refraction"),{refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean"},He("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},He("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},He("iridescenceThickness"),He("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"}),fa=[];for(var oS in ha)ha[oS]==="texture"&&fa.push(oS);var Xu=[];for(var lS in ha)ha[lS]==="cubemap"&&Xu.push(lS);var UI={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean",ambientTint:"boolean",emissiveTint:"boolean",diffuseTint:"boolean",sheenTint:"boolean",conserveEnergy:"boolean",useGamma:"boolean",useGammaTonemap:"boolean",sheenGlossTint:"boolean",anisotropy:"boolean"};function uS(o,a){return(uS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Yu={},cS={},qu=new Set,Ku=new B,it=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return(t=o.call(this)||this).userAttributes=new Map,t._assetReferences={},t._activeParams=new Set,t._activeLightingParams=new Set,t.shaderOptBuilder=new FI,t.reset(),t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&uS(a,o);var i=a.prototype;return i.reset=function(){var t=this;Object.keys(Yu).forEach(function(e){t["_"+e]=Yu[e].value()}),this._uniformCache={}},i.copy=function(t){var e=this;return o.prototype.copy.call(this,t),Object.keys(Yu).forEach(function(n){e[n]=t[n]}),this.userAttributes=new Map(t.userAttributes),this},i.setAttribute=function(t,e){this.userAttributes.set(e,t)},i._setParameter=function(t,e){qu.add(t),this.setParameter(t,e)},i._setParameters=function(t){var e=this;t.forEach(function(n){e._setParameter(n.name,n.value)})},i._processParameters=function(t){var e=this,n=this[t];n.forEach(function(r){qu.has(r)||delete e.parameters[r]}),this[t]=qu,(qu=n).clear()},i._updateMap=function(t){var e=""+t+"Map",n=this[e];if(n){this._setParameter("texture_"+e,n);var r=this.getUniform(""+e+"Transform");r&&this._setParameters(r)}},i._allocUniform=function(t,e){var n=this._uniformCache[t];return n||(n=e(),this._uniformCache[t]=n),n},i.getUniform=function(t,e,n){return cS[t](this,e,n)},i.updateUniforms=function(t,e){var n=this,r=function(l){return n.getUniform(l,t,e)};for(var s in this._setParameter("material_ambient",r("ambient")),this._setParameter("material_diffuse",r("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",r("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",r("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",r("specular")),this.enableGGXSpecular&&(this._setParameter("material_anisotropyIntensity",this.anisotropyIntensity),this._setParameter("material_anisotropyRotation",[Math.cos(this.anisotropyRotation*U.DEG_TO_RAD),Math.sin(this.anisotropyRotation*U.DEG_TO_RAD)])),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",r("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",r("attenuation")),this._setParameter("material_invAttenuationDistance",this.attenuationDistance===0?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),this.opacityFadesSpecular===!1&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===1&&this._setParameter(r("cubeMapProjectionBox")),ca)this._updateMap(s);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",r("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),o.prototype.updateUniforms.call(this,t,e)},i.updateEnvUniforms=function(t,e){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(e.envAtlas&&e.skybox?(this._setParameter("texture_envAtlas",e.envAtlas),this._setParameter("texture_cubeMap",e.skybox)):e.envAtlas?this._setParameter("texture_envAtlas",e.envAtlas):e.skybox&&this._setParameter("texture_cubeMap",e.skybox)),this._processParameters("_activeLightingParams")},i.getShaderVariant=function(t){var e=t.device,n=t.scene,r=t.pass,s=t.objDefs,l=t.sortedLights,u=t.cameraShaderParams;this.updateEnvUniforms(e,n);var c=Ti.get(e).getByIndex(r),h=r===3||r===1||c.isShadow,f=h?bd.optionsContextMin:bd.optionsContext;f.defines=Te.getCoreDefines(this,t),h?this.shaderOptBuilder.updateMinRef(f,n,this,s,r,l):this.shaderOptBuilder.updateRef(f,n,u,this,s,r,l),this.useFog||f.defines.set("FOG","NONE"),f.defines.set("TONEMAP",gu[f.litOptions.toneMap]),this.onUpdateShader&&(f=this.onUpdateShader(f));var d=new Io(t.viewUniformFormat,t.viewBindGroupFormat,t.vertexFormat),p=sr(e);p.register("standard",bd);var _=p.getProgram("standard",f,d,this.userId);return this._dirtyShader=!1,_},i.destroy=function(){for(var t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,o.prototype.destroy.call(this)},a}(Ci);it.TEXTURE_PARAMETERS=fa,it.CUBEMAP_PARAMETERS=Xu;var Zu=function(o,a){cS[o]=a},Td=function(o,a,i,t){Object.defineProperty(it.prototype,o,{get:t||function(){return this["_"+o]},set:i}),Yu[o]={value:a}},BI=function(o){var a="_"+o.name,i=o.dirtyShaderFunc||function(){return!0};Td(o.name,function(){return o.defaultValue},function(t){var e=this[a];e!==t&&(this._dirtyShader=this._dirtyShader||i(e,t),this[a]=t)},o.getterFunc)},VI=function(o){var a="_"+o.name,i=o.dirtyShaderFunc||function(){return!0};Td(o.name,function(){return o.defaultValue.clone()},function(t){var e=this[a];e.equals(t)||(this._dirtyShader=this._dirtyShader||i(e,t),this[a]=e.copy(t))},o.getterFunc)},vn=function(o){return o.defaultValue&&o.defaultValue.clone?VI(o):BI(o)};function Ve(o,a,i,t){a===void 0&&(a="rgb"),i===void 0&&(i=!0),t===void 0&&(t=0),ca[o]=a.length||-1,vn({name:""+o+"Map",defaultValue:null,dirtyShaderFunc:function(l,u){return!!l!=!!u||l&&(l.type!==u.type||l.format!==u.format)}}),vn({name:""+o+"MapTiling",defaultValue:new G(1,1)}),vn({name:""+o+"MapOffset",defaultValue:new G(0,0)}),vn({name:""+o+"MapRotation",defaultValue:0}),vn({name:""+o+"MapUv",defaultValue:t}),a&&(vn({name:""+o+"MapChannel",defaultValue:a}),i&&(vn({name:""+o+"VertexColor",defaultValue:!1}),vn({name:""+o+"VertexColorChannel",defaultValue:a})));var e=""+o+"MapTiling",n=""+o+"MapOffset",r=""+o+"MapRotation",s=""+o+"MapTransform";Zu(s,function(l,u,c){var h=l[e],f=l[n],d=l[r];if(h.x===1&&h.y===1&&f.x===0&&f.y===0&&d===0)return null;var p=l._allocUniform(s,function(){return[{name:"texture_"+s+"0",value:new Float32Array(3)},{name:"texture_"+s+"1",value:new Float32Array(3)}]}),_=Math.cos(d*U.DEG_TO_RAD),g=Math.sin(d*U.DEG_TO_RAD),y=p[0].value;y[0]=_*h.x,y[1]=-g*h.y,y[2]=f.x;var v=p[1].value;return v[0]=g*h.x,v[1]=_*h.y,v[2]=1-h.y-f.y,p})}function da(o,a){vn({name:o,defaultValue:a,getterFunc:function(){return this._dirtyShader=!0,this["_"+o]}}),Zu(o,function(i,t,e){var n=i._allocUniform(o,function(){return new Float32Array(3)}),r=i[o];return Ku.linear(r),n[0]=Ku.r,n[1]=Ku.g,n[2]=Ku.b,n})}function Me(o,a,i){vn({name:o,defaultValue:a,dirtyShaderFunc:function(t,e){return(t===0||t===1)!=(e===0||e===1)}}),Zu(o,i)}function jo(o,a){vn({name:o,defaultValue:null,dirtyShaderFunc:function(i,t){return!!i==!!t}}),Zu(o,a)}function Ae(o,a){vn({name:o,defaultValue:a})}function hS(o,a){return(hS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}da("ambient",new B(1,1,1)),da("diffuse",new B(1,1,1)),da("specular",new B(0,0,0)),da("emissive",new B(0,0,0)),da("sheen",new B(1,1,1)),da("attenuation",new B(1,1,1)),Me("emissiveIntensity",1),Me("specularityFactor",1),Me("sheenGloss",0),Me("gloss",.25),Me("aoIntensity",1),Me("heightMapFactor",1,function(o,a,i){return .025*o.heightMapFactor}),Me("opacity",1),Me("alphaFade",1),Me("alphaTest",0),Me("bumpiness",1),Me("normalDetailMapBumpiness",1),Me("reflectivity",1),Me("occludeSpecularIntensity",1),Me("refraction",0),Me("refractionIndex",1/1.5),Me("dispersion",0),Me("thickness",0),Me("attenuationDistance",0),Me("metalness",1),Me("anisotropyIntensity",0),Me("anisotropyRotation",0),Me("clearCoat",0),Me("clearCoatGloss",1),Me("clearCoatBumpiness",1),Me("aoUvSet",0,null),Me("iridescence",0),Me("iridescenceRefractionIndex",1/1.5),Me("iridescenceThicknessMin",0),Me("iridescenceThicknessMax",0),jo("ambientSH"),jo("cubeMapProjectionBox",function(o,a,i){var t=o._allocUniform("cubeMapProjectionBox",function(){return[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]}),e=o.cubeMapProjectionBox.getMin(),n=t[0].value;n[0]=e.x,n[1]=e.y,n[2]=e.z;var r=o.cubeMapProjectionBox.getMax(),s=t[1].value;return s[0]=r.x,s[1]=r.y,s[2]=r.z,t}),Ae("specularTint",!1),Ae("specularityFactorTint",!1),Ae("useMetalness",!1),Ae("useMetalnessSpecularColor",!1),Ae("useSheen",!1),Ae("enableGGXSpecular",!1),Ae("occludeDirect",!1),Ae("opacityFadesSpecular",!0),Ae("occludeSpecular",1),Ae("fresnelModel",2),Ae("useDynamicRefraction",!1),Ae("cubeMapProjection",0),Ae("useFog",!0),Ae("useLighting",!0),Ae("useTonemap",!0),Ae("useSkybox",!0),Ae("forceUv1",!1),Ae("pixelSnap",!1),Ae("twoSidedLighting",!1),Ae("nineSlicedMode",void 0),Ae("msdfTextAttribute",!1),Ae("useIridescence",!1),Ae("glossInvert",!1),Ae("sheenGlossInvert",!1),Ae("clearCoatGlossInvert",!1),Ae("opacityDither",Kn),Ae("opacityShadowDither",Kn),Ae("shadowCatcher",!1),Ve("diffuse"),Ve("specular"),Ve("emissive"),Ve("thickness","g"),Ve("specularityFactor","g"),Ve("normal",""),Ve("metalness","g"),Ve("gloss","g"),Ve("opacity","a"),Ve("refraction","g"),Ve("height","g",!1),Ve("ao","g"),Ve("light","rgb",!0,1),Ve("msdf",""),Ve("diffuseDetail","rgb",!1),Ve("normalDetail",""),Ve("aoDetail","g",!1),Ve("clearCoat","g"),Ve("clearCoatGloss","g"),Ve("clearCoatNormal",""),Ve("sheen","rgb"),Ve("sheenGloss","g"),Ve("iridescence","g"),Ve("iridescenceThickness","g"),Ve("anisotropy",""),Ae("diffuseDetailMode","mul"),Ae("aoDetailMode","mul"),jo("cubeMap"),jo("sphereMap"),jo("envAtlas"),Mm=[null,null,null,null,null,null],Td("prefilteredCubemaps",function(){return Mm.slice()},function(o){var a=this._prefilteredCubemaps;o=o||[];for(var i=!1,t=!0,e=0;e<6;++e){var n=o[e]||null;a[e]!==n&&(a[e]=n,i=!0),t=t&&!!a[e]}i&&(t?this.envAtlas=_d.generatePrefilteredAtlas(a,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},function(){return this._prefilteredCubemaps});var Ed=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e,n,r,s){var l,u=o.call(this)||this,c=new E,h=new E,f=new E,d=new E,p=new E,_=new E,g=[],y=[],v=[],x=[],S=[];if(e>0)for(var T=0;T<=n;T++)for(var b=0;b<=r;b++){var w=b/r*2*Math.PI-Math.PI,A=Math.sin(w),C=Math.cos(w);p.set(A*i,-e/2,C*i),d.set(A*t,e/2,C*t),c.lerp(p,d,T/n),h.sub2(d,p).normalize(),_.set(C,0,-A),f.cross(_,h).normalize(),g.push(c.x,c.y,c.z),y.push(f.x,f.y,f.z);var L=b/r,I=T/n;v.push(L,1-I);var P=I;if(I=L,L=.875*(L=P)+.0625,I=.875*I+.0625,L/=3,x.push(L,1-I),T<n&&b<r){var M=T*(r+1)+b,R=T*(r+1)+(b+1),k=(T+1)*(r+1)+b,D=(T+1)*(r+1)+(b+1);S.push(M,R,k),S.push(R,D,k)}}if(s){for(var O=Math.floor(r/2),F=e/2,N=0;N<=O;N++)for(var j=N*Math.PI*.5/O,z=Math.sin(j),V=Math.cos(j),H=0;H<=r;H++){var Y=2*H*Math.PI/r-Math.PI/2,W=Math.sin(Y),ie=Math.cos(Y)*z,te=W*z,ae=1-H/r,_e=1-N/O;g.push(ie*t,V*t+F,te*t),y.push(ie,V,te),v.push(ae,1-_e),_e=(.875*_e+.0625)/3,ae=(.875*ae+.0625)/3+1/3,x.push(ae,1-_e)}l=(n+1)*(r+1);for(var xe=0;xe<O;++xe)for(var je=0;je<r;++je){var Qe=xe*(r+1)+je,rt=Qe+r+1;S.push(l+Qe+1,l+rt,l+Qe),S.push(l+Qe+1,l+rt+1,l+rt)}for(var Pe=0;Pe<=O;Pe++)for(var wt=.5*Math.PI+Pe*Math.PI*.5/O,tt=Math.sin(wt),At=Math.cos(wt),K=0;K<=r;K++){var dt=2*K*Math.PI/r-Math.PI/2,ri=Math.sin(dt),Nn=Math.cos(dt)*tt,Fn=ri*tt,Re=1-K/r,Dt=1-Pe/O;g.push(Nn*t,At*t-F,Fn*t),y.push(Nn,At,Fn),v.push(Re,1-Dt),Dt=(.875*Dt+.0625)/3,Re=(.875*Re+.0625)/3+2/3,x.push(Re,1-Dt)}l=(n+1)*(r+1)+(r+1)*(O+1);for(var Mt=0;Mt<O;++Mt)for(var si=0;si<r;++si){var Ki=Mt*(r+1)+si,Es=Ki+r+1;S.push(l+Ki+1,l+Es,l+Ki),S.push(l+Ki+1,l+Es+1,l+Es)}}else{if(l=(n+1)*(r+1),i>0)for(var ai=0;ai<r;ai++){var Ml=ai/r*2*Math.PI,Rl=Math.sin(Ml),ws=-e/2,Un=Math.cos(Ml),Ar=1-(Rl+1)/2,oi=(Un+1)/2;g.push(Rl*i,ws,Un*i),y.push(0,-1,0),v.push(Ar,1-oi),oi=(.875*oi+.0625)/3,Ar=(.875*Ar+.0625)/3+1/3,x.push(Ar,1-oi),ai>1&&S.push(l,l+ai,l+ai-1)}if(l+=r,t>0)for(var an=0;an<r;an++){var mh=an/r*2*Math.PI,_h=Math.sin(mh),wm=e/2,vh=Math.cos(mh),le=1-(_h+1)/2,Cr=(vh+1)/2;g.push(_h*t,wm,vh*t),y.push(0,1,0),v.push(le,1-Cr),Cr=(.875*Cr+.0625)/3,le=(.875*le+.0625)/3+2/3,x.push(le,1-Cr),an>1&&S.push(l,l+an-1,l+an)}}return u.positions=g,u.normals=y,u.uvs=v,u.uvs1=x,u.indices=S,u}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&hS(a,o),a}(Ft);function fS(o,a){return(fS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var wd=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});var t,e,n,r,s,l=(e=i.radius)!=null?e:.3,u=(n=i.height)!=null?n:1,c=(r=i.heightSegments)!=null?r:1,h=(s=i.sides)!=null?s:20;return t=o.call(this,l,l,u-2*l,c,h,!0)||this,i.calculateTangents&&(t.tangents=Ri(t.positions,t.normals,t.uvs,t.indices)),t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&fS(a,o),a}(Ed);function dS(o,a){return(dS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Xo=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});var t,e,n,r,s,l,u=(e=i.baseRadius)!=null?e:.5,c=(n=i.peakRadius)!=null?n:0,h=(r=i.height)!=null?r:1,f=(s=i.heightSegments)!=null?s:5,d=(l=i.capSegments)!=null?l:18;return t=o.call(this,u,c,h,f,d,!1)||this,i.calculateTangents&&(t.tangents=Ri(t.positions,t.normals,t.uvs,t.indices)),t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&dS(a,o),a}(Ed);function pS(o,a){return(pS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var pa=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});var t,e,n,r,s,l=(e=i.radius)!=null?e:.5,u=(n=i.height)!=null?n:1,c=(r=i.heightSegments)!=null?r:5,h=(s=i.capSegments)!=null?s:20;return t=o.call(this,l,l,u,c,h,!1)||this,i.calculateTangents&&(t.tangents=Ri(t.positions,t.normals,t.uvs,t.indices)),t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&pS(a,o),a}(Ed);function mS(o,a){return(mS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Yo=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});for(var t,e,n,r=o.call(this)||this,s=(t=i.halfExtents)!=null?t:new G(.5,.5),l=(e=i.widthSegments)!=null?e:5,u=(n=i.lengthSegments)!=null?n:5,c=[],h=[],f=[],d=[],p=0,_=0;_<=l;_++)for(var g=0;g<=u;g++){var y=-s.x+2*s.x*_/l,v=-(-s.y+2*s.y*g/u),x=_/l,S=g/u;c.push(y,0,v),h.push(0,1,0),f.push(x,1-S),_<l&&g<u&&(d.push(p+u+1,p+1,p),d.push(p+u+1,p+u+2,p+1)),p++}return r.positions=c,r.normals=h,r.uvs=f,r.uvs1=f,r.indices=d,i.calculateTangents&&(r.tangents=Ri(c,h,f,d)),r}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&mS(a,o),a}(Ft);function _S(o,a){return(_S=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ma=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){i===void 0&&(i={});for(var t,e,n,r,s,l=o.call(this)||this,u=(t=i.tubeRadius)!=null?t:.2,c=(e=i.ringRadius)!=null?e:.3,h=((n=i.sectorAngle)!=null?n:360)*U.DEG_TO_RAD,f=(r=i.segments)!=null?r:30,d=(s=i.sides)!=null?s:20,p=[],_=[],g=[],y=[],v=0;v<=d;v++)for(var x=0;x<=f;x++){var S=Math.cos(h*x/f)*(c+u*Math.cos(2*Math.PI*v/d)),T=Math.sin(2*Math.PI*v/d)*u,b=Math.sin(h*x/f)*(c+u*Math.cos(2*Math.PI*v/d)),w=Math.cos(h*x/f)*Math.cos(2*Math.PI*v/d),A=Math.sin(2*Math.PI*v/d),C=Math.sin(h*x/f)*Math.cos(2*Math.PI*v/d),L=v/d,I=1-x/f;if(p.push(S,T,b),_.push(w,A,C),g.push(L,1-I),v<d&&x<f){var P=v*(f+1)+x,M=(v+1)*(f+1)+x,R=v*(f+1)+(x+1),k=(v+1)*(f+1)+(x+1);y.push(P,M,R),y.push(M,k,R)}}return l.positions=p,l.normals=_,l.uvs=g,l.uvs1=g,l.indices=y,i.calculateTangents&&(l.tangents=Ri(p,_,g,y)),l}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&_S(a,o),a}(Ft),vS=function(){function o(i,t){var e=this;this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=i,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new Zr,this._defaultStdMatOptionMin=new Zr;var n=new Dg;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},n,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,2,null),i.on("destroy:shader",function(r){e.removeFromCache(r)})}var a=o.prototype;return a.destroy=function(){this.clearCache()},a.register=function(i,t){this._generators.has(i)||this._generators.set(i,t)},a.unregister=function(i){this._generators.has(i)&&this._generators.delete(i)},a.isRegistered=function(i){return this._generators.has(i)},a.generateShaderDefinition=function(i,t,e,n){var r=this.definitionsCache.get(e);if(!r){(s=n.litOptions)!=null&&s.lights&&(u=n.litOptions.lights,n.litOptions.lights=u.map(function(f){var d=f.clone?f.clone():f;return d.key=f.key,d})),this.storeNewProgram(t,n),(l=n.litOptions)!=null&&l.lights&&(n.litOptions.lights=u),this._precached;var s,l,u,c,h=this._device;(r=i.createShaderDefinition(h,n)).name=(c=r.name)!=null?c:n.pass?t+"-pass:"+n.pass:t,this.definitionsCache.set(e,r)}return r},a.getCachedShader=function(i){return this.processedCache.get(i)},a.setCachedShader=function(i,t){this.processedCache.set(i,t)},a.getProgram=function(i,t,e,n){var r=this._generators.get(i);if(!r)return null;var s=dn(r.generateKey(t)),l=s+"#"+dn(e.generateKey(this._device)),u=this.getCachedShader(l);if(!u){var c,h=this.generateShaderDefinition(r,i,s,t),f="";t.pass!==void 0&&(f="-"+(c=Ti.get(this._device).getByIndex(t.pass)).name),this._device.fire("shader:generate",{userMaterialId:n,shaderPassInfo:c,definition:h});var d={name:""+h.name+f+"-proc",attributes:h.attributes,vshader:h.vshader,vincludes:h.vincludes,fincludes:h.fincludes,fshader:h.fshader,processingOptions:e,shaderLanguage:h.shaderLanguage,meshUniformBufferFormat:h.meshUniformBufferFormat,meshBindGroupFormat:h.meshBindGroupFormat};u=new rr(this._device,d),this.setCachedShader(l,u)}return u},a.storeNewProgram=function(i,t){var e={};if(i==="standard"){var n=this._getDefaultStdMatOptions(t.pass);for(var r in t)(t.hasOwnProperty(r)&&n[r]!==t[r]||r==="pass")&&(e[r]=t[r]);for(var s in t.litOptions)e[s]=t.litOptions[s]}else e=t;this._programsCollection.push(JSON.stringify({name:i,options:e}))},a.dumpPrograms=function(){var i=`let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;
`;i+="let shaders = [",this._programsCollection[0]&&(i+=`
	`+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)i+=`,
	`+this._programsCollection[t];i+=`
];
pc.getProgramLibrary(device).precompile(shaders);
`+('if (pc.version != "'+Dh+'" || pc.revision != "'+zm)+`")
	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");`;var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i)),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)},a.clearCache=function(){this._isClearingCache=!0,this.processedCache.forEach(function(i){i.destroy()}),this.processedCache.clear(),this._isClearingCache=!1},a.removeFromCache=function(i){var t=this;this._isClearingCache||this.processedCache.forEach(function(e,n){i===e&&t.processedCache.delete(n)})},a._getDefaultStdMatOptions=function(i){var t=Ti.get(this._device).getByIndex(i);return i===3||i===1||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption},a.precompile=function(i){if(i)for(var t=Array(i.length),e=0;e<i.length;e++){if(i[e].name==="standard"){var n=i[e].options,r=this._getDefaultStdMatOptions(n.pass);for(var s in r)r.hasOwnProperty(s)&&n[s]===void 0&&(n[s]=r[s])}t[e]=this.getProgram(i[e].name,i[e].options)}this._precached=!0},o}(),_a=new X,gS=new Z,Ad=new Se,yS=new Se,zI=new B(1,1,0,.4),GI=function(o,a,i,t,e){var n=o.getProp("x"),r=o.getProp("y"),s=o.getProp("z"),l=o.getProp("rot_1"),u=o.getProp("rot_2"),c=o.getProp("rot_3"),h=o.getProp("rot_0"),f=o.getProp("scale_0"),d=o.getProp("scale_1"),p=o.getProp("scale_2"),_=o.getProp("f_dc_0"),g=o.getProp("f_dc_1"),y=o.getProp("f_dc_2"),v=o.getProp("opacity"),x=function(S){if(S>0)return 1/(1+Math.exp(-S));var T=Math.exp(S);return T/(1+T)};this.read=function(S){a&&(a.x=n[S],a.y=r[S],a.z=s[S]),i&&i.set(l[S],u[S],c[S],h[S]),t&&t.set(Math.exp(f[S]),Math.exp(d[S]),Math.exp(p[S])),e&&e.set(.5+.28209479177387814*_[S],.5+.28209479177387814*g[S],.5+.28209479177387814*y[S],x(v[S]))}},SS=function(o,a,i){gS.set(i.x,i.y,i.z,i.w).normalize(),o.setTRS(a,gS,E.ONE)},qo=function(){function o(t,e){e===void 0&&(e=[]),this.elements=t,this.numSplats=this.getElement("vertex").count,this.comments=e}var a,i=o.prototype;return i.getProp=function(t,e){var n,r;return e===void 0&&(e="vertex"),(r=this.getElement(e))==null||(n=r.properties.find(function(s){return s.name===t}))==null?void 0:n.storage},i.getElement=function(t){return this.elements.find(function(e){return e.name===t})},i.addProp=function(t,e){this.getElement("vertex").properties.push({type:"float",name:t,storage:e,byteSize:4})},i.createIter=function(t,e,n,r){return new GI(this,t,e,n,r)},i.calcAabb=function(t,e){for(var n,r,s,l,u,c,h=!0,f=this.getProp("x"),d=this.getProp("y"),p=this.getProp("z"),_=this.getProp("scale_0"),g=this.getProp("scale_1"),y=this.getProp("scale_2"),v=0;v<this.numSplats;++v)if(!e||e(v)){var x=f[v],S=d[v],T=p[v],b=Math.max(_[v],g[v],y[v]);if(isFinite(x)&&isFinite(S)&&isFinite(T)&&isFinite(b)){var w=2*Math.exp(b);h?(h=!1,n=x-w,r=S-w,s=T-w,l=x+w,u=S+w,c=T+w):(n=Math.min(n,x-w),r=Math.min(r,S-w),s=Math.min(s,T-w),l=Math.max(l,x+w),u=Math.max(u,S+w),c=Math.max(c,T+w))}}return h||(t.center.set((n+l)*.5,(r+u)*.5,(s+c)*.5),t.halfExtents.set((l-n)*.5,(u-r)*.5,(c-s)*.5)),!h},i.calcAabbExact=function(t,e){for(var n=new E,r=new Z,s=new E,l=this.createIter(n,r,s),u=!0,c=0;c<this.numSplats;++c)(!e||e(c))&&(l.read(c),u?(u=!1,o.calcSplatAabb(t,n,r,s)):(o.calcSplatAabb(yS,n,r,s),t.add(yS)));return!u},i.getCenters=function(t){for(var e=this.getProp("x"),n=this.getProp("y"),r=this.getProp("z"),s=0;s<this.numSplats;++s)t[3*s+0]=e[s],t[3*s+1]=n[s],t[3*s+2]=r[s]},i.calcFocalPoint=function(t,e){var n=this.getProp("x"),r=this.getProp("y"),s=this.getProp("z"),l=this.getProp("scale_0"),u=this.getProp("scale_1"),c=this.getProp("scale_2");t.x=0,t.y=0,t.z=0;for(var h=0,f=0;f<this.numSplats;++f)if(!e||e(f)){var d=n[f],p=r[f],_=s[f];if(isFinite(d)&&isFinite(p)&&isFinite(_)){var g=1/(1+Math.exp(Math.max(l[f],u[f],c[f])));t.x+=d*g,t.y+=p*g,t.z+=_*g,h+=g}}t.mulScalar(1/h)},i.renderWireframeBounds=function(t,e){for(var n=new E,r=new Z,s=new E,l=new E,u=new E,c=this.createIter(n,r,s),h=0;h<this.numSplats;++h)c.read(h),SS(_a,n,r),_a.mul2(e,_a),l.set(-2*s.x,-2*s.y,-2*s.z),u.set(2*s.x,2*s.y,2*s.z),t.immediate.drawWireAlignedBox(l,u,zI,!0,t.defaultDrawLayer,_a)},i.calcMortonOrder=function(){for(var t=function(M){for(var R=M[0],k=M[0],D=1;D<M.length;D++)M[D]<R&&(R=M[D]),M[D]>k&&(k=M[D]);return{min:R,max:k}},e=this.getProp("x"),n=this.getProp("y"),r=this.getProp("z"),s=t(e),l=s.min,u=s.max,c=t(n),h=c.min,f=c.max,d=t(r),p=d.min,_=d.max,g=l===u?0:1024/(u-l),y=h===f?0:1024/(f-h),v=p===_?0:1024/(_-p),x=new Map,S=0;S<this.numSplats;S++){var T=function(M,R,k){var D=function(O){return O&=1023,O=((O=((O=((O=(O^O<<16)&4278190335)^O<<8)&50393103)^O<<4)&51130563)^O<<2)&153391689};return(D(k)<<2)+(D(R)<<1)+D(M)}(Math.min(1023,Math.floor((e[S]-l)*g)),Math.min(1023,Math.floor((n[S]-h)*y)),Math.min(1023,Math.floor((r[S]-p)*v))),b=x.get(T);b?b.push(S):x.set(T,[S])}for(var w=Array.from(x.keys()).sort(function(M,R){return M-R}),A=new Uint32Array(this.numSplats),C=0,L=0;L<w.length;++L)for(var I=x.get(w[L]),P=0;P<I.length;++P)A[C++]=I[P];return A},i.reorder=function(t){var e=new Map,n=function(l){if(e.has(l)){var u=e.get(l);return e.delete(l),u}return new ArrayBuffer(l)},r=function(l){e.set(l.byteLength,l)},s=function(l){for(var u=new l.constructor(n(l.byteLength)),c=0;c<t.length;c++)u[c]=l[t[c]];return r(l.buffer),u};this.elements.forEach(function(l){l.properties.forEach(function(u){u.storage&&(u.storage=s(u.storage))})})},i.reorderData=function(){this.reorder(this.calcMortonOrder())},o.calcSplatAabb=function(t,e,n,r){SS(_a,e,n),Ad.center.set(0,0,0),Ad.halfExtents.set(2*r.x,2*r.y,2*r.z),t.setFromTransformedAabb(Ad,_a)},a=[{key:"isCompressed",get:function(){return!1}},{key:"shBands",get:function(){var t,e=this;return(t={9:1,24:2,45:3}[function(){for(var n=0;n<45;++n)if(!e.getProp("f_rest_"+n))return n;return 45}()])!=null?t:0}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function xS(){return(xS=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}var Qu=function(){function o(t,e){this.device=t,this.gsplatData=e,this.centers=new Float32Array(3*e.numSplats),e.getCenters(this.centers),this.aabb=new Se,e.calcAabb(this.aabb);for(var n=128*Math.ceil(e.numSplats/128)/128,r=new Uint32Array(n),s=0;s<n;++s)r[s]=128*s;for(var l=new Ot(t,[{semantic:Rs,components:1,type:5,asInt:!0}]),u=new Float32Array(1536),c=new Uint32Array(768),h=0;h<128;++h){u.set([-1,-1,h,1,-1,h,1,1,h,-1,1,h],12*h);var f=4*h;c.set([0+f,1+f,2+f,0+f,2+f,3+f],6*h)}this.mesh=new ye(t),this.mesh.setPositions(u,3),this.mesh.setIndices(c),this.mesh.update(),this.mesh.incRefCount(),this.mesh.aabb.copy(this.aabb),this.instanceIndices=new Rt(t,l,n,{usage:0,data:r.buffer})}var a,i=o.prototype;return i.destroy=function(){var t,e;(t=this.mesh)==null||t.destroy(),(e=this.instanceIndices)==null||e.destroy()},i.configureMaterial=function(t){},i.evalTextureSize=function(t){},i.createTexture=function(t,e,n,r){return new ee(this.device,xS({name:t,width:n.x,height:n.y,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1},r?{levels:[r]}:{}))},i.instantiate=function(){},a=[{key:"instanceSize",get:function(){return 128}},{key:"numSplats",get:function(){return this.gsplatData.numSplats}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function bS(o,a){return(bS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var HI=function(o,a){for(var i=[],t=0;t<a;++t)i.push(o.getProp("f_rest_"+t));return i},Ju=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n=o.call(this,t,e)||this,r=e.numSplats,s=n.evalTextureSize(r);return n.colorTexture=n.createTexture("splatColor",12,s),n.transformATexture=n.createTexture("transformA",49,s),n.transformBTexture=n.createTexture("transformB",12,s),n.updateColorData(e),n.updateTransformData(e),n.shBands=e.shBands,n.shBands>0&&(n.sh1to3Texture=n.createTexture("splatSH_1to3",49,s),n.shBands>1&&(n.sh4to7Texture=n.createTexture("splatSH_4to7",49,s),n.shBands>2?(n.sh8to11Texture=n.createTexture("splatSH_8to11",49,s),n.sh12to15Texture=n.createTexture("splatSH_12to15",49,s)):n.sh8to11Texture=n.createTexture("splatSH_8to11",37,s)),n.updateSHData(e)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&bS(a,o);var i=a.prototype;return i.destroy=function(){var t,e,n,r,s,l,u;(t=this.colorTexture)==null||t.destroy(),(e=this.transformATexture)==null||e.destroy(),(n=this.transformBTexture)==null||n.destroy(),(r=this.sh1to3Texture)==null||r.destroy(),(s=this.sh4to7Texture)==null||s.destroy(),(l=this.sh8to11Texture)==null||l.destroy(),(u=this.sh12to15Texture)==null||u.destroy(),o.prototype.destroy.call(this)},i.configureMaterial=function(t){t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture)},i.evalTextureSize=function(t){var e=Math.ceil(Math.sqrt(t)),n=Math.ceil(t/e);return new G(e,n)},i.updateColorData=function(t){var e=this.colorTexture;if(e){for(var n=pi.float2Half,r=e.lock(),s=t.getProp("f_dc_0"),l=t.getProp("f_dc_1"),u=t.getProp("f_dc_2"),c=t.getProp("opacity"),h=0;h<this.numSplats;++h){var f=.28209479177387814*s[h]+.5,d=.28209479177387814*l[h]+.5,p=.28209479177387814*u[h]+.5,_=1/(1+Math.exp(-c[h]));r[4*h+0]=n(f),r[4*h+1]=n(d),r[4*h+2]=n(p),r[4*h+3]=n(_)}e.unlock()}},i.updateTransformData=function(t){var e=pi.float2Half;if(this.transformATexture){for(var n=this.transformATexture.lock(),r=new Float32Array(n.buffer),s=this.transformBTexture.lock(),l=new E,u=new Z,c=new E,h=t.createIter(l,u,c),f=0;f<this.numSplats;f++)h.read(f),u.normalize(),u.w<0&&u.mulScalar(-1),r[4*f+0]=l.x,r[4*f+1]=l.y,r[4*f+2]=l.z,n[4*f+3]=e(u.x)|e(u.y)<<16,s[4*f+0]=e(c.x),s[4*f+1]=e(c.y),s[4*f+2]=e(c.z),s[4*f+3]=e(u.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}},i.updateSHData=function(t){for(var e,n,r,s,l,u,c=this.sh1to3Texture.lock(),h=(e=this.sh4to7Texture)==null?void 0:e.lock(),f=(n=this.sh8to11Texture)==null?void 0:n.lock(),d=(r=this.sh12to15Texture)==null?void 0:r.lock(),p={1:3,2:8,3:15}[this.shBands],_=HI(t,3*p),g=new Float32Array(1),y=new Uint32Array(g.buffer),v=Array(3*p).fill(0),x=0;x<t.numSplats;++x){for(var S=0;S<p;++S)v[3*S]=_[S][x],v[3*S+1]=_[S+p][x],v[3*S+2]=_[S+2*p][x];for(var T=v[0],b=1;b<3*p;++b)T=Math.max(T,Math.abs(v[b]));if(T!==0){for(var w=0;w<p;++w)v[3*w+0]=Math.max(0,Math.min(2047,Math.floor((v[3*w+0]/T*.5+.5)*2047+.5))),v[3*w+1]=Math.max(0,Math.min(1023,Math.floor((v[3*w+1]/T*.5+.5)*1023+.5))),v[3*w+2]=Math.max(0,Math.min(2047,Math.floor((v[3*w+2]/T*.5+.5)*2047+.5)));g[0]=T,c[4*x+0]=y[0],c[4*x+1]=v[0]<<21|v[1]<<11|v[2],c[4*x+2]=v[3]<<21|v[4]<<11|v[5],c[4*x+3]=v[6]<<21|v[7]<<11|v[8],this.shBands>1&&(h[4*x+0]=v[9]<<21|v[10]<<11|v[11],h[4*x+1]=v[12]<<21|v[13]<<11|v[14],h[4*x+2]=v[15]<<21|v[16]<<11|v[17],h[4*x+3]=v[18]<<21|v[19]<<11|v[20],this.shBands>2?(f[4*x+0]=v[21]<<21|v[22]<<11|v[23],f[4*x+1]=v[24]<<21|v[25]<<11|v[26],f[4*x+2]=v[27]<<21|v[28]<<11|v[29],f[4*x+3]=v[30]<<21|v[31]<<11|v[32],d[4*x+0]=v[33]<<21|v[34]<<11|v[35],d[4*x+1]=v[36]<<21|v[37]<<11|v[38],d[4*x+2]=v[39]<<21|v[40]<<11|v[41],d[4*x+3]=v[42]<<21|v[43]<<11|v[44]):f[x]=v[21]<<21|v[22]<<11|v[23])}}this.sh1to3Texture.unlock(),(s=this.sh4to7Texture)==null||s.unlock(),(l=this.sh8to11Texture)==null||l.unlock(),(u=this.sh12to15Texture)==null||u.unlock()},a}(Qu);function TS(o,a){return(TS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function WI(){var o,a,i,t,e,n,r,s,l=typeof self<"u"&&self||require("node:worker_threads").parentPort,u=!1,c={x:0,y:0,z:0},h={x:0,y:0,z:0},f={x:0,y:0,z:0},d={x:0,y:0,z:0},p=Array(32).fill(0),_=Array(32).fill(0),g=Array(32).fill(0),y=function(x,S,T){for(;x<=S;){var b=S+x>>1,w=T(b);if(w>0)x=b+1;else{if(!(w<0))return b;S=b-1}}return~x},v=function(){if(o&&a&&a.length!==0&&e&&n){var x,S,T=e.x,b=e.y,w=e.z,A=n.x,C=n.y,L=n.z;if(!(!u&&.001>Math.abs(T-c.x)&&.001>Math.abs(b-c.y)&&.001>Math.abs(w-c.z)&&.001>Math.abs(A-h.x)&&.001>Math.abs(C-h.y)&&.001>Math.abs(L-h.z))){u=!1,c.x=T,c.y=b,c.z=w,h.x=A,h.y=C,h.z=L;for(var I,P=0;P<8;++P){var M=(1&P?f.x:d.x)*A+(2&P?f.y:d.y)*C+(4&P?f.z:d.z)*L;P===0?x=S=M:(x=Math.min(x,M),S=Math.max(S,M))}var R=a.length/3,k=Math.pow(2,Math.max(10,Math.min(20,Math.round(Math.log2(R/4)))))+1;(r==null?void 0:r.length)!==R&&(r=new Uint32Array(R)),s&&s.length===k?s.fill(0):s=new Uint32Array(k);var D=S-x;if(D<1e-6)for(var O=0;O<R;++O)r[O]=0,s[0]++;else{var F=i.length/4;p.fill(0);for(var N=0;N<F;++N)for(var j=i[4*N+0],z=i[4*N+1],V=i[4*N+2],H=i[4*N+3],Y=j*A+z*C+V*L-x,W=Math.max(0,Math.floor((Y-H)*32/D)),ie=Math.min(32,Math.ceil((Y+H)*32/D)),te=W;te<ie;++te)p[te]++;for(var ae=p.reduce(function(Dt,Mt){return Dt+Mt},0),_e=0;_e<32;++_e)g[_e]=p[_e]/ae*k>>>0;for(var xe=0;xe<32;++xe)_[xe]=xe===0?0:_[xe-1]+g[xe-1];for(var je=D/32,Qe=0,rt=0;rt<R;++rt){var Pe=(a[Qe++]*A+a[Qe++]*C+a[Qe++]*L-x)/je,wt=Pe>>>0,tt=_[wt]+g[wt]*(Pe-wt)>>>0;r[rt]=tt,s[tt]++}}for(var At=1;At<k;At++)s[At]+=s[At-1];for(var K=0;K<R;K++){var dt=r[K];o[--s[dt]]=K}var ri=T*A+b*C+w*L,Nn=function(Dt){var Mt=3*o[Dt];return a[Mt++]*A+a[Mt++]*C+a[Mt]*L-ri},Fn=Nn(R-1)>=0?(I=y(0,R-1,function(Dt){return-Nn(Dt)}),Math.min(R,Math.abs(I))):R;if(t)for(var Re=0;Re<R;++Re)o[Re]=t[o[Re]];l.postMessage({order:o.buffer,count:Fn},[o.buffer]),o=null}}};l.addEventListener("message",function(x){var S=(M=x.data)!=null?M:x;if(S.order&&(o=new Uint32Array(S.order)),S.centers)if(a=new Float32Array(S.centers),u=!0,S.chunks){var T=new Float32Array(S.chunks);i=new Float32Array(S.chunks,0,4*T.length/6),f.x=T[0],f.y=T[1],f.z=T[2],d.x=T[3],d.y=T[4],d.z=T[5];for(var b=0;b<T.length/6;++b){var w=T[6*b+0],A=T[6*b+1],C=T[6*b+2],L=T[6*b+3],I=T[6*b+4],P=T[6*b+5];i[4*b+0]=(w+L)*.5,i[4*b+1]=(A+I)*.5,i[4*b+2]=(C+P)*.5,i[4*b+3]=.5*Math.sqrt(Math.pow(L-w,2)+Math.pow(I-A,2)+Math.pow(P-C,2)),w<f.x&&(f.x=w),A<f.y&&(f.y=A),C<f.z&&(f.z=C),L>d.x&&(d.x=L),I>d.y&&(d.y=I),P>d.z&&(d.z=P)}}else{var M,R,k,D,O,F,N,j=a.length/3,z=Math.ceil(j/256);i=new Float32Array(4*z),f.x=f.y=f.z=1/0,d.x=d.y=d.z=-1/0;for(var V=0;V<z;++V){R=k=D=1/0,O=F=N=-1/0;for(var H=256*V,Y=Math.min(j,(V+1)*256),W=H;W<Y;++W){var ie=a[3*W+0],te=a[3*W+1],ae=a[3*W+2],_e=Number.isFinite(ie),xe=Number.isFinite(te),je=Number.isFinite(ae);_e||(a[3*W+0]=0),xe||(a[3*W+1]=0),je||(a[3*W+2]=0),_e&&xe&&je&&(ie<R?R=ie:ie>O&&(O=ie),te<k?k=te:te>F&&(F=te),ae<D?D=ae:ae>N&&(N=ae),ie<f.x?f.x=ie:ie>d.x&&(d.x=ie),te<f.y?f.y=te:te>d.y&&(d.y=te),ae<f.z?f.z=ae:ae>d.z&&(d.z=ae))}i[4*V+0]=(R+O)*.5,i[4*V+1]=(k+F)*.5,i[4*V+2]=(D+N)*.5,i[4*V+3]=.5*Math.sqrt(Math.pow(O-R,2)+Math.pow(F-k,2)+Math.pow(N-D,2))}}S.hasOwnProperty("mapping")&&(t=S.mapping?new Uint32Array(S.mapping):null,u=!0),S.cameraPosition&&(e=S.cameraPosition),S.cameraDirection&&(n=S.cameraDirection),v()})}var jI=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t=o.call(this)||this,e="("+WI.toString()+")()",n=fe.environment==="node";return n?t.worker=new Worker(e,{eval:!0}):t.worker=new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"}))),t.worker[n?"on":"addEventListener"]("message",function(r){var s,l=(s=r.data)!=null?s:r,u=l.order,c=t.orderTexture._levels[0].buffer;t.worker.postMessage({order:c},[c]),t.orderTexture._levels[0]=new Uint32Array(u),t.orderTexture.upload(),t.fire("updated",l.count)}),t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&TS(a,o);var i=a.prototype;return i.destroy=function(){this.worker.terminate(),this.worker=null},i.init=function(t,e,n){this.orderTexture=t,this.centers=e.slice();var r=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(var s=0;s<r.length;++s)r[s]=s;var l={order:r.buffer,centers:e.buffer,chunks:n==null?void 0:n.buffer},u=[r.buffer,e.buffer].concat(n?[n.buffer]:[]);this.worker.postMessage(l,u)},i.setMapping=function(t){if(t){for(var e=new Float32Array(3*t.length),n=0;n<t.length;++n){var r=3*t[n],s=3*n;e[s+0]=this.centers[r+0],e[s+1]=this.centers[r+1],e[s+2]=this.centers[r+2]}this.worker.postMessage({centers:e.buffer,mapping:t.buffer},[e.buffer,t.buffer])}else{var l=this.centers.slice();this.worker.postMessage({centers:l.buffer,mapping:null},[l.buffer])}},i.setCamera=function(t,e){this.worker.postMessage({cameraPosition:{x:t.x,y:t.y,z:t.z},cameraDirection:{x:e.x,y:e.y,z:e.z}})},a}(se),XI=new X,va=new E,ga=new E,$u=[0,0],ES=function(){function o(t,e){var n,r=this;this.options={},this.sorter=null,this.lastCameraPosition=new E,this.lastCameraDirection=new E,this.cameras=[],this.resource=t,this.orderTexture=t.createTexture("splatOrder",37,t.evalTextureSize(t.numSplats)),e?(this._material=e,this._material.setParameter("splatOrder",this.orderTexture)):(this._material=new hr({uniqueName:"SplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:oe,vertex_id_attrib:Rs}}),this.configureMaterial(this._material),this._material.update()),this.meshInstance=new De(t.mesh,this._material),this.meshInstance.setInstancing(t.instanceIndices,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;var s=t.centers.slice(),l=(n=t.chunks)==null?void 0:n.slice();this.sorter=new jI,this.sorter.init(this.orderTexture,s,l),this.sorter.on("updated",function(u){r.meshInstance.instancingCount=Math.ceil(u/t.instanceSize),r.material.setParameter("numSplats",u)})}var a,i=o.prototype;return i.destroy=function(){var t,e,n;(t=this.material)==null||t.destroy(),(e=this.meshInstance)==null||e.destroy(),(n=this.sorter)==null||n.destroy()},i.configureMaterial=function(t,e){e===void 0&&(e={}),this.resource.configureMaterial(t),t.setParameter("numSplats",0),t.setParameter("splatOrder",this.orderTexture),t.setParameter("alphaClip",.3),t.setDefine("DITHER_"+(e.dither?"BLUENOISE":"NONE"),""),t.cull=0,t.blendType=e.dither?3:4,t.depthWrite=!!e.dither},i.updateViewport=function(t){var e,n=t==null?void 0:t.camera,r=n==null?void 0:n.renderTarget,s=r??this.resource.device,l=s.width,u=s.height;$u[0]=l,$u[1]=u;var c=n==null||(e=n.camera)==null?void 0:e.xr;c!=null&&c.active&&c.views.list.length===2&&($u[0]*=.5),this.material.setParameter("viewport",$u)},i.sort=function(t){if(this.sorter){var e=t.getWorldTransform();e.getTranslation(va),e.getZ(ga);var n=this.meshInstance.node.getWorldTransform(),r=XI.invert(n);r.transformPoint(va,va),r.transformVector(ga,ga),va.equalsApprox(this.lastCameraPosition)&&ga.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(va),this.lastCameraDirection.copy(ga),this.sorter.setCamera(va,ga))}this.updateViewport(t)},i.update=function(){if(this.cameras.length>0){var t=this.cameras[0];this.sort(t._node),this.cameras.length=0}},a=[{key:"material",get:function(){return this._material},set:function(t){this._material!==t&&(this._material=t,this._material.setParameter("splatOrder",this.orderTexture),this.meshInstance&&(this.meshInstance.material=t))}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function wS(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function AS(o){return function(){var a=this,i=arguments;return new Promise(function(t,e){var n=o.apply(a,i);function r(l){wS(n,t,e,r,s,"next",l)}function s(l){wS(n,t,e,r,s,"throw",l)}r(void 0)})}}function CS(o,a){var i,t,e,n={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]},r=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return r.next=s(0),r.throw=s(1),r.return=s(2),typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function s(l){return function(u){var c=[l,u];if(i)throw TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(n=0)),n;)try{if(i=1,t&&(e=2&c[0]?t.return:c[0]?t.throw||((e=t.return)&&e.call(t),0):t.next)&&!(e=e.call(t,c[1])).done)return e;switch(t=0,e&&(c=[2&c[0],e.value]),c[0]){case 0:case 1:e=c;break;case 4:return n.label++,{value:c[1],done:!1};case 5:n.label++,t=c[1],c=[0];continue;case 7:c=n.ops.pop(),n.trys.pop();continue;default:if(!(e=(e=n.trys).length>0&&e[e.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!e||c[1]>e[0]&&c[1]<e[3])){n.label=c[1];break}if(c[0]===6&&n.label<e[1]){n.label=e[1],e=c;break}if(e&&n.label<e[2]){n.label=e[2],n.ops.push(c);break}e[2]&&n.ops.pop(),n.trys.pop();continue}c=a.call(o,n)}catch(h){c=[6,h],t=0}finally{i=e=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var ki=function(o){return o.read(0,0,o.width,o.height,{mipLevel:0,face:0,immediate:!0})},YI=function(o,a){for(var i in a)o.resolve(i).setValue(a[i])},qI=function(o,a,i,t,e,n){var r=function(S,T,b){return S*(1-b)+T*b},s=o.meta,l=s.means,u=s.scales,c=s.sh0,h=s.shN,f=a&&o.means_l._levels[0],d=a&&o.means_u._levels[0],p=i&&o.quats._levels[0],_=t&&o.scales._levels[0],g=e&&o.sh0._levels[0],y=n&&o.sh_labels._levels[0],v=n&&o.sh_centroids._levels[0],x=2/Math.sqrt(2);this.read=function(S){if(a){var T=r(l.mins[0],l.maxs[0],((d[4*S+0]<<8)+f[4*S+0])/65535),b=r(l.mins[1],l.maxs[1],((d[4*S+1]<<8)+f[4*S+1])/65535),w=r(l.mins[2],l.maxs[2],((d[4*S+2]<<8)+f[4*S+2])/65535);a.x=Math.sign(T)*(Math.exp(Math.abs(T))-1),a.y=Math.sign(b)*(Math.exp(Math.abs(b))-1),a.z=Math.sign(w)*(Math.exp(Math.abs(w))-1)}if(i){var A=(p[4*S+0]/255-.5)*x,C=(p[4*S+1]/255-.5)*x,L=(p[4*S+2]/255-.5)*x,I=Math.sqrt(Math.max(0,1-(A*A+C*C+L*L)));switch(p[4*S+3]-252){case 0:i.set(A,C,L,I);break;case 1:i.set(I,C,L,A);break;case 2:i.set(C,I,L,A);break;case 3:i.set(C,L,I,A)}}if(t){var P=r(u.mins[0],u.maxs[0],_[4*S+0]/255),M=r(u.mins[1],u.maxs[1],_[4*S+1]/255),R=r(u.mins[2],u.maxs[2],_[4*S+2]/255);t.set(P,M,R)}if(e){var k=r(c.mins[0],c.maxs[0],g[4*S+0]/255),D=r(c.mins[1],c.maxs[1],g[4*S+1]/255),O=r(c.mins[2],c.maxs[2],g[4*S+2]/255),F=r(c.mins[3],c.maxs[3],g[4*S+3]/255);e.set(.5+.28209479177387814*k,.5+.28209479177387814*D,.5+.28209479177387814*O,1/(1+Math.exp(-F)))}if(n)for(var N=y[4*S+0]+(y[4*S+1]<<8),j=N%64*15,z=Math.floor(N/64),V=0;V<3;++V)for(var H=0;H<15;++H)n[15*V+H]=r(h.mins,h.maxs,v[(j+H)*4+V+z*o.sh_centroids.width*4]/255)}},PS=function(){function o(){}var a,i=o.prototype;return i.destroy=function(){var t,e,n,r,s,l,u;(t=this.means_l)==null||t.destroy(),(e=this.means_u)==null||e.destroy(),(n=this.quats)==null||n.destroy(),(r=this.scales)==null||r.destroy(),(s=this.sh0)==null||s.destroy(),(l=this.sh_centroids)==null||l.destroy(),(u=this.sh_labels)==null||u.destroy()},i.createIter=function(t,e,n,r,s){return new qI(this,t,e,n,r,s)},i.calcAabb=function(t){var e=this.meta.means,n=e.mins,r=e.maxs,s=function(l){return Math.sign(l)*(Math.exp(Math.abs(l))-1)};t.center.set((s(n[0])+s(r[0]))*.5,(s(n[1])+s(r[1]))*.5,(s(n[2])+s(r[2]))*.5),t.halfExtents.set((s(r[0])-s(n[0]))*.5,(s(r[1])-s(n[1]))*.5,(s(r[2])-s(n[2]))*.5)},i.getCenters=function(t){for(var e,n=this.meta,r=this.means_l,s=this.means_u,l=this.numSplats,u=n.means,c=new Uint32Array(s._levels[0].buffer),h=new Uint32Array(r._levels[0].buffer),f=(e=this.orderTexture)==null?void 0:e._levels[0],d=u.mins[0]/65535,p=u.mins[1]/65535,_=u.mins[2]/65535,g=u.maxs[0]/65535,y=u.maxs[1]/65535,v=u.maxs[2]/65535,x=0;x<l;x++){var S=f?f[x]:x,T=c[S],b=h[S],w=T<<8&65280|255&b,A=65280&T|b>>>8&255,C=T>>>8&65280|b>>>16&255,L=d*(65535-w)+g*w,I=p*(65535-A)+y*A,P=_*(65535-C)+v*C,M=L<0?-L:L,R=I<0?-I:I,k=P<0?-P:P;t[3*x]=(L<0?-1:1)*(Math.exp(M)-1),t[3*x+1]=(I<0?-1:1)*(Math.exp(R)-1),t[3*x+2]=(P<0?-1:1)*(Math.exp(k)-1)}},i.calcFocalPoint=function(t,e){t.set(0,0,0)},i.decompress=function(){var t=this;return AS(function(){var e,n,r,s,l,u,c,h,f,d,p,_,g,y,v,x,S,T,b,w,A,C,L,I,P,M,R,k,D,O,F,N,j,z,V;return CS(this,function(H){switch(H.label){case 0:return e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],n=t.shBands,r=t.means_l,s=t.means_u,l=t.quats,u=t.scales,c=t.sh0,h=t.sh_labels,f=t.sh_centroids,d=r._levels,p=0,[4,ki(r)];case 1:return d[p]=H.sent(),_=s._levels,g=0,[4,ki(s)];case 2:return _[g]=H.sent(),y=l._levels,v=0,[4,ki(l)];case 3:return y[v]=H.sent(),x=u._levels,S=0,[4,ki(u)];case 4:return x[S]=H.sent(),T=c._levels,b=0,[4,ki(c)];case 5:return T[b]=H.sent(),n>0?(A=h._levels,C=0,[4,ki(h)]):[3,8];case 6:return A[C]=H.sent(),L=f._levels,I=0,[4,ki(f)];case 7:for(M=0,L[I]=H.sent(),P=[];M<45;++M)P.push("f_rest_"+M);(w=e).splice.apply(w,[].concat([e.indexOf("f_dc_0")+1,0],P)),H.label=8;case 8:for(R={},e.forEach(function(Y){R[Y]=new Float32Array(t.numSplats)}),k=new E,D=new Z,O=new E,F=new q,N=n>0?new Float32Array(45):null,j=t.createIter(k,D,O,F,N),z=0;z<t.numSplats;++z)if(j.read(z),R.x[z]=k.x,R.y[z]=k.y,R.z[z]=k.z,R.rot_1[z]=D.x,R.rot_2[z]=D.y,R.rot_3[z]=D.z,R.rot_0[z]=D.w,R.scale_0[z]=O.x,R.scale_1[z]=O.y,R.scale_2[z]=O.z,R.f_dc_0[z]=(F.x-.5)/.28209479177387814,R.f_dc_1[z]=(F.y-.5)/.28209479177387814,R.f_dc_2[z]=(F.z-.5)/.28209479177387814,R.opacity[z]=F.w<=0?-40:F.w>=1?40:-Math.log(1/F.w-1),N)for(V=0;V<45;++V)R["f_rest_"+V][z]=N[V];return[2,new qo([{name:"vertex",count:t.numSplats,properties:e.map(function(Y){return{name:Y,type:"float",byteSize:4,storage:R[Y]}})}])]}})})()},i.reorderGpuMemory=function(){var t=this,e=this.orderTexture,n=this.numSplats,r=e.device,s=e.height,l=e.width,u=r.scope,c=Te.createShader(r,{uniqueName:"GsplatSogsReorderShader",attributes:{vertex_position:oe},vertexChunk:"fullscreenQuadVS",fragmentGLSL:`
	uniform usampler2D orderTexture;
	uniform sampler2D sourceTexture;
	uniform highp uint numSplats;
	void main(void) {
		uint w = uint(textureSize(sourceTexture, 0).x);
		uint idx = uint(gl_FragCoord.x) + uint(gl_FragCoord.y) * w;
		if (idx >= numSplats) discard;
		uint sidx = texelFetch(orderTexture, ivec2(gl_FragCoord.xy), 0).x;
		uvec2 suv = uvec2(sidx % w, sidx / w);
		gl_FragColor = texelFetch(sourceTexture, ivec2(suv), 0);
	}
`,fragmentWGSL:`
	var orderTexture: texture_2d<u32>;
	var sourceTexture: texture_2d<f32>;
	uniform numSplats: u32;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let w: u32 = textureDimensions(sourceTexture, 0).x;
		let idx: u32 = u32(pcPosition.x) + u32(pcPosition.y) * w;
		if (idx >= uniform.numSplats) {
			discard;
			return output;
		}
		let sidx: u32 = textureLoad(orderTexture, vec2<i32>(input.position.xy), 0).x;
		let suv: vec2<u32> = vec2<u32>(sidx % w, sidx / w);
		output.color = textureLoad(sourceTexture, vec2<i32>(suv), 0);
		return output;
	}
`}),h=new ee(r,{width:l,height:s,format:7,mipmaps:!1});r.setBlendState(ge.NOBLEND),r.setCullMode(0),r.setDepthState(Xe.NODEPTH),["means_l","means_u","quats","scales","sh0","sh_labels"].forEach(function(f){var d=t[f];if(d){var p=new Ee({colorBuffer:d,depth:!1,mipLevel:0});h._levels[0]=d._levels[0],h.upload(),YI(u,{orderTexture:e,sourceTexture:h,numSplats:n}),kt(r,p,c),p.destroy()}}),h.destroy()},i.calcMortonOrder=function(){for(var t=this.means_l,e=this.means_u,n=t._levels[0],r=e._levels[0],s=new BigUint64Array(this.numSplats),l=0;l<this.numSplats;++l){var u=r[4*l+0]<<2|n[4*l+0]>>>6,c=r[4*l+1]<<2|n[4*l+1]>>>6,h=r[4*l+2]<<2|n[4*l+2]>>>6;s[l]=BigInt(function(p,_,g){var y=function(v){return v&=1023,v=((v=((v=((v=(v^v<<16)&4278190335)^v<<8)&50393103)^v<<4)&51130563)^v<<2)&153391689};return(y(g)<<2)+(y(_)<<1)+y(p)}(u,c,h))<<BigInt(32)|BigInt(l)}s.sort();for(var f=new Uint32Array(t.width*t.height),d=0;d<this.numSplats;++d)f[d]=Number(s[d]&BigInt(4294967295));return f},i.reorderData=function(){var t=this;return AS(function(){var e,n,r,s,l,u,c,h;return CS(this,function(f){switch(f.label){case 0:return n=(e=t.means_l).device,r=e.height,s=e.width,l=t.means_l._levels,u=0,[4,ki(t.means_l)];case 1:return l[u]=f.sent(),c=t.means_u._levels,h=0,[4,ki(t.means_u)];case 2:return c[h]=f.sent(),t.orderTexture=new ee(n,{name:"orderTexture",width:s,height:r,format:37,mipmaps:!1,levels:[t.calcMortonOrder()]}),n.on("devicerestored",function(){t.reorderGpuMemory()}),t.reorderGpuMemory(),[2]}})})()},a=[{key:"isSogs",get:function(){return!0}},{key:"shBands",get:function(){var t,e;return(e={192:1,512:2,960:3}[(t=this.sh_centroids)==null?void 0:t.width])!=null?e:0}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function IS(o,a){return(IS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var LS=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&IS(a,o);var i=a.prototype;return i.destroy=function(){this.gsplatData.destroy(),o.prototype.destroy.call(this)},i.configureMaterial=function(t){var e=this.gsplatData;t.setDefine("GSPLAT_SOGS_DATA",!0),t.setDefine("SH_BANDS",this.gsplatData.shBands),["means_l","means_u","quats","scales","sh0","sh_centroids","sh_labels"].forEach(function(n){e[n]&&t.setParameter(n,e[n])}),["means","scales","sh0","shN"].forEach(function(n){var r=e.meta[n];r&&(t.setParameter(""+n+"_mins",r.mins),t.setParameter(""+n+"_maxs",r.maxs))})},i.evalTextureSize=function(t){return new G(this.gsplatData.means_l.width,this.gsplatData.means_l.height)},a}(Qu),DS="FILL_WINDOW",Cd="KEEP_ASPECT",Pd="AUTO",MS="FIXED",RS=!1,Id={app:null,createLoadingScreen:function(o){RS||(RS=!0,o(xt))}},KI=function(){function o(){this.renderPasses=[],this.renderTargetMap=new Map}var a=o.prototype;return a.addRenderPass=function(i){i.frameUpdate();for(var t=i.beforePasses,e=0;e<t.length;e++){var n=t[e];n.enabled&&this.addRenderPass(n)}i.enabled&&this.renderPasses.push(i);for(var r=i.afterPasses,s=0;s<r.length;s++){var l=r[s];l.enabled&&this.addRenderPass(l)}},a.reset=function(){this.renderPasses.length=0},a.compile=function(){for(var i=this.renderTargetMap,t=this.renderPasses,e=0;e<t.length;e++){var n=t[e],r=n.renderTarget;if(r!==void 0){var s=i.get(r);if(s){for(var l=n.colorArrayOps.length,u=0;u<l;u++)n.colorArrayOps[u].clear||(s.colorArrayOps[u].store=!0);n.depthStencilOps.clearDepth||(s.depthStencilOps.storeDepth=!0),n.depthStencilOps.clearStencil||(s.depthStencilOps.storeStencil=!0)}i.set(r,n)}}for(var c=0;c<t.length-1;c++){var h=t[c],f=h.renderTarget,d=t[c+1];f!==d.renderTarget||f===void 0||d.depthStencilOps.clearDepth||d.depthStencilOps.clearStencil||d.colorArrayOps.some(function(b){return b.clear})||h.afterPasses.length>0||d.beforePasses.length>0||(h._skipEnd=!0,d._skipStart=!0)}for(var p=null,_=null,g=0;g<t.length;g++){var y=t[g],v=y.renderTarget,x=v==null?void 0:v.colorBuffer;if(x!=null&&x.cubemap){if(p===x)for(var S=_.colorArrayOps.length,T=0;T<S;T++)_.colorArrayOps[T].mipmaps=!1;p=v.colorBuffer,_=y}else y.requiresCubemaps&&(p=null,_=null)}i.clear()},a.render=function(i){this.compile();for(var t=this.renderPasses,e=0;e<t.length;e++)t[e].render()},o}(),ZI=function(){function o(a,i){this.texture0=a,this.texture1=i}return o.prototype.destroy=function(){var a,i;(a=this.texture0)==null||a.destroy(),(i=this.texture1)==null||i.destroy()},o}(),OS=new It,kS=function(){function o(){}return o.createTexture=function(a,i,t,e){return e===void 0&&(e=""),new ee(a,{name:"AreaLightLUT"+e,width:t,height:t,format:i,addressU:1,addressV:1,type:Wt,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})},o.applyTextures=function(a,i,t){OS.remove(a),OS.get(a,function(){return new ZI(i,i===t?null:t)}),a.scope.resolve("areaLightsLutTex1").setValue(i),a.scope.resolve("areaLightsLutTex2").setValue(t)},o.createPlaceholder=function(a){var i=o.createTexture(a,12,2,"placeholder");i.lock().fill(0),i.unlock(),o.applyTextures(a,i,i)},o.set=function(a,i,t){function e(c,h,f){var d=o.createTexture(c,f,64);return d.lock().set(h),d.unlock(),d}function n(c){for(var h=c.length,f=new Uint16Array(h),d=pi.float2Half,p=0;p<h;p++)f[p]=d(c[p]);return f}var r=n(i),s=n(t),l=e(a,r,12),u=e(a,s,12);o.applyTextures(a,l,u)},o}(),ec="en-US",tc={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Ko={};function dr(o,a){for(var i=0,t=o.length;i<t;i++)Ko[o[i]]=a}function Ni(o){var a=o.indexOf("-");return a!==-1?o.substring(0,a):o}function NS(o,a){if(a[o])return o;var i=tc[o];if(i&&a[i])return i;var t=Ni(o);return a[i=tc[t]]?i:a[t]?t:ec}dr(["ja","ko","th","vi","zh","id"],function(o){return 0}),dr(["fa","hi"],function(o){return o>=0&&o<=1?0:1}),dr(["fr","pt"],function(o){return o>=0&&o<2?0:1}),dr(["da"],function(o){return o===1||!Number.isInteger(o)&&o>=0&&o<=1?0:1}),dr(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(o){return+(o!==1)}),dr(["ru","uk"],function(o){if(Number.isInteger(o)){var a=o%10,i=o%100;if(a===1&&i!==11)return 0;if(a>=2&&a<=4&&(i<12||i>14))return 1;if(a===0||a>=5&&a<=9||i>=11&&i<=14)return 2}return 3}),dr(["pl"],function(o){if(Number.isInteger(o)){if(o===1)return 0;var a=o%10,i=o%100;if(a>=2&&a<=4&&(i<12||i>14))return 1;if(a>=0&&a<=1||a>=5&&a<=9||i>=12&&i<=14)return 2}return 3}),dr(["ar"],function(o){if(o===0)return 0;if(o===1)return 1;if(o===2)return 2;if(Number.isInteger(o)){var a=o%100;if(a>=3&&a<=10)return 3;if(a>=11&&a<=99)return 4}return 5});var Ld=Ko[Ni(ec)],Qr=RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i"),QI=function(){function o(a,i,t,e,n,r){a===void 0&&(a=""),i===void 0&&(i=""),t===void 0&&(t=null),e===void 0&&(e=null),n===void 0&&(n=null),r===void 0&&(r=null),this.url=a,this.filename=i,this.hash=t,this.size=e,this.opt=n,this.contents=r}return o.prototype.equals=function(a){return this.url===a.url&&this.filename===a.filename&&this.hash===a.hash&&this.size===a.size&&this.opt===a.opt&&this.contents===a.contents},o}();function FS(o,a){return(FS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var JI=-1,$I={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},US=["pvr","dxt","etc2","etc1","basis"],$=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r,s,l){var u;return s===void 0&&(s={}),l===void 0&&(l={}),(u=o.call(this)||this)._file=null,u._i18n={},u._preload=!1,u._resources=[],u.id=JI--,u.loaded=!1,u.loading=!1,u.options={},u.registry=null,u.tags=new Ls(u),u.urlObject=null,u._name=e||"",u.type=n,u._data=s||{},u.options=l||{},r&&(u.file=r),u}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&FS(a,o);var i,t=a.prototype;return t.getFileUrl=function(){var e=this.file;if(!e||!e.url)return null;var n=e.url;if(this.registry&&this.registry.prefix&&!Qr.test(n)&&(n=this.registry.prefix+n),this.type!=="script"&&e.hash){var r=n.indexOf("?")!==-1?"&":"?";n+=r+"t="+e.hash}return n},t.getAbsoluteUrl=function(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;var n=ce.getDirectory(this.file.url);return ce.join(n,e)},t.getLocalizedAssetId=function(e){return e=NS(e,this._i18n),this._i18n[e]||null},t.addLocalizedAssetId=function(e,n){this._i18n[e]=n,this.fire("add:localized",e,n)},t.removeLocalizedAssetId=function(e){var n=this._i18n[e];n&&(delete this._i18n[e],this.fire("remove:localized",e,n))},t.ready=function(e,n){n=n||this,this.loaded?e.call(n,this):this.once("load",function(r){e.call(n,r)})},t.reload=function(){this.loaded&&(this.loaded=!1,this.registry.load(this))},t.unload=function(){if(this.loaded||this._resources.length!==0){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var n=0;n<e.length;++n){var r=e[n];r&&r.destroy&&r.destroy()}}},a.fetchArrayBuffer=function(e,n,r,s){var l;s===void 0&&(s=0),!(r==null||(l=r.file)==null)&&l.contents?setTimeout(function(){n(null,r.file.contents)}):Fe.get(e,{cache:!0,responseType:"arraybuffer",retry:s>0,maxRetries:s},n)},i=[{key:"name",get:function(){return this._name},set:function(e){if(this._name!==e){var n=this._name;this._name=e,this.fire("name",this,this._name,n)}}},{key:"file",get:function(){return this._file},set:function(e){if(e&&e.variants&&["texture","textureatlas","bundle"].indexOf(this.type)!==-1){var n=((l=this.registry)==null||(s=l._loader)==null?void 0:s._app)||xt,r=n==null?void 0:n.graphicsDevice;if(r)for(var s,l,u,c=0,h=US.length;c<h&&(u=this,function(p,_){var g=US[p];if(e.variants[g]&&r[$I[g]])return e=e.variants[g],"break";if(n.enableBundles){var y=n.bundles.listBundlesForAsset(u);if(y&&y.find(function(v){var x;return v==null||(x=v.file)==null?void 0:x.variants[g]}))return"break"}}(c)!=="break");c++);}var f=this._file,d=e?new QI(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!d!=!!f||d&&!d.equals(f))&&(this._file=d,this.fire("change",this,"file",d,f),this.reload())}},{key:"data",get:function(){return this._data},set:function(e){var n=this._data;this._data=e,e!==n&&(this.fire("change",this,"data",e,n),this.loaded&&this.registry._loader.patch(this,this.registry))}},{key:"resource",get:function(){return this._resources[0]},set:function(e){var n=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,n)}},{key:"resources",get:function(){return this._resources},set:function(e){var n=this._resources;this._resources=e,this.fire("change",this,"resources",e,n)}},{key:"preload",get:function(){return this._preload},set:function(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}},{key:"loadFaces",get:function(){return this._loadFaces},set:function(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function BS(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function VS(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return BS(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return BS(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}$.EVENT_LOAD="load",$.EVENT_UNLOAD="unload",$.EVENT_REMOVE="remove",$.EVENT_ERROR="error",$.EVENT_CHANGE="change",$.EVENT_PROGRESS="progress",$.EVENT_ADDLOCALIZED="add:localized",$.EVENT_REMOVELOCALIZED="remove:localized";var eL=function(){function o(i){i===void 0&&(i=null),this._index={},this._key=i}var a=o.prototype;return a.addItem=function(i){for(var t,e=i.tags._list,n=VS(e);!(t=n()).done;){var r=t.value;this.add(r,i)}},a.removeItem=function(i){for(var t,e=i.tags._list,n=VS(e);!(t=n()).done;){var r=t.value;this.remove(r,i)}},a.add=function(i,t){(!this._index[i]||this._index[i].list.indexOf(t)===-1)&&(!this._index[i]&&(this._index[i]={list:[]},this._key&&(this._index[i].keys={})),this._index[i].list.push(t),this._key&&(this._index[i].keys[t[this._key]]=t))},a.remove=function(i,t){if(this._index[i]&&(!this._key||this._index[i].keys[t[this._key]])){var e=this._index[i].list.indexOf(t);e!==-1&&(this._index[i].list.splice(e,1),this._key&&delete this._index[i].keys[t[this._key]],this._index[i].list.length===0&&delete this._index[i])}},a.find=function(i){for(var t,e,n,r,s,l,u,c=this,h={},f=[],d=function(v,x){return c._index[v].list.length-c._index[x].list.length},p=0;p<i.length;p++){if(t=r=i[p],(e=Array)!=null&&typeof Symbol<"u"&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):Q(t,e)){if(r.length===0)continue;if(r.length===1)r=r[0];else{u=!1;for(var _=0;_<r.length;_++)if(!this._index[r[_]]){u=!0;break}if(u)continue;(l=(s=r.slice(0).sort(d)).slice(1)).length===1&&(l=l[0]);for(var g=0;g<this._index[s[0]].list.length;g++)n=this._index[s[0]].list[g],(this._key?!h[n[this._key]]:f.indexOf(n)===-1)&&n.tags.has(l)&&(this._key&&(h[n[this._key]]=!0),f.push(n));continue}}if(r&&typeof r=="string"&&this._index[r])for(var y=0;y<this._index[r].list.length;y++)n=this._index[r].list[y],this._key?h[n[this._key]]||(h[n[this._key]]=!0,f.push(n)):f.indexOf(n)===-1&&f.push(n)}return f},o}();function zS(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function GS(o,a){return(GS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Jr=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this)._assets=new Set,e._idToAsset=new Map,e._urlToAsset=new Map,e._nameToAsset=new Map,e._tags=new eL("id"),e.prefix=null,e.bundles=null,e._loader=t,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&GS(a,o);var i=a.prototype;return i.list=function(t){t===void 0&&(t={});var e=Array.from(this._assets);return t.preload!==void 0?e.filter(function(n){return n.preload===t.preload}):e},i.add=function(t){var e,n;!this._assets.has(t)&&(this._assets.add(t),this._idToAsset.set(t.id,t),(e=t.file)!=null&&e.url&&this._urlToAsset.set(t.file.url,t),this._nameToAsset.has(t.name)||this._nameToAsset.set(t.name,new Set),this._nameToAsset.get(t.name).add(t),t.on("name",this._onNameChange,this),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),(n=t.file)!=null&&n.url&&this.fire("add:url:"+t.file.url,t),t.preload&&this.load(t))},i.remove=function(t){var e,n;if(!this._assets.has(t))return!1;if(this._assets.delete(t),this._idToAsset.delete(t.id),(e=t.file)!=null&&e.url&&this._urlToAsset.delete(t.file.url),t.off("name",this._onNameChange,this),this._nameToAsset.has(t.name)){var r=this._nameToAsset.get(t.name);r.delete(t),r.size===0&&this._nameToAsset.delete(t.name)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),(n=t.file)!=null&&n.url&&this.fire("remove:url:"+t.file.url,t),!0},i.get=function(t){return this._idToAsset.get(Number(t))},i.getByUrl=function(t){return this._urlToAsset.get(t)},i.load=function(t,e){var n=this;if(!t.loading&&!t.loaded||e!=null&&e.force){var r=t.file,s=function(){n.fire("load",t),n.fire("load:"+t.id,t),r&&r.url&&n.fire("load:url:"+r.url,t),t.fire("load",t)},l=function(p){var _;if(((_=Array)!=null&&typeof Symbol<"u"&&_[Symbol.hasInstance]?_[Symbol.hasInstance](p):Q(p,_))?t.resources=p:t.resource=p,n._loader.patch(t,n),t.type==="bundle"){for(var g=t.data.assets,y=0;y<g.length;y++){var v=n._idToAsset.get(g[y]);v&&!v.loaded&&n.load(v,{force:!0})}t.resource.loaded?s():(n.fire("load:start",t),n.fire("load:start:"+t.id,t),r&&r.url&&n.fire("load:start:url:"+r.url,t),t.fire("load:start",t),t.resource.on("load",s))}else s()};if(r||t.type==="cubemap"){this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0;var u=t.getFileUrl();if(t.type==="bundle")for(var c=t.data.assets,h=0;h<c.length;h++){var f=this._idToAsset.get(c[h]);f&&(f.loaded||f.resource||f.loading||(f.loading=!0))}this._loader.load(u,t.type,function(p,_,g){if(t.loaded=!0,t.loading=!1,p)n.fire("error",p,t),n.fire("error:"+t.id,p,t),t.fire("error",p,t);else{if(t.type==="script"){var y=n._loader.getHandler("script");y._cache[t.id]&&y._cache[t.id].parentNode===document.head&&document.head.removeChild(y._cache[t.id]),y._cache[t.id]=g}l(_)}},t,e)}else{var d=this._loader.open(t.type,t.data);t.loaded=!0,l(d)}}},i.loadFromUrl=function(t,e,n){this.loadFromUrlAndFilename(t,null,e,n)},i.loadFromUrlAndFilename=function(t,e,n,r){var s=this,l=ce.getBasename(e||t),u=this.getByUrl(t);if(u){if(u.loaded)return void r(u.loadFromUrlError||null,u)}else u=new $(l,n,{filename:e||l,url:t}),this.add(u);var c=function(h){h.once("load",function(f){n==="material"?s._loadTextures(f,function(d,p){r(d,f)}):r(null,f)}),h.once("error",function(f){f&&(s.loadFromUrlError=f),r(f,h)}),s.load(h)};u.resource?r(null,u):n==="model"?this._loadModel(u,c):c(u)},i._loadModel=function(t,e){var n=this,r=t.getFileUrl(),s=ce.getExtension(r);if(s===".json"||s===".glb"){var l=ce.getDirectory(r),u=ce.getBasename(r),c=ce.join(l,u.replace(s,".mapping.json"));this._loader.load(c,"json",function(h,f){h?(t.data={mapping:[]},e(t)):n._loadMaterials(t,f,function(d,p){t.data=f,e(t)})})}else e(t)},i._loadMaterials=function(t,e,n){for(var r=this,s=[],l=0,u=function(d,p){r._loadTextures(p,function(_,g){s.push(p),s.length===l&&n(null,s)})},c=0;c<e.mapping.length;c++){var h=e.mapping[c].path;if(h){l++;var f=t.getAbsoluteUrl(h);this.loadFromUrl(f,"material",u)}}l===0&&n(null,s)},i._loadTextures=function(t,e){var n=[],r=0,s=t.data;if(s.mappingFormat!=="path")return void e(null,n);for(var l=function(f,d){n.push(d),n.length===r&&e(null,n)},u=0;u<fa.length;u++){var c=s[fa[u]];if(c&&typeof c=="string"){r++;var h=t.getAbsoluteUrl(c);this.loadFromUrl(h,"texture",l)}}r===0&&e(null,n)},i._onTagAdd=function(t,e){this._tags.add(t,e)},i._onTagRemove=function(t,e){this._tags.remove(t,e)},i._onNameChange=function(t,e,n){if(this._nameToAsset.has(n)){var r=this._nameToAsset.get(n);r.delete(t),r.size===0&&this._nameToAsset.delete(n)}this._nameToAsset.has(t.name)||this._nameToAsset.set(t.name,new Set),this._nameToAsset.get(t.name).add(t)},i.findByTag=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return this._tags.find(e)},i.filter=function(t){return Array.from(this._assets).filter(function(e){return t(e)})},i.find=function(t,e){var n=this._nameToAsset.get(t);if(!n)return null;for(var r,s=function(u,c){var h=typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(h)return(h=h.call(u)).next.bind(h);if(Array.isArray(u)||(h=function(d,p){if(d){if(typeof d=="string")return zS(d,void 0);var _=Object.prototype.toString.call(d).slice(8,-1);if(_==="Object"&&d.constructor&&(_=d.constructor.name),_==="Map"||_==="Set")return Array.from(_);if(_==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(_))return zS(d,void 0)}}(u))){h&&(u=h);var f=0;return function(){return f>=u.length?{done:!0}:{done:!1,value:u[f++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(n);!(r=s()).done;){var l=r.value;if(!e||l.type===e)return l}return null},i.findAll=function(t,e){var n=this._nameToAsset.get(t);if(!n)return[];var r=Array.from(n);return e?r.filter(function(s){return s.type===e}):r},a}(se);function HS(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Zo(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return HS(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return HS(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Jr.EVENT_LOAD="load",Jr.EVENT_ADD="add",Jr.EVENT_REMOVE="remove",Jr.EVENT_ERROR="error";var WS=function(){function o(i){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=i,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}var a=o.prototype;return a._onAssetAdd=function(i){if(i.type==="bundle"){this._idToBundle.set(i.id,i),this._assets.on("load:start:"+i.id,this._onBundleLoadStart,this),this._assets.on("load:"+i.id,this._onBundleLoad,this),this._assets.on("error:"+i.id,this._onBundleError,this);for(var t=i.data.assets,e=0;e<t.length;e++)this._indexAssetInBundle(t[e],i)}else this._assetToBundles.has(i.id)&&this._indexAssetFileUrls(i)},a._unbindAssetEvents=function(i){this._assets.off("load:start:"+i,this._onBundleLoadStart,this),this._assets.off("load:"+i,this._onBundleLoad,this),this._assets.off("error:"+i,this._onBundleError,this)},a._indexAssetInBundle=function(i,t){var e=this._assetToBundles.get(i);e||(e=new Set,this._assetToBundles.set(i,e)),e.add(t);var n=this._assets.get(i);n&&this._indexAssetFileUrls(n)},a._indexAssetFileUrls=function(i){var t=this._getAssetFileUrls(i);if(t)for(var e=0;e<t.length;e++){var n=this._assetToBundles.get(i.id);n&&this._urlsToBundles.set(t[e],n)}},a._getAssetFileUrls=function(i){var t=i.getFileUrl();if(!t)return null;var e=[t=t.split("?")[0]];if(i.type==="font")for(var n=i.data.info.maps.length,r=1;r<n;r++)e.push(t.replace(".png",""+r+".png"));return e},a._onAssetRemove=function(i){if(i.type==="bundle"){this._idToBundle.delete(i.id),this._unbindAssetEvents(i.id);for(var t=i.data.assets,e=0;e<t.length;e++){var n=this._assetToBundles.get(t[e]);if(n&&(n.delete(i),n.size===0)){this._assetToBundles.delete(t[e]);for(var r,s=Zo(this._urlsToBundles);!(r=s()).done;){var l=r.value,u=l[0];l[1]===n&&this._urlsToBundles.delete(u)}}}this._onBundleError("Bundle "+i.id+" was removed")}else{if(!this._assetToBundles.get(i.id))return;this._assetToBundles.delete(i.id);var c=this._getAssetFileUrls(i);if(!c)return;for(var h=0;h<c.length;h++)this._urlsToBundles.delete(c[h])}},a._onBundleLoadStart=function(i){var t=this;i.resource.on("add",function(e,n){var r=t._fileRequests.get(e);if(r){for(var s=0;s<r.length;s++)r[s](null,n);t._fileRequests.delete(e)}})},a._onBundleLoad=function(i){if(!i.resource)return void this._onBundleError("Bundle "+i.id+" failed to load");if(this._fileRequests)for(var t,e=Zo(this._fileRequests);!(t=e()).done;){var n=t.value,r=n[0],s=n[1],l=this._urlsToBundles.get(r);if(l&&l.has(i)){var u=decodeURIComponent(r),c=void 0,h=void 0;if(i.resource.has(u))h=i.resource.get(u);else{if(!i.resource.loaded)continue;c="Bundle "+i.id+" does not contain URL "+r}for(var f=0;f<s.length;f++)s[f](c,c||h);this._fileRequests.delete(r)}}},a._onBundleError=function(i){for(var t,e=Zo(this._fileRequests);!(t=e()).done;){var n=t.value,r=n[0],s=n[1];if(!this._findLoadedOrLoadingBundleForUrl(r)){for(var l=0;l<s.length;l++)s[l](i);this._fileRequests.delete(r)}}},a._findLoadedOrLoadingBundleForUrl=function(i){var t=this._urlsToBundles.get(i);if(!t)return null;for(var e,n=null,r=Zo(t);!(e=r()).done;){var s=e.value;if(s.loaded&&s.resource)return s;s.loading&&(n=s)}return n},a.listBundlesForAsset=function(i){var t=this._assetToBundles.get(i.id);return t?Array.from(t):null},a.list=function(){return Array.from(this._idToBundle.values())},a.hasUrl=function(i){return this._urlsToBundles.has(i)},a.urlIsLoadedOrLoading=function(i){return!!this._findLoadedOrLoadingBundleForUrl(i)},a.loadUrl=function(i,t){var e=this._findLoadedOrLoadingBundleForUrl(i);if(!e)return void t("URL "+i+" not found in any bundles");if(e.loaded){var n=decodeURIComponent(i);if(e.resource.has(n))return void t(null,e.resource.get(n));if(e.resource.loaded)return void t("Bundle "+e.id+" does not contain URL "+i)}var r=this._fileRequests.get(i);r||(r=[],this._fileRequests.set(i,r)),r.push(t)},a.destroy=function(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(var i,t=Zo(this._idToBundle.keys());!(i=t()).done;){var e=i.value;this._unbindAssetEvents(e)}this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null},o}();function jS(o,a){return(jS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var XS=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var t;return(t=o.call(this)||this).list=[],t}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&jS(a,o);var i=a.prototype;return i.add=function(t){var e=t.id;if(this[e])throw Error("ComponentSystem name '"+e+"' already registered or not allowed");this[e]=t,this.list.push(t)},i.remove=function(t){var e=t.id;if(!this[e])throw Error("No ComponentSystem named '"+e+"' registered");delete this[e];var n=this.list.indexOf(this[e]);n!==-1&&this.list.splice(n,1)},i.destroy=function(){this.off();for(var t=0;t<this.list.length;t++)this.list[t].destroy()},a}(se);function YS(o,a){return(YS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var nc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._index=new Map,e._loaded=!1,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&YS(a,o);var i,t=a.prototype;return t.addFile=function(e,n){this._index.has(e)||(this._index.set(e,n),this.fire("add",e,n))},t.has=function(e){return this._index.has(e)},t.get=function(e){return this._index.get(e)||null},t.destroy=function(){this._index.clear()},i=[{key:"loaded",get:function(){return this._loaded},set:function(e){e&&!this._loaded&&(this._loaded=!0,this.fire("load"))}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function qS(o,a){return(qS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}nc.EVENT_ADD="add",nc.EVENT_LOAD="load";var tL=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return e===void 0&&(e=""),(n=o.call(this)||this).headerSize=512,n.paddingSize=512,n.bytesRead=0,n.bytesReceived=0,n.headerRead=!1,n.reader=null,n.data=new Uint8Array(0),n.decoder=null,n.prefix="",n.fileName="",n.fileSize=0,n.fileType="",n.ustarFormat="",n.prefix=e||"",n.reader=t.body.getReader(),n.reader.read().then(function(r){n.pump(r.done,r.value)}).catch(function(r){n.fire("error",r)}),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&qS(a,o);var i=a.prototype;return i.pump=function(t,e){var n=this;if(t)return this.fire("done"),null;this.bytesReceived+=e.byteLength;var r=new Uint8Array(this.data.length+e.length);for(r.set(this.data),r.set(e,this.data.length),this.data=r;this.readFile(););return this.reader.read().then(function(s){n.pump(s.done,s.value)}).catch(function(s){n.fire("error",s)})},i.readFile=function(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;var t=new DataView(this.data.buffer,this.bytesRead,this.headerSize);this.decoder!=null||(this.decoder=new TextDecoder("windows-1252"));var e=this.decoder.decode(t);if(this.fileName=e.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(e.substring(124,136),8),this.fileType=e.substring(156,157),this.ustarFormat=e.substring(257,263),this.ustarFormat.indexOf("ustar")!==-1){var n=e.substring(345,500).replace(/\0/g,"");n.length>0&&(this.fileName=n.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(this.fileType===""||this.fileType==="0"){var r=new DataView(this.data.buffer,this.bytesRead,this.fileSize),s={name:this.prefix+this.fileName,size:this.fileSize,data:r};this.fire("file",s)}this.bytesRead+=this.fileSize,this.headerRead=!1;var l=this.bytesRead%this.paddingSize;return l!==0&&(this.bytesRead+=this.paddingSize-l),!0}return!1},a}(se),Oe=function(){function o(t,e){this.handlerType="",this._maxRetries=0,this._app=t,this.handlerType=e}var a,i=o.prototype;return i.load=function(t,e,n){},i.open=function(t,e,n){return e},i.patch=function(t,e){},a=[{key:"maxRetries",get:function(){return this._maxRetries},set:function(t){this._maxRetries=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function KS(o,a){return(KS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ZS=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"bundle")||this)._assets=t.assets,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&KS(a,o);var i=a.prototype;return i._fetchRetries=function(t,e,n){var r=this;return n===void 0&&(n=0),new Promise(function(s,l){var u=function(){fetch(t,e).then(s).catch(function(c){++n<r.maxRetries?u():l(c)})};u()})},i.load=function(t,e){var n=this;typeof t=="string"&&(t={load:t,original:t}),this._fetchRetries(t.load,{mode:"cors",credentials:"include"},this.maxRetries).then(function(r){var s=new nc;e(null,s);var l=new tL(r,n._assets.prefix);l.on("file",function(u){s.addFile(u.name,u.data)}),l.on("done",function(){s.loaded=!0}),l.on("error",function(u){e(u)})}).catch(function(r){e(r)})},i.open=function(t,e){return e},a}(Oe),Dd=function(){function o(i){this._handlers={},this._requests={},this._cache={},this._app=i}var a=o.prototype;return a.addHandler=function(i,t){this._handlers[i]=t,t._loader=this},a.removeHandler=function(i){delete this._handlers[i]},a.getHandler=function(i){return this._handlers[i]},a.load=function(i,t,e,n,r){var s=this._handlers[t];if(!s)return void e("No resource handler for asset type: '"+t+"' when loading ["+i+"]");if(!i)return void this._loadNull(s,e,n);var l=o.makeKey(i,t);if(this._cache[l]!==void 0)e(null,this._cache[l]);else if(this._requests[l])this._requests[l].push(e);else{this._requests[l]=[e];var u=this,c=function(_,g){if(_)return void u._onFailure(l,_);if(y=g.load,(v=DataView)!=null&&typeof Symbol<"u"&&v[Symbol.hasInstance]?!!v[Symbol.hasInstance](y):Q(y,v)){if(s.openBinary){if(!u._requests[l])return;try{var y,v,x=s.openBinary(g.load);u._onSuccess(l,x)}catch(S){u._onFailure(l,S)}return}g.load=URL.createObjectURL(new Blob([g.load])),n&&(n.urlObject&&URL.revokeObjectURL(n.urlObject),n.urlObject=g.load)}s.load(g,function(S,T,b){if(u._requests[l]){if(S)return void u._onFailure(l,S);try{u._onSuccess(l,s.open(g.original,T,n),b)}catch(w){u._onFailure(l,w)}}},n)},h=i.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(h)&&!(r&&r.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(h)){var f,d,p=this._app.bundles.listBundlesForAsset(n);r&&r.bundlesFilter&&(d=r.bundlesFilter(p)),d||(p==null||p.sort(function(_,g){return _.file.size-g.file.size}),d=p==null?void 0:p[0]),d&&((f=this._app.assets)==null||f.load(d))}this._app.bundles.loadUrl(h,function(_,g){c(_,{load:g,original:h})})}else c(null,{load:i,original:n&&n.file.filename||i})}},a._loadNull=function(i,t,e){i.load(null,function(n,r,s){if(n)t(n);else try{t(null,i.open(null,r,e),s)}catch(l){t(l)}},e)},a._onSuccess=function(i,t,e){t!==null?this._cache[i]=t:delete this._cache[i];for(var n=0;n<this._requests[i].length;n++)this._requests[i][n](null,t,e);delete this._requests[i]},a._onFailure=function(i,t){if(this._requests[i]){for(var e=0;e<this._requests[i].length;e++)this._requests[i][e](t);delete this._requests[i]}},a.open=function(i,t){var e=this._handlers[i];return e?e.open(null,t):t},a.patch=function(i,t){var e=this._handlers[i.type];e&&e.patch&&e.patch(i,t)},a.clearCache=function(i,t){var e=o.makeKey(i,t);delete this._cache[e]},a.getFromCache=function(i,t){var e=o.makeKey(i,t);if(this._cache[e])return this._cache[e]},a.enableRetry=function(i){for(var t in i===void 0&&(i=5),i=Math.max(0,i)||0,this._handlers)this._handlers[t].maxRetries=i},a.disableRetry=function(){for(var i in this._handlers)this._handlers[i].maxRetries=0},a.destroy=function(){this._handlers={},this._requests={},this._cache={}},o.makeKey=function(i,t){return i+"-"+t},o}(),nL=function(){function o(){}var a=o.prototype;return a._validate=function(i){if(!i.header)throw Error('pc.I18n#addData: Missing "header" field');if(!i.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(i.header.version!==1)throw Error('pc.I18n#addData: Invalid "header.version" field');if(i.data){if(!Array.isArray(i.data))throw Error('pc.I18n#addData: "data" field must be an array')}else throw Error('pc.I18n#addData: Missing "data" field');for(var t=0,e=i.data.length;t<e;t++){var n=i.data[t];if(!n.info)throw Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!n.info.locale)throw Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if(typeof n.info.locale!="string")throw Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!n.messages)throw Error('pc.I18n#addData: missing "data['+t+'].messages" field')}},a.parse=function(i){return i.data},o}();function QS(o,a){return(QS=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var $r=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this).locale=ec,n._translations={},n._availableLangs={},n._app=e,n._assets=[],n._parser=new nL,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&QS(a,o);var i,t=a.prototype;return t.findAvailableLocale=function(e){if(this._translations[e])return e;var n=Ni(e);return this._findFallbackLocale(e,n)},t.getText=function(e,n){var r,s=e;n||(n=this._locale,r=this._lang);var l=this._translations[n];return l||(r||(r=Ni(n)),n=this._findFallbackLocale(n,r),l=this._translations[n]),l&&l.hasOwnProperty(e)&&(Array.isArray(s=l[e])&&(s=s[0]),s==null&&(s=e)),s},t.getPluralText=function(e,n,r){var s,l,u=e;r?l=Ko[s=Ni(r)]||Ld:(r=this._locale,s=this._lang,l=this._pluralFn);var c=this._translations[r];if(c||(l=Ko[s=Ni(r=this._findFallbackLocale(r,s))]||Ld,c=this._translations[r]),c&&c[e]&&l){var h=l(n);(u=c[e][h])==null&&(u=e)}return u},t.addData=function(e){var n;try{n=this._parser.parse(e)}catch{return}for(var r=0,s=n.length;r<s;r++){var l=n[r],u=l.info.locale,c=l.messages;if(!this._translations[u]){this._translations[u]={};var h=Ni(u);this._availableLangs[h]||(this._availableLangs[h]=u)}Object.assign(this._translations[u],c),this.fire("data:add",u,c)}},t.removeData=function(e){var n;try{n=this._parser.parse(e)}catch{return}for(var r=0,s=n.length;r<s;r++){var l=n[r],u=l.info.locale,c=this._translations[u];if(c){var h=l.messages;for(var f in h)delete c[f];Object.keys(c).length===0&&(delete this._translations[u],delete this._availableLangs[Ni(u)]),this.fire("data:remove",u,h)}}},t.destroy=function(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()},t._findFallbackLocale=function(e,n){var r=tc[e];return r&&this._translations[r]||(r=tc[n])&&this._translations[r]||(r=this._availableLangs[n])&&this._translations[r]?r:ec},t._onAssetAdd=function(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)},t._onAssetLoad=function(e){this.addData(e.resource)},t._onAssetChange=function(e){e.resource&&this.addData(e.resource)},t._onAssetRemove=function(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)},t._onAssetUnload=function(e){e.resource&&this.removeData(e.resource)},a.findAvailableLocale=function(e,n){return NS(e,n)},i=[{key:"assets",get:function(){return this._assets},set:function(e){for(var n,r={},s=0,l=e.length;s<l;s++)r[n=e[s],($!=null&&typeof Symbol<"u"&&$[Symbol.hasInstance]?!!$[Symbol.hasInstance](n):Q(n,$))?e[s].id:e[s]]=!0;for(var u=this._assets.length;u--;){var c=this._assets[u];if(!r[c]){this._app.assets.off("add:"+c,this._onAssetAdd,this);var h=this._app.assets.get(c);h&&this._onAssetRemove(h),this._assets.splice(u,1)}}for(var f in r){var d=parseInt(f,10);if(this._assets.indexOf(d)===-1){this._assets.push(d);var p=this._app.assets.get(d);p?this._onAssetAdd(p):this._app.assets.once("add:"+d,this._onAssetAdd,this)}}}},{key:"locale",get:function(){return this._locale},set:function(e){if(this._locale!==e){var n,r,s,l=Ni(e);if(l!=="in"||(l="id",n=e,r=l,e=(s=n.indexOf("-"))!==-1?r+n.substring(s):r,this._locale!==e)){var u=this._locale;this._locale=e,this._lang=l,this._pluralFn=Ko[this._lang]||Ld,this.fire(a.EVENT_CHANGE,e,u)}}}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function JS(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function $S(o,a){return($S=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}$r.EVENT_CHANGE="change";var e0=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this)._scripts={},e._list=[],e._scriptSchemas=new Map,e.app=t,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&$S(a,o);var i=a.prototype;return i.destroy=function(){this.app=null,this.off()},i.addSchema=function(t,e){e&&this._scriptSchemas.set(t,e)},i.getSchema=function(t){return this._scriptSchemas.get(t)},i.add=function(t){var e=this,n=t.__name;return this._scripts.hasOwnProperty(n)?(setTimeout(function(){if(t.prototype.swap){var r=e._scripts[n],s=e._list.indexOf(r);e._list[s]=t,e._scripts[n]=t,e.fire("swap",n,t),e.fire("swap:"+n,t)}}),!1):(this._scripts[n]=t,this._list.push(t),this.fire("add",n,t),this.fire("add:"+n,t),setTimeout(function(){if(e._scripts.hasOwnProperty(n)&&e.app&&e.app.systems&&e.app.systems.script){var r=e.app.systems.script._components,s=[],l=[];for(r.loopIndex=0;r.loopIndex<r.length;r.loopIndex++){var u=r.items[r.loopIndex];if(u._scriptsIndex[n]&&u._scriptsIndex[n].awaiting){u._scriptsData&&u._scriptsData[n]&&(h=u._scriptsData[n].attributes);var c=u.create(n,{preloading:!0,ind:u._scriptsIndex[n].ind,attributes:h});c&&s.push(c);for(var h,f,d=function(y,v){var x=typeof Symbol<"u"&&y[Symbol.iterator]||y["@@iterator"];if(x)return(x=x.call(y)).next.bind(x);if(Array.isArray(y)||(x=function(T,b){if(T){if(typeof T=="string")return JS(T,void 0);var w=Object.prototype.toString.call(T).slice(8,-1);if(w==="Object"&&T.constructor&&(w=T.constructor.name),w==="Map"||w==="Set")return Array.from(w);if(w==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(w))return JS(T,void 0)}}(y))){x&&(y=x);var S=0;return function(){return S>=y.length?{done:!0}:{done:!1,value:y[S++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(u.scripts);!(f=d()).done;){var p=f.value;u.initializeAttributes(p)}}}for(var _=0;_<s.length;_++)s[_].enabled&&(s[_]._initialized=!0,l.push(s[_]),s[_].initialize&&s[_].initialize());for(var g=0;g<l.length;g++)l[g].enabled&&!l[g]._postInitialized&&(l[g]._postInitialized=!0,l[g].postInitialize&&l[g].postInitialize())}}),!0)},i.remove=function(t){var e=t,n=t;if(typeof n!="string"?n=e.__name:e=this.get(n),this.get(n)!==e)return!1;delete this._scripts[n];var r=this._list.indexOf(e);return this._list.splice(r,1),this.fire("remove",n,e),this.fire("remove:"+n,e),!0},i.get=function(t){return this._scripts[t]||null},i.has=function(t){if(typeof t=="string")return this._scripts.hasOwnProperty(t);if(!t)return!1;var e=t.__name;return this._scripts[e]===t},i.list=function(){return this._list},a}(se);function ic(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function t0(o,a){return(t0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var iL=function(o,a){return o.constructor.order-a.constructor.order},Qo=[],n0=[],rL=function(){var o;return(o=n0.pop())!=null?o:[]},i0=function(o){o.length=0,n0.push(o)},ve=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return e===void 0&&(e=xt),(n=o.call(this,t)||this).c={},n._destroying=!1,n._guid=null,n._template=!1,n._app=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&t0(a,o);var i=a.prototype;return i.addComponent=function(t,e){var n=this._app.systems[t];return!n||this.c[t]?null:n.addComponent(this,e)},i.removeComponent=function(t){var e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)},i.findComponent=function(t){var e=this.findOne(function(n){var r;return(r=n.c)==null?void 0:r[t]});return e&&e.c[t]},i.findComponents=function(t){return this.find(function(e){var n;return(n=e.c)==null?void 0:n[t]}).map(function(e){return e.c[t]})},i.findScript=function(t){var e=this.findOne(function(n){var r,s;return(s=n.c)==null||(r=s.script)==null?void 0:r.has(t)});return e==null?void 0:e.c.script.get(t)},i.findScripts=function(t){return this.find(function(e){var n,r;return(r=e.c)==null||(n=r.script)==null?void 0:n.has(t)}).map(function(e){return e.c.script.get(t)})},i.getGuid=function(){return this._guid||this.setGuid(Gm.create()),this._guid},i.setGuid=function(t){var e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this},i._notifyHierarchyStateChanged=function(t,e){var n=!1;t===this&&Qo.length===0&&(n=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&Qo.push(t);for(var r=t._children,s=0,l=r.length;s<l;s++)r[s]._enabled&&this._notifyHierarchyStateChanged(r[s],e);if(t._beingEnabled=!1,n){for(var u=0;u<Qo.length;u++)Qo[u]._onHierarchyStatePostChanged();Qo.length=0}},i._onHierarchyStateChanged=function(t){o.prototype._onHierarchyStateChanged.call(this,t);for(var e=this._getSortedComponents(),n=0;n<e.length;n++){var r=e[n];r.enabled&&(t?r.onEnable():r.onDisable())}i0(e)},i._onHierarchyStatePostChanged=function(){for(var t=this._getSortedComponents(),e=0;e<t.length;e++)t[e].onPostStateChange();i0(t)},i.findByGuid=function(t){if(this._guid===t)return this;var e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null},i.destroy=function(){for(var t in this._destroying=!0,this.c)this.c[t].enabled=!1;for(var e in this.c)this.c[e].system.removeComponent(this);o.prototype.destroy.call(this),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1},i.clone=function(){var t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,function n(r,s,l,u){if(ic(s,ve)){var c=s.c;for(var h in c)for(var f=c[h],d=f.system.getPropertiesOfType("entity"),p=0,_=d.length;p<_;p++){var g=d[p].name,y=f[g];if(r.findByGuid(y)){var v=u[y].getGuid();v&&(l.c[h][g]=v)}}c.script&&l.script.resolveDuplicatedEntityReferenceProperties(c.script,u),c.render&&l.render.resolveDuplicatedEntityReferenceProperties(c.render,u),c.button&&l.button.resolveDuplicatedEntityReferenceProperties(c.button,u),c.scrollview&&l.scrollview.resolveDuplicatedEntityReferenceProperties(c.scrollview,u),c.scrollbar&&l.scrollbar.resolveDuplicatedEntityReferenceProperties(c.scrollbar,u),c.anim&&l.anim.resolveDuplicatedEntityReferenceProperties(c.anim,u);for(var x=s.children.filter(function(w){return ic(w,ve)}),S=l.children.filter(function(w){return ic(w,ve)}),T=0,b=x.length;T<b;T++)n(r,x[T],S[T],u)}}(this,this,e,t),e},i._getSortedComponents=function(){var t=this.c,e=rL(),n=0;for(var r in t)if(t.hasOwnProperty(r)){var s=t[r];n|=s.constructor.order!==0,e.push(s)}return n&&e.length>1&&e.sort(iL),e},i._cloneRecursively=function(t){var e=new this.constructor(void 0,this._app);for(var n in o.prototype._cloneInternal.call(this,e),this.c)this.c[n].system.cloneComponent(this,e);for(var r=0;r<this._children.length;r++){var s=this._children[r];if(ic(s,a)){var l=s._cloneRecursively(t);e.addChild(l),t[s.getGuid()]=l}}return e},a}(pe);ve.EVENT_DESTROY="destroy";var Md=function(){var o;function a(i,t){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=i,this.url=t}return o=[{key:"loaded",get:function(){return!!this.data}},{key:"loading",get:function(){return this._loading}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),r0=function(){function o(i){this._list=[],this._index={},this._urlIndex={},this._app=i}var a=o.prototype;return a.destroy=function(){this._app=null},a.list=function(){return this._list},a.add=function(i,t){if(this._index.hasOwnProperty(i))return!1;var e=new Md(i,t),n=this._list.push(e);return this._index[e.name]=n-1,this._urlIndex[e.url]=n-1,!0},a.find=function(i){return this._index.hasOwnProperty(i)?this._list[this._index[i]]:null},a.findByUrl=function(i){return this._urlIndex.hasOwnProperty(i)?this._list[this._urlIndex[i]]:null},a.remove=function(i){if(this._index.hasOwnProperty(i)){var t=this._index[i],e=this._list[t];delete this._urlIndex[e.url],delete this._index[i],this._list.splice(t,1);for(var n=0;n<this._list.length;n++)e=this._list[n],this._index[e.name]=n,this._urlIndex[e.url]=n}},a._loadSceneData=function(i,t,e){var n=this._app,r=i;return typeof i=="string"&&(i=this.findByUrl(r)||this.find(r)||new Md("Untitled",r)),(r=i.url)?i.loaded?void e(null,i):(n.assets&&n.assets.prefix&&!Qr.test(r)&&(r=ce.join(n.assets.prefix,r)),i._onLoadedCallbacks.push(e),!i._loading&&n.loader.getHandler("hierarchy").load(r,function(s,l){i.data=l,i._loading=!1;for(var u=0;u<i._onLoadedCallbacks.length;u++)i._onLoadedCallbacks[u](s,i);t||(i.data=null),i._onLoadedCallbacks.length=0}),void(i._loading=!0)):void e("Cannot find scene to load")},a.loadSceneData=function(i,t){this._loadSceneData(i,!0,t)},a.unloadSceneData=function(i){typeof i=="string"&&(i=this.findByUrl(i)),i&&(i.data=null)},a._loadSceneHierarchy=function(i,t,e){var n=this;this._loadSceneData(i,!1,function(r,s){if(r){e&&e(r);return}t&&t(s);var l=n._app;l._preloadScripts(s.data,function(){var u=l.loader.getHandler("hierarchy");l.systems.script.preloading=!0;var c=u.open(s.url,s.data);l.systems.script.preloading=!1,l.loader.clearCache(s.url,"hierarchy"),l.root.addChild(c),l.systems.fire("initialize",c),l.systems.fire("postInitialize",c),l.systems.fire("postPostInitialize",c),e&&e(null,c)})})},a.loadSceneHierarchy=function(i,t){this._loadSceneHierarchy(i,null,t)},a.loadSceneSettings=function(i,t){var e=this;this._loadSceneData(i,!1,function(n,r){n?t&&t(n):(e._app.applySceneSettings(r.data.settings),t&&t(null))})},a.changeScene=function(i,t){var e=this._app;this._loadSceneHierarchy(i,function(n){for(var r=e.root.children;r.length;)r[0].destroy();e.applySceneSettings(n.data.settings)},t)},a.loadScene=function(i,t){var e=this,n=this._app,r=n.loader.getHandler("scene");n.assets&&n.assets.prefix&&!Qr.test(i)&&(i=ce.join(n.assets.prefix,i)),r.load(i,function(s,l){s?t&&t(s):n._preloadScripts(l,function(){n.systems.script.preloading=!0;var u=r.open(i,l),c=e.findByUrl(i);c&&!c.loaded&&(c.data=l),n.systems.script.preloading=!1,n.loader.clearCache(i,"scene"),n.loader.patch({resource:u,type:"scene"},n.assets),n.root.addChild(u.root),n.systems.rigidbody&&typeof Ammo<"u"&&n.systems.rigidbody.gravity.set(u._gravity.x,u._gravity.y,u._gravity.z),t&&t(null,u)})})},o}(),sL=function(){var o;function a(i){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=i._shaderStats,this.vram=i._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}return o=[{key:"scene",get:function(){return xt.scene._stats}},{key:"lightmapper",get:function(){var i;return(i=xt.lightmapper)==null?void 0:i.stats}},{key:"batcher",get:function(){var i=xt._batcher;return i?i._stats:null}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),aL={alphaTestPS:`
uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`,ambientPS:`
#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform vec3 ambientSH[9];
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
	#define ENV_ATLAS
		uniform sampler2D texture_envAtlas;
	#endif
#endif
void addAmbient(vec3 worldNormal) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		vec3 n = cubeMapRotate(worldNormal);
		vec3 color =
			ambientSH[0] +
			ambientSH[1] * n.x +
			ambientSH[2] * n.y +
			ambientSH[3] * n.z +
			ambientSH[4] * n.x * n.z +
			ambientSH[5] * n.z * n.y +
			ambientSH[6] * n.y * n.x +
			ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));
		vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		vec4 raw = texture2D(texture_envAtlas, uv);
		vec3 linear = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += light_globalAmbient;
	#endif
}
`,anisotropyPS:`
#ifdef LIT_GGX_SPECULAR
	uniform float material_anisotropyIntensity;
	uniform vec2 material_anisotropyRotation;
#endif
void getAnisotropy() {
	dAnisotropy = 0.0;
	dAnisotropyRotation = vec2(1.0, 0.0);
#ifdef LIT_GGX_SPECULAR
	dAnisotropy = material_anisotropyIntensity;
	dAnisotropyRotation = material_anisotropyRotation;
#endif
	#ifdef STD_ANISOTROPY_TEXTURE
	vec3 anisotropyTex = texture2DBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_UV}, textureBias).rgb;
	dAnisotropy *= anisotropyTex.b;
	vec2 anisotropyRotationFromTex = anisotropyTex.rg * 2.0 - vec2(1.0);
	mat2 rotationMatrix = mat2(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);
	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;
	#endif
	
	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);
}
`,aoPS:`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform float material_aoIntensity;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		float aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			float aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;
		#endif
		dAo *= aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, material_aoIntensity);
	#endif
}
`,aoDiffuseOccPS:`
void occludeDiffuse(float ao) {
	dDiffuseLight *= ao;
}
`,aoSpecOccPS:`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform float material_occludeSpecularIntensity;
	#endif
#endif
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);
		#else
			float specOcc = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		float specPow = exp2(gloss * 11.0);
		float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight *= specOcc;
		dReflection *= specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight *= specOcc;
			sReflection *= specOcc;
		#endif
	#endif
}
`,bakeDirLmEndPS:`
	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001 ? (1.0/255.0) : 0.0);
	}
`,bakeLmEndPS:`
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	dDiffuseLight = ((dDiffuseLight - 0.5) * max(ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;
	dDiffuseLight += vec3(ambientBakeOcclusionBrightness);
	dDiffuseLight = saturate(dDiffuseLight);
	dDiffuseLight *= dAmbientLight;
#endif
#ifdef LIGHTMAP_RGBM
	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
#else
	gl_FragColor = vec4(dDiffuseLight, 1.0);
#endif
`,basePS:`
uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`,baseNineSlicedPS:`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,baseNineSlicedTiledPS:`
#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,bayerPS:`
float bayer2(vec2 p) {
	return mod(2.0 * p.y + p.x + 1.0, 4.0);
}
float bayer4(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
float bayer8(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	vec2 p4 = floor(0.25 * mod(p, 8.0));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,blurVSMPS:`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
	uniform float weight[{SAMPLES}];
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float({SAMPLES}) * 0.5);
	for (int i = 0; i < {SAMPLES}; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef GAUSS
			moments += c.xyz * weight[i];
		#else
			moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
		moments *= 1.0 / float({SAMPLES});
	#endif
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
}
`,clearCoatPS:`
#ifdef STD_CLEARCOAT_CONSTANT
uniform float material_clearCoat;
#endif
void getClearCoat() {
	ccSpecularity = 1.0;
	#ifdef STD_CLEARCOAT_CONSTANT
	ccSpecularity *= material_clearCoat;
	#endif
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`,clearCoatGlossPS:`
#ifdef STD_CLEARCOATGLOSS_CONSTANT
uniform float material_clearCoatGloss;
#endif
void getClearCoatGlossiness() {
	ccGlossiness = 1.0;
	#ifdef STD_CLEARCOATGLOSS_CONSTANT
	ccGlossiness *= material_clearCoatGloss;
	#endif
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,clearCoatNormalPS:`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	vec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,clusteredLightCookiesPS:`
vec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);
	bool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;
	return isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);
}
vec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);
}
`,clusteredLightShadowsPS:`
vec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	return projPos.xyz;
}
vec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {
	vec3 wPos = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
vec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	float distScale = length(lightDir);
	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	vec3 dir = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return textureShadow(shadowMap, vec3(uv, shadowZ));
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
`,clusteredLightUtilsPS:`
vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`,clusteredLightPS:`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
uniform highp sampler2D clusterWorldTexture;
uniform highp sampler2D lightsTexture;
#ifdef CLUSTER_SHADOWS
	uniform sampler2DShadow shadowAtlasTexture;
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
uniform int clusterMaxCells;
uniform float clusterSkip;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec3 clusterTextureSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform vec3 clusterCellsDot;
uniform vec3 clusterCellsMax;
uniform vec2 shadowAtlasParams;
struct ClusterLightData {
	uint flags;
	vec3 halfWidth;
	bool isSpot;
	vec3 halfHeight;
	int lightIndex;
	vec3 position;
	uint shape;
	vec3 direction;
	bool falloffModeLinear;
	vec3 color;
	float shadowIntensity;
	vec3 omniAtlasViewport;
	float range;
	vec4 cookieChannelMask;
	float biasesData;
	float shadowBias;
	float shadowNormalBias;
	float anglesData;
	float innerConeAngleCos;
	float outerConeAngleCos;
	float cookieIntensity;
	bool isDynamic;
	bool isLightmapped;
};
mat4 lightProjectionMatrix;
vec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {
	return texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);
}
void decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {
	clusterLightData.lightIndex = int(lightIndex);
	vec4 halfData = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	vec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));
	vec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));
	clusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};
	vec4 lightPosRange = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_POSITION_RANGE});
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	vec4 lightDir_Flags = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_DIRECTION_FLAGS});
	clusterLightData.direction = lightDir_Flags.xyz;
	clusterLightData.flags = floatBitsToUint(lightDir_Flags.w);
	clusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;
	clusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	vec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));
	clusterLightData.innerConeAngleCos = angles.x;
	clusterLightData.outerConeAngleCos = angles.y;
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	
	vec4 m0 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0});
	vec4 m1 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_1});
	vec4 m2 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_2});
	vec4 m3 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_3});
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	
	vec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	uint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;
	clusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));
	clusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);
}
void evaluateLight(
	ClusterLightData light, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir,
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	vec3 cookieAttenuation = vec3(1.0);
	float diffuseAttenuation = 1.0;
	float falloffAttenuation = 1.0;
	vec3 lightDirW = evalOmniLight(light.position);
	vec3 lightDirNormW = normalize(lightDirW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear)
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		else
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); 
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						vec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					} else {
						vec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				float areaLightSpecular;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					float areaLightSpecularCC;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);
				#endif
				#endif
				dDiffuseLight += punctualDiffuse;
			}
   
			#ifdef LIT_SPECULAR
				vec3 halfDir = normalize(-lightDirNormW + viewDir);
				
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight += 
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * 
						getFresnel(
							dot(viewDir, halfDir), 
							gloss, 
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; 
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
void evaluateClusterLight(
	float lightIndex, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		bool acceptLightMask = clusterLightData.isDynamic;
	#else
		bool acceptLightMask = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask)
		evaluateLight(
			clusterLightData, 
			worldNormal, 
			viewDir, 
			reflectionDir, 
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir, 
#endif
			gloss, 
			specularity, 
			geometricNormal, 
			tbn, 
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
}
void addClusteredLights(
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	if (clusterSkip > 0.5)
		return;
	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);
	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		float cellIndex = dot(clusterCellsDot, cellCoords);
		float clusterV = floor(cellIndex * clusterTextureSize.y);
		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);
		for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {
			float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;
			if (lightIndex <= 0.0)
				break;
			evaluateClusterLight(
				lightIndex * 255.0, 
				worldNormal, 
				viewDir, 
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss, 
				specularity, 
				geometricNormal, 
				tbn, 
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			); 
		}
	}
}
`,combinePS:`
vec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {
	vec3 ret = vec3(0);
#ifdef LIT_OLD_AMBIENT
	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;
#else
	ret += albedo * dDiffuseLight;
#endif
#ifdef LIT_SPECULAR
	ret += dSpecularLight;
#endif
#ifdef LIT_REFLECTIONS
	ret += dReflection.rgb * dReflection.a;
#endif
#ifdef LIT_SHEEN
	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
#endif
#ifdef LIT_CLEARCOAT
	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;
	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;
#endif
	return ret;
}
`,cookieBlit2DPS:`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}
`,cookieBlitCubePS:`
	varying vec2 uv0;
	uniform samplerCube blitTexture;
	uniform mat4 invViewProj;
	void main(void) {
		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
		vec4 worldPos = invViewProj * projPos;
		gl_FragColor = textureCube(blitTexture, worldPos.xyz);
	}
`,cookieBlitVS:`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
		#ifndef WEBGPU
			uv0.y = 1.0 - uv0.y;
		#endif
	}
`,cookiePS:`
vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`,cubeMapProjectPS:`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform vec3 envBoxMin;
	uniform vec3 envBoxMax;
#endif
vec3 cubeMapProject(vec3 nrdir) {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		nrdir = cubeMapRotate(nrdir);
		vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
		vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
		vec3 rbminmax = mix(rbmin, rbmax, vec3(greaterThan(nrdir, vec3(0.0))));
		float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		vec3 posonbox = vPositionW + nrdir * fa;
		vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`,cubeMapRotatePS:`
#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,debugOutputPS:`
#ifdef DEBUG_ALBEDO_PASS
gl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
gl_FragColor = vec4(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
gl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
gl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
gl_FragColor = vec4(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
gl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
gl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
gl_FragColor = vec4(vec3(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,debugProcessFrontendPS:`
#ifdef DEBUG_LIGHTING_PASS
litArgs_albedo = vec3(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
litArgs_albedo = vec3(vUv0, 0);
#else
litArgs_albedo = vec3(0);
#endif
#endif
`,detailModesPS:`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
#endif
`,diffusePS:`
uniform vec3 material_diffuse;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAlbedo() {
	dAlbedo = material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		vec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			vec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo *= albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));
	#endif
}
`,decodePS:`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
float decodeGamma(float raw) {
	return pow(raw, 2.2);
}
vec3 decodeGamma(vec3 raw) {
	return pow(raw, vec3(2.2));
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBP(vec4 raw) {
	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
vec4 passThrough(vec4 raw) {
	return raw;
}
vec3 unpackNormalXYZ(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
vec3 unpackNormalXY(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));
	return normal;
}
#endif
`,emissivePS:`
uniform vec3 material_emissive;
uniform float material_emissiveIntensity;
void getEmission() {
	dEmission = material_emissive * material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));
	#endif
}
`,encodePS:`
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec4 encodeRGBP(vec3 source) {
	vec3 gamma = pow(source, vec3(0.5));
	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	float v = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4(gamma / (-v * 7.0 + 8.0), v);	
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,endPS:`
	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	gl_FragColor.rgb += litArgs_emission;
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
`,envAtlasPS:`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapShinyUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`,envProcPS:`
#ifdef LIT_SKYBOX_INTENSITY
	uniform float skyboxIntensity;
#endif
vec3 processEnvironment(vec3 color) {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * skyboxIntensity;
	#else
		return color;
	#endif
}
`,falloffInvSquaredPS:`
float getFalloffWindow(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float invRadius = 1.0 / lightRadius;
	return square(saturate(1.0 - square(sqrDist * square(invRadius))));
}
float getFalloffInvSquared(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square(saturate(1.0 - square(sqrDist * square(invRadius))));
	return falloff;
}
`,falloffLinearPS:`
float getFalloffLinear(float lightRadius, vec3 lightDir) {
	float d = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,floatAsUintPS:`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
vec4 float2uint(float value) {
	uint intBits = floatBitsToUint(value);
	return vec4(
		float((intBits >> 24u) & 0xFFu) / 255.0,
		float((intBits >> 16u) & 0xFFu) / 255.0,
		float((intBits >> 8u) & 0xFFu) / 255.0,
		float(intBits & 0xFFu) / 255.0
	);
}
float uint2float(vec4 value) {
	uint intBits = 
		(uint(value.r * 255.0) << 24u) |
		(uint(value.g * 255.0) << 16u) |
		(uint(value.b * 255.0) << 8u) |
		uint(value.a * 255.0);
	return uintBitsToFloat(intBits);
}
vec4 float2vec4(float value) {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`,fogPS:`
float dBlendModeFogFactor = 1.0;
#if (FOG != NONE)
	uniform vec3 fog_color;
	#if (FOG == LINEAR)
		uniform float fog_start;
		uniform float fog_end;
	#else
		uniform float fog_density;
	#endif
#endif
float getFogFactor() {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (fog_end - depth) / (fog_end - fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * fog_density * fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
vec3 addFog(vec3 color) {
	#if (FOG != NONE)
		return mix(fog_color * dBlendModeFogFactor, color, getFogFactor());
	#endif
	return color;
}
`,fresnelSchlickPS:`
vec3 getFresnel(
		float cosTheta, 
		float gloss, 
		vec3 specularity
#if defined(LIT_IRIDESCENCE)
		, vec3 iridescenceFresnel, 
		float iridescenceIntensity
#endif
	) {
	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);
	float glossSq = gloss * gloss;
	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;
#if defined(LIT_IRIDESCENCE)
	return mix(ret, iridescenceFresnel, iridescenceIntensity);
#else
	return ret;
#endif	
}
float getFresnelCC(float cosTheta) {
	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}
`,frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy * 0.5 + 0.5;
}
`,gammaPS:`
#include "decodePS"
#if (GAMMA == SRGB)
	float gammaCorrectInput(float color) {
		return decodeGamma(color);
	}
	vec3 gammaCorrectInput(vec3 color) {
		return decodeGamma(color);
	}
	vec4 gammaCorrectInput(vec4 color) {
		return vec4(decodeGamma(color.xyz), color.w);
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return pow(color + 0.0000001, vec3(1.0 / 2.2));
	}
#else
	float gammaCorrectInput(float color) {
		return color;
	}
	vec3 gammaCorrectInput(vec3 color) {
		return color;
	}
	vec4 gammaCorrectInput(vec4 color) {
		return color;
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return color;
	}
#endif
`,gles3PS:j_,gles3VS:X_,glossPS:`
#ifdef STD_GLOSS_CONSTANT
uniform float material_gloss;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness *= material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness += 0.0000001;
}
`,gsplatCenterVS:`
uniform mat4 matrix_model;
uniform mat4 matrix_view;
uniform mat4 matrix_projection;
bool initCenter(vec3 modelCenter, out SplatCenter center) {
	mat4 modelView = matrix_view * matrix_model;
	vec4 centerView = modelView * vec4(modelCenter, 1.0);
	if (centerView.z > 0.0) {
		return false;
	}
	vec4 centerProj = matrix_projection * centerView;
	#if WEBGPU
		centerProj.z = clamp(centerProj.z, 0, abs(centerProj.w));
	#else
		centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));
	#endif
	center.view = centerView.xyz / centerView.w;
	center.proj = centerProj;
	center.projMat00 = matrix_projection[0][0];
	center.modelView = modelView;
	return true;
}
`,gsplatCornerVS:`
uniform vec2 viewport;
uniform vec4 camera_params;
bool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {
	vec3 covA, covB;
	readCovariance(source, covA, covB);
	mat3 Vrk = mat3(
		covA.x, covA.y, covA.z, 
		covA.y, covB.x, covB.y,
		covA.z, covB.y, covB.z
	);
	float focal = viewport.x * center.projMat00;
	vec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;
	float J1 = focal / v.z;
	vec2 J2 = -J1 / v.z * v.xy;
	mat3 J = mat3(
		J1, 0.0, J2.x, 
		0.0, J1, J2.y, 
		0.0, 0.0, 0.0
	);
	mat3 W = transpose(mat3(center.modelView));
	mat3 T = W * J;
	mat3 cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		float detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];
		float detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];
		corner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));
	#endif
	float diagonal1 = cov[0][0] + 0.3;
	float offDiagonal = cov[0][1];
	float diagonal2 = cov[1][1] + 0.3;
	float mid = 0.5 * (diagonal1 + diagonal2);
	float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
	float lambda1 = mid + radius;
	float lambda2 = max(mid - radius, 0.1);
	float vmin = min(1024.0, min(viewport.x, viewport.y));
	float l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);
	float l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	vec2 c = center.proj.ww / viewport;
	if (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {
		return false;
	}
	vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
	vec2 v1 = l1 * diagonalVector;
	vec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);
	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;
	corner.uv = source.cornerUV;
	return true;
}
`,gsplatColorVS:`
uniform mediump sampler2D splatColor;
vec4 readColor(in SplatSource source) {
	return texelFetch(splatColor, source.uv, 0);
}
`,gsplatCommonVS:`
struct SplatSource {
	uint order;
	uint id;
	ivec2 uv;
	vec2 cornerUV;
};
struct SplatCenter {
	vec3 view;
	vec4 proj;
	mat4 modelView;
	float projMat00;
};
mat3 quatToMat3(vec4 R) {
	vec4 R2 = R + R;
	float X = R2.x * R.w;
	vec4 Y  = R2.y * R;
	vec4 Z  = R2.z * R;
	float W = R2.w * R.w;
	return mat3(
		1.0 - Z.z - W,
			  Y.z + X,
			  Y.w - Z.x,
			  Y.z - X,
		1.0 - Y.y - W,
			  Z.w + Y.x,
			  Y.w + Z.x,
			  Z.w - Y.x,
		1.0 - Y.y - Z.z
	);
}
struct SplatCorner {
	vec2 offset;
	vec2 uv;
	#if GSPLAT_AA
		float aaFactor;
	#endif
};
#if SH_BANDS == 1
	#define SH_COEFFS 3
#elif SH_BANDS == 2
	#define SH_COEFFS 8
#elif SH_BANDS == 3
	#define SH_COEFFS 15
#else
	#define SH_COEFFS 0
#endif
#if GSPLAT_COMPRESSED_DATA == true
	#include "gsplatCompressedDataVS"
	#if SH_COEFFS > 0
		#include "gsplatCompressedSHVS"
	#endif
#elif GSPLAT_SOGS_DATA == true
	#include "gsplatSogsDataVS"
	#include "gsplatSogsColorVS"
	#if SH_COEFFS > 0
		#include "gsplatSogsSHVS"
	#endif
#else
	#include "gsplatDataVS"
	#include "gsplatColorVS"
	#if SH_COEFFS > 0
		#include "gsplatSHVS"
	#endif
#endif
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
void clipCorner(inout SplatCorner corner, float alpha) {
	float clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);
	corner.offset *= clip;
	corner.uv *= clip;
}
#if SH_BANDS > 0
	#define SH_C1 0.4886025119029199f
	#if SH_BANDS > 1
		#define SH_C2_0 1.0925484305920792f
		#define SH_C2_1 -1.0925484305920792f
		#define SH_C2_2 0.31539156525252005f
		#define SH_C2_3 -1.0925484305920792f
		#define SH_C2_4 0.5462742152960396f
	#endif
	#if SH_BANDS > 2
		#define SH_C3_0 -0.5900435899266435f
		#define SH_C3_1 2.890611442640554f
		#define SH_C3_2 -0.4570457994644658f
		#define SH_C3_3 0.3731763325901154f
		#define SH_C3_4 -0.4570457994644658f
		#define SH_C3_5 1.445305721320277f
		#define SH_C3_6 -0.5900435899266435f
	#endif
	vec3 evalSH(in SplatSource source, in vec3 dir) {
		vec3 sh[SH_COEFFS];
		float scale;
		readSHData(source, sh, scale);
		float x = dir.x;
		float y = dir.y;
		float z = dir.z;
		vec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
		#if SH_BANDS > 1
			float xx = x * x;
			float yy = y * y;
			float zz = z * z;
			float xy = x * y;
			float yz = y * z;
			float xz = x * z;
			result +=
				sh[3] * (SH_C2_0 * xy) +
				sh[4] * (SH_C2_1 * yz) +
				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
				sh[6] * (SH_C2_3 * xz) +
				sh[7] * (SH_C2_4 * (xx - yy));
		#endif
		#if SH_BANDS > 2
			result +=
				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
				sh[9]  * (SH_C3_1 * xy * z) +
				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
				sh[13] * (SH_C3_5 * z * (xx - yy)) +
				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));
		#endif
		return result * scale;
	}
#endif
`,gsplatCompressedDataVS:`
uniform highp usampler2D packedTexture;
uniform highp sampler2D chunkTexture;
vec4 chunkDataA;
vec4 chunkDataB;
vec4 chunkDataC;
vec4 chunkDataD;
vec4 chunkDataE;
uvec4 packedData;
vec3 unpack111011(uint bits) {
	return vec3(
		float(bits >> 21u) / 2047.0,
		float((bits >> 11u) & 0x3ffu) / 1023.0,
		float(bits & 0x7ffu) / 2047.0
	);
}
vec4 unpack8888(uint bits) {
	return vec4(
		float(bits >> 24u) / 255.0,
		float((bits >> 16u) & 0xffu) / 255.0,
		float((bits >> 8u) & 0xffu) / 255.0,
		float(bits & 0xffu) / 255.0
	);
}
const float norm = 1.0 / (sqrt(2.0) * 0.5);
vec4 unpackRotation(uint bits) {
	float a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;
	float m = sqrt(1.0 - (a * a + b * b + c * c));
	uint mode = bits >> 30u;
	if (mode == 0u) return vec4(m, a, b, c);
	if (mode == 1u) return vec4(a, m, b, c);
	if (mode == 2u) return vec4(a, b, m, c);
	return vec4(a, b, c, m);
}
vec3 readCenter(SplatSource source) {
	uint w = uint(textureSize(chunkTexture, 0).x) / 5u;
	uint chunkId = source.id / 256u;
	ivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);
	chunkDataA = texelFetch(chunkTexture, chunkUV, 0);
	chunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);
	chunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);
	chunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);
	chunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);
	packedData = texelFetch(packedTexture, source.uv, 0);
	return mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
vec4 readColor(in SplatSource source) {
	vec4 r = unpack8888(packedData.w);
	return vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
vec4 getRotation() {
	return unpackRotation(packedData.y);
}
vec3 getScale() {
	return exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	mat3 rot = quatToMat3(getRotation());
	vec3 scale = getScale();
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,gsplatCompressedSHVS:`
#if SH_BANDS > 0
uniform highp usampler2D shTexture0;
uniform highp usampler2D shTexture1;
uniform highp usampler2D shTexture2;
vec4 unpack8888s(in uint bits) {
	return vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;
}
void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
	uvec4 shData0 = texelFetch(shTexture0, source.uv, 0);
	uvec4 shData1 = texelFetch(shTexture1, source.uv, 0);
	uvec4 shData2 = texelFetch(shTexture2, source.uv, 0);
	vec4 r0 = unpack8888s(shData0.x);
	vec4 r1 = unpack8888s(shData0.y);
	vec4 r2 = unpack8888s(shData0.z);
	vec4 r3 = unpack8888s(shData0.w);
	vec4 g0 = unpack8888s(shData1.x);
	vec4 g1 = unpack8888s(shData1.y);
	vec4 g2 = unpack8888s(shData1.z);
	vec4 g3 = unpack8888s(shData1.w);
	vec4 b0 = unpack8888s(shData2.x);
	vec4 b1 = unpack8888s(shData2.y);
	vec4 b2 = unpack8888s(shData2.z);
	vec4 b3 = unpack8888s(shData2.w);
	sh[0] =  vec3(r0.x, g0.x, b0.x);
	sh[1] =  vec3(r0.y, g0.y, b0.y);
	sh[2] =  vec3(r0.z, g0.z, b0.z);
	sh[3] =  vec3(r0.w, g0.w, b0.w);
	sh[4] =  vec3(r1.x, g1.x, b1.x);
	sh[5] =  vec3(r1.y, g1.y, b1.y);
	sh[6] =  vec3(r1.z, g1.z, b1.z);
	sh[7] =  vec3(r1.w, g1.w, b1.w);
	sh[8] =  vec3(r2.x, g2.x, b2.x);
	sh[9] =  vec3(r2.y, g2.y, b2.y);
	sh[10] = vec3(r2.z, g2.z, b2.z);
	sh[11] = vec3(r2.w, g2.w, b2.w);
	sh[12] = vec3(r3.x, g3.x, b3.x);
	sh[13] = vec3(r3.y, g3.y, b3.y);
	sh[14] = vec3(r3.z, g3.z, b3.z);
	scale = 1.0;
}
#endif
`,gsplatSogsColorVS:`
uniform mediump sampler2D sh0;
uniform vec4 sh0_mins;
uniform vec4 sh0_maxs;
float SH_C0 = 0.28209479177387814;
vec4 readColor(in SplatSource source) {
	vec4 clr = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));
	return vec4(vec3(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));
}
`,gsplatSogsDataVS:`
uniform highp sampler2D means_u;
uniform highp sampler2D means_l;
uniform highp sampler2D quats;
uniform highp sampler2D scales;
uniform vec3 means_mins;
uniform vec3 means_maxs;
uniform vec3 scales_mins;
uniform vec3 scales_maxs;
vec3 readCenter(SplatSource source) {
	vec3 u = texelFetch(means_u, source.uv, 0).xyz;
	vec3 l = texelFetch(means_l, source.uv, 0).xyz;
	vec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;
	vec3 v = mix(means_mins, means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
const float norm = 2.0 / sqrt(2.0);
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	vec4 qdata = texelFetch(quats, source.uv, 0);
	vec3 abc = (qdata.xyz - 0.5) * norm;
	float d = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	uint mode = uint(qdata.w * 255.0 + 0.5) - 252u;
	vec4 quat = (mode == 0u) ? vec4(d, abc) :
				((mode == 1u) ? vec4(abc.x, d, abc.yz) :
				((mode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));
	mat3 rot = quatToMat3(quat);
	vec3 scale = exp(mix(scales_mins, scales_maxs, texelFetch(scales, source.uv, 0).xyz));
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,gsplatSogsSHVS:`
uniform highp sampler2D sh_labels;
uniform highp sampler2D sh_centroids;
uniform float shN_mins;
uniform float shN_maxs;
void readSHData(in SplatSource source, out vec3 sh[SH_COEFFS], out float scale) {
	ivec2 t = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);
	int n = t.x + t.y * 256;
	int u = (n % 64) * SH_COEFFS;
	int v = n / 64;
	for (int i = 0; i < SH_COEFFS; i++) {
		sh[i] = mix(vec3(shN_mins), vec3(shN_maxs), texelFetch(sh_centroids, ivec2(u + i, v), 0).xyz);
	}
	scale = 1.0;
}
`,gsplatDataVS:`
uniform highp usampler2D transformA;
uniform highp sampler2D transformB;
uint tAw;
vec3 readCenter(SplatSource source) {
	uvec4 tA = texelFetch(transformA, source.uv, 0);
	tAw = tA.w;
	return uintBitsToFloat(tA.xyz);
}
vec4 unpackRotation(vec3 packed) {
	return vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	vec4 tB = texelFetch(transformB, source.uv, 0);
	mat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)).wxyz);
	vec3 scale = tB.xyz;
	
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,gsplatOutputVS:`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
vec3 prepareOutputFromGamma(vec3 gammaColor) {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma(gammaColor);
		#else
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));
	#endif
}
`,gsplatPS:`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying float id;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform float alphaClip;
#endif
#ifdef PREPASS_PASS
	varying float vLinearDepth;
	#include "floatAsUintPS"
#endif
const float  EXP_A	  = 12102203.0;
const int	EXP_BC_RMS = 1064866808;
float fastExp(float x) {
	int i = int(EXP_A * x) + EXP_BC_RMS;
	return intBitsToFloat(i);
}
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
void main(void) {
	mediump float A = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
	}
	mediump float alpha = fastExp(-A * 4.0) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < alphaClip) {
			discard;
		}
	#endif
	#ifdef PICK_PASS
		gl_FragColor = getPickOutput();
	#elif SHADOW_PASS
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#else
		if (alpha < 1.0 / 255.0) {
			discard;
		}
		#ifndef DITHER_NONE
			opacityDither(alpha, id * 0.013);
		#endif
		gl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);
	#endif
}
`,gsplatSHVS:`
#if SH_BANDS > 0
vec3 unpack111011s(uint bits) {
	return vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;
}
void fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {
	scale = uintBitsToFloat(t.x);
	a = unpack111011s(t.y);
	b = unpack111011s(t.z);
	c = unpack111011s(t.w);
}
void fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {
	a = unpack111011s(t.x);
	b = unpack111011s(t.y);
	c = unpack111011s(t.z);
	d = unpack111011s(t.w);
}
void fetch(in uint t, out vec3 a) {
	a = unpack111011s(t);
}
#if SH_BANDS == 1
	uniform highp usampler2D splatSH_1to3;
	void readSHData(in SplatSource source, out vec3 sh[3], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
	}
#elif SH_BANDS == 2
	uniform highp usampler2D splatSH_1to3;
	uniform highp usampler2D splatSH_4to7;
	uniform highp usampler2D splatSH_8to11;
	void readSHData(in SplatSource source, out vec3 sh[8], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);
		fetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);
	}
#else
	uniform highp usampler2D splatSH_1to3;
	uniform highp usampler2D splatSH_4to7;
	uniform highp usampler2D splatSH_8to11;
	uniform highp usampler2D splatSH_12to15;
	void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);
		fetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);
		fetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);
	}
#endif
#endif
`,gsplatSourceVS:`
attribute vec3 vertex_position;
attribute uint vertex_id_attrib;
uniform uint numSplats;
uniform highp usampler2D splatOrder;
bool initSource(out SplatSource source) {
	uint w = uint(textureSize(splatOrder, 0).x);
	source.order = vertex_id_attrib + uint(vertex_position.z);
	if (source.order >= numSplats) {
		return false;
	}
	ivec2 orderUV = ivec2(source.order % w, source.order / w);
	source.id = texelFetch(splatOrder, orderUV, 0).r;
	source.uv = ivec2(source.id % w, source.id / w);
	source.cornerUV = vertex_position.xy;
	return true;
}
`,gsplatVS:`
#include "gsplatCommonVS"
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
#ifndef DITHER_NONE
	varying float id;
#endif
mediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
void main(void) {
	SplatSource source;
	if (!initSource(source)) {
		gl_Position = discardVec;
		return;
	}
	vec3 modelCenter = readCenter(source);
	SplatCenter center;
	if (!initCenter(modelCenter, center)) {
		gl_Position = discardVec;
		return;
	}
	SplatCorner corner;
	if (!initCorner(source, center, corner)) {
		gl_Position = discardVec;
		return;
	}
	vec4 clr = readColor(source);
	#if GSPLAT_AA
		clr.a *= corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		vec3 dir = normalize(center.view * mat3(center.modelView));
		clr.xyz += evalSH(source, dir);
	#endif
	clipCorner(corner, clr.w);
	gl_Position = center.proj + vec4(corner.offset, 0, 0);
	gaussianUV = corner.uv;
	gaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);
	#ifndef DITHER_NONE
		id = float(source.id);
	#endif
	#ifdef PREPASS_PASS
		vLinearDepth = -center.view.z;
	#endif
}
`,quadVS:`
	attribute vec2 aPosition;
	varying vec2 uv0;
	void main(void)
	{
		gl_Position = vec4(aPosition, 0.0, 1.0);
		uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
	}
`,immediateLinePS:`
		#include "gammaPS"
		varying vec4 color;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);
		}
`,immediateLineVS:`
	attribute vec4 vertex_position;
	attribute vec4 vertex_color;
	uniform mat4 matrix_model;
	uniform mat4 matrix_viewProjection;
	varying vec4 color;
	void main(void) {
		color = vertex_color;
		gl_Position = matrix_viewProjection * matrix_model * vertex_position;
	}
`,iridescenceDiffractionPS:`
uniform float material_iridescenceRefractionIndex;
float iridescence_iorToFresnel(float transmittedIor, float incidentIor) {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
vec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {
	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));
}
vec3 iridescence_fresnelToIor(vec3 f0) {
	vec3 sqrtF0 = sqrt(f0);
	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
vec3 iridescence_sensitivity(float opd, vec3 shift) {
	float PI = 3.141592653589793;
	float phase = 2.0 * PI * opd * 1.0e-9;
	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);
	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz /= vec3(1.0685e-07);
	const mat3 XYZ_TO_REC709 = mat3(
		3.2404542, -0.9692660,  0.0556434,
	   -1.5371385,  1.8760108, -0.2040259,
	   -0.4985314,  0.0415560,  1.0572252
	);
	return XYZ_TO_REC709 * xyz;
}
float iridescence_fresnel(float cosTheta, float f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
} 
vec3 iridescence_fresnel(float cosTheta, vec3 f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2; 
	return f0 + (vec3(1.0) - f0) * x5;
}
vec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {
	float PI = 3.141592653589793;
	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	float cosTheta2Sq = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3(1.0);
	}
	float cosTheta2 = sqrt(cosTheta2Sq);
	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);
	float r12 = iridescence_fresnel(cosTheta, r0);
	float r21 = r12;
	float t121 = 1.0 - r12;
	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;
	float phi21 = PI - phi12;
	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));
	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);
	vec3 r23 = iridescence_fresnel(cosTheta2, r1);
	vec3 phi23 = vec3(0.0);
	if (baseIor[0] < iridescenceIor) phi23[0] = PI;
	if (baseIor[1] < iridescenceIor) phi23[1] = PI;
	if (baseIor[2] < iridescenceIor) phi23[2] = PI;
	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	vec3 phi = vec3(phi21) + phi23; 
	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);
	vec3 r123 = sqrt(r123Sq);
	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);
	vec3 c0 = r12 + rs;
	vec3 i = c0;
	vec3 cm = rs - t121;
	for (int m = 1; m <= 2; m++) {
		cm *= r123;
		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);
		i += cm * sm;
	}
	return max(i, vec3(0.0));
}
vec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,iridescencePS:`
#ifdef STD_IRIDESCENCE_CONSTANT
uniform float material_iridescence;
#endif
void getIridescence() {
	float iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence *= material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`,iridescenceThicknessPS:`
uniform float material_iridescenceThicknessMax;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
uniform float material_iridescenceThicknessMin;
#endif
void getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		float blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);
	#else
		float iridescenceThickness = material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,iorPS:`
#ifdef STD_IOR_CONSTANT
uniform float material_refractionIndex;
#endif
void getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,lightDeclarationPS:`
#if defined(LIGHT{i})
	uniform vec3 light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform vec3 light{i}_direction;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform vec3 light{i}_position;
		uniform float light{i}_radius;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform vec3 light{i}_direction;
			uniform float light{i}_innerConeAngle;
			uniform float light{i}_outerConeAngle;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform vec3 light{i}_position;
		#endif
		uniform vec3 light{i}_halfWidth;
		uniform vec3 light{i}_halfHeight;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		uniform mat4 light{i}_shadowMatrix;
		uniform float light{i}_shadowIntensity;
		uniform vec4 light{i}_shadowParams;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform float light{i}_shadowSearchArea;
			uniform vec4 light{i}_cameraParams;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform vec4 light{i}_softShadowParams;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform mat4 light{i}_shadowMatrixPalette[4];
			uniform vec4 light{i}_shadowCascadeDistances;
			uniform int light{i}_shadowCascadeCount;
			uniform float light{i}_shadowCascadeBlend;
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform samplerCubeShadow light{i}_shadowMap;
			#else
				uniform samplerCube light{i}_shadowMap;
			#endif
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform sampler2DShadow light{i}_shadowMap;
			#else
				uniform sampler2D light{i}_shadowMap;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			uniform samplerCube light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			uniform sampler2D light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
			#if defined(LIGHT{i}COOKIE_TRANSFORM)
				uniform vec4 light{i}_cookieMatrix;
				uniform vec2 light{i}_cookieOffset;
			#endif
		#endif
	#endif
#endif
`,lightDiffuseLambertPS:`
float getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,lightDirPointPS:`
vec3 evalOmniLight(vec3 lightPosW) {
	return vPositionW - lightPosW;
}
`,lightEvaluationPS:`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`,lightFunctionLightPS:`
#if defined(LIGHT{i})
void evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		vec3 iridescenceFresnel
	#endif
) {
	vec3 lightColor = light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(equal(lightColor, vec3(0.0)))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = light{i}_direction;
		dAtten = 1.0;
	#else
		
		vec3 lightDirW = evalOmniLight(light{i}_position);
		dLightDirNormW = normalize(lightDirW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				vec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor *= cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			float attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				float attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				float attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				float attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			float shadow = getShadow{i}(vec3(0.0));
		#else
			float shadow = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, light{i}_shadowIntensity);
		dAtten *= shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher *= shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);
		#else
			dDiffuseLight += (attenDiffuse * dAtten) * lightColor;
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);
		#else
			dDiffuseLight += dAtten * lightColor;
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				vec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				vec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight += lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;
			#endif
			#ifdef LIT_SPECULAR
				vec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular *= litArgs_specularity;
				#endif
				
				dSpecularLight += lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`,lightFunctionShadowPS:`
#ifdef LIGHT{i}CASTSHADOW
	vec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
		vec3 surfacePosition = worldPosition;
		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				float distScale = length(lightDir);
				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				lightDir = surfacePosition - lightPos;
				return lightDir;
			#endif
		#else
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						float distScale = 1.0;
					#else
						float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz /= positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy /= positionInShadowSpace.w;
					positionInShadowSpace.z = length(lightDir) * shadowParams.w;
				#endif
			#endif
			#ifdef SHADOW_SAMPLE_Z_BIAS
			#endif
			surfacePosition = positionInShadowSpace.xyz;
		#endif
		return surfacePosition;
	}
	float getShadow{i}(vec3 lightDirW) {
		#ifdef LIGHT{i}_SHADOW_CASCADES
			int cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);
			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);
			#endif
			mat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];
		#else
			mat4 shadowMatrix = light{i}_shadowMatrix;
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);
		#else
			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
				#else
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
		#endif
	}
#endif
`,lightingPS:`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	uniform highp sampler2D areaLightsLutTex1;
	uniform highp sampler2D areaLightsLutTex2;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowPCSSPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`,lightmapAddPS:`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight += lightmap;
		} else {
			float vlight = saturate(dot(dir, -vertexNormal));
			float flight = saturate(dot(dir, -worldNormal));
			float nlight = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight += lightmap * nlight * 2.0;
			vec3 halfDir = normalize(-dir + viewDir);
			vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight *= 
					getFresnel(dot(viewDir, halfDir), 
					gloss, 
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight += specularLight;
		}
	#else
		dDiffuseLight += lightmap;
	#endif
}
`,lightmapPS:`
#ifdef STD_LIGHTMAP_DIR
	vec3 dLightmapDir;
	uniform sampler2D texture_dirLightMap;
#endif
void getLightMap() {
	dLightmap = vec3(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			vec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;
			float dirDot = dot(dir, dir);
			dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`,lightSpecularAnisoGGXPS:`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float alphaRoughness = roughness * roughness;
	float anisotropy = dAnisotropy;
	vec2 direction = dAnisotropyRotation;
	float at = mix(alphaRoughness, 1.0, anisotropy * anisotropy);
	float ab = clamp(alphaRoughness, 0.001, 1.0);
	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));
	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));
	float NoH = dot(worldNormal, h);
	float ToH = dot(anisotropicT, h);
	float BoH = dot(anisotropicB, h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(anisotropicT, viewDir);
	float BoV = dot(anisotropicB, viewDir);
	float ToL = dot(anisotropicT, -lightDirNorm);
	float BoL = dot(anisotropicB, -lightDirNorm);
	float NoV = dot(worldNormal, viewDir);
	float NoL = dot(worldNormal, -lightDirNorm);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,lightSpecularBlinnPS:`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {
	float nh = max( dot( h, worldNormal ), 0.0 );
	float specPow = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,lightSheenPS:`
float sheenD(vec3 normal, vec3 h, float roughness) {
	const float PI = 3.141592653589793;
	float invR = 1.0 / (roughness * roughness);
	float cos2h = max(dot(normal, h), 0.0);
	cos2h *= cos2h;
	float sin2h = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
float sheenV(vec3 normal, vec3 viewDir, vec3 light) {
	float NoV = max(dot(normal, viewDir), 0.000001);
	float NoL = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
float getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {
	float D = sheenD(worldNormal, h, sheenGloss);
	float V = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}
`,linearizeDepthPS:`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
float linearizeDepthWithParams(float z, vec4 cameraParams) {
	if (cameraParams.w == 0.0)
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	else
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
}
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
float linearizeDepth(float z) {
	return linearizeDepthWithParams(z, camera_params);
}
#endif
`,litForwardBackendPS:`
void evaluateBackend() {
	#ifdef LIT_SSAO
		litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			float f0 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 *= f0;
			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			vec3 dAmbientLight = dDiffuseLight;
			dDiffuseLight = vec3(0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight *= material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection *= ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection *= litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection.rgb *= getFresnel(
					dot(dViewDirW, litArgs_worldNormal), 
					litArgs_gloss, 
					litArgs_specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					litArgs_iridescence_intensity
				#endif
					);
			#else
				dReflection.rgb *= litArgs_specularity;
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				dReflection.rgb *= litArgs_specularityFactor;
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight *= litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#ifdef LIGHT_COUNT > 0
			#include "lightEvaluationPS, LIGHT_COUNT"
		#endif
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#ifdef LIT_SPECULARITY_FACTOR
		dSpecularLight *= litArgs_specularityFactor;
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity *= material_alphaFade;
	#endif
	#ifdef LIT_LIGHTMAP_BAKING
		#ifdef LIT_LIGHTMAP_BAKING_COLOR
			#include "bakeLmEndPS"
		#endif
		#ifdef LIT_LIGHTMAP_BAKING_DIR
			#include "bakeDirLmEndPS"
		#endif
	#else
		#include "endPS"
		#include "outputAlphaPS"
	#endif
	#ifdef LIT_MSDF
		gl_FragColor = applyMsdf(gl_FragColor);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		gl_FragColor.rgb = vec3(dShadowCatcher);
	#endif
}
`,litForwardDeclarationPS:`
vec3 sReflection;
vec3 dVertexNormalW;
vec3 dTangentW;
vec3 dBinormalW;
vec3 dViewDirW;
vec3 dReflDirW;
vec3 ccReflDirW;
vec3 dLightDirNormW;
float dAtten;
mat3 dTBN;
vec4 dReflection;
vec3 dDiffuseLight;
vec3 dSpecularLight;
float ccFresnel;
vec3 ccReflection;
vec3 ccSpecularLight;
float ccSpecularityNoFres;
vec3 sSpecularLight;
#ifdef LIT_DISPERSION
	uniform float material_dispersion;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform float material_alphaFade;
#endif
#ifdef LIT_SSAO
	uniform sampler2D ssaoTexture;
	uniform vec2 ssaoTextureSizeInv;
#endif
#ifdef LIT_SHADOW_CATCHER
	float dShadowCatcher = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
#ifdef STD_LIGHTMAP_DIR
	uniform float bakeDir;
#endif
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	uniform float ambientBakeOcclusionContrast;
	uniform float ambientBakeOcclusionBrightness;
#endif
`,litForwardMainPS:`
void main(void) {
	#include "litUserMainStartPS"
	dReflection = vec4(0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3(0);
		ccReflection = vec3(0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	evaluateBackend();
	#include "litUserMainEndPS"
}
`,litForwardPostCodePS:`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
uniform vec3 material_ambient;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#include "lightSpecularAnisoGGXPS"
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_GGX_SPECULAR
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`,litForwardPreCodePS:`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`,litMainPS:`
#include "varyingsPS"
#include "litUserDeclarationPS"
#include "frontendDeclPS"
#if defined(PICK_PASS) || defined(PREPASS_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litOtherMainPS"
#elif defined(SHADOW_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litShadowMainPS"
#else
	#include "litForwardDeclarationPS"
	#include "litForwardPreCodePS"
	#include "frontendCodePS"
	#include "litForwardPostCodePS"
	#include "litForwardBackendPS"
	#include "litUserCodePS"
	#include "litForwardMainPS"
#endif
`,litMainVS:`
#include "varyingsVS"
#include  "litUserDeclarationVS"
#ifdef VERTEX_COLOR
	attribute vec4 vertex_color;
#endif
#ifdef NINESLICED
	varying vec2 vMask;
	varying vec2 vTiledUv;
	uniform mediump vec4 innerOffset;
	uniform mediump vec2 outerScale;
	uniform mediump vec4 atlasRect;
#endif
vec3 dPositionW;
mat4 dModelMatrix;
#include "transformCoreVS"
#ifdef UV0
	attribute vec2 vertex_texCoord0;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vec2 vertex_texCoord1;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform mat4 matrix_view;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vec4 vertex_tangent;
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
#include  "litUserCodeVS"
void main(void) {
	#include "litUserMainStartVS"
	gl_PointSize = 1.0;
	gl_Position = getPosition();
	vPositionW = getWorldPosition();
	#ifdef NORMALS
		vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);
		vBinormalW = cross(vNormalW, vTangentW) * vertex_tangent.w;
	#elif defined(GGX_SPECULAR)
		vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));
	#endif
	#ifdef UV0
		vec2 uv0 = getUv0();
		#ifdef UV0_UNMODIFIED
			vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		vec2 uv1 = getUv1();
		#ifdef UV1_UNMODIFIED
			vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		vVertexColor = vertex_color;
	#endif
	#ifdef LINEAR_DEPTH
		vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
	#endif
	#include "litUserMainEndVS"
}
`,litOtherMainPS:`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
void main(void) {
	#include "litUserMainStartPS"
	evaluateFrontend();
	#ifdef PICK_PASS
		gl_FragColor = getPickOutput();
	#endif
	#ifdef PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#endif
	#include "litUserMainEndPS"
}
`,litShaderArgsPS:`
vec3 litArgs_albedo;
float litArgs_opacity;
vec3 litArgs_emission;
vec3 litArgs_worldNormal;
float litArgs_ao;
vec3 litArgs_lightmap;
vec3 litArgs_lightmapDir;
float litArgs_metalness;
vec3 litArgs_specularity;
float litArgs_specularityFactor;
float litArgs_gloss;
float litArgs_sheen_gloss;
vec3 litArgs_sheen_specularity;
float litArgs_transmission;
float litArgs_thickness;
float litArgs_ior;
float litArgs_dispersion;
float litArgs_iridescence_intensity;
float litArgs_iridescence_thickness;
vec3 litArgs_clearcoat_worldNormal;
float litArgs_clearcoat_specularity;
float litArgs_clearcoat_gloss;
`,litShaderCorePS:`
	#if LIT_NONE_SLICE_MODE == TILED
		const float textureBias = -1000.0;
	#else
		uniform float textureBias;
	#endif
	#include "litShaderArgsPS"
`,litShadowMainPS:`
#if LIGHT_TYPE != DIRECTIONAL
	uniform vec3 view_position;
	uniform float light_radius;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
void main(void) {
	#include "litUserMainStartPS"
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		float depth = gl_FragCoord.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepthWithParams(depth, camera_params);
			#endif
		#endif
	#else
		float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			float exponent = 15.0;
		#else
			float exponent = 5.54;
		#endif
		depth = 2.0 * depth - 1.0;
		depth =  exp(exponent * depth);
		gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			gl_FragColor.r = depth;
		#else
			#ifdef MODIFIED_DEPTH
				gl_FragDepth = depth;
			#endif
			gl_FragColor = vec4(1.0);
		#endif
	#endif
	#include "litUserMainEndPS"
}
`,litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:`
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =  factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef LIT_CLEARCOAT
	vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)
{
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
vec3 dLTCSpecFres;
#ifdef LIT_CLEARCOAT
	vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)
{
	vec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);
	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;
}
void calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)
{
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); 
#ifdef LIT_CLEARCOAT
	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =  xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =  xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1 = normalize(V - N * dot(V, N));
	vec3 T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 C  = 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C  = Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = normalize(cross(V1, V2));
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L  = dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;
	return formFactor*scale;
}
float FixNan(float value) {
	#ifdef WEBGPU
		return value != value ? 0.0 : value;
	#else
		return isnan(value) ? 0.0 : value;
	#endif
}
float getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));
}
float getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
float calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
float getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,metalnessPS:`
#ifdef STD_METALNESS_CONSTANT
uniform float material_metalness;
#endif
void getMetalness() {
	float metalness = 1.0;
	#ifdef STD_METALNESS_CONSTANT
	metalness *= material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
	metalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`,metalnessModulatePS:`
vec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {
	vec3 dielectricF0 = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
vec3 getAlbedoModulate(in vec3 albedo, in float metalness) {
	return albedo * (1.0 - metalness);
}
`,morphPS:`
	varying vec2 uv0;
	uniform sampler2DArray morphTexture;
	uniform highp float morphFactor[{MORPH_TEXTURE_MAX_COUNT}];
	uniform highp uint morphIndex[{MORPH_TEXTURE_MAX_COUNT}];
	uniform int count;
	#ifdef MORPH_INT
		uniform vec3 aabbSize;
		uniform vec3 aabbMin;
	#endif
	void main (void) {
		highp vec3 color = vec3(0, 0, 0);
		for (int i = 0; i < count; i++) {
			uint textureIndex = morphIndex[i];
			vec3 delta = texture(morphTexture, vec3(uv0, textureIndex)).xyz;
			color += morphFactor[i] * delta;
		}
		#ifdef MORPH_INT
			color = (color - aabbMin) / aabbSize * 65535.0;
			gl_FragColor = uvec4(color, 1u);
		#else
			gl_FragColor = vec4(color, 1.0);
		#endif
	}
`,morphVS:`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}
`,msdfPS:`
uniform sampler2D texture_msdfMap;
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform vec4 outline_color;
	uniform float outline_thickness;
	uniform vec4 shadow_color;
	uniform vec2 shadow_offset;
#else
	varying vec4 outline_color;
	varying float outline_thickness;
	varying vec4 shadow_color;
	varying vec2 shadow_offset;
#endif
vec4 applyMsdf(vec4 color) {
	color.rgb = gammaCorrectInput(color.rgb);
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	tcolor.rgb = gammaCorrectOutput(tcolor.rgb);
	
	return tcolor;
}
`,msdfVS:`
attribute vec3 vertex_outlineParameters;
attribute vec3 vertex_shadowParameters;
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
void unpackMsdfParams() {
	vec3 little = mod(vertex_outlineParameters, 256.);
	vec3 big = (vertex_outlineParameters - little) / 256.;
	outline_color.rb = little.xy / 255.;
	outline_color.ga = big.xy / 255.;
	outline_thickness = little.z / 255. * 0.2;
	little = mod(vertex_shadowParameters, 256.);
	big = (vertex_shadowParameters - little) / 256.;
	shadow_color.rb = little.xy / 255.;
	shadow_color.ga = big.xy / 255.;
	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;
}
`,normalVS:`
mat3 dNormalMatrix;
vec3 getNormal() {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	vec3 localNormal = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}
`,normalCoreVS:`
attribute vec3 vertex_normal;
uniform mat3 matrix_normal;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		uniform highp usampler2D morphNormalTex;
	#else
		uniform highp sampler2D morphNormalTex;
	#endif
#endif
vec3 getLocalNormal(vec3 vertexNormal) {
	vec3 localNormal = vertex_normal;
	#ifdef MORPHING_NORMAL
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;
		#else
			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;
		#endif
		localNormal += morphNormal;
	#endif
	return localNormal;
}
#if defined(SKIN) || defined(BATCH)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return matrix_normal;
	}
#endif
`,normalMapPS:`
#ifdef STD_NORMAL_TEXTURE
	uniform float material_bumpiness;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
	uniform float material_normalDetailMapBumpiness;
	vec3 blendNormals(vec3 n1, vec3 n2) {
		n1 += vec3(0, 0, 1);
		n2 *= vec3(-1, -1, 1);
		return n1 * dot(n1, n2) / n1.z - n2;
	}
#endif
void getNormal() {
#ifdef STD_NORMAL_TEXTURE
	vec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		vec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));
		normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`,opacityPS:`
uniform float material_opacity;
void getOpacity() {
	dAlpha = material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`,opacityDitherPS:`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform vec4 blueNoiseJitter;
#if STD_OPACITY_DITHER == BLUENOISE
	uniform sampler2D blueNoiseTex32;
#endif
void opacityDither(float alpha, float id) {
	#if STD_OPACITY_DITHER == BAYER8
		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);
			float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
			float noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise)
		discard;
}
`,outputPS:`
`,outputAlphaPS:`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	gl_FragColor.a = litArgs_opacity;
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	gl_FragColor.rgb *= litArgs_opacity;
	gl_FragColor.a = litArgs_opacity;
#else
	gl_FragColor.a = 1.0;
#endif
`,outputTex2DPS:`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,sheenPS:`
uniform vec3 material_sheen;
void getSheen() {
	vec3 sheenColor = material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`,sheenGlossPS:`
uniform float material_sheenGloss;
void getSheenGlossiness() {
	float sheenGlossiness = material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`,parallaxPS:`
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale * 0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,pickPS:`
uniform uint meshInstanceId;
vec4 getPickOutput() {
	const vec4 inv = vec4(1.0 / 255.0);
	const uvec4 shifts = uvec4(16, 8, 0, 24);
	uvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);
	return vec4(col) * inv;
}
`,reflDirPS:`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,reflDirAnisoPS:`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	float roughness = sqrt(1.0 - min(gloss, 1.0));
	vec2 direction = dAnisotropyRotation;
	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));
	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));
	float anisotropy = dAnisotropy;
	vec3 anisotropicDirection = anisotropicB;
	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	float bendFactor = 1.0 - anisotropy * (1.0 - roughness);
	float bendFactor4 = bendFactor * bendFactor * bendFactor * bendFactor;
	vec3 bentNormal = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));
	dReflDirW = reflect(-viewDir, bentNormal);
}
`,reflectionCCPS:`
#ifdef LIT_CLEARCOAT
void addReflectionCC(vec3 reflDir, float gloss) {
	ccReflection += calcReflection(reflDir, gloss);
}
#endif
`,reflectionCubePS:`
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 lookupVec = cubeMapProject(reflDir);
	lookupVec.x *= -1.0;
	return {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionEnvHQPS:`
#ifndef ENV_ATLAS
	#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
#endif
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float flevel = level - ilevel;
	vec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));
	vec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));
	vec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionEnvPS:`
#ifndef ENV_ATLAS
#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));
	vec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionSpherePS:`
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 reflDirV = (mat3(matrix_view) * reflDir);
	float m = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionSheenPS:`
void addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {
	float NoV = dot(worldNormal, viewDir);
	float alphaG = gloss * gloss;
	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;
	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;
	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );
	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);
}
`,refractionCubePS:`
vec3 refract2(vec3 viewVec, vec3 normal, float IOR) {
	float vn = dot(viewVec, normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif 
) {
	vec4 tmpRefl = dReflection;
	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4(0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,refractionDynamicPS:`
uniform float material_invAttenuationDistance;
uniform vec3 material_attenuation;
vec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {
	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);
	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;
	vec2 uv = getGrabScreenPos(projectionPoint);
	float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	float refractionLod = log2(uScreenSize.x) * iorToRoughness;
	vec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;
	return refraction;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif
) {
	vec3 modelScale;
	modelScale.x = length(vec3(matrix_model[0].xyz));
	modelScale.y = length(vec3(matrix_model[1].xyz));
	modelScale.z = length(vec3(matrix_model[2].xyz));
	vec3 scale = thickness * modelScale;
	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	vec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		float halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		float refractionIndexR = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		float refractionIndexB = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	vec3 transmittance;
	if (material_invAttenuationDistance != 0.0)
	{
		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	vec3 fresnel = vec3(1.0) - 
		getFresnel(
			dot(viewDir, worldNormal), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,reprojectPS:`
varying vec2 vUv0;
#ifdef CUBEMAP_SOURCE
	uniform samplerCube sourceCube;
#else
	uniform sampler2D sourceTex;
#endif
#ifdef USE_SAMPLES_TEX
	uniform sampler2D samplesTex;
	uniform vec2 samplesTexInverseSize;
#endif
uniform vec3 params;
float targetFace() { return params.x; }
float targetTotalPixels() { return params.y; }
float sourceTotalPixels() { return params.z; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	vec4 sampleCubemap(vec3 dir) {
		return textureCube(sourceCube, modifySeams(dir, 1.0));
	}
	vec4 sampleCubemap(vec2 sph) {
		return sampleCubemap(fromSpherical(sph));
	}
	vec4 sampleCubemap(vec3 dir, float mipLevel) {
		return textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);
	}
	vec4 sampleCubemap(vec2 sph, float mipLevel) {
		return sampleCubemap(fromSpherical(sph), mipLevel);
	}
#else
	vec4 sampleEquirect(vec2 sph) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleEquirect(vec3 dir) {
		return sampleEquirect(toSpherical(dir));
	}
	vec4 sampleEquirect(vec2 sph, float mipLevel) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleEquirect(vec3 dir, float mipLevel) {
		return sampleEquirect(toSpherical(dir), mipLevel);
	}
	vec4 sampleOctahedral(vec3 dir) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleOctahedral(vec2 sph) {
		return sampleOctahedral(fromSpherical(sph));
	}
	vec4 sampleOctahedral(vec3 dir, float mipLevel) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleOctahedral(vec2 sph, float mipLevel) {
		return sampleOctahedral(fromSpherical(sph), mipLevel);
	}
#endif
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));
	} else {
		vec3 t = {TARGET_FUNC}();
		vec3 tu = dFdx(t);
		vec3 tv = dFdy(t);
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {
			for (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {
				result += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	void unpackSample(int i, out vec3 L, out float mipLevel) {
		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
		vec4 raw;
		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
		L.xyz = raw.xyz * 2.0 - 1.0;
		mipLevel = raw.w * 8.0;
	}
	vec4 prefilterSamples() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	vec4 prefilterSamplesUnweighted() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / float({NUM_SAMPLES}));
	}
#endif
void main(void) {
	gl_FragColor = {PROCESS_FUNC}();
}
`,reprojectVS:`
attribute vec2 vertex_position;
uniform vec4 uvMod;
varying vec2 vUv0;
void main(void) {
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);
}
`,screenDepthPS:`
uniform highp sampler2D uSceneDepthMap;
#ifndef SCREENSIZE
	#define SCREENSIZE
	uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
#ifndef LINEARIZE_DEPTH
	#define LINEARIZE_DEPTH
	
	#ifndef CAMERAPLANES
		#define CAMERAPLANES
		uniform vec4 camera_params;
	#endif
	float linearizeDepth(float z) {
		if (camera_params.w == 0.0)
			return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));
		else
			return camera_params.z + z * (camera_params.y - camera_params.z);
	}
#endif
float delinearizeDepth(float linearDepth) {
	if (camera_params.w == 0.0) {
		return (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));
	} else {
		return (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);
	}
}
float getLinearScreenDepth(vec2 uv) {
	#ifdef SCENE_DEPTHMAP_LINEAR
		#ifdef SCENE_DEPTHMAP_FLOAT
			return texture2D(uSceneDepthMap, uv).r;
		#else
			ivec2 textureSize = textureSize(uSceneDepthMap, 0);
			ivec2 texel = ivec2(uv * vec2(textureSize));
			vec4 data = texelFetch(uSceneDepthMap, texel, 0);
			uint intBits = 
				(uint(data.r * 255.0) << 24u) |
				(uint(data.g * 255.0) << 16u) |
				(uint(data.b * 255.0) << 8u) |
				uint(data.a * 255.0);
			return uintBitsToFloat(intBits);
		#endif
	#else
		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);
	#endif
}
#ifndef VERTEXSHADER
	float getLinearScreenDepth() {
		vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
		return getLinearScreenDepth(uv);
	}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`,shadowCascadesPS:`
int getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	vec4 comparisons = step(shadowCascadeDistances, vec4(depth));
	int cascadeIndex = int(dot(comparisons, vec4(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
int ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {
 
	if (cascadeIndex < shadowCascadeCount - 1) {
		float currentRangeEnd = shadowCascadeDistances[cascadeIndex];
		float transitionStart = blendFactor * currentRangeEnd;
		float depth = 1.0 / gl_FragCoord.w;
		if (depth > transitionStart) {
			float transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);
			float dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex += 1;
			}
		}
	}
	return cascadeIndex;
}
vec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {				  
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`,shadowEVSMPS:`
float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
   return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
float VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
float VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	#else
		float pixelSize = 1.0 / resolution;
		texCoords -= vec2(pixelSize);
		vec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;
		vec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;
		vec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;
		vec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;
		vec2 fr = fract(texCoords * resolution);
		vec3 h0 = mix(s00, s10, fr.x);
		vec3 h1 = mix(s01, s11, fr.x);
		vec3 moments = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	float Z = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
`,shadowPCF1PS:`
float getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#ifndef WEBGPU
float getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return texture(shadowMap, vec4(lightDir, shadowZ));
}
#endif
`,shadowPCF3PS:`
float _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y); 
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
#ifndef WEBGPU
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {
	
	float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
	float z = 1.0 / float(textureSize(shadowMap, 0));
	vec3 tc = normalize(dir);
	mediump vec4 shadows;
	shadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));
	shadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));
	shadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));
	shadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));
	return dot(shadows, vec4(0.25));
}
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	return getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);
}
#endif
`,shadowPCF5PS:`
float _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
`,shadowPCSSPS:`
#define PCSS_SAMPLE_COUNT 16
uniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];
uniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];
vec2 vogelDisk(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float sine = sin(theta);
	float cosine = cos(theta);
	return vec2(r * cosine, r * sine);
}
vec3 vogelSphere(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float weight = float(sampleIndex) / count;
	return vec3(cos(theta) * r, weight, sin(theta) * r);
}
float noise(vec2 screenPos) {
	const float PHI = 1.61803398874989484820459;
	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);
}
float viewSpaceDepth(float depth, mat4 invProjection) {
	float z = depth * 2.0 - 1.0;
	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);
	vec4 viewSpace = invProjection * clipSpace;
	return viewSpace.z;
}
float PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec2 offset = sampleCoords[i] * searchSize;
		vec2 sampleUV = shadowCoords + offset;
		float blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {
	float receiverDepth = linearizeDepthWithParams(shadowCoords.z, cameraParams);
	vec2 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float pcssPresample = pcssDiskSamples[i];
		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);
	}
	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float depthDifference = (receiverDepth - averageBlocker) / 3.0;
		vec2 filterRadius = depthDifference * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)
		{
			vec2 sampleUV = samplePoints[i] * filterRadius;
			sampleUV = shadowCoords.xy + sampleUV;
			float depth = texture2DLod(shadowMap, sampleUV, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	} 
}
#ifndef WEBGPU
float PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;
		sampleDir = normalize(sampleDir);
		float blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {
	
	vec3 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float r = pcssSphereSamples[i];
		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);
	}
	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 lightDirNorm = normalize(lightDir);
	
	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)
		{
			vec3 offset = samplePoints[i] * filterRadius;
			vec3 sampleDir = lightDirNorm + offset;
			sampleDir = normalize(sampleDir);
			float depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	}
}
float getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);
}
#endif
float getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
`,shadowSoftPS:`
highp float fractSinRand(const in vec2 uv) {
	const float PI = 3.141592653589793;
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	float invNumSamples;
	float initialAngle;
	float currentPointId;
};
void prepareDiskConstants(out VogelDiskData data, int sampleCount, float randomSeed) {
	const float pi2 = 6.28318530718;
	data.invNumSamples = 1.0 / float(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
vec2 generateDiskSample(inout VogelDiskData data) {
	const float GOLDEN_ANGLE = 2.399963;
	float r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	float theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	vec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId += 1.0;
	return offset;
}
void PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,
	vec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowBlockerSamples, randomSeed);
	float searchWidth = penumbraSize * invShadowMapSize;
	float blockerSum = 0.0;
	numBlockers = 0;
	for( int i = 0; i < shadowBlockerSamples; ++i ) {
		vec2 diskUV = generateDiskSample(diskData);
		vec2 sampleUV = shadowCoords + diskUV * searchWidth;
		float shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum += shadowMapDepth;
			numBlockers++;
		}
	}
	avgBlockerDepth = blockerSum / float(numBlockers);
}
float PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowSamples, randomSeed);
	float sum = 0.0;
	for (int i = 0; i < shadowSamples; i++) {
		vec2 offsetUV = generateDiskSample(diskData) * filterRadius;
		float depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;
		sum += step(receiverDepth, depth);
	}
	return sum / float(shadowSamples);
}
float getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {
	float dist = dreceiver - dblocker;
	float penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
float PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {
	float receiverDepth = shadowCoords.z;
	float randomSeed = fractSinRand(gl_FragCoord.xy);
	int shadowSamples = int(softShadowParams.x);
	int shadowBlockerSamples = int(softShadowParams.y);
	float penumbraSize = softShadowParams.z;
	float penumbraFalloff = softShadowParams.w;
	int shadowMapSize = textureSize(shadowMap, 0).x;
	float invShadowMapSize = 1.0 / float(shadowMapSize);
	invShadowMapSize *= float(shadowMapSize) / 2048.0;
	float penumbra;
	if (shadowBlockerSamples > 0) {
		float avgBlockerDepth = 0.0;
		int numBlockers = 0;
		PCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1)
			return 1.0f;
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	float filterRadius = penumbra * invShadowMapSize;
	return PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
float getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {
	return PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);
}
`,skinBatchVS:`
attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
mat4 getBoneMatrix(const in float indexFloat) {
	int width = textureSize(texture_poseMap, 0).x;
	int index = int(indexFloat + 0.5) * 3;
	int iy = index / width;
	int ix = index % width;
	vec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);
	vec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);
	vec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,skinVS:`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
void getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {
	int v = index / width;
	int u = index % width;
	v1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);
	v2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);
	v3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);
}
mat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {
	int width = textureSize(texture_poseMap, 0).x;
	ivec4 indices = ivec4(indicesFloat + 0.5) * 3;
	vec4 a1, a2, a3;
	getBoneMatrix(width, indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(width, indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(width, indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(width, indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,skyboxPS:`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	#ifdef PREPASS_PASS
		varying float vLinearDepth;
		#include "floatAsUintPS"
	#endif
	varying vec3 vViewDir;
	uniform float skyboxHighlightMultiplier;
	#ifdef SKY_CUBEMAP
		uniform samplerCube texture_cubeMap;
		#ifdef SKYMESH
			varying vec3 vWorldPos;
			uniform mat3 cubeMapRotationMatrix;
			uniform vec3 projectedSkydomeCenter;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		uniform sampler2D texture_envAtlas;
		uniform float mipLevel;
	#endif
	void main(void) {
		#ifdef PREPASS_PASS
			gl_FragColor = float2vec4(vLinearDepth);
		#else
			#ifdef SKY_CUBEMAP
				#ifdef SKYMESH
					vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);
					vec3 dir = envDir * cubeMapRotationMatrix;
				#else
					vec3 dir = vViewDir;
				#endif
				dir.x *= -1.0;
				vec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));
			#else
				vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
				vec2 uv = toSphericalUv(normalize(dir));
				vec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
			#endif
			if (any(greaterThanEqual(linear, vec3(64.0)))) {
				linear *= skyboxHighlightMultiplier;
			}
			gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
		#endif
	}
`,skyboxVS:`
attribute vec4 aPosition;
uniform mat4 matrix_view;
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
#ifdef SKYMESH
	uniform mat4 matrix_model;
	varying vec3 vWorldPos;
#endif
void main(void) {
	mat4 view = matrix_view;
	#ifdef SKYMESH
		vec4 worldPos = matrix_model * aPosition;
		vWorldPos = worldPos.xyz;
		gl_Position = matrix_projectionSkybox * (view * worldPos);
		#ifdef PREPASS_PASS
			vLinearDepth = -(matrix_view * vec4(vWorldPos, 1.0)).z;
		#endif
	#else
		view[3][0] = view[3][1] = view[3][2] = 0.0;
		gl_Position = matrix_projectionSkybox * (view * aPosition);
		vViewDir = aPosition.xyz * cubeMapRotationMatrix;
		#ifdef PREPASS_PASS
			vLinearDepth = -gl_Position.w;
		#endif
	#endif
	gl_Position.z = gl_Position.w - 1.0e-7;
}
`,specularPS:`
#ifdef STD_SPECULAR_CONSTANT
uniform vec3 material_specular;
#endif
void getSpecularity() {
	vec3 specularColor = vec3(1,1,1);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor *= material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`,sphericalPS:`
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	const float PI = 3.141592653589793;
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
`,specularityFactorPS:`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
uniform float material_specularityFactor;
#endif
void getSpecularityFactor() {
	float specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor *= material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`,spotPS:`
float getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {
	float cosAngle = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`,startNineSlicedPS:`
	nineSlicedUv = vec2(vUv0.x, 1.0 - vUv0.y);
`,startNineSlicedTiledPS:`
	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
	
`,stdDeclarationPS:`
	float dAlpha = 1.0;
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			uniform sampler2D texture_opacityMap;
		#endif
	#endif
	#ifdef FORWARD_PASS
		vec3 dAlbedo;
		vec3 dNormalW;
		vec3 dSpecularity = vec3(0.0);
		float dGlossiness = 0.0;
		#ifdef LIT_REFRACTION
			float dTransmission;
			float dThickness;
		#endif
		#ifdef LIT_SCENE_COLOR
			uniform sampler2D uSceneColorMap;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform vec4 uScreenSize;
		#endif
		#ifdef LIT_TRANSFORMS
			uniform mat4 matrix_viewProjection;
			uniform mat4 matrix_model;
		#endif
		#ifdef STD_HEIGHT_MAP
			vec2 dUvOffset;
			#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
				uniform sampler2D texture_heightMap;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseMap;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseDetailMap;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalMap;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalDetailMap;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			uniform sampler2D texture_thicknessMap;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			uniform sampler2D texture_refractionMap;
		#endif
		#ifdef LIT_IRIDESCENCE
			float dIridescence;
			float dIridescenceThickness;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceThicknessMap;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceMap;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			float ccSpecularity;
			float ccGlossiness;
			vec3 ccNormalW;
		#endif
		#ifdef LIT_GGX_SPECULAR
			float dAnisotropy;
			vec2 dAnisotropyRotation;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				vec3 sSpecularity;
				float sGlossiness;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenMap;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenGlossMap;
				#endif
			#endif
			#ifdef LIT_METALNESS
				float dMetalness;
				float dIor;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					uniform sampler2D texture_metalnessMap;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				float dSpecularityFactor;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularityFactorMap;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularMap;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_glossMap;
			#endif
		#endif
		#ifdef STD_AO
			float dAo;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoMap;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoDetailMap;
			#endif
		#endif
		vec3 dEmission;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			uniform sampler2D texture_emissiveMap;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatMap;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatGlossMap;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatNormalMap;
			#endif
		#endif
		
		#ifdef LIT_GGX_SPECULAR
			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE
				uniform sampler2D texture_anisotropyMap;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			vec3 dLightmap;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				uniform sampler2D texture_lightMap;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`,stdFrontEndPS:`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#include "opacityPS"
		#if defined(LIT_ALPHA_TEST)
			#include "alphaTestPS"
		#endif
		#if STD_OPACITY_DITHER != NONE
			#include "opacityDitherPS"
		#endif
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				void getSpecularity() { 
					dSpecularity = vec3(1);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
			#include "anisotropyPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	void evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
				getAnisotropy();
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`,TBNPS:`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform float tbnBasis;
#endif
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	#ifdef TBN_TANGENTS
		dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		vec2 uv = {lightingUv};
		vec3 dp1 = dFdx( vPositionW );
		vec3 dp2 = dFdy( vPositionW );
		vec2 duv1 = dFdx( uv );
		vec2 duv2 = dFdy( uv );
		vec3 dp2perp = cross( dp2, normal );
		vec3 dp1perp = cross( normal, dp1 );
		vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
		vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
		float denom = max( dot(T,T), dot(B,B) );
		float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
		dTBN = mat3(T * invmax, -B * invmax, normal );
	#else
		vec3 B = cross(normal, vObjectSpaceUpW);
		vec3 T = cross(normal, B);
		if (dot(B,B)==0.0)
		{
			float major=max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3(0,1,0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3(0,0,1));
				T = cross(normal, B);
			}
			else if (normal.z == major)
			{
				B = cross(normal, vec3(1,0,0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3(normalize(T), normalize(B), normalize(normal));
	#endif
}
`,thicknessPS:`
#ifdef STD_THICKNESS_CONSTANT
uniform float material_thickness;
#endif
void getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness *= material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`,tonemappingPS:`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`,tonemappingAcesPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`,tonemappingAces2PS:`
uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,  1.10813, -0.00605,
	-0.00327, -0.07276,  1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure / 0.6;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`,tonemappingFilmicPS:`
const float A =  0.15;
const float B =  0.50;
const float C =  0.10;
const float D =  0.20;
const float E =  0.02;
const float F =  0.30;
const float W =  11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`,tonemappingHejlPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`,tonemappingLinearPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`,tonemappingNeutralPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	float startCompression = 0.8 - 0.04;
	float desaturation = 0.15;
	float x = min(color.r, min(color.g, color.b));
	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;
	color -= offset;
	float peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) return color;
	float d = 1. - startCompression;
	float newPeak = 1. - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);
	return mix(color, newPeak * vec3(1, 1, 1), g);
}
`,tonemappingNonePS:`
vec3 toneMap(vec3 color) {
	return color;
}
`,transformVS:`
#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef SCREENSPACE
uniform float projectionFlipY;
#endif
vec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {
	vec3 localPos = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		localPos.xz *= outerScale;
		vec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));
		localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
		localPos.xz *= -0.5;
		localPos = localPos.xzy;
	#endif
	vec4 posW = modelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
		posW.zw = vec2(0.0, 1.0);
	#endif
	return posW;
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
		screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
		#ifdef WEBGPU
			screenPos.y *= -1.0;
		#endif
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= projectionFlipY;
		#else
			screenPos = matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`,transformCoreVS:`
attribute vec4 vertex_position;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifdef MORPHING
	uniform vec2 morph_tex_params;
	attribute uint morph_vertex_id;
	ivec2 getTextureMorphCoords() {
		ivec2 textureSize = ivec2(morph_tex_params);
		int morphGridV = int(morph_vertex_id) / textureSize.x;
		int morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);
		#ifdef WEBGPU
			morphGridV = textureSize.y - morphGridV - 1;
		#endif
		return ivec2(morphGridU, morphGridV);
	}
	#ifdef MORPHING_POSITION
		#ifdef MORPHING_INT
			uniform vec3 aabbSize;
			uniform vec3 aabbMin;
			uniform usampler2D morphPositionTex;
		#else
			uniform highp sampler2D morphPositionTex;
		#endif
	#endif
#endif
#ifdef defined(BATCH)
	#include "skinBatchVS"
	mat4 getModelMatrix() {
		return getBoneMatrix(vertex_boneIndices);
	}
#elif defined(SKIN)
	#include "skinVS"
	mat4 getModelMatrix() {
		return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	}
#elif defined(INSTANCING)
	#include "transformInstancingVS"
#else
	mat4 getModelMatrix() {
		return matrix_model;
	}
#endif
vec3 getLocalPosition(vec3 vertexPosition) {
	vec3 localPos = vertexPosition;
	#ifdef MORPHING_POSITION
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;
		#else
			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;
		#endif
		localPos += morphPos;
	#endif
	return localPos;
}
`,transformInstancingVS:`
attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
mat4 getModelMatrix() {
	return matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);
}
`,transmissionPS:`
#ifdef STD_REFRACTION_CONSTANT
uniform float material_refraction;
#endif
void getRefraction() {
	float refraction = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`,twoSidedLightingPS:`
uniform float twoSidedLightingNegScaleFactor;
void handleTwoSidedLighting() {
	dTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;
}
`,uv0VS:`
#ifdef NINESLICED
	vec2 getUv0() {
		vec2 uv = vertex_position.xz;
		vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
		uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		uv = uv * -0.5 + 0.5;
		uv = uv * atlasRect.zw + atlasRect.xy;
		vMask = vertex_texCoord0.xy;
		return uv;
	}
#else
	vec2 getUv0() {
		return vertex_texCoord0;
	}
#endif
`,uv1VS:`
vec2 getUv1() {
	return vertex_texCoord1;
}
`,uvTransformVS:`
vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)
);
`,uvTransformUniformsPS:`
	uniform vec3 {TRANSFORM_NAME_{i}}0;
	uniform vec3 {TRANSFORM_NAME_{i}}1;
`,viewDirPS:`
void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`,webgpuPS:Y_,webgpuVS:q_},oL={alphaTestPS:`
uniform alpha_ref: f32;
fn alphaTest(a: f32) {
	if (a < uniform.alpha_ref) {
		discard;
	}
}
`,ambientPS:`
#if LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform ambientSH: array<vec3f, 9>;
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
		#define ENV_ATLAS
		var texture_envAtlas: texture_2d<f32>;
		var texture_envAtlasSampler: sampler;
	#endif
#endif
fn addAmbient(worldNormal: vec3f) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		let n: vec3f = cubeMapRotate(worldNormal);
		let color: vec3f =
			uniform.ambientSH[0] +
			uniform.ambientSH[1] * n.x +
			uniform.ambientSH[2] * n.y +
			uniform.ambientSH[3] * n.z +
			uniform.ambientSH[4] * n.x * n.z +
			uniform.ambientSH[5] * n.z * n.y +
			uniform.ambientSH[6] * n.y * n.x +
			uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));
		let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);
		let linear: vec3f = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += uniform.light_globalAmbient;
	#endif
}
`,anisotropyPS:`
#ifdef LIT_GGX_SPECULAR
	uniform material_anisotropyIntensity: f32;
	uniform material_anisotropyRotation: vec2f;
#endif
fn getAnisotropy() {
	dAnisotropy = 0.0;
	dAnisotropyRotation = vec2f(1.0, 0.0);
#ifdef LIT_GGX_SPECULAR
	dAnisotropy = uniform.material_anisotropyIntensity;
	dAnisotropyRotation = uniform.material_anisotropyRotation;
#endif
#ifdef STD_ANISOTROPY_TEXTURE
	let anisotropyTex: vec3f = textureSampleBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_NAME}Sampler, {STD_ANISOTROPY_TEXTURE_UV}, uniform.textureBias).rgb;
	dAnisotropy *= anisotropyTex.b;
	let anisotropyRotationFromTex: vec2f = anisotropyTex.rg * 2.0 - vec2f(1.0);
	let rotationMatrix: mat2x2f = mat2x2f(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);
	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;
#endif
	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);
}
`,aoPS:`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform material_aoIntensity: f32;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
fn getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		var aoBase: f32 = textureSampleBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_NAME}Sampler, {STD_AO_TEXTURE_UV}, uniform.textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			var aoDetail: f32 = textureSampleBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_NAME}Sampler, {STD_AODETAIL_TEXTURE_UV}, uniform.textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3f(aoBase), vec3f(aoDetail)).r;
		#endif
		dAo = dAo * aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo = dAo * saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, uniform.material_aoIntensity);
	#endif
}
`,aoDiffuseOccPS:`
fn occludeDiffuse(ao: f32) {
	dDiffuseLight = dDiffuseLight * ao;
}
`,aoSpecOccPS:`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform material_occludeSpecularIntensity: f32;
	#endif
#endif
fn occludeSpecular(gloss: f32, ao: f32, worldNormal: vec3f, viewDir: vec3f) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			var specOcc: f32 = mix(1.0, ao, uniform.material_occludeSpecularIntensity);
		#else
			var specOcc: f32 = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		var specPow: f32 = exp2(gloss * 11.0);
		var specOcc: f32 = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, uniform.material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight = dSpecularLight * specOcc;
		dReflection = dReflection * specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight = sSpecularLight * specOcc;
			sReflection = sReflection * specOcc;
		#endif
	#endif
}
`,bakeDirLmEndPS:`
	let dirLm = textureSample(texture_dirLightMap, texture_dirLightMapSampler, vUv1);
	if (uniform.bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			let unpacked_dir = dirLm.xyz * 2.0 - vec3f(1.0);
			dAtten = clamp(dAtten, 0.0, 1.0);
			let combined_dir = dLightDirNormW.xyz * dAtten + unpacked_dir * dirLm.w;
			let finalRgb = normalize(combined_dir) * 0.5 + vec3f(0.5);
			let finalA = max(dirLm.w + dAtten, 1.0 / 255.0);
			output.color = vec4f(finalRgb, finalA);
		} else {
			output.color = dirLm;
		}
	} else {
		let alpha_min = select(0.0, 1.0 / 255.0, dAtten > 0.00001);
		let finalA = max(dirLm.w, alpha_min);
		output.color = vec4f(dirLm.rgb, finalA);
	}
`,bakeLmEndPS:`
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	dDiffuseLight = ((dDiffuseLight - 0.5) * max(uniform.ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;
	dDiffuseLight = dDiffuseLight + vec3f(uniform.ambientBakeOcclusionBrightness);
	dDiffuseLight = saturate3(dDiffuseLight);
	dDiffuseLight = dDiffuseLight * dAmbientLight;
#endif
#ifdef LIGHTMAP_RGBM
	var temp_color_rgbm = vec4f(dDiffuseLight, 1.0);
	temp_color_rgbm = vec4f(pow(temp_color_rgbm.rgb, vec3f(0.5)), temp_color_rgbm.a);
	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / 8.0, temp_color_rgbm.a);
	let max_g_b = max(temp_color_rgbm.g, max(temp_color_rgbm.b, 1.0 / 255.0));
	let max_rgb = max(temp_color_rgbm.r, max_g_b);
	temp_color_rgbm.a = clamp(max_rgb, 0.0, 1.0);
	temp_color_rgbm.a = ceil(temp_color_rgbm.a * 255.0) / 255.0;
	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / temp_color_rgbm.a, temp_color_rgbm.a);
	output.color = temp_color_rgbm;
#else
	output.color = vec4f(dDiffuseLight, 1.0);
#endif
`,basePS:`
uniform view_position: vec3f;
uniform light_globalAmbient: vec3f;
fn square(x: f32) -> f32 {
	return x*x;
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn saturate3(x: vec3f) -> vec3f {
	return clamp(x, vec3f(0.0), vec3f(1.0));
}
`,baseNineSlicedPS:`
#define NINESLICED
varying vMask: vec2f;
varying vTiledUv: vec2f;
uniform innerOffset: vec4f;
uniform outerScale: vec2f;
uniform atlasRect: vec4f;
var<private> nineSlicedUv: vec2f;
`,baseNineSlicedTiledPS:`
#define NINESLICED
#define NINESLICETILED
varying vMask: vec2f;
varying vTiledUv: vec2f;
uniform innerOffset: vec4f;
uniform outerScale: vec2f;
uniform atlasRect: vec4f;
var<private> nineSlicedUv: vec2f;
`,bayerPS:`
fn bayer2(p: vec2f) -> f32 {
	return (2.0 * p.y + p.x + 1.0) % 4.0;
}
fn bayer4(p: vec2f) -> f32 {
	let p1: vec2f = p % vec2f(2.0);
	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
fn bayer8(p: vec2f) -> f32 {
	let p1: vec2f = p % vec2f(2.0);
	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));
	let p4: vec2f = floor(0.25 * (p % vec2f(8.0)));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,blurVSMPS:`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
#ifdef GAUSS
	uniform weight: array<f32, {SAMPLES}>;
#endif
uniform pixelOffset: vec2f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	var moments: vec3f = vec3f(0.0);
	let uv: vec2f = input.vUv0 - uniform.pixelOffset * (f32({SAMPLES}) * 0.5);
	for (var i: i32 = 0; i < {SAMPLES}; i = i + 1) {
		let c: vec4f = textureSample(source, sourceSampler, uv + uniform.pixelOffset * f32(i));
		#ifdef GAUSS
			moments = moments + c.xyz * uniform.weight[i].element;
		#else
			moments = moments + c.xyz;
		#endif
	}
	#ifndef GAUSS
		moments = moments * (1.0 / f32({SAMPLES}));
	#endif
	output.color = vec4f(moments, 1.0);
	return output;
}
`,clearCoatPS:`
#ifdef STD_CLEARCOAT_CONSTANT
	uniform material_clearCoat: f32;
#endif
fn getClearCoat() {
	ccSpecularity = 1.0;
	#ifdef STD_CLEARCOAT_CONSTANT
	ccSpecularity = ccSpecularity * uniform.material_clearCoat;
	#endif
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity = ccSpecularity * textureSampleBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_NAME}Sampler, {STD_CLEARCOAT_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity = ccSpecularity * saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`,clearCoatGlossPS:`
#ifdef STD_CLEARCOATGLOSS_CONSTANT
	uniform material_clearCoatGloss: f32;
#endif
fn getClearCoatGlossiness() {
	ccGlossiness = 1.0;
	#ifdef STD_CLEARCOATGLOSS_CONSTANT
	ccGlossiness = ccGlossiness * uniform.material_clearCoatGloss;
	#endif
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness = ccGlossiness * textureSampleBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_NAME}Sampler, {STD_CLEARCOATGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness = ccGlossiness * saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,clearCoatNormalPS:`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	uniform material_clearCoatBumpiness: f32;
#endif
fn getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	var normalMap: vec3f = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(textureSampleBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_NAME}Sampler, {STD_CLEARCOATNORMAL_TEXTURE_UV}, uniform.textureBias));
	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,clusteredLightCookiesPS:`
fn _getCookieClustered(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, intensity: f32, cookieChannel: vec4f) -> vec3f {
	let pixel: vec4f = mix(vec4f(1.0), textureSampleLevel(tex, texSampler, uv, 0.0), intensity);
	let isRgb: bool = dot(cookieChannel.rgb, vec3f(1.0)) == 3.0;
	return select(vec3f(dot(pixel, cookieChannel)), pixel.rgb, isRgb);
}
fn getCookie2DClustered(tex: texture_2d<f32>, texSampler: sampler, transform: mat4x4f, worldPosition: vec3f, intensity: f32, cookieChannel: vec4f) -> vec3f {
	let projPos: vec4f = transform * vec4f(worldPosition, 1.0);
	return _getCookieClustered(tex, texSampler, projPos.xy / projPos.w, intensity, cookieChannel);
}
fn getCookieCubeClustered(tex: texture_2d<f32>, texSampler: sampler, dir: vec3f, intensity: f32, cookieChannel: vec4f, shadowTextureResolution: f32, shadowEdgePixels: f32, omniAtlasViewport: vec3f) -> vec3f {
	let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(tex, texSampler, uv, intensity, cookieChannel);
}
`,clusteredLightShadowsPS:`
fn _getShadowCoordPerspZbuffer(shadowMatrix: mat4x4f, shadowParams: vec4f, wPos: vec3f) -> vec3f {
	var projPos = shadowMatrix * vec4f(wPos, 1.0);
	return projPos.xyz / projPos.w;
}
fn getShadowCoordPerspZbufferNormalOffset(shadowMatrix: mat4x4f, shadowParams: vec4f, normal: vec3f) -> vec3f {
	let wPos: vec3f = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
fn normalOffsetPointShadow(shadowParams: vec4f, lightPos: vec3f, lightDir: vec3f, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
	let distScale: f32 = length(lightDir);
	let wPos: vec3f = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	let dir: vec3f = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	fn getShadowOmniClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		return textureSampleCompareLevel(shadowMap, shadowMapSampler, uv, shadowZ);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	fn getShadowOmniClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		let shadowCoord: vec3f = vec3f(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	fn getShadowOmniClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		let shadowCoord: vec3f = vec3f(uv, shadowZ);
		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	fn getShadowSpotClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
	}
#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	fn getShadowSpotClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return getShadowSpotPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	fn getShadowSpotClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
`,clusteredLightUtilsPS:`
struct FaceCoords {
	uv: vec2f,
	faceIndex: f32,
	tileOffset: vec2f,
}
fn getCubemapFaceCoordinates(dir: vec3f) -> FaceCoords {
	var faceIndex: f32;
	var tileOffset: vec2f;
	var uv: vec2f;
	let vAbs: vec3f = abs(dir);
	var ma: f32;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		let is_neg_z = dir.z < 0.0;
		faceIndex = select(4.0, 5.0, is_neg_z);
		ma = 0.5 / vAbs.z;
		uv = vec2f(select(dir.x, -dir.x, is_neg_z), -dir.y);
		tileOffset = vec2f(2.0, select(0.0, 1.0, is_neg_z));
	} else if (vAbs.y >= vAbs.x) {
		let is_neg_y = dir.y < 0.0;
		faceIndex = select(2.0, 3.0, is_neg_y);
		ma = 0.5 / vAbs.y;
		uv = vec2f(dir.x, select(dir.z, -dir.z, is_neg_y));
		tileOffset = vec2f(1.0, select(0.0, 1.0, is_neg_y));
	} else {
		let is_neg_x = dir.x < 0.0;
		faceIndex = select(0.0, 1.0, is_neg_x);
		ma = 0.5 / vAbs.x;
		uv = vec2f(select(-dir.z, dir.z, is_neg_x), -dir.y);
		tileOffset = vec2f(0.0, select(0.0, 1.0, is_neg_x));
	}
	uv = uv * ma + 0.5;
	return FaceCoords(uv, faceIndex, tileOffset);
}
fn getCubemapAtlasCoordinates(omniAtlasViewport: vec3f, shadowEdgePixels: f32, shadowTextureResolution: f32, dir: vec3f) -> vec2f {
	let faceData: FaceCoords = getCubemapFaceCoordinates(dir);
	var uv: vec2f = faceData.uv;
	let tileOffset: vec2f = faceData.tileOffset;
	let atlasFaceSize: f32 = omniAtlasViewport.z;
	let tileSize: f32 = shadowTextureResolution * atlasFaceSize;
	var offset: f32 = shadowEdgePixels / tileSize;
	uv = uv * (1.0 - offset * 2.0) + offset;
	uv = uv * atlasFaceSize;
	uv = uv + tileOffset * atlasFaceSize;
	uv = uv + omniAtlasViewport.xy;
	return uv;
}
`,clusteredLightPS:`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
var clusterWorldTexture: texture_2d<f32>;
var lightsTexture: texture_2d<f32>;
#ifdef CLUSTER_SHADOWS
	var shadowAtlasTexture: texture_depth_2d;
	var shadowAtlasTextureSampler: sampler_comparison;
#endif
#ifdef CLUSTER_COOKIES
	var cookieAtlasTexture: texture_2d<f32>;
	var cookieAtlasTextureSampler: sampler;
#endif
uniform clusterMaxCells: i32;
uniform clusterSkip: f32;
uniform clusterCellsCountByBoundsSize: vec3f;
uniform clusterTextureSize: vec3f;
uniform clusterBoundsMin: vec3f;
uniform clusterBoundsDelta: vec3f;
uniform clusterCellsDot: vec3f;
uniform clusterCellsMax: vec3f;
uniform shadowAtlasParams: vec2f;
struct ClusterLightData {
	flags: u32,
	halfWidth: vec3f,
	isSpot: bool,
	halfHeight: vec3f,
	lightIndex: i32,
	position: vec3f,
	shape: u32,
	direction: vec3f,
	falloffModeLinear: bool,
	color: vec3f,
	shadowIntensity: f32,
	omniAtlasViewport: vec3f,
	range: f32,
	cookieChannelMask: vec4f,
	biasesData: f32,
	shadowBias: f32,
	shadowNormalBias: f32,
	anglesData: f32,
	innerConeAngleCos: f32,
	outerConeAngleCos: f32,
	cookieIntensity: f32,
	isDynamic: bool,
	isLightmapped: bool
}
var<private> lightProjectionMatrix: mat4x4f;
fn sampleLightTextureF(lightIndex: i32, index: i32) -> vec4f {
	return textureLoad(lightsTexture, vec2<i32>(index, lightIndex), 0);
}
fn decodeClusterLightCore(clusterLightData: ptr<function, ClusterLightData>, lightIndex: f32) {
	clusterLightData.lightIndex = i32(lightIndex);
	let halfData: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	let colorRG: vec2f = unpack2x16float(bitcast<u32>(halfData.x));
	let colorB_: vec2f = unpack2x16float(bitcast<u32>(halfData.y));
	clusterLightData.color = vec3f(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};
	let lightPosRange: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_POSITION_RANGE});
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	let lightDir_Flags: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_DIRECTION_FLAGS});
	clusterLightData.direction = lightDir_Flags.xyz;
	let flags_uint: u32 = bitcast<u32>(lightDir_Flags.w);
	clusterLightData.flags = flags_uint;
	clusterLightData.isSpot = (flags_uint & (1u << 30u)) != 0u;
	clusterLightData.shape = (flags_uint >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (flags_uint & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = f32((flags_uint >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = f32((flags_uint >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (flags_uint & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (flags_uint & (1u << 21u)) != 0u;
}
fn decodeClusterLightSpot(clusterLightData: ptr<function, ClusterLightData>) {
	let angles: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.anglesData));
	clusterLightData.innerConeAngleCos = angles.x;
	clusterLightData.outerConeAngleCos = angles.y;
}
fn decodeClusterLightOmniAtlasViewport(clusterLightData: ptr<function, ClusterLightData>) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;
}
fn decodeClusterLightAreaData(clusterLightData: ptr<function, ClusterLightData>) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;
}
fn decodeClusterLightProjectionMatrixData(clusterLightData: ptr<function, ClusterLightData>) {
	let m0: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0});
	let m1: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_1});
	let m2: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_2});
	let m3: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_3});
	lightProjectionMatrix = mat4x4f(m0, m1, m2, m3);
}
fn decodeClusterLightShadowData(clusterLightData: ptr<function, ClusterLightData>) {
	let biases: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
fn decodeClusterLightCookieData(clusterLightData: ptr<function, ClusterLightData>) {
	let cookieFlags: u32 = (clusterLightData.flags >> 23u) & 0x0Fu;
	let mask_uvec: vec4<u32> = vec4<u32>(cookieFlags) & vec4<u32>(1u, 2u, 4u, 8u);
	clusterLightData.cookieChannelMask = step(vec4f(1.0), vec4f(mask_uvec));
}
fn evaluateLight(
	light: ptr<function, ClusterLightData>,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	var cookieAttenuation: vec3f = vec3f(1.0);
	var diffuseAttenuation: f32 = 1.0;
	var falloffAttenuation: f32 = 1.0;
	let lightDirW: vec3f = evalOmniLight(light.position);
	let lightDirNormW: vec3f = normalize(lightDirW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear) {
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		} else {
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
		}
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation = falloffAttenuation * getLightDiffuse(worldNormal, viewDir, lightDirNormW);
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation = falloffAttenuation * getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				let shadowTextureResolution: f32 = uniform.shadowAtlasParams.x;
				let shadowEdgePixels: f32 = uniform.shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					let shadowParams: vec4f = vec4f(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						let shadowCoord: vec3f = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							let shadow: f32 = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							let shadow: f32 = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							let shadow: f32 = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							let shadow: f32 = getShadowSpotClusteredPCSS(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#endif
						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);
					} else {
						let dir: vec3f = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							let shadow: f32 = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							let shadow: f32 = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							let shadow: f32 = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				var areaDiffuse: vec3f = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3f(0.0), dLTCSpecFres);
				#endif
				dDiffuseLight = dDiffuseLight + areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				var areaLightSpecular: f32;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight = dSpecularLight + dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					var areaLightSpecularCC: f32;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight = ccSpecularLight + ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				var punctualDiffuse: vec3f = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3f(0.0), specularity);
				#endif
				#endif
				dDiffuseLight = dDiffuseLight + punctualDiffuse;
			}
			#ifdef LIT_SPECULAR
				let halfDir: vec3f = normalize(-lightDirNormW + viewDir);
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight = dSpecularLight +
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation *
						getFresnel(
							dot(viewDir, halfDir),
							gloss,
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight = dSpecularLight + getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation;
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight = sSpecularLight + getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
fn evaluateClusterLight(
	lightIndex: f32,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	var clusterLightData: ClusterLightData;
	decodeClusterLightCore(&clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		let acceptLightMask: bool = clusterLightData.isDynamic;
	#else
		let acceptLightMask: bool = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask) {
		evaluateLight(
			&clusterLightData,
			worldNormal,
			viewDir,
			reflectionDir,
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir,
#endif
			gloss,
			specularity,
			geometricNormal,
			tbn,
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
	}
}
fn addClusteredLights(
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	if (uniform.clusterSkip > 0.5) {
		return;
	}
	let cellCoords: vec3f = floor((vPositionW - uniform.clusterBoundsMin) * uniform.clusterCellsCountByBoundsSize);
	if (!(any(cellCoords < vec3f(0.0)) || any(cellCoords >= uniform.clusterCellsMax))) {
		let cellIndex: f32 = dot(uniform.clusterCellsDot, cellCoords);
		let clusterV: f32 = floor(cellIndex * uniform.clusterTextureSize.y);
		let clusterU: f32 = cellIndex - (clusterV * uniform.clusterTextureSize.x);
		for (var lightCellIndex: i32 = 0; lightCellIndex < uniform.clusterMaxCells; lightCellIndex = lightCellIndex + 1) {
			let lightIndexPacked: f32 = textureLoad(clusterWorldTexture, vec2<i32>(i32(clusterU) + lightCellIndex, i32(clusterV)), 0).r;
			if (lightIndexPacked <= 0.0) {
				break;
			}
			evaluateClusterLight(
				lightIndexPacked * 255.0,
				worldNormal,
				viewDir,
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss,
				specularity,
				geometricNormal,
				tbn,
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			);
		}
	}
}`,combinePS:`
fn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {
	var ret: vec3f = vec3f(0.0);
	#ifdef LIT_OLD_AMBIENT
		ret = ret + ((dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient);
	#else
		ret = ret + (albedo * dDiffuseLight);
	#endif
	#ifdef LIT_SPECULAR
		ret = ret + dSpecularLight;
	#endif
	#ifdef LIT_REFLECTIONS
		ret = ret + (dReflection.rgb * dReflection.a);
	#endif
	#ifdef LIT_SHEEN
		let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
		ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
	#endif
	#ifdef LIT_CLEARCOAT
		let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;
		ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;
	#endif
	return ret;
}
`,cookieBlit2DPS:`
	varying uv0: vec2f;
	var blitTexture: texture_2d<f32>;
	var blitTextureSampler : sampler;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);
		return output;
	}
`,cookieBlitCubePS:`
	varying uv0: vec2f;
	uniform invViewProj: mat4x4<f32>;
	var blitTexture: texture_cube<f32>;
	var blitTextureSampler : sampler;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);
		var worldPos = uniform.invViewProj * projPos;
		output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);
		return output;
	}
`,cookieBlitVS:`
	attribute vertex_position: vec2f;
	varying uv0: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.vertex_position, 0.5, 1.0);
		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
		output.uv0.y = 1.0 - output.uv0.y;
		return output;
	}
`,cubeMapProjectPS:`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform envBoxMin: vec3f;
	uniform envBoxMax: vec3f;
#endif
fn cubeMapProject(nrdir: vec3f) -> vec3f {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		let nrdir_rotated: vec3f = cubeMapRotate(nrdir);
		let rbmax: vec3f = (uniform.envBoxMax - vPositionW) / nrdir_rotated;
		let rbmin: vec3f = (uniform.envBoxMin - vPositionW) / nrdir_rotated;
		let rbminmax: vec3f = select(rbmin, rbmax, nrdir_rotated > vec3f(0.0));
		let fa: f32 = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		let posonbox: vec3f = vPositionW + nrdir_rotated * fa;
		let envBoxPos: vec3f = (uniform.envBoxMin + uniform.envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`,cubeMapRotatePS:`
#ifdef CUBEMAP_ROTATION
uniform cubeMapRotationMatrix: mat3x3f;
#endif
fn cubeMapRotate(refDir: vec3f) -> vec3f {
#ifdef CUBEMAP_ROTATION
	return refDir * uniform.cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,debugOutputPS:`
#ifdef DEBUG_ALBEDO_PASS
output.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
output.color = vec4f(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
output.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
output.color = vec4f(vec3f(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
output.color = vec4f(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
output.color = vec4f(vec3f(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
output.color = vec4f(vec3f(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
output.color = vec4f(vec3f(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
output.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,debugProcessFrontendPS:`
#ifdef DEBUG_LIGHTING_PASS
	litArgs_albedo = vec3f(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
	litArgs_albedo = vec3f(vUv0, 0.0);
#else
	litArgs_albedo = vec3f(0.0);
#endif
#endif
`,detailModesPS:`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
fn detailMode_mul(c1: vec3f, c2: vec3f) -> vec3f {
	return c1 * c2;
}
fn detailMode_add(c1: vec3f, c2: vec3f) -> vec3f {
	return c1 + c2;
}
fn detailMode_screen(c1: vec3f, c2: vec3f) -> vec3f {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
fn detailMode_overlay(c1: vec3f, c2: vec3f) -> vec3f {
	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3f(0.5)));
}
fn detailMode_min(c1: vec3f, c2: vec3f) -> vec3f {
	return min(c1, c2);
}
fn detailMode_max(c1: vec3f, c2: vec3f) -> vec3f {
	return max(c1, c2);
}
#endif
`,diffusePS:`
uniform material_diffuse: vec3f;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
fn getAlbedo() {
	dAlbedo = uniform.material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		var albedoTexture: vec3f = {STD_DIFFUSE_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_NAME}Sampler, {STD_DIFFUSE_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			var albedoDetail: vec3f = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_NAME}Sampler, {STD_DIFFUSEDETAIL_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo = dAlbedo * albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo = dAlbedo * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));
	#endif
}
`,decodePS:`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
fn decodeLinear(raw: vec4f) -> vec3f {
	return raw.rgb;
}
fn decodeGammaFloat(raw: f32) -> f32 {
	return pow(raw, 2.2);
}
fn decodeGamma3(raw: vec3f) -> vec3f {
	return pow(raw, vec3f(2.2));
}
fn decodeGamma(raw: vec4f) -> vec3f {
	return pow(raw.xyz, vec3f(2.2));
}
fn decodeRGBM(raw: vec4f) -> vec3f {
	let color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
fn decodeRGBP(raw: vec4f) -> vec3f {
	let color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
fn decodeRGBE(raw: vec4f) -> vec3f {
	return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);
}
fn passThrough(raw: vec4f) -> vec4f {
	return raw;
}
fn unpackNormalXYZ(nmap: vec4f) -> vec3f {
	return nmap.xyz * 2.0 - 1.0;
}
fn unpackNormalXY(nmap: vec4f) -> vec3f {
	var xy = nmap.wy * 2.0 - 1.0;
	return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));
}
#endif
`,emissivePS:`
uniform material_emissive: vec3f;
uniform material_emissiveIntensity: f32;
fn getEmission() {
	dEmission = uniform.material_emissive * uniform.material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(textureSampleBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_NAME}Sampler, {STD_EMISSIVE_TEXTURE_UV}, uniform.textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission = dEmission * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));
	#endif
}
`,encodePS:`
fn encodeLinear(source: vec3f) -> vec4f {
	return vec4f(source, 1.0);
}
fn encodeGamma(source: vec3f) -> vec4f {
	return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);
}
fn encodeRGBM(source: vec3f) -> vec4f {
	var color: vec3f = pow(source, vec3f(0.5));
	color *= 1.0 / 8.0;
	var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));
	a = ceil(a * 255.0) / 255.0;
	color /= a;
	return vec4f(color, a);
}
fn encodeRGBP(source: vec3f) -> vec4f {
	var gamma: vec3f = pow(source, vec3f(0.5));
	var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4f(gamma / (-v * 7.0 + 8.0), v);
}
fn encodeRGBE(source: vec3f) -> vec4f {
	var maxVal: f32 = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4f(0.0, 0.0, 0.0, 0.0);
	} else {
		var e: f32 = ceil(log2(maxVal));
		return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,endPS:`
	var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	finalRgb = finalRgb + litArgs_emission;
	finalRgb = addFog(finalRgb);
	finalRgb = toneMap(finalRgb);
	finalRgb = gammaCorrectOutput(finalRgb);
	output.color = vec4f(finalRgb, output.color.a);
`,envAtlasPS:`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const atlasSize : f32 = 512.0;
const seamSize : f32 = 1.0 / atlasSize;
fn mapUv(uv : vec2f, rect : vec4f) -> vec2f {
	return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
fn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {
	let t : f32 = 1.0 / exp2(level);
	return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));
}
fn mapShinyUv(uv : vec2f, level : f32) -> vec2f {
	let t : f32 = 1.0 / exp2(level);
	return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`,envProcPS:`
#ifdef LIT_SKYBOX_INTENSITY
	uniform skyboxIntensity : f32;
#endif
fn processEnvironment(color : vec3f) -> vec3f {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * uniform.skyboxIntensity;
	#else
		return color;
	#endif
}
`,falloffInvSquaredPS:`
fn getFalloffWindow(lightRadius: f32, lightDir: vec3f) -> f32 {
	let sqrDist: f32 = dot(lightDir, lightDir);
	let invRadius: f32 = 1.0 / lightRadius;
	return square(saturate(1.0 - square(sqrDist * square(invRadius))));
}
fn getFalloffInvSquared(lightRadius: f32, lightDir: vec3f) -> f32 {
	let sqrDist: f32 = dot(lightDir, lightDir);
	var falloff: f32 = 1.0 / (sqrDist + 1.0);
	let invRadius: f32 = 1.0 / lightRadius;
	falloff = falloff * 16.0;
	falloff = falloff * square(saturate(1.0 - square(sqrDist * square(invRadius))));
	return falloff;
}
`,falloffLinearPS:`
fn getFalloffLinear(lightRadius: f32, lightDir: vec3f) -> f32 {
	let d: f32 = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,floatAsUintPS:`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
fn float2uint(value: f32) -> vec4f {
	let intBits = bitcast<u32>(value);
	return vec4f(
		f32((intBits >> 24u) & 0xffu),
		f32((intBits >> 16u) & 0xffu),
		f32((intBits >> 8u) & 0xffu),
		f32(intBits & 0xffu)
	) / 255.0;
}
fn uint2float(value: vec4f) -> f32 {
	let rgba_u32 = vec4<u32>(value * 255.0);
	let intBits: u32 =
		(rgba_u32.r << 24u) |
		(rgba_u32.g << 16u) |
		(rgba_u32.b << 8u)  |
		 rgba_u32.a;
	return bitcast<f32>(intBits);
}
fn float2vec4(value: f32) -> vec4f {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4f(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`,fogPS:`
var<private> dBlendModeFogFactor : f32 = 1.0;
#if (FOG != NONE)
	uniform fog_color : vec3f;
	
	#if (FOG == LINEAR)
		uniform fog_start : f32;
		uniform fog_end : f32;
	#else
		uniform fog_density : f32;
	#endif
#endif
fn getFogFactor() -> f32 {
	let depth = pcPosition.z / pcPosition.w;
	var fogFactor : f32 = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * uniform.fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
fn addFog(color : vec3f) -> vec3f {
	#if (FOG != NONE)
		return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());
	#else
		return color;
	#endif
}
`,fresnelSchlickPS:`
fn getFresnel(
		cosTheta: f32,
		gloss: f32,
		specularity: vec3f
	#if defined(LIT_IRIDESCENCE)
		, iridescenceFresnel: vec3f,
		iridescenceIntensity: f32
	#endif
) -> vec3f {
	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);
	let glossSq: f32 = gloss * gloss;
	let ret: vec3f = specularity + (max(vec3f(glossSq), specularity) - specularity) * fresnel;
	#if defined(LIT_IRIDESCENCE)
		return mix(ret, iridescenceFresnel, iridescenceIntensity);
	#else
		return ret;
	#endif
}
fn getFresnelCC(cosTheta: f32) -> f32 {
	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}`,frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:`
attribute vertex_position: vec2f;
varying vUv0: vec2f;
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	output.position = vec4f(input.vertex_position, 0.5, 1.0);
	output.vUv0 = input.vertex_position.xy * 0.5 + vec2f(0.5);
	return output;
}
`,gammaPS:`
#include "decodePS"
#if (GAMMA == SRGB)
	fn gammaCorrectInput(color: f32) -> f32 {
		return decodeGammaFloat(color);
	}
	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
		return decodeGamma3(color);
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return vec4f(decodeGamma3(color.xyz), color.w);
	}
	fn gammaCorrectOutput(color: vec3f) -> vec3f {
		return pow(color + 0.0000001, vec3f(1.0 / 2.2));
	}
#else
	fn gammaCorrectInput(color: f32) -> f32 {
		return color;
	}
	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
		return color;
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return color;
	}
	fn gammaCorrectOutput(color: vec3f) -> vec3f {
		return color;
	}
#endif
`,glossPS:`
#ifdef STD_GLOSS_CONSTANT
	uniform material_gloss: f32;
#endif
fn getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness = dGlossiness * uniform.material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness = dGlossiness * textureSampleBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_NAME}Sampler, {STD_GLOSS_TEXTURE_UV}, uniform.textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness = dGlossiness * saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness = dGlossiness + 0.0000001;
}
`,gsplatCenterVS:`
uniform matrix_model: mat4x4f;
uniform matrix_view: mat4x4f;
uniform matrix_projection: mat4x4f;
fn initCenter(modelCenter: vec3f, center: ptr<function, SplatCenter>) -> bool {
	let modelView: mat4x4f = uniform.matrix_view * uniform.matrix_model;
	let centerView: vec4f = modelView * vec4f(modelCenter, 1.0);
	if (centerView.z > 0.0) {
		return false;
	}
	var centerProj: vec4f = uniform.matrix_projection * centerView;
	centerProj.z = clamp(centerProj.z, 0.0, abs(centerProj.w));
	center.view = centerView.xyz / centerView.w;
	center.proj = centerProj;
	center.projMat00 = uniform.matrix_projection[0][0];
	center.modelView = modelView;
	return true;
}
`,gsplatCornerVS:`
uniform viewport: vec2f;
uniform camera_params: vec4f;
fn initCorner(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>) -> bool {
	var covA: vec3f;
	var covB: vec3f;
	readCovariance(source, &covA, &covB);
	let Vrk = mat3x3f(
		vec3f(covA.x, covA.y, covA.z),
		vec3f(covA.y, covB.x, covB.y),
		vec3f(covA.z, covB.y, covB.z)
	);
	let focal = uniform.viewport.x * center.projMat00;
	let v = select(center.view.xyz, vec3f(0.0, 0.0, 1.0), uniform.camera_params.w == 1.0);
	let J1 = focal / v.z;
	let J2 = -J1 / v.z * v.xy;
	let J = mat3x3f(
		vec3f(J1, 0.0, J2.x),
		vec3f(0.0, J1, J2.y),
		vec3f(0.0, 0.0, 0.0)
	);
	let W = transpose(mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));
	let T = W * J;
	let cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		let detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[1][0];
		let detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[1][0];
		corner.aaFactor = sqrt(detOrig / detBlur);
	#endif
	let diagonal1 = cov[0][0] + 0.3;
	let offDiagonal = cov[0][1];
	let diagonal2 = cov[1][1] + 0.3;
	let mid = 0.5 * (diagonal1 + diagonal2);
	let radius = length(vec2f((diagonal1 - diagonal2) / 2.0, offDiagonal));
	let lambda1 = mid + radius;
	let lambda2 = max(mid - radius, 0.1);
	let vmin = min(1024.0, min(uniform.viewport.x, uniform.viewport.y));
	let l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);
	let l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	let c = center.proj.ww / uniform.viewport;
	if (any((abs(center.proj.xy) - vec2f(max(l1, l2)) * c) > center.proj.ww)) {
		return false;
	}
	let diagonalVector = normalize(vec2f(offDiagonal, lambda1 - diagonal1));
	let v1 = l1 * diagonalVector;
	let v2 = l2 * vec2f(diagonalVector.y, -diagonalVector.x);
	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;
	corner.uv = source.cornerUV;
	return true;
}
`,gsplatColorVS:`
var splatColor: texture_2d<f32>;
fn readColor(source: ptr<function, SplatSource>) -> vec4f {
	return textureLoad(splatColor, source.uv, 0);
}
`,gsplatCommonVS:`
struct SplatSource {
	order: u32,
	id: u32,
	uv: vec2<i32>,
	cornerUV: vec2f,
}
struct SplatCenter {
	view: vec3f,
	proj: vec4f,
	modelView: mat4x4f,
	projMat00: f32,
}
struct SplatCorner {
	offset: vec2f,
	uv: vec2f,
	#if GSPLAT_AA
		aaFactor: f32,
	#endif
}
fn quatToMat3(R: vec4<f32>) -> mat3x3<f32> {
	let R2: vec4<f32> = R + R;
	let X: f32	   = R2.x * R.w;
	let Y: vec4<f32> = R2.y * R;
	let Z: vec4<f32> = R2.z * R;
	let W: f32	   = R2.w * R.w;
	return mat3x3<f32>(
		1.0 - Z.z - W,  Y.z + X,	  Y.w - Z.x,
		Y.z - X,		1.0 - Y.y - W, Z.w + Y.x,
		Y.w + Z.x,	  Z.w - Y.x,	 1.0 - Y.y - Z.z
	);
}
#if SH_BANDS == 1
	const SH_COEFFS: i32 = 3;
#elif SH_BANDS == 2
	const SH_COEFFS: i32 = 8;
#elif SH_BANDS == 3
	const SH_COEFFS: i32 = 15;
#else
	const SH_COEFFS: i32 = 0;
#endif
#if GSPLAT_COMPRESSED_DATA
	#include "gsplatCompressedDataVS"
	#if SH_BANDS > 0
		#include "gsplatCompressedSHVS"
	#endif
#elif GSPLAT_SOGS_DATA
	#include "gsplatSogsDataVS"
	#include "gsplatSogsColorVS"
	#if SH_BANDS > 0
		#include "gsplatSogsSHVS"
	#endif
#else
	#include "gsplatDataVS"
	#include "gsplatColorVS"
	#if SH_BANDS > 0
		#include "gsplatSHVS"
	#endif
#endif
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
fn clipCorner(corner: ptr<function, SplatCorner>, alpha: f32) {
	let clip: f32 = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);
	corner.offset = corner.offset * clip;
	corner.uv = corner.uv * clip;
}
#if SH_BANDS > 0
	const SH_C1: f32 = 0.4886025119029199;
	#if SH_BANDS > 1
		const SH_C2_0: f32 = 1.0925484305920792;
		const SH_C2_1: f32 = -1.0925484305920792;
		const SH_C2_2: f32 = 0.31539156525252005;
		const SH_C2_3: f32 = -1.0925484305920792;
		const SH_C2_4: f32 = 0.5462742152960396;
	#endif
	#if SH_BANDS > 2
		const SH_C3_0: f32 = -0.5900435899266435;
		const SH_C3_1: f32 = 2.890611442640554;
		const SH_C3_2: f32 = -0.4570457994644658;
		const SH_C3_3: f32 = 0.3731763325901154;
		const SH_C3_4: f32 = -0.4570457994644658;
		const SH_C3_5: f32 = 1.445305721320277;
		const SH_C3_6: f32 = -0.5900435899266435;
	#endif
	fn evalSH(source: ptr<function, SplatSource>, dir: vec3f) -> vec3f {
		var sh: array<vec3f, SH_COEFFS>;
		var scale: f32;
		readSHData(source, &sh, &scale);
		let x = dir.x;
		let y = dir.y;
		let z = dir.z;
		var result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
		#if SH_BANDS > 1
			let xx = x * x;
			let yy = y * y;
			let zz = z * z;
			let xy = x * y;
			let yz = y * z;
			let xz = x * z;
			result = result + (
				sh[3] * (SH_C2_0 * xy) +
				sh[4] * (SH_C2_1 * yz) +
				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
				sh[6] * (SH_C2_3 * xz) +
				sh[7] * (SH_C2_4 * (xx - yy))
			);
		#endif
		#if SH_BANDS > 2
			result = result + (
				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
				sh[9]  * (SH_C3_1 * xy * z) +
				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
				sh[13] * (SH_C3_5 * z * (xx - yy)) +
				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy))
			);
		#endif
		return result * scale;
	}
#endif
`,gsplatCompressedDataVS:`
var packedTexture: texture_2d<u32>;
var chunkTexture: texture_2d<f32>;
var<private> chunkDataA: vec4f;
var<private> chunkDataB: vec4f;
var<private> chunkDataC: vec4f;
var<private> chunkDataD: vec4f;
var<private> chunkDataE: vec4f;
var<private> packedData: vec4u;
fn unpack111011(bits: u32) -> vec3f {
	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu))) / vec3f(2047.0, 1023.0, 2047.0);
}
fn unpack8888(bits: u32) -> vec4f {
	return vec4f(
		f32((bits >> 24u) & 0xffu),
		f32((bits >> 16u) & 0xffu),
		f32((bits >> 8u)  & 0xffu),
		f32(bits		 & 0xffu)
	) / 255.0;
}
const norm_const: f32 = 1.0 / (sqrt(2.0) * 0.5);
fn unpackRotation(bits: u32) -> vec4f {
	let a = (f32((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let b = (f32((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let c = (f32(bits & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let m = sqrt(1.0 - (a * a + b * b + c * c));
	let mode = bits >> 30u;
	if (mode == 0u) { return vec4f(m, a, b, c); }
	if (mode == 1u) { return vec4f(a, m, b, c); }
	if (mode == 2u) { return vec4f(a, b, m, c); }
	return vec4f(a, b, c, m);
}
fn readCenter(source: ptr<function, SplatSource>) -> vec3f {
	let tex_size_u = textureDimensions(chunkTexture, 0);
	let w: u32 = tex_size_u.x / 5u;
	let chunkId: u32 = source.id / 256u;
	let chunkUV: vec2<i32> = vec2<i32>(i32((chunkId % w) * 5u), i32(chunkId / w));
	chunkDataA = textureLoad(chunkTexture, chunkUV + vec2<i32>(0, 0), 0);
	chunkDataB = textureLoad(chunkTexture, chunkUV + vec2<i32>(1, 0), 0);
	chunkDataC = textureLoad(chunkTexture, chunkUV + vec2<i32>(2, 0), 0);
	chunkDataD = textureLoad(chunkTexture, chunkUV + vec2<i32>(3, 0), 0);
	chunkDataE = textureLoad(chunkTexture, chunkUV + vec2<i32>(4, 0), 0);
	packedData = textureLoad(packedTexture, source.uv, 0);
	return mix(chunkDataA.xyz, vec3f(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
fn readColor(source: ptr<function, SplatSource>) -> vec4f {
	let r = unpack8888(packedData.w);
	return vec4f(mix(chunkDataD.xyz, vec3f(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
fn getRotation() -> vec4f {
	return unpackRotation(packedData.y);
}
fn getScale() -> vec3f {
	return exp(mix(vec3f(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
fn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let rot = quatToMat3(getRotation());
	let scale = getScale();
	let M = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,gsplatCompressedSHVS:`
#if SH_BANDS > 0
var shTexture0: texture_2d<u32>;
var shTexture1: texture_2d<u32>;
var shTexture2: texture_2d<u32>;
fn unpack8888s(bits: u32) -> vec4f {
	let unpacked_u = (vec4<u32>(bits) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);
	return vec4f(unpacked_u) * (8.0 / 255.0) - 4.0;
}
fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {
	let shData0: vec4<u32> = textureLoad(shTexture0, source.uv, 0);
	let shData1: vec4<u32> = textureLoad(shTexture1, source.uv, 0);
	let shData2: vec4<u32> = textureLoad(shTexture2, source.uv, 0);
	let r0 = unpack8888s(shData0.x);
	let r1 = unpack8888s(shData0.y);
	let r2 = unpack8888s(shData0.z);
	let r3 = unpack8888s(shData0.w);
	let g0 = unpack8888s(shData1.x);
	let g1 = unpack8888s(shData1.y);
	let g2 = unpack8888s(shData1.z);
	let g3 = unpack8888s(shData1.w);
	let b0 = unpack8888s(shData2.x);
	let b1 = unpack8888s(shData2.y);
	let b2 = unpack8888s(shData2.z);
	let b3 = unpack8888s(shData2.w);
	sh[0] =  vec3f(r0.x, g0.x, b0.x);
	sh[1] =  vec3f(r0.y, g0.y, b0.y);
	sh[2] =  vec3f(r0.z, g0.z, b0.z);
	sh[3] =  vec3f(r0.w, g0.w, b0.w);
	sh[4] =  vec3f(r1.x, g1.x, b1.x);
	sh[5] =  vec3f(r1.y, g1.y, b1.y);
	sh[6] =  vec3f(r1.z, g1.z, b1.z);
	sh[7] =  vec3f(r1.w, g1.w, b1.w);
	sh[8] =  vec3f(r2.x, g2.x, b2.x);
	sh[9] =  vec3f(r2.y, g2.y, b2.y);
	sh[10] = vec3f(r2.z, g2.z, b2.z);
	sh[11] = vec3f(r2.w, g2.w, b2.w);
	sh[12] = vec3f(r3.x, g3.x, b3.x);
	sh[13] = vec3f(r3.y, g3.y, b3.y);
	sh[14] = vec3f(r3.z, g3.z, b3.z);
	*scale = 1.0;
}
#endif
`,gsplatSogsColorVS:`
var sh0: texture_2d<f32>;
uniform sh0_mins: vec4f;
uniform sh0_maxs: vec4f;
const SH_C0: f32 = 0.28209479177387814;
fn readColor(source: ptr<function, SplatSource>) -> vec4f {
	let clr: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));
	return vec4f(vec3f(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));
}
`,gsplatSogsDataVS:`
var means_u: texture_2d<f32>;
var means_l: texture_2d<f32>;
var quats: texture_2d<f32>;
var scales: texture_2d<f32>;
uniform means_mins: vec3f;
uniform means_maxs: vec3f;
uniform scales_mins: vec3f;
uniform scales_maxs: vec3f;
fn readCenter(source: ptr<function, SplatSource>) -> vec3f {
	let u: vec3f = textureLoad(means_u, source.uv, 0).xyz;
	let l: vec3f = textureLoad(means_l, source.uv, 0).xyz;
	let n: vec3f = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;
	let v: vec3f = mix(uniform.means_mins, uniform.means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
const norm: f32 = 2.0 / sqrt(2.0);
fn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let qdata: vec4f = textureLoad(quats, source.uv, 0);
	let abc: vec3f = (qdata.xyz - 0.5) * norm;
	let d: f32 = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	let mode: u32 = u32(qdata.w * 255.0 + 0.5) - 252u;
	var quat: vec4f;
	if (mode == 0u) {
		quat = vec4f(d, abc);
	} else if (mode == 1u) {
		quat = vec4f(abc.x, d, abc.y, abc.z);
	} else if (mode == 2u) {
		quat = vec4f(abc.x, abc.y, d, abc.z);
	} else {
		quat = vec4f(abc.x, abc.y, abc.z, d);
	}
	let rot: mat3x3f = quatToMat3(quat);
	let scale: vec3f = exp(mix(uniform.scales_mins, uniform.scales_maxs, textureLoad(scales, source.uv, 0).xyz));
	let M: mat3x3f = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,gsplatSogsSHVS:`
var sh_labels: texture_2d<f32>;
var sh_centroids: texture_2d<f32>;
uniform shN_mins: f32;
uniform shN_maxs: f32;
fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, SH_COEFFS>>, scale: ptr<function, f32>) {
	let t: vec2<i32> = vec2<i32>(textureLoad(sh_labels, source.uv, 0).xy * 255.0);
	let n: i32 = t.x + t.y * 256;
	let u: i32 = (n % 64) * SH_COEFFS;
	let v: i32 = n / 64;
	for (var i: i32 = 0; i < SH_COEFFS; i = i + 1) {
		sh[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), textureLoad(sh_centroids, vec2<i32>(u + i, v), 0).xyz);
	}
	*scale = 1.0;
}
`,gsplatDataVS:`
var transformA: texture_2d<u32>;
var transformB: texture_2d<f32>;
var<private> tAw: u32;
fn readCenter(source: ptr<function, SplatSource>) -> vec3f {
	let tA: vec4<u32> = textureLoad(transformA, source.uv, 0);
	tAw = tA.w;
	return bitcast<vec3f>(tA.xyz);
}
fn unpackRotation(packed: vec3f) -> vec4f {
	return vec4f(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
fn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let tB: vec4f = textureLoad(transformB, source.uv, 0);
	let rot: mat3x3f = quatToMat3(unpackRotation(vec3f(unpack2x16float(bitcast<u32>(tAw)), tB.w)).wxyz);
	let scale: vec3f = tB.xyz;
	let M = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,gsplatOutputVS:`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
fn prepareOutputFromGamma(gammaColor: vec3f) -> vec3f {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma3(gammaColor);
		#else 
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma3(gammaColor)));
	#endif
}
`,gsplatPS:`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying id: f32;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform alphaClip: f32;
#endif
#ifdef PREPASS_PASS
	varying vLinearDepth: f32;
	#include "floatAsUintPS"
#endif
const EXP_A: f32	  = 12102203.0;
const EXP_BC_RMS: i32 = 1064866808;
fn fastExp(x: f32) -> f32 {
	var i: i32 = i32(EXP_A * x) + EXP_BC_RMS;
	return bitcast<f32>(i);
}
varying gaussianUV: vec2f;
varying gaussianColor: vec4f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let A: f32 = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
		return output;
	}
	var alpha: f32 = fastExp(-A * 4.0) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < uniform.alphaClip) {
			discard;
			return output;
		}
	#endif
	#ifdef PICK_PASS
		output.color = getPickOutput();
	#elif SHADOW_PASS
		output.color = vec4f(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		output.color = float2vec4(vLinearDepth);
	#else
		if (alpha < (1.0 / 255.0)) {
			discard;
			return output;
		}
		#ifndef DITHER_NONE
			opacityDither(&alpha, id * 0.013);
		#endif
		output.color = vec4f(input.gaussianColor.xyz * alpha, alpha);
	#endif
	return output;
}`,gsplatSHVS:`
#if SH_BANDS > 0
fn unpack111011s(bits: u32) -> vec3f {
	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu)) / vec3f(2047.0, 1023.0, 2047.0)) * 2.0 - 1.0;
}
struct ScaleAndSH {
	scale: f32,
	a: vec3f,
	b: vec3f,
	c: vec3f
};
fn fetchScale(t_in: vec4<u32>) -> ScaleAndSH {
	var result: ScaleAndSH;
	result.scale = bitcast<f32>(t_in.x);
	result.a = unpack111011s(t_in.y);
	result.b = unpack111011s(t_in.z);
	result.c = unpack111011s(t_in.w);
	return result;
}
struct SH {
	a: vec3f,
	b: vec3f,
	c: vec3f,
	d: vec3f
};
fn fetch4(t_in: vec4<u32>) -> SH {
	var result: SH;
	result.a = unpack111011s(t_in.x);
	result.b = unpack111011s(t_in.y);
	result.c = unpack111011s(t_in.z);
	result.d = unpack111011s(t_in.w);
	return result;
}
fn fetch1(t_in: u32) -> vec3f {
	return unpack111011s(t_in);
}
#if SH_BANDS == 1
	var splatSH_1to3: texture_2d<u32>;
	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 3>>, scale: ptr<function, f32>) {
		let result = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));
		*scale = result.scale;
		sh[0] = result.a;
		sh[1] = result.b;
		sh[2] = result.c;
	}
#elif SH_BANDS == 2
	var splatSH_1to3: texture_2d<u32>;
	var splatSH_4to7: texture_2d<u32>;
	var splatSH_8to11: texture_2d<u32>;
	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 8>>, scale: ptr<function, f32>) {
		let first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));
		*scale = first.scale;
		sh[0] = first.a;
		sh[1] = first.b;
		sh[2] = first.c;
		let second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));
		sh[3] = second.a;
		sh[4] = second.b;
		sh[5] = second.c;
		sh[6] = second.d;
		sh[7] = fetch1(textureLoad(splatSH_8to11, source.uv, 0).x);
	}
#else
	var splatSH_1to3: texture_2d<u32>;
	var splatSH_4to7: texture_2d<u32>;
	var splatSH_8to11: texture_2d<u32>;
	var splatSH_12to15: texture_2d<u32>;
	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {
		let first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));
		*scale = first.scale;
		sh[0] = first.a;
		sh[1] = first.b;
		sh[2] = first.c;
		let second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));
		sh[3] = second.a;
		sh[4] = second.b;
		sh[5] = second.c;
		sh[6] = second.d;
		let third: SH = fetch4(textureLoad(splatSH_8to11, source.uv, 0));
		sh[7] = third.a;
		sh[8] = third.b;
		sh[9] = third.c;
		sh[10] = third.d;
		let fourth: SH = fetch4(textureLoad(splatSH_12to15, source.uv, 0));
		sh[11] = fourth.a;
		sh[12] = fourth.b;
		sh[13] = fourth.c;
		sh[14] = fourth.d;
	}
#endif
#endif
`,gsplatSourceVS:`
attribute vertex_position: vec3f;
attribute vertex_id_attrib: u32;
uniform numSplats: u32;
var splatOrder: texture_2d<u32>;
fn initSource(source: ptr<function, SplatSource>) -> bool {
	let w: u32 = textureDimensions(splatOrder, 0).x;
	source.order = vertex_id_attrib + u32(vertex_position.z);
	if (source.order >= uniform.numSplats) {
		return false;
	}
	let orderUV = vec2i(vec2u(source.order % w, source.order / w));
	source.id = textureLoad(splatOrder, orderUV, 0).r;
	source.uv = vec2i(vec2u(source.id % w, source.id / w));
	source.cornerUV = vertex_position.xy;
	return true;
}
`,gsplatVS:`
#include "gsplatCommonVS"
varying gaussianUV: vec2f;
varying gaussianColor: vec4f;
#ifndef DITHER_NONE
	varying id: f32;
#endif
const discardVec: vec4f = vec4f(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying vLinearDepth: f32;
#endif
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	var source: SplatSource;
	if (!initSource(&source)) {
		output.position = discardVec;
		return output;
	}
	let modelCenter: vec3f = readCenter(&source);
	var center: SplatCenter;
	if (!initCenter(modelCenter, &center)) {
		output.position = discardVec;
		return output;
	}
	var corner: SplatCorner;
	if (!initCorner(&source, &center, &corner)) {
		output.position = discardVec;
		return output;
	}
	var clr: vec4f = readColor(&source);
	#if GSPLAT_AA
		clr.a = clr.a * corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		let modelView3x3 = mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz);
		let dir = normalize(modelView3x3 * center.view);
		clr = vec4f(clr.xyz + evalSH(&source, dir), clr.a);
	#endif
	clipCorner(&corner, clr.w);
	output.position = center.proj + vec4f(corner.offset, 0.0, 0.0);
	output.gaussianUV = corner.uv;
	output.gaussianColor = vec4f(prepareOutputFromGamma(max(clr.xyz, vec3f(0.0))), clr.w);
	#ifndef DITHER_NONE
		output.id = f32(source.id);
	#endif
	#ifdef PREPASS_PASS
		output.vLinearDepth = -center.view.z;
	#endif
	return output;
}
`,quadVS:`
	attribute aPosition: vec2f;
	varying uv0: vec2f;
	@vertex fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.aPosition, 0.0, 1.0);
		output.uv0 = getImageEffectUV((input.aPosition + 1.0) * 0.5);
		return output;
	}
`,immediateLinePS:`
	#include "gammaPS"
	varying color: vec4f;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);
		return output;
	}
`,immediateLineVS:`
	attribute vertex_position: vec4f;
	attribute vertex_color: vec4f;
	uniform matrix_model: mat4x4f;
	uniform matrix_viewProjection: mat4x4f;
	varying color: vec4f;
	@vertex
	fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.color = input.vertex_color;
		output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;
		return output;
	}
`,iridescenceDiffractionPS:`
uniform material_iridescenceRefractionIndex: f32;
fn iridescence_iorToFresnelScalar(transmittedIor: f32, incidentIor: f32) -> f32 {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
fn iridescence_iorToFresnelVec3(transmittedIor: vec3f, incidentIor: f32) -> vec3f {
	return pow((transmittedIor - vec3f(incidentIor)) / (transmittedIor + vec3f(incidentIor)), vec3f(2.0));
}
fn iridescence_fresnelToIor(f0: vec3f) -> vec3f {
	let sqrtF0: vec3f = sqrt(f0);
	return (vec3f(1.0) + sqrtF0) / (vec3f(1.0) - sqrtF0);
}
const XYZ_TO_REC709: mat3x3f = mat3x3f(
	vec3f(3.2404542, -1.5371385, -0.4985314),
	vec3f(-0.9692660,  1.8760108,  0.0415560),
	vec3f(0.0556434, -0.2040259,  1.0572252)
);
fn iridescence_sensitivity(opd: f32, shift: vec3f) -> vec3f {
	let PI: f32 = 3.141592653589793;
	let phase: f32 = 2.0 * PI * opd * 1.0e-9;
	const val: vec3f = vec3f(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const pos: vec3f = vec3f(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const var_: vec3f = vec3f(4.3278e+09, 9.3046e+09, 6.6121e+09);
	var xyz: vec3f = val * sqrt(2.0 * PI * var_) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var_);
	xyz.x = xyz.x + 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz = xyz / vec3f(1.0685e-07);
	return XYZ_TO_REC709 * xyz;
}
fn iridescence_fresnelScalar(cosTheta: f32, f0: f32) -> f32 {
	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);
	let x2: f32 = x * x;
	let x5: f32 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
}
fn iridescence_fresnelVec3(cosTheta: f32, f0: vec3f) -> vec3f {
	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);
	let x2: f32 = x * x;
	let x5: f32 = x * x2 * x2;
	return f0 + (vec3f(1.0) - f0) * x5;
}
fn calcIridescence(outsideIor: f32, cosTheta: f32, base_f0: vec3f, iridescenceThickness: f32) -> vec3f {
	let PI: f32 = 3.141592653589793;
	let iridescenceIor: f32 = mix(outsideIor, uniform.material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	let sinTheta2Sq: f32 = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	let cosTheta2Sq: f32 = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3f(1.0);
	}
	let cosTheta2: f32 = sqrt(cosTheta2Sq);
	let r0: f32 = iridescence_iorToFresnelScalar(iridescenceIor, outsideIor);
	let r12: f32 = iridescence_fresnelScalar(cosTheta, r0);
	let r21: f32 = r12;
	let t121: f32 = 1.0 - r12;
	let phi12: f32 = select(0.0, PI, iridescenceIor < outsideIor);
	let phi21: f32 = PI - phi12;
	let baseIor: vec3f = iridescence_fresnelToIor(base_f0 + vec3f(0.0001));
	let r1: vec3f = iridescence_iorToFresnelVec3(baseIor, iridescenceIor);
	let r23: vec3f = iridescence_fresnelVec3(cosTheta2, r1);
	let phi23: vec3f = select(vec3f(0.0), vec3f(PI), baseIor < vec3f(iridescenceIor));
	let opd: f32 = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	let phi: vec3f = vec3f(phi21) + phi23;
	let r123Sq: vec3f = clamp(vec3f(r12) * r23, vec3f(1e-5), vec3f(0.9999));
	let r123: vec3f = sqrt(r123Sq);
	let rs: vec3f = pow(vec3f(t121), vec3f(2.0)) * r23 / (vec3f(1.0) - r123Sq);
	let c0: vec3f = vec3f(r12) + rs;
	var i_irid: vec3f = c0;
	var cm: vec3f = rs - vec3f(t121);
	cm = cm * r123;
	let sm1: vec3f = 2.0 * iridescence_sensitivity(1.0 * opd, 1.0 * phi);
	i_irid = i_irid + cm * sm1;
	cm = cm * r123;
	let sm2: vec3f = 2.0 * iridescence_sensitivity(2.0 * opd, 2.0 * phi);
	i_irid = i_irid + cm * sm2;
	return max(i_irid, vec3f(0.0));
}
fn getIridescenceDiffraction(cosTheta: f32, specularity: vec3f, iridescenceThickness: f32) -> vec3f {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,iridescencePS:`
#ifdef STD_IRIDESCENCE_CONSTANT
	uniform material_iridescence: f32;
#endif
fn getIridescence() {
	var iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence = iridescence * uniform.material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence = iridescence * textureSampleBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_NAME}Sampler, {STD_IRIDESCENCE_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`,iridescenceThicknessPS:`
uniform material_iridescenceThicknessMax: f32;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
	uniform material_iridescenceThicknessMin: f32;
#endif
fn getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		var blend: f32 = textureSampleBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}Sampler, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		var iridescenceThickness: f32 = mix(uniform.material_iridescenceThicknessMin, uniform.material_iridescenceThicknessMax, blend);
	#else
		var iridescenceThickness: f32 = uniform.material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,iorPS:`
#ifdef STD_IOR_CONSTANT
	uniform material_refractionIndex: f32;
#endif
fn getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = uniform.material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,lightDeclarationPS:`
#if defined(LIGHT{i})
	uniform light{i}_color: vec3f;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform light{i}_direction: vec3f;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform light{i}_position: vec3f;
		uniform light{i}_radius: f32;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform light{i}_direction: vec3f;
			uniform light{i}_innerConeAngle: f32;
			uniform light{i}_outerConeAngle: f32;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform light{i}_position: vec3f;
		#endif
		uniform light{i}_halfWidth: vec3f;
		uniform light{i}_halfHeight: vec3f;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		uniform light{i}_shadowMatrix: mat4x4f;
		uniform light{i}_shadowIntensity: f32;
		uniform light{i}_shadowParams: vec4f;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform light{i}_shadowSearchArea: f32;
			uniform light{i}_cameraParams: vec4f;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform light{i}_softShadowParams: vec4f;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform light{i}_shadowMatrixPalette: array<mat4x4f, 4>;
			uniform light{i}_shadowCascadeDistances: vec4f;
			uniform light{i}_shadowCascadeCount: i32;
			uniform light{i}_shadowCascadeBlend: f32;
		#endif
		#if LIGHT{i}TYPE == OMNI
			NOT SUPPORTED
			
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				var light{i}_shadowMap: texture_depth_2d;
				var light{i}_shadowMapSampler: sampler_comparison;
			#else
				var light{i}_shadowMap: texture_2d<f32>;
				var light{i}_shadowMapSampler: sampler;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			NOT SUPPORTED
		#endif
		#if LIGHT{i}TYPE == SPOT
			NOT SUPPORTED
		#endif
	#endif
#endif
`,lightDiffuseLambertPS:`
fn getLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f) -> f32 {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,lightDirPointPS:`
fn evalOmniLight(lightPosW: vec3f) -> vec3f {
	return vPositionW - lightPosW;
}
`,lightEvaluationPS:`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`,lightFunctionLightPS:`
#if defined(LIGHT{i})
fn evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		iridescenceFresnel: vec3f
	#endif
) {
	var lightColor: vec3f = uniform.light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(lightColor == vec3f(0.0, 0.0, 0.0))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = uniform.light{i}_direction;
		dAtten = 1.0;
	#else
		var lightDirW: vec3f = evalOmniLight(uniform.light{i}_position);
		dLightDirNormW = normalize(lightDirW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						var cookieAttenuation: vec3f = getCookie2DXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						var cookieAttenuation: vec3f = getCookie2D(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						var cookieAttenuation: vec3f = getCookie2DClipXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						var cookieAttenuation: vec3f = getCookie2DClip(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				var cookieAttenuation: vec3f = getCookieCube(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor = lightColor * cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(uniform.light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(uniform.light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(uniform.light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten = dAtten * getSpotEffect(uniform.light{i}_direction, uniform.light{i}_innerConeAngle, uniform.light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			var attenDiffuse: f32 = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				var attenDiffuse: f32 = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				var attenDiffuse: f32 = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				var attenDiffuse: f32 = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten = dAtten * getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			var shadow: f32 = getShadow{i}(vec3(0.0));
		#else
			var shadow: f32 = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, uniform.light{i}_shadowIntensity);
		dAtten = dAtten * shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher = dShadowCatcher * shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight + (((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres));
		#else
			dDiffuseLight = dDiffuseLight + ((attenDiffuse * dAtten) * lightColor);
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight = dDiffuseLight + ((dAtten * lightColor) * (1.0 - litArgs_specularity));
		#else
			dDiffuseLight = dDiffuseLight + (dAtten * lightColor);
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				var halfDirW: vec3f = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				var lightspecularCC: vec3f = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC = lightspecularCC * getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight = ccSpecularLight + lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight = sSpecularLight + (getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor);
			#endif
			#ifdef LIT_SPECULAR
				var lightSpecular: vec3f = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular = lightSpecular * litArgs_specularity;
				#endif
				
				dSpecularLight = dSpecularLight + lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`,lightFunctionShadowPS:`
#ifdef LIGHT{i}CASTSHADOW
	fn getShadowSampleCoord{i}(shadowTransform: mat4x4f, shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
		var surfacePosition = worldPosition;
		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				let distScale: f32 = length(*lightDir);
				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				*lightDir = surfacePosition - lightPos;
				return *lightDir;
			#endif
		#else
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						var distScale: f32 = 1.0;
					#else
						var distScale: f32 = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			var positionInShadowSpace: vec4f = shadowTransform * vec4f(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz = positionInShadowSpace.xyz / positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy = positionInShadowSpace.xy / positionInShadowSpace.w;
					positionInShadowSpace.z = length(*lightDir) * shadowParams.w;
				#endif
			#endif
			#ifdef SHADOW_SAMPLE_Z_BIAS
			#endif
			surfacePosition = positionInShadowSpace.xyz;
		#endif
		return surfacePosition;
	}
	fn getShadow{i}(lightDirW_in: vec3f) -> f32 {
		#ifdef LIGHT{i}_SHADOW_CASCADES
			var cascadeIndex: i32 = getShadowCascadeIndex(uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount);
			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount, uniform.light{i}_shadowCascadeBlend);
			#endif
			var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrixPalette[cascadeIndex];
		#else
			var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrix;
		#endif
		var lightDirArg = lightDirW_in;
		#if LIGHT{i}TYPE == DIRECTIONAL
			var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, vec3f(0.0), &lightDirArg, dLightDirNormW, dVertexNormalW);
		#else
			 var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, uniform.light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					let shadowSearchArea = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
				#else
					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, uniform.light{i}_softShadowParams, lightDirW_in);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
				#else
					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				 var shadowSearchArea: vec2f;
				 #if LIGHT{i}SHAPE != PUNCTUAL
					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
				#else
					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);
			#endif
		#endif
	}
#endif
`,lightingPS:`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	var areaLightsLutTex1: texture_2d<f32>;
	var areaLightsLutTex1Sampler: sampler;
	var areaLightsLutTex2: texture_2d<f32>;
	var areaLightsLutTex2Sampler: sampler;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`,lightmapAddPS:`
fn addLightMap(
	lightmap: vec3f,
	dir: vec3f,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
	gloss: f32,
	specularity: vec3f,
	vertexNormal: vec3f,
	tbn: mat3x3f
#if defined(LIT_IRIDESCENCE)
	, iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight = dDiffuseLight + lightmap;
		} else {
			let vlight: f32 = saturate(dot(dir, -vertexNormal));
			let flight: f32 = saturate(dot(dir, -worldNormal));
			let nlight: f32 = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight = dDiffuseLight + lightmap * nlight * 2.0;
			let halfDir: vec3f = normalize(-dir + viewDir);
			var specularLight: vec3f = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight = specularLight *
					getFresnel(dot(viewDir, halfDir),
					gloss,
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight = dSpecularLight + specularLight;
		}
	#else
		dDiffuseLight = dDiffuseLight + lightmap;
	#endif
}
`,lightmapPS:`
#ifdef STD_LIGHTMAP_DIR
	var<private> dLightmapDir: vec3f;
	var texture_dirLightMap: texture_2d<f32>;
	var texture_dirLightMapSampler: sampler;
#endif
fn getLightMap() {
	dLightmap = vec3f(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap = dLightmap * {STD_LIGHT_TEXTURE_DECODE}(textureSampleBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_NAME}Sampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			var dir: vec3f = textureSampleBias(texture_dirLightMap, texture_dirLightMapSampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias).xyz * 2.0 - 1.0;
			var dirDot = dot(dir, dir);
			dLightmapDir = select(vec3(0.0), dir / sqrt(dirDot), dirDot > 0.001);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap = dLightmap * saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`,lightSpecularAnisoGGXPS:`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f, tbn: mat3x3f) -> f32 {
	let PI: f32 = 3.141592653589793;
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	let alphaRoughness: f32 = roughness * roughness;
	let anisotropy: f32 = dAnisotropy;
	let direction: vec2f = dAnisotropyRotation;
	let at: f32 = mix(alphaRoughness, 1.0, anisotropy * anisotropy);
	let ab: f32 = clamp(alphaRoughness, 0.001, 1.0);
	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));
	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));
	let NoH: f32 = dot(worldNormal, h);
	let ToH: f32 = dot(anisotropicT, h);
	let BoH: f32 = dot(anisotropicB, h);
	let a2: f32 = at * ab;
	let v: vec3f = vec3f(ab * ToH, at * BoH, a2 * NoH);
	let v2: f32 = dot(v, v);
	let w2: f32 = a2 / v2;
	let D: f32 = a2 * w2 * w2 * (1.0 / PI);
	let ToV: f32 = dot(anisotropicT, viewDir);
	let BoV: f32 = dot(anisotropicB, viewDir);
	let ToL: f32 = dot(anisotropicT, -lightDirNorm);
	let BoL: f32 = dot(anisotropicB, -lightDirNorm);
	let NoV: f32 = dot(worldNormal, viewDir);
	let NoL: f32 = dot(worldNormal, -lightDirNorm);
	let lambdaV: f32 = NoL * length(vec3f(at * ToV, ab * BoV, NoV));
	let lambdaL: f32 = NoV * length(vec3f(at * ToL, ab * BoL, NoL));
	let G: f32 = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,lightSpecularBlinnPS:`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, h: vec3f) -> f32 {
	let nh: f32 = max( dot( h, worldNormal ), 0.0 );
	var specPow: f32 = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,lightSheenPS:`
fn sheenD(normal: vec3f, h: vec3f, roughness: f32) -> f32 {
	let PI: f32 = 3.141592653589793;
	let invR: f32 = 1.0 / (roughness * roughness);
	var cos2h: f32 = max(dot(normal, h), 0.0);
	cos2h = cos2h * cos2h;
	let sin2h: f32 = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
fn sheenV(normal: vec3f, viewDir: vec3f, light: vec3f) -> f32 {
	let NoV: f32 = max(dot(normal, viewDir), 0.000001);
	let NoL: f32 = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
fn getLightSpecularSheen(h: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, sheenGloss: f32) -> f32 {
	let D: f32 = sheenD(worldNormal, h, sheenGloss);
	let V: f32 = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}`,linearizeDepthPS:`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
fn linearizeDepthWithParams(z: f32, cameraParams: vec4f) -> f32 {
	if (cameraParams.w == 0.0) {
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	} else {
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
	}
}
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
fn linearizeDepth(z: f32) -> f32 {
	return linearizeDepthWithParams(z, uniform.camera_params);
}
#endif
`,litForwardBackendPS:`
fn evaluateBackend() -> FragmentOutput {
	var output: FragmentOutput;
	#ifdef LIT_SSAO
		litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * uniform.ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			var f0: f32 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 = f0 * f0;
			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			var iridescenceFresnel: vec3f = getIridescenceDiffraction(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			var dAmbientLight: vec3f = dDiffuseLight;
			dDiffuseLight = vec3(0.0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight = dDiffuseLight * uniform.material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection = ccReflection * ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection = ccReflection * litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection = vec4f(
					dReflection.rgb * getFresnel(
						dot(dViewDirW, litArgs_worldNormal),
						litArgs_gloss,
						litArgs_specularity
					#if defined(LIT_IRIDESCENCE)
						, iridescenceFresnel,
						litArgs_iridescence_intensity
					#endif
						),
					dReflection.a
				);
			#else
				dReflection = vec4f(dReflection.rgb * litArgs_specularity, dReflection.a);
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				dReflection = vec4f(dReflection.rgb * litArgs_specularityFactor, dReflection.a);
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight = dSpecularLight * litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#ifdef LIGHT_COUNT > 0
			#include "lightEvaluationPS, LIGHT_COUNT"
		#endif
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1.0);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#ifdef LIT_SPECULARITY_FACTOR
		dSpecularLight = dSpecularLight * litArgs_specularityFactor;
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity = litArgs_opacity * uniform.material_alphaFade;
	#endif
	#ifdef LIT_LIGHTMAP_BAKING
		#ifdef LIT_LIGHTMAP_BAKING_COLOR
			#include "bakeLmEndPS"
		#endif
		#ifdef LIT_LIGHTMAP_BAKING_DIR
			#include "bakeDirLmEndPS"
		#endif
	#else
		#include "endPS"
		#include "outputAlphaPS"
	#endif
	#ifdef LIT_MSDF
		output.color = applyMsdf(output.color);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		output.color = vec4f(vec3f(dShadowCatcher), output.color.a);
	#endif
	return output;
}
`,litForwardDeclarationPS:`
var<private> sReflection: vec3f;
var<private> dVertexNormalW: vec3f;
var<private> dTangentW: vec3f;
var<private> dBinormalW: vec3f;
var<private> dViewDirW: vec3f;
var<private> dReflDirW: vec3f;
var<private> ccReflDirW: vec3f;
var<private> dLightDirNormW: vec3f;
var<private> dAtten: f32;
var<private> dTBN: mat3x3f;
var<private> dReflection: vec4f;
var<private> dDiffuseLight: vec3f;
var<private> dSpecularLight: vec3f;
var<private> ccFresnel: f32;
var<private> ccReflection: vec3f;
var<private> ccSpecularLight: vec3f;
var<private> ccSpecularityNoFres: f32;
var<private> sSpecularLight: vec3f;
#ifdef LIT_DISPERSION
	uniform material_dispersion: f32;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform material_alphaFade: f32;
#endif
#ifdef LIT_SSAO
	var ssaoTexture : texture_2d<f32>;
	var ssaoTextureSampler : sampler;
	uniform ssaoTextureSizeInv: vec2f;
#endif
#ifdef LIT_SHADOW_CATCHER
	var<private> dShadowCatcher: f32 = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
#ifdef STD_LIGHTMAP_DIR
	uniform bakeDir: f32;
#endif
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	uniform ambientBakeOcclusionContrast: f32;
	uniform ambientBakeOcclusionBrightness: f32;
#endif
`,litForwardMainPS:`
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	dReflection = vec4f(0.0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3f(0.0);
		ccReflection = vec3f(0.0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	var output: FragmentOutput = evaluateBackend();
	#include "litUserMainEndPS"
	return output;
}
`,litForwardPostCodePS:`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
uniform material_ambient: vec3f;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#include "lightSpecularAnisoGGXPS"
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_GGX_SPECULAR
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`,litForwardPreCodePS:`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`,litMainPS:`
#include "varyingsPS"
#include "litUserDeclarationPS"
#include "frontendDeclPS"
#if defined(PICK_PASS) || defined(PREPASS_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litOtherMainPS"
#elif defined(SHADOW_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litShadowMainPS"
#else
	#include "litForwardDeclarationPS"
	#include "litForwardPreCodePS"
	#include "frontendCodePS"
	#include "litForwardPostCodePS"
	#include "litForwardBackendPS"
	#include "litUserCodePS"
	#include "litForwardMainPS"
#endif
`,litMainVS:`
#include "varyingsVS"
#include  "litUserDeclarationVS"
#ifdef VERTEX_COLOR
	attribute vertex_color: vec4f;
#endif
#ifdef NINESLICED
	varying vMask: vec2f;
	varying vTiledUv: vec2f;
	var<private> dMaskGlobal: vec2f;
	var<private> dTiledUvGlobal: vec2f;
	uniform innerOffset: vec4f;
	uniform outerScale: vec2f;
	uniform atlasRect: vec4f;
#endif
var<private> dPositionW: vec3f;
var<private> dModelMatrix: mat4x4f;
#include "transformCoreVS"
#ifdef UV0
	attribute vertex_texCoord0: vec2f;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vertex_texCoord1: vec2f;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform matrix_view: mat4x4f;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vertex_tangent: vec4f;
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
#include  "litUserCodeVS"
@vertex
fn vertexMain(input : VertexInput) -> VertexOutput {
	#include "litUserMainStartVS"
	var output : VertexOutput;
	output.position = getPosition();
	output.vPositionW = getWorldPosition();
	#ifdef NORMALS
		output.vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		output.vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);
		output.vBinormalW = cross(output.vNormalW, output.vTangentW) * vertex_tangent.w;
	#elif defined(GGX_SPECULAR)
		output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));
	#endif
	#ifdef UV0
		var uv0: vec2f = getUv0();
		#ifdef UV0_UNMODIFIED
			output.vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		var uv1: vec2f = getUv1();
		#ifdef UV1_UNMODIFIED
			output.vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		output.vVertexColor = vertex_color;
	#endif
	#ifdef LINEAR_DEPTH
		output.vLinearDepth = -(uniform.matrix_view * vec4f(output.vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
		output.outline_color = dOutlineColor;
		output.outline_thickness = dOutlineThickness;
		output.shadow_color = dShadowColor;
		output.shadow_offset = dShadowOffset;
	#endif
	#ifdef NINESLICED
		output.vMask = dMaskGlobal;
		output.vTiledUv = dTiledUvGlobal;
	#endif
	#include "litUserMainEndVS"
	return output;
}
`,litOtherMainPS:`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	var output: FragmentOutput;
	
	evaluateFrontend();
	#ifdef PICK_PASS
		output.color = getPickOutput();
	#endif
	#ifdef PREPASS_PASS
		output.color = float2vec4(vLinearDepth);
	#endif
	#include "litUserMainEndPS"
	return output;
}
`,litShaderArgsPS:`
var<private> litArgs_albedo: vec3f;
var<private> litArgs_opacity: f32;
var<private> litArgs_emission: vec3f;
var<private> litArgs_worldNormal: vec3f;
var<private> litArgs_ao: f32;
var<private> litArgs_lightmap: vec3f;
var<private> litArgs_lightmapDir: vec3f;
var<private> litArgs_metalness: f32;
var<private> litArgs_specularity: vec3f;
var<private> litArgs_specularityFactor: f32;
var<private> litArgs_gloss: f32;
var<private> litArgs_sheen_gloss: f32;
var<private> litArgs_sheen_specularity: vec3f;
var<private> litArgs_transmission: f32;
var<private> litArgs_thickness: f32;
var<private> litArgs_ior: f32;
var<private> litArgs_dispersion: f32;
var<private> litArgs_iridescence_intensity: f32;
var<private> litArgs_iridescence_thickness: f32;
var<private> litArgs_clearcoat_worldNormal: vec3f;
var<private> litArgs_clearcoat_specularity: f32;
var<private> litArgs_clearcoat_gloss: f32;
`,litShaderCorePS:`
	#if LIT_NONE_SLICE_MODE == TILED
		var<private> textureBias: f32 = -1000.0;
	#else
		uniform textureBias: f32;
	#endif
	#include "litShaderArgsPS"
`,litShadowMainPS:`
#if LIGHT_TYPE != DIRECTIONAL
	uniform view_position: vec3f;
	uniform light_radius: f32;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	var output: FragmentOutput;
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		var depth: f32 = input.position.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepthWithParams(depth, camera_params);
			#endif
		#endif
	#else
		var depth: f32 = min(distance(uniform.view_position, input.vPositionW) / uniform.light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			var exponent: f32 = 15.0;
		#else
			var exponent: f32 = 5.54;
		#endif
		var depth_vsm = 2.0 * depth - 1.0;
		depth_vsm = exp(exponent * depth_vsm);
		output.color = vec4f(depth_vsm, depth_vsm * depth_vsm, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			output.color = vec4f(depth, 0.0, 0.0, 1.0);
		#else
			#ifdef MODIFIED_DEPTH
				output.fragDepth = depth;
			#endif
			output.color = vec4f(1.0);
		#endif
	#endif
	#include "litUserMainEndPS"
	
	return output;
}
`,litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:`
fn LTC_Uv(N: vec3f, V: vec3f, roughness: f32) -> vec2f {
	const LUT_SIZE: f32 = 64.0;
	const LUT_SCALE: f32 = (LUT_SIZE - 1.0) / LUT_SIZE;
	const LUT_BIAS: f32 = 0.5 / LUT_SIZE;
	let dotNV: f32 = saturate(dot( N, V ));
	let uv: vec2f = vec2f( roughness, sqrt( 1.0 - dotNV ) );
	return uv * LUT_SCALE + LUT_BIAS;
}
fn LTC_ClippedSphereFormFactor( f: vec3f ) -> f32 {
	let l: f32 = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
fn LTC_EdgeVectorFormFactor( v1: vec3f, v2: vec3f ) -> vec3f {
	let x: f32 = dot( v1, v2 );
	let y: f32 = abs( x );
	let a: f32 = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	let b: f32 = 3.4175940 + ( 4.1616724 + y ) * y;
	let v: f32 = a / b;
	let inv_sqrt_term = inverseSqrt( max( 1.0 - x * x, 1e-7f ) );
	let theta_sintheta: f32 = select( (0.5 * inv_sqrt_term - v), v, x > 0.0 );
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	coord0: vec3f,
	coord1: vec3f,
	coord2: vec3f,
	coord3: vec3f,
}
fn LTC_EvaluateRect( N: vec3f, V: vec3f, P: vec3f, mInv: mat3x3f, rectCoords: Coords) -> f32 {
	let v1: vec3f = rectCoords.coord1 - rectCoords.coord0;
	let v2: vec3f = rectCoords.coord3 - rectCoords.coord0;
	let lightNormal: vec3f = cross( v1, v2 );
	let factor: f32 = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	let T1: vec3f = normalize( V - N * dot( V, N ) );
	let T2: vec3f = factor * cross( N, T1 );
	let mat: mat3x3f = mInv * transpose( mat3x3f( T1, T2, N ) );
	var coords: array<vec3f, 4>;
	coords[0] = mat * ( rectCoords.coord0 - P );
	coords[1] = mat * ( rectCoords.coord1 - P );
	coords[2] = mat * ( rectCoords.coord2 - P );
	coords[3] = mat * ( rectCoords.coord3 - P );
	coords[0] = normalize( coords[0] );
	coords[1] = normalize( coords[1] );
	coords[2] = normalize( coords[2] );
	coords[3] = normalize( coords[3] );
	var vectorFormFactor: vec3f = vec3f( 0.0 );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[0], coords[1] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[1], coords[2] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[2], coords[3] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[3], coords[0] );
	let result: f32 = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
var<private> dLTCCoords: Coords;
fn getLTCLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {
	var coords: Coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
var<private> dSphereRadius: f32;
fn getSphereLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	let f: vec3f = reflect(normalize(lightPos - uniform.view_position), vNormalW);
	let w: vec3f = normalize(cross(f, halfHeight));
	let h: vec3f = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
var<private> dLTCUV: vec2f;
#ifdef LIT_CLEARCOAT
	var<private> ccLTCUV: vec2f;
#endif
fn getLTCLightUV(gloss: f32, worldNormal: vec3f, viewDir: vec3f) -> vec2f {
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
var<private> dLTCSpecFres: vec3f;
#ifdef LIT_CLEARCOAT
	var<private> ccLTCSpecFres: vec3f;
#endif
fn getLTCLightSpecFres(uv: vec2f, specularity: vec3f) -> vec3f {
	let t2: vec4f = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0);
	return specularity * t2.x + ( vec3f( 1.0 ) - specularity) * t2.y;
}
fn calcLTCLightValues(gloss: f32, worldNormal: vec3f, viewDir: vec3f, specularity: vec3f, clearcoatGloss: f32, clearcoatWorldNormal: vec3f, clearcoatSpecularity: f32) {
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity);
	#ifdef LIT_CLEARCOAT
		ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
		ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3f(clearcoatSpecularity));
	#endif
}
fn calcRectLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
fn calcDiskLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
fn calcSphereLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
fn SolveCubic(Coefficient_in: vec4f) -> vec3f {
	let pi: f32 = 3.14159;
	var Coefficient = Coefficient_in;
	Coefficient = vec4f(Coefficient.xyz / Coefficient.w, Coefficient.w);
	let new_yz: vec2f = Coefficient.yz / 3.0;
	Coefficient = vec4f(Coefficient.x, new_yz.x, new_yz.y, Coefficient.w);
	
	let A: f32 = Coefficient.w;
	let B: f32 = Coefficient.z;
	let C: f32 = Coefficient.y;
	let D: f32 = Coefficient.x;
	let Delta: vec3f = vec3f(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2f(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	let Discriminant: f32 = dot(vec2f(4.0 * Delta.x, -Delta.y), Delta.zy);
	var xlc: vec2f;
	var xsc: vec2f;
	{
		let A_a: f32 = 1.0;
		let C_a: f32 = Delta.x;
		let D_a: f32 = -2.0 * B * Delta.x + Delta.y;
		let Theta: f32 = atan2(sqrt(Discriminant), -D_a) / 3.0;
		let sqrt_neg_Ca = sqrt(-C_a);
		let x_1a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta);
		let x_3a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta + (2.0 / 3.0) * pi);
		let xl: f32 = select(x_3a, x_1a, (x_1a + x_3a) > 2.0 * B);
		xlc = vec2f(xl - B, A);
	}
	{
		let A_d: f32 = D;
		let C_d: f32 = Delta.z;
		let D_d: f32 = -D * Delta.y + 2.0 * C * Delta.z;
		let Theta: f32 = atan2(D * sqrt(Discriminant), -D_d) / 3.0;
		let sqrt_neg_Cd = sqrt(-C_d);
		let x_1d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta);
		let x_3d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta + (2.0 / 3.0) * pi);
		let xs: f32 = select(x_3d, x_1d, x_1d + x_3d < 2.0 * C);
		xsc = vec2f(-D, xs + C);
	}
	let E: f32 =  xlc.y * xsc.y;
	let F: f32 = -xlc.x * xsc.y - xlc.y * xsc.x;
	let G: f32 =  xlc.x * xsc.x;
	let xmc: vec2f = vec2f(C * F - B * G, -B * F + C * E);
	var Root: vec3f = vec3f(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z) {
		Root = Root.yxz;
	} else if (Root.z < Root.x && Root.z < Root.y) {
		Root = Root.xzy;
	}
	return Root;
}
fn LTC_EvaluateDisk(N: vec3f, V: vec3f, P: vec3f, Minv: mat3x3f, points: Coords) -> f32 {
	let T1: vec3f = normalize(V - N * dot(V, N));
	let T2: vec3f = cross(N, T1);
	let R: mat3x3f = transpose( mat3x3f( T1, T2, N ) );
	var L_: array<vec3f, 3>;
	L_[0] = R * ( points.coord0 - P );
	L_[1] = R * ( points.coord1 - P );
	L_[2] = R * ( points.coord2 - P );
	let C: vec3f  = 0.5 * (L_[0] + L_[2]);
	var V1: vec3f = 0.5 * (L_[1] - L_[2]);
	var V2: vec3f = 0.5 * (L_[1] - L_[0]);
	let C_Minv: vec3f  = Minv * C;
	let V1_Minv: vec3f = Minv * V1;
	let V2_Minv: vec3f = Minv * V2;
	var a: f32;
	var b: f32;
	let d11: f32 = dot(V1_Minv, V1_Minv);
	let d22: f32 = dot(V2_Minv, V2_Minv);
	let d12: f32 = dot(V1_Minv, V2_Minv);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001) {
		let tr: f32 = d11 + d22;
		let det_inner: f32 = -d12 * d12 + d11 * d22;
		let det: f32 = sqrt(det_inner);
		let u: f32 = 0.5 * sqrt(tr - 2.0 * det);
		let v: f32 = 0.5 * sqrt(tr + 2.0 * det);
		let e_max: f32 = (u + v) * (u + v);
		let e_min: f32 = (u - v) * (u - v);
		var V1_: vec3f;
		var V2_: vec3f;
		if (d11 > d22) {
			V1_ = d12 * V1_Minv + (e_max - d11) * V2_Minv;
			V2_ = d12 * V1_Minv + (e_min - d11) * V2_Minv;
		} else {
			V1_ = d12*V2_Minv + (e_max - d22)*V1_Minv;
			V2_ = d12*V2_Minv + (e_min - d22)*V1_Minv;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	} else {
		a = 1.0 / dot(V1_Minv, V1_Minv);
		b = 1.0 / dot(V2_Minv, V2_Minv);
		V1 = V1_Minv * sqrt(a);
		V2 = V2_Minv * sqrt(b);
	}
	var V3: vec3f = normalize(cross(V1, V2));
	if (dot(C_Minv, V3) < 0.0) {
		V3 = V3 * -1.0;
	}
	let L: f32  = dot(V3, C_Minv);
	let x0: f32 = dot(V1, C_Minv) / L;
	let y0: f32 = dot(V2, C_Minv) / L;
	let E1: f32 = inverseSqrt(a);
	let E2: f32 = inverseSqrt(b);
	let a_scaled = a * L * L;
	let b_scaled = b * L * L;
	let c0: f32 = a_scaled * b_scaled;
	let c1: f32 = a_scaled * b_scaled * (1.0 + x0 * x0 + y0 * y0) - a_scaled - b_scaled;
	let c2: f32 = 1.0 - a_scaled * (1.0 + x0 * x0) - b_scaled * (1.0 + y0 * y0);
	let c3: f32 = 1.0;
	let roots: vec3f = SolveCubic(vec4f(c0, c1, c2, c3));
	let e1: f32 = roots.x;
	let e2: f32 = roots.y;
	let e3: f32 = roots.z;
	var avgDir: vec3f = vec3f(a_scaled * x0 / (a_scaled - e2), b_scaled * y0 / (b_scaled - e2), 1.0);
	let rotate: mat3x3f = mat3x3f(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	let L1: f32 = sqrt(-e2 / e3);
	let L2: f32 = sqrt(-e2 / e1);
	let formFactor: f32 = max(0.0, L1 * L2 * inverseSqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	const LUT_SIZE_disk: f32 = 64.0;
	const LUT_SCALE_disk: f32 = ( LUT_SIZE_disk - 1.0 ) / LUT_SIZE_disk;
	const LUT_BIAS_disk: f32 = 0.5 / LUT_SIZE_disk;
	var uv: vec2f = vec2f(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv * LUT_SCALE_disk + LUT_BIAS_disk;
	let scale: f32 = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0).w;
	return formFactor * scale;
}
fn FixNan(value: f32) -> f32 {
	return select(value, 0.0, value != value);
}
fn getRectLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords );
}
fn getDiskLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords ));
}
fn getSphereLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let falloff: f32 = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
fn getLTCLightInvMat(uv: vec2f) -> mat3x3f {
	let t1: vec4f = textureSampleLevel(areaLightsLutTex1, areaLightsLutTex1Sampler, uv, 0.0);
	return mat3x3f(
		vec3f( t1.x, 0.0, t1.y ),
		vec3f( 0.0, 1.0, 0.0 ),
		vec3f( t1.z, 0.0, t1.w )
	);
}
fn calcRectLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {
	let mInv: mat3x3f = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
fn getRectLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
fn calcDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {
	let mInv: mat3x3f = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
fn getDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
fn getSphereLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,metalnessPS:`
#ifdef STD_METALNESS_CONSTANT
uniform material_metalness: f32;
#endif
fn getMetalness() {
	var metalness: f32 = 1.0;
	#ifdef STD_METALNESS_CONSTANT
		metalness = metalness * uniform.material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
		metalness = metalness * textureSampleBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_NAME}Sampler, {STD_METALNESS_TEXTURE_UV}, uniform.textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness = metalness * saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`,metalnessModulatePS:`
fn getSpecularModulate(specularity: vec3f, albedo: vec3f, metalness: f32, f0: f32) -> vec3f {
	let dielectricF0: vec3f = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
fn getAlbedoModulate(albedo: vec3f, metalness: f32) -> vec3f {
	return albedo * (1.0 - metalness);
}
`,morphPS:`
	varying uv0: vec2f;
	var morphTexture: texture_2d_array<f32>;
	var morphTextureSampler : sampler;
	uniform morphFactor: array<f32, {MORPH_TEXTURE_MAX_COUNT}>;
	uniform morphIndex: array<u32, {MORPH_TEXTURE_MAX_COUNT}>;
	uniform count: u32;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var color = vec3f(0, 0, 0);
		for (var i: u32 = 0; i < uniform.count; i = i + 1) {
			var textureIndex: u32 = uniform.morphIndex[i].element;
			var delta = textureSample(morphTexture, morphTextureSampler, input.uv0, textureIndex).xyz;
			color += uniform.morphFactor[i].element * delta;
		}
		var output: FragmentOutput;
		output.color = vec4f(color, 1.0);
		return output;
	}
`,morphVS:`
	attribute vertex_position: vec2f;
	varying uv0: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.vertex_position, 0.5, 1.0);
		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
		return output;
	}
`,msdfPS:`
var texture_msdfMap: texture_2d<f32>;
var texture_msdfMapSampler: sampler;
fn median(r: f32, g: f32, b: f32) -> f32 {
	return max(min(r, g), min(max(r, g), b));
}
fn map(min: f32, max: f32, v: f32) -> f32 {
	return (v - min) / (max - min);
}
uniform font_sdfIntensity: f32;
uniform font_pxrange: f32;
uniform font_textureWidth: f32;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform outline_color: vec4f;
	uniform outline_thickness: f32;
	uniform shadow_color: vec4f;
	uniform shadow_offset: vec2f;
#else
	varying outline_color: vec4f;
	varying outline_thickness: f32;
	varying shadow_color: vec4f;
	varying shadow_offset: vec2f;
#endif
fn applyMsdf(color_in: vec4f) -> vec4f {
	#ifndef LIT_MSDF_TEXT_ATTRIBUTE
		var outline_colorValue = uniform.outline_color;
		var outline_thicknessValue = uniform.outline_thickness;
		var shadow_colorValue = uniform.shadow_color;
		var shadow_offsetValue = uniform.shadow_offset;
	#else
		var outline_colorValue = outline_color;
		var outline_thicknessValue = outline_thickness;
		var shadow_colorValue = shadow_color;
		var shadow_offsetValue = shadow_offset;
	#endif
	var color = vec4f(gammaCorrectInputVec3(color_in.rgb), color_in.a);
	let tsample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, vUv0).rgb;
	let uvShdw: vec2f = vUv0 - shadow_offsetValue;
	let ssample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, uvShdw).rgb;
	let sigDist: f32 = median(tsample.r, tsample.g, tsample.b);
	var sigDistShdw: f32 = median(ssample.r, ssample.g, ssample.b);
	let smoothingMax: f32 = 0.2;
	let w: vec2f = abs(dpdx(vUv0)) + abs(dpdy(vUv0));
	let smoothing: f32 = clamp(w.x * uniform.font_textureWidth / uniform.font_pxrange, 0.0, smoothingMax);
	let mapMin: f32 = 0.05;
	let mapMax: f32 = clamp(1.0 - uniform.font_sdfIntensity, mapMin, 1.0);
	let sigDistInner: f32 = map(mapMin, mapMax, sigDist);
	let sigDistOutline: f32 = map(mapMin, mapMax, sigDist + outline_thicknessValue);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thicknessValue);
	let center: f32 = 0.5;
	let inside: f32 = smoothstep(center - smoothing, center + smoothing, sigDistInner);
	let outline: f32 = smoothstep(center - smoothing, center + smoothing, sigDistOutline);
	let shadow: f32 = smoothstep(center - smoothing, center + smoothing, sigDistShdw);
	let tcolor_outline: vec4f = outline * vec4f(outline_colorValue.a * outline_colorValue.rgb, outline_colorValue.a);
	var tcolor: vec4f = select(vec4f(0.0), tcolor_outline, outline > inside);
	tcolor = mix(tcolor, color, inside);
	let scolor_shadow: vec4f = shadow * vec4f(shadow_colorValue.a * shadow_colorValue.rgb, shadow_colorValue.a);
	let scolor: vec4f = select(tcolor, scolor_shadow, shadow > outline);
	tcolor = mix(scolor, tcolor, outline);
	tcolor = vec4f(gammaCorrectOutput(tcolor.rgb), tcolor.a);
	return tcolor;
}
`,msdfVS:`
attribute vertex_outlineParameters: vec3f;
attribute vertex_shadowParameters: vec3f;
varying outline_color: vec4f;
varying outline_thickness: f32;
varying shadow_color: vec4f;
varying shadow_offset: vec2f;
var<private> dOutlineColor: vec4f;
var<private> dOutlineThickness: f32;
var<private> dShadowColor: vec4f;
var<private> dShadowOffset: vec2f;
fn unpackMsdfParams() {
	let little: vec3f = vertex_outlineParameters % vec3f(256.0);
	let big: vec3f = (vertex_outlineParameters - little) / 256.0;
	dOutlineColor = vec4f(little.x, big.x, little.y, big.y) / 255.0;
	dOutlineThickness = little.z / 255.0 * 0.2;
	let little_shadow = vertex_shadowParameters % vec3f(256.0);
	let big_shadow = (vertex_shadowParameters - little_shadow) / 256.0;
	dShadowColor = vec4f(little_shadow.x, big_shadow.x, little_shadow.y, big_shadow.y) / 255.0;
	dShadowOffset = (vec2f(little_shadow.z, big_shadow.z) / 127.0 - 1.0) * 0.005;
}
`,normalVS:`
var<private> dNormalMatrix: mat3x3f;
fn getNormal() -> vec3f {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	let localNormal: vec3f = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}`,normalCoreVS:`
attribute vertex_normal: vec3f;
uniform matrix_normal: mat3x3f;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		var morphNormalTex: texture_2d<u32>;
		var morphNormalTexSampler: sampler;
	#else
		var morphNormalTex: texture_2d<f32>;
		var morphNormalTexSampler: sampler;
	#endif
#endif
fn getLocalNormal(vertexNormal: vec3f) -> vec3f {
	var localNormal: vec3f = vertexNormal;
	#ifdef MORPHING_NORMAL
		let morphUV: vec2i = getTextureMorphCoords();
		#ifdef MORPHING_INT
			let morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);
			let morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;
			localNormal = localNormal + morphNormalF;
		#else
			let morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;
			localNormal = localNormal + morphNormal;
		#endif
	#endif
	return localNormal;
}
#if defined(SKIN) || defined(BATCH)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return uniform.matrix_normal;
	}
#endif
`,normalMapPS:`
#ifdef STD_NORMAL_TEXTURE
	uniform material_bumpiness: f32;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
	uniform material_normalDetailMapBumpiness: f32;
	fn blendNormals(inN1: vec3f, inN2: vec3f) -> vec3f {
		let n1: vec3f = inN1 + vec3f(0.0, 0.0, 1.0);
		let n2: vec3f = inN2 * vec3f(-1.0, -1.0, 1.0);
		return n1 * dot(n1, n2) / n1.z - n2;
	}
#endif
fn getNormal() {
#ifdef STD_NORMAL_TEXTURE
	var normalMap: vec3f = {STD_NORMAL_TEXTURE_DECODE}(textureSampleBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_NAME}Sampler, {STD_NORMAL_TEXTURE_UV}, uniform.textureBias));
	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		var normalDetailMap: vec3f = {STD_NORMALDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_NAME}Sampler, {STD_NORMALDETAIL_TEXTURE_UV}, uniform.textureBias));
		normalDetailMap = mix(vec3f(0.0, 0.0, 1.0), normalDetailMap, uniform.material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`,opacityPS:`
uniform material_opacity: f32;
fn getOpacity() {
	dAlpha = uniform.material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha = dAlpha * textureSampleBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_NAME}Sampler, {STD_OPACITY_TEXTURE_UV}, uniform.textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha = dAlpha * clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`,opacityDitherPS:`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform blueNoiseJitter: vec4f;
#if STD_OPACITY_DITHER == BLUENOISE
	var blueNoiseTex32 : texture_2d<f32>;
	var blueNoiseTex32Sampler : sampler;
#endif
fn opacityDither(alpha: f32, id: f32) {
	#if STD_OPACITY_DITHER == BAYER8
		var noise: f32 = bayer8(floor((pcPosition.xy + uniform.blueNoiseJitter.xy + id) % vec2f(8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			var uv = fract(pcPosition.xy / 32.0 + uniform.blueNoiseJitter.xy + id);
			var noise: f32 = textureSampleLevel(blueNoiseTex32, blueNoiseTex32Sampler, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			var magic = vec3f(0.06711056, 0.00583715, 52.9829189);
			var noise: f32 = fract(magic.z * fract(dot(pcPosition.xy + uniform.blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise) {
		discard;
	}
}
`,outputPS:`
`,outputAlphaPS:`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	output.color = vec4f(output.color.rgb, litArgs_opacity);
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);
#else
	output.color = vec4f(output.color.rgb, 1.0);
#endif
`,outputTex2DPS:`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	output.color = textureSample(source, sourceSampler, input.vUv0);
	return output;
}
`,sheenPS:`
uniform material_sheen: vec3f;
fn getSheen() {
	var sheenColor = uniform.material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor = sheenColor * {STD_SHEEN_TEXTURE_DECODE}(textureSampleBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_NAME}Sampler, {STD_SHEEN_TEXTURE_UV}, uniform.textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor = sheenColor * saturate3(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`,sheenGlossPS:`
uniform material_sheenGloss: f32;
fn getSheenGlossiness() {
	var sheenGlossiness = uniform.material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness = sheenGlossiness * textureSampleBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_NAME}Sampler, {STD_SHEENGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness = sheenGlossiness * saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`,parallaxPS:`
uniform material_heightMapFactor: f32;
fn getParallax() {
	var parallaxScale = uniform.material_heightMapFactor;
	var height: f32 = textureSampleBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_NAME}Sampler, {STD_HEIGHT_TEXTURE_UV}, uniform.textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale * 0.5;
	var viewDirT: vec3f = dViewDirW * dTBN;
	viewDirT.z = viewDirT.z + 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,pickPS:`
uniform meshInstanceId: u32;
fn getPickOutput() -> vec4f {
	let inv: vec4f = vec4f(1.0 / 255.0);
	let shifts: vec4u = vec4u(16u, 8u, 0u, 24u);
	let col: vec4u = (vec4u(uniform.meshInstanceId) >> shifts) & vec4u(0xffu);
	return vec4f(col) * inv;
}`,reflDirPS:`
fn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,reflDirAnisoPS:`
fn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {
	let roughness: f32 = sqrt(1.0 - min(gloss, 1.0));
	let direction: vec2f = dAnisotropyRotation;
	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));
	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));
	let anisotropy: f32 = dAnisotropy;
	let anisotropicDirection: vec3f = anisotropicB;
	let anisotropicTangent: vec3f = cross(anisotropicDirection, viewDir);
	let anisotropicNormal: vec3f = cross(anisotropicTangent, anisotropicDirection);
	let bendFactor: f32 = 1.0 - anisotropy * (1.0 - roughness);
	let bendFactor4: f32 = bendFactor * bendFactor * bendFactor * bendFactor;
	let bentNormal: vec3f = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));
	dReflDirW = reflect(-viewDir, bentNormal);
}`,reflectionCCPS:`
#ifdef LIT_CLEARCOAT
fn addReflectionCC(reflDir: vec3f, gloss: f32) {
	ccReflection = ccReflection + calcReflection(reflDir, gloss);
}
#endif
`,reflectionCubePS:`
var texture_cubeMap: texture_cube<f32>;
var texture_cubeMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	var lookupVec: vec3f = cubeMapProject(reflDir);
	lookupVec.x = lookupVec.x * -1.0;
	return {reflectionDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, lookupVec));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionEnvHQPS:`
#ifndef ENV_ATLAS
	#define ENV_ATLAS
	var texture_envAtlas: texture_2d<f32>;
	var texture_envAtlasSampler: sampler;
#endif
var texture_cubeMap: texture_cube<f32>;
var texture_cubeMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);
	let uv: vec2f = toSphericalUv(dir);
	let level: f32 = saturate(1.0 - gloss) * 5.0;
	let ilevel: f32 = floor(level);
	let flevel: f32 = level - ilevel;
	let sharp: vec3f = {reflectionCubemapDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, dir));
	let roughA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel)));
	let roughB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionEnvPS:`
#ifndef ENV_ATLAS
#define ENV_ATLAS
	var texture_envAtlas: texture_2d<f32>;
	var texture_envAtlasSampler: sampler;
#endif
uniform material_reflectivity: f32;
fn shinyMipLevel(uv: vec2f) -> f32 {
	let dx: vec2f = dpdx(uv);
	let dy: vec2f = dpdy(uv);
	let uv2: vec2f = vec2f(fract(uv.x + 0.5), uv.y);
	let dx2: vec2f = dpdx(uv2);
	let dy2: vec2f = dpdy(uv2);
	let maxd: f32 = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + uniform.textureBias, 0.0, 5.0);
}
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);
	let uv: vec2f = toSphericalUv(dir);
	let level: f32 = saturate(1.0 - gloss) * 5.0;
	let ilevel: f32 = floor(level);
	let level2: f32 = shinyMipLevel(uv * atlasSize);
	let ilevel2: f32 = floor(level2);
	var uv0: vec2f;
	var uv1: vec2f;
	var weight: f32;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = mapRoughnessUv(uv, ilevel);
		uv1 = uv0;
		weight = 0.0;
	}
	let linearA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv0));
	let linearB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv1));
	let linear0: vec3f = mix(linearA, linearB, weight);
	let linear1: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionSpherePS:`
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
var texture_sphereMap: texture_2d<f32>;
var texture_sphereMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let viewRotationMatrix = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let reflDirV: vec3f = viewRotationMatrix * reflDir;
	let m: f32 = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));
	let sphereMapUv: vec2f = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(textureSample(texture_sphereMap, texture_sphereMapSampler, sphereMapUv));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionSheenPS:`
fn addReflectionSheen(worldNormal: vec3f, viewDir: vec3f, gloss: f32) {
	let NoV: f32 = dot(worldNormal, viewDir);
	let alphaG: f32 = gloss * gloss;
	let a: f32 = select(
		-8.48 * alphaG + 14.3 * gloss - 9.95,
		-339.2 * alphaG + 161.4 * gloss - 25.9,
		gloss < 0.25
	);
	let b: f32 = select(
		1.97 * alphaG - 3.27 * gloss + 0.72,
		44.0 * alphaG - 23.7 * gloss + 3.26,
		gloss < 0.25
	);
	let dg_add: f32 = select(
		0.1 * ( gloss - 0.25 ),
		0.0,
		gloss < 0.25
	);
	let dg: f32 = exp( a * NoV + b ) + dg_add;
	sReflection = sReflection + (calcReflection(worldNormal, 0.0) * saturate(dg));
}`,refractionCubePS:`
fn refract2(viewVec: vec3f, normal: vec3f, IOR: f32) -> vec3f {
	let vn: f32 = dot(viewVec, normal);
	let k: f32 = 1.0 - IOR * IOR * (1.0 - vn * vn);
	let refrVec: vec3f = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
fn addRefraction(
	worldNormal: vec3f,
	viewDir: vec3f,
	thickness: f32,
	gloss: f32,
	specularity: vec3f,
	albedo: vec3f,
	transmission: f32,
	refractionIndex: f32,
	dispersion: f32
#if defined(LIT_IRIDESCENCE)
	, iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	let tmpRefl: vec4f = dReflection;
	let reflectionDir: vec3f = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4f(0.0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,refractionDynamicPS:`
uniform material_invAttenuationDistance: f32;
uniform material_attenuation: vec3f;
fn evalRefractionColor(refractionVector: vec3f, gloss: f32, refractionIndex: f32) -> vec3f {
	let pointOfRefraction: vec4f = vec4f(vPositionW + refractionVector, 1.0);
	let projectionPoint: vec4f = uniform.matrix_viewProjection * pointOfRefraction;
	let uv: vec2f = getGrabScreenPos(projectionPoint);
	let iorToRoughness: f32 = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	let refractionLod: f32 = log2(uniform.uScreenSize.x) * iorToRoughness;
	let refraction: vec3f = textureSampleLevel(uSceneColorMap, uSceneColorMapSampler, uv, refractionLod).rgb;
	return refraction;
}
fn addRefraction(
	worldNormal: vec3f,
	viewDir: vec3f,
	thickness: f32,
	gloss: f32,
	specularity: vec3f,
	albedo: vec3f,
	transmission: f32,
	refractionIndex: f32,
	dispersion: f32,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	var modelScale: vec3f;
	modelScale.x = length(uniform.matrix_model[0].xyz);
	modelScale.y = length(uniform.matrix_model[1].xyz);
	modelScale.z = length(uniform.matrix_model[2].xyz);
	let scale: vec3f = thickness * modelScale;
	var refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	var refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		let halfSpread: f32 = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		let refractionIndexR: f32 = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		let refractionIndexB: f32 = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	var transmittance: vec3f;
	if (uniform.material_invAttenuationDistance != 0.0)
	{
		let attenuation: vec3f = -log(uniform.material_attenuation) * uniform.material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	let fresnel: vec3f = vec3f(1.0) -
		getFresnel(
			dot(viewDir, worldNormal),
			gloss,
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,reprojectPS:`
varying vUv0: vec2f;
#ifdef CUBEMAP_SOURCE
	var sourceCube: texture_cube<f32>;
	var sourceCubeSampler : sampler;
#else
	var sourceTex: texture_2d<f32>;
	var sourceTexSampler : sampler;
#endif
#ifdef USE_SAMPLES_TEX
	var samplesTex: texture_2d<f32>;
	var samplesTexSampler : sampler;
	uniform samplesTexInverseSize: vec2f;
#endif
uniform params: vec3f;
fn targetFace() -> f32 { return uniform.params.x; }
fn targetTotalPixels() -> f32 { return uniform.params.y; }
fn sourceTotalPixels() -> f32 { return uniform.params.z; }
const PI: f32 = 3.141592653589793;
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
fn modifySeams(dir: vec3f, scale: f32) -> vec3f {
	let adir = abs(dir);
	let M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3f(
		select(scale, 1.0, adir.x == M),
		select(scale, 1.0, adir.y == M),
		select(scale, 1.0, adir.z == M)
	);
}
fn toSpherical(dir: vec3f) -> vec2f {
	let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));
	return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));
}
fn fromSpherical(uv: vec2f) -> vec3f {
	return vec3f(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
fn getDirectionEquirect(uv: vec2f) -> vec3f {
	return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));
}
fn signNotZero(k: f32) -> f32 {
	return select(-1.0, 1.0, k >= 0.0);
}
fn signNotZeroVec2(v: vec2f) -> vec2f {
	return vec2f(signNotZero(v.x), signNotZero(v.y));
}
fn octDecode(o: vec2f) -> vec3f {
	var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);
		v = vec3f(temp.x, v.y, temp.y);
	}
	return normalize(v);
}
fn getDirectionOctahedral(uv: vec2f) -> vec3f {
	return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);
}
fn octEncode(v: vec3f) -> vec2f {
	let l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	var result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	fn sampleCubemapDir(dir: vec3f) -> vec4f {
		return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));
	}
	fn sampleCubemapSph(sph: vec2f) -> vec4f {
		return sampleCubemapDir(fromSpherical(sph));
	}
	fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);
	}
	fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		return sampleCubemapDirLod(fromSpherical(sph), mipLevel);
	}
#else
	fn sampleEquirectSph(sph: vec2f) -> vec4f {
		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
	}
	fn sampleEquirectDir(dir: vec3f) -> vec4f {
		return sampleEquirectSph(toSpherical(dir));
	}
	fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
	}
	fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		return sampleEquirectSphLod(toSpherical(dir), mipLevel);
	}
	fn sampleOctahedralDir(dir: vec3f) -> vec4f {
		let uv = octEncode(dir) * 0.5 + 0.5;
		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
	}
	fn sampleOctahedralSph(sph: vec2f) -> vec4f {
		return sampleOctahedralDir(fromSpherical(sph));
	}
	fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		let uv = octEncode(dir) * 0.5 + 0.5;
		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
	}
	fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);
	}
#endif
fn getDirectionCubemap(uv: vec2f) -> vec3f {
	let st = uv * 2.0 - 1.0;
	let face = targetFace();
	var vec: vec3f;
	if (face == 0.0) {
		vec = vec3f(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3f(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3f(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3f(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3f(st.x, -st.y, 1);
	} else {
		vec = vec3f(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
fn matrixFromVector(n: vec3f) -> mat3x3f {
	let a = 1.0 / (1.0 + n.z);
	let b = -n.x * n.y * a;
	let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);
	let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3x3f(b1, b2, n);
}
fn matrixFromVectorSlow(n: vec3f) -> mat3x3f {
	let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);
	let x = normalize(cross(up, n));
	let y = cross(n, x);
	return mat3x3f(x, y, n);
}
fn reproject(uv: vec2f) -> vec4f {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));
	} else {
		let t = {TARGET_FUNC}(uv);
		let tu = dpdx(t);
		let tv = dpdy(t);
		var result = vec3f(0.0);
		for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {
			for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {
				result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
const unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {
		var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;
		var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;
		var raw: vec4f;
		raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);
		*L = raw.xyz * 2.0 - 1.0;
		*mipLevel = raw.w * 8.0;
	}
	fn prefilterSamples(uv: vec2f) -> vec4f {
		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));
		var L: vec3f;
		var mipLevel: f32;
		var result = vec3f(0.0);
		var totalWeight = 0.0;
		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
			unpackSample(i, &L, &mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {
		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));
		var L: vec3f;
		var mipLevel: f32;
		var result = vec3f(0.0);
		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
			unpackSample(i, &L, &mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));
	}
#endif
@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	output.color = {PROCESS_FUNC}(input.vUv0);
	return output;
}
`,reprojectVS:`
attribute vertex_position: vec2f;
uniform uvMod: vec4f;
varying vUv0: vec2f;
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4f(input.vertex_position, 0.5, 1.0);
  output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);
  return output;
}
`,screenDepthPS:`
var uSceneDepthMap: texture_2d<f32>;
var uSceneDepthMapSampler: sampler;
#ifndef SCREENSIZE
	#define SCREENSIZE
	uniform uScreenSize: vec4f;
#endif
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
#ifndef LINEARIZE_DEPTH
	#define LINEARIZE_DEPTH
	#ifndef CAMERAPLANES
		#define CAMERAPLANES
		uniform camera_params: vec4f;
	#endif
	fn linearizeDepth(z: f32) -> f32 {
		if (uniform.camera_params.w == 0.0) {
			return (uniform.camera_params.z * uniform.camera_params.y) / (uniform.camera_params.y + z * (uniform.camera_params.z - uniform.camera_params.y));
		} else {
			return uniform.camera_params.z + z * (uniform.camera_params.y - uniform.camera_params.z);
		}
	}
#endif
fn delinearizeDepth(linearDepth: f32) -> f32 {
	if (uniform.camera_params.w == 0.0) {
		return (uniform.camera_params.y * (uniform.camera_params.z - linearDepth)) / (linearDepth * (uniform.camera_params.z - uniform.camera_params.y));
	} else {
		return (linearDepth - uniform.camera_params.z) / (uniform.camera_params.y - uniform.camera_params.z);
	}
}
fn getLinearScreenDepth(uv: vec2f) -> f32 {
	#ifdef SCENE_DEPTHMAP_LINEAR
		#ifdef SCENE_DEPTHMAP_FLOAT
			return textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r;
		#else
			let textureSize = textureDimensions(uSceneDepthMap, 0);
			let texel: vec2i = vec2i(uv * vec2f(textureSize));
			let data: vec4f = textureLoad(uSceneDepthMap, texel, 0);
			let data_u32: vec4u = vec4u(data * 255.0);
			let intBits: u32 = (data_u32.r << 24u) | (data_u32.g << 16u) | (data_u32.b << 8u) | data_u32.a;
			return bitcast<f32>(intBits);
		#endif
	#else
		return linearizeDepth(textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r);
	#endif
}
#ifndef VERTEXSHADER
	fn getLinearScreenDepthFrag() -> f32 {
		let uv: vec2f = pcPosition.xy * uniform.uScreenSize.zw;
		return getLinearScreenDepth(uv);
	}
#endif
fn getLinearDepth(pos: vec3f) -> f32 {
	return -(uniform.matrix_view * vec4f(pos, 1.0)).z;
}
`,shadowCascadesPS:`
fn getShadowCascadeIndex(shadowCascadeDistances: vec4f, shadowCascadeCount: i32) -> i32 {
	let depth: f32 = 1.0 / pcPosition.w;
	let comparisons: vec4f = step(shadowCascadeDistances, vec4f(depth));
	let cascadeIndex: i32 = i32(dot(comparisons, vec4f(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
fn ditherShadowCascadeIndex(cascadeIndex_in: i32, shadowCascadeDistances: vec4f, shadowCascadeCount: i32, blendFactor: f32) -> i32 {
	var cascadeIndex: i32 = cascadeIndex_in;
	if (cascadeIndex < shadowCascadeCount - 1) {
		let currentRangeEnd: f32 = shadowCascadeDistances[cascadeIndex];
		let transitionStart: f32 = blendFactor * currentRangeEnd;
		let depth: f32 = 1.0 / pcPosition.w;
		if (depth > transitionStart) {
			let transitionFactor: f32 = smoothstep(transitionStart, currentRangeEnd, depth);
			let dither: f32 = fract(sin(dot(pcPosition.xy, vec2f(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex = cascadeIndex + 1;
			}
		}
	}
	return cascadeIndex;
}
fn fadeShadow(shadowCoord_in: vec3f, shadowCascadeDistances: vec4f) -> vec3f {
	var shadowCoord: vec3f = shadowCoord_in;
	let depth: f32 = 1.0 / pcPosition.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`,shadowEVSMPS:`
fn linstep(a: f32, b: f32, v: f32) -> f32 {
	return clamp((v - a) / (b - a), 0.0, 1.0);
}
fn reduceLightBleeding(pMax: f32, amount: f32) -> f32 {
   return linstep(amount, 1.0, pMax);
}
fn chebyshevUpperBound(moments: vec2f, mean: f32, minVariance: f32, lightBleedingReduction: f32) -> f32 {
	var variance: f32 = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	let d: f32 = mean - moments.x;
	var pMax: f32 = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return select(pMax, 1.0, mean <= moments.x);
}
fn calculateEVSM(moments_in: vec3f, Z_in: f32, vsmBias: f32, exponent: f32) -> f32 {
	let Z: f32 = 2.0 * Z_in - 1.0;
	let warpedDepth: f32 = exp(exponent * Z);
	let moments: vec2f = moments_in.xy + vec2f(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments_in.z);
	let VSMBias: f32 = vsmBias;
	let depthScale: f32 = VSMBias * exponent * warpedDepth;
	let minVariance1: f32 = depthScale * depthScale;
	return chebyshevUpperBound(moments, warpedDepth, minVariance1, 0.1);
}
fn VSM16(tex: texture_2d<f32>, texSampler: sampler, texCoords: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {
	let moments: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
fn getShadowVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {
	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
fn getShadowSpotVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {
	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
fn VSM32(tex: texture_2d<f32>, texSampler: sampler, texCoords_in: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		var moments: vec3f = textureSampleLevel(tex, texSampler, texCoords_in, 0.0).xyz;
	#else
		var pixelSize : f32 = 1.0 / resolution;
		let texCoords: vec2f = texCoords_in - vec2f(pixelSize);
		let s00: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;
		let s10: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize, 0.0), 0.0).xyz;
		let s01: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(0.0, pixelSize), 0.0).xyz;
		let s11: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize), 0.0).xyz;
		let fr: vec2f = fract(texCoords * resolution);
		let h0: vec3f = mix(s00, s10, fr.x);
		let h1: vec3f = mix(s01, s11, fr.x);
		var moments: vec3f = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
fn getShadowVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {
	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
fn getShadowSpotVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {
	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
`,shadowPCF1PS:`
fn getShadowPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
}
fn getShadowSpotPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
}
`,shadowPCF3PS:`
fn _getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {
	let z: f32 = shadowCoord.z;
	let uv: vec2f = shadowCoord.xy * shadowParams.x;
	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;
	let base_uv_temp: vec2f = floor(uv + 0.5);
	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);
	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);
	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;
	var sum: f32 = 0.0;
	let uw0: f32 = (3.0 - 2.0 * s);
	let uw1: f32 = (1.0 + 2.0 * s);
	let u0_offset: f32 = (2.0 - s) / uw0 - 1.0;
	let u1_offset: f32 = s / uw1 + 1.0;
	let vw0: f32 = (3.0 - 2.0 * t);
	let vw1: f32 = (1.0 + 2.0 * t);
	let v0_offset: f32 = (2.0 - t) / vw0 - 1.0;
	let v1_offset: f32 = t / vw1 + 1.0;
	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;
	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;
	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;
	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;
	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);
	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);
	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);
	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);
	sum = sum * (1.0 / 16.0);
	return sum;
}
fn getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
fn getShadowSpotPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
`,shadowPCF5PS:`
fn _getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {
	let z: f32 = shadowCoord.z;
	let uv: vec2f = shadowCoord.xy * shadowParams.x;
	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;
	let base_uv_temp: vec2f = floor(uv + 0.5);
	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);
	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);
	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;
	let uw0: f32 = (4.0 - 3.0 * s);
	let uw1: f32 = 7.0;
	let uw2: f32 = (1.0 + 3.0 * s);
	let u0_offset: f32 = (3.0 - 2.0 * s) / uw0 - 2.0;
	let u1_offset: f32 = (3.0 + s) / uw1;
	let u2_offset: f32 = s / uw2 + 2.0;
	let vw0: f32 = (4.0 - 3.0 * t);
	let vw1: f32 = 7.0;
	let vw2: f32 = (1.0 + 3.0 * t);
	let v0_offset: f32 = (3.0 - 2.0 * t) / vw0 - 2.0;
	let v1_offset: f32 = (3.0 + t) / vw1;
	let v2_offset: f32 = t / vw2 + 2.0;
	var sum: f32 = 0.0;
	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;
	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;
	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;
	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;
	let u2: f32 = u2_offset * shadowMapSizeInv + base_uv.x;
	let v2: f32 = v2_offset * shadowMapSizeInv + base_uv.y;
	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);
	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);
	sum = sum + uw2 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v0), z);
	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);
	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);
	sum = sum + uw2 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v1), z);
	sum = sum + uw0 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v2), z);
	sum = sum + uw1 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v2), z);
	sum = sum + uw2 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v2), z);
	sum = sum * (1.0 / 144.0);
	sum = saturate(sum);
	return sum;
}
fn getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
fn getShadowSpotPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
`,shadowSoftPS:`
fn fractSinRand(uv: vec2f) -> f32 {
	let PI: f32 = 3.141592653589793;
	let a: f32 = 12.9898; let b: f32 = 78.233; let c: f32 = 43758.5453;
	let dt: f32 = dot(uv.xy, vec2f(a, b));
	let sn: f32 = dt % PI;
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	invNumSamples: f32,
	initialAngle: f32,
	currentPointId: f32,
}
fn prepareDiskConstants(data: ptr<function, VogelDiskData>, sampleCount: i32, randomSeed: f32) {
	let pi2: f32 = 6.28318530718;
	data.invNumSamples = 1.0 / f32(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
fn generateDiskSample(data: ptr<function, VogelDiskData>) -> vec2f {
	let GOLDEN_ANGLE: f32 = 2.399963;
	let r: f32 = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	let theta: f32 = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	let offset: vec2f = vec2f(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId = data.currentPointId + 1.0;
	return offset;
}
fn PCSSFindBlocker(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, avgBlockerDepth: ptr<function, f32>, numBlockers: ptr<function, i32>,
	shadowCoords: vec2f, z: f32, shadowBlockerSamples: i32, penumbraSize: f32, invShadowMapSize: f32, randomSeed: f32) {
	var diskData: VogelDiskData;
	prepareDiskConstants(&diskData, shadowBlockerSamples, randomSeed);
	let searchWidth: f32 = penumbraSize * invShadowMapSize;
	var blockerSum: f32 = 0.0;
	var numBlockers_local: i32 = 0;
	for( var i: i32 = 0; i < shadowBlockerSamples; i = i + 1 ) {
		let diskUV: vec2f = generateDiskSample(&diskData);
		let sampleUV: vec2f = shadowCoords + diskUV * searchWidth;
		let shadowMapDepth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum = blockerSum + shadowMapDepth;
			numBlockers_local = numBlockers_local + 1;
		}
	}
	*avgBlockerDepth = blockerSum / f32(numBlockers_local);
	*numBlockers = numBlockers_local;
}
fn PCSSFilter(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, uv: vec2f, receiverDepth: f32, shadowSamples: i32, filterRadius: f32, randomSeed: f32) -> f32 {
	var diskData: VogelDiskData;
	prepareDiskConstants(&diskData, shadowSamples, randomSeed);
	var sum: f32 = 0.0;
	for (var i: i32 = 0; i < shadowSamples; i = i + 1) {
		let offsetUV: vec2f = generateDiskSample(&diskData) * filterRadius;
		let depth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, uv + offsetUV, 0.0).r;
		sum = sum + step(receiverDepth, depth);
	}
	return sum / f32(shadowSamples);
}
fn getPenumbra(dblocker: f32, dreceiver: f32, penumbraSize: f32, penumbraFalloff: f32) -> f32 {
	let dist: f32 = dreceiver - dblocker;
	let penumbra: f32 = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
fn PCSSDirectional(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoords: vec3f, cameraParams: vec4f, softShadowParams: vec4f) -> f32 {
	let receiverDepth: f32 = shadowCoords.z;
	let randomSeed: f32 = fractSinRand(pcPosition.xy);
	let shadowSamples: i32 = i32(softShadowParams.x);
	let shadowBlockerSamples: i32 = i32(softShadowParams.y);
	let penumbraSize: f32 = softShadowParams.z;
	let penumbraFalloff: f32 = softShadowParams.w;
	let shadowMapSize: i32 = i32(textureDimensions(shadowMap, 0).x);
	var invShadowMapSize: f32 = 1.0 / f32(shadowMapSize);
	invShadowMapSize = invShadowMapSize * (f32(shadowMapSize) / 2048.0);
	var penumbra: f32;
	if (shadowBlockerSamples > 0) {
		var avgBlockerDepth: f32 = 0.0;
		var numBlockers: i32 = 0;
		PCSSFindBlocker(shadowMap, shadowMapSampler, &avgBlockerDepth, &numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1) {
			return 1.0;
		}
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	let filterRadius: f32 = penumbra * invShadowMapSize;
	return PCSSFilter(shadowMap, shadowMapSampler, shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
fn getShadowPCSS(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, cameraParams: vec4f, softShadowParams: vec4f, lightDir: vec3f) -> f32 {
	return PCSSDirectional(shadowMap, shadowMapSampler, shadowCoord, cameraParams, softShadowParams);
}
`,skinBatchVS:`
attribute vertex_boneIndices: f32;
var texture_poseMap: texture_2d<f32>;
fn getBoneMatrix(indexFloat: f32) -> mat4x4f {
	let width = i32(textureDimensions(texture_poseMap).x);
	let index: i32 = i32(indexFloat + 0.5) * 3;
	let iy: i32 = index / width;
	let ix: i32 = index % width;
	let v1: vec4f = textureLoad(texture_poseMap, vec2i(ix + 0, iy), 0);
	let v2: vec4f = textureLoad(texture_poseMap, vec2i(ix + 1, iy), 0);
	let v3: vec4f = textureLoad(texture_poseMap, vec2i(ix + 2, iy), 0);
	return mat4x4f(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1.0
	);
}
`,skinVS:`
attribute vertex_boneWeights: vec4f;
attribute vertex_boneIndices: vec4f;
var texture_poseMap: texture_2d<f32>;
struct BoneMatrix {
	v1: vec4f,
	v2: vec4f,
	v3: vec4f,
}
fn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {
	let v = index / width;
	let u = index % width;
	var result: BoneMatrix;
	result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);
	result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);
	result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);
	return result;
}
fn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {
	let width = i32(textureDimensions(texture_poseMap).x);
	var indices = vec4i(indicesFloat + 0.5) * 3;
	let boneA = getBoneMatrix(width, indices.x);
	let boneB = getBoneMatrix(width, indices.y);
	let boneC = getBoneMatrix(width, indices.z);
	let boneD = getBoneMatrix(width, indices.w);
	let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;
	let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;
	let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;
	let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));
	return mat4x4f(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,skyboxPS:`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	#ifdef PREPASS_PASS
		varying vLinearDepth: f32;
		#include "floatAsUintPS"
	#endif
	varying vViewDir : vec3f;
	uniform skyboxHighlightMultiplier : f32;
	#ifdef SKY_CUBEMAP
		var texture_cubeMap : texture_cube<f32>;
		var texture_cubeMap_sampler : sampler;
		#ifdef SKYMESH
			varying vWorldPos : vec3f;
			uniform cubeMapRotationMatrix : mat3x3f;
			uniform projectedSkydomeCenter : vec3f;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		var texture_envAtlas : texture_2d<f32>;
		var texture_envAtlas_sampler : sampler;
		uniform mipLevel : f32;
	#endif
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		#ifdef PREPASS_PASS
			output.color = float2vec4(vLinearDepth);
		#else
			var linear : vec3f;
			var dir : vec3f;
			#ifdef SKY_CUBEMAP
				#ifdef SKYMESH
					var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);
					dir = envDir * uniform.cubeMapRotationMatrix;
				#else
					dir = input.vViewDir;
				#endif
				dir.x *= -1.0;
				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));
			#else
				dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);
				let uv : vec2f = toSphericalUv(normalize(dir));
				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));
			#endif
			if (any(linear >= vec3f(64.0))) {
				linear *= uniform.skyboxHighlightMultiplier;
			}
			
			output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
		#endif
		return output;
	}
`,skyboxVS:`
	attribute aPosition : vec4f;
	uniform matrix_view : mat4x4f;
	uniform matrix_projectionSkybox : mat4x4f;
	uniform cubeMapRotationMatrix : mat3x3f;
	varying vViewDir : vec3f;
	#ifdef PREPASS_PASS
		varying vLinearDepth: f32;
	#endif
	#ifdef SKYMESH
		uniform matrix_model : mat4x4f;
		varying vWorldPos : vec3f;
	#endif
	@vertex
	fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		var view : mat4x4f = uniform.matrix_view;
		#ifdef SKYMESH
			var worldPos : vec4f = uniform.matrix_model * input.aPosition;
			output.vWorldPos = worldPos.xyz;
			output.position = uniform.matrix_projectionSkybox * (view * worldPos);
			#ifdef PREPASS_PASS
				output.vLinearDepth = -(uniform.matrix_view * vec4f(worldPos.xyz, 1.0)).z;
			#endif
		#else
			view[3][0] = 0.0;
			view[3][1] = 0.0;
			view[3][2] = 0.0;
			output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);
			output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;
			#ifdef PREPASS_PASS
				output.vLinearDepth = -pcPosition.w;
			#endif
		#endif
		output.position.z = output.position.w - 1.0e-7;
		return output;
	}
`,specularPS:`
#ifdef STD_SPECULAR_CONSTANT
	uniform material_specular: vec3f;
#endif
fn getSpecularity() {
	var specularColor = vec3f(1.0, 1.0, 1.0);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor = specularColor * uniform.material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor = specularColor * {STD_SPECULAR_TEXTURE_DECODE}(textureSampleBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_NAME}Sampler, {STD_SPECULAR_TEXTURE_UV}, uniform.textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor = specularColor * saturate3(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`,sphericalPS:`
fn toSpherical(dir: vec3f) -> vec2f {
	let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));
	return vec2f(angle_xz, asin(dir.y));
}
fn toSphericalUv(dir : vec3f) -> vec2f {
	const PI : f32 = 3.141592653589793;
	let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);
	return vec2f(uv.x, 1.0 - uv.y);
}
`,specularityFactorPS:`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
	uniform material_specularityFactor: f32;
#endif
fn getSpecularityFactor() {
	var specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor = specularityFactor * uniform.material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor = specularityFactor * textureSampleBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_NAME}Sampler, {STD_SPECULARITYFACTOR_TEXTURE_UV}, uniform.textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor = specularityFactor * saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`,spotPS:`
fn getSpotEffect(lightSpotDir: vec3f, lightInnerConeAngle: f32, lightOuterConeAngle: f32, lightDirNorm: vec3f) -> f32 {
	let cosAngle: f32 = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}`,startNineSlicedPS:`
	nineSlicedUv = vec2f(vUv0.x, 1.0 - vUv0.y);
`,startNineSlicedTiledPS:`
	let tileMask: vec2f = step(vMask, vec2f(0.99999));
	let tileSize: vec2f = 0.5 * (innerOffset.xy + innerOffset.zw);
	let tileScale: vec2f = vec2f(1.0) / (vec2f(1.0) - tileSize);
	var clampedUv: vec2f = mix(innerOffset.xy * 0.5, vec2f(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	var nineSlicedUv: vec2f = vUv0 * tileMask + clampedUv * (vec2f(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,stdDeclarationPS:`
	var<private> dAlpha: f32 = 1.0;
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			var texture_opacityMap : texture_2d<f32>;
			var texture_opacityMapSampler : sampler;
		#endif
	#endif
	#ifdef FORWARD_PASS
		var<private> dAlbedo: vec3f;
		var<private> dNormalW: vec3f;
		var<private> dSpecularity: vec3f = vec3f(0.0, 0.0, 0.0);
		var<private> dGlossiness: f32 = 0.0;
		#ifdef LIT_REFRACTION
			var<private> dTransmission: f32;
			var<private> dThickness: f32;
		#endif
		#ifdef LIT_SCENE_COLOR
			var uSceneColorMap : texture_2d<f32>;
			var uSceneColorMapSampler : sampler;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform uScreenSize: vec4f;
		#endif
		#ifdef LIT_TRANSFORMS
			var<private> matrix_viewProjection: mat4x4f;
			var<private> matrix_model: mat4x4f;
		#endif
		#ifdef STD_HEIGHT_MAP
			var<private> dUvOffset: vec2f;
			#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
				var texture_heightMap : texture_2d<f32>;
				var texture_heightMapSampler : sampler;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			var texture_diffuseMap : texture_2d<f32>;
			var texture_diffuseMapSampler : sampler;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			var texture_diffuseDetailMap : texture_2d<f32>;
			var texture_diffuseDetailMapSampler : sampler;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			var texture_normalMap : texture_2d<f32>;
			var texture_normalMapSampler : sampler;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			var texture_normalDetailMap : texture_2d<f32>;
			var texture_normalDetailMapSampler : sampler;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			var texture_thicknessMap : texture_2d<f32>;
			var texture_thicknessMapSampler : sampler;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			var texture_refractionMap : texture_2d<f32>;
			var texture_refractionMapSampler : sampler;
		#endif
		#ifdef LIT_IRIDESCENCE
			var<private> dIridescence: f32;
			var<private> dIridescenceThickness: f32;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				var texture_iridescenceThicknessMap : texture_2d<f32>;
				var texture_iridescenceThicknessMapSampler : sampler;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				var texture_iridescenceMap : texture_2d<f32>;
				var texture_iridescenceMapSampler : sampler;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			var<private> ccSpecularity: f32;
			var<private> ccGlossiness: f32;
			var<private> ccNormalW: vec3f;
		#endif
		#ifdef LIT_GGX_SPECULAR
			var<private> dAnisotropy: f32;
			var<private> dAnisotropyRotation: vec2f;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				var<private> sSpecularity: vec3f;
				var<private> sGlossiness: f32;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					var texture_sheenMap : texture_2d<f32>;
					var texture_sheenMapSampler : sampler;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					var texture_sheenGlossMap : texture_2d<f32>;
					var texture_sheenGlossMapSampler : sampler;
				#endif
			#endif
			#ifdef LIT_METALNESS
				var<private> dMetalness: f32;
				var<private> dIor: f32;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					var texture_metalnessMap : texture_2d<f32>;
					var texture_metalnessMapSampler : sampler;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				var<private> dSpecularityFactor: f32;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					var texture_specularityFactorMap : texture_2d<f32>;
					var texture_specularityFactorMapSampler : sampler;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					var texture_specularMap : texture_2d<f32>;
					var texture_specularMapSampler : sampler;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				var texture_glossMap : texture_2d<f32>;
				var texture_glossMapSampler : sampler;
			#endif
		#endif
		#ifdef STD_AO
			var <private> dAo: f32;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				var texture_aoMap : texture_2d<f32>;
				var texture_aoMapSampler : sampler;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				var texture_aoDetailMap : texture_2d<f32>;
				var texture_aoDetailMapSampler : sampler;
			#endif
		#endif
		var <private> dEmission: vec3f;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			var texture_emissiveMap : texture_2d<f32>;
			var texture_emissiveMapSampler : sampler;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				var texture_clearCoatMap : texture_2d<f32>;
				var texture_clearCoatMapSampler : sampler;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				var texture_clearCoatGlossMap : texture_2d<f32>;
				var texture_clearCoatGlossMapSampler : sampler;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				var texture_clearCoatNormalMap : texture_2d<f32>;
				var texture_clearCoatNormalMapSampler : sampler;
			#endif
		#endif
		#ifdef LIT_GGX_SPECULAR
			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE
				var texture_anisotropyMap : texture_2d<f32>;
				var texture_anisotropyMapSampler : sampler;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			var<private> dLightmap: vec3f;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				var texture_lightMap : texture_2d<f32>;
				var texture_lightMapSampler : sampler;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`,stdFrontEndPS:`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#include "opacityPS"
		#if defined(LIT_ALPHA_TEST)
			#include "alphaTestPS"
		#endif
		#if STD_OPACITY_DITHER != NONE
			#include "opacityDitherPS"
		#endif
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				fn getSpecularity() { 
					dSpecularity = vec3f(1.0, 1.0, 1.0);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
			#include "anisotropyPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	fn evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = uniform.material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
				getAnisotropy();
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`,TBNPS:`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform tbnBasis: f32;
#endif
fn getTBN(tangent: vec3f, binormal: vec3f, normal: vec3f) {
	#ifdef TBN_TANGENTS
		dTBN = mat3x3f(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		let uv: vec2f = {lightingUv};
		let dp1: vec3f = dpdx( vPositionW );
		let dp2: vec3f = dpdy( vPositionW );
		let duv1: vec2f = dpdx( uv );
		let duv2: vec2f = dpdy( uv );
		let dp2perp: vec3f = cross( dp2, normal );
		let dp1perp: vec3f = cross( normal, dp1 );
		let T: vec3f = dp2perp * duv1.x + dp1perp * duv2.x;
		let B: vec3f = dp2perp * duv1.y + dp1perp * duv2.y;
		let denom: f32 = max( dot(T, T), dot(B, B) );
		let invmax: f32 = select(uniform.tbnBasis / sqrt( denom ), 0.0, denom == 0.0);
		dTBN = mat3x3f(T * invmax, -B * invmax, normal );
	#else
		var B: vec3f = cross(normal, vObjectSpaceUpW);
		var T: vec3f = cross(normal, B);
		if (dot(B,B) == 0.0)
		{
			let major: f32 = max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3f(0.0, 1.0, 0.0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3f(0.0, 0.0, 1.0));
				T = cross(normal, B);
			}
			else
			{
				B = cross(normal, vec3f(1.0, 0.0, 0.0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3x3f(normalize(T), normalize(B), normalize(normal));
	#endif
}`,thicknessPS:`
#ifdef STD_THICKNESS_CONSTANT
uniform material_thickness: f32;
#endif
fn getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness = dThickness * uniform.material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness = dThickness * textureSampleBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_NAME}Sampler, {STD_THICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness = dThickness * saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`,tonemappingPS:`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`,tonemappingAcesPS:`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	let tA: f32 = 2.51;
	let tB: f32 = 0.03;
	let tC: f32 = 2.43;
	let tD: f32 = 0.59;
	let tE: f32 = 0.14;
	let x: vec3f = color * uniform.exposure;
	return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);
}
`,tonemappingAces2PS:`
uniform exposure: f32;
const ACESInputMat: mat3x3f = mat3x3f(
	vec3f(0.59719, 0.35458, 0.04823),
	vec3f(0.07600, 0.90834, 0.01566),
	vec3f(0.02840, 0.13383, 0.83777)
);
const ACESOutputMat: mat3x3f = mat3x3f(
	vec3f( 1.60475, -0.53108, -0.07367),
	vec3f(-0.10208,  1.10813, -0.00605),
	vec3f(-0.00327, -0.07276,  1.07602)
);
fn RRTAndODTFit(v: vec3f) -> vec3f {
	let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);
	let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);
	return a / b;
}
fn toneMap(color: vec3f) -> vec3f {
	var c: vec3f = color * (uniform.exposure / 0.6);
	c = c * ACESInputMat;
	c = RRTAndODTFit(c);
	c = c * ACESOutputMat;
	return clamp(c, vec3f(0.0), vec3f(1.0));
}
`,tonemappingFilmicPS:`
const A: f32 = 0.15;
const B: f32 = 0.50;
const C: f32 = 0.10;
const D: f32 = 0.20;
const E: f32 = 0.02;
const F: f32 = 0.30;
const W: f32 = 11.2;
uniform exposure: f32;
fn uncharted2Tonemap(x: vec3f) -> vec3f {
	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);
}
fn toneMap(color: vec3f) -> vec3f {
	var c: vec3f = uncharted2Tonemap(color * uniform.exposure);
	let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));
	c *= whiteScale;
	return c;
}
`,tonemappingHejlPS:`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	let A: f32 = 0.22;
	let B: f32 = 0.3;
	let C: f32 = 0.1;
	let D: f32 = 0.2;
	let E: f32 = 0.01;
	let F: f32 = 0.3;
	let Scl: f32 = 1.25;
	let adjusted_color = color * uniform.exposure;
	let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));
	return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /
		   (h * (A * h + vec3f(B)) + vec3f(D * F)) -
		   Scl * vec3f(E / F);
}
`,tonemappingLinearPS:`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	return color * uniform.exposure;
}
`,tonemappingNeutralPS:`
uniform exposure: f32;
fn toneMap(col: vec3f) -> vec3f {
	var color = col * uniform.exposure;
	let startCompression = 0.8 - 0.04;
	let desaturation = 0.15;
	let x = min(color.r, min(color.g, color.b));
	let offset = select(0.04, x - 6.25 * x * x, x < 0.08);
	color -= vec3f(offset);
	let peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) {
		return color;
	}
	let d = 1.0 - startCompression;
	let newPeak = 1.0 - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);
	return mix(color, vec3f(newPeak), vec3f(g));
}
`,tonemappingNonePS:`
fn toneMap(color: vec3f) -> vec3f {
	return color;
}
`,transformVS:`
#ifdef PIXELSNAP
	uniform uScreenSize: vec4f;
#endif
#ifdef SCREENSPACE
	uniform projectionFlipY: f32;
#endif
fn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {
	var localPos: vec3f = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		var localPosXZ: vec2f = localPos.xz;
		localPosXZ = localPosXZ * uniform.outerScale;
		let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));
		let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));
		localPosXZ = localPosXZ + (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;
		dTiledUvGlobal = (localPosXZ - uniform.outerScale + uniform.innerOffset.xy) * -0.5 + 1.0;
		localPosXZ = localPosXZ * -0.5;
		localPos = vec3f(localPosXZ.x, localPosXZ.y, localPos.y);
	#endif
	var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);
	#ifdef SCREENSPACE
		posW = vec4f(posW.xy, 0.0, 1.0);
	#endif
	return posW;
}
fn getPosition() -> vec4f {
	dModelMatrix = getModelMatrix();
	let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	var screenPos: vec4f;
	#ifdef UV1LAYOUT
		screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);
		screenPos.y *= -1.0;
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= uniform.projectionFlipY;
		#else
			screenPos = uniform.matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uniforms.uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uniforms.uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
fn getWorldPosition() -> vec3f {
	return dPositionW;
}
`,transformCoreVS:`
	attribute vertex_position: vec4f;
	uniform matrix_viewProjection: mat4x4f;
	uniform matrix_model: mat4x4f;
	
	#ifdef MORPHING
		uniform morph_tex_params: vec2f;
		attribute morph_vertex_id: u32;
		fn getTextureMorphCoords() -> vec2i {
			var textureSize: vec2i = vec2i(uniform.morph_tex_params);
			var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;
			var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);
			morphGridV = textureSize.y - morphGridV - 1;
			return vec2i(morphGridU, morphGridV);
		}
		#ifdef MORPHING_POSITION
			#ifdef MORPHING_INT
				uniform aabbSize: vec3f;
				uniform aabbMin: vec3f;
				var morphPositionTex: texture_2d<u32>;
			#else
				var morphPositionTex: texture_2d<f32>;
			#endif
		#endif
	#endif
	#ifdef defined(BATCH)
		#include "skinBatchVS"
		fn getModelMatrix() -> mat4x4f {
			return getBoneMatrix(vertex_boneIndices);
		}
	#elif defined(SKIN)
		#include "skinVS"
		fn getModelMatrix() -> mat4x4f {
			return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
		}
	#elif defined(INSTANCING)
		#include "transformInstancingVS"
	#else
		fn getModelMatrix() -> mat4x4f {
			return uniform.matrix_model;
		}
	#endif
	fn getLocalPosition(vertexPosition: vec3f) -> vec3f {
		var localPos: vec3f = vertexPosition;
		#ifdef MORPHING_POSITION
			var morphUV: vec2i = getTextureMorphCoords();
			#ifdef MORPHING_INT
				var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;
			#else
				var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;
			#endif
			localPos += morphPos;
		#endif
		return localPos;
	}
`,transformInstancingVS:`
attribute instance_line1: vec4f;
attribute instance_line2: vec4f;
attribute instance_line3: vec4f;
attribute instance_line4: vec4f;
fn getModelMatrix() -> mat4x4f {
	return uniform.matrix_model * mat4x4f(instance_line1, instance_line2, instance_line3, instance_line4);
}
`,transmissionPS:`
#ifdef STD_REFRACTION_CONSTANT
	uniform material_refraction: f32;
#endif
fn getRefraction() {
	var refraction: f32 = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = uniform.material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction = refraction * textureSampleBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_NAME}Sampler, {STD_REFRACTION_TEXTURE_UV}, uniform.textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction = refraction * saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`,twoSidedLightingPS:`
uniform twoSidedLightingNegScaleFactor: f32;
fn handleTwoSidedLighting() {
	dTBN[2] = dTBN[2] * select(-uniform.twoSidedLightingNegScaleFactor, uniform.twoSidedLightingNegScaleFactor, pcFrontFacing);
}
`,uv0VS:`
#ifdef NINESLICED
	fn getUv0() -> vec2f {
		var uv = vertex_position.xz;
		let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
		let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
		uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;
		uv = uv * -0.5 + vec2f(0.5, 0.5);
		uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;
		dMaskGlobal = vertex_texCoord0.xy;
		return uv;
	}
#else
	fn getUv0() -> vec2f {
		return vertex_texCoord0;
	}
#endif
`,uv1VS:`
fn getUv1() -> vec2f {
	return vertex_texCoord1;
}
`,uvTransformVS:`
output.vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(
	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}0),
	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}1)
);
`,uvTransformUniformsPS:`
	uniform {TRANSFORM_NAME_{i}}0: vec3f;
	uniform {TRANSFORM_NAME_{i}}1: vec3f;
`,viewDirPS:`
fn getViewDir() {
	dViewDirW = normalize(uniform.view_position - vPositionW);
}
`,webgpuPS:`
`,webgpuVS:K_};function s0(o,a){return(s0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}m.app=null;var Pn=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._batcher=null,n._destroyRequested=!1,n._inFrameUpdate=!1,n._librariesLoaded=!1,n._fillMode=Cd,n._resolutionMode=MS,n._allowResize=!0,n._skyboxAsset=null,n._entityIndex={},n._inTools=!1,n._scriptPrefix="",n._time=0,n.enableBundles=typeof TextDecoder<"u",n.timeScale=1,n.maxDeltaTime=.1,n.frame=0,n.frameGraph=new KI,n.scriptsOrder=[],n.autoRender=!0,n.renderNextFrame=!1,n.lightmapper=null,n.loader=new Dd(n),n.scenes=new r0(n),n.scripts=new e0(n),n.systems=new XS,n.i18n=new $r(n),n.keyboard=null,n.mouse=null,n.touch=null,n.gamepads=null,n.elementInput=null,n.xr=null,a._applications[e.id]=n,xt=n,m.app=n,n.root=new ve,n.root._enabledInHierarchy=!0,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&s0(a,o);var i,t=a.prototype;return t.init=function(e){var n=this,r=e.assetPrefix,s=e.batchManager,l=e.componentSystems,u=e.elementInput,c=e.gamepads,h=e.graphicsDevice,f=e.keyboard,d=e.lightmapper,p=e.mouse,_=e.resourceHandlers,g=e.scriptsOrder,y=e.scriptPrefix,v=e.soundManager,x=e.touch,S=e.xr;this.graphicsDevice=h,re.get(h,ue).add(aL),re.get(h,he).add(oL),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new sL(h),this._soundManager=v,this.scene=new $e(h),this._registerSceneImmediate(this.scene),this.assets=new Jr(this.loader),r&&(this.assets.prefix=r),this.bundles=new WS(this.assets),this.scriptsOrder=g||[],this.defaultLayerWorld=new Ye({name:"World",id:0}),this.defaultLayerDepth=new Ye({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new Ye({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new Ye({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new Ye({name:"Immediate",id:3,opaqueSortMode:0});var T=new Ru("default");T.pushOpaque(this.defaultLayerWorld),T.pushOpaque(this.defaultLayerDepth),T.pushOpaque(this.defaultLayerSkybox),T.pushTransparent(this.defaultLayerWorld),T.pushOpaque(this.defaultLayerImmediate),T.pushTransparent(this.defaultLayerImmediate),T.pushTransparent(this.defaultLayerUi),this.scene.layers=T,kS.createPlaceholder(h),this.renderer=new id(h),this.renderer.scene=this.scene,d&&(this.lightmapper=new d(h,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(h,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=f||null,this.mouse=p||null,this.touch=x||null,this.gamepads=c||null,u&&(this.elementInput=u,this.elementInput.app=this),this.xr=S?new S(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=y||"",this.enableBundles&&this.loader.addHandler("bundle",new ZS(this)),_.forEach(function(b){var w=new b(n);n.loader.addHandler(w.handlerType,w)}),l.forEach(function(b){n.systems.add(new b(n))}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),typeof document<"u"&&(document.hidden!==void 0?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):document.mozHidden!==void 0?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):document.msHidden!==void 0?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):document.webkitHidden!==void 0&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=lL(this)},t._initDefaultMaterial=function(){var e,n=new it;n.name="Default Material",e=this.graphicsDevice,bg.get(e,function(){return n})},t._initProgramLibrary=function(){var e,n=new vS(this.graphicsDevice,new it);e=this.graphicsDevice,lg.get(e,function(){return n})},t.configure=function(e,n){var r=this;Fe.get(e,function(s,l){if(s)return void n(s);var u=l.application_properties,c=l.scenes,h=l.assets;r._parseApplicationProperties(u,function(f){r._parseScenes(c),r._parseAssets(h),n(f||null)})})},t.preload=function(e){var n=this;this.fire("preload:start");var r=this.assets.list({preload:!0});if(r.length===0){this.fire("preload:end"),e();return}var s=0,l=function(){s++,n.fire("preload:progress",s/r.length),s===r.length&&(n.fire("preload:end"),e())};r.forEach(function(u){u.loaded?l():(u.once("load",l),u.once("error",l),n.assets.load(u))})},t._preloadScripts=function(e,n){n()},t._parseApplicationProperties=function(e,n){if(typeof e.maxAssetRetries=="number"&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){var r=new Ru("application"),s={};for(var l in e.layers){var u=e.layers[l];u.id=parseInt(l,10),u.enabled=u.id!==1,s[l]=new Ye(u)}for(var c=0,h=e.layerOrder.length;c<h;c++){var f=e.layerOrder[c],d=s[f.layer];d&&(f.transparent?r.pushTransparent(d):r.pushOpaque(d),r.subLayerEnabled[c]=f.enabled)}this.scene.layers=r}if(e.batchGroups){var p=this.batcher;if(p)for(var _=0,g=e.batchGroups.length;_<g;_++){var y=e.batchGroups[_];p.addGroup(y.name,y.dynamic,y.maxAabbSize,y.id,y.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,n)},t._loadLibraries=function(e,n){var r=this,s=e.length,l=s,u=/^https?:\/\//;if(s)for(var c=function(d,p){l--,d?n(d):l===0&&(r.onLibrariesLoaded(),n(null))},h=0;h<s;++h){var f=e[h];!u.test(f.toLowerCase())&&this._scriptPrefix&&(f=ce.join(this._scriptPrefix,f)),this.loader.load(f,"script",c)}else this.onLibrariesLoaded(),n(null)},t._parseScenes=function(e){if(e)for(var n=0;n<e.length;n++)this.scenes.add(e[n].name,e[n].url)},t._parseAssets=function(e){for(var n=[],r={},s={},l=0;l<this.scriptsOrder.length;l++){var u=this.scriptsOrder[l];e[u]&&(r[u]=!0,n.push(e[u]))}if(this.enableBundles)for(var c in e)e[c].type==="bundle"&&(s[c]=!0,n.push(e[c]));for(var h in e)r[h]||s[h]||n.push(e[h]);for(var f=0;f<n.length;f++){var d=n[f],p=new $(d.name,d.type,d.file,d.data);if(p.id=parseInt(d.id,10),p.preload=!!d.preload&&d.preload,p.loaded=d.type==="script"&&d.data&&d.data.loadingType>0,p.tags.add(d.tags),d.i18n)for(var _ in d.i18n)p.addLocalizedAssetId(_,d.i18n[_]);this.assets.add(p)}},t.start=function(){this.frame=0,this.fire("start",{timestamp:un(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()},t.inputUpdate=function(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()},t.update=function(e){this.frame++,this.graphicsDevice.updateClientRect(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)},t.frameStart=function(){this.graphicsDevice.frameStart()},t.frameEnd=function(){this.graphicsDevice.frameEnd()},t.render=function(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")},t.renderComposition=function(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)},t._fillFrameStatsBasic=function(e,n,r){var s=this.stats.frame;s.dt=n,s.ms=r,e>s._timeToCountFrames?(s.fps=s._fpsAccum,s._fpsAccum=0,s._timeToCountFrames=e+1e3):s._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0},t._fillFrameStats=function(){var e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;var n=this.graphicsDevice._primsPerFrame;e.triangles=n[4]/3+Math.max(n[5]-2,0)+Math.max(n[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(var r=0;r<n.length;r++)r<4&&(e.otherPrimitives+=n[r]),n[r]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0},t.setCanvasFillMode=function(e,n,r){this._fillMode=e,this.resizeCanvas(n,r)},t.setCanvasResolution=function(e,n,r){this._resolutionMode=e,e===Pd&&n===void 0&&(n=this.graphicsDevice.canvas.clientWidth,r=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(n,r)},t.isHidden=function(){return document[this._hiddenAttr]},t.onVisibilityChange=function(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()},t.resizeCanvas=function(e,n){if(this._allowResize&&(!this.xr||!this.xr.session)){var r=window.innerWidth,s=window.innerHeight;if(this._fillMode===Cd){var l=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;l>r/s?n=(e=r)/l:e=(n=s)*l}else this._fillMode===DS&&(e=r,n=s);return this.graphicsDevice.canvas.style.width=""+e+"px",this.graphicsDevice.canvas.style.height=""+n+"px",this.updateCanvasSize(),{width:e,height:n}}},t.updateCanvasSize=function(){var e;if(this._allowResize&&((e=this.xr)==null||!e.active)&&this._resolutionMode===Pd){var n=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(n.clientWidth,n.clientHeight)}},t.onLibrariesLoaded=function(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()},t.applySceneSettings=function(e){var n;if(this.systems.rigidbody&&typeof Ammo<"u"){var r=e.physics.gravity,s=r[0],l=r[1],u=r[2];this.systems.rigidbody.gravity.set(s,l,u)}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(n=this.assets.get(e.render.skybox))?this.setSkybox(n):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null))},t.setAreaLightLuts=function(e,n){e&&n&&kS.set(this.graphicsDevice,e,n)},t.setSkybox=function(e){var n=this;if(e!==this._skyboxAsset){var r=function(){n.setSkybox(null)},s=function(){n.scene.setSkybox(n._skyboxAsset?n._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,r,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,r,this),this._skyboxAsset.on("change",s,this),this.scene.skyboxMip!==0||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}},t._firstBake=function(){var e;(e=this.lightmapper)==null||e.bake(null,this.scene.lightmapMode)},t._firstBatch=function(){var e;(e=this.batcher)==null||e.generate()},t._processTimestamp=function(e){return e},t.drawLine=function(e,n,r,s,l){this.scene.drawLine(e,n,r,s,l)},t.drawLines=function(e,n,r,s){r===void 0&&(r=!0),s===void 0&&(s=this.scene.defaultDrawLayer),this.scene.drawLines(e,n,r,s)},t.drawLineArrays=function(e,n,r,s){r===void 0&&(r=!0),s===void 0&&(s=this.scene.defaultDrawLayer),this.scene.drawLineArrays(e,n,r,s)},t.drawWireSphere=function(e,n,r,s,l,u){r===void 0&&(r=B.WHITE),s===void 0&&(s=20),l===void 0&&(l=!0),u===void 0&&(u=this.scene.defaultDrawLayer),this.scene.immediate.drawWireSphere(e,n,r,s,l,u)},t.drawWireAlignedBox=function(e,n,r,s,l,u){r===void 0&&(r=B.WHITE),s===void 0&&(s=!0),l===void 0&&(l=this.scene.defaultDrawLayer),this.scene.immediate.drawWireAlignedBox(e,n,r,s,l,u)},t.drawMeshInstance=function(e,n){n===void 0&&(n=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(null,null,null,e,n)},t.drawMesh=function(e,n,r,s){s===void 0&&(s=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(n,r,e,null,s)},t.drawQuad=function(e,n,r){r===void 0&&(r=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(n,e,this.scene.immediate.getQuadMesh(),null,r)},t.drawTexture=function(e,n,r,s,l,u,c,h){if(c===void 0&&(c=this.scene.defaultDrawLayer),h===void 0&&(h=!0),h!==!1||this.graphicsDevice.isWebGPU){var f=new X;f.setTRS(new E(e,n,0),Z.IDENTITY,new E(r,-s,0)),u||((u=new hr).cull=0,u.setParameter("colorMap",l),u.shaderDesc=h?this.scene.immediate.getTextureShaderDesc(l.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),u.update()),this.drawQuad(f,u,c)}},t.drawDepthTexture=function(e,n,r,s,l){l===void 0&&(l=this.scene.defaultDrawLayer);var u=new hr;u.cull=0,u.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),u.update(),this.drawTexture(e,n,r,s,null,u,l)},t.destroy=function(){if(this._inFrameUpdate){this._destroyRequested=!0;return}var e,n,r,s,l=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),typeof document<"u"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();for(var u=this.assets.list(),c=0;c<u.length;c++)u[c].unload(),u[c].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;var h=this.loader.getHandler("script");h==null||h.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,(e=this.lightmapper)==null||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,(n=this.xr)==null||n.end(),(r=this.xr)==null||r.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),(s=this._soundManager)==null||s.destroy(),this._soundManager=null,Id.app=null,a._applications[l]=null,xt===this&&(xt=null),a.cancelTick(this)},t.getEntityFromIndex=function(e){return this._entityIndex[e]},t._registerSceneImmediate=function(e){this.on("postrender",e.immediate.onPostRender,e.immediate)},a.getApplication=function(e){return e?a._applications[e]:xt},a.cancelTick=function(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)},i=[{key:"soundManager",get:function(){return this._soundManager}},{key:"batcher",get:function(){return this._batcher}},{key:"fillMode",get:function(){return this._fillMode}},{key:"resolutionMode",get:function(){return this._resolutionMode}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);Pn._applications={};var Rd={},lL=function(o){return function(a,i){if(o.graphicsDevice){o.frameRequestId&&((n=o.xr)==null||(e=n.session)==null||e.cancelAnimationFrame(o.frameRequestId),cancelAnimationFrame(o.frameRequestId),o.frameRequestId=null),o._inFrameUpdate=!0,xt=o,m.app=o;var t,e,n,r,s=o._processTimestamp(a)||un(),l=s-(o._time||s),u=l/1e3;if(u=U.clamp(u,0,o.maxDeltaTime)*o.timeScale,o._time=s,(t=o.xr)!=null&&t.session?o.frameRequestId=o.xr.session.requestAnimationFrame(o.tick):o.frameRequestId=fe.browser||fe.worker?requestAnimationFrame(o.tick):null,!o.graphicsDevice.contextLost){o._fillFrameStatsBasic(s,u,l),o.fire("frameupdate",l);var c=!0;i?(c=(r=o.xr)==null?void 0:r.update(i),o.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer):o.graphicsDevice.defaultFramebuffer=null,c&&(o.update(u),o.fire("framerender"),(o.autoRender||o.renderNextFrame)&&(o.updateCanvasSize(),o.frameStart(),o.render(),o.frameEnd(),o.renderNextFrame=!1),Rd.timestamp=un(),Rd.target=o,o.fire("frameend",Rd)),o._inFrameUpdate=!1,o._destroyRequested&&o.destroy()}}}},a0=function(){this.componentSystems=[],this.resourceHandlers=[]},Jo=new to,o0=function(){function o(i,t,e){this.scene=i,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!e.shadowsEnabled&&(t.castShadows=!1),t.type!==0&&(t._node.getWorldTransform(),t.getBoundingSphere(Jo),this.lightBounds=new Se,this.lightBounds.center.copy(Jo.center),this.lightBounds.halfExtents.set(Jo.radius,Jo.radius,Jo.radius))}var a=o.prototype;return a.store=function(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows},a.restore=function(){var i=this.light;i.mask=this.mask,i.shadowUpdateMode=this.shadowUpdateMode,i.enabled=this.enabled,i.intensity=this.intensity,i._node.setLocalRotation(this.rotation),i.numCascades=this.numCascades,i._castShadows=this.castShadows},a.startBake=function(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()},a.endBake=function(i){var t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&i.add(t,t.shadowMap),t.shadowMap=null)},o}();function l0(o,a){return(l0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var rc=new G,uL=function(o){var a;if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function i(t,e){return o.call(this,t.scene,e,t.lightingParams)||this}return i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),o&&l0(i,o),i.prototype.prepareVirtualLight=function(t,e){var n=this.light;if(n._node.setLocalRotation(this.rotation),t>0){var r=n.bakeArea;Ho.circlePointDeterministic(rc,t,e),rc.mulScalar(.5*r),n._node.rotateLocal(rc.x,0,rc.y)}n._node.getWorldTransform(),n.intensity=Math.pow(Math.pow(this.intensity,2.2)/e,.45454545454545453)},a=[{key:"numVirtualLights",get:function(){return this.light.type===0?this.light.bakeNumSamples:1}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(i.prototype,a),i}(o0);function u0(o,a){return(u0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var c0=new E,$o=function(o){var a;if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function i(t){var e=t.scene,n=new ve("AmbientLight");return n.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:e.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:B.WHITE,intensity:1,bakeDir:!1}),o.call(this,e,n.light.light,t.lightingParams)||this}return i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),o&&u0(i,o),i.prototype.prepareVirtualLight=function(t,e){Ho.spherePointDeterministic(c0,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(c0.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);var n=Math.pow(2*Math.PI*this.scene.ambientBakeSpherePart,2.2);this.light.intensity=Math.pow(n/e,.45454545454545453)},a=[{key:"numVirtualLights",get:function(){return this.light.bakeNumSamples}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(i.prototype,a),i}(o0),sc=function(){function o(i,t){t===void 0&&(t=null),this.node=i,this.component=i.render||i.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}var a=o.prototype;return a.store=function(){this.castShadows=this.component.castShadows},a.restore=function(){this.component.castShadows=this.castShadows},o}(),cL={glslBilateralDeNoisePS:`
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
vec3 decode(vec4 pixel) {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[{MSIZE}];
void main(void) {
	
	vec4 pixel = texture2DLod(source, vUv0, 0.0);
	if (!isUsed(pixel)) {
		gl_FragColor = pixel;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decode(pixel);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.000001;
	const int kSize = ({MSIZE} - 1) / 2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 pix = texture2DLod(source, coord, 0.0);
			if (isUsed(pix)) {
				vec3 hdr = decode(pix);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	vec3 finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		gl_FragColor = vec4(finalHDR, 1.0);
	#else
		gl_FragColor = encodeRGBM(finalHDR);
	#endif
}
`,glslDilatePS:`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
void main(void) {
	vec4 c = texture2DLod(source, vUv0, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);
	gl_FragColor = c;
}
`},hL={wgslBilateralDeNoisePS:`
fn normpdf3(v: vec3f, sigma: f32) -> f32 {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
fn decodeRGBM(rgbm: vec4f) -> vec3f {
	let color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn encodeRGBM(color: vec3f) -> vec4f {
	var encoded: vec4f;
	let rgb_processed = pow(color.rgb, vec3f(0.5)) * (1.0 / 8.0);
	encoded = vec4f(rgb_processed, 0.0);
	let max_g_b = max( encoded.g, max( encoded.b, 1.0 / 255.0 ) );
	let max_rgb = max( encoded.r, max_g_b );
	encoded.a = clamp(max_rgb, 0.0, 1.0);
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded = vec4f(encoded.rgb / encoded.a, encoded.a);
	return encoded;
}
fn decode(pixel: vec4f) -> vec3f {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
fn isUsed(pixel: vec4f) -> bool {
	#if HDR
		return any(pixel.rgb > vec3f(0.0));
	#else
		return pixel.a > 0.0;
	#endif
}
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
uniform kernel: array<f32, {MSIZE}>;
uniform pixelOffset: vec2f;
uniform sigmas: vec2f;
uniform bZnorm: f32;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let pixel = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);
	if (!isUsed(pixel)) {
		output.color = pixel;
		return output;
	}
	let sigma = uniform.sigmas.x;
	let bSigma = uniform.sigmas.y;
	let pixelHdr = decode(pixel);
	var accumulatedHdr = vec3f(0.0);
	var accumulatedFactor = 0.000001;
	const kSize = ({MSIZE} - 1) / 2;
	for (var i: i32 = -kSize; i <= kSize; i = i + 1) {
		for (var j: i32 = -kSize; j <= kSize; j = j + 1) {
			let coord = input.vUv0 + vec2f(f32(i), f32(j)) * uniform.pixelOffset;
			let pix = textureSampleLevel(source, sourceSampler, coord, 0.0);
			if (isUsed(pix)) {
				let hdr = decode(pix);
				var factor = uniform.kernel[u32(kSize + j)].element * uniform.kernel[u32(kSize + i)].element;
				factor = factor * normpdf3(hdr - pixelHdr, bSigma) * uniform.bZnorm;
				accumulatedHdr = accumulatedHdr + factor * hdr;
				accumulatedFactor = accumulatedFactor + factor;
			}
		}
	}
	let finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		output.color = vec4f(finalHDR, 1.0);
	#else
		output.color = encodeRGBM(finalHDR);
	#endif
	return output;
}
`,wgslDilatePS:`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
uniform pixelOffset: vec2f;
fn isUsed(pixel: vec4f) -> bool {
	#ifdef HDR
		return any(pixel.rgb > vec3f(0.0));
	#else
		return pixel.a > 0.0;
	#endif
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var c: vec4f = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 - uniform.pixelOffset, 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, -uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, -uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + uniform.pixelOffset, 0.0), c, isUsed(c));
	var output: FragmentOutput;
	output.color = c;
	return output;
}
`},fL=function(){function o(i){this.shaderDilate=[],this.shaderDenoise=[],this.device=i,re.get(this.device,ue).add(cL),re.get(this.device,he).add(hL),this.constantTexSource=i.scope.resolve("source"),this.constantPixelOffset=i.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.sigmas=null,this.constantSigmas=null,this.kernel=null}var a=o.prototype;return a.setSourceTexture=function(i){this.constantTexSource.setValue(i)},a.prepare=function(i,t){this.pixelOffset[0]=1/i,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)},a.prepareDenoise=function(i,t,e){var n=+!e;if(!this.shaderDenoise[n]){var r=new Map;r.set("{MSIZE}",15),e&&r.set("HDR",""),this.shaderDenoise[n]=Te.createShader(this.device,{uniqueName:"lmBilateralDeNoise-"+(e?"hdr":"rgbm"),attributes:{vertex_position:oe},vertexGLSL:re.get(this.device,ue).get("fullscreenQuadVS"),vertexWGSL:re.get(this.device,he).get("fullscreenQuadVS"),fragmentGLSL:re.get(this.device,ue).get("glslBilateralDeNoisePS"),fragmentWGSL:re.get(this.device,he).get("wgslBilateralDeNoisePS"),fragmentDefines:r}),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")}this.sigmas[0]=i,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(i,t)},a.getDenoise=function(i){return this.shaderDenoise[+!i]},a.getDilate=function(i,t){var e=+!t;if(!this.shaderDilate[e]){var n=t?`#define HDR
`:"";this.shaderDilate[e]=Te.createShader(i,{uniqueName:"lmDilate-"+(t?"hdr":"rgbm"),attributes:{vertex_position:oe},vertexGLSL:re.get(this.device,ue).get("fullscreenQuadVS"),vertexWGSL:re.get(this.device,he).get("fullscreenQuadVS"),fragmentGLSL:n+re.get(this.device,ue).get("glslDilatePS"),fragmentWGSL:n+re.get(this.device,he).get("wgslDilatePS")})}return this.shaderDilate[e]},a.evaluateDenoiseUniforms=function(i,t){function e(c,h){return .39894*Math.exp(-.5*c*c/(h*h))/h}this.kernel=this.kernel||new Float32Array(15);for(var n=this.kernel,r=Math.floor(7),s=0;s<=r;++s){var l=e(s,i);n[r+s]=l,n[r-s]=l}this.constantKernel.setValue(this.kernel);var u=1/e(0,t);this.bZnorm.setValue(u)},o}();function h0(o,a){return(h0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var dL=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s,l){var u;return(u=o.call(this,t)||this).viewBindGroups=[],u.renderer=e,u.camera=n,u.worldClusters=r,u.receivers=s,u.lightArray=l,u}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&h0(a,o);var i=a.prototype;return i.destroy=function(){this.viewBindGroups.forEach(function(t){t.defaultUniformBuffer.destroy(),t.destroy()}),this.viewBindGroups.length=0},i.execute=function(){this.device;var t=this.renderer,e=this.camera,n=this.receivers,r=this.renderTarget,s=this.worldClusters,l=this.lightArray;t.renderForwardLayer(e,r,null,void 0,0,this.viewBindGroups,{meshInstances:n,splitLights:l,lightClusters:s})},a}(ct),$n=new E,f0=function(){function o(i,t,e,n,r){this.device=i,this.root=t,this.scene=e,this.renderer=n,this.assets=r,this.shadowMapCache=n.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new B,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}var a=o.prototype;return a.destroy=function(){var i;Ei.decRef(this.blackTex),this.blackTex=null,Ei.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,(i=this.camera)==null||i.destroy(),this.camera=null},a.initBake=function(i){if(this.bakeHDR=this.scene.lightmapPixelFormat!==7,!this._initCalled){this._initCalled=!0,this.lightmapFilters=new fL(i),this.constantBakeDir=i.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new ee(this.device,{width:4,height:4,format:7,type:Wn,name:"lightmapBlack"}),Ei.incRef(this.blackTex);var t=new Eu;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=1,t.aspectRatio=1,t.node=new pe,this.camera=t,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0}if(this.scene.clusteredLightingEnabled){var e=new ld(i.supportsAreaLights,i.maxTextureSize,function(){});this.lightingParams=e;var n=this.scene.lighting;e.shadowsEnabled=n.shadowsEnabled,e.shadowAtlasResolution=n.shadowAtlasResolution,e.cookiesEnabled=n.cookiesEnabled,e.cookieAtlasResolution=n.cookieAtlasResolution,e.areaLightsEnabled=n.areaLightsEnabled,e.cells=new E(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new Iu(i),this.worldClusters.name="ClusterLightmapper"}},a.finishBake=function(i){function t(e){Ei.decRef(e.colorBuffer),e.destroy()}this.materials=[],this.renderTargets.forEach(function(e){t(e)}),this.renderTargets.clear(),i.forEach(function(e){e.renderTargets.forEach(function(n){t(n)}),e.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)},a.createMaterialForPass=function(i,t,e){var n=new it;return n.name="lmMaterial-pass:"+t+"-ambient:"+e,n.setDefine("UV1LAYOUT",""),n.setDefine("LIT_LIGHTMAP_BAKING",""),t===0?(n.setDefine("LIT_LIGHTMAP_BAKING_COLOR",""),e?n.setDefine("LIT_LIGHTMAP_BAKING_ADD_AMBIENT",""):n.ambient=new B(0,0,0),this.bakeHDR||n.setDefine("LIGHTMAP_RGBM",""),n.lightMap=this.blackTex):(n.setDefine("LIT_LIGHTMAP_BAKING_DIR",""),n.setDefine("STD_LIGHTMAP_DIR","")),n.cull=0,n.forceUv1=!0,n.update(),n},a.createMaterials=function(i,t,e){for(var n=0;n<e;n++)this.passMaterials[n]||(this.passMaterials[n]=this.createMaterialForPass(t,n,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,0,!0),this.ambientAOMaterial.onUpdateShader=function(r){return r.litOptions.lightMapWithoutAmbient=!0,r.litOptions.separateAmbient=!0,r})},a.createTexture=function(i,t){return new ee(this.device,{width:i,height:i,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.bakeHDR?Wt:Wn,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})},a.collectModels=function(i,t,e){if(i.enabled){if((n=i.model)!=null&&n.model&&((r=i.model)!=null&&r.enabled)&&(e&&e.push(new sc(i)),i.model.lightmapped&&t&&(l=i.model.model.meshInstances)),(s=i.render)!=null&&s.enabled&&(e&&e.push(new sc(i)),i.render.lightmapped&&t&&(l=i.render.meshInstances)),l){for(var n,r,s,l,u=!0,c=0;c<l.length;c++)if(!l[c].mesh.vertexBuffer.format.hasUv1){u=!1;break}if(u){for(var h=[],f=0;f<l.length;f++){var d=l[f].mesh;this._tempSet.has(d)?t.push(new sc(i,[l[f]])):h.push(l[f]),this._tempSet.add(d)}this._tempSet.clear(),h.length>0&&t.push(new sc(i,h))}}for(var p=0;p<i._children.length;p++)this.collectModels(i._children[p],t,e)}},a.prepareShadowCasters=function(i){for(var t=[],e=0;e<i.length;e++){var n=i[e].component;if(n.castShadows=n.castShadowsLightmap,n.castShadowsLightmap)for(var r=i[e].meshInstances,s=0;s<r.length;s++)r[s].visibleThisFrame=!0,t.push(r[s])}return t},a.updateTransforms=function(i){for(var t=0;t<i.length;t++)for(var e=i[t].meshInstances,n=0;n<e.length;n++)e[n].node.getWorldTransform()},a.calculateLightmapSize=function(i){var t,e,n,r=this.scene.lightmapSizeMultiplier||16;i.model?(n=i.model.lightmapSizeMultiplier,i.model.asset?(t=this.assets.get(i.model.asset).data).area&&(e=t.area):i.model._area&&(t=i.model)._area&&(e=t._area)):i.render&&(n=i.render.lightmapSizeMultiplier,i.render.type!=="asset"&&i.render._area&&(t=i.render)._area&&(e=t._area));var s={x:1,y:1,z:1,uv:1};e&&(s.x=e.x,s.y=e.y,s.z=e.z,s.uv=e.uv);var l=n||1;s.x*=l,s.y*=l,s.z*=l;var u=i.render||i.model,c=this.computeNodeBounds(u.meshInstances);$n.copy(c.halfExtents);var h=s.x*$n.y*$n.z+s.y*$n.x*$n.z+s.z*$n.x*$n.y;return h/=s.uv,h=Math.sqrt(h),Math.min(U.nextPowerOfTwo(h*r),this.scene.lightmapMaxResolution||2048)},a.setLightmapping=function(i,t,e,n){for(var r=0;r<i.length;r++)for(var s=i[r],l=s.meshInstances,u=0;u<l.length;u++){var c=l[u];if(c.setLightmapped(t),t){n&&(c._shaderDefs|=n),c.mask=2;for(var h=0;h<e;h++){var f=s.renderTargets[h].colorBuffer;f.minFilter=1,f.magFilter=1,c.setRealtimeLightmap(De.lightmapParamNames[h],f)}}}},a.bake=function(i,t){t===void 0&&(t=1);var e=this.device,n=un();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;var r=e._shaderStats.linked,s=e._renderTargetCreationTime,l=e._shaderStats.compileTime,u=[],c=[];if(i){for(var h=0;h<i.length;h++)this.collectModels(i[h],u,null);this.collectModels(this.root,null,c)}else this.collectModels(this.root,u,c);if(u.length>0){this.renderer.shadowRenderer.frameUpdate();var f=t===1?2:1;this.setLightmapping(u,!1,f),this.initBake(e),this.bakeInternal(f,u,c);var d=64;t===1&&(d|=128),this.scene.ambientBake&&(d|=4096),this.setLightmapping(u,!0,f,d),this.finishBake(u)}var p=un();this.stats.totalRenderTime=p-n,this.stats.shadersLinked=e._shaderStats.linked-r,this.stats.compileTime=e._shaderStats.compileTime-l,this.stats.fboTime=e._renderTargetCreationTime-s,this.stats.lightmapCount=u.length},a.allocateTextures=function(i,t){for(var e=0;e<i.length;e++){for(var n=i[e],r=this.calculateLightmapSize(n.node),s=0;s<t;s++){var l=this.createTexture(r,"lightmapper_lightmap_"+e);Ei.incRef(l),n.renderTargets[s]=new Ee({colorBuffer:l,depth:!1})}if(!this.renderTargets.has(r)){var u=this.createTexture(r,"lightmapper_temp_lightmap_"+r);Ei.incRef(u),this.renderTargets.set(r,new Ee({colorBuffer:u,depth:!1}))}}},a.prepareLightsToBake=function(i,t){if(this.scene.ambientBake){var e=new $o(this);t.push(e)}for(var n=this.renderer.lights,r=0;r<n.length;r++){var s=n[r],l=new uL(this,s);i.push(l),s.enabled&&4&s.mask&&(s.mask=7,s.shadowUpdateMode=s.type===0?2:1,t.push(l))}t.sort()},a.restoreLights=function(i){for(var t=0;t<i.length;t++)i[t].restore()},a.setupScene=function(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants(),this.device.scope.resolve("ambientBakeOcclusionContrast").setValue(this.scene.ambientBakeOcclusionContrast),this.device.scope.resolve("ambientBakeOcclusionBrightness").setValue(this.scene.ambientBakeOcclusionBrightness)},a.restoreScene=function(){this.scene.ambientLight.copy(this.ambientLight)},a.computeNodeBounds=function(i){var t=new Se;if(i.length>0){t.copy(i[0].aabb);for(var e=1;e<i.length;e++)t.add(i[e].aabb)}return t},a.computeNodesBounds=function(i){for(var t=0;t<i.length;t++){var e=i[t].meshInstances;i[t].bounds=this.computeNodeBounds(e)}},a.computeBounds=function(i){for(var t=new Se,e=0;e<i.length;e++){t.copy(i[0].aabb);for(var n=1;n<i.length;n++)t.add(i[n].aabb)}return t},a.backupMaterials=function(i){for(var t=0;t<i.length;t++)this.materials[t]=i[t].material},a.restoreMaterials=function(i){for(var t=0;t<i.length;t++)i[t].material=this.materials[t]},a.lightCameraPrepare=function(i,t){var e,n=t.light;return n.type===2&&((e=n.getRenderData(null,0).shadowCamera)._node.setPosition(n._node.getPosition()),e._node.setRotation(n._node.getRotation()),e._node.rotateLocal(-90,0,0),e.projection=0,e.nearClip=n.attenuationEnd/1e3,e.farClip=n.attenuationEnd,e.aspectRatio=1,e.fov=2*n._outerConeAngle,this.renderer.updateCameraFrustum(e)),e},a.lightCameraPrepareAndCull=function(i,t,e,n){var r=i.light,s=!0;if(r.type===0){$n.copy(n.center),$n.y+=n.halfExtents.y,this.camera.node.setPosition($n),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*n.halfExtents.y;var l=Math.max(n.halfExtents.x,n.halfExtents.z);this.camera.orthoHeight=l}else i.lightBounds.intersects(t.bounds)||(s=!1);if(r.type===2){for(var u=!1,c=t.meshInstances,h=0;h<c.length;h++)if(c[h]._isVisible(e)){u=!0;break}u||(s=!1)}return s},a.setupLightArray=function(i,t){i[0].length=0,i[1].length=0,i[2].length=0,i[t.type][0]=t,t.visibleThisFrame=!0},a.renderShadowMap=function(i,t,e,n){var r=n.light,s=this.scene.clusteredLightingEnabled,l=r.castShadows&&(!s||this.scene.lighting.shadowsEnabled);if(!t&&l)if(r.shadowMap||s||(r.shadowMap=this.shadowMapCache.get(this.device,r)),r.type===0){this.renderer._shadowRendererDirectional.cull(r,i,this.camera,e);var u=this.renderer._shadowRendererDirectional.getLightRenderPass(r,this.camera);u==null||u.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(r,i,e),this.renderer.shadowRenderer.render(r,this.camera,!1)}return!0},a.postprocessTextures=function(i,t,e){var n,r=this.lightmapFilters.getDilate(i,this.bakeHDR),s=this.scene.lightmapFilterEnabled;s&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),n=this.lightmapFilters.getDenoise(this.bakeHDR)),i.setBlendState(ge.NOBLEND),i.setDepthState(Xe.NODEPTH),i.setStencilState(null,null);for(var l=0;l<t.length;l++)for(var u=t[l],c=0;c<e;c++){var h=u.renderTargets[c],f=h.colorBuffer,d=this.renderTargets.get(f.width),p=d.colorBuffer;this.lightmapFilters.prepare(f.width,f.height);for(var _=0;_<1;_++)this.lightmapFilters.setSourceTexture(f),kt(i,d,s&&c===0&&_===0?n:r),this.lightmapFilters.setSourceTexture(p),kt(i,h,r)}},a.bakeInternal=function(i,t,e){var n,r,s,l,u,c,h=this.scene,f=h.layers,d=this.device,p=h.clusteredLightingEnabled;this.createMaterials(d,h,i),this.setupScene(),f._update(),this.computeNodesBounds(t),this.allocateTextures(t,i),this.renderer.collectLights(f);var _=[],g=[];this.prepareLightsToBake(_,g),this.updateTransforms(e);var y=this.prepareShadowCasters(e);this.renderer.updateCpuSkinMatrices(y),this.renderer.gpuUpdate(y);var v=this.computeBounds(y);for(n=0;n<t.length;n++)for(r=0,s=t[n].meshInstances;r<s.length;r++)(l=s[r]).setLightmapped(!1),l.mask=4,l.setRealtimeLightmap(De.lightmapParamNames[0],this.blackTex),l.setRealtimeLightmap(De.lightmapParamNames[1],this.blackTex);for(r=0;r<g.length;r++)g[r].light.enabled=!1;var x=[[],[],[]],S=!1;for(n=0;n<g.length;n++){var T=g[n],b=$o!=null&&typeof Symbol<"u"&&$o[Symbol.hasInstance]?!!$o[Symbol.hasInstance](T):Q(T,$o),w=T.light.type===0,A=T.numVirtualLights;i>1&&A>1&&T.light.bakeDir&&(A=1);for(var C=0;C<A;C++){A>1&&T.prepareVirtualLight(C,A),T.startBake();var L=!1,I=this.lightCameraPrepare(d,T);for(c=0;c<t.length;c++){var P=t[c];if(s=P.meshInstances,this.lightCameraPrepareAndCull(T,P,I,v)){this.setupLightArray(x,T.light);var M=w?[]:[T.light];for(p&&this.renderer.lightTextureAtlas.update(M,this.lightingParams),L=this.renderShadowMap(f,L,y,T),p&&this.worldClusters.update(M,this.lightingParams),this.backupMaterials(s),u=0;u<i&&(!(u>0)||!(C>0))&&(!b||!(u>0));u++){var R=P.renderTargets[u],k=P.renderTargets[u].colorBuffer.width,D=this.renderTargets.get(k),O=D.colorBuffer;u===0?S=h.updateShaders:S&&(h.updateShaders=!0);var F=this.passMaterials[u];for(b&&C+1===A&&u===0&&(F=this.ambientAOMaterial),r=0;r<s.length;r++)s[r].material=F;if(this.renderer.updateShaders(s),u===1&&this.constantBakeDir.setValue(+!!T.light.bakeDir),d.isWebGPU){var N=new dL(d,this.renderer,this.camera,p?this.worldClusters:null,s,x);N.init(D),N.render(),N.destroy()}else this.renderer.setCamera(this.camera,D,!0),p&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,D,s,x,0),d.updateEnd();for(P.renderTargets[u]=D,this.renderTargets.set(k,R),r=0;r<s.length;r++)(l=s[r]).setRealtimeLightmap(De.lightmapParamNames[u],O),l._shaderDefs|=64}this.restoreMaterials(s)}}T.endBake(this.shadowMapCache)}}for(this.postprocessTextures(d,t,i),c=0;c<e.length;c++)e[c].restore();this.restoreLights(_),this.restoreScene(),p||this.shadowMapCache.clear()},o}();function d0(o,a){return(d0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var de=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this).system=e,r.entity=n,r.system.schema&&!r._accessorsBuilt&&r.buildAccessors(r.system.schema),r.on("set",function(s,l,u){this.fire("set_"+s,s,l,u)}),r.on("set_enabled",r.onSetEnabled,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&d0(a,o);var i,t=a.prototype;return t.buildAccessors=function(e){a._buildAccessors(this,e)},t.onSetEnabled=function(e,n,r){n!==r&&this.entity.enabled&&(r?this.onEnable():this.onDisable())},t.onEnable=function(){},t.onDisable=function(){},t.onPostStateChange=function(){},a._buildAccessors=function(e,n){n.forEach(function(r){var s=(r===void 0?"undefined":r&&typeof Symbol<"u"&&r.constructor===Symbol?"symbol":typeof r)=="object"?r.name:r;Object.defineProperty(e,s,{get:function(){return this.data[s]},set:function(l){var u=this.data,c=u[s];u[s]=l,this.fire("set",s,c,l)},configurable:!0})}),e._accessorsBuilt=!0},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return!0},set:function(e){}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function el(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function p0(o,a){return(p0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function m0(o){return o&&typeof Symbol<"u"&&o.constructor===Symbol?"symbol":typeof o}de.order=0;var We=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this).app=t,e.store={},e.schema=[],e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&p0(a,o);var i=a.prototype;return i.addComponent=function(t,e){e===void 0&&(e={});var n=new this.ComponentType(this,t),r=new this.DataType;return this.store[t.getGuid()]={entity:t,data:r},t[this.id]=n,t.c[this.id]=n,this.initializeComponentData(n,e,[]),this.fire("add",t,n),n},i.removeComponent=function(t){var e=this.id,n=this.store[t.getGuid()],r=t.c[e];r.fire("beforeremove"),this.fire("beforeremove",t,r),delete this.store[t.getGuid()],t[e]=void 0,delete t.c[e],this.fire("remove",t,n.data)},i.cloneComponent=function(t,e){var n=this.store[t.getGuid()];return this.addComponent(e,n.data)},i.initializeComponentData=function(t,e,n){e===void 0&&(e={});for(var r=0,s=n.length;r<s;r++){var l=n[r],u=void 0,c=void 0;(l===void 0?"undefined":m0(l))==="object"?(u=l.name,c=l.type):(u=l,c=void 0);var h=e[u];h!==void 0?(c!==void 0&&(h=function(f,d){if(!f)return f;switch(d){case"rgb":return el(f,B)?f.clone():new B(f[0],f[1],f[2]);case"rgba":return el(f,B)?f.clone():new B(f[0],f[1],f[2],f[3]);case"vec2":return el(f,G)?f.clone():new G(f[0],f[1]);case"vec3":return el(f,E)?f.clone():new E(f[0],f[1],f[2]);case"vec4":return el(f,q)?f.clone():new q(f[0],f[1],f[2],f[3]);case"boolean":case"number":case"string":case"entity":return f;default:throw Error("Could not convert unhandled type: "+d)}}(h,c)),t[u]=h):t[u]=t.data[u]}t.enabled&&t.entity.enabled&&t.onEnable()},i.getPropertiesOfType=function(t){var e=[];return(this.schema||[]).forEach(function(n){n&&(n===void 0?"undefined":m0(n))==="object"&&n.type===t&&e.push(n)}),e},i.destroy=function(){this.off()},a}(se),pL=function(){function o(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}var a=o.prototype;return a.update=function(i,t){if(i<this._left||i>=this._right){var e=t.length;if(e)if(i<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(i>=t[e-1])this._left=t[e-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=e-1;else{var n=this._findKey(i,t);this._left=t[n],this._right=t[n+1],this._len=this._right-this._left;var r=1/this._len;this._recip=isFinite(r)?r:0,this._p0=n,this._p1=n+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=this._recip===0?0:(i-this._left)*this._recip,this._hermite.valid=!1},a._findKey=function(i,t){for(var e=0;i>=t[e+1];)e++;return e},a.eval=function(i,t,e){var n=e._data,r=e._components,s=this._p0*r;if(t===0)for(var l=0;l<r;++l)i[l]=n[s+l];else{var u=this._t,c=this._p1*r;switch(t){case 1:for(var h=0;h<r;++h)i[h]=U.lerp(n[s+h],n[c+h],u);break;case 2:var f=this._hermite;if(!f.valid){var d=u*u,p=u+u,_=1-u,g=_*_;f.valid=!0,f.p0=(1+p)*g,f.m0=u*g,f.p1=d*(3-p),f.m1=d*(u-1)}for(var y=(3*this._p0+1)*r,v=(3*this._p0+2)*r,x=(3*this._p1+1)*r,S=(3*this._p1+0)*r,T=0;T<r;++T)i[T]=f.p0*n[y+T]+f.m0*n[v+T]*this._len+f.p1*n[x+T]+f.m1*n[S+T]*this._len}}},o}(),Od=function(o){this._name=""+o.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(var a=0;a<o._inputs.length;++a)this._cache[a]=new pL;for(var i=o._curves,t=o._outputs,e=0;e<i.length;++e){for(var n=t[i[e]._output],r=[],s=0;s<n._components;++s)r[s]=0;this._results[e]=r}};function _0(){return(_0=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}var ac=function(){function o(t,e,n,r,s,l){this._name=t.name,this._track=t,this._snapshot=new Od(t),this._playing=r,this._time=e,this._speed=n,this._loop=s,this._blendWeight=1,this._blendOrder=0,this._eventHandler=l,this.alignCursorToCurrentTime()}var a,i=o.prototype;return i.nextEventAheadOfTime=function(t){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=t:this.nextEvent.time>=t)},i.nextEventBehindTime=function(t){return!!this.nextEvent&&(t===this.track.duration?this.isReverse?this.nextEvent.time>=t:this.nextEvent.time<=t:this.isReverse?this.nextEvent.time>t:this.nextEvent.time<t)},i.resetEventCursor=function(){this._eventCursor=this.isReverse?this._track.events.length-1:0},i.moveEventCursor=function(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)},i.clipFrameTime=function(t){var e=o.eventFrame;e.start=0,e.end=t,e.residual=0,this.isReverse?t<0&&(e.start=this.track.duration,e.end=0,e.residual=t+this.track.duration):t>this.track.duration&&(e.start=0,e.end=this.track.duration,e.residual=t-this.track.duration)},i.alignCursorToCurrentTime=function(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()},i.fireNextEvent=function(){this._eventHandler.fire(this.nextEvent.name,_0({track:this.track},this.nextEvent)),this.moveEventCursor()},i.fireNextEventInFrame=function(t,e){return!!(this.nextEventAheadOfTime(t)&&this.nextEventBehindTime(e))&&(this.fireNextEvent(),!0)},i.activeEventsForFrame=function(t,e){var n=o.eventFrame;this.clipFrameTime(e);for(var r=this.eventCursor;this.fireNextEventInFrame(t,n.end)&&r!==this.eventCursor;);this.loop&&Math.abs(n.residual)>0&&this.activeEventsForFrame(n.start,n.residual)},i.progressForTime=function(t){return t*this._speed/this._track.duration},i._update=function(t){if(this._playing){var e=this._time,n=this._track.duration,r=this._speed,s=this._loop;this._track.events.length>0&&n>0&&this.activeEventsForFrame(e,e+r*t),e+=r*t,r>=0?e>n&&(s?e=e%n||0:(e=this._track.duration,this.pause())):e<0&&(s?e=n+(e%n||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)},i.play=function(){this._playing=!0,this._time=0},i.stop=function(){this._playing=!1,this._time=0},i.pause=function(){this._playing=!1},i.resume=function(){this._playing=!0},i.reset=function(){this._time=0},a=[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"track",get:function(){return this._track},set:function(t){this._track=t,this._snapshot=new Od(t)}},{key:"snapshot",get:function(){return this._snapshot}},{key:"time",get:function(){return this._time},set:function(t){this._time=t,this.alignCursorToCurrentTime()}},{key:"speed",get:function(){return this._speed},set:function(t){var e=Math.sign(t)!==Math.sign(this._speed);this._speed=t,e&&this.alignCursorToCurrentTime()}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t}},{key:"blendWeight",get:function(){return this._blendWeight},set:function(t){this._blendWeight=t}},{key:"blendOrder",get:function(){return this._blendOrder},set:function(t){this._blendOrder=t}},{key:"eventCursor",get:function(){return this._eventCursor},set:function(t){this._eventCursor=t}},{key:"eventCursorEnd",get:function(){return this.isReverse?0:this._track.events.length-1}},{key:"nextEvent",get:function(){return this._track.events[this._eventCursor]}},{key:"isReverse",get:function(){return this._speed<0}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();ac.eventFrame={start:0,end:0,residual:0};var kd="NONE",v0="PREV_STATE",g0="NEXT_STATE",y0="PREV_STATE_NEXT_STATE",S0="NEXT_STATE_PREV_STATE",x0="GREATER_THAN",b0="LESS_THAN",T0="GREATER_THAN_EQUAL_TO",E0="LESS_THAN_EQUAL_TO",w0="EQUAL_TO",A0="NOT_EQUAL_TO",Nd="INTEGER",Fd="FLOAT",Ud="BOOLEAN",tl="TRIGGER",C0="2D_DIRECTIONAL",P0="2D_CARTESIAN",I0="DIRECT",ya="START",nl=[ya,"END","ANY"],Bd="OVERWRITE",L0="ADDITIVE",Fi=function(){function o(){}return o.dot=function(a,i){for(var t=a.length,e=0,n=0;n<t;++n)e+=a[n]*i[n];return e},o.normalize=function(a){var i=o.dot(a,a);if(i>0){i=1/Math.sqrt(i);for(var t=a.length,e=0;e<t;++e)a[e]*=i}},o.set=function(a,i,t){var e=a.length;if(t==="quaternion"){var n=o.dot(i,i);n>0&&(n=1/Math.sqrt(n));for(var r=0;r<e;++r)a[r]=i[r]*n}else for(var s=0;s<e;++s)a[s]=i[s]},o.blendVec=function(a,i,t,e){for(var n=e?1:1-t,r=a.length,s=0;s<r;++s)a[s]=a[s]*n+i[s]*t},o.blendQuat=function(a,i,t,e){var n=a.length,r=e?1:1-t;0>o.dot(a,i)&&(t=-t);for(var s=0;s<n;++s)a[s]=a[s]*r+i[s]*t;e||o.normalize(a)},o.blend=function(a,i,t,e,n){e==="quaternion"?o.blendQuat(a,i,t,n):o.blendVec(a,i,t,n)},o.stableSort=function(a,i){for(var t=a.length,e=0;e<t-1;++e)for(var n=e+1;n<t;++n)if(i(a[n],a[e])){var r=a[e];a[e]=a[n],a[n]=r}},o}(),In=function(){function o(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=e===o.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}var a,i=o.prototype;return i.getWeight=function(t){return this.dirty&&this.updateWeights(),this._normalizeWeights&&this.totalWeight===0||!this.mask[t]?0:this._normalizeWeights?this.weights[t]/this.totalWeight:U.clamp(this.weights[t],0,1)},i._layerBlendType=function(t){return this._component.layers[t].blendType},i.setMask=function(t,e){this.mask[t]=e,this._normalizeWeights&&(this._component.layers[t].blendType===Bd&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0)},i.updateWeights=function(){this.totalWeight=0;for(var t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1},i.updateValue=function(t,e){if(this.counter===0&&(Fi.set(this.value,o.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Fi.blend(this.value,this.baseValue,1,this.valueType)),this.mask[t]&&this.getWeight(t)!==0){if(this._layerBlendType(t)!==L0||this._normalizeWeights)Fi.blend(this.value,e,this.getWeight(t),this.valueType);else if(this.valueType===o.TYPE_QUAT){var n=o.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),r=o.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),s=o.q3.set(e[0],e[1],e[2],e[3]),l=r.invert().mul(s);l.slerp(Z.IDENTITY,l,this.getWeight(t)),n.mul(l),o.quatArr[0]=n.x,o.quatArr[1]=n.y,o.quatArr[2]=n.z,o.quatArr[3]=n.w,Fi.set(this.value,o.quatArr,this.valueType)}else o.vecArr[0]=e[0]-this.baseValue[0],o.vecArr[1]=e[1]-this.baseValue[1],o.vecArr[2]=e[2]-this.baseValue[2],Fi.blend(this.value,o.vecArr,this.getWeight(t),this.valueType,!0);this.setter&&this.setter(this.value)}},i.unbind=function(){this.setter&&this.setter(this.baseValue)},a=[{key:"_normalizeWeights",get:function(){return this._component.normalizeWeights}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();In.TYPE_QUAT="quaternion",In.TYPE_VEC3="vector3",In.q1=new Z,In.q2=new Z,In.q3=new Z,In.quatArr=[0,0,0,1],In.vecArr=[0,0,0],In.IDENTITY_QUAT_ARR=[0,0,0,1];var Vd=function(){function o(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}var a,i=o.prototype;return i.addClip=function(t){for(var e=this._targets,n=this._binder,r=t.track.curves,s=t.snapshot,l=[],u=[],c=0;c<r.length;++c)for(var h=r[c].paths,f=0;f<h.length;++f){var d=h[f],p=n.resolve(d),_=e[p&&p.targetPath||null];if(!_&&p){_={target:p,value:[],curves:0,blendCounter:0};for(var g=0;g<_.target.components;++g)_.value.push(0);if(e[p.targetPath]=_,n.animComponent){if(!n.animComponent.targets[p.targetPath]){var y=void 0;y=p.targetPath.substring(p.targetPath.length-13)==="localRotation"?In.TYPE_QUAT:In.TYPE_VEC3,n.animComponent.targets[p.targetPath]=new In(n.animComponent,y)}n.animComponent.targets[p.targetPath].layerCounter++,n.animComponent.targets[p.targetPath].setMask(n.layerIndex,1)}}_&&(_.curves++,l.push(s._results[c]),u.push(_))}this._clips.push(t),this._inputs.push(l),this._outputs.push(u)},i.removeClip=function(t){for(var e=this._targets,n=this._binder,r=this._clips,s=r[t].track.curves,l=0;l<s.length;++l)for(var u=s[l].paths,c=0;c<u.length;++c){var h=u[c],f=this._binder.resolve(h);f&&(f.curves--,f.curves===0&&(n.unresolve(h),delete e[f.targetPath],n.animComponent&&n.animComponent.targets[f.targetPath].layerCounter--))}r.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)},i.removeClips=function(){for(;this._clips.length>0;)this.removeClip(0)},i.updateClipTrack=function(t,e){this._clips.forEach(function(n){n.name.includes(t)&&(n.track=e)}),this.rebind()},i.findClip=function(t){for(var e=this._clips,n=0;n<e.length;++n){var r=e[n];if(r.name===t)return r}return null},i.rebind=function(){var t=this;this._binder.rebind(),this._targets={};var e=[].concat(this.clips);this.removeClips(),e.forEach(function(n){t.addClip(n)})},i.assignMask=function(t){return this._binder.assignMask(t)},i.update=function(t,e){e===void 0&&(e=!0);var n=this._clips,r=n.map(function(w,A){return A});Fi.stableSort(r,function(w,A){return n[w].blendOrder<n[A].blendOrder});for(var s=0;s<r.length;++s){var l=r[s],u=n[l],c=this._inputs[l],h=this._outputs[l],f=u.blendWeight;if(f>0&&u._update(t),!e)break;var d=void 0,p=void 0,_=void 0;if(f>=1)for(var g=0;g<c.length;++g)d=c[g],_=(p=h[g]).value,Fi.set(_,d,p.target.type),p.blendCounter++;else if(f>0)for(var y=0;y<c.length;++y)d=c[y],_=(p=h[y]).value,p.blendCounter===0?Fi.set(_,d,p.target.type):Fi.blend(_,d,f,p.target.type),p.blendCounter++}var v=this._targets,x=this._binder;for(var S in v)if(v.hasOwnProperty(S)){var T=v[S];if(x.animComponent&&T.target.isTransform){var b=x.animComponent.targets[S];b.counter===b.layerCounter&&(b.counter=0),b.path||(b.path=S,b.baseValue=T.target.get(),b.setter=T.target.set),b.updateValue(x.layerIndex,T.value),b.counter++}else T.target.set(T.value);T.blendCounter=0}this._binder.update(t)},a=[{key:"clips",get:function(){return this._clips}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),zd=function(){var o;function a(i){this._events=[].concat(i),this._events.sort(function(t,e){return t.time-e.time})}return o=[{key:"events",get:function(){return this._events}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),Qt=function(){var o;function a(i,t,e,n,r,s){s===void 0&&(s=new zd([])),this._name=i,this._duration=t,this._inputs=e,this._outputs=n,this._curves=r,this._animEvents=s}return a.prototype.eval=function(i,t){t._time=i;for(var e=this._inputs,n=this._outputs,r=this._curves,s=t._cache,l=t._results,u=0;u<e.length;++u)s[u].update(i,e[u]._data);for(var c=0;c<r.length;++c){var h=r[c],f=n[h._output],d=l[c];s[h._input].eval(d,h._interpolation,f)}},o=[{key:"name",get:function(){return this._name}},{key:"duration",get:function(){return this._duration}},{key:"inputs",get:function(){return this._inputs}},{key:"outputs",get:function(){return this._outputs}},{key:"curves",get:function(){return this._curves}},{key:"events",get:function(){return this._animEvents.events},set:function(i){this._animEvents=i}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();Qt.EMPTY=Object.freeze(new Qt("empty",Number.MAX_VALUE,[],[],[]));var es=function(){function o(){}var a=o.prototype;return a.resolve=function(i){return null},a.unresolve=function(i){},a.update=function(i){},o.joinPath=function(i,t){return t=t||".",i.map(function(e){return e.replace(/\\/g,"\\\\").replace(RegExp("\\"+t,"g"),"\\"+t)}).join(t)},o.splitPath=function(i,t){t=t||".";for(var e=[],n="",r=0;r<i.length;){var s=i[r++];s==="\\"&&r<i.length?(s=i[r++])==="\\"||s===t?n+=s:n+="\\"+s:s===t?(e.push(n),n=""):n+=s}return n.length>0&&e.push(n),e},o.encode=function(i,t,e){return(Array.isArray(i)?i.join("/"):i)+"/"+t+"/"+(Array.isArray(e)?e.join("/"):e)},o}(),oc=function(){var o;function a(i,t,e,n){i.set?(this._set=i.set,this._get=i.get):this._set=i,this._type=t,this._components=e,this._targetPath=n,this._isTransform=this._targetPath.substring(this._targetPath.length-13)==="localRotation"||this._targetPath.substring(this._targetPath.length-13)==="localPosition"||this._targetPath.substring(this._targetPath.length-10)==="localScale"}return o=[{key:"set",get:function(){return this._set}},{key:"get",get:function(){return this._get}},{key:"type",get:function(){return this._type}},{key:"components",get:function(){return this._components}},{key:"targetPath",get:function(){return this._targetPath}},{key:"isTransform",get:function(){return this._isTransform}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),Gd=function(){function o(i){var t=this;if(this._isPathInMask=function(s,l){var u=t._mask[s];return!!(u&&(u.children||l&&u.value!==!1))},this.graph=i,i){this._mask=null;var e={},n=function(s){e[s.name]=s;for(var l=0;l<s.children.length;++l)n(s.children[l])};n(i),this.nodes=e,this.targetCache={};var r=function(s){for(var l,u,c=s;c&&(l=c,ve!=null&&typeof Symbol<"u"&&ve[Symbol.hasInstance]?!ve[Symbol.hasInstance](l):!Q(l,ve));)c=c.parent;return c&&(c.render?u=c.render.meshInstances:c.model&&(u=c.model.meshInstances)),u};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(s){var l=s.localPosition;return o.createAnimTarget(function(u){l.set.apply(l,[].concat(u))},"vector",3,s,"localPosition")},localRotation:function(s){var l=s.localRotation;return o.createAnimTarget(function(u){l.set.apply(l,[].concat(u))},"quaternion",4,s,"localRotation")},localScale:function(s){var l=s.localScale;return o.createAnimTarget(function(u){l.set.apply(l,[].concat(u))},"vector",3,s,"localScale")},weight:function(s,l){l=l.indexOf("name.")===0?l.replace("name.",""):Number(l);var u,c=r(s);if(c)for(var h=0;h<c.length;++h){var f=h;if(c[f].node.name===s.name&&c[f].morphInstance){var d=c[f].morphInstance;u||(u=[]),u.push(function(p){d.setWeight(l,p[0])})}}return u?o.createAnimTarget(function(p){for(var _=0;_<u.length;++_)u[_](p)},"number",1,s,"weight."+l):null},materialTexture:function(s,l){var u,c=r(s);if(c){for(var h=0;h<c.length;++h)if(c[h].node.name===s.name){u=c[h];break}if(u)return o.createAnimTarget(function(f){var d=t.animComponent.system.app.assets.get(f[0]);d&&d.resource&&d.type==="texture"&&(u.material[l]=d.resource,u.material.update())},"vector",1,s,"materialTexture","material")}return null}}}}var a=o.prototype;return a._isPathActive=function(i){if(!this._mask)return!0;for(var t=[i.entityPath[0],this.graph.name],e=0;e<t.length;++e){var n=t[e];if(this._isPathInMask(n,i.entityPath.length===1))return!0;for(var r=1;r<i.entityPath.length;r++)if(n+="/"+i.entityPath[r],this._isPathInMask(n,r===i.entityPath.length-1))return!0}return!1},a.findNode=function(i){var t;return this._isPathActive(i)?(this.graph&&((t=this.graph.findByPath(i.entityPath))||(t=this.graph.findByPath(i.entityPath.slice(1)))),t||(t=this.nodes[i.entityPath[i.entityPath.length-1]||""]),t):null},a.resolve=function(i){var t=es.encode(i.entityPath,i.component,i.propertyPath),e=this.targetCache[t];if(e)return e;var n=this.findNode(i);if(!n)return null;var r=this.handlers[i.propertyPath];return r&&(e=r(n))?(this.targetCache[t]=e,this.nodeCounts[n.path]?this.nodeCounts[n.path]++:(this.activeNodes.push(n),this.nodeCounts[n.path]=1),e):null},a.unresolve=function(i){if(i.component==="graph"){var t=this.nodes[i.entityPath[i.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,this.nodeCounts[t.path]===0){var e=this.activeNodes,n=e.indexOf(t.node),r=e.length;n<r-1&&(e[n]=e[r-1]),e.pop()}}},a.update=function(i){for(var t=this.activeNodes,e=0;e<t.length;++e)t[e]._dirtifyLocal()},a.assignMask=function(i){return i!==this._mask&&(this._mask=i,!0)},o.createAnimTarget=function(i,t,e,n,r,s){return new oc(i,t,e,es.encode(n.path,s||"entity",r))},o}();function D0(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function M0(o,a){return(M0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Hd=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._animations={},e._assets=[],e._loop=!0,e.animEvaluator=null,e.model=null,e.skeleton=null,e.fromSkel=null,e.toSkel=null,e.animationsIndex={},e.prevAnim=null,e.currAnim=null,e.blend=0,e.blending=!1,e.blendSpeed=0,e.activate=!0,e.speed=1,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&M0(a,o);var i,t=a.prototype;return t.play=function(e,n){if(n===void 0&&(n=0),this.enabled&&this.entity.enabled&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();var r=this.animations[this.prevAnim],s=this.animations[this.currAnim];if(this.blending=n>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/n),this.skeleton&&(this.blending?(this.fromSkel.animation=r,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=s):this.skeleton.animation=s),this.animEvaluator){var l=this.animEvaluator;if(this.blending)for(;l.clips.length>1;)l.removeClip(0);else this.animEvaluator.removeClips();var u=new ac(this.animations[this.currAnim],0,1,!0,this.loop);u.name=this.currAnim,u.blendWeight=+!this.blending,u.reset(),this.animEvaluator.addClip(u)}}this.playing=!0}},t.getAnimation=function(e){return this.animations[e]},t.setModel=function(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))},t.onSetAnimations=function(){var e=this.entity.model;if(e){var n=e.model;n&&n!==this.model&&this.setModel(n)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){var r=Object.keys(this._animations);r.length>0&&this.play(r[0])}},t._resetAnimationController=function(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null},t._createAnimationController=function(){var e=this.model,n=this.animations,r=!1,s=!1;for(var l in n)n.hasOwnProperty(l)&&(n[l].constructor===Qt?s=!0:r=!0);var u=e.getGraph();r?(this.fromSkel=new Wu(u),this.toSkel=new Wu(u),this.skeleton=new Wu(u),this.skeleton.looping=this.loop,this.skeleton.setGraph(u)):s&&(this.animEvaluator=new Vd(new Gd(this.entity)))},t.loadAnimationAssets=function(e){var n=this;if(e&&e.length)for(var r=this.system.app.assets,s=function(f){if(f.resources.length>1)for(var d=0;d<f.resources.length;d++)n.animations[f.resources[d].name]=f.resources[d],n.animationsIndex[f.id]=f.resources[d].name;else n.animations[f.name]=f.resource,n.animationsIndex[f.id]=f.name;n.animations=n.animations},l=function(f){f.off("change",n.onAssetChanged,n),f.on("change",n.onAssetChanged,n),f.off("remove",n.onAssetRemoved,n),f.on("remove",n.onAssetRemoved,n),f.resource?s(f):(f.once("load",s,n),n.enabled&&n.entity.enabled&&r.load(f))},u=0,c=e.length;u<c;u++){var h=r.get(e[u]);h?l(h):r.on("add:"+e[u],l)}},t.onAssetChanged=function(e,n,r,s){if(n==="resource"||n==="resources")if(n==="resources"&&r&&r.length===0&&(r=null),r){var l=!1;if(r.length>1){if(s&&s.length>1)for(var u=0;u<s.length;u++)delete this.animations[s[u].name];else delete this.animations[e.name];l=!1;for(var c=0;c<r.length;c++)this.animations[r[c].name]=r[c],!l&&this.currAnim===r[c].name&&this.playing&&this.enabled&&this.entity.enabled&&(l=!0,this.play(r[c].name));l||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(s&&s.length>1)for(var h=0;h<s.length;h++)delete this.animations[s[h].name];this.animations[e.name]=r[0]||r,l=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(l=!0,this.play(e.name)),l||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(s.length>1)for(var f=0;f<s.length;f++)delete this.animations[s[f].name],this.currAnim===s[f].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}},t.onAssetRemoved=function(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(var n=0;n<e.resources.length;n++)delete this.animations[e.resources[n].name],this.currAnim===e.resources[n].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}},t._stopCurrentAnimation=function(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(var e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}},t.onEnable=function(){o.prototype.onEnable.call(this);var e=this.assets,n=this.system.app.assets;if(e)for(var r=0,s=e.length;r<s;r++){var l=e[r];D0(l,$)||(l=n.get(l)),l&&!l.resource&&n.load(l)}if(this.activate&&!this.currAnim){var u=Object.keys(this.animations);u.length>0&&this.play(u[0])}},t.onBeforeRemove=function(){for(var e=0;e<this.assets.length;e++){var n=this.assets[e];typeof n=="number"&&(n=this.system.app.assets.get(n)),n&&(n.off("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null},t.update=function(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){var n=this.skeleton;if(n!==null&&this.model!==null){if(this.blending)n.blend(this.fromSkel,this.toSkel,this.blend);else{var r=e*this.speed;n.addTime(r),this.speed>0&&n._time===n.animation.duration&&!this.loop?this.playing=!1:this.speed<0&&n._time===0&&!this.loop&&(this.playing=!1)}this.blending&&this.blend===1&&(n.animation=this.toSkel.animation),n.updateGraph()}}var s=this.animEvaluator;if(s){for(var l=0;l<s.clips.length;++l){var u=s.clips[l];u.speed=this.speed,this.playing?u.resume():u.pause()}this.blending&&s.clips.length>1&&(s.clips[1].blendWeight=this.blend),s.update(e)}this.blending&&this.blend===1&&(this.blending=!1)},i=[{key:"animations",get:function(){return this._animations},set:function(e){this._animations=e,this.onSetAnimations()}},{key:"assets",get:function(){return this._assets},set:function(e){var n=this._assets;if(n&&n.length){for(var r=0;r<n.length;r++)if(n[r]){var s=this.system.app.assets.get(n[r]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);var l=this.animationsIndex[s.id];this.currAnim===l&&this._stopCurrentAnimation(),delete this.animations[l],delete this.animationsIndex[s.id]}}}this._assets=e;var u=e.map(function(c){return D0(c,$)?c.id:c});this.loadAnimationAssets(u)}},{key:"currentTime",get:function(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){var e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0},set:function(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator)for(var n=this.animEvaluator.clips,r=0;r<n.length;++r)n[r].time=e}},{key:"duration",get:function(){return this.currAnim?this.animations[this.currAnim].duration:0}},{key:"loop",get:function(){return this._loop},set:function(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(var n=0;n<this.animEvaluator.clips.length;++n)this.animEvaluator.clips[n].loop=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),mL=function(){this.enabled=!0};function R0(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function O0(o,a){return(O0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Wd=["enabled"],k0=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="animation",e.ComponentType=Hd,e.DataType=mL,e.schema=Wd,e.on("beforeremove",e.onBeforeRemove,e),e.app.systems.on("update",e.onUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&O0(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){n=["activate","enabled","loop","speed","assets"];for(var r,s=function(u,c){var h=typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(h)return(h=h.call(u)).next.bind(h);if(Array.isArray(u)||(h=function(d,p){if(d){if(typeof d=="string")return R0(d,void 0);var _=Object.prototype.toString.call(d).slice(8,-1);if(_==="Object"&&d.constructor&&(_=d.constructor.name),_==="Map"||_==="Set")return Array.from(_);if(_==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(_))return R0(d,void 0)}}(u))){h&&(u=h);var f=0;return function(){return f>=u.length?{done:!0}:{done:!1,value:u[f++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(n);!(r=s()).done;){var l=r.value;e.hasOwnProperty(l)&&(t[l]=e[l])}o.prototype.initializeComponentData.call(this,t,e,Wd)},i.cloneComponent=function(t,e){this.addComponent(e,{}),e.animation.assets=t.animation.assets.slice(),e.animation.speed=t.animation.speed,e.animation.loop=t.animation.loop,e.animation.activate=t.animation.activate,e.animation.enabled=t.animation.enabled;var n={},r=t.animation.animations;for(var s in r)r.hasOwnProperty(s)&&(n[s]=r[s]);e.animation.animations=n;var l={},u=t.animation.animationsIndex;for(var c in u)u.hasOwnProperty(c)&&(l[c]=u[c]);return e.animation.animationsIndex=l,e.animation},i.onBeforeRemove=function(t,e){e.onBeforeRemove()},i.onUpdate=function(t){var e=this.store;for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];r.data.enabled&&r.entity.enabled&&r.entity.animation.update(t)}},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this)},a}(We);de._buildAccessors(Hd.prototype,Wd);var il=function(){var o;function a(i,t,e,n,r){r===void 0&&(r=1),this._state=i,this._parent=t,this._name=e,Array.isArray(n)?(this._point=new G(n[0],n[1]),this._pointLength=this._point.length()):(this._point=n,this._pointLength=n),this._speed=r,this._weightedSpeed=1,this._weight=1,this._animTrack=null}return o=[{key:"parent",get:function(){return this._parent}},{key:"name",get:function(){return this._name}},{key:"path",get:function(){return this._parent?this._parent.path+"."+this._name:this._name}},{key:"point",get:function(){return this._point}},{key:"pointLength",get:function(){return this._pointLength}},{key:"weight",get:function(){return this._parent?this._parent.weight*this._weight:this._weight},set:function(i){this._weight=i}},{key:"normalizedWeight",get:function(){var i=this._state.totalWeight;return i===0?0:this.weight/i}},{key:"speed",get:function(){return this._weightedSpeed*this._speed}},{key:"absoluteSpeed",get:function(){return Math.abs(this._speed)}},{key:"weightedSpeed",get:function(){return this._weightedSpeed},set:function(i){this._weightedSpeed=i}},{key:"animTrack",get:function(){return this._animTrack},set:function(i){this._animTrack=i}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function N0(o,a){return(N0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var lc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r,s,l,u,c,h,f){var d;(d=o.call(this,e,n,r,s)||this)._parameters=l,d._parameterValues=Array(l.length),d._children=[],d._findParameter=f,d._syncAnimations=c!==!1,d._pointCache={};for(var p=0;p<u.length;p++){var _=u[p];_.children?d._children.push(h(_.type,e,d,_.name,1,_.parameter?[_.parameter]:_.parameters,_.children,_.syncAnimations,h,f)):d._children.push(new il(e,d,_.name,_.point,_.speed))}return d}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&N0(a,o);var i,t=a.prototype;return t.getChild=function(e){for(var n=0;n<this._children.length;n++)if(this._children[n].name===e)return this._children[n];return null},t.updateParameterValues=function(){for(var e=!0,n=0;n<this._parameterValues.length;n++){var r=this._findParameter(this._parameters[n]).value;this._parameterValues[n]!==r&&(this._parameterValues[n]=r,e=!1)}return e},t.getNodeWeightedDuration=function(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight},t.getNodeCount=function(){for(var e=0,n=0;n<this._children.length;n++)this._children[n].constructor===a?e+=this._children[n].getNodeCount():e++;return e},i=[{key:"weight",get:function(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}},{key:"syncAnimations",get:function(){return this._syncAnimations}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(il);function F0(o,a){return(F0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var _L=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e,n,r,s,l,u,c){return s.sort(function(h,f){return h.point-f.point}),o.call(this,i,t,e,n,r,s,l,u,c)||this}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&F0(a,o),a.prototype.calculateWeights=function(){if(!this.updateParameterValues()){var i=0;this._children[0].weight=0;for(var t=0;t<this._children.length;t++){var e=this._children[t];if(t!==this._children.length-1){var n=this._children[t+1];if(e.point===n.point)e.weight=.5,n.weight=.5;else if(U.between(this._parameterValues[0],e.point,n.point,!0)){var r=Math.abs(e.point-n.point),s=(r-Math.abs(e.point-this._parameterValues[0]))/r;e.weight=s,n.weight=1-s}else n.weight=0}this._syncAnimations&&(i+=e.animTrack.duration/e.absoluteSpeed*e.weight)}if(this._syncAnimations)for(var l=0;l<this._children.length;l++){var u=this._children[l];u.weightedSpeed=u.animTrack.duration/u.absoluteSpeed/i}}},a}(lc);function U0(o,a){return(U0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var jd=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&U0(a,o);var i=a.prototype;return i.pointDistanceCache=function(t,e){var n=""+t+e;return this._pointCache[n]||(this._pointCache[n]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[n]},i.calculateWeights=function(){if(!this.updateParameterValues()){(t=a._p).set.apply(t,[].concat(this._parameterValues)),e=0,n=0;for(var t,e,n,r=0;r<this._children.length;r++){var s=this._children[r],l=s.point;a._pip.set(a._p.x,a._p.y).sub(l);for(var u=Number.MAX_VALUE,c=0;c<this._children.length;c++)if(r!==c){var h=this.pointDistanceCache(r,c),f=U.clamp(1-a._pip.dot(h)/h.lengthSq(),0,1);f<u&&(u=f)}s.weight=u,e+=u,this._syncAnimations&&(n+=s.animTrack.duration/s.absoluteSpeed*s.weight)}for(var d=0;d<this._children.length;d++){var p=this._children[d];p.weight=p._weight/e,this._syncAnimations&&(p.weightedSpeed=p.animTrack.duration/p.absoluteSpeed/n)}}},a}(lc);function B0(o,a){return(B0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}jd._p=new G,jd._pip=new G;var Xd=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&B0(a,o);var i=a.prototype;return i.pointCache=function(t,e){var n=""+t+e;return this._pointCache[n]||(this._pointCache[n]=new G((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*G.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[n]},i.calculateWeights=function(){if(!this.updateParameterValues()){(t=a._p).set.apply(t,[].concat(this._parameterValues));var t,e,n,r=a._p.length();e=0,n=0;for(var s=0;s<this._children.length;s++){for(var l=this._children[s],u=l.point,c=l.pointLength,h=Number.MAX_VALUE,f=0;f<this._children.length;f++)if(s!==f){var d=this.pointCache(s,f),p=this._children[f].pointLength;a._pip.set((r-c)/((p+c)/2),2*G.angleRad(u,a._p));var _=U.clamp(1-Math.abs(a._pip.dot(d)/d.lengthSq()),0,1);_<h&&(h=_)}l.weight=h,e+=h,this._syncAnimations&&(n+=l.animTrack.duration/l.absoluteSpeed*l.weight)}for(var g=0;g<this._children.length;g++){var y=this._children[g];if(y.weight=y._weight/e,this._syncAnimations){var v=y.animTrack.duration/n*e;y.weightedSpeed=y.absoluteSpeed*v}}}},a}(lc);function V0(o,a){return(V0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Xd._p=new G,Xd._pip=new G;var vL=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&V0(a,o),a.prototype.calculateWeights=function(){if(!this.updateParameterValues()){for(var i=0,t=0,e=0;e<this._children.length;e++)if(i+=Math.max(this._parameterValues[e],0),this._syncAnimations){var n=this._children[e];t+=n.animTrack.duration/n.absoluteSpeed*n.weight}for(var r=0;r<this._children.length;r++){var s=this._children[r],l=Math.max(this._parameterValues[r],0);i?(s.weight=l/i,this._syncAnimations&&(s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t)):(s.weight=0,this._syncAnimations&&(s.weightedSpeed=0))}}},a}(lc),z0=function(){function o(t,e,n,r,s){n===void 0&&(n=1),r===void 0&&(r=!0),this._animations={},this._animationList=[],this._controller=t,this._name=e,this._speed=n,this._loop=r,this._hasAnimations=!1,s?this._blendTree=this._createTree(s.type,this,null,e,1,s.parameter?[s.parameter]:s.parameters,s.children,s.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new il(this,null,e,1,n)}var a,i=o.prototype;return i._createTree=function(t,e,n,r,s,l,u,c,h,f){switch(t){case"1D":return new _L(e,n,r,s,l,u,c,h,f);case P0:return new jd(e,n,r,s,l,u,c,h,f);case C0:return new Xd(e,n,r,s,l,u,c,h,f);case I0:return new vL(e,n,r,s,l,u,c,h,f)}},i._getNodeFromPath=function(t){for(var e=this._blendTree,n=1;n<t.length;n++)e=e.getChild(t[n]);return e},i.addAnimation=function(t,e){var n=t.join("."),r=this._animationList.findIndex(function(l){return l.path===n});if(r>=0)this._animationList[r].animTrack=e;else{var s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}this._updateHasAnimations()},i._updateHasAnimations=function(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(function(t){return t.animTrack&&t.animTrack!==Qt.EMPTY})},a=[{key:"name",get:function(){return this._name}},{key:"animations",get:function(){return this._animationList},set:function(t){this._animationList=t,this._updateHasAnimations()}},{key:"hasAnimations",get:function(){return this._hasAnimations}},{key:"speed",get:function(){return this._speed},set:function(t){this._speed=t}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t}},{key:"nodeCount",get:function(){return this._blendTree&&this._blendTree.constructor!==il?this._blendTree.getNodeCount():1}},{key:"playable",get:function(){return nl.indexOf(this.name)!==-1||this.animations.length===this.nodeCount}},{key:"looping",get:function(){if(this.animations.length>0){var t=this.name+"."+this.animations[0].animTrack.name,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}},{key:"totalWeight",get:function(){for(var t=0,e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}},{key:"timelineDuration",get:function(){for(var t=0,e=0;e<this.animations.length;e++){var n=this.animations[e];n.animTrack.duration>t&&(t=n.animTrack.duration)}return t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),uc=function(){var o;function a(i){var t=i.from,e=i.to,n=i.time,r=i.priority,s=i.conditions,l=i.exitTime,u=i.transitionOffset,c=i.interruptionSource,h=c===void 0?kd:c;this._from=t,this._to=e,this._time=n===void 0?0:n,this._priority=r===void 0?0:r,this._conditions=s===void 0?[]:s,this._exitTime=l===void 0?null:l,this._transitionOffset=u===void 0?null:u,this._interruptionSource=h}return o=[{key:"from",get:function(){return this._from}},{key:"to",get:function(){return this._to},set:function(i){this._to=i}},{key:"time",get:function(){return this._time}},{key:"priority",get:function(){return this._priority}},{key:"conditions",get:function(){return this._conditions}},{key:"exitTime",get:function(){return this._exitTime}},{key:"transitionOffset",get:function(){return this._transitionOffset}},{key:"interruptionSource",get:function(){return this._interruptionSource}},{key:"hasExitTime",get:function(){return!!this.exitTime}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function G0(){return(G0=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}var H0=function(){function o(t,e,n,r,s,l,u){var c=this;this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=ya,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=kd,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=function(f){return c._findParameter(f)},this._animEvaluator=t,this._eventHandler=s,this._findParameter=l,this._consumeTrigger=u;for(var h=0;h<e.length;h++)this._states[e[h].name]=new z0(this,e[h].name,e[h].speed,e[h].loop,e[h].blendTree),this._stateNames.push(e[h].name);this._transitions=n.map(function(f){return new uc(G0({},f))}),this._activate=r}var a,i=o.prototype;return i.assignMask=function(t){return this._animEvaluator.assignMask(t)},i._findState=function(t){return this._states[t]},i._getActiveStateProgressForTime=function(t){if(this.activeStateName===ya||this.activeStateName==="END"||this.activeStateName==="ANY")return 1;var e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?e.progressForTime(t):null},i._findTransitionsFromState=function(t){var e=this._findTransitionsFromStateCache[t];return e||(Vo(e=this._transitions.filter(function(n){return n.from===t})),this._findTransitionsFromStateCache[t]=e),e},i._findTransitionsBetweenStates=function(t,e){var n=this._findTransitionsBetweenStatesCache[t+"->"+e];return n||(Vo(n=this._transitions.filter(function(r){return r.from===t&&r.to===e})),this._findTransitionsBetweenStatesCache[t+"->"+e]=n),n},i._transitionHasConditionsMet=function(t){for(var e=t.conditions,n=0;n<e.length;n++){var r=e[n],s=this._findParameter(r.parameterName);switch(r.predicate){case x0:if(!(s.value>r.value))return!1;break;case b0:if(!(s.value<r.value))return!1;break;case T0:if(!(s.value>=r.value))return!1;break;case E0:if(!(s.value<=r.value))return!1;break;case w0:if(s.value!==r.value)return!1;break;case A0:if(s.value===r.value)return!1}}return!0},i._findTransition=function(t,e){var n=this,r=[];if(t&&e)r=r.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case v0:r=(r=r.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));break;case g0:r=(r=r.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case y0:r=(r=(r=r.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case S0:r=(r=(r=r.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"))}else r=(r=r.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));if((r=r.filter(function(l){if(l.to===n.activeStateName)return!1;if(l.hasExitTime){var u=n._getActiveStateProgressForTime(n._timeInStateBefore),c=n._getActiveStateProgressForTime(n._timeInState);if(l.exitTime<1&&n.activeState.loop&&(u-=Math.floor(u),c-=Math.floor(c)),c===u){if(c!==l.exitTime)return null}else if(!(l.exitTime>u&&l.exitTime<=c))return null}return n._transitionHasConditionsMet(l)})).length>0){var s=r[0];return s.to==="END"&&(s.to=this._findTransitionsFromState(ya)[0].to),s}return null},i.updateStateFromTransition=function(t){this.previousState=t.from?this.activeStateName:null,this.activeState=t.to,this._activeStateDurationDirty=!0;for(var e,n,r,s=0;s<t.conditions.length;s++){var l=t.conditions[s];this._findParameter(l.parameterName).type===tl&&this._consumeTrigger(l.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});for(var u=Math.min(this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,1),c=0;c<this._transitionPreviousStates.length;c++){this._isTransitioning?c!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[c].weight*=1-u:this._transitionPreviousStates[c].weight=u:this._transitionPreviousStates[c].weight=1,e=this._findState(this._transitionPreviousStates[c].name);for(var h=0;h<e.animations.length;h++)n=e.animations[h],(r=this._animEvaluator.findClip(n.name+".previous."+c))||((r=this._animEvaluator.findClip(n.name)).name=n.name+".previous."+c),c!==this._transitionPreviousStates.length-1&&r.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;var f=this.activeState,d=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1,p=0,_=0;if(d){var g=f.timelineDuration*t.transitionOffset;p=g,_=g}this._timeInState=p,this._timeInStateBefore=_;for(var y=0;y<f.animations.length;y++){if(r=this._animEvaluator.findClip(f.animations[y].name))r.reset();else{var v=Number.isFinite(f.animations[y].speed)?f.animations[y].speed:f.speed;(r=new ac(f.animations[y].animTrack,this._timeInState,v,!0,f.loop,this._eventHandler)).name=f.animations[y].name,this._animEvaluator.addClip(r)}if(t.time>0?r.blendWeight=0:r.blendWeight=f.animations[y].normalizedWeight,r.play(),d)r.time=f.timelineDuration*t.transitionOffset;else{var x=f.speed>=0?0:this.activeStateDuration;r.time=x}}},i._transitionToState=function(t){if(this._findState(t)){var e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new uc({from:null,to:t})),this.updateStateFromTransition(e)}},i.assignAnimation=function(t,e,n,r){var s=t.split("."),l=this._findState(s[0]);l||(l=new z0(this,s[0],n),this._states[s[0]]=l,this._stateNames.push(s[0])),l.addAnimation(s,e),this._animEvaluator.updateClipTrack(l.name,e),n!==void 0&&(l.speed=n),r!==void 0&&(l.loop=r),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0},i.removeNodeAnimations=function(t){if(nl.indexOf(t)!==-1)return!1;var e=this._findState(t);return!!e&&(e.animations=[],!0)},i.play=function(t){t&&this._transitionToState(t),this._playing=!0},i.pause=function(){this._playing=!1},i.reset=function(){this._previousStateName=null,this._activeStateName=ya,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()},i.rebind=function(){this._animEvaluator.rebind()},i.update=function(t){if(this._playing){(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=t*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,t=this.activeStateDuration-this._timeInStateBefore));var e,n,r,s=this._findTransition(this._activeStateName);if(s&&this.updateStateFromTransition(s),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){for(var l=this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,u=0;u<this._transitionPreviousStates.length;u++){e=this._findState(this._transitionPreviousStates[u].name);for(var c=this._transitionPreviousStates[u].weight,h=0;h<e.animations.length;h++)n=e.animations[h],(r=this._animEvaluator.findClip(n.name+".previous."+u))&&(r.blendWeight=(1-l)*n.normalizedWeight*c)}e=this.activeState;for(var f=0;f<e.animations.length;f++)n=e.animations[f],this._animEvaluator.findClip(n.name).blendWeight=l*n.normalizedWeight}else{this._isTransitioning=!1;for(var d=this.activeStateAnimations.length,p=this._animEvaluator.clips.length,_=0;_<p-d;_++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(var g=0;g<e.animations.length;g++)n=e.animations[g],(r=this._animEvaluator.findClip(n.name))&&(r.blendWeight=n.normalizedWeight)}else if(this.activeState._blendTree.constructor!==il){e=this.activeState;for(var y=0;y<e.animations.length;y++)n=e.animations[y],(r=this._animEvaluator.findClip(n.name))&&(r.blendWeight=n.normalizedWeight,n.parent.syncAnimations&&(r.speed=n.speed))}this._animEvaluator.update(t,this.activeState.hasAnimations)}},a=[{key:"animEvaluator",get:function(){return this._animEvaluator}},{key:"activeState",get:function(){return this._findState(this._activeStateName)},set:function(t){this._activeStateName=t}},{key:"activeStateName",get:function(){return this._activeStateName}},{key:"activeStateAnimations",get:function(){return this.activeState.animations}},{key:"previousState",get:function(){return this._findState(this._previousStateName)},set:function(t){this._previousStateName=t}},{key:"previousStateName",get:function(){return this._previousStateName}},{key:"playable",get:function(){for(var t=!0,e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}},{key:"playing",get:function(){return this._playing},set:function(t){this._playing=t}},{key:"activeStateProgress",get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},{key:"activeStateDuration",get:function(){if(this._activeStateDurationDirty){for(var t=0,e=0;e<this.activeStateAnimations.length;e++){var n=this._animEvaluator.findClip(this.activeStateAnimations[e].name);n&&(t=Math.max(t,n.track.duration))}this._activeStateDuration=t,this._activeStateDurationDirty=!1}return this._activeStateDuration}},{key:"activeStateCurrentTime",get:function(){return this._timeInState},set:function(t){this._timeInStateBefore=t,this._timeInState=t;for(var e=0;e<this.activeStateAnimations.length;e++){var n=this.animEvaluator.findClip(this.activeStateAnimations[e].name);n&&(n.time=t)}}},{key:"transitioning",get:function(){return this._isTransitioning}},{key:"transitionProgress",get:function(){return this._currTransitionTime/this._totalTransitionTime}},{key:"states",get:function(){return this._stateNames}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function W0(o,a){return(W0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function j0(o){return o&&typeof Symbol<"u"&&o.constructor===Symbol?"symbol":typeof o}var Yd=new G,cc=new E,rl=new q,sl=new B,al=new Z,gL=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s){var l;return(l=o.call(this,e)||this).animComponent=t,l._mask=r,l.layerName=n,l.layerIndex=s,l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&W0(a,o);var i=a.prototype;return i.resolve=function(t){var e,n,r,s=es.encode(t.entityPath,t.component,t.propertyPath),l=this.targetCache[s];if(l)return l;switch(t.component){case"entity":e=this._getEntityFromHierarchy(t.entityPath),r=es.encode(e.path,"entity",t.propertyPath),n=e;break;case"graph":if(!(n=this.findNode(t)))return null;r=es.encode(n.path,"graph",t.propertyPath);break;default:if(!(n=(e=this._getEntityFromHierarchy(t.entityPath)).findComponent(t.component)))return null;r=es.encode(e.path,t.component,t.propertyPath)}return l=this._createAnimTargetForProperty(n,t.propertyPath,r),this.targetCache[s]=l,l},i.update=function(t){var e=this.activeNodes;if(e)for(var n=0;n<e.length;n++)e[n]._dirtifyLocal()},i._getEntityFromHierarchy=function(t){if(!this.animComponent.entity.name===t[0])return null;var e=this.animComponent.entity;return t.length===1?e:e._parent.findByPath(t)},i._resolvePath=function(t,e,n){for(var r=e.length-!n,s=0;s<r;s++)t=t[e[s]];return t},i._setter=function(t,e,n){var r=this._resolvePath(t,e),s=e[e.length-1],l="set"+s.substring(0,1).toUpperCase()+s.substring(1);if(r[l]){var u=r["get"+s.substring(0,1).toUpperCase()+s.substring(1)].bind(r)();u=[u.x,u.y,u.z,u.w];var c=r[l].bind(r);return{set:function(p){c(n(p))},get:function(){return u}}}var h=r[s];if((h===void 0?"undefined":j0(h))==="object"&&h.hasOwnProperty("copy"))return function(p){h.copy(n(p))};if([G,E,q,B,Z].indexOf(r.constructor)!==-1&&e.length>1){var f=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,d=e[e.length-2];return function(p){r[s]=n(p),f[d]=r}}return function(p){r[s]=n(p)}},i._createAnimTargetForProperty=function(t,e,n){if(this.handlers&&e[0].startsWith("weight."))return this.handlers.weight(t,e[0].replace("weight.",""));if(this.handlers&&e[0]==="material"&&e.length===2){var r,s,l,u=e[1];if(u.endsWith("Map"))return this.handlers.materialTexture(t,u)}var c=this._resolvePath(t,e,!0);if(c===void 0)return null;if(typeof c=="number")r=this._setter(t,e,a._packFloat),s="vector",l=1;else if(typeof c=="boolean")r=this._setter(t,e,a._packBoolean),s="vector",l=1;else if((c===void 0?"undefined":j0(c))==="object")switch(c.constructor){case G:r=this._setter(t,e,a._packVec2),s="vector",l=2;break;case E:r=this._setter(t,e,a._packVec3),s="vector",l=3;break;case q:r=this._setter(t,e,a._packVec4),s="vector",l=4;break;case B:r=this._setter(t,e,a._packColor),s="vector",l=4;break;case Z:r=this._setter(t,e,a._packQuat),s="quaternion",l=4;break;default:return null}return e.indexOf("material")!==-1?new oc(function(h){r(h),t.material.update()},s,l,n):new oc(r,s,l,n)},i.rebind=function(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;var t={},e=function(n){t[n.name]=n;for(var r=0;r<n.children.length;++r)e(n.children[r])};e(this.graph),this.nodes=t},a._packFloat=function(t){return t[0]},a._packBoolean=function(t){return!!t[0]},a._packVec2=function(t){return Yd.x=t[0],Yd.y=t[1],Yd},a._packVec3=function(t){return cc.x=t[0],cc.y=t[1],cc.z=t[2],cc},a._packVec4=function(t){return rl.x=t[0],rl.y=t[1],rl.z=t[2],rl.w=t[3],rl},a._packColor=function(t){return sl.r=t[0],sl.g=t[1],sl.b=t[2],sl.a=t[3],sl},a._packQuat=function(t){return al.x=t[0],al.y=t[1],al.z=t[2],al.w=t[3],al},a}(Gd),X0=function(){function o(t,e,n,r,s){r===void 0&&(r=1),s===void 0&&(s=Bd),this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=t,this._controller=e,this._component=n,this._weight=r,this._blendType=s}var a,i=o.prototype;return i.play=function(t){this._controller.play(t)},i.pause=function(){this._controller.pause()},i.reset=function(){this._controller.reset()},i.rebind=function(){this._controller.rebind()},i.update=function(t){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=U.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=t):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(t)},i.blendToWeight=function(t,e){this._startingWeight=this.weight,this._targetWeight=t,this._blendTime=Math.max(0,e),this._blendTimeElapsed=0},i.assignAnimation=function(t,e,n,r){(Qt!=null&&typeof Symbol<"u"&&Qt[Symbol.hasInstance]?Qt[Symbol.hasInstance](e):Q(e,Qt))&&(this._controller.assignAnimation(t,e,n,r),this._controller._transitions.length===0&&this._controller._transitions.push(new uc({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))},i.removeNodeAnimations=function(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)},i.getAnimationAsset=function(t){return this._component.animationAssets[this.name+":"+t]},i.transition=function(t,e,n){e===void 0&&(e=0),n===void 0&&(n=null),this._controller.updateStateFromTransition(new uc({from:this._controller.activeStateName,to:t,time:e,transitionOffset:n}))},a=[{key:"name",get:function(){return this._name}},{key:"playing",get:function(){return this._controller.playing},set:function(t){this._controller.playing=t}},{key:"playable",get:function(){return this._controller.playable}},{key:"activeState",get:function(){return this._controller.activeStateName}},{key:"previousState",get:function(){return this._controller.previousStateName}},{key:"activeStateProgress",get:function(){return this._controller.activeStateProgress}},{key:"activeStateDuration",get:function(){return this._controller.activeStateDuration}},{key:"activeStateCurrentTime",get:function(){return this._controller.activeStateCurrentTime},set:function(t){var e=this._controller,n=e.playing;e.playing=!0,e.activeStateCurrentTime=t,n||e.update(0),e.playing=n}},{key:"transitioning",get:function(){return this._controller.transitioning}},{key:"transitionProgress",get:function(){return this.transitioning?this._controller.transitionProgress:null}},{key:"states",get:function(){return this._controller.states}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._component.dirtifyTargets()}},{key:"blendType",get:function(){return this._blendType},set:function(t){t!==this._blendType&&(this._blendType=t,this._controller.normalizeWeights&&this._component.rebind())}},{key:"mask",get:function(){return this._mask},set:function(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),ol=function(){var o;function a(i){if(this._layers=[],this._parameters={},Array.isArray(i.layers))this._layers=i.layers;else for(var t in i.layers){for(var e=i.layers[t],n={name:e.name,blendType:e.blendType,weight:e.weight,states:[],transitions:[]},r=0;r<e.states.length;r++)n.states.push(i.states[e.states[r]]);for(var s=0;s<e.transitions.length;s++){var l=i.transitions[e.transitions[s]];if(l.conditions&&!Array.isArray(l.conditions)){for(var u=Object.keys(l.conditions),c=[],h=0;h<u.length;h++){var f=l.conditions[u[h]];f.parameterName&&c.push(f)}l.conditions=c}Number.isInteger(l.from)&&(l.from=i.states[l.from].name),Number.isInteger(l.to)&&(l.to=i.states[l.to].name),n.transitions.push(l)}this._layers.push(n)}for(var d in i.parameters){var p=i.parameters[d];this._parameters[p.name]={type:p.type,value:p.value}}}return o=[{key:"parameters",get:function(){return Object.assign({},this._parameters)}},{key:"layers",get:function(){return this._layers}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function Y0(){return(Y0=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function q0(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function K0(o,a){return(K0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var qd=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._stateGraphAsset=null,e._animationAssets={},e._speed=1,e._activate=!0,e._playing=!1,e._rootBone=null,e._stateGraph=null,e._layers=[],e._layerIndices={},e._parameters={},e._targets={},e._consumedTriggers=new Set,e._normalizeWeights=!1,e.findParameter=function(n){return e._parameters[n]},e.consumeTrigger=function(n){e._consumedTriggers.add(n)},e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&K0(a,o);var i,t=a.prototype;return t._onStateGraphAssetChangeEvent=function(e){var n=this.animationAssets,r=this.layers.map(function(s){return s.mask});this.removeStateGraph(),this._stateGraph=new ol(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=n,this.loadAnimationAssets(),this.layers.forEach(function(s,l){s.mask=r[l]}),this.rebind()},t.dirtifyTargets=function(){for(var e=Object.values(this._targets),n=0;n<e.length;n++)e[n].dirty=!0},t._addLayer=function(e){var n,r=e.name,s=e.states,l=e.transitions,u=e.weight,c=e.mask,h=e.blendType;n=this.rootBone?this.rootBone:this.entity;var f=this._layers.length,d=new H0(new Vd(new gL(this,n,r,c,f)),s,l,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new X0(r,d,this,u,h)),this._layerIndices[r]=f,this._layers[f]},t.addLayer=function(e,n,r,s){var l=this.findAnimationLayer(e);return l||this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:n,mask:r,blendType:s})},t._assignParameters=function(e){this._parameters={};for(var n=Object.keys(e.parameters),r=0;r<n.length;r++){var s=n[r];this._parameters[s]={type:e.parameters[s].type,value:e.parameters[s].value}}},t.loadStateGraph=function(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];for(var n=!1,r=0;r<e.layers.length;r++){var s=e.layers[r];this._addLayer(Y0({},s)),s.states.some(function(l){return l.blendTree})&&(n=!0)}n||this.setupAnimationAssets()},t.setupAnimationAssets=function(){for(var e=0;e<this._layers.length;e++)for(var n=this._layers[e],r=n.name,s=0;s<n.states.length;s++){var l=n.states[s];if(nl.indexOf(l)===-1){var u=r+":"+l;this._animationAssets[u]||(this._animationAssets[u]={asset:null})}}this.loadAnimationAssets()},t.loadAnimationAssets=function(){for(var e=0;e<this._layers.length;e++)for(var n=this._layers[e],r=0;r<n.states.length;r++){var s=n.states[r];if(nl.indexOf(s)===-1){var l=this._animationAssets[n.name+":"+s];if(!l||!l.asset){this.findAnimationLayer(n.name).assignAnimation(s,Qt.EMPTY);continue}var u=l.asset,c=this.system.app.assets.get(u);c&&(c.resource?this.onAnimationAssetLoaded(n.name,s,c):(c.once("load",(function(h,f){return(function(d){this.onAnimationAssetLoaded(h,f,d)}).bind(this)}).bind(this)(n.name,s)),this.system.app.assets.load(c)))}}},t.onAnimationAssetLoaded=function(e,n,r){this.findAnimationLayer(e).assignAnimation(n,r.resource)},t.removeStateGraph=function(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}},t.reset=function(){this._assignParameters(this._stateGraph);for(var e=0;e<this._layers.length;e++){var n=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=n}},t.unbind=function(){var e=this;this._normalizeWeights||Object.keys(this._targets).forEach(function(n){e._targets[n].unbind()})},t.rebind=function(){this._targets={};for(var e=0;e<this._layers.length;e++)this._layers[e].rebind()},t.findAnimationLayer=function(e){var n=this._layerIndices[e];return this._layers[n]||null},t.addAnimationState=function(e,n,r,s,l){r===void 0&&(r=1),s===void 0&&(s=!0),l===void 0&&(l="Base"),this._stateGraph||this.loadStateGraph(new ol({layers:[{name:l,states:[{name:"START",speed:1},{name:e,speed:r,loop:s,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));var u,c=this.findAnimationLayer(l);c?c.assignAnimation(e,n,r,s):(u=this.addLayer(l))==null||u.assignAnimation(e,n,r,s)},t.assignAnimation=function(e,n,r,s,l){if(s===void 0&&(s=1),l===void 0&&(l=!0),!this._stateGraph&&e.indexOf(".")===-1){this.loadStateGraph(new ol({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:s,loop:l,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,n);return}var u=r?this.findAnimationLayer(r):this.baseLayer;u&&u.assignAnimation(e,n,s,l)},t.removeNodeAnimations=function(e,n){var r=n?this.findAnimationLayer(n):this.baseLayer;r&&r.removeNodeAnimations(e)},t.getParameterValue=function(e,n){var r=this._parameters[e];if(r&&r.type===n)return r.value},t.setParameterValue=function(e,n,r){var s=this._parameters[e];if(s&&s.type===n){s.value=r;return}},t.getFloat=function(e){return this.getParameterValue(e,Fd)},t.setFloat=function(e,n){this.setParameterValue(e,Fd,n)},t.getInteger=function(e){return this.getParameterValue(e,Nd)},t.setInteger=function(e,n){typeof n=="number"&&n%1==0&&this.setParameterValue(e,Nd,n)},t.getBoolean=function(e){return this.getParameterValue(e,Ud)},t.setBoolean=function(e,n){this.setParameterValue(e,Ud,!!n)},t.getTrigger=function(e){return this.getParameterValue(e,tl)},t.setTrigger=function(e,n){n===void 0&&(n=!1),this.setParameterValue(e,tl,!0),n&&this._consumedTriggers.add(e)},t.resetTrigger=function(e){this.setParameterValue(e,tl,!1)},t.onBeforeRemove=function(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)},t.update=function(e){for(var n=this,r=0;r<this.layers.length;r++)this.layers[r].update(e*this.speed);this._consumedTriggers.forEach(function(s){n.parameters[s].value=!1}),this._consumedTriggers.clear()},t.resolveDuplicatedEntityReferenceProperties=function(e,n){e.rootBone&&n[e.rootBone.getGuid()]?this.rootBone=n[e.rootBone.getGuid()]:this.rebind()},i=[{key:"stateGraphAsset",get:function(){return this._stateGraphAsset},set:function(e){var n,r,s=this;if(e===null)return void this.removeStateGraph();this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this),q0(e,$)?(n=e.id,(r=this.system.app.assets.get(n))||(this.system.app.assets.add(e),r=this.system.app.assets.get(n))):(n=e,r=this.system.app.assets.get(n)),r&&this._stateGraphAsset!==n&&(r.resource?(this._stateGraph=r.resource,this.loadStateGraph(this._stateGraph),r.on("change",this._onStateGraphAssetChangeEvent,this)):(r.once("load",function(l){s._stateGraph=l.resource,s.loadStateGraph(s._stateGraph)}),r.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(r)),this._stateGraphAsset=n)}},{key:"normalizeWeights",get:function(){return this._normalizeWeights},set:function(e){this._normalizeWeights=e,this.unbind()}},{key:"animationAssets",get:function(){return this._animationAssets},set:function(e){this._animationAssets=e,this.loadAnimationAssets()}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"activate",get:function(){return this._activate},set:function(e){this._activate=e}},{key:"playing",get:function(){return this._playing},set:function(e){this._playing=e}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){if(typeof e=="string"){var n=this.entity.root.findByGuid(e);this._rootBone=n}else q0(e,ve)?this._rootBone=e:this._rootBone=null;this.rebind()}},{key:"stateGraph",get:function(){return this._stateGraph},set:function(e){this._stateGraph=e}},{key:"layers",get:function(){return this._layers}},{key:"layerIndices",get:function(){return this._layerIndices},set:function(e){this._layerIndices=e}},{key:"parameters",get:function(){return this._parameters},set:function(e){this._parameters=e}},{key:"targets",get:function(){return this._targets},set:function(e){this._targets=e}},{key:"playable",get:function(){for(var e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}},{key:"baseLayer",get:function(){return this._layers.length>0?this._layers[0]:null}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),yL=function(){this.enabled=!0};function Z0(o,a){return(Z0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Kd=["enabled"],Q0=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="anim",e.ComponentType=qd,e.DataType=yL,e.schema=Kd,e.on("beforeremove",e.onBeforeRemove,e),e.app.systems.on("animationUpdate",e.onAnimationUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Z0(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){var r=this;o.prototype.initializeComponentData.call(this,t,e,Kd);var s=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach(function(l){s.includes(l)||(t[l]=e[l])}),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers&&e.layers.forEach(function(l,u){l._controller.states.forEach(function(c){l._controller._states[c]._animationList.forEach(function(h){if(h.animTrack&&h.animTrack!==Qt.EMPTY)t.layers[u].assignAnimation(h.name,h.animTrack);else{var f=r.app.assets.get(l._component._animationAssets[l.name+":"+h.name].asset);f&&!f.loaded&&f.once("load",function(){t.layers[u].assignAnimation(h.name,f.resource)})}})})}),e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach(function(l){if(t.layers[l]){var u=e.masks[l].mask,c={};Object.keys(u).forEach(function(h){c[decodeURI(h)]=u[h]}),t.layers[l].mask=c}})},i.onAnimationUpdate=function(t){var e=this.store;for(var n in e)if(e.hasOwnProperty(n)){var r=e[n].entity.anim;r.data.enabled&&r.entity.enabled&&r.playing&&r.update(t)}},i.cloneComponent=function(t,e){t.anim.rootBone&&t.anim.rootBone!==t||(n={},t.anim.layers.forEach(function(s,l){if(s.mask){var u={};Object.keys(s.mask).forEach(function(c){var h=c.split("/");h.shift(),u[[].concat([e.name],h).join("/")]=s.mask[c]}),n[l]={mask:u}}}));var n,r={enabled:t.anim.enabled,stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters,normalizeWeights:t.anim.normalizeWeights,masks:n};return this.addComponent(e,r)},i.onBeforeRemove=function(t,e){e.onBeforeRemove()},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)},a}(We);function J0(o,a){return(J0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}de._buildAccessors(qd.prototype,Kd);var Zd=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&J0(a,o);var i=a.prototype;return i.setCurrentListener=function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}},i.onEnable=function(){this.setCurrentListener()},i.onDisable=function(){this.system.current===this.entity&&(this.system.current=null)},a}(de),SL=function(){this.enabled=!0};function $0(o,a){return($0=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ex=["enabled"],tx=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="audiolistener",e.ComponentType=Zd,e.DataType=SL,e.schema=ex,e.manager=t.soundManager,e.current=null,e.app.systems.on("update",e.onUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&$0(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){n=["enabled"],o.prototype.initializeComponentData.call(this,t,e,n)},i.onUpdate=function(t){if(this.current){var e=this.current.getPosition();this.manager.listener.setPosition(e);var n=this.current.getWorldTransform();this.manager.listener.setOrientation(n)}},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this)},a}(We);de._buildAccessors(Zd.prototype,ex);var ll="group",hc="image",Qd="text",ul="stretch",nx="contain",ix="cover";function rx(o,a){return(rx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ke={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},cl={};cl[Ke.DEFAULT]="_defaultTint",cl[Ke.HOVER]="hoverTint",cl[Ke.PRESSED]="pressedTint",cl[Ke.INACTIVE]="inactiveTint";var hl={};hl[Ke.DEFAULT]="_defaultSpriteAsset",hl[Ke.HOVER]="hoverSpriteAsset",hl[Ke.PRESSED]="pressedSpriteAsset",hl[Ke.INACTIVE]="inactiveSpriteAsset";var fl={};fl[Ke.DEFAULT]="_defaultSpriteFrame",fl[Ke.HOVER]="hoverSpriteFrame",fl[Ke.PRESSED]="pressedSpriteFrame",fl[Ke.INACTIVE]="inactiveSpriteFrame";var at=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._visualState=Ke.DEFAULT,r._isHovering=!1,r._hoveringCounter=0,r._isPressed=!1,r._defaultTint=new B(1,1,1,1),r._defaultSpriteAsset=null,r._defaultSpriteFrame=0,r._imageEntity=null,r._evtElementAdd=null,r._evtImageEntityElementAdd=null,r._evtImageEntityElementRemove=null,r._evtImageEntityElementColor=null,r._evtImageEntityElementOpacity=null,r._evtImageEntityElementSpriteAsset=null,r._evtImageEntityElementSpriteFrame=null,r._visualState=Ke.DEFAULT,r._isHovering=!1,r._hoveringCounter=0,r._isPressed=!1,r._defaultTint=new B(1,1,1,1),r._defaultSpriteAsset=null,r._defaultSpriteFrame=0,r._toggleLifecycleListeners("on",e),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&rx(a,o);var i,t=a.prototype;return t._setValue=function(e,n){var r=this.data,s=r[e];r[e]=n,this.fire("set",e,s,n)},t._toggleLifecycleListeners=function(e,n){if(this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e==="on")this._evtElementAdd=this.entity.on("element:add",this._onElementComponentAdd,this);else{var r;(r=this._evtElementAdd)==null||r.off(),this._evtElementAdd=null}},t._onSetActive=function(e,n,r){n!==r&&this._updateVisualState()},t._onSetTransitionMode=function(e,n,r){n!==r&&(this._cancelTween(),this._resetToDefaultVisualState(n),this._forceReapplyVisualState())},t._onSetTransitionValue=function(e,n,r){n!==r&&this._forceReapplyVisualState()},t._imageEntitySubscribe=function(){this._evtImageEntityElementAdd=this._imageEntity.on("element:add",this._onImageElementGain,this),this._imageEntity.element&&this._onImageElementGain()},t._imageEntityUnsubscribe=function(){var e,n;(e=this._evtImageEntityElementAdd)==null||e.off(),this._evtImageEntityElementAdd=null,(n=this._imageEntity)!=null&&n.element&&this._onImageElementLose()},t._imageEntityElementSubscribe=function(){var e=this._imageEntity.element;this._evtImageEntityElementRemove=e.once("beforeremove",this._onImageElementLose,this),this._evtImageEntityElementColor=e.on("set:color",this._onSetColor,this),this._evtImageEntityElementOpacity=e.on("set:opacity",this._onSetOpacity,this),this._evtImageEntityElementSpriteAsset=e.on("set:spriteAsset",this._onSetSpriteAsset,this),this._evtImageEntityElementSpriteFrame=e.on("set:spriteFrame",this._onSetSpriteFrame,this)},t._imageEntityElementUnsubscribe=function(){var e,n,r,s,l;(e=this._evtImageEntityElementRemove)==null||e.off(),this._evtImageEntityElementRemove=null,(n=this._evtImageEntityElementColor)==null||n.off(),this._evtImageEntityElementColor=null,(r=this._evtImageEntityElementOpacity)==null||r.off(),this._evtImageEntityElementOpacity=null,(s=this._evtImageEntityElementSpriteAsset)==null||s.off(),this._evtImageEntityElementSpriteAsset=null,(l=this._evtImageEntityElementSpriteFrame)==null||l.off(),this._evtImageEntityElementSpriteFrame=null},t._onElementComponentRemove=function(){this._toggleHitElementListeners("off")},t._onElementComponentAdd=function(){this._toggleHitElementListeners("on")},t._onImageElementLose=function(){this._imageEntityElementUnsubscribe(),this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)},t._onImageElementGain=function(){this._imageEntityElementSubscribe(),this._storeDefaultVisualState(),this._forceReapplyVisualState()},t._toggleHitElementListeners=function(e){if(this.entity.element){var n=e==="on";n&&this._hasHitElementListeners||(this.entity.element[e]("beforeremove",this._onElementComponentRemove,this),this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=n)}},t._storeDefaultVisualState=function(){var e,n=(e=this._imageEntity)==null?void 0:e.element;n&&n.type!==ll&&(this._storeDefaultColor(n.color),this._storeDefaultOpacity(n.opacity),this._storeDefaultSpriteAsset(n.spriteAsset),this._storeDefaultSpriteFrame(n.spriteFrame))},t._storeDefaultColor=function(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b},t._storeDefaultOpacity=function(e){this._defaultTint.a=e},t._storeDefaultSpriteAsset=function(e){this._defaultSpriteAsset=e},t._storeDefaultSpriteFrame=function(e){this._defaultSpriteFrame=e},t._onSetColor=function(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())},t._onSetOpacity=function(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())},t._onSetSpriteAsset=function(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())},t._onSetSpriteFrame=function(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())},t._onMouseEnter=function(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)},t._onMouseLeave=function(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)},t._onMouseDown=function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)},t._onMouseUp=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)},t._onTouchStart=function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)},t._onTouchEnd=function(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)},t._onTouchLeave=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)},t._onTouchCancel=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)},t._onSelectStart=function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)},t._onSelectEnd=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)},t._onSelectEnter=function(e){this._hoveringCounter++,this._hoveringCounter===1&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)},t._onSelectLeave=function(e){this._hoveringCounter--,this._hoveringCounter===0&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)},t._onClick=function(e){this._fireIfActive("click",e)},t._fireIfActive=function(e,n){this.data.active&&this.fire(e,n)},t._updateVisualState=function(e){var n=this._visualState,r=this._determineVisualState();if((n!==r||e)&&this.enabled)switch(this._visualState=r,n===Ke.HOVER&&this._fireIfActive("hoverend"),n===Ke.PRESSED&&this._fireIfActive("pressedend"),r===Ke.HOVER&&this._fireIfActive("hoverstart"),r===Ke.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:var s=this[cl[this._visualState]];this._applyTint(s);break;case 1:var l=hl[this._visualState],u=fl[this._visualState],c=this[l],h=this[u];this._applySprite(c,h)}},t._forceReapplyVisualState=function(){this._updateVisualState(!0)},t._resetToDefaultVisualState=function(e){var n;if((n=this._imageEntity)!=null&&n.element)switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},t._determineVisualState=function(){return this.active?this._isPressed?Ke.PRESSED:this._isHovering?Ke.HOVER:Ke.DEFAULT:Ke.INACTIVE},t._applySprite=function(e,n){var r,s=(r=this._imageEntity)==null?void 0:r.element;s&&(n=n||0,this._isApplyingSprite=!0,s.spriteAsset!==e&&(s.spriteAsset=e),s.spriteFrame!==n&&(s.spriteFrame=n),this._isApplyingSprite=!1)},t._applyTint=function(e){this._cancelTween(),this.fadeDuration===0?this._applyTintImmediately(e):this._applyTintWithTween(e)},t._applyTintImmediately=function(e){var n,r=(n=this._imageEntity)==null?void 0:n.element;if(e&&r&&r.type!==ll){var s=sx(e);this._isApplyingTint=!0,s.equals(r.color)||(r.color=s),r.opacity!==e.a&&(r.opacity=e.a),this._isApplyingTint=!1}},t._applyTintWithTween=function(e){var n,r=(n=this._imageEntity)==null?void 0:n.element;if(e&&r&&r.type!==ll){var s=sx(e),l=r.color,u=r.opacity;s.equals(l)&&e.a===u||(this._tweenInfo={startTime:un(),from:new B(l.r,l.g,l.b,u),to:e.clone(),lerpColor:new B})}},t._updateTintTween=function(){var e=un()-this._tweenInfo.startTime,n=this.fadeDuration===0?1:e/this.fadeDuration;if(Math.abs((n=U.clamp(n,0,1))-1)>1e-5){var r=this._tweenInfo.lerpColor;r.lerp(this._tweenInfo.from,this._tweenInfo.to,n),this._applyTintImmediately(new B(r.r,r.g,r.b,r.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},t._cancelTween=function(){delete this._tweenInfo},t.onUpdate=function(){this._tweenInfo&&this._updateTintTween()},t.onEnable=function(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._toggleHitElementListeners("on"),this._forceReapplyVisualState()},t.onDisable=function(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)},t.onRemove=function(){this._imageEntityUnsubscribe(),this._toggleLifecycleListeners("off",this.system),this.onDisable()},t.resolveDuplicatedEntityReferenceProperties=function(e,n){e.imageEntity&&(this.imageEntity=n[e.imageEntity.getGuid()])},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e)}},{key:"active",get:function(){return this.data.active},set:function(e){this._setValue("active",e)}},{key:"imageEntity",get:function(){return this._imageEntity},set:function(e){if(this._imageEntity!==e){var n=typeof e=="string";(!this._imageEntity||!n||this._imageEntity.getGuid()!==e)&&(this._imageEntity&&this._imageEntityUnsubscribe(),(pe!=null&&typeof Symbol<"u"&&pe[Symbol.hasInstance]?!!pe[Symbol.hasInstance](e):Q(e,pe))?this._imageEntity=e:n?this._imageEntity=this.system.app.getEntityFromIndex(e)||null:this._imageEntity=null,this._imageEntity&&this._imageEntitySubscribe(),this._imageEntity?this.data.imageEntity=this._imageEntity.getGuid():n&&e&&(this.data.imageEntity=e))}}},{key:"hitPadding",get:function(){return this.data.hitPadding},set:function(e){this._setValue("hitPadding",e)}},{key:"transitionMode",get:function(){return this.data.transitionMode},set:function(e){this._setValue("transitionMode",e)}},{key:"hoverTint",get:function(){return this.data.hoverTint},set:function(e){this._setValue("hoverTint",e)}},{key:"pressedTint",get:function(){return this.data.pressedTint},set:function(e){this._setValue("pressedTint",e)}},{key:"inactiveTint",get:function(){return this.data.inactiveTint},set:function(e){this._setValue("inactiveTint",e)}},{key:"fadeDuration",get:function(){return this.data.fadeDuration},set:function(e){this._setValue("fadeDuration",e)}},{key:"hoverSpriteAsset",get:function(){return this.data.hoverSpriteAsset},set:function(e){this._setValue("hoverSpriteAsset",e)}},{key:"hoverSpriteFrame",get:function(){return this.data.hoverSpriteFrame},set:function(e){this._setValue("hoverSpriteFrame",e)}},{key:"pressedSpriteAsset",get:function(){return this.data.pressedSpriteAsset},set:function(e){this._setValue("pressedSpriteAsset",e)}},{key:"pressedSpriteFrame",get:function(){return this.data.pressedSpriteFrame},set:function(e){this._setValue("pressedSpriteFrame",e)}},{key:"inactiveSpriteAsset",get:function(){return this.data.inactiveSpriteAsset},set:function(e){this._setValue("inactiveSpriteAsset",e)}},{key:"inactiveSpriteFrame",get:function(){return this.data.inactiveSpriteFrame},set:function(e){this._setValue("inactiveSpriteFrame",e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);function sx(o){return new B(o.r,o.g,o.b)}at.EVENT_MOUSEDOWN="mousedown",at.EVENT_MOUSEUP="mouseup",at.EVENT_MOUSEENTER="mouseenter",at.EVENT_MOUSELEAVE="mouseleave",at.EVENT_CLICK="click",at.EVENT_TOUCHSTART="touchstart",at.EVENT_TOUCHEND="touchend",at.EVENT_TOUCHCANCEL="touchcancel",at.EVENT_TOUCHLEAVE="touchleave",at.EVENT_SELECTSTART="selectstart",at.EVENT_SELECTEND="selectend",at.EVENT_SELECTENTER="selectenter",at.EVENT_SELECTLEAVE="selectleave",at.EVENT_HOVERSTART="hoverstart",at.EVENT_HOVEREND="hoverend",at.EVENT_PRESSEDSTART="pressedstart",at.EVENT_PRESSEDEND="pressedend";var xL=function(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new q,this.transitionMode=0,this.hoverTint=new B(.75,.75,.75),this.pressedTint=new B(.5,.5,.5),this.inactiveTint=new B(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0};function ax(o,a){return(ax=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ox=["enabled","active",{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],lx=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="button",e.ComponentType=at,e.DataType=xL,e.schema=ox,e.on("beforeremove",e._onRemoveComponent,e),e.app.systems.on("update",e.onUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ax(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){t.imageEntity=e.imageEntity,o.prototype.initializeComponentData.call(this,t,e,ox)},i.onUpdate=function(t){var e=this.store;for(var n in e){var r=e[n].entity,s=r.button;s.enabled&&r.enabled&&s.onUpdate()}},i._onRemoveComponent=function(t,e){e.onRemove()},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this)},a}(We);function ux(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function cx(o,a){return(cx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var hx=new E,fx=new Z,ts=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._compoundParent=null,r._hasOffset=!1,r.entity.on("insert",r._onInsert,r),r.on("set_type",r.onSetType,r),r.on("set_convexHull",r.onSetModel,r),r.on("set_halfExtents",r.onSetHalfExtents,r),r.on("set_linearOffset",r.onSetOffset,r),r.on("set_angularOffset",r.onSetOffset,r),r.on("set_radius",r.onSetRadius,r),r.on("set_height",r.onSetHeight,r),r.on("set_axis",r.onSetAxis,r),r.on("set_asset",r.onSetAsset,r),r.on("set_renderAsset",r.onSetRenderAsset,r),r.on("set_model",r.onSetModel,r),r.on("set_render",r.onSetRender,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&cx(a,o);var i,t=a.prototype;return t._setValue=function(e,n){var r=this.data,s=r[e];r[e]=n,this.fire("set",e,s,n)},t.onSetType=function(e,n,r){n!==r&&this.system.changeType(this,n,r)},t.onSetHalfExtents=function(e,n,r){var s=this.data.type;this.data.initialized&&s==="box"&&this.system.recreatePhysicalShapes(this)},t.onSetOffset=function(e,n,r){this._hasOffset=!this.data.linearOffset.equals(E.ZERO)||!this.data.angularOffset.equals(Z.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this)},t.onSetRadius=function(e,n,r){var s=this.data.type;this.data.initialized&&(s==="sphere"||s==="capsule"||s==="cylinder"||s==="cone")&&this.system.recreatePhysicalShapes(this)},t.onSetHeight=function(e,n,r){var s=this.data.type;this.data.initialized&&(s==="capsule"||s==="cylinder"||s==="cone")&&this.system.recreatePhysicalShapes(this)},t.onSetAxis=function(e,n,r){var s=this.data.type;this.data.initialized&&(s==="capsule"||s==="cylinder"||s==="cone")&&this.system.recreatePhysicalShapes(this)},t.onSetAsset=function(e,n,r){var s=this.system.app.assets;if(n){var l=s.get(n);l&&l.off("remove",this.onAssetRemoved,this)}if(r){ux(r,$)&&(this.data.asset=r.id);var u=s.get(this.data.asset);u&&(u.off("remove",this.onAssetRemoved,this),u.on("remove",this.onAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(r||(this.data.model=null),this.system.recreatePhysicalShapes(this))},t.onSetRenderAsset=function(e,n,r){var s=this.system.app.assets;if(n){var l=s.get(n);l&&l.off("remove",this.onRenderAssetRemoved,this)}if(r){ux(r,$)&&(this.data.renderAsset=r.id);var u=s.get(this.data.renderAsset);u&&(u.off("remove",this.onRenderAssetRemoved,this),u.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(r||(this.data.render=null),this.system.recreatePhysicalShapes(this))},t.onSetModel=function(e,n,r){this.data.initialized&&this.data.type==="mesh"&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},t.onSetRender=function(e,n,r){this.onSetModel(e,n,r)},t.onAssetRemoved=function(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)},t.onRenderAssetRemoved=function(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)},t.getCompoundChildShapeIndex=function(e){for(var n=this.data.shape,r=n.getNumChildShapes(),s=0;s<r;s++){var l=n.getChildShape(s);if(Ammo.getPointer(l)===Ammo.getPointer(e))return s}return null},t._onInsert=function(e){if(typeof Ammo<"u"){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(var n=this.entity.parent;n;){if(n.collision&&n.collision.type==="compound"){n.collision.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(n.collision):this.system.recreatePhysicalShapes(this);break}n=n.parent}}},t._updateCompound=function(){var e=this.entity;if(e._dirtyWorld){for(var n=e._dirtyLocal,r=e;r&&!n&&(!r.collision||r.collision!==this._compoundParent);)r._dirtyLocal&&(n=!0),r=r.parent;if(n){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);var s=this._compoundParent.entity.rigidbody;s&&s.activate()}}},t.getShapePosition=function(){var e=this.entity.getPosition();if(this._hasOffset){var n=this.entity.getRotation(),r=this.data.linearOffset;return fx.copy(n).transformVector(r,hx),hx.add(e)}return e},t.getShapeRotation=function(){var e=this.entity.getRotation();return this._hasOffset?fx.copy(e).mul(this.data.angularOffset):e},t.onEnable=function(){if(this.data.type==="mesh"&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){var e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{var n=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(n,this.data.shape),Ammo.destroy(n),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()},t.onDisable=function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?!this._compoundParent.entity._destroying&&(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},t.onBeforeRemove=function(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e)}},{key:"type",get:function(){return this.data.type},set:function(e){this._setValue("type",e)}},{key:"halfExtents",get:function(){return this.data.halfExtents},set:function(e){this._setValue("halfExtents",e)}},{key:"linearOffset",get:function(){return this.data.linearOffset},set:function(e){this._setValue("linearOffset",e)}},{key:"angularOffset",get:function(){return this.data.angularOffset},set:function(e){this._setValue("angularOffset",e)}},{key:"radius",get:function(){return this.data.radius},set:function(e){this._setValue("radius",e)}},{key:"axis",get:function(){return this.data.axis},set:function(e){this._setValue("axis",e)}},{key:"height",get:function(){return this.data.height},set:function(e){this._setValue("height",e)}},{key:"asset",get:function(){return this.data.asset},set:function(e){this._setValue("asset",e)}},{key:"renderAsset",get:function(){return this.data.renderAsset},set:function(e){this._setValue("renderAsset",e)}},{key:"convexHull",get:function(){return this.data.convexHull},set:function(e){this._setValue("convexHull",e)}},{key:"shape",get:function(){return this.data.shape},set:function(e){this._setValue("shape",e)}},{key:"model",get:function(){return this.data.model},set:function(e){this._setValue("model",e)}},{key:"render",get:function(){return this.data.render},set:function(e){this._setValue("render",e)}},{key:"checkVertexDuplicates",get:function(){return this.data.checkVertexDuplicates},set:function(e){this._setValue("checkVertexDuplicates",e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);ts.EVENT_CONTACT="contact",ts.EVENT_COLLISIONSTART="collisionstart",ts.EVENT_COLLISIONEND="collisionend",ts.EVENT_TRIGGERENTER="triggerenter",ts.EVENT_TRIGGERLEAVE="triggerleave";var bL=function(){this.enabled=!0,this.type="box",this.halfExtents=new E(.5,.5,.5),this.linearOffset=new E,this.angularOffset=new Z,this.radius=.5,this.axis=1,this.height=2,this.convexHull=!1,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=!0,this.shape=null,this.model=null,this.render=null,this.initialized=!1},Sa="static",Jt="dynamic",pr="kinematic",dx=function(){function o(i,t,e){this.entity=t.entity,this.component=t,this.app=i,typeof Ammo>"u"||Sn||(Sn=new Ammo.btVector3,Pr=new Ammo.btQuaternion,Cs=new Ammo.btTransform),this.initialize(e)}var a=o.prototype;return a.initialize=function(i){var t=this.entity,e=i.shape;if(e&&typeof Ammo<"u"){t.trigger&&t.trigger.destroy();var n=this.component;if(n){var r=n.getShapePosition(),s=n.getShapeRotation();Sn.setValue(r.x,r.y,r.z),Pr.setValue(s.x,s.y,s.z,s.w)}else{var l=t.getPosition(),u=t.getRotation();Sn.setValue(l.x,l.y,l.z),Pr.setValue(u.x,u.y,u.z,u.w)}Cs.setOrigin(Sn),Cs.setRotation(Pr);var c=this.app.systems.rigidbody.createBody(1,e,Cs);c.setRestitution(0),c.setFriction(0),c.setDamping(0,0),Sn.setValue(0,0,0),c.setLinearFactor(Sn),c.setAngularFactor(Sn),c.setCollisionFlags(4|c.getCollisionFlags()),c.entity=t,this.body=c,this.component.enabled&&t.enabled&&this.enable()}},a.destroy=function(){this.body&&(this.disable(),this.app.systems.rigidbody.destroyBody(this.body),this.body=null)},a._getEntityTransform=function(i){var t=this.component;if(t){var e=t.getShapePosition(),n=t.getShapeRotation();Sn.setValue(e.x,e.y,e.z),Pr.setValue(n.x,n.y,n.z,n.w)}else{var r=this.entity.getPosition(),s=this.entity.getRotation();Sn.setValue(r.x,r.y,r.z),Pr.setValue(s.x,s.y,s.z,s.w)}i.setOrigin(Sn),i.setRotation(Pr)},a.updateTransform=function(){this._getEntityTransform(Cs);var i=this.body;i.setWorldTransform(Cs),i.activate()},a.enable=function(){var i=this.body;if(i){var t=this.app.systems.rigidbody;0>t._triggers.indexOf(this)&&(t.addBody(i,16,65517),t._triggers.push(this)),i.forceActivationState(1),this.updateTransform()}},a.disable=function(){var i=this.body;if(i){var t=this.app.systems.rigidbody,e=t._triggers.indexOf(this);e>-1&&(t.removeBody(i),t._triggers.splice(e,1)),i.forceActivationState(5)}},o}();function mr(o,a){if(typeof a!="function"&&a!==null)throw TypeError("Super expression must either be null or a function");o.prototype=Object.create(a&&a.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),a&&px(o,a)}function px(o,a){return(px=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var fc=new X,TL=new E,dl=new E,ns=new Z,mx=new pe,EL=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","convexHull","asset","renderAsset","shape","model","render","checkVertexDuplicates"],is=function(){function o(i){this.system=i}var a=o.prototype;return a.beforeInitialize=function(i,t){t.shape=null,t.model=new cr,t.model.graph=new pe},a.afterInitialize=function(i,t){this.recreatePhysicalShapes(i),i.data.initialized=!0},a.reset=function(i,t){this.beforeInitialize(i,t),this.afterInitialize(i,t)},a.recreatePhysicalShapes=function(i){var t=i.entity,e=i.data;if(typeof Ammo<"u"){t.trigger&&(t.trigger.destroy(),delete t.trigger),e.shape&&(i._compoundParent&&(i!==i._compoundParent&&this.system._removeCompoundChild(i._compoundParent,e.shape),i._compoundParent.entity.rigidbody&&i._compoundParent.entity.rigidbody.activate()),this.destroyShape(e)),e.shape=this.createPhysicalShape(i.entity,e);var n=!i._compoundParent;if(e.type!=="compound"||i._compoundParent&&i!==i._compoundParent){if(e.type!=="compound"&&!i.rigidbody){i._compoundParent=null;for(var r=t.parent;r;){if(r.collision&&r.collision.type==="compound"){i._compoundParent=r.collision;break}r=r.parent}}}else i._compoundParent=i,t.forEach(this._addEachDescendant,i);i._compoundParent&&i!==i._compoundParent&&(n&&i._compoundParent.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(i._compoundParent):(this.system.updateCompoundChildTransform(t,!0),i._compoundParent.entity.rigidbody&&i._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):i._compoundParent||(t.trigger?t.trigger.initialize(e):t.trigger=new dx(this.system.app,i,e))}},a.createPhysicalShape=function(i,t){},a.updateTransform=function(i,t,e,n){i.entity.trigger&&i.entity.trigger.updateTransform()},a.destroyShape=function(i){i.shape&&(Ammo.destroy(i.shape),i.shape=null)},a.beforeRemove=function(i,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data))},a.remove=function(i,t){i.rigidbody&&i.rigidbody.body&&i.rigidbody.disableSimulation(),i.trigger&&(i.trigger.destroy(),delete i.trigger)},a.clone=function(i,t){var e=this.system.store[i.getGuid()],n={enabled:e.data.enabled,type:e.data.type,halfExtents:[e.data.halfExtents.x,e.data.halfExtents.y,e.data.halfExtents.z],linearOffset:[e.data.linearOffset.x,e.data.linearOffset.y,e.data.linearOffset.z],angularOffset:[e.data.angularOffset.x,e.data.angularOffset.y,e.data.angularOffset.z,e.data.angularOffset.w],radius:e.data.radius,axis:e.data.axis,height:e.data.height,convexHull:e.data.convexHull,asset:e.data.asset,renderAsset:e.data.renderAsset,model:e.data.model,render:e.data.render,checkVertexDuplicates:e.data.checkVertexDuplicates};return this.system.addComponent(t,n)},o}(),wL=function(o){function a(){return o.apply(this,arguments)||this}return mr(a,o),a.prototype.createPhysicalShape=function(i,t){if(typeof Ammo<"u"){var e=t.halfExtents,n=new Ammo.btVector3(e?e.x:.5,e?e.y:.5,e?e.z:.5),r=new Ammo.btBoxShape(n);return Ammo.destroy(n),r}},a}(is),AL=function(o){function a(){return o.apply(this,arguments)||this}return mr(a,o),a.prototype.createPhysicalShape=function(i,t){if(typeof Ammo<"u")return new Ammo.btSphereShape(t.radius)},a}(is),CL=function(o){function a(){return o.apply(this,arguments)||this}return mr(a,o),a.prototype.createPhysicalShape=function(i,t){var e,n,r,s=(e=t.axis)!=null?e:1,l=(n=t.radius)!=null?n:.5,u=Math.max(((r=t.height)!=null?r:2)-2*l,0),c=null;if(typeof Ammo<"u")switch(s){case 0:c=new Ammo.btCapsuleShapeX(l,u);break;case 1:c=new Ammo.btCapsuleShape(l,u);break;case 2:c=new Ammo.btCapsuleShapeZ(l,u)}return c},a}(is),PL=function(o){function a(){return o.apply(this,arguments)||this}return mr(a,o),a.prototype.createPhysicalShape=function(i,t){var e,n,r,s=(e=t.axis)!=null?e:1,l=(n=t.radius)!=null?n:.5,u=(r=t.height)!=null?r:1,c=null,h=null;if(typeof Ammo<"u")switch(s){case 0:c=new Ammo.btVector3(.5*u,l,l),h=new Ammo.btCylinderShapeX(c);break;case 1:c=new Ammo.btVector3(l,.5*u,l),h=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(l,l,.5*u),h=new Ammo.btCylinderShapeZ(c)}return c&&Ammo.destroy(c),h},a}(is),IL=function(o){function a(){return o.apply(this,arguments)||this}return mr(a,o),a.prototype.createPhysicalShape=function(i,t){var e,n,r,s=(e=t.axis)!=null?e:1,l=(n=t.radius)!=null?n:.5,u=(r=t.height)!=null?r:1,c=null;if(typeof Ammo<"u")switch(s){case 0:c=new Ammo.btConeShapeX(l,u);break;case 1:c=new Ammo.btConeShape(l,u);break;case 2:c=new Ammo.btConeShapeZ(l,u)}return c},a}(is),LL=function(o){function a(){return o.apply(this,arguments)||this}mr(a,o);var i=a.prototype;return i.beforeInitialize=function(t,e){},i.createAmmoHull=function(t,e,n,r){var s=new Ammo.btConvexHullShape,l=new Ammo.btVector3,u=[];t.getPositions(u);for(var c=0;c<u.length;c+=3)l.setValue(u[c]*r.x,u[c+1]*r.y,u[c+2]*r.z),s.addPoint(l,!1);Ammo.destroy(l),s.recalcLocalAabb(),s.setMargin(.01);var h=this.system._getNodeTransform(e);n.addChildShape(h,s),Ammo.destroy(h)},i.createAmmoMesh=function(t,e,n,r,s){s===void 0&&(s=!0);var l=this.system;if(l._triMeshCache[t.id])u=l._triMeshCache[t.id];else{for(var u,c,h,f,d,p,_=t.vertexBuffer,g=_.getFormat(),y=0;y<g.elements.length;y++){var v=g.elements[y];if(v.name===oe){h=new Float32Array(_.lock(),v.offset),c=v.stride/4;break}}var x=[];t.getIndices(x);var S=t.primitive[0].count/3,T=new Ammo.btVector3,b=t.primitive[0].base;u=new Ammo.btTriangleMesh,l._triMeshCache[t.id]=u;var w=new Map;u.getIndexedMeshArray().at(0).m_numTriangles=S;for(var A=r?r.x:1,C=r?r.y:1,L=r?r.z:1,I=function(D){var O,F=h[D*c]*A,N=h[D*c+1]*C,j=h[D*c+2]*L;if(s){var z=F+":"+N+":"+j;if((O=w.get(z))!==void 0)return O;T.setValue(F,N,j),O=u.findOrAddVertex(T,!1),w.set(z,O)}else T.setValue(F,N,j),O=u.findOrAddVertex(T,!1);return O},P=0;P<S;P++)f=I(x[b+3*P]),d=I(x[b+3*P+1]),p=I(x[b+3*P+2]),u.addIndex(f),u.addIndex(d),u.addIndex(p);Ammo.destroy(T)}var M=new Ammo.btBvhTriangleMeshShape(u,!0);if(!r){var R=l._getNodeScaling(e);M.setLocalScaling(R),Ammo.destroy(R)}var k=l._getNodeTransform(e);n.addChildShape(k,M),Ammo.destroy(k)},i.createPhysicalShape=function(t,e){if(typeof Ammo<"u"&&(e.model||e.render)){var n=new Ammo.btCompoundShape,r=t.getWorldTransform().getScale();if(e.render)for(var s=e.render.meshes,l=0;l<s.length;l++)e.convexHull?this.createAmmoHull(s[l],mx,n,r):this.createAmmoMesh(s[l],mx,n,r,e.checkVertexDuplicates);else if(e.model){for(var u=e.model.meshInstances,c=0;c<u.length;c++)this.createAmmoMesh(u[c].mesh,u[c].node,n,null,e.checkVertexDuplicates);var h=new Ammo.btVector3(r.x,r.y,r.z);n.setLocalScaling(h),Ammo.destroy(h)}return n}},i.recreatePhysicalShapes=function(t){var e=t.data;if((e.renderAsset||e.asset)&&t.enabled&&t.entity.enabled)return void this.loadAsset(t,e.renderAsset||e.asset,e.renderAsset?"render":"model");this.doRecreatePhysicalShape(t)},i.loadAsset=function(t,e,n){var r=this,s=t.data,l=this.system.app.assets,u=s[n],c=function(d){s[n]===u&&(s[n]=d.resource,r.doRecreatePhysicalShape(t))},h=function(d){d.ready(function(p){if(p.data.containerAsset){var _=l.get(p.data.containerAsset);_.loaded?c(p):(_.ready(function(){c(p)}),l.load(_))}else c(p)}),l.load(d)},f=l.get(e);f?h(f):l.once("add:"+e,h)},i.doRecreatePhysicalShape=function(t){var e=t.entity,n=t.data;n.model||n.render?(this.destroyShape(n),n.shape=this.createPhysicalShape(e,n),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):e.trigger?e.trigger.initialize(n):e.trigger=new dx(this.system.app,t,n)):(this.beforeRemove(e,t),this.remove(e,n))},i.updateTransform=function(t,e,n,r){if(t.shape){var s=t.entity.getWorldTransform().getScale(),l=t.shape.getLocalScaling();(s.x!==l.x()||s.y!==l.y()||s.z!==l.z())&&this.doRecreatePhysicalShape(t)}o.prototype.updateTransform.call(this,t,e,n,r)},i.destroyShape=function(t){if(t.shape){for(var e=t.shape.getNumChildShapes(),n=0;n<e;n++){var r=t.shape.getChildShape(n);Ammo.destroy(r)}Ammo.destroy(t.shape),t.shape=null}},a}(is),DL=function(o){function a(){return o.apply(this,arguments)||this}mr(a,o);var i=a.prototype;return i.createPhysicalShape=function(t,e){if(typeof Ammo<"u")return new Ammo.btCompoundShape},i._addEachDescendant=function(t){t.collision&&!t.rigidbody&&(t.collision._compoundParent=this,t!==this.entity&&t.collision.system.recreatePhysicalShapes(t.collision))},i._updateEachDescendant=function(t){t.collision&&t.collision._compoundParent===this&&(t.collision._compoundParent=null,t===this.entity||t.rigidbody||t.collision.system.recreatePhysicalShapes(t.collision))},i._updateEachDescendantTransform=function(t){t.collision&&t.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(t,!1)},a}(is),_x=function(o){function a(t){var e;return(e=o.call(this,t)||this).id="collision",e.ComponentType=ts,e.DataType=bL,e.schema=EL,e.implementations={},e._triMeshCache={},e.on("beforeremove",e.onBeforeRemove,e),e.on("remove",e.onRemove,e),e}mr(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){n=["type","halfExtents","radius","axis","height","convexHull","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];for(var r,s={},l=0,u=n.length;l<u;l++){var c=n[l];s[c]=e[c]}if(e.hasOwnProperty("asset")?((r=n.indexOf("model"))!==-1&&n.splice(r,1),(r=n.indexOf("render"))!==-1&&n.splice(r,1)):e.hasOwnProperty("model")&&(r=n.indexOf("asset"))!==-1&&n.splice(r,1),s.type||(s.type=t.data.type),t.data.type=s.type,Array.isArray(s.halfExtents)&&(s.halfExtents=new E(s.halfExtents)),Array.isArray(s.linearOffset)&&(s.linearOffset=new E(s.linearOffset)),Array.isArray(s.angularOffset)){var h=s.angularOffset;h.length===3?s.angularOffset=new Z().setFromEulerAngles(h[0],h[1],h[2]):s.angularOffset=new Z(s.angularOffset)}var f=this._createImplementation(s.type);f.beforeInitialize(t,s),o.prototype.initializeComponentData.call(this,t,s,n),f.afterInitialize(t,s)},i._createImplementation=function(t){if(this.implementations[t]===void 0){var e;switch(t){case"box":e=new wL(this);break;case"sphere":e=new AL(this);break;case"capsule":e=new CL(this);break;case"cylinder":e=new PL(this);break;case"cone":e=new IL(this);break;case"mesh":e=new LL(this);break;case"compound":e=new DL(this)}this.implementations[t]=e}return this.implementations[t]},i._getImplementation=function(t){return this.implementations[t.collision.data.type]},i.cloneComponent=function(t,e){return this._getImplementation(t).clone(t,e)},i.onBeforeRemove=function(t,e){this.implementations[e.data.type].beforeRemove(t,e),e.onBeforeRemove()},i.onRemove=function(t,e){this.implementations[e.type].remove(t,e)},i.updateCompoundChildTransform=function(t,e){var n=t.collision._compoundParent;if(n!==t.collision&&t.enabled&&t.collision.enabled&&(t._dirtyLocal||e)){var r=this._getNodeTransform(t,n.entity),s=n.getCompoundChildShapeIndex(t.collision.shape);s===null?n.shape.addChildShape(r,t.collision.data.shape):n.shape.updateChildTransform(s,r,!0),Ammo.destroy(r)}},i._removeCompoundChild=function(t,e){if(t.shape.getNumChildShapes()!==0)if(t.shape.removeChildShape)t.shape.removeChildShape(e);else{var n=t.getCompoundChildShapeIndex(e);n!==null&&t.shape.removeChildShapeByIndex(n)}},i.onTransformChanged=function(t,e,n,r){this.implementations[t.data.type].updateTransform(t,e,n,r)},i.changeType=function(t,e,n){this.implementations[e].beforeRemove(t.entity,t),this.implementations[e].remove(t.entity,t.data),this._createImplementation(n).reset(t,t.data)},i.recreatePhysicalShapes=function(t){this.implementations[t.data.type].recreatePhysicalShapes(t)},i._calculateNodeRelativeTransform=function(t,e){if(t===e){var n=t.getWorldTransform().getScale();fc.setScale(n.x,n.y,n.z)}else this._calculateNodeRelativeTransform(t.parent,e),fc.mul(t.getLocalTransform())},i._getNodeScaling=function(t){var e=t.getWorldTransform().getScale();return new Ammo.btVector3(e.x,e.y,e.z)},i._getNodeTransform=function(t,e){e?(this._calculateNodeRelativeTransform(t,e),n=TL,r=ns,fc.getTranslation(n),r.setFromMat4(fc)):(n=t.getPosition(),r=t.getRotation());var n,r,s=new Ammo.btQuaternion,l=new Ammo.btTransform;l.setIdentity();var u=l.getOrigin(),c=t.collision;if(c&&c._hasOffset){var h=c.data.linearOffset,f=c.data.angularOffset;ns.copy(r).transformVector(h,dl),dl.add(n),ns.copy(r).mul(f),u.setValue(dl.x,dl.y,dl.z),s.setValue(ns.x,ns.y,ns.z,ns.w)}else u.setValue(n.x,n.y,n.z),s.setValue(r.x,r.y,r.z,r.w);return l.setRotation(s),Ammo.destroy(s),l},i.destroy=function(){for(var t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,o.prototype.destroy.call(this)},a}(We);function pl(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var dc=new B,ML=new It,RL=function(){function o(i,t,e){this._entity=i,this._element=i.element,this.model=new cr,this.node=new pe,this.model.graph=this.node,this.mesh=t,this.meshInstance=new De(this.mesh,e,this.node),this.meshInstance.name="ImageElement: "+i.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}var a=o.prototype;return a.destroy=function(){var i,t;this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,(i=this.meshInstance)==null||i.destroy(),this.meshInstance=null,(t=this.unmaskMeshInstance)==null||t.destroy(),this.unmaskMeshInstance=null,this._entity=null,this._element=null},a.setMesh=function(i){this.meshInstance&&(this.mesh=i,this.meshInstance.mesh=i,this.meshInstance.visible=!!i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=i),this.forceUpdateAabb())},a.setMask=function(i){if(this.meshInstance){if(this._entity.enabled&&this._element.enabled&&this._element.removeModelFromLayers(this.model),i)for(var t in this.unmaskMeshInstance=new De(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data);else{var e,n=this.model.meshInstances.indexOf(this.unmaskMeshInstance);n>=0&&this.model.meshInstances.splice(n,1)}this._entity.enabled&&this._element.enabled&&this._element.addModelToLayers(this.model),i||((e=this.unmaskMeshInstance)==null||e.destroy(),this.unmaskMeshInstance=null)}},a.setMaterial=function(i){this.meshInstance&&(this.meshInstance.material=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=i))},a.setParameter=function(i,t){this.meshInstance&&(this.meshInstance.setParameter(i,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(i,t))},a.deleteParameter=function(i){this.meshInstance&&(this.meshInstance.deleteParameter(i),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(i))},a.setUnmaskDrawOrder=function(){if(this.meshInstance){var i=function(e){var n,r=e.children,s=r.length;if(s){for(var l=0;l<s;l++)r[l].element&&(n=r[l]);if(!n)return null;var u=i(n);return u||n}return null};if(this.unmaskMeshInstance){var t=i(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}},a.setDrawOrder=function(i){this.meshInstance&&(this.meshInstance.drawOrder=i)},a.setCull=function(i){if(this.meshInstance){var t=this._element,e=null;i&&t._isScreenSpace()&&(e=function(n){return t.isVisibleForCamera(n)}),this.meshInstance.cull=i,this.meshInstance.isVisibleFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=i,this.unmaskMeshInstance.isVisibleFunc=e)}},a.setScreenSpace=function(i){this.meshInstance&&(this.meshInstance.screenSpace=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=i))},a.setLayer=function(i){this.meshInstance&&(this.meshInstance.layer=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=i))},a.forceUpdateAabb=function(i){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))},a.setAabbFunc=function(i){this.meshInstance&&(this.meshInstance._updateAabbFunc=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=i))},o}(),vx=function(){function o(t){this._evtSetMeshes=null,this._element=t,this._entity=t.entity,this._system=t.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new q(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new G,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new q,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new q,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new RL(this._entity,this._defaultMesh,this._material),this._color=new B(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}var a,i=o.prototype;return i.destroy=function(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)},i._onResolutionChange=function(t){},i._onParentResizeOrPivotChange=function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},i._onScreenSpaceChange=function(t){this._updateMaterial(t)},i._onScreenChange=function(t,e){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)},i._onDrawOrderChange=function(t){this._renderable.setDrawOrder(t),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},i._hasUserMaterial=function(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1},i._use9Slicing=function(){return this.sprite&&(this.sprite.renderMode===1||this.sprite.renderMode===2)},i._updateMaterial=function(t){var e=!!this._mask,n=!!(this.sprite&&this.sprite.renderMode===1),r=!!(this.sprite&&this.sprite.renderMode===2);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(t,e,n,r)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(t),this._renderable.setLayer(15*!t))},i._createMesh=function(){var t=this._element,e=t.calculatedWidth,n=t.calculatedHeight,r=this._rect,s=this._system.app.graphicsDevice,l=new Float32Array([e,0,0,0,0,1,r.x+r.z,1-r.y,e,n,0,0,0,1,r.x+r.z,1-(r.y+r.w),0,0,0,0,0,1,r.x,1-r.y,0,n,0,0,0,1,r.x,1-(r.y+r.w)]),u=ML.get(s,function(){return new Ot(s,[{semantic:oe,components:3,type:6},{semantic:bt,components:3,type:6},{semantic:mt,components:2,type:6}])}),c=new Rt(s,u,4,{data:l.buffer}),h=new ye(s);return h.vertexBuffer=c,h.primitive[0].type=5,h.primitive[0].base=0,h.primitive[0].count=4,h.primitive[0].indexed=!1,h.aabb.setMinMax(E.ZERO,new E(e,n,0)),this._updateMesh(h),h},i._updateMesh=function(t){var e=this._element,n=e.calculatedWidth,r=e.calculatedHeight;if(e.fitMode!==ul&&this._targetAspectRatio>0){var s=e.calculatedWidth/e.calculatedHeight;e.fitMode===nx&&s>this._targetAspectRatio||e.fitMode===ix&&s<this._targetAspectRatio?n=e.calculatedHeight*this._targetAspectRatio:r=e.calculatedWidth/this._targetAspectRatio}var l=e._isScreenSpace();if(this._updateMaterial(l),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(this.sprite.renderMode===1||this.sprite.renderMode===2)){var u=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],c=2/u.rect.z,h=2/u.rect.w;this._innerOffset.set(u.border.x*c,u.border.y*h,u.border.z*c,u.border.w*h);var f=this.sprite.atlas.texture;this._atlasRect.set(u.rect.x/f.width,u.rect.y/f.height,u.rect.z/f.width,u.rect.w/f.height);var d=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit,p=u.rect.z/d,_=u.rect.w/d;this._outerScale.set(Math.max(n,this._innerOffset.x*p),Math.max(r,this._innerOffset.y*_));var g=p,y=_;this._outerScale.x/=p,this._outerScale.y/=_,g*=U.clamp(n/(this._innerOffset.x*p),1e-4,1),y*=U.clamp(r/(this._innerOffset.y*_),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(g,y,1),this._renderable.node.setLocalPosition((.5-e.pivot.x)*n,(.5-e.pivot.y)*r,0))}else{var v=t.vertexBuffer,x=new Float32Array(v.lock()),S=e.pivot.x,T=e.pivot.y;x[0]=n-S*n,x[1]=0-T*r,x[8]=n-S*n,x[9]=r-T*r,x[16]=0-S*n,x[17]=0-T*r,x[24]=0-S*n,x[25]=r-T*r;var b=1,w=1,A=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var C=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];C&&(A=C.rect,b=this._sprite.atlas.texture.width,w=this._sprite.atlas.texture.height)}x[6]=(A.x+A.z)/b,x[7]=1-A.y/w,x[14]=(A.x+A.z)/b,x[15]=1-(A.y+A.w)/w,x[22]=A.x/b,x[23]=1-A.y/w,x[30]=A.x/b,x[31]=1-(A.y+A.w)/w,v.unlock();var L=new E(0-S*n,0-T*r,0),I=new E(n-S*n,r-T*r,0);t.aabb.setMinMax(L,I),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}this._meshDirty=!1},i._updateSprite=function(){var t=!1,e=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){e=this._sprite.meshes[this.spriteFrame],t=this._sprite.renderMode===1||this._sprite.renderMode===2;var n=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(n==null?void 0:n.rect.w)>0&&(this._targetAspectRatio=n.rect.z/n.rect.w)}this.mesh=t?e:this._defaultMesh,this.refreshMesh()},i.refreshMesh=function(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))},i._updateAabb=function(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform()),t},i._toggleMask=function(){this._element._dirtifyMask();var t=this._element._isScreenSpace();this._updateMaterial(t),this._renderable.setMask(!!this._mask)},i._onMaterialLoad=function(t){this.material=t.resource},i._onMaterialAdded=function(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)},i._bindMaterialAsset=function(t){this._entity.enabled&&(t.on("load",this._onMaterialLoad,this),t.on("change",this._onMaterialChange,this),t.on("remove",this._onMaterialRemove,this),t.resource?this._onMaterialLoad(t):this._system.app.assets.load(t))},i._unbindMaterialAsset=function(t){t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)},i._onMaterialChange=function(){},i._onMaterialRemove=function(){},i._onTextureAdded=function(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this),this._textureAsset===t.id&&this._bindTextureAsset(t)},i._bindTextureAsset=function(t){this._entity.enabled&&(t.on("load",this._onTextureLoad,this),t.on("change",this._onTextureChange,this),t.on("remove",this._onTextureRemove,this),t.resource?this._onTextureLoad(t):this._system.app.assets.load(t))},i._unbindTextureAsset=function(t){t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)},i._onTextureLoad=function(t){this.texture=t.resource},i._onTextureChange=function(t){},i._onTextureRemove=function(t){},i._onSpriteAssetAdded=function(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)},i._bindSpriteAsset=function(t){this._entity.enabled&&(t.on("load",this._onSpriteAssetLoad,this),t.on("change",this._onSpriteAssetChange,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._system.app.assets.load(t))},i._unbindSpriteAsset=function(t){t.off("load",this._onSpriteAssetLoad,this),t.off("change",this._onSpriteAssetChange,this),t.off("remove",this._onSpriteAssetRemove,this),t.data.textureAtlasAsset&&this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},i._onSpriteAssetLoad=function(t){if(t&&t.resource)if(t.resource.atlas)this.sprite=t.resource;else{var e=t.data.textureAtlasAsset;if(e){var n=this._system.app.assets;n.off("load:"+e,this._onTextureAtlasLoad,this),n.once("load:"+e,this._onTextureAtlasLoad,this)}}else this.sprite=null},i._onSpriteAssetChange=function(t){this._onSpriteAssetLoad(t)},i._onSpriteAssetRemove=function(t){},i._bindSprite=function(t){this._evtSetMeshes=t.on("set:meshes",this._onSpriteMeshesChange,this),t.on("set:pixelsPerUnit",this._onSpritePpuChange,this),t.on("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.on("set:texture",this._onAtlasTextureChange,this)},i._unbindSprite=function(t){var e;(e=this._evtSetMeshes)==null||e.off(),this._evtSetMeshes=null,t.off("set:pixelsPerUnit",this._onSpritePpuChange,this),t.off("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.off("set:texture",this._onAtlasTextureChange,this)},i._onSpriteMeshesChange=function(){this._sprite&&(this._spriteFrame=U.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()},i._onSpritePpuChange=function(){this.sprite.renderMode!==0&&this._pixelsPerUnit===null&&this._updateSprite()},i._onAtlasTextureChange=function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},i._onTextureAtlasLoad=function(t){var e=this._spriteAsset;pl(e,$)?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))},i.onEnable=function(){if(this._materialAsset){var t=this._system.app.assets.get(this._materialAsset);t&&t.resource!==this._material&&this._bindMaterialAsset(t)}if(this._textureAsset){var e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){var n=this._system.app.assets.get(this._spriteAsset);n&&n.resource!==this._sprite&&this._bindSpriteAsset(n)}this._element.addModelToLayers(this._renderable.model)},i.onDisable=function(){this._element.removeModelFromLayers(this._renderable.model)},i._setStencil=function(t){this._renderable.meshInstance.stencilFront=t,this._renderable.meshInstance.stencilBack=t;var e=0;if(this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){var n=new Xt({ref:e+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=n,this._renderable.unmaskMeshInstance.stencilBack=n}},i._updateRenderableEmissive=function(){dc.linear(this._color),this._colorUniform[0]=dc.r,this._colorUniform[1]=dc.g,this._colorUniform[2]=dc.b,this._renderable.setParameter("material_emissive",this._colorUniform)},i._removeMaterialAssetEvents=function(){if(this._materialAsset){var t=this._system.app.assets;t.off("add:"+this._materialAsset,this._onMaterialAdded,this);var e=t.get(this._materialAsset);e&&(e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this))}},a=[{key:"color",get:function(){return this._color},set:function(t){var e=t.r,n=t.g,r=t.b;(this._color.r!==e||this._color.g!==n||this._color.b!==r)&&(this._color.r=e,this._color.g=n,this._color.b=r,this._updateRenderableEmissive()),this._element&&this._element.fire("set:color",this._color)}},{key:"opacity",get:function(){return this._color.a},set:function(t){t!==this._color.a&&(this._color.a=t,this._renderable.setParameter("material_opacity",t)),this._element&&this._element.fire("set:opacity",t)}},{key:"rect",get:function(){return this._rect},set:function(t){var e,n,r,s;pl(t,q)?(e=t.x,n=t.y,r=t.z,s=t.w):(e=t[0],n=t[1],r=t[2],s=t[3]),(e!==this._rect.x||n!==this._rect.y||r!==this._rect.z||s!==this._rect.w)&&(this._rect.set(e,n,r,s),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}},{key:"material",get:function(){return this._material},set:function(t){if(this._material!==t){if(!t){var e=this._element._isScreenSpace();t=this.mask?e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}if(this._material=t,this._materialAsset){var n=this._system.app.assets.get(this._materialAsset);n&&n.resource===t||(this._removeMaterialAssetEvents(),this._materialAsset=null)}t&&(this._renderable.setMaterial(t),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a)))}}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(t){var e=this._system.app.assets,n=t;if(pl(t,$)&&(n=t.id),this._materialAsset!==n)if(this._removeMaterialAssetEvents(),this._materialAsset=n,this._materialAsset){var r=e.get(this._materialAsset);r?this._bindMaterialAsset(r):(this._materialAsset=null,this.material=null,this._materialAsset=n,e.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this._materialAsset=null,this.material=null,this._materialAsset=n}},{key:"texture",get:function(){return this._texture},set:function(t){if(this._texture!==t){if(this._textureAsset){var e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==t&&(this.textureAsset=null)}if(this._texture=t,t){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a);var n=this._texture.width/this._texture.height;n!==this._targetAspectRatio&&(this._targetAspectRatio=n,this._element.fitMode!==ul&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==ul&&this.refreshMesh()}}},{key:"textureAsset",get:function(){return this._textureAsset},set:function(t){var e=this._system.app.assets,n=t;if(pl(t,$)&&(n=t.id),this._textureAsset!==n){if(this._textureAsset){e.off("add:"+this._textureAsset,this._onTextureAdded,this);var r=e.get(this._textureAsset);r&&(r.off("load",this._onTextureLoad,this),r.off("change",this._onTextureChange,this),r.off("remove",this._onTextureRemove,this))}if(this._textureAsset=n,this._textureAsset){var s=e.get(this._textureAsset);s?this._bindTextureAsset(s):(this.texture=null,e.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}},{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(t){var e=this._system.app.assets,n=t;if(pl(t,$)&&(n=t.id),this._spriteAsset!==n){if(this._spriteAsset){e.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);var r=e.get(this._spriteAsset);r&&this._unbindSpriteAsset(r)}if(this._spriteAsset=n,this._spriteAsset){var s=e.get(this._spriteAsset);s?this._bindSpriteAsset(s):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",n)}},{key:"sprite",get:function(){return this._sprite},set:function(t){if(this._sprite!==t){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==t&&(this.spriteAsset=null)}this._sprite=t,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=U.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){var e=this._spriteFrame;this._sprite?this._spriteFrame=U.clamp(t,0,this._sprite.frameKeys.length-1):this._spriteFrame=t,this._spriteFrame!==e&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",t)}},{key:"mesh",get:function(){return this._renderable.mesh},set:function(t){this._renderable.setMesh(t),this._defaultMesh===t?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}},{key:"mask",get:function(){return this._mask},set:function(t){this._mask!==t&&(this._mask=t,this._toggleMask())}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this._sprite&&(this._sprite.renderMode===1||this._sprite.renderMode===2)&&this._updateSprite())}},{key:"aabb",get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function gx(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function yx(o,a){return(yx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Sx=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._app=e,e.i18n.on($r.EVENT_CHANGE,n._onSetLocale,n),n._autoLoad=!1,n._disableLocalization=!1,n._defaultAsset=null,n._localizedAsset=null,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&yx(a,o);var i,t=a.prototype;return t._bindDefaultAsset=function(){var e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)},t._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}},t._onDefaultAssetAdd=function(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))},t._onDefaultAssetRemove=function(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))},t._bindLocalizedAsset=function(){if(this._autoLoad){var e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}},t._unbindLocalizedAsset=function(){var e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))},t._onLocalizedAssetAdd=function(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()},t._onLocalizedAssetLoad=function(e){this.fire("load",e)},t._onLocalizedAssetChange=function(e,n,r,s){this.fire("change",e,n,r,s)},t._onLocalizedAssetRemove=function(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)},t._onLocaleAdd=function(e,n){this._app.i18n.locale===e&&this._onSetLocale(e)},t._onLocaleRemove=function(e,n){this._app.i18n.locale===e&&this._onSetLocale(e)},t._onSetLocale=function(e){if(!this._defaultAsset){this.localizedAsset=null;return}var n=this._app.assets.get(this._defaultAsset);if(!n||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}var r=n.getLocalizedAssetId(e);if(!r){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=r},t.destroy=function(){this.defaultAsset=null,this._app.i18n.off($r.EVENT_CHANGE,this._onSetLocale,this),this.off()},i=[{key:"defaultAsset",get:function(){return this._defaultAsset},set:function(e){var n=gx(e,$)?e.id:e;this._defaultAsset!==n&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=n,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}},{key:"localizedAsset",get:function(){return this._localizedAsset},set:function(e){var n=gx(e,$)?e.id:e;this._localizedAsset!==n&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset()),this._localizedAsset=n,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)))}},{key:"autoLoad",get:function(){return this._autoLoad},set:function(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}},{key:"disableLocalization",get:function(){return this._disableLocalization},set:function(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se),pc="msdf",xx="bitmap",OL=/[\w|/]/,kL=function(){function o(i){this._symbols=i,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}var a=o.prototype;return a.read=function(){for(var i=this._read();i===8;)i=this._read();return i!==0&&i!==1&&(this._last=this._index),i},a.buf=function(){return this._buf},a.last=function(){return this._last},a.error=function(){return this._error},a.debugPrint=function(){for(var i=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],t=this.read(),e="";e+=(e.length>0?`
`:"")+i[t]+" '"+this.buf().join("")+"'",t!==0&&t!==1;)t=this.read();return e},a._read=function(){return this._buf=[],this._eof()?0:this._mode==="text"?this._text():this._tag()},a._text=function(){for(;;)switch(this._cur){case null:return 2*(this._buf.length>0);case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":this._next(),this._cur==="["?this._store():this._output("\\");break;default:this._store()}},a._tag=function(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"	":case`
`:case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}},a._whitespace=function(){for(this._store();` 	
\r\v\f`.indexOf(this._cur)!==-1;)this._store();return 8},a._string=function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}},a._identifier=function(){for(this._store();this._cur!==null&&this._isIdentifierSymbol(this._cur);)this._store();return 7},a._isIdentifierSymbol=function(i){return i.length===1&&i.match(OL)!==null},a._eof=function(){return this._cur===null},a._next=function(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},a._store=function(){return this._buf.push(this._cur),this._next()},a._output=function(i){this._buf.push(i)},o}(),NL=function(){function o(i){this._scanner=new kL(i),this._error=null}var a=o.prototype;return a.parse=function(i,t){for(;;)switch(this._scanner.read()){case 0:return!0;case 1:default:return!1;case 2:Array.prototype.push.apply(i,this._scanner.buf());break;case 3:if(!this._parseTag(i,t))return!1}},a.error=function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},a._parseTag=function(i,t){var e=this._scanner.read();if(e!==7)return this._error="expected identifier",!1;var n=this._scanner.buf().join("");if(n[0]==="/"){for(var r=t.length-1;r>=0;--r)if(n==="/"+t[r].name&&t[r].end===null)return t[r].end=i.length,(e=this._scanner.read())!==4?(this._error="expected close bracket",!1):!0;return this._error="failed to find matching tag",!1}var s={name:n,value:null,attributes:{},start:i.length,end:null};if((e=this._scanner.read())===5){if((e=this._scanner.read())!==6)return this._error="expected string",!1;s.value=this._scanner.buf().join(""),e=this._scanner.read()}for(;;){switch(e){case 4:return t.push(s),!0;case 7:var l=this._scanner.buf().join("");if((e=this._scanner.read())!==5)return this._error="expected equals",!1;if((e=this._scanner.read())!==6)return this._error="expected string",!1;var u=this._scanner.buf().join("");s.attributes[l]=u;break;default:return this._error="expected close bracket or identifier",!1}e=this._scanner.read()}},o}(),FL=function(){function o(){}return o.evaluate=function(a){var i=new NL(a),t=[],e=[];if(!i.parse(t,e)||e.find(function(r){return r.end===null}))return{symbols:a,tags:null};var n=function(r,s){if(r.length===0)return null;for(var l={},u=0;u<r.length;++u){var c=r[u];l.hasOwnProperty(c.start)?l[c.start].open===null?l[c.start].open=[c]:l[c.start].open.push(c):l[c.start]={open:[c],close:null},l.hasOwnProperty(c.end)?l[c.end].close===null?l[c.end].close=[c]:l[c.end].close.push(c):l[c.end]={open:null,close:[c]}}for(var h=[],f=Object.keys(l).sort(function(S,T){return S-T}),d=[],p=0;p<f.length;++p){var _=l[f[p]];_.close!==null&&function(S){h=h.filter(function(T){return S.find(function(b){return b===T})===void 0})}(_.close),_.open!==null&&function(S){for(var T=0;T<S.length;++T)h.push(S[T])}(_.open),d.push({start:f[p],tags:function(S){if(S.length===0)return null;for(var T={},b=0;b<S.length;++b){var w=S[b],A={};A[w.name]={value:w.value,attributes:w.attributes},function C(L,I){for(var P in I)if(I.hasOwnProperty(P)){var M,R=I[P];((M=Object)!=null&&typeof Symbol<"u"&&M[Symbol.hasInstance]?M[Symbol.hasInstance](R):Q(R,M))?(L.hasOwnProperty(P)||(L[P]={}),C(L[P],I[P])):L[P]=R}}(T,A)}return T}(h)})}for(var g=[],y=null,v=0;v<d.length;++v){for(var x=d[v];g.length<x.start;)g.push(y?y.tags:null);y=x}for(;g.length<s;)g.push(null);return g}(e,t.length);return{symbols:t,tags:n}},o}();function Ln(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var UL=function(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null},bx=/^[\r\n]$/,BL=/^[ \t]$/,Tx=/^[ \t\-]|\u200b$/,VL=/^[a-z0-9]$/i,Ex=/^[\u1100-\u11ff]|[\u3000-\u9fff\ua960-\ua97f]|[\uac00-\ud7ff]$/,zL=/^[]$/,GL=["","","","","","","","","","","","",""],HL={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},wx=new B,WL=new G,ke=new B,Ax=function(){function o(t){this._element=t,this._system=t.system,this._entity=t.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new Sx(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new B(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new G(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new pe,this._model=new cr,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new Se,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new B(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new B(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new G(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),t.on("resize",this._onParentResize,this),t.on("set:screen",this._onScreenChange,this),t.on("screen:set:screenspace",this._onScreenSpaceChange,this),t.on("set:draworder",this._onDrawOrderChange,this),t.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on($r.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}var a,i=o.prototype;return i.destroy=function(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off($r.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},i._onParentResize=function(t,e){!this._noResize&&this._font&&this._updateText()},i._onScreenChange=function(t){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)},i._onScreenSpaceChange=function(t){this._updateMaterial(t)},i._onDrawOrderChange=function(t){if(this._drawOrder=t,this._model)for(var e=0,n=this._model.meshInstances.length;e<n;e++)this._model.meshInstances[e].drawOrder=t},i._onPivotChange=function(t){this._font&&this._updateText()},i._onLocaleSet=function(t){if(this._i18nKey){if(this.fontAsset){var e=this._system.app.assets.get(this.fontAsset);e&&e.resource&&e.resource===this._font||(this.font=null)}this._resetLocalizedText()}},i._onLocalizationData=function(t,e){this._i18nKey&&e[this._i18nKey]&&this._resetLocalizedText()},i._resetLocalizedText=function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},i._setText=function(t){if(this.unicodeConverter){var e=this._system.getUnicodeConverter();e&&(t=e(t))}this._text!==t&&(this._font&&this._updateText(t),this._text=t)},i._updateText=function(t){if(t===void 0&&(t=this._text),this._symbols=er.getSymbols(t.normalize?t.normalize("NFC"):t),this._symbols.length===0&&(this._symbols=[" "]),this._enableMarkup){var e,n=FL.evaluate(this._symbols);this._symbols=n.symbols,e=n.tags||[]}if(this._rtlReorder){var r=this._system.app.systems.element.getRtlReorder();if(r){var s=r(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map(function(te){return this._symbols[te]},this),e&&(e=s.mapping.map(function(te){return e[te]}))}}else this._rtl=!1;var l=function(te,ae){return te.toString(!0).toLowerCase()+":"+ae.toFixed(2)},u=function(te,ae){return te.toString(!0).toLowerCase()+":"+ae.x.toFixed(2)+":"+ae.y.toFixed(2)};if(e){var c={},h={},f={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._outlinePalette=[Math.round(255*this._outlineColor.r),Math.round(255*this._outlineColor.g),Math.round(255*this._outlineColor.b),Math.round(255*this._outlineColor.a),Math.round(255*this._outlineThickness)],this._shadowPalette=[Math.round(255*this._shadowColor.r),Math.round(255*this._shadowColor.g),Math.round(255*this._shadowColor.b),Math.round(255*this._shadowColor.a),Math.round(127*this._shadowOffset.x),Math.round(127*this._shadowOffset.y)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],c[this._color.toString(!1).toLowerCase()]=0,h[l(this._outlineColor,this._outlineThickness)]=0,f[u(this._shadowColor,this._shadowOffset)]=0;for(var d=0,p=this._symbols.length;d<p;++d){var _=e[d],g=0;if(_&&_.color&&_.color.value){var y=_.color.value;if(y.length===7&&y[0]==="#"){var v=y.substring(1).toLowerCase();c.hasOwnProperty(v)?g=c[v]:/^[0-9a-f]{6}$/.test(v)&&(g=this._colorPalette.length/3,c[v]=g,this._colorPalette.push(parseInt(v.substring(0,2),16)),this._colorPalette.push(parseInt(v.substring(2,4),16)),this._colorPalette.push(parseInt(v.substring(4,6),16)))}}this._symbolColors.push(g);var x=0;if(_&&_.outline&&(_.outline.attributes.color||_.outline.attributes.thickness)){var S=_.outline.attributes.color?wx.fromString(_.outline.attributes.color):this._outlineColor,T=Number(_.outline.attributes.thickness);(Number.isNaN(S.r)||Number.isNaN(S.g)||Number.isNaN(S.b)||Number.isNaN(S.a))&&(S=this._outlineColor),Number.isNaN(T)&&(T=this._outlineThickness);var b=l(S,T);h.hasOwnProperty(b)?x=h[b]:(x=this._outlinePalette.length/5,h[b]=x,this._outlinePalette.push(Math.round(255*S.r),Math.round(255*S.g),Math.round(255*S.b),Math.round(255*S.a),Math.round(255*T)))}this._symbolOutlineParams.push(x);var w=0;if(_&&_.shadow&&(_.shadow.attributes.color||_.shadow.attributes.offset||_.shadow.attributes.offsetX||_.shadow.attributes.offsetY)){var A=_.shadow.attributes.color?wx.fromString(_.shadow.attributes.color):this._shadowColor,C=Number(_.shadow.attributes.offset),L=Number(_.shadow.attributes.offsetX),I=Number(_.shadow.attributes.offsetY);(Number.isNaN(A.r)||Number.isNaN(A.g)||Number.isNaN(A.b)||Number.isNaN(A.a))&&(A=this._shadowColor);var P=WL.set(Number.isNaN(L)?Number.isNaN(C)?this._shadowOffset.x:C:L,Number.isNaN(I)?Number.isNaN(C)?this._shadowOffset.y:C:I),M=u(A,P);f.hasOwnProperty(M)?w=f[M]:(w=this._shadowPalette.length/6,f[M]=w,this._shadowPalette.push(Math.round(255*A.r),Math.round(255*A.g),Math.round(255*A.b),Math.round(255*A.a),Math.round(127*P.x),Math.round(127*P.y)))}this._symbolShadowParams.push(w)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();for(var R=this._calculateCharsPerTexture(),k=!1,D=this._element,O=D._isScreenSpace(),F=D._isScreenCulled(),N=function(te){return D.isVisibleForCamera(te)},j=0,z=this._meshInfo.length;j<z;j++){var V=R[j]||0,H=this._meshInfo[j];if(H.count!==V){if(k||(D.removeModelFromLayers(this._model),k=!0),H.count=V,H.positions.length=H.normals.length=3*V*4,H.indices.length=3*V*2,H.uvs.length=2*V*4,H.colors.length=4*V*4,H.outlines.length=4*V*3,H.shadows.length=4*V*3,H.meshInstance&&this._removeMeshInstance(H.meshInstance),V===0){H.meshInstance=null;continue}for(var Y=0;Y<V;Y++)H.indices[3*Y*2+0]=4*Y,H.indices[3*Y*2+1]=4*Y+1,H.indices[3*Y*2+2]=4*Y+3,H.indices[3*Y*2+3]=4*Y+2,H.indices[3*Y*2+4]=4*Y+3,H.indices[3*Y*2+5]=4*Y+1,H.normals[4*Y*3+0]=0,H.normals[4*Y*3+1]=0,H.normals[4*Y*3+2]=-1,H.normals[4*Y*3+3]=0,H.normals[4*Y*3+4]=0,H.normals[4*Y*3+5]=-1,H.normals[4*Y*3+6]=0,H.normals[4*Y*3+7]=0,H.normals[4*Y*3+8]=-1,H.normals[4*Y*3+9]=0,H.normals[4*Y*3+10]=0,H.normals[4*Y*3+11]=-1;var W=new De(function(te,ae){var _e=new ye(te);return _e.setPositions(ae.positions),_e.setNormals(ae.normals),_e.setColors32(ae.colors),_e.setUvs(0,ae.uvs),_e.setIndices(ae.indices),_e.setVertexStream(Ds,ae.outlines,3,void 0,6,!1),_e.setVertexStream(Ms,ae.shadows,3,void 0,6,!1),_e.update(),_e}(this._system.app.graphicsDevice,H),this._material,this._node);if(W.name="Text Element: "+this._entity.name,W.castShadow=!1,W.receiveShadow=!1,W.cull=!O,W.screenSpace=O,W.drawOrder=this._drawOrder,F&&(W.cull=!0,W.isVisibleFunc=N),this._setTextureParams(W,this._font.textures[j]),W.setParameter("material_emissive",this._colorUniform),W.setParameter("material_opacity",this._color.a),W.setParameter("font_sdfIntensity",this._font.intensity),W.setParameter("font_pxrange",this._getPxRange(this._font)),W.setParameter("font_textureWidth",this._font.data.info.maps[j].width),W.setParameter("outline_color",this._outlineColorUniform),W.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),W.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{var ie=-this._font.data.info.maps[j].width/this._font.data.info.maps[j].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=ie*this._shadowOffsetScale*this._shadowOffset.y}W.setParameter("shadow_offset",this._shadowOffsetUniform),H.meshInstance=W,this._model.meshInstances.push(W)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),k&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()},i._removeMeshInstance=function(t){t.destroy();var e=this._model.meshInstances.indexOf(t);e!==-1&&this._model.meshInstances.splice(e,1)},i._setMaterial=function(t){if(this._material=t,this._model)for(var e=0,n=this._model.meshInstances.length;e<n;e++)this._model.meshInstances[e].material=t},i._updateMaterial=function(t){var e=this._element,n=e._isScreenCulled(),r=function(h){return e.isVisibleForCamera(h)},s=this._font&&this._font.type===pc;if(this._material=this._system.getTextElementMaterial(t,s,this._enableMarkup),this._model)for(var l=0,u=this._model.meshInstances.length;l<u;l++){var c=this._model.meshInstances[l];c.cull=!t,c.material=this._material,c.screenSpace=t,n?(c.cull=!0,c.isVisibleFunc=r):c.isVisibleFunc=null}},i._updateMaterialEmissive=function(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(ke.linear(this._color),this._colorUniform[0]=ke.r,this._colorUniform[1]=ke.g,this._colorUniform[2]=ke.b)},i._updateMaterialOutline=function(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(ke.linear(this._outlineColor),this._outlineColorUniform[0]=ke.r,this._outlineColorUniform[1]=ke.g,this._outlineColorUniform[2]=ke.b,this._outlineColorUniform[3]=ke.a)},i._updateMaterialShadow=function(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(ke.linear(this._shadowColor),this._shadowColorUniform[0]=ke.r,this._shadowColorUniform[1]=ke.g,this._shadowColorUniform[2]=ke.b,this._shadowColorUniform[3]=ke.a)},i._isWordBoundary=function(t){return Tx.test(t)},i._isValidNextChar=function(t){return t!==null&&!zL.test(t)},i._isNextCJKBoundary=function(t,e){return Ex.test(t)&&(Tx.test(e)||VL.test(e))},i._isNextCJKWholeWord=function(t){return Ex.test(t)},i._updateMeshes=function(){var t,e,n,r,s=this._font.data,l=this,u=Math.min(this._minFontSize,this._maxFontSize),c=this._maxFontSize,h=this._shouldAutoFit();h&&(this._fontSize=this._maxFontSize);var f=this._symbols.length,d=0,p=0,_=0,g=0,y=1,v=0,x=0,S=0,T=0,b=0,w=0,A=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4,C=this._element.calculatedWidth;(!this.autoWidth||A)&&this._wrapLines||(C=Number.POSITIVE_INFINITY);var L=0,I=0;function P(I3,kl,L3){l._lineWidths.push(Math.abs(L3));var D3=S>kl?kl+1:S,M3=S>kl?S+1:kl,Sh=I3.slice(D3,M3);if(w)for(var Pm=Sh.length;Pm--&&w>0;)bx.test(Sh[Pm])&&(Sh.splice(Pm,1),w--);l._lineContents.push(Sh.join("")),d=0,p-=l._scaledLineHeight,y++,T=0,b=0,w=0,v=0,S=kl}for(var M=!0;M;){M=!1,h?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],d=0,p=0,_=0,g=0,y=1,v=0,x=0,S=0,T=0,b=0,w=0;var R=this._fontSize/32;L=this._fontMinY*R,I=this._fontMaxY*R;for(var k=0;k<this._meshInfo.length;k++)this._meshInfo[k].quad=0,this._meshInfo[k].lines={};for(var D=255,O=255,F=255,N=65535,j=65535,z=0,V=65535,H=65535,Y=32639,W=0;W<f;W++){if(t=this._symbols[W],r=W+1>=f?null:this._symbols[W+1],bx.test(t)){w++,(!this._wrapLines||this._maxLines<0||y<this._maxLines)&&(P(this._symbols,W,g),x=W+1,S=W+1);continue}var ie=0,te=0,ae=0,_e=1,xe=void 0;if(!(e=s.chars[t]))if(GL.indexOf(t)!==-1)e=HL;else if(s.chars[" "])e=s.chars[" "];else for(var je in s.chars){e=s.chars[je];break}if(e){var Qe=0;if(b>0){var rt=this._font.data.kerning;if(rt){var Pe=rt[er.getCodePoint(this._symbols[W-1])||0];Pe&&(Qe=Pe[er.getCodePoint(this._symbols[W])||0]||0)}}xe=e.scale||1,_e=R*((e.width+e.height)/2)/xe,ae=(e.xadvance+Qe)*R,ie=(e.xoffset-Qe)*R,te=e.yoffset*R}var wt=BL.test(t),tt=e&&e.map||0,At=-this._font.data.info.maps[tt].width/this._font.data.info.maps[tt].height,K=this._meshInfo[tt],dt=d+this._spacing*ae;if(dt>C&&b>0&&!wt&&(this._maxLines<0||y<this._maxLines))if(T===0)x=W,P(this._symbols,W,g);else{var ri=Math.max(W-x,0);if(this._meshInfo.length<=1)K.lines[y-1]-=ri,K.quad-=ri;else for(var Nn=x,Fn=W,Re=Nn;Re<Fn;Re++){var Dt=this._symbols[Re],Mt=s.chars[Dt],si=this._meshInfo[Mt&&Mt.map||0];si.lines[y-1]-=1,si.quad-=1}W-=ri+1,P(this._symbols,x,v);continue}n=K.quad,K.lines[y-1]=n;var Ki=d-ie,Es=Ki+_e,ai=p-te,Ml=ai+_e;if(this._rtl){var Rl=_e-ie-this._spacing*ae-ie;Ki-=Rl,Es-=Rl}K.positions[4*n*3+0]=Ki,K.positions[4*n*3+1]=ai,K.positions[4*n*3+2]=_,K.positions[4*n*3+3]=Es,K.positions[4*n*3+4]=ai,K.positions[4*n*3+5]=_,K.positions[4*n*3+6]=Es,K.positions[4*n*3+7]=Ml,K.positions[4*n*3+8]=_,K.positions[4*n*3+9]=Ki,K.positions[4*n*3+10]=Ml,K.positions[4*n*3+11]=_,this.width=Math.max(this.width,dt);var ws=void 0;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(ws=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(ws=U.clamp(ws,u,c))!==this._element.fontSize)||(this.height=Math.max(this.height,I-(p+L)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(ws=U.clamp(this._fontSize-1,u,c))!==this._element.fontSize)){this._fontSize=ws,M=!0;break}d+=this._spacing*ae,wt||(g=d),(this._isWordBoundary(t)||this._isValidNextChar(r)&&(this._isNextCJKBoundary(t,r)||this._isNextCJKWholeWord(r)))&&(T++,v=g,x=W+1),b++;var Un=this._getUv(t);if(K.uvs[4*n*2+0]=Un[0],K.uvs[4*n*2+1]=1-Un[1],K.uvs[4*n*2+2]=Un[2],K.uvs[4*n*2+3]=1-Un[1],K.uvs[4*n*2+4]=Un[2],K.uvs[4*n*2+5]=1-Un[3],K.uvs[4*n*2+6]=Un[0],K.uvs[4*n*2+7]=1-Un[3],this._symbolColors){var Ar=3*this._symbolColors[W];D=this._colorPalette[Ar],O=this._colorPalette[Ar+1],F=this._colorPalette[Ar+2]}if(K.colors[4*n*4+0]=D,K.colors[4*n*4+1]=O,K.colors[4*n*4+2]=F,K.colors[4*n*4+3]=255,K.colors[4*n*4+4]=D,K.colors[4*n*4+5]=O,K.colors[4*n*4+6]=F,K.colors[4*n*4+7]=255,K.colors[4*n*4+8]=D,K.colors[4*n*4+9]=O,K.colors[4*n*4+10]=F,K.colors[4*n*4+11]=255,K.colors[4*n*4+12]=D,K.colors[4*n*4+13]=O,K.colors[4*n*4+14]=F,K.colors[4*n*4+15]=255,this._symbolOutlineParams){var oi=5*this._symbolOutlineParams[W];N=this._outlinePalette[oi]+256*this._outlinePalette[oi+1],j=this._outlinePalette[oi+2]+256*this._outlinePalette[oi+3],z=this._outlinePalette[oi+4]}if(K.outlines[4*n*3+0]=N,K.outlines[4*n*3+1]=j,K.outlines[4*n*3+2]=z,K.outlines[4*n*3+3]=N,K.outlines[4*n*3+4]=j,K.outlines[4*n*3+5]=z,K.outlines[4*n*3+6]=N,K.outlines[4*n*3+7]=j,K.outlines[4*n*3+8]=z,K.outlines[4*n*3+9]=N,K.outlines[4*n*3+10]=j,K.outlines[4*n*3+11]=z,this._symbolShadowParams){var an=6*this._symbolShadowParams[W];V=this._shadowPalette[an]+256*this._shadowPalette[an+1],H=this._shadowPalette[an+2]+256*this._shadowPalette[an+3],Y=this._shadowPalette[an+4]+127+256*Math.round(At*this._shadowPalette[an+5]+127)}K.shadows[4*n*3+0]=V,K.shadows[4*n*3+1]=H,K.shadows[4*n*3+2]=Y,K.shadows[4*n*3+3]=V,K.shadows[4*n*3+4]=H,K.shadows[4*n*3+5]=Y,K.shadows[4*n*3+6]=V,K.shadows[4*n*3+7]=H,K.shadows[4*n*3+8]=Y,K.shadows[4*n*3+9]=V,K.shadows[4*n*3+10]=H,K.shadows[4*n*3+11]=Y,K.quad++}!M&&S<f&&P(this._symbols,f,d)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;for(var mh=this._element.pivot.x,_h=this._element.pivot.y,wm=this._alignment.x,vh=this._alignment.y,le=0;le<this._meshInfo.length;le++)if(this._meshInfo[le].count!==0){var Cr=0;for(var IC in this._meshInfo[le].lines){for(var Am=this._meshInfo[le].lines[IC],E3=this._lineWidths[parseInt(IC,10)],Ol=-mh*this._element.calculatedWidth+wm*(this._element.calculatedWidth-E3)*(this._rtl?-1:1),gh=(1-_h)*this._element.calculatedHeight-I-(1-vh)*(this._element.calculatedHeight-this.height),li=Cr;li<=Am;li++)this._meshInfo[le].positions[4*li*3]+=Ol,this._meshInfo[le].positions[4*li*3+3]+=Ol,this._meshInfo[le].positions[4*li*3+6]+=Ol,this._meshInfo[le].positions[4*li*3+9]+=Ol,this._meshInfo[le].positions[4*li*3+1]+=gh,this._meshInfo[le].positions[4*li*3+4]+=gh,this._meshInfo[le].positions[4*li*3+7]+=gh,this._meshInfo[le].positions[4*li*3+10]+=gh;if(this._rtl)for(var Cm=Cr;Cm<=Am;Cm++){for(var ui=4*Cm*3,yh=0;yh<4;++yh)this._meshInfo[le].positions[ui+3*yh]=this._element.calculatedWidth-this._meshInfo[le].positions[ui+3*yh]+2*Ol;var w3=this._meshInfo[le].positions[ui+3],A3=this._meshInfo[le].positions[ui+6];this._meshInfo[le].positions[ui+3]=this._meshInfo[le].positions[ui+0],this._meshInfo[le].positions[ui+6]=this._meshInfo[le].positions[ui+9],this._meshInfo[le].positions[ui+0]=w3,this._meshInfo[le].positions[ui+9]=A3}Cr=Am+1}for(var C3=4*this._meshInfo[le].count,P3=4*this._meshInfo[le].quad,yn=new js(this._meshInfo[le].meshInstance.mesh.vertexBuffer),pt=0;pt<C3;pt++)pt>=P3?(yn.element[oe].set(0,0,0),yn.element[mt].set(0,0),yn.element[st].set(0,0,0,0),yn.element[Ds].set(0,0,0,0),yn.element[Ms].set(0,0,0,0)):(yn.element[oe].set(this._meshInfo[le].positions[3*pt+0],this._meshInfo[le].positions[3*pt+1],this._meshInfo[le].positions[3*pt+2]),yn.element[mt].set(this._meshInfo[le].uvs[2*pt+0],this._meshInfo[le].uvs[2*pt+1]),yn.element[st].set(this._meshInfo[le].colors[4*pt+0],this._meshInfo[le].colors[4*pt+1],this._meshInfo[le].colors[4*pt+2],this._meshInfo[le].colors[4*pt+3]),yn.element[Ds].set(this._meshInfo[le].outlines[3*pt+0],this._meshInfo[le].outlines[3*pt+1],this._meshInfo[le].outlines[3*pt+2]),yn.element[Ms].set(this._meshInfo[le].shadows[3*pt+0],this._meshInfo[le].shadows[3*pt+1],this._meshInfo[le].shadows[3*pt+2])),yn.next();yn.end(),this._meshInfo[le].meshInstance.mesh.aabb.compute(this._meshInfo[le].positions),this._meshInfo[le].meshInstance._aabbVer=-1}this._aabbDirty=!0},i._onFontRender=function(){this.font=this._font},i._onFontLoad=function(t){this.font!==t.resource&&(this.font=t.resource)},i._onFontChange=function(t,e,n,r){if(e==="data"){this._font.data=n;for(var s=this._font.data.info.maps.length,l=0;l<s;l++)if(this._meshInfo[l]){var u=this._meshInfo[l].meshInstance;u&&(u.setParameter("font_sdfIntensity",this._font.intensity),u.setParameter("font_pxrange",this._getPxRange(this._font)),u.setParameter("font_textureWidth",this._font.data.info.maps[l].width))}}},i._onFontRemove=function(t){},i._setTextureParams=function(t,e){this._font&&(this._font.type===pc?(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap"),t.setParameter("texture_msdfMap",e)):this._font.type===xx&&(t.deleteParameter("texture_msdfMap"),t.setParameter("texture_emissiveMap",e),t.setParameter("texture_opacityMap",e)))},i._getPxRange=function(t){for(var e=Object.keys(this._font.data.chars),n=0;n<e.length;n++){var r=this._font.data.chars[e[n]];if(r.range)return(r.scale||1)*r.range}return 2},i._getUv=function(t){var e=this._font.data;if(!e.chars[t])return e.chars[" "]?this._getUv(" "):[0,0,0,0];var n=e.chars[t].map,r=e.info.maps[n].width,s=e.info.maps[n].height,l=e.chars[t].x,u=e.chars[t].y,c=l+e.chars[t].width,h=u-e.chars[t].height,f=1-e.chars[t].height/s;return[l/r,f-u/s,c/r,f-h/s]},i.onEnable=function(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)},i.onDisable=function(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)},i._setStencil=function(t){if(this._model)for(var e=this._model.meshInstances,n=0;n<e.length;n++)e[n].stencilFront=t,e[n].stencilBack=t},i._shouldAutoFitWidth=function(){return this._autoFitWidth&&!this._autoWidth},i._shouldAutoFitHeight=function(){return this._autoFitHeight&&!this._autoHeight},i._shouldAutoFit=function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},i._calculateCharsPerTexture=function(t){var e={};t===void 0&&(t=this._symbols.length);for(var n=0,r=t;n<r;n++){var s=this._symbols[n],l=this._font.data.chars[s];!l&&((l=this._font.data.chars[" "])||(l=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));var u=l.map;e[u]?e[u]++:e[u]=1}return e},i._updateRenderRange=function(){for(var t=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart),e=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd),n=0,r=this._meshInfo.length;n<r;n++){var s=t[n]||0,l=e[n]||0,u=this._meshInfo[n].meshInstance;if(u){var c=u.mesh;c&&(c.primitive[0].base=3*s*2,c.primitive[0].count=(l-s)*6)}}},a=[{key:"text",get:function(){return this._text},set:function(t){this._i18nKey=null;var e=t!=null&&t.toString()||"";this._setText(e)}},{key:"key",get:function(){return this._i18nKey},set:function(t){var e=t!==null?t.toString():null;this._i18nKey!==e&&(this._i18nKey=e,e?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}},{key:"color",get:function(){return this._color},set:function(t){var e=t.r,n=t.g,r=t.b;if((this._color.r!==e||this._color.g!==n||this._color.b!==r)&&(this._color.r=e,this._color.g=n,this._color.b=r,this._model)){if(this._symbolColors)this._font&&this._updateText();else{ke.linear(this._color),this._colorUniform[0]=ke.r,this._colorUniform[1]=ke.g,this._colorUniform[2]=ke.b;for(var s=0,l=this._model.meshInstances.length;s<l;s++)this._model.meshInstances[s].setParameter("material_emissive",this._colorUniform)}this._element&&this._element.fire("set:color",this._color)}}},{key:"opacity",get:function(){return this._color.a},set:function(t){if(this._color.a!==t&&(this._color.a=t,this._model))for(var e=0,n=this._model.meshInstances.length;e<n;e++)this._model.meshInstances[e].setParameter("material_opacity",t);this._element&&this._element.fire("set:opacity",t)}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){var e=this._lineHeight;this._lineHeight=t,this._scaledLineHeight=t,e!==t&&this._font&&this._updateText()}},{key:"wrapLines",get:function(){return this._wrapLines},set:function(t){var e=this._wrapLines;this._wrapLines=t,e!==t&&this._font&&this._updateText()}},{key:"lines",get:function(){return this._lineContents}},{key:"spacing",get:function(){return this._spacing},set:function(t){var e=this._spacing;this._spacing=t,e!==t&&this._font&&this._updateText()}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){var e=this._fontSize;this._fontSize=t,this._originalFontSize=t,e!==t&&this._font&&this._updateText()}},{key:"fontAsset",get:function(){return this._fontAsset.localizedAsset},set:function(t){this._fontAsset.defaultAsset=t}},{key:"font",get:function(){return this._font},set:function(t){if(this._font&&(e=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=t,this._fontMinY=0,this._fontMaxY=0,t){var e,n=this._font.data;for(var r in n.chars){var s=n.chars[r];s.bounds&&(this._fontMinY=Math.min(this._fontMinY,s.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,s.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),t.type!==e){var l=this._element._isScreenSpace();this._updateMaterial(l)}for(var u=0,c=this._font.textures.length;u<c;u++)if(this._meshInfo[u]){var h=this._meshInfo[u].meshInstance;h&&(h.setParameter("font_sdfIntensity",this._font.intensity),h.setParameter("font_pxrange",this._getPxRange(this._font)),h.setParameter("font_textureWidth",this._font.data.info.maps[u].width),this._setTextureParams(h,this._font.textures[u]))}else this._meshInfo[u]=new UL;for(var f=!1,d=this._font.textures.length;d<this._meshInfo.length;d++)this._meshInfo[d].meshInstance&&(f||(this._element.removeModelFromLayers(this._model),f=!0),this._removeMeshInstance(this._meshInfo[d].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}}},{key:"alignment",get:function(){return this._alignment},set:function(t){Ln(t,G)?this._alignment.set(t.x,t.y):this._alignment.set(t[0],t[1]),this._font&&this._updateText()}},{key:"autoWidth",get:function(){return this._autoWidth},set:function(t){var e=this._autoWidth;if(this._autoWidth=t,t&&1e-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width),e!==t){var n=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;n!==this._fontSize&&(this._fontSize=n,this._font&&this._updateText())}}},{key:"autoHeight",get:function(){return this._autoHeight},set:function(t){var e=this._autoHeight;if(this._autoHeight=t,t&&1e-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height),e!==t){var n=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;n!==this._fontSize&&(this._fontSize=n,this._font&&this._updateText())}}},{key:"rtlReorder",get:function(){return this._rtlReorder},set:function(t){this._rtlReorder!==t&&(this._rtlReorder=t,this._font&&this._updateText())}},{key:"unicodeConverter",get:function(){return this._unicodeConverter},set:function(t){this._unicodeConverter!==t&&(this._unicodeConverter=t,this._setText(this._text))}},{key:"aabb",get:function(){if(this._aabbDirty){for(var t=!1,e=0;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t?this._aabb.add(this._meshInfo[e].meshInstance.aabb):(this._aabb.copy(this._meshInfo[e].meshInstance.aabb),t=!0));this._aabbDirty=!1}return this._aabb}},{key:"outlineColor",get:function(){return this._outlineColor},set:function(t){var e=Ln(t,B)?t.r:t[0],n=Ln(t,B)?t.g:t[1],r=Ln(t,B)?t.b:t[2],s=Ln(t,B)?t.a:t[3];if((this._outlineColor.r!==e||this._outlineColor.g!==n||this._outlineColor.b!==r||this._outlineColor.a!==s)&&(this._outlineColor.r=e,this._outlineColor.g=n,this._outlineColor.b=r,this._outlineColor.a=s,this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{ke.linear(this._outlineColor),this._outlineColorUniform[0]=ke.r,this._outlineColorUniform[1]=ke.g,this._outlineColorUniform[2]=ke.b,this._outlineColorUniform[3]=ke.a;for(var l=0,u=this._model.meshInstances.length;l<u;l++)this._model.meshInstances[l].setParameter("outline_color",this._outlineColorUniform)}this._element&&this._element.fire("set:outline",this._color)}}},{key:"outlineThickness",get:function(){return this._outlineThickness},set:function(t){var e=this._outlineThickness;if(this._outlineThickness=t,e!==t&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(var n=0,r=this._model.meshInstances.length;n<r;n++)this._model.meshInstances[n].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){var e=Ln(t,B)?t.r:t[0],n=Ln(t,B)?t.g:t[1],r=Ln(t,B)?t.b:t[2],s=Ln(t,B)?t.a:t[3];if((this._shadowColor.r!==e||this._shadowColor.g!==n||this._shadowColor.b!==r||this._shadowColor.a!==s)&&(this._shadowColor.r=e,this._shadowColor.g=n,this._shadowColor.b=r,this._shadowColor.a=s,this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{ke.linear(this._shadowColor),this._shadowColorUniform[0]=ke.r,this._shadowColorUniform[1]=ke.g,this._shadowColorUniform[2]=ke.b,this._shadowColorUniform[3]=ke.a;for(var l=0,u=this._model.meshInstances.length;l<u;l++)this._model.meshInstances[l].setParameter("shadow_color",this._shadowColorUniform)}}},{key:"shadowOffset",get:function(){return this._shadowOffset},set:function(t){var e=Ln(t,G)?t.x:t[0],n=Ln(t,G)?t.y:t[1];if((this._shadowOffset.x!==e||this._shadowOffset.y!==n)&&(this._shadowOffset.set(e,n),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(var r=0,s=this._model.meshInstances.length;r<s;r++){var l=-this._font.data.info.maps[r].width/this._font.data.info.maps[r].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=l*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[r].setParameter("shadow_offset",this._shadowOffsetUniform)}}},{key:"minFontSize",get:function(){return this._minFontSize},set:function(t){this._minFontSize!==t&&(this._minFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"maxFontSize",get:function(){return this._maxFontSize},set:function(t){this._maxFontSize!==t&&(this._maxFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"autoFitWidth",get:function(){return this._autoFitWidth},set:function(t){this._autoFitWidth!==t&&(this._autoFitWidth=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"autoFitHeight",get:function(){return this._autoFitHeight},set:function(t){this._autoFitHeight!==t&&(this._autoFitHeight=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"maxLines",get:function(){return this._maxLines},set:function(t){this._maxLines!==t&&(t!==null||this._maxLines!==-1)&&(this._maxLines=t===null?-1:t,this.font&&this._wrapLines&&this._updateText())}},{key:"enableMarkup",get:function(){return this._enableMarkup},set:function(t){if(t=!!t,this._enableMarkup!==t){this._enableMarkup=t,this.font&&this._updateText();var e=this._element._isScreenSpace();this._updateMaterial(e)}}},{key:"symbols",get:function(){return this._symbols}},{key:"symbolColors",get:function(){return this._symbolColors===null?null:this._symbolColors.map(function(t){return this._colorPalette.slice(3*t,3*t+3)},this)}},{key:"symbolOutlineParams",get:function(){return this._symbolOutlineParams===null?null:this._symbolOutlineParams.map(function(t){return this._outlinePalette.slice(5*t,5*t+5)},this)}},{key:"symbolShadowParams",get:function(){return this._symbolShadowParams===null?null:this._symbolShadowParams.map(function(t){return this._shadowPalette.slice(6*t,6*t+6)},this)}},{key:"rtl",get:function(){return this._rtl}},{key:"rangeStart",get:function(){return this._rangeStart},set:function(t){(t=Math.max(0,Math.min(t,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=t,this._updateRenderRange())}},{key:"rangeEnd",get:function(){return this._rangeEnd},set:function(t){(t=Math.max(this._rangeStart,Math.min(t,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=t,this._updateRenderRange())}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function mc(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Cx(o,a){return(Cx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Jd=new E,Px=new X,ei=new E,rs=new E,gn=new X,_c=new X,vc=new X,xa=new X,_t=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._beingInitialized=!1,r._anchor=new q,r._localAnchor=new q,r._pivot=new G,r._width=r._calculatedWidth=32,r._height=r._calculatedHeight=32,r._margin=new q(0,0,-32,-32),r._modelTransform=new X,r._screenToWorld=new X,r._anchorTransform=new X,r._anchorDirty=!0,r._parentWorldTransform=new X,r._screenTransform=new X,r._screenCorners=[new E,new E,new E,new E],r._canvasCorners=[new G,new G,new G,new G],r._worldCorners=[new E,new E,new E,new E],r._cornersDirty=!0,r._canvasCornersDirty=!0,r._worldCornersDirty=!0,r.entity.on("insert",r._onInsert,r),r._patch(),r.screen=null,r._type=ll,r._image=null,r._text=null,r._group=null,r._drawOrder=0,r._fitMode=ul,r._useInput=!1,r._layers=[4],r._addedModels=[],r._batchGroupId=-1,r._offsetReadAt=0,r._maskOffset=.5,r._maskedBy=null,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Cx(a,o);var i,t=a.prototype;return t._setValue=function(e,n){this._text?(this._text[e]!==n&&this._dirtyBatch(),this._text[e]=n):this._image&&(this._image[e]!==n&&this._dirtyBatch(),this._image[e]=n)},t._patch=function(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition},t._unpatch=function(){this.entity._sync=ve.prototype._sync,this.entity.setPosition=ve.prototype.setPosition,this.entity.setLocalPosition=ve.prototype.setLocalPosition},t._setPosition=function(e,n,r){if(!this.element.screen)return void ve.prototype.setPosition.call(this,e,n,r);mc(e,E)?Jd.copy(e):Jd.set(e,n,r),this.getWorldTransform(),Px.copy(this.element._screenToWorld).invert(),Px.transformPoint(Jd,this.localPosition),this._dirtyLocal||this._dirtifyLocal()},t._setLocalPosition=function(e,n,r){mc(e,E)?this.localPosition.copy(e):this.localPosition.set(e,n,r);var s=this.element,l=this.localPosition,u=s._pivot;s._margin.x=l.x-s._calculatedWidth*u.x,s._margin.z=s._localAnchor.z-s._localAnchor.x-s._calculatedWidth-s._margin.x,s._margin.y=l.y-s._calculatedHeight*u.y,s._margin.w=s._localAnchor.w-s._localAnchor.y-s._calculatedHeight-s._margin.y,this._dirtyLocal||this._dirtifyLocal()},t._sync=function(){var e=this.element,n=e.screen;if(n){if(e._anchorDirty){var r=0,s=0,l=0,u=1;if(this._parent&&this._parent.element)r=this._parent.element.calculatedWidth,s=this._parent.element.calculatedHeight,l=this._parent.element.pivot.x,u=this._parent.element.pivot.y;else{var c=n.screen.resolution;r=c.x/n.screen.scale,s=c.y/n.screen.scale}e._anchorTransform.setTranslate(r*(e.anchor.x-l),-(s*(u-e.anchor.y)),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);var h=this.localPosition,f=e._pivot;e._margin.x=h.x-e._calculatedWidth*f.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=h.y-e._calculatedHeight*f.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!n){this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),ve.prototype._sync.call(this);return}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),n){e._screenToWorld.mul2(n.screen._screenMatrix,e._screenToWorld),n.screen.screenSpace||e._screenToWorld.mul2(n.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);var d=e._parentWorldTransform;d.setIdentity();var p=this._parent;p&&p.element&&p!==n&&(gn.setTRS(E.ZERO,p.getLocalRotation(),p.getLocalScale()),d.mul2(p.element._parentWorldTransform,gn)),ei.set(0,0,this.localPosition.z),rs.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),gn.setTranslate(-rs.x,-rs.y,-rs.z),_c.setTRS(ei,this.getLocalRotation(),this.getLocalScale()),vc.setTranslate(rs.x,rs.y,rs.z),e._screenTransform.mul2(e._parentWorldTransform,vc).mul(_c).mul(gn),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}},t._onInsert=function(e){var n=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(n.screen),this._dirtifyMask()},t._dirtifyMask=function(){for(var e=this.entity;e;){var n=e.parent;if((n===null||n.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var r=this.system._prerender.indexOf(this.entity);r>=0&&this.system._prerender.splice(r,1),0>this.system._prerender.indexOf(e)&&this.system._prerender.push(e)}e=n}},t._onPrerender=function(){for(var e=0;e<this.system._prerender.length;e++){var n=this.system._prerender[e];n.element&&n.element.syncMask(1)}this.system._prerender.length=0},t._bindScreen=function(e){e._bindElement(this)},t._unbindScreen=function(e){e._unbindElement(this)},t._updateScreen=function(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);var n=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,n),this._anchorDirty=!0;for(var r=this.entity.children,s=0,l=r.length;s<l;s++)r[s].element&&r[s].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()},t.syncMask=function(e){var n=this._parseUpToScreen();this._updateMask(n.mask,e)},t._setMaskedBy=function(e){var n=this._image||this._text;if(e){var r=e.element._image._maskRef;n==null||n._setStencil(new Xt({ref:r,func:2})),this._maskedBy=e}else n==null||n._setStencil(null),this._maskedBy=null},t._updateMask=function(e,n){if(e){if(this._setMaskedBy(e),this.mask){var r,s=new Xt({ref:e.element._image._maskRef,func:2,zpass:3});this._image._setStencil(s),this._image._maskRef=n,n++,e=this.entity}for(var l=this.entity.children,u=0,c=l.length;u<c;u++)(r=l[u].element)==null||r._updateMask(e,n);this.mask&&n--}else{if(this._setMaskedBy(null),this.mask){var h,f=new Xt({ref:n,func:7,zpass:2});this._image._setStencil(f),this._image._maskRef=n,n++,e=this.entity}for(var d=this.entity.children,p=0,_=d.length;p<_;p++)(h=d[p].element)==null||h._updateMask(e,n);this.mask&&n--}},t._parseUpToScreen=function(){for(var e={screen:null,mask:null},n=this.entity._parent;n&&!n.screen;)n.element&&n.element.mask&&!e.mask&&(e.mask=n),n=n.parent;return n&&n.screen&&(e.screen=n),e},t._onScreenResize=function(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)},t._onScreenSpaceChange=function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},t._onScreenRemove=function(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))},t._calculateLocalAnchors=function(){var e=1e3,n=1e3,r=this.entity._parent;if(r&&r.element)e=r.element.calculatedWidth,n=r.element.calculatedHeight;else if(this.screen){var s=this.screen.screen.resolution,l=this.screen.screen.scale;e=s.x/l,n=s.y/l}this._localAnchor.set(this._anchor.x*e,this._anchor.y*n,this._anchor.z*e,this._anchor.w*n)},t.getOffsetPosition=function(e,n){var r=this.entity.getLocalPosition().clone();return r.x+=e,r.y+=n,this._screenToWorld.transformPoint(r,r),r},t.onLayersChanged=function(e,n){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))},t.onLayerRemoved=function(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))},t.onEnable=function(){var e,n=this.system.app.scene,r=n.layers;this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this._evtLayersChanged=n.on("set:layers",this.onLayersChanged,this),r&&(this._evtLayerAdded=r.on("add",this.onLayerAdded,this),this._evtLayerRemoved=r.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&((e=this.system.app.batcher)==null||e.insert(qe.ELEMENT,this.batchGroupId,this.entity)),this.fire("enableelement")},t.onDisable=function(){var e,n,r,s,l=this.system.app.scene.layers;(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,l&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&((s=this.system.app.batcher)==null||s.remove(qe.ELEMENT,this.batchGroupId,this.entity)),this.fire("disableelement")},t.onRemove=function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()},t._calculateSize=function(e,n){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var r=this._absRight-this._absLeft,s=this._absTop-this._absBottom;e?this._setWidth(r):this._setCalculatedWidth(r,!1),n?this._setHeight(s):this._setCalculatedHeight(s,!1);var l=this.entity.getLocalPosition();l.x=this._margin.x+this._calculatedWidth*this._pivot.x,l.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(l),this._sizeDirty=!1}},t._setWidth=function(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)},t._setHeight=function(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)},t._setCalculatedWidth=function(e,n){if(!(1e-4>=Math.abs(e-this._calculatedWidth))){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),n){var r=this.entity.getLocalPosition(),s=this._pivot;this._margin.x=r.x-this._calculatedWidth*s.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},t._setCalculatedHeight=function(e,n){if(!(1e-4>=Math.abs(e-this._calculatedHeight))){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),n){var r=this.entity.getLocalPosition(),s=this._pivot;this._margin.y=r.y-this._calculatedHeight*s.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},t._flagChildrenAsDirty=function(){for(var e=this.entity._children,n=0,r=e.length;n<r;n++)e[n].element&&(e[n].element._anchorDirty=!0,e[n].element._sizeDirty=!0)},t.addModelToLayers=function(e){this._addedModels.push(e);for(var n=0;n<this.layers.length;n++){var r=this.system.app.scene.layers.getLayerById(this.layers[n]);r&&r.addMeshInstances(e.meshInstances)}},t.removeModelFromLayers=function(e){var n=this._addedModels.indexOf(e);n>=0&&this._addedModels.splice(n,1);for(var r=0;r<this.layers.length;r++){var s=this.system.app.scene.layers.getLayerById(this.layers[r]);s&&s.removeMeshInstances(e.meshInstances)}},t.getMaskOffset=function(){var e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);var n=this._maskOffset;return this._maskOffset-=.001,n},t.isVisibleForCamera=function(e){if(this.maskedBy){var n,r,s,l,u=this.maskedBy.element.screenCorners;n=Math.min(Math.min(u[0].x,u[1].x),Math.min(u[2].x,u[3].x)),r=Math.max(Math.max(u[0].x,u[1].x),Math.max(u[2].x,u[3].x)),l=Math.min(Math.min(u[0].y,u[1].y),Math.min(u[2].y,u[3].y)),s=Math.max(Math.max(u[0].y,u[1].y),Math.max(u[2].y,u[3].y))}else{var c=this.system.app.graphicsDevice.width,h=this.system.app.graphicsDevice.height,f=e._rect.z*c,d=e._rect.w*h;r=(n=e._rect.x*c)+f,l=(s=(1-e._rect.y)*h)-d}var p=this.screenCorners,_=Math.min(Math.min(p[0].x,p[1].x),Math.min(p[2].x,p[3].x)),g=Math.max(Math.max(p[0].x,p[1].x),Math.max(p[2].x,p[3].x)),y=Math.min(Math.min(p[0].y,p[1].y),Math.min(p[2].y,p[3].y)),v=Math.max(Math.max(p[0].y,p[1].y),Math.max(p[2].y,p[3].y));return!(g<n)&&!(_>r)&&!(y>s)&&!(v<l)},t._isScreenSpace=function(){return!!this.screen&&!!this.screen.screen&&this.screen.screen.screenSpace},t._isScreenCulled=function(){return!!this.screen&&!!this.screen.screen&&this.screen.screen.cull},t._dirtyBatch=function(){if(this.batchGroupId!==-1){var e;(e=this.system.app.batcher)==null||e.markGroupDirty(this.batchGroupId)}},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){var n=this.data,r=n.enabled;n.enabled=e,this.fire("set","enabled",r,e)}},{key:"_absLeft",get:function(){return this._localAnchor.x+this._margin.x}},{key:"_absRight",get:function(){return this._localAnchor.z-this._margin.z}},{key:"_absTop",get:function(){return this._localAnchor.w-this._margin.w}},{key:"_absBottom",get:function(){return this._localAnchor.y+this._margin.y}},{key:"_hasSplitAnchorsX",get:function(){return Math.abs(this._anchor.x-this._anchor.z)>.001}},{key:"_hasSplitAnchorsY",get:function(){return Math.abs(this._anchor.y-this._anchor.w)>.001}},{key:"aabb",get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}},{key:"anchor",get:function(){return this._anchor},set:function(e){if(mc(e,q))this._anchor.copy(e);else{var n;(n=this._anchor).set.apply(n,[].concat(e))}this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){var n,r;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&((n=this.system.app.batcher)==null||n.remove(qe.ELEMENT,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&((r=this.system.app.batcher)==null||r.insert(qe.ELEMENT,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e)}},{key:"bottom",get:function(){return this._margin.y},set:function(e){this._margin.y=e;var n=this.entity.getLocalPosition(),r=this._absTop,s=this._localAnchor.y+e;this._setHeight(r-s),n.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n)}},{key:"calculatedWidth",get:function(){return this._calculatedWidth},set:function(e){this._setCalculatedWidth(e,!0)}},{key:"calculatedHeight",get:function(){return this._calculatedHeight},set:function(e){this._setCalculatedHeight(e,!0)}},{key:"canvasCorners",get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var e=this.system.app.graphicsDevice,n=this.screenCorners,r=e.canvas.clientWidth/e.width,s=e.canvas.clientHeight/e.height,l=0;l<4;l++)this._canvasCorners[l].set(n[l].x*r,(e.height-n[l].y)*s);return this._canvasCornersDirty=!1,this._canvasCorners}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){var n=0;this.screen&&(n=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(n<<24)+e,this.fire("set:draworder",this._drawOrder)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}},{key:"layers",get:function(){return this._layers},set:function(e){if(this._addedModels.length)for(var n=0;n<this._layers.length;n++){var r=this.system.app.scene.layers.getLayerById(this._layers[n]);if(r)for(var s=0;s<this._addedModels.length;s++)r.removeMeshInstances(this._addedModels[s].meshInstances)}if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(var l=0;l<this._layers.length;l++){var u=this.system.app.scene.layers.getLayerById(this._layers[l]);if(u)for(var c=0;c<this._addedModels.length;c++)u.addMeshInstances(this._addedModels[c].meshInstances)}}},{key:"left",get:function(){return this._margin.x},set:function(e){this._margin.x=e;var n=this.entity.getLocalPosition(),r=this._absRight,s=this._localAnchor.x+e;this._setWidth(r-s),n.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(n)}},{key:"margin",get:function(){return this._margin},set:function(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}},{key:"maskedBy",get:function(){return this._maskedBy}},{key:"pivot",get:function(){return this._pivot},set:function(e){var n=this.pivot,r=this.margin,s=n.x,l=n.y;mc(e,G)?n.copy(e):n.set.apply(n,[].concat(e));var u=r.x+r.z,c=n.x-s;r.x+=u*c,r.z-=u*c;var h=r.y+r.w,f=n.y-l;r.y+=h*f,r.w-=h*f,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",n)}},{key:"right",get:function(){return this._margin.z},set:function(e){this._margin.z=e;var n=this.entity.getLocalPosition(),r=this._absLeft,s=this._localAnchor.z-e;this._setWidth(s-r),n.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(n)}},{key:"screenCorners",get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var n=this.screen.screen.screenSpace,r=0;r<4;r++)this._screenTransform.transformPoint(this._screenCorners[r],this._screenCorners[r]),n&&this._screenCorners[r].mulScalar(this.screen.screen.scale),e&&this._screenCorners[r].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}},{key:"textWidth",get:function(){return this._text?this._text.width:0}},{key:"textHeight",get:function(){return this._text?this._text.height:0}},{key:"top",get:function(){return this._margin.w},set:function(e){this._margin.w=e;var n=this.entity.getLocalPosition(),r=this._absBottom,s=this._localAnchor.w-e;this._setHeight(s-r),n.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(n)}},{key:"type",get:function(){return this._type},set:function(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===hc?this._image=new vx(this):e===Qd&&(this._text=new Ax(this)))}},{key:"useInput",get:function(){return this._useInput},set:function(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}},{key:"fitMode",get:function(){return this._fitMode},set:function(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}},{key:"worldCorners",get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var e=this.screenCorners;if(!this.screen.screen.screenSpace){gn.copy(this.screen.screen._screenMatrix),gn.data[13]=-gn.data[13],gn.mul2(this.screen.getWorldTransform(),gn);for(var n=0;n<4;n++)gn.transformPoint(e[n],this._worldCorners[n])}}else{var r=this.entity.getLocalPosition();gn.setTranslate(-r.x,-r.y,-r.z),_c.setTRS(E.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),vc.setTranslate(r.x,r.y,r.z);var s=this.entity.parent?this.entity.parent:this.entity;xa.copy(s.getWorldTransform()),xa.mul(vc).mul(_c).mul(gn),ei.set(r.x-this.pivot.x*this.calculatedWidth,r.y-this.pivot.y*this.calculatedHeight,r.z),xa.transformPoint(ei,this._worldCorners[0]),ei.set(r.x+(1-this.pivot.x)*this.calculatedWidth,r.y-this.pivot.y*this.calculatedHeight,r.z),xa.transformPoint(ei,this._worldCorners[1]),ei.set(r.x+(1-this.pivot.x)*this.calculatedWidth,r.y+(1-this.pivot.y)*this.calculatedHeight,r.z),xa.transformPoint(ei,this._worldCorners[2]),ei.set(r.x-this.pivot.x*this.calculatedWidth,r.y+(1-this.pivot.y)*this.calculatedHeight,r.z),xa.transformPoint(ei,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}},{key:"fontSize",get:function(){return this._text?this._text.fontSize:null},set:function(e){this._setValue("fontSize",e)}},{key:"minFontSize",get:function(){return this._text?this._text.minFontSize:null},set:function(e){this._setValue("minFontSize",e)}},{key:"maxFontSize",get:function(){return this._text?this._text.maxFontSize:null},set:function(e){this._setValue("maxFontSize",e)}},{key:"maxLines",get:function(){return this._text?this._text.maxLines:null},set:function(e){this._setValue("maxLines",e)}},{key:"autoFitWidth",get:function(){return this._text?this._text.autoFitWidth:null},set:function(e){this._setValue("autoFitWidth",e)}},{key:"autoFitHeight",get:function(){return this._text?this._text.autoFitHeight:null},set:function(e){this._setValue("autoFitHeight",e)}},{key:"color",get:function(){return this._text?this._text.color:this._image?this._image.color:null},set:function(e){this._setValue("color",e)}},{key:"font",get:function(){return this._text?this._text.font:null},set:function(e){this._setValue("font",e)}},{key:"fontAsset",get:function(){return this._text&&typeof this._text.fontAsset=="number"?this._text.fontAsset:null},set:function(e){this._setValue("fontAsset",e)}},{key:"spacing",get:function(){return this._text?this._text.spacing:null},set:function(e){this._setValue("spacing",e)}},{key:"lineHeight",get:function(){return this._text?this._text.lineHeight:null},set:function(e){this._setValue("lineHeight",e)}},{key:"wrapLines",get:function(){return this._text?this._text.wrapLines:null},set:function(e){this._setValue("wrapLines",e)}},{key:"lines",get:function(){return this._text?this._text.lines:null},set:function(e){this._setValue("lines",e)}},{key:"alignment",get:function(){return this._text?this._text.alignment:null},set:function(e){this._setValue("alignment",e)}},{key:"autoWidth",get:function(){return this._text?this._text.autoWidth:null},set:function(e){this._setValue("autoWidth",e)}},{key:"autoHeight",get:function(){return this._text?this._text.autoHeight:null},set:function(e){this._setValue("autoHeight",e)}},{key:"rtlReorder",get:function(){return this._text?this._text.rtlReorder:null},set:function(e){this._setValue("rtlReorder",e)}},{key:"unicodeConverter",get:function(){return this._text?this._text.unicodeConverter:null},set:function(e){this._setValue("unicodeConverter",e)}},{key:"text",get:function(){return this._text?this._text.text:null},set:function(e){this._setValue("text",e)}},{key:"key",get:function(){return this._text?this._text.key:null},set:function(e){this._setValue("key",e)}},{key:"texture",get:function(){return this._image?this._image.texture:null},set:function(e){this._setValue("texture",e)}},{key:"textureAsset",get:function(){return this._image?this._image.textureAsset:null},set:function(e){this._setValue("textureAsset",e)}},{key:"material",get:function(){return this._image?this._image.material:null},set:function(e){this._setValue("material",e)}},{key:"materialAsset",get:function(){return this._image?this._image.materialAsset:null},set:function(e){this._setValue("materialAsset",e)}},{key:"sprite",get:function(){return this._image?this._image.sprite:null},set:function(e){this._setValue("sprite",e)}},{key:"spriteAsset",get:function(){return this._image?this._image.spriteAsset:null},set:function(e){this._setValue("spriteAsset",e)}},{key:"spriteFrame",get:function(){return this._image?this._image.spriteFrame:null},set:function(e){this._setValue("spriteFrame",e)}},{key:"pixelsPerUnit",get:function(){return this._image?this._image.pixelsPerUnit:null},set:function(e){this._setValue("pixelsPerUnit",e)}},{key:"opacity",get:function(){return this._text?this._text.opacity:this._image?this._image.opacity:null},set:function(e){this._setValue("opacity",e)}},{key:"rect",get:function(){return this._image?this._image.rect:null},set:function(e){this._setValue("rect",e)}},{key:"mask",get:function(){return this._image?this._image.mask:null},set:function(e){this._setValue("mask",e)}},{key:"outlineColor",get:function(){return this._text?this._text.outlineColor:null},set:function(e){this._setValue("outlineColor",e)}},{key:"outlineThickness",get:function(){return this._text?this._text.outlineThickness:null},set:function(e){this._setValue("outlineThickness",e)}},{key:"shadowColor",get:function(){return this._text?this._text.shadowColor:null},set:function(e){this._setValue("shadowColor",e)}},{key:"shadowOffset",get:function(){return this._text?this._text.shadowOffset:null},set:function(e){this._setValue("shadowOffset",e)}},{key:"enableMarkup",get:function(){return this._text?this._text.enableMarkup:null},set:function(e){this._setValue("enableMarkup",e)}},{key:"rangeStart",get:function(){return this._text?this._text.rangeStart:null},set:function(e){this._setValue("rangeStart",e)}},{key:"rangeEnd",get:function(){return this._text?this._text.rangeEnd:null},set:function(e){this._setValue("rangeEnd",e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);_t.EVENT_MOUSEDOWN="mousedown",_t.EVENT_MOUSEUP="mouseup",_t.EVENT_MOUSEENTER="mouseenter",_t.EVENT_MOUSELEAVE="mouseleave",_t.EVENT_MOUSEMOVE="mousemove",_t.EVENT_MOUSEWHEEL="mousewheel",_t.EVENT_CLICK="click",_t.EVENT_TOUCHSTART="touchstart",_t.EVENT_TOUCHEND="touchend",_t.EVENT_TOUCHMOVE="touchmove",_t.EVENT_TOUCHCANCEL="touchcancel";var jL=function(){this.enabled=!0};function ml(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Ix(o,a){return(Ix=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var XL=["enabled"],Lx=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){(e=o.call(this,t)||this).id="element",e.ComponentType=_t,e.DataType=jL,e.schema=XL,e._unicodeConverter=null,e._rtlReorder=null,e._defaultTexture=new ee(t.graphicsDevice,{width:1,height:1,format:20,name:"element-system"});var e,n=e._defaultTexture.lock(),r=new Uint8Array(4);return r[0]=255,r[1]=255,r[2]=255,r[3]=255,n.set(r),e._defaultTexture.unlock(),e.defaultImageMaterial=null,e.defaultImage9SlicedMaterial=null,e.defaultImage9TiledMaterial=null,e.defaultImageMaskMaterial=null,e.defaultImage9SlicedMaskMaterial=null,e.defaultImage9TiledMaskMaterial=null,e.defaultScreenSpaceImageMaterial=null,e.defaultScreenSpaceImage9SlicedMaterial=null,e.defaultScreenSpaceImage9TiledMaterial=null,e.defaultScreenSpaceImageMask9SlicedMaterial=null,e.defaultScreenSpaceImageMask9TiledMaterial=null,e.defaultScreenSpaceImageMaskMaterial=null,e._defaultTextMaterials={},e.defaultImageMaterials=[],e.on("add",e.onAddComponent,e),e.on("beforeremove",e.onRemoveComponent,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ix(a,o);var i=a.prototype;return i.destroy=function(){o.prototype.destroy.call(this),this._defaultTexture.destroy()},i.initializeComponentData=function(t,e,n){t._beingInitialized=!0,e.anchor!==void 0&&(ml(e.anchor,q)?t.anchor.copy(e.anchor):t.anchor.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),e.pivot!==void 0&&(ml(e.pivot,G)?t.pivot.copy(e.pivot):t.pivot.set(e.pivot[0],e.pivot[1]));var r,s=Math.abs(t.anchor.x-t.anchor.z)>.001,l=Math.abs(t.anchor.y-t.anchor.w)>.001,u=!1;e.margin!==void 0&&(ml(e.margin,q)?t.margin.copy(e.margin):t._margin.set(e.margin[0],e.margin[1],e.margin[2],e.margin[3]),u=!0),e.left!==void 0&&(t._margin.x=e.left,u=!0),e.bottom!==void 0&&(t._margin.y=e.bottom,u=!0),e.right!==void 0&&(t._margin.z=e.right,u=!0),e.top!==void 0&&(t._margin.w=e.top,u=!0),u&&(t.margin=t._margin);var c=!1;e.width===void 0||s?s&&(c=!0):t.width=e.width,e.height===void 0||l?l&&(c=!0):t.height=e.height,c&&(t.anchor=t.anchor),e.enabled!==void 0&&(t.enabled=e.enabled),e.useInput!==void 0&&(t.useInput=e.useInput),e.fitMode!==void 0&&(t.fitMode=e.fitMode),t.batchGroupId=e.batchGroupId===void 0||e.batchGroupId===null?-1:e.batchGroupId,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),e.type!==void 0&&(t.type=e.type),t.type===hc?(e.rect!==void 0&&(t.rect=e.rect),e.color!==void 0&&(ml(r=e.color,B)||(r=new B(e.color[0],e.color[1],e.color[2])),t.color=r),e.opacity!==void 0&&(t.opacity=e.opacity),e.textureAsset!==void 0&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),e.spriteAsset!==void 0&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),e.spriteFrame!==void 0&&(t.spriteFrame=e.spriteFrame),e.pixelsPerUnit!==void 0&&e.pixelsPerUnit!==null&&(t.pixelsPerUnit=e.pixelsPerUnit),e.materialAsset!==void 0&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),e.mask!==void 0&&(t.mask=e.mask)):t.type===Qd&&(e.autoWidth!==void 0&&(t.autoWidth=e.autoWidth),e.autoHeight!==void 0&&(t.autoHeight=e.autoHeight),e.rtlReorder!==void 0&&(t.rtlReorder=e.rtlReorder),e.unicodeConverter!==void 0&&(t.unicodeConverter=e.unicodeConverter),e.text!==null&&e.text!==void 0?t.text=e.text:e.key!==null&&e.key!==void 0&&(t.key=e.key),e.color!==void 0&&(ml(r=e.color,B)||(r=new B(r[0],r[1],r[2])),t.color=r),e.opacity!==void 0&&(t.opacity=e.opacity),e.spacing!==void 0&&(t.spacing=e.spacing),e.fontSize!==void 0&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),e.lineHeight!==void 0&&(t.lineHeight=e.lineHeight),e.maxLines!==void 0&&(t.maxLines=e.maxLines),e.wrapLines!==void 0&&(t.wrapLines=e.wrapLines),e.minFontSize!==void 0&&(t.minFontSize=e.minFontSize),e.maxFontSize!==void 0&&(t.maxFontSize=e.maxFontSize),e.autoFitWidth&&(t.autoFitWidth=e.autoFitWidth),e.autoFitHeight&&(t.autoFitHeight=e.autoFitHeight),e.fontAsset!==void 0&&(t.fontAsset=e.fontAsset),e.font!==void 0&&(t.font=e.font),e.alignment!==void 0&&(t.alignment=e.alignment),e.outlineColor!==void 0&&(t.outlineColor=e.outlineColor),e.outlineThickness!==void 0&&(t.outlineThickness=e.outlineThickness),e.shadowColor!==void 0&&(t.shadowColor=e.shadowColor),e.shadowOffset!==void 0&&(t.shadowOffset=e.shadowOffset),e.enableMarkup!==void 0&&(t.enableMarkup=e.enableMarkup));var h=t._parseUpToScreen();h.screen&&t._updateScreen(h.screen),o.prototype.initializeComponentData.call(this,t,e,n),t._beingInitialized=!1,t.type===hc&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)},i.onAddComponent=function(t,e){t.fire("element:add")},i.onRemoveComponent=function(t,e){e.onRemove()},i.cloneComponent=function(t,e){var n=t.element,r={enabled:n.enabled,width:n.width,height:n.height,anchor:n.anchor.clone(),pivot:n.pivot.clone(),margin:n.margin.clone(),alignment:n.alignment&&n.alignment.clone()||n.alignment,autoWidth:n.autoWidth,autoHeight:n.autoHeight,type:n.type,rect:n.rect&&n.rect.clone()||n.rect,rtlReorder:n.rtlReorder,unicodeConverter:n.unicodeConverter,materialAsset:n.materialAsset,material:n.material,color:n.color&&n.color.clone()||n.color,opacity:n.opacity,textureAsset:n.textureAsset,texture:n.texture,spriteAsset:n.spriteAsset,sprite:n.sprite,spriteFrame:n.spriteFrame,pixelsPerUnit:n.pixelsPerUnit,spacing:n.spacing,lineHeight:n.lineHeight,wrapLines:n.wrapLines,layers:n.layers,fontSize:n.fontSize,minFontSize:n.minFontSize,maxFontSize:n.maxFontSize,autoFitWidth:n.autoFitWidth,autoFitHeight:n.autoFitHeight,maxLines:n.maxLines,fontAsset:n.fontAsset,font:n.font,useInput:n.useInput,fitMode:n.fitMode,batchGroupId:n.batchGroupId,mask:n.mask,outlineColor:n.outlineColor&&n.outlineColor.clone()||n.outlineColor,outlineThickness:n.outlineThickness,shadowColor:n.shadowColor&&n.shadowColor.clone()||n.shadowColor,shadowOffset:n.shadowOffset&&n.shadowOffset.clone()||n.shadowOffset,enableMarkup:n.enableMarkup};return n.key!==void 0&&n.key!==null?r.key=n.key:r.text=n.text,this.addComponent(e,r)},i.getTextElementMaterial=function(t,e,n){var r=(t&&1)|(e&&2)|(n&&4),s=this._defaultTextMaterials[r];if(s)return s;var l="TextMaterial";return s=new it,e?(s.msdfMap=this._defaultTexture,s.msdfTextAttribute=n,s.emissive.set(1,1,1)):(l="Bitmap"+l,s.emissive.set(1,1,1),s.emissiveMap=this._defaultTexture,s.opacityMap=this._defaultTexture,s.opacityMapChannel="a"),t&&(l="ScreenSpace"+l,s.depthTest=!1),s.name="default"+l,s.useLighting=!1,s.useTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.diffuse.set(0,0,0),s.opacity=.5,s.blendType=4,s.depthWrite=!1,s.emissiveVertexColor=!0,s.update(),this._defaultTextMaterials[r]=s,s},i._createBaseImageMaterial=function(){var t=new it;return t.diffuse.set(0,0,0),t.emissive.set(1,1,1),t.emissiveMap=this._defaultTexture,t.opacityMap=this._defaultTexture,t.opacityMapChannel="a",t.useLighting=!1,t.useTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=4,t.depthWrite=!1,t},i.getImageElementMaterial=function(t,e,n,r){return t?e?n?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):r?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):n?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):r?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):e?n?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):r?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):n?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):r?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},i.registerUnicodeConverter=function(t){this._unicodeConverter=t},i.registerRtlReorder=function(t){this._rtlReorder=t},i.getUnicodeConverter=function(){return this._unicodeConverter},i.getRtlReorder=function(){return this._rtlReorder},a}(We),ss="free",as="limited",os="locked";function Dx(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Mx(o,a){return(Mx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var YL=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"],gc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._constraint=null,r._entityA=null,r._entityB=null,r._breakForce=34e37,r._enableCollision=!0,r._linearMotionX=os,r._linearLimitsX=new G(0,0),r._linearSpringX=!1,r._linearStiffnessX=0,r._linearDampingX=1,r._linearEquilibriumX=0,r._linearMotionY=os,r._linearLimitsY=new G(0,0),r._linearSpringY=!1,r._linearStiffnessY=0,r._linearDampingY=1,r._linearEquilibriumY=0,r._linearMotionZ=os,r._linearLimitsZ=new G(0,0),r._linearSpringZ=!1,r._linearStiffnessZ=0,r._linearDampingZ=1,r._linearEquilibriumZ=0,r._angularMotionX=os,r._angularLimitsX=new G(0,0),r._angularSpringX=!1,r._angularStiffnessX=0,r._angularDampingX=1,r._angularEquilibriumX=0,r._angularMotionY=os,r._angularLimitsY=new G(0,0),r._angularSpringY=!1,r._angularStiffnessY=0,r._angularDampingY=1,r._angularEquilibriumY=0,r._angularMotionZ=os,r._angularLimitsZ=new G(0,0),r._angularSpringZ=!1,r._angularEquilibriumZ=0,r._angularDampingZ=1,r._angularStiffnessZ=0,r.on("set_enabled",r._onSetEnabled,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Mx(a,o);var i,t=a.prototype;return t._convertTransform=function(e,n){var r=e.getTranslation(),s=new Z;s.setFromMat4(e);var l=new Ammo.btVector3(r.x,r.y,r.z),u=new Ammo.btQuaternion(s.x,s.y,s.z,s.w);n.setOrigin(l),n.setRotation(u),Ammo.destroy(l),Ammo.destroy(u)},t._updateAngularLimits=function(){var e=this._constraint;if(e){this._angularMotionX===as?(n=this._angularLimitsX.x*U.DEG_TO_RAD,l=this._angularLimitsX.y*U.DEG_TO_RAD):this._angularMotionX===ss?(n=1,l=0):n=l=0,this._angularMotionY===as?(r=this._angularLimitsY.x*U.DEG_TO_RAD,u=this._angularLimitsY.y*U.DEG_TO_RAD):this._angularMotionY===ss?(r=1,u=0):r=u=0,this._angularMotionZ===as?(s=this._angularLimitsZ.x*U.DEG_TO_RAD,c=this._angularLimitsZ.y*U.DEG_TO_RAD):this._angularMotionZ===ss?(s=1,c=0):s=c=0;var n,r,s,l,u,c,h=new Ammo.btVector3(n,r,s);e.setAngularLowerLimit(h),h.setValue(l,u,c),e.setAngularUpperLimit(h),Ammo.destroy(h)}},t._updateLinearLimits=function(){var e=this._constraint;if(e){this._linearMotionX===as?(n=this._linearLimitsX.x,l=this._linearLimitsX.y):this._linearMotionX===ss?(n=1,l=0):n=l=0,this._linearMotionY===as?(r=this._linearLimitsY.x,u=this._linearLimitsY.y):this._linearMotionY===ss?(r=1,u=0):r=u=0,this._linearMotionZ===as?(s=this._linearLimitsZ.x,c=this._linearLimitsZ.y):this._linearMotionZ===ss?(s=1,c=0):s=c=0;var n,r,s,l,u,c,h=new Ammo.btVector3(n,r,s);e.setLinearLowerLimit(h),h.setValue(l,u,c),e.setLinearUpperLimit(h),Ammo.destroy(h)}},t._createConstraint=function(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();var e=new X,n=this._entityA.rigidbody.body;n.activate();var r=this.entity.getWorldTransform(),s=this._entityA.getWorldTransform().clone().invert();e.mul2(s,r);var l=new Ammo.btTransform;if(this._convertTransform(e,l),this._entityB&&this._entityB.rigidbody){var u=this._entityB.rigidbody.body;u.activate();var c=this._entityB.getWorldTransform().clone().invert();e.mul2(c,r);var h=new Ammo.btTransform;this._convertTransform(e,h),this._constraint=new Ammo.btGeneric6DofSpringConstraint(n,u,l,h,!this._enableCollision),Ammo.destroy(h)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(n,l,!this._enableCollision);Ammo.destroy(l);for(var f=["X","Y","Z","X","Y","Z"],d=0;d<6;d++){var p=d<3?"_linear":"_angular";this._constraint.enableSpring(d,this[p+"Spring"+f[d]]),this._constraint.setDamping(d,this[p+"Damping"+f[d]]),this._constraint.setEquilibriumPoint(d,this[p+"Equilibrium"+f[d]]),this._constraint.setStiffness(d,this[p+"Stiffness"+f[d]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}},t._destroyConstraint=function(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)},t.initFromData=function(e){for(var n,r=function(u,c){var h=typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(h)return(h=h.call(u)).next.bind(h);if(Array.isArray(u)||(h=function(d,p){if(d){if(typeof d=="string")return Dx(d,void 0);var _=Object.prototype.toString.call(d).slice(8,-1);if(_==="Object"&&d.constructor&&(_=d.constructor.name),_==="Map"||_==="Set")return Array.from(_);if(_==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(_))return Dx(d,void 0)}}(u))){h&&(u=h);var f=0;return function(){return f>=u.length?{done:!0}:{done:!1,value:u[f++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(YL);!(n=r()).done;){var s,l=n.value;e.hasOwnProperty(l)&&(s=e[l],(G!=null&&typeof Symbol<"u"&&G[Symbol.hasInstance]?!!G[Symbol.hasInstance](s):Q(s,G))?this["_"+l].copy(e[l]):this["_"+l]=e[l])}this._createConstraint()},t.onEnable=function(){this._createConstraint()},t.onDisable=function(){this._destroyConstraint()},t._onSetEnabled=function(e,n,r){},t._onBeforeRemove=function(){this.fire("remove")},i=[{key:"entityA",get:function(){return this._entityA},set:function(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}},{key:"entityB",get:function(){return this._entityB},set:function(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}},{key:"breakForce",get:function(){return this._breakForce},set:function(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}},{key:"angularLimitsX",get:function(){return this._angularLimitsX},set:function(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}},{key:"angularMotionX",get:function(){return this._angularMotionX},set:function(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}},{key:"angularLimitsY",get:function(){return this._angularLimitsY},set:function(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}},{key:"angularMotionY",get:function(){return this._angularMotionY},set:function(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}},{key:"angularLimitsZ",get:function(){return this._angularLimitsZ},set:function(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}},{key:"angularMotionZ",get:function(){return this._angularMotionZ},set:function(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}},{key:"linearLimitsX",get:function(){return this._linearLimitsX},set:function(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}},{key:"linearMotionX",get:function(){return this._linearMotionX},set:function(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}},{key:"linearLimitsY",get:function(){return this._linearLimitsY},set:function(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}},{key:"linearMotionY",get:function(){return this._linearMotionY},set:function(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}},{key:"linearLimitsZ",get:function(){return this._linearLimitsZ},set:function(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}},{key:"linearMotionZ",get:function(){return this._linearMotionZ},set:function(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),qL={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(function(o){["Damping","Equilibrium","Spring","Stiffness"].forEach(function(a){["X","Y","Z"].forEach(function(i){var t=o+a+i,e="_"+t,n=3*(o!=="linear");i==="Y"&&(n+=1),i==="Z"&&(n+=2),Object.defineProperty(gc.prototype,t,{get:function(){return this[e]},set:function(r){this[e]!==r&&(this[e]=r,this._constraint[qL[a]](n,r))}})})})});var KL=function(){this.enabled=!0};function Rx(o,a){return(Rx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var $d=["enabled"],Ox=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){var t;return(t=o.call(this,i)||this).id="joint",t.app=i,t.ComponentType=gc,t.DataType=KL,t.schema=$d,t}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Rx(a,o),a.prototype.initializeComponentData=function(i,t,e){i.initFromData(t),o.prototype.initializeComponentData.call(this,i,t,$d)},a}(We);function kx(o,a){return(kx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}de._buildAccessors(gc.prototype,$d);var ep=function(o){var a;if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function i(){var t;return t=o.apply(this,arguments)||this,t._minWidth=0,t._minHeight=0,t._maxWidth=null,t._maxHeight=null,t._fitWidthProportion=0,t._fitHeightProportion=0,t._excludeFromLayout=!1,t}return i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),o&&kx(i,o),a=[{key:"minWidth",get:function(){return this._minWidth},set:function(t){t!==this._minWidth&&(this._minWidth=t,this.fire("resize"))}},{key:"minHeight",get:function(){return this._minHeight},set:function(t){t!==this._minHeight&&(this._minHeight=t,this.fire("resize"))}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){t!==this._maxWidth&&(this._maxWidth=t,this.fire("resize"))}},{key:"maxHeight",get:function(){return this._maxHeight},set:function(t){t!==this._maxHeight&&(this._maxHeight=t,this.fire("resize"))}},{key:"fitWidthProportion",get:function(){return this._fitWidthProportion},set:function(t){t!==this._fitWidthProportion&&(this._fitWidthProportion=t,this.fire("resize"))}},{key:"fitHeightProportion",get:function(){return this._fitHeightProportion},set:function(t){t!==this._fitHeightProportion&&(this._fitHeightProportion=t,this.fire("resize"))}},{key:"excludeFromLayout",get:function(){return this._excludeFromLayout},set:function(t){t!==this._excludeFromLayout&&(this._excludeFromLayout=t,this.fire("resize"))}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(i.prototype,a),i}(de),ZL=function(){this.enabled=!0};function Nx(o,a){return(Nx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Fx=["enabled"],Ux=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="layoutchild",e.ComponentType=ep,e.DataType=ZL,e.schema=Fx,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Nx(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){e.enabled!==void 0&&(t.enabled=e.enabled),e.minWidth!==void 0&&(t.minWidth=e.minWidth),e.minHeight!==void 0&&(t.minHeight=e.minHeight),e.maxWidth!==void 0&&(t.maxWidth=e.maxWidth),e.maxHeight!==void 0&&(t.maxHeight=e.maxHeight),e.fitWidthProportion!==void 0&&(t.fitWidthProportion=e.fitWidthProportion),e.fitHeightProportion!==void 0&&(t.fitHeightProportion=e.fitHeightProportion),e.excludeFromLayout!==void 0&&(t.excludeFromLayout=e.excludeFromLayout),o.prototype.initializeComponentData.call(this,t,e,n)},i.cloneComponent=function(t,e){var n=t.layoutchild;return this.addComponent(e,{enabled:n.enabled,minWidth:n.minWidth,minHeight:n.minHeight,maxWidth:n.maxWidth,maxHeight:n.maxHeight,fitWidthProportion:n.fitWidthProportion,fitHeightProportion:n.fitHeightProportion,excludeFromLayout:n.excludeFromLayout})},a}(We);de._buildAccessors(ep.prototype,Fx);var yc={};yc[0]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},yc[1]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};var tp={};tp[0]=1,tp[1]=0;var QL={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},$t={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},en=new G;function Bx(o){var a,i=yc[o],t=yc[tp[o]];function e(S,T){return-T[t.size]*S.pivot[t.axis]}function n(S){var T=S.entity.layoutchild;return!T||!T.enabled||!T.excludeFromLayout}function r(S,T,b){switch(S){case 0:return $t.NONE;case 1:return T<b?$t.APPLY_STRETCHING:$t.NONE;case 2:return T>=b?$t.APPLY_SHRINKING:$t.NONE;case 3:return T<b?$t.APPLY_STRETCHING:$t.APPLY_SHRINKING;default:throw Error("Unrecognized fitting mode: "+S)}}function s(S,T){return p(S,T.size)+(S.length-1)*a.spacing[T.axis]}function l(S,T,b){for(var w=g(S,b.maxSize),A=_(S,b.fittingProportion),C=x(A,w),L=en[b.axis]-T,I=0;I<S.length;++I){var P=w[I],M=c(P,L,A,C),R=S[P][b.size]+M,k=Math.min(R,S[P][b.maxSize]);S[P][b.size]=k,L-=M-Math.max(R-k,0)}}function u(S,T,b){for(var w=g(S,b.minSize,!0),A=function(D){if(D.length===1)return[1];for(var O=[],F=D.length,N=0;N<F;++N)O.push((1-D[N])/(F-1));return O}(_(S,b.fittingProportion)),C=x(A,w),L=T-en[b.axis],I=0;I<S.length;++I){var P=w[I],M=c(P,L,A,C),R=S[P][b.size]-M,k=Math.max(R,S[P][b.minSize]);S[P][b.size]=k,L-=M-Math.max(k-R,0)}}function c(S,T,b,w){var A=b[S],C=w[S];return 1e-5>Math.abs(A)&&1e-5>Math.abs(C)?T:T*A/C}function h(S){for(var T=[],b=0;b<S.length;++b){var w=S[b],A=Math.max(f(w,"minWidth"),0),C=Math.max(f(w,"minHeight"),0),L=Math.max(f(w,"maxWidth"),A),I=Math.max(f(w,"maxHeight"),C),P=d(f(w,"width"),A,L),M=d(f(w,"height"),C,I),R=f(w,"fitWidthProportion"),k=f(w,"fitHeightProportion");T.push({minWidth:A,minHeight:C,maxWidth:L,maxHeight:I,width:P,height:M,fitWidthProportion:R,fitHeightProportion:k})}return T}function f(S,T){var b=S.entity.layoutchild;return b&&b.enabled&&b[T]!==void 0&&b[T]!==null?b[T]:S[T]!==void 0?S[T]:QL[T]}function d(S,T,b){return Math.min(Math.max(S,T),b)}function p(S,T){return S.reduce(function(b,w){return b+w[T]},0)}function _(S,T){var b=p(S,T),w=[],A=S.length;if(b===0)for(var C=0;C<A;++C)w.push(1/A);else for(var L=0;L<A;++L)w.push(S[L][T]/b);return w}function g(S,T,b){return S.forEach(y),S.slice().sort(function(w,A){return b?A[T]-w[T]:w[T]-A[T]}).map(v)}function y(S,T){S.index=T}function v(S){return S.index}function x(S,T){var b=[];b[T[S.length-1]]=S[T[S.length-1]];for(var w=S.length-2;w>=0;--w)b[T[w]]=b[T[w+1]]+S[T[w]];return b}return function(S,T){S=S.filter(n),en.x=(a=T).containerSize.x-a.padding.x-a.padding.z,en.y=a.containerSize.y-a.padding.y-a.padding.w,function(P){for(var M=0;M<P.length;++M){var R=P[M],k=R.anchor;(k.x!==0||k.y!==0||k.z!==0||k.w!==0)&&(R.anchor=q.ZERO)}}(S);var b,w,A,C=function(P){var M=a.orientation===0&&a.reverseX||a.orientation===1&&a.reverseY,R=a.orientation===0&&a.reverseY||a.orientation===1&&a.reverseX;if(M)for(var k=0;k<P.length;++k)M&&P[k].reverse();return R&&P.reverse(),P}(function(P){if(!a.wrap)return[P];for(var M=[[]],R=h(P),k=0,D=a[i.fitting]===2,O=0;O<P.length;++O){M[M.length-1].length>0&&(k+=a.spacing[i.axis]);var F=R[O][i.size];k+=F,!D&&k>en[i.axis]&&M[M.length-1].length!==0&&(k=F,M.push([])),M[M.length-1].push(P[O]),D&&k>en[i.axis]&&O!==P.length-1&&(k=0,M.push([]))}return M}(S)),L=function(P,M){for(var R=[],k=[],D=0;D<P.length;++D){var O=P[D];O.largestElement=null,O.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(var F=0;F<O.length;++F){var N=M[D][F];N[t.size]>O.largestSize[t.size]&&(O.largestElement=O[F],O.largestSize=N)}R.push(O.largestElement),k.push(O.largestSize)}var j=s(k,t),z=r(a[t.fitting],j,en[t.axis]);z===$t.APPLY_STRETCHING?l(k,j,t):z===$t.APPLY_SHRINKING&&u(k,j,t);for(var V=0;V<P.length;++V)for(var H=P[V],Y=0;Y<H.length;++Y){var W=M[V][Y],ie=W[t.size],te=P.length===1?en[t.axis]:H.largestSize[t.size],ae=r(a[t.fitting],ie,te);ae===$t.APPLY_STRETCHING?W[t.size]=Math.min(te,W[t.maxSize]):ae===$t.APPLY_SHRINKING&&(W[t.size]=Math.max(te,W[t.minSize]))}return M}(C,function(P){for(var M=[],R=0;R<P.length;++R){var k=h(P[R]),D=s(k,i),O=r(a[i.fitting],D,en[i.axis]);O===$t.APPLY_STRETCHING?l(k,D,i):O===$t.APPLY_SHRINKING&&u(k,D,i),M.push(k)}return M}(C)),I=function(P,M){var R={};R[i.axis]=0,R[t.axis]=0,P[i.size]=Number.NEGATIVE_INFINITY;for(var k=[],D=0;D<P.length;++D){var O=P[D];if(O.length===0){k.push([]);continue}for(var F=[],N=M[D],j=0;j<O.length;++j){var z=O[j],V=N[j];R[t.axis]-=e(z,V),R[i.axis]-=-V[i.size]*z.pivot[i.axis],F[j]={},F[j][i.axis]=R[i.axis],F[j][t.axis]=R[t.axis],R[t.axis]+=e(z,V),R[i.axis]+=V[i.size]*(1-z.pivot[i.axis])+a.spacing[i.axis]}O[i.size]=R[i.axis]-a.spacing[i.axis],O[t.size]=O.largestSize[t.size],P[i.size]=Math.max(P[i.size],O[i.size]),R[i.axis]=0,R[t.axis]+=O[t.size]+a.spacing[t.axis],k.push(F)}return P[t.size]=R[t.axis]-a.spacing[t.axis],k}(C,L);return function(P,M,R){for(var k=a.alignment[i.axis],D=a.alignment[t.axis],O=a.padding[i.axis],F=a.padding[t.axis],N=0;N<P.length;++N)for(var j=P[N],z=M[N],V=R[N],H=(en[i.axis]-j[i.size])*k+O,Y=(en[t.axis]-P[t.size])*D+F,W=0;W<j.length;++W){var ie=(j[t.size]-z[W][t.size])*a.alignment[t.axis];V[W][i.axis]+=H,V[W][t.axis]+=Y+ie}}(C,L,I),function(P,M,R){for(var k=0;k<P.length;++k)for(var D=P[k],O=M[k],F=R[k],N=0;N<D.length;++N){var j=D[N];j[i.calculatedSize]=O[N][i.size],j[t.calculatedSize]=O[N][t.size],a.orientation===0?j.entity.setLocalPosition(F[N][i.axis],F[N][t.axis],j.entity.getLocalPosition().z):j.entity.setLocalPosition(F[N][t.axis],F[N][i.axis],j.entity.getLocalPosition().z)}}(C,L,I),w=(b=C).width,A=b.height,{bounds:new q((en.x-w)*a.alignment.x+a.padding.x,(en.y-A)*a.alignment.y+a.padding.y,w,A)}}}var np={};np[0]=Bx(0),np[1]=Bx(1);var Vx=function(){function o(){}return o.prototype.calculateLayout=function(a,i){var t=np[i.orientation];if(t)return t(a,i);throw Error("Unrecognized orientation value: "+i.orientation)},o}();function zx(o,a){return(zx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Gx(o){return o.element}function JL(o){return o.enabled&&o.element&&o.element.enabled}var ip=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._orientation=0,r._reverseX=!1,r._reverseY=!0,r._alignment=new G(0,1),r._padding=new q,r._spacing=new G,r._widthFitting=0,r._heightFitting=0,r._wrap=!1,r._layoutCalculator=new Vx,r._listenForReflowEvents(r.entity,"on"),r.entity.children.forEach(function(s){r._listenForReflowEvents(s,"on")}),r.entity.on("childinsert",r._onChildInsert,r),r.entity.on("childremove",r._onChildRemove,r),e.app.systems.element.on("add",r._onElementOrLayoutComponentAdd,r),e.app.systems.element.on("beforeremove",r._onElementOrLayoutComponentRemove,r),e.app.systems.layoutchild.on("add",r._onElementOrLayoutComponentAdd,r),e.app.systems.layoutchild.on("beforeremove",r._onElementOrLayoutComponentRemove,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&zx(a,o);var i,t=a.prototype;return t._isSelfOrChild=function(e){return e===this.entity||this.entity.children.indexOf(e)!==-1},t._listenForReflowEvents=function(e,n){e.element&&(e.element[n]("enableelement",this._scheduleReflow,this),e.element[n]("disableelement",this._scheduleReflow,this),e.element[n]("resize",this._scheduleReflow,this),e.element[n]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[n]("set_enabled",this._scheduleReflow,this),e.layoutchild[n]("resize",this._scheduleReflow,this))},t._onElementOrLayoutComponentAdd=function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())},t._onElementOrLayoutComponentRemove=function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())},t._onChildInsert=function(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()},t._onChildRemove=function(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()},t._scheduleReflow=function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},t.reflow=function(){var e=Gx(this.entity),n=this.entity.children.filter(JL).map(Gx);if(e&&n.length!==0){var r=Math.max(e.calculatedWidth,0),s=Math.max(e.calculatedHeight,0),l={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new G(r,s)};this._isPerformingReflow=!0;var u=this._layoutCalculator.calculateLayout(n,l);this._isPerformingReflow=!1,this.fire("reflow",u)}},t.onEnable=function(){this._scheduleReflow()},t.onRemove=function(){var e=this;this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(n){e._listenForReflowEvents(n,"off")}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)},i=[{key:"orientation",get:function(){return this._orientation},set:function(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}},{key:"reverseX",get:function(){return this._reverseX},set:function(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}},{key:"reverseY",get:function(){return this._reverseY},set:function(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}},{key:"alignment",get:function(){return this._alignment},set:function(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}},{key:"padding",get:function(){return this._padding},set:function(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}},{key:"spacing",get:function(){return this._spacing},set:function(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}},{key:"widthFitting",get:function(){return this._widthFitting},set:function(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}},{key:"heightFitting",get:function(){return this._heightFitting},set:function(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}},{key:"wrap",get:function(){return this._wrap},set:function(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),$L=function(){this.enabled=!0};function Hx(o,a){return(Hx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Wx=["enabled"],jx=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="layoutgroup",e.ComponentType=ip,e.DataType=$L,e.schema=Wx,e._reflowQueue=[],e.on("beforeremove",e._onRemoveComponent,e),e.app.systems.on("postUpdate",e._onPostUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Hx(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){e.enabled!==void 0&&(t.enabled=e.enabled),e.orientation!==void 0&&(t.orientation=e.orientation),e.reverseX!==void 0&&(t.reverseX=e.reverseX),e.reverseY!==void 0&&(t.reverseY=e.reverseY),e.alignment!==void 0&&(t.alignment=Array.isArray(e.alignment)?new G(e.alignment):e.alignment),e.padding!==void 0&&(t.padding=Array.isArray(e.padding)?new q(e.padding):e.padding),e.spacing!==void 0&&(t.spacing=Array.isArray(e.spacing)?new G(e.spacing):e.spacing),e.widthFitting!==void 0&&(t.widthFitting=e.widthFitting),e.heightFitting!==void 0&&(t.heightFitting=e.heightFitting),e.wrap!==void 0&&(t.wrap=e.wrap),o.prototype.initializeComponentData.call(this,t,e,n)},i.cloneComponent=function(t,e){var n=t.layoutgroup;return this.addComponent(e,{enabled:n.enabled,orientation:n.orientation,reverseX:n.reverseX,reverseY:n.reverseY,alignment:n.alignment,padding:n.padding,spacing:n.spacing,widthFitting:n.widthFitting,heightFitting:n.heightFitting,wrap:n.wrap})},i.scheduleReflow=function(t){this._reflowQueue.indexOf(t)===-1&&this._reflowQueue.push(t)},i._onPostUpdate=function(){this._processReflowQueue()},i._processReflowQueue=function(){if(this._reflowQueue.length!==0)for(var t=0;this._reflowQueue.length>0;){var e=this._reflowQueue.slice();this._reflowQueue.length=0,e.sort(function(r,s){return r.entity.graphDepth-s.entity.graphDepth});for(var n=0;n<e.length;++n)e[n].reflow();if(++t>=100)break}},i._onRemoveComponent=function(t,e){e.onRemove()},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("postUpdate",this._onPostUpdate,this)},a}(We);de._buildAccessors(ip.prototype,Wx);var eD=function(){function o(){this.map=new Map}return o.prototype.destroy=function(a){this.map.forEach(function(i){return i.mesh.destroy()})},o}(),tD=new It,Xx=function(o,a){var i,t,e=tD.get(o,function(){return new eD}),n=e.map.get(a);if(!n){switch(a){case"box":i=ye.fromGeometry(o,new fr),t={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=ye.fromGeometry(o,new wd({radius:.5,height:2})),t={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=ye.fromGeometry(o,new Xo({baseRadius:.5,peakRadius:0,height:1})),t={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=ye.fromGeometry(o,new pa({radius:.5,height:1})),t={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=ye.fromGeometry(o,new Yo({halfExtents:new G(.5,.5),widthSegments:1,lengthSegments:1})),t={x:0,y:1,z:0,uv:1};break;case"sphere":i=ye.fromGeometry(o,new oa({radius:.5})),t={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=ye.fromGeometry(o,new ma({tubeRadius:.2,ringRadius:.3})),t={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw Error("Invalid primitive type: "+a)}i.incRefCount(),n={mesh:i,area:t},e.map.set(a,n)}return n};function Yx(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function qx(o,a){return(qx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Sc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._type="asset",r._asset=null,r._model=null,r._mapping={},r._castShadows=!0,r._receiveShadows=!0,r._materialAsset=null,r._castShadowsLightmap=!0,r._lightmapped=!1,r._lightmapSizeMultiplier=1,r.isStatic=!1,r._layers=[0],r._batchGroupId=-1,r._customAabb=null,r._area=null,r._materialEvents=null,r._clonedModel=!1,r._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._material=e.defaultMaterial,n.on("remove",r.onRemoveChild,r),n.on("removehierarchy",r.onRemoveChild,r),n.on("insert",r.onInsertChild,r),n.on("inserthierarchy",r.onInsertChild,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&qx(a,o);var i,t=a.prototype;return t.addModelToLayers=function(){for(var e=this.system.app.scene.layers,n=0;n<this._layers.length;n++){var r=e.getLayerById(this._layers[n]);r&&r.addMeshInstances(this.meshInstances)}},t.removeModelFromLayers=function(){for(var e=this.system.app.scene.layers,n=0;n<this._layers.length;n++){var r=e.getLayerById(this._layers[n]);r&&r.removeMeshInstances(this.meshInstances)}},t.onRemoveChild=function(){this._model&&this.removeModelFromLayers()},t.onInsertChild=function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},t.onRemove=function(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},t.onLayersChanged=function(e,n){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this.meshInstances)},t.onLayerRemoved=function(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this.meshInstances)},t._setMaterialEvent=function(e,n,r,s){var l=n+":"+r;this.system.app.assets.on(l,s,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][l]={id:r,handler:s}},t._unsetMaterialEvents=function(){var e=this.system.app.assets,n=this._materialEvents;if(n){for(var r=0,s=n.length;r<s;r++)if(n[r]){var l=n[r];for(var u in l)e.off(u,l[u].handler,this)}this._materialEvents=null}},t._getAssetByIdOrPath=function(e){var n=null;if(isNaN(parseInt(e,10))){if(this.asset){var r=this._getMaterialAssetUrl(e);r&&(n=this.system.app.assets.getByUrl(r))}}else n=this.system.app.assets.get(e);return n},t._getMaterialAssetUrl=function(e){if(!this.asset)return null;var n=this.system.app.assets.get(this.asset);return n?n.getAbsoluteUrl(e):null},t._loadAndSetMeshInstanceMaterial=function(e,n,r){var s=this.system.app.assets;e&&(e.resource?(n.material=e.resource,this._setMaterialEvent(r,"remove",e.id,function(){n.material=this.system.defaultMaterial})):(this._setMaterialEvent(r,"load",e.id,function(l){n.material=l.resource,this._setMaterialEvent(r,"remove",e.id,function(){n.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&s.load(e)))},t.onEnable=function(){var e,n,r=this.system.app,s=r.scene,l=s==null?void 0:s.layers;this._evtLayersChanged=s.on("set:layers",this.onLayersChanged,this),l&&(this._evtLayerAdded=l.on("add",this.onLayerAdded,this),this._evtLayerRemoved=l.on("remove",this.onLayerRemoved,this));var u=this._type==="asset";if(this._model?this.addModelToLayers():u&&this._asset&&(e=r.assets.get(this._asset))&&e.resource!==this._model&&this._bindModelAsset(e),this._materialAsset&&(e=r.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),u&&this._mapping)for(var c in this._mapping)this._mapping[c]&&(e=this._getAssetByIdOrPath(this._mapping[c]))&&!e.resource&&r.assets.load(e);this._batchGroupId>=0&&((n=r.batcher)==null||n.insert(qe.MODEL,this.batchGroupId,this.entity))},t.onDisable=function(){var e,n,r,s,l=this.system.app,u=l.scene.layers;(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,u&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&((s=l.batcher)==null||s.remove(qe.MODEL,this.batchGroupId,this.entity)),this._model&&this.removeModelFromLayers()},t.hide=function(){if(this._model)for(var e=this._model.meshInstances,n=0,r=e.length;n<r;n++)e[n].visible=!1},t.show=function(){if(this._model)for(var e=this._model.meshInstances,n=0,r=e.length;n<r;n++)e[n].visible=!0},t._bindMaterialAsset=function(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindMaterialAsset=function(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)},t._onMaterialAssetAdd=function(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},t._onMaterialAssetLoad=function(e){this._setMaterial(e.resource)},t._onMaterialAssetUnload=function(e){this._setMaterial(this.system.defaultMaterial)},t._onMaterialAssetRemove=function(e){this._onMaterialAssetUnload(e)},t._onMaterialAssetChange=function(e){},t._bindModelAsset=function(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindModelAsset=function(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)},t._onModelAssetAdded=function(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)},t._onModelAssetLoad=function(e){this.model=e.resource.clone(),this._clonedModel=!0},t._onModelAssetUnload=function(e){this.model=null},t._onModelAssetChange=function(e,n,r,s){n==="data"&&(this.mapping=this._mapping)},t._onModelAssetRemove=function(e){this.model=null},t._setMaterial=function(e){if(this._material!==e){this._material=e;var n=this._model;if(n&&this._type!=="asset")for(var r=n.meshInstances,s=0,l=r.length;s<l;s++)r[s].material=e}},i=[{key:"meshInstances",get:function(){return this._model?this._model.meshInstances:null},set:function(e){this._model&&(this._model.meshInstances=e)}},{key:"customAabb",get:function(){return this._customAabb},set:function(e){if(this._customAabb=e,this._model){var n=this._model.meshInstances;if(n)for(var r=0;r<n.length;r++)n[r].setCustomAabb(this._customAabb)}}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e)if(this._area=null,this._type=e,e==="asset")this._asset!==null?this._bindModelAsset(this._asset):this.model=null;else{var n=Xx(this.system.app.graphicsDevice,e);this._area=n.area;var r=n.mesh,s=new pe,l=new cr;l.graph=s,l.meshInstances=[new De(r,this._material,s)],this.model=l,this._asset=null}}},{key:"asset",get:function(){return this._asset},set:function(e){var n=this.system.app.assets,r=e;if(Yx(e,$)&&(r=e.id),this._asset!==r){if(this._asset){n.off("add:"+this._asset,this._onModelAssetAdded,this);var s=n.get(this._asset);s&&this._unbindModelAsset(s)}if(this._asset=r,this._asset){var l=n.get(this._asset);l?this._bindModelAsset(l):(this.model=null,n.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}},{key:"model",get:function(){return this._model},set:function(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;for(var n=this._model.meshInstances,r=0;r<n.length;r++)n[r].castShadow=this._castShadows,n[r].receiveShadow=this._receiveShadows,n[r].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),this.type==="asset"?this.mapping=this._mapping:this._unsetMaterialEvents()}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model))for(var n=this._model.meshInstances,r=0;r<n.length;r++)n[r].setLightmapped(e)}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var n=this._model;if(n){var r=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(var l=0;l<r.length;l++){var u=this.system.app.scene.layers.getLayerById(this.layers[l]);u&&u.removeShadowCasters(n.meshInstances)}for(var c=n.meshInstances,h=0;h<c.length;h++)c[h].castShadow=e;if(!this._castShadows&&e)for(var f=0;f<r.length;f++){var d=s.layers.getLayerById(r[f]);d&&d.addShadowCasters(n.meshInstances)}}this._castShadows=e}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model))for(var n=this._model.meshInstances,r=0,s=n.length;r<s;r++)n[r].receiveShadow=e}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e}},{key:"layers",get:function(){return this._layers},set:function(e){var n=this.system.app.scene.layers;if(this.meshInstances)for(var r=0;r<this._layers.length;r++){var s=n.getLayerById(this._layers[r]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(var l=0;l<e.length;l++)this._layers[l]=e[l];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(var u=0;u<this._layers.length;u++){var c=n.getLayerById(this._layers[u]);c&&c.addMeshInstances(this.meshInstances)}}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){var n,r;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&((n=this.system.app.batcher)==null||n.remove(qe.MODEL,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&((r=this.system.app.batcher)==null||r.insert(qe.MODEL,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e)}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(e){var n=e;Yx(e,$)&&(n=e.id);var r=this.system.app.assets;if(n!==this._materialAsset){if(this._materialAsset){r.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var s=r.get(this._materialAsset);s&&this._unbindMaterialAsset(s)}if(this._materialAsset=n,this._materialAsset){var l=r.get(this._materialAsset);l?this._bindMaterialAsset(l):(this._setMaterial(this.system.defaultMaterial),r.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}},{key:"mapping",get:function(){return this._mapping},set:function(e){if(this._type==="asset"&&(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,this._model)){for(var n=this._model.meshInstances,r=this.asset?this.system.app.assets.get(this.asset):null,s=r?r.data.mapping:null,l=null,u=0,c=n.length;u<c;u++)if(e[u]!==void 0)e[u]?(l=this.system.app.assets.get(e[u]),this._loadAndSetMeshInstanceMaterial(l,n[u],u)):n[u].material=this.system.defaultMaterial;else if(s)if(s[u]&&(s[u].material||s[u].path)){if(s[u].material!==void 0)l=this.system.app.assets.get(s[u].material);else if(s[u].path!==void 0){var h=this._getMaterialAssetUrl(s[u].path);h&&(l=this.system.app.assets.getByUrl(h))}this._loadAndSetMeshInstanceMaterial(l,n[u],u)}else n[u].material=this.system.defaultMaterial}}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),nD=function(){this.enabled=!0};function Kx(o,a){return(Kx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Zx=["enabled"],Qx=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="model",e.ComponentType=Sc,e.DataType=nD,e.schema=Zx,e.defaultMaterial=Ks(t.graphicsDevice),e.on("beforeremove",e.onRemove,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Kx(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){n=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(e.batchGroupId===null||e.batchGroupId===void 0)&&(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(var r=0;r<n.length;r++)e.hasOwnProperty(n[r])&&(t[n[r]]=e[n[r]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Se(new E(e.aabbCenter),new E(e.aabbHalfExtents))),o.prototype.initializeComponentData.call(this,t,e,["enabled"])},i.cloneComponent=function(t,e){var n,r={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:Ka({},t.model.mapping)},s=t.model.materialAsset;n=s,($!=null&&typeof Symbol<"u"&&$[Symbol.hasInstance]?$[Symbol.hasInstance](n):Q(n,$))||s==null||(s=this.app.assets.get(s));var l=t.model.material;l&&l!==this.defaultMaterial&&s&&l!==s.resource||(r.materialAsset=s);var u=this.addComponent(e,r);if(t.model.model&&t.model.type==="asset"&&!t.model.asset&&(u.model=t.model.model.clone(),u._clonedModel=!0),r.materialAsset||(u.material=l),t.model.model)for(var c=t.model.model.meshInstances,h=u.model.meshInstances,f=0;f<c.length;f++)h[f].mask=c[f].mask,h[f].material=c[f].material,h[f].layer=c[f].layer,h[f].receiveShadow=c[f].receiveShadow;return t.model.customAabb&&(u.customAabb=t.model.customAabb.clone()),u},i.onRemove=function(t,e){e.onRemove()},a}(We);function _r(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Jx(o,a){return(Jx=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}de._buildAccessors(Sc.prototype,Zx);var iD=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],rD=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],sD=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],xc=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"],$x=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._requestedDepth=!1,r._drawOrder=0,r._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._evtSetMeshes=null,r.on("set_colorMapAsset",r.onSetColorMapAsset,r),r.on("set_normalMapAsset",r.onSetNormalMapAsset,r),r.on("set_meshAsset",r.onSetMeshAsset,r),r.on("set_mesh",r.onSetMesh,r),r.on("set_renderAsset",r.onSetRenderAsset,r),r.on("set_loop",r.onSetLoop,r),r.on("set_blendType",r.onSetBlendType,r),r.on("set_depthSoftening",r.onSetDepthSoftening,r),r.on("set_layers",r.onSetLayers,r),iD.forEach(function(s){r.on("set_"+s,r.onSetSimpleProperty,r)}),rD.forEach(function(s){r.on("set_"+s,r.onSetComplexProperty,r)}),sD.forEach(function(s){r.on("set_"+s,r.onSetGraphProperty,r)}),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Jx(a,o);var i,t=a.prototype;return t._setValue=function(e,n){var r=this.data,s=r[e];r[e]=n,this.fire("set",e,s,n)},t.addMeshInstanceToLayers=function(){if(this.emitter)for(var e=0;e<this.layers.length;e++){var n=this.system.app.scene.layers.getLayerById(this.layers[e]);n&&(n.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=n)}},t.removeMeshInstanceFromLayers=function(){if(this.emitter)for(var e=0;e<this.layers.length;e++){var n=this.system.app.scene.layers.getLayerById(this.layers[e]);n&&n.removeMeshInstances([this.emitter.meshInstance])}},t.onSetLayers=function(e,n,r){if(this.emitter){for(var s=0;s<n.length;s++){var l=this.system.app.scene.layers.getLayerById(n[s]);l&&l.removeMeshInstances([this.emitter.meshInstance])}if(this.enabled&&this.entity.enabled)for(var u=0;u<r.length;u++){var c=this.system.app.scene.layers.getLayerById(r[u]);c&&c.addMeshInstances([this.emitter.meshInstance])}}},t.onLayersChanged=function(e,n){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.emitter&&(0>this.layers.indexOf(e.id)||e.addMeshInstances([this.emitter.meshInstance]))},t.onLayerRemoved=function(e){this.emitter&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this.emitter.meshInstance]))},t._bindColorMapAsset=function(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindColorMapAsset=function(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)},t._onColorMapAssetLoad=function(e){this.colorMap=e.resource},t._onColorMapAssetUnload=function(e){this.colorMap=null},t._onColorMapAssetRemove=function(e){this._onColorMapAssetUnload(e)},t._onColorMapAssetChange=function(e){},t.onSetColorMapAsset=function(e,n,r){var s=this,l=this.system.app.assets;if(n){var u=l.get(n);u&&this._unbindColorMapAsset(u)}if(r){_r(r,$)&&(this.data.colorMapAsset=r.id,r=r.id);var c=l.get(r);c?this._bindColorMapAsset(c):l.once("add:"+r,function(h){s._bindColorMapAsset(h)})}else this.colorMap=null},t._bindNormalMapAsset=function(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindNormalMapAsset=function(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)},t._onNormalMapAssetLoad=function(e){this.normalMap=e.resource},t._onNormalMapAssetUnload=function(e){this.normalMap=null},t._onNormalMapAssetRemove=function(e){this._onNormalMapAssetUnload(e)},t._onNormalMapAssetChange=function(e){},t.onSetNormalMapAsset=function(e,n,r){var s=this,l=this.system.app.assets;if(n){var u=l.get(n);u&&this._unbindNormalMapAsset(u)}if(r){_r(r,$)&&(this.data.normalMapAsset=r.id,r=r.id);var c=l.get(r);c?this._bindNormalMapAsset(c):l.once("add:"+r,function(h){s._bindNormalMapAsset(h)})}else this.normalMap=null},t._bindMeshAsset=function(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindMeshAsset=function(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)},t._onMeshAssetLoad=function(e){this._onMeshChanged(e.resource)},t._onMeshAssetUnload=function(e){this.mesh=null},t._onMeshAssetRemove=function(e){this._onMeshAssetUnload(e)},t._onMeshAssetChange=function(e){},t.onSetMeshAsset=function(e,n,r){var s=this.system.app.assets;if(n){var l=s.get(n);l&&this._unbindMeshAsset(l)}if(r){_r(r,$)&&(this.data.meshAsset=r.id,r=r.id);var u=s.get(r);u&&this._bindMeshAsset(u)}else this._onMeshChanged(null)},t.onSetMesh=function(e,n,r){!r||_r(r,$)||typeof r=="number"?this.meshAsset=r:this._onMeshChanged(r)},t._onMeshChanged=function(e){e&&!_r(e,ye)&&(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())},t.onSetRenderAsset=function(e,n,r){var s=this.system.app.assets;if(n){var l=s.get(n);l&&this._unbindRenderAsset(l)}if(r){_r(r,$)&&(this.data.renderAsset=r.id,r=r.id);var u=s.get(r);u&&this._bindRenderAsset(u)}else this._onRenderChanged(null)},t._bindRenderAsset=function(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindRenderAsset=function(e){var n;e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),(n=this._evtSetMeshes)==null||n.off(),this._evtSetMeshes=null},t._onRenderAssetLoad=function(e){this._onRenderChanged(e.resource)},t._onRenderAssetUnload=function(e){this._onRenderChanged(null)},t._onRenderAssetRemove=function(e){this._onRenderAssetUnload(e)},t._onRenderChanged=function(e){var n;if(!e)return void this._onMeshChanged(null);(n=this._evtSetMeshes)==null||n.off(),this._evtSetMeshes=e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)},t._onRenderSetMeshes=function(e){this._onMeshChanged(e&&e[0])},t.onSetLoop=function(e,n,r){this.emitter&&(this.emitter[e]=r,this.emitter.resetTime())},t.onSetBlendType=function(e,n,r){this.emitter&&(this.emitter[e]=r,this.emitter.material.blendType=r,this.emitter.resetMaterial(),this.rebuild())},t._requestDepth=function(){!this._requestedDepth&&(Ps||(Ps=this.system.app.scene.layers.getLayerById(1)),Ps&&(Ps.incrementCounter(),this._requestedDepth=!0))},t._releaseDepth=function(){this._requestedDepth&&Ps&&(Ps.decrementCounter(),this._requestedDepth=!1)},t.onSetDepthSoftening=function(e,n,r){n!==r&&(r?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=r),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},t.onSetSimpleProperty=function(e,n,r){this.emitter&&(this.emitter[e]=r,this.emitter.resetMaterial())},t.onSetComplexProperty=function(e,n,r){this.emitter&&(this.emitter[e]=r,this.emitter.resetMaterial(),this.rebuild(),this.reset())},t.onSetGraphProperty=function(e,n,r){this.emitter&&(this.emitter[e]=r,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},t.onEnable=function(){for(var e=this.system.app.scene,n=e.layers,r=this.data,s=0,l=xc.length;s<l;s++){var u=r[xc[s]];if(u){if(!_r(u,$)){if(!(parseInt(u,10)>=0))continue;u=this.system.app.assets.get(u)}u&&!u.resource&&this.system.app.assets.load(u)}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){var c=r.mesh;_r(c,ye)||(c=null),this.emitter=new Oy(this.system.app.graphicsDevice,{numParticles:r.numParticles,emitterExtents:r.emitterExtents,emitterExtentsInner:r.emitterExtentsInner,emitterRadius:r.emitterRadius,emitterRadiusInner:r.emitterRadiusInner,emitterShape:r.emitterShape,initialVelocity:r.initialVelocity,wrap:r.wrap,localSpace:r.localSpace,screenSpace:r.screenSpace,wrapBounds:r.wrapBounds,lifetime:r.lifetime,rate:r.rate,rate2:r.rate2,orientation:r.orientation,particleNormal:r.particleNormal,animTilesX:r.animTilesX,animTilesY:r.animTilesY,animStartFrame:r.animStartFrame,animNumFrames:r.animNumFrames,animNumAnimations:r.animNumAnimations,animIndex:r.animIndex,randomizeAnimIndex:r.randomizeAnimIndex,animSpeed:r.animSpeed,animLoop:r.animLoop,startAngle:r.startAngle,startAngle2:r.startAngle2,scaleGraph:r.scaleGraph,scaleGraph2:r.scaleGraph2,colorGraph:r.colorGraph,colorGraph2:r.colorGraph2,alphaGraph:r.alphaGraph,alphaGraph2:r.alphaGraph2,localVelocityGraph:r.localVelocityGraph,localVelocityGraph2:r.localVelocityGraph2,velocityGraph:r.velocityGraph,velocityGraph2:r.velocityGraph2,rotationSpeedGraph:r.rotationSpeedGraph,rotationSpeedGraph2:r.rotationSpeedGraph2,radialSpeedGraph:r.radialSpeedGraph,radialSpeedGraph2:r.radialSpeedGraph2,colorMap:r.colorMap,normalMap:r.normalMap,loop:r.loop,preWarm:r.preWarm,sort:r.sort,stretch:r.stretch,alignToMotion:r.alignToMotion,lighting:r.lighting,halfLambert:r.halfLambert,intensity:r.intensity,depthSoftening:r.depthSoftening,scene:this.system.app.scene,mesh:c,depthWrite:r.depthWrite,noFog:r.noFog,node:this.entity,blendType:r.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,r.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),n&&(this._evtLayerAdded=n.on("add",this.onLayerAdded,this),this._evtLayerRemoved=n.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&r.depthSoftening&&this._requestDepth()}},t.onDisable=function(){var e,n,r,s=this.system.app.scene.layers;(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,s&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)},t.onBeforeRemove=function(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var e=0;e<xc.length;e++){var n=xc[e];this.data[n]&&(this[n]=null)}this.off()},t.reset=function(){this.emitter&&this.emitter.reset()},t.stop=function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},t.pause=function(){this.data.paused=!0},t.unpause=function(){this.data.paused=!1},t.play=function(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},t.isPlaying=function(){return!this.data.paused&&(!!this.emitter&&!!this.emitter.loop||Date.now()<=this.emitter.endTime)},t.setInTools=function(){var e=this.emitter;e&&!e.inTools&&(e.inTools=!0,this.rebuild())},t.rebuild=function(){var e=this.enabled;this.enabled=!1,this.emitter&&this.emitter.rebuild(),this.enabled=e},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e)}},{key:"autoPlay",get:function(){return this.data.autoPlay},set:function(e){this._setValue("autoPlay",e)}},{key:"numParticles",get:function(){return this.data.numParticles},set:function(e){this._setValue("numParticles",e)}},{key:"lifetime",get:function(){return this.data.lifetime},set:function(e){this._setValue("lifetime",e)}},{key:"rate",get:function(){return this.data.rate},set:function(e){this._setValue("rate",e)}},{key:"rate2",get:function(){return this.data.rate2},set:function(e){this._setValue("rate2",e)}},{key:"startAngle",get:function(){return this.data.startAngle},set:function(e){this._setValue("startAngle",e)}},{key:"startAngle2",get:function(){return this.data.startAngle2},set:function(e){this._setValue("startAngle2",e)}},{key:"loop",get:function(){return this.data.loop},set:function(e){this._setValue("loop",e)}},{key:"preWarm",get:function(){return this.data.preWarm},set:function(e){this._setValue("preWarm",e)}},{key:"lighting",get:function(){return this.data.lighting},set:function(e){this._setValue("lighting",e)}},{key:"halfLambert",get:function(){return this.data.halfLambert},set:function(e){this._setValue("halfLambert",e)}},{key:"intensity",get:function(){return this.data.intensity},set:function(e){this._setValue("intensity",e)}},{key:"depthWrite",get:function(){return this.data.depthWrite},set:function(e){this._setValue("depthWrite",e)}},{key:"noFog",get:function(){return this.data.noFog},set:function(e){this._setValue("noFog",e)}},{key:"depthSoftening",get:function(){return this.data.depthSoftening},set:function(e){this._setValue("depthSoftening",e)}},{key:"sort",get:function(){return this.data.sort},set:function(e){this._setValue("sort",e)}},{key:"blendType",get:function(){return this.data.blendType},set:function(e){this._setValue("blendType",e)}},{key:"stretch",get:function(){return this.data.stretch},set:function(e){this._setValue("stretch",e)}},{key:"alignToMotion",get:function(){return this.data.alignToMotion},set:function(e){this._setValue("alignToMotion",e)}},{key:"emitterShape",get:function(){return this.data.emitterShape},set:function(e){this._setValue("emitterShape",e)}},{key:"emitterExtents",get:function(){return this.data.emitterExtents},set:function(e){this._setValue("emitterExtents",e)}},{key:"emitterExtentsInner",get:function(){return this.data.emitterExtentsInner},set:function(e){this._setValue("emitterExtentsInner",e)}},{key:"emitterRadius",get:function(){return this.data.emitterRadius},set:function(e){this._setValue("emitterRadius",e)}},{key:"emitterRadiusInner",get:function(){return this.data.emitterRadiusInner},set:function(e){this._setValue("emitterRadiusInner",e)}},{key:"initialVelocity",get:function(){return this.data.initialVelocity},set:function(e){this._setValue("initialVelocity",e)}},{key:"wrap",get:function(){return this.data.wrap},set:function(e){this._setValue("wrap",e)}},{key:"wrapBounds",get:function(){return this.data.wrapBounds},set:function(e){this._setValue("wrapBounds",e)}},{key:"localSpace",get:function(){return this.data.localSpace},set:function(e){this._setValue("localSpace",e)}},{key:"screenSpace",get:function(){return this.data.screenSpace},set:function(e){this._setValue("screenSpace",e)}},{key:"colorMapAsset",get:function(){return this.data.colorMapAsset},set:function(e){this._setValue("colorMapAsset",e)}},{key:"normalMapAsset",get:function(){return this.data.normalMapAsset},set:function(e){this._setValue("normalMapAsset",e)}},{key:"mesh",get:function(){return this.data.mesh},set:function(e){this._setValue("mesh",e)}},{key:"meshAsset",get:function(){return this.data.meshAsset},set:function(e){this._setValue("meshAsset",e)}},{key:"renderAsset",get:function(){return this.data.renderAsset},set:function(e){this._setValue("renderAsset",e)}},{key:"orientation",get:function(){return this.data.orientation},set:function(e){this._setValue("orientation",e)}},{key:"particleNormal",get:function(){return this.data.particleNormal},set:function(e){this._setValue("particleNormal",e)}},{key:"localVelocityGraph",get:function(){return this.data.localVelocityGraph},set:function(e){this._setValue("localVelocityGraph",e)}},{key:"localVelocityGraph2",get:function(){return this.data.localVelocityGraph2},set:function(e){this._setValue("localVelocityGraph2",e)}},{key:"velocityGraph",get:function(){return this.data.velocityGraph},set:function(e){this._setValue("velocityGraph",e)}},{key:"velocityGraph2",get:function(){return this.data.velocityGraph2},set:function(e){this._setValue("velocityGraph2",e)}},{key:"rotationSpeedGraph",get:function(){return this.data.rotationSpeedGraph},set:function(e){this._setValue("rotationSpeedGraph",e)}},{key:"rotationSpeedGraph2",get:function(){return this.data.rotationSpeedGraph2},set:function(e){this._setValue("rotationSpeedGraph2",e)}},{key:"radialSpeedGraph",get:function(){return this.data.radialSpeedGraph},set:function(e){this._setValue("radialSpeedGraph",e)}},{key:"radialSpeedGraph2",get:function(){return this.data.radialSpeedGraph2},set:function(e){this._setValue("radialSpeedGraph2",e)}},{key:"scaleGraph",get:function(){return this.data.scaleGraph},set:function(e){this._setValue("scaleGraph",e)}},{key:"scaleGraph2",get:function(){return this.data.scaleGraph2},set:function(e){this._setValue("scaleGraph2",e)}},{key:"colorGraph",get:function(){return this.data.colorGraph},set:function(e){this._setValue("colorGraph",e)}},{key:"colorGraph2",get:function(){return this.data.colorGraph2},set:function(e){this._setValue("colorGraph2",e)}},{key:"alphaGraph",get:function(){return this.data.alphaGraph},set:function(e){this._setValue("alphaGraph",e)}},{key:"alphaGraph2",get:function(){return this.data.alphaGraph2},set:function(e){this._setValue("alphaGraph2",e)}},{key:"colorMap",get:function(){return this.data.colorMap},set:function(e){this._setValue("colorMap",e)}},{key:"normalMap",get:function(){return this.data.normalMap},set:function(e){this._setValue("normalMap",e)}},{key:"animTilesX",get:function(){return this.data.animTilesX},set:function(e){this._setValue("animTilesX",e)}},{key:"animTilesY",get:function(){return this.data.animTilesY},set:function(e){this._setValue("animTilesY",e)}},{key:"animStartFrame",get:function(){return this.data.animStartFrame},set:function(e){this._setValue("animStartFrame",e)}},{key:"animNumFrames",get:function(){return this.data.animNumFrames},set:function(e){this._setValue("animNumFrames",e)}},{key:"animNumAnimations",get:function(){return this.data.animNumAnimations},set:function(e){this._setValue("animNumAnimations",e)}},{key:"animIndex",get:function(){return this.data.animIndex},set:function(e){this._setValue("animIndex",e)}},{key:"randomizeAnimIndex",get:function(){return this.data.randomizeAnimIndex},set:function(e){this._setValue("randomizeAnimIndex",e)}},{key:"animSpeed",get:function(){return this.data.animSpeed},set:function(e){this._setValue("animSpeed",e)}},{key:"animLoop",get:function(){return this.data.animLoop},set:function(e){this._setValue("animLoop",e)}},{key:"layers",get:function(){return this.data.layers},set:function(e){this._setValue("layers",e)}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),aD=function(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new E,this.emitterExtentsInner=new E,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrap=!1,this.wrapBounds=new E,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=0,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.renderAsset=null,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=0,this.particleNormal=new E(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]},oD={particlePS:`
varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
uniform float softening;
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
void main(void) {
	vec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));
	vec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a  = tex.a * ramp.a;
`,particleVS:`
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow)
		meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`,particleAnimFrameClampVS:`
	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`,particleAnimFrameLoopVS:`
	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`,particleAnimTexVS:`
	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`,particleInputFloatPS:`
void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,particleInputRgba8PS:`
#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y * (1.0 / 255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot(rgba, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`,particleOutputFloatPS:`
void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`,particleOutputRgba8PS:`
uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`,particleUpdaterAABBPS:`
uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`,particleUpdaterEndPS:`
	writeOutput();
}
`,particleUpdaterInitPS:`
varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix;
uniform mat3 emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 frameRandom;
uniform vec3 localVelocityDivMult;
uniform vec3 velocityDivMult;
uniform float delta;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float numParticles;
uniform float rotSpeedDivMult;
uniform float radialSpeedDivMult;
uniform float seed;
uniform float startAngle;
uniform float startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`,particleUpdaterNoRespawnPS:`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`,particleUpdaterOnStopPS:`
	visMode = outLife < 0.0? -1.0: visMode;
`,particleUpdaterRespawnPS:`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`,particleUpdaterSpherePS:`
uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`,particleUpdaterStartPS:`
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =	  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`,particle_billboardVS:`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`,particle_blendAddPS:`
	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`,particle_blendMultiplyPS:`
	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`,particle_blendNormalPS:`
	if (a < 0.01) discard;
`,particle_cpuVS:`
attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
	attribute vec2 particle_vertexData5;
#else
	attribute vec4 particle_vertexData5;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`,particle_cpu_endVS:`
	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
`,particle_customFaceVS:`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`,particle_endPS:`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`,particle_endVS:`
	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`,particle_halflambertPS:`
	vec3 negNormal = normal * 0.5 + 0.5;
	vec3 posNormal = -normal * 0.5 + 0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`,particle_initVS:`
attribute vec4 particle_vertexData;
#if defined(USE_MESH)
	#if defined(USE_MESH_UV)
		attribute vec2 particle_uv;
	#else
		vec2 particle_uv = vec2(0.0, 0.0);
	#endif
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform float numParticles;
uniform float numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float deltaRandomnessStatic;
uniform float scaleDivMult;
uniform float alphaDivMult;
uniform float seed;
uniform float delta;
uniform sampler2D particleTexOUT;
uniform sampler2D particleTexIN;
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`,particle_lambertPS:`
	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`,particle_lightingPS:`
	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`,particle_localShiftVS:`
	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`,particle_meshVS:`
	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`,particle_normalVS:`
	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`,particle_normalMapPS:`
	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`,particle_pointAlongVS:`
	inAngle = atan(velocityV.x, velocityV.y);
`,particle_simulationPS:`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`,particle_shaderPS:`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying vec3 Normal;
		#endif
		#if NORMAL == MAP
			varying mat3 ParticleMat;
		#endif
		uniform vec3 lightCube[6];
	#endif
	#ifdef SOFT
		varying float vDepth;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		uniform sampler2D normalMap;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		vec3 normal = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`,particle_shaderVS:`
	#ifdef ANIMTEX
		uniform vec2 animTexTilesParams;
		uniform vec4 animTexParams;
		uniform vec2 animTexIndexParams;
	#endif
	#if NORMAL == MAP
		varying mat3 ParticleMat;
	#endif
	#if NORMAL == VERTEX
		varying vec3 Normal;
	#endif
	#ifdef SOFT
		varying float vDepth;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	}
`,particle_softPS:`
	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`,particle_softVS:`
	vDepth = getLinearDepth(localPos);
`,particle_stretchVS:`
	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,particle_TBNVS:`
	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`,particle_wrapVS:`
	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`},lD={particlePS:`
varying texCoordsAlphaLife: vec4f;
var colorMap: texture_2d<f32>;
var colorMapSampler: sampler;
var colorParam: texture_2d<f32>;
var colorParamSampler: sampler;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
uniform softening: f32;
uniform colorMult: f32;
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let tex: vec4f  = textureSample(colorMap, colorMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));
	var ramp: vec4f = textureSample(colorParam, colorParamSampler, vec2f(input.texCoordsAlphaLife.w, 0.0));
	ramp = vec4f(ramp.rgb * uniform.colorMult, ramp.a);
	ramp.a = ramp.a + input.texCoordsAlphaLife.z;
	var rgb: vec3f = tex.rgb * ramp.rgb;
	var a: f32 = tex.a * ramp.a;
`,particleVS:`
fn unpack3NFloats(src: f32) -> vec3f {
	let r = fract(src);
	let g = fract(src * 256.0);
	let b = fract(src * 65536.0);
	return vec3f(r, g, b);
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
struct TexLerpUnpackResult {
	result: vec4f,
	unpacked: vec3f
}
fn tex1Dlod_lerp_simple(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> vec4f {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	return mix( textureSample(tex, texSampler, tc), textureSample(tex, texSampler, tc_next), fract(tc.x * uniform.graphNumSamples) );
}
fn tex1Dlod_lerp_unpack(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> TexLerpUnpackResult {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let a = textureSampleLevel(tex, texSampler, tc, 0.0);
	let b = textureSampleLevel(tex, texSampler, tc_next, 0.0);
	let c = fract(tc.x * uniform.graphNumSamples);
	let unpackedA = unpack3NFloats(a.w);
	let unpackedB = unpack3NFloats(b.w);
	let w_out = mix(unpackedA, unpackedB, c);
	return TexLerpUnpackResult(mix(a, b, c), w_out);
}
struct RotateResult {
	rotatedVec: vec2f,
	matrix: mat2x2f
}
fn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {
	let c = cos(pRotation);
	let s = sin(pRotation);
	let m = mat2x2f(vec2f(c, s), vec2f(-s, c));
	return RotateResult(m * quadXY, m);
}
fn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	var pos: vec3f;
	#ifdef SCREEN_SPACE
		pos = vec3f(-1.0, 0.0, 0.0) * quadXY.x + vec3f(0.0, -1.0, 0.0) * quadXY.y;
	#else
		pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
fn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;
	return pos;
}
fn safeNormalize(v: vec2f) -> vec2f {
	let l = length(v);
	return select(v, v / l, l > 1e-06);
}
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	let meshLocalPos_in = input.particle_vertexData.xyz;
	let id = floor(input.particle_vertexData.w);
	let rndFactor = fract(sin(id + 1.0 + uniform.seed));
	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	let uv = id / uniform.numParticlesPot;
	readInput(uv);
	#ifdef LOCAL_SPACE
		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);
		inVel = modelRotation * inVel;
	#endif
	let viewRotation = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let velocityV = safeNormalize((viewRotation * inVel).xy);
	let particleLifetime = uniform.lifetime;
	var meshLocalPos = meshLocalPos_in;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) {
		 meshLocalPos = vec3f(0.0);
	}
	let quadXY = meshLocalPos.xy;
	let nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	let lerp_result = tex1Dlod_lerp_unpack(internalTex2, internalTex2Sampler, vec2f(nlife, 0.0));
	let params = lerp_result.result;
	let paramDiv = lerp_result.unpacked;
	var scale = params.y;
	let scaleDiv = paramDiv.x;
	let alphaDiv = paramDiv.z;
	scale = scale + (scaleDiv * 2.0 - 1.0) * uniform.scaleDivMult * fract(rndFactor*10000.0);
	#ifndef USE_MESH
		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);
	#else
		output.texCoordsAlphaLife = vec4f(particle_uv, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);
	#endif
	var particlePos = inPos;
	var particlePosMoved = vec3f(0.0);
	var rotMatrix: mat2x2f;
`,particleAnimFrameClampVS:`
	let animFrame: f32 = min(floor(input.texCoordsAlphaLife.w * uniform.animTexParams.y) + uniform.animTexParams.x, uniform.animTexParams.z);
`,particleAnimFrameLoopVS:`
	let animFrame: f32 = floor((output.texCoordsAlphaLife.w * uniform.animTexParams.y + uniform.animTexParams.x) % (uniform.animTexParams.z + 1.0));	
`,particleAnimTexVS:`
	var animationIndex: f32;
	if (uniform.animTexIndexParams.y == 1.0) {
		animationIndex = floor((uniform.animTexParams.w + 1.0) * rndFactor3.z) * (uniform.animTexParams.z + 1.0);
	} else {
		animationIndex = uniform.animTexIndexParams.x * (uniform.animTexParams.z + 1.0);
	}
	var atlasX: f32 = (animationIndex + animFrame) * uniform.animTexTilesParams.x;
	let atlasY: f32 = 1.0 - floor(atlasX + 1.0) * uniform.animTexTilesParams.y;
	atlasX = fract(atlasX);
	let current_tcal_xy = output.texCoordsAlphaLife.xy;
	let scaled_tcal_xy = current_tcal_xy * uniform.animTexTilesParams.xy;
	let final_tcal_xy = scaled_tcal_xy + vec2f(atlasX, atlasY);
	output.texCoordsAlphaLife = vec4f(final_tcal_xy, output.texCoordsAlphaLife.z, output.texCoordsAlphaLife.w);
`,particleInputFloatPS:`
fn readInput(uv: f32) {
	let tex: vec4f = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.25), 0.0);
	let tex2: vec4f = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.75), 0.0);
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = abs(tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,particleInputRgba8PS:`
const PI2: f32 = 6.283185307179586;
uniform inBoundsSize: vec3f;
uniform inBoundsCenter: vec3f;
uniform maxVel: f32;
fn decodeFloatRG(rg: vec2f) -> f32 {
	return rg.y * (1.0 / 255.0) + rg.x;
}
fn decodeFloatRGBA( rgba: vec4f ) -> f32 {
	return dot(rgba, vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));
}
fn readInput(uv: f32) {
	let tex0 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.125), 0.0);
	let tex1 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.375), 0.0);
	let tex2 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.625), 0.0);
	let tex3 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.875), 0.0);
	inPos = vec3f(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3f(0.5)) * uniform.inBoundsSize + uniform.inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3f(0.5)) * uniform.maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	let life_decoded = decodeFloatRGBA(tex3);
	let maxNegLife = max(uniform.lifetime, (uniform.numParticles - 1.0) * (uniform.rate + uniform.rateDiv));
	let maxPosLife = uniform.lifetime + 1.0;
	inLife = life_decoded * (maxNegLife + maxPosLife) - maxNegLife;
}`,particleOutputFloatPS:`
fn getOutput() -> vec4f {
	if (pcPosition.y < 1.0) {
		return vec4f(outPos, (outAngle + 1000.0) * visMode);
	} else {
		return vec4f(outVel, outLife);
	}
}
`,particleOutputRgba8PS:`
uniform outBoundsMul: vec3f;
uniform outBoundsAdd: vec3f;
fn encodeFloatRG( v: f32 ) -> vec2f {
	var enc: vec2f = vec2f(1.0, 255.0) * v;
	enc = fract(enc);
	enc = enc - enc.yy * (1.0 / 255.0);
	return enc;
}
fn encodeFloatRGBA( v: f32 ) -> vec4f {
	let factors = vec4f(1.0, 255.0, 65025.0, 160581375.0);
	var enc: vec4f = factors * v;
	enc = fract(enc);
	enc = enc - enc.yzww * vec4f(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
	return enc;
}
fn getOutput() -> vec4f {
	outPos = outPos * uniform.outBoundsMul + uniform.outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / uniform.maxVel) + vec3f(0.5);
	let maxNegLife = max(uniform.lifetime, (uniform.numParticles - 1.0) * (uniform.rate + uniform.rateDiv));
	let maxPosLife = uniform.lifetime + 1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (pcPosition.y < 1.0) {
		return vec4f(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (pcPosition.y < 2.0) {
		return vec4f(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (pcPosition.y < 3.0) {
		return vec4f(outVel, visMode * 0.5 + 0.5);
	} else {
		return encodeFloatRGBA(outLife);
	}
}
`,particleUpdaterAABBPS:`
uniform spawnBounds: mat3x3f;
uniform spawnPosInnerRatio: vec3f;
fn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {
	var pos = inBounds - vec3f(0.5);
	let posAbs = abs(pos);
	let maxComp = max(posAbs.x, max(posAbs.y, posAbs.z));
	let maxPos = vec3f(maxComp);
	let edge = maxPos + (vec3f(0.5) - maxPos) * uniform.spawnPosInnerRatio;
	pos.x = edge.x * select(2.0 * pos.x, sign(pos.x), maxPos.x == posAbs.x);
	pos.y = edge.y * select(2.0 * pos.y, sign(pos.y), maxPos.y == posAbs.y);
	pos.z = edge.z * select(2.0 * pos.z, sign(pos.z), maxPos.z == posAbs.z);
	#ifndef LOCAL_SPACE
		return uniform.emitterPos + uniform.spawnBounds * pos;
	#else
		return uniform.spawnBounds * pos;
	#endif
}
fn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {
	*localVelocity = *localVelocity - vec3f(0.0, 0.0, uniform.initialVelocity);
}
`,particleUpdaterEndPS:`
	output.color = getOutput();
	return output;
}
`,particleUpdaterInitPS:`
varying vUv0: vec2f;
var particleTexIN: texture_2d<f32>;
var particleTexINSampler: sampler;
var internalTex0: texture_2d<f32>;
var internalTex0Sampler: sampler;
var internalTex1: texture_2d<f32>;
var internalTex1Sampler: sampler;
var internalTex2: texture_2d<f32>;
var internalTex2Sampler: sampler;
var internalTex3: texture_2d<f32>;
var internalTex3Sampler: sampler;
uniform emitterMatrix: mat3x3f;
uniform emitterMatrixInv: mat3x3f;
uniform emitterScale: vec3f;
uniform emitterPos: vec3f;
uniform frameRandom: vec3f;
uniform localVelocityDivMult: vec3f;
uniform velocityDivMult: vec3f;
uniform delta: f32;
uniform rate: f32;
uniform rateDiv: f32;
uniform lifetime: f32;
uniform numParticles: f32;
uniform rotSpeedDivMult: f32;
uniform radialSpeedDivMult: f32;
uniform seed: f32;
uniform startAngle: f32;
uniform startAngle2: f32;
uniform initialVelocity: f32;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
var<private> inPos: vec3f;
var<private> inVel: vec3f;
var<private> inAngle: f32;
var<private> inShow: bool;
var<private> inLife: f32;
var<private> visMode: f32;
var<private> outPos: vec3f;
var<private> outVel: vec3f;
var<private> outAngle: f32;
var<private> outShow: bool;
var<private> outLife: f32;
`,particleUpdaterNoRespawnPS:`
	if (outLife >= uniform.lifetime) {
		outLife = outLife - max(uniform.lifetime, (uniform.numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`,particleUpdaterOnStopPS:`
	visMode = select(visMode, -1.0, outLife < 0.0);
`,particleUpdaterRespawnPS:`
	if (outLife >= uniform.lifetime) {
		let subtractAmount = max(uniform.lifetime, (uniform.numParticles - 1.0) * particleRate);
		outLife = outLife - subtractAmount;
		visMode = 1.0;
	}
	visMode = select(visMode, 1.0, outLife < 0.0);
`,particleUpdaterSpherePS:`
uniform spawnBoundsSphere: f32;
uniform spawnBoundsSphereInnerRatio: f32;
fn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {
	let rnd4: f32 = fract(rndFactor * 1000.0);
	let norm: vec3f = normalize(inBounds.xyz - vec3f(0.5));
	let r: f32 = rnd4 * (1.0 - uniform.spawnBoundsSphereInnerRatio) + uniform.spawnBoundsSphereInnerRatio;
	#ifndef LOCAL_SPACE
		return uniform.emitterPos + norm * r * uniform.spawnBoundsSphere;
	#else
		return norm * r * uniform.spawnBoundsSphere;
	#endif
}
fn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {
	let initialVelOffset: vec3f = normalize(inBounds - vec3f(0.5)) * uniform.initialVelocity;
	*localVelocity = *localVelocity + initialVelOffset;
}
`,particleUpdaterStartPS:`
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn unpack3NFloats(src: f32) -> vec3f {
	let r = fract(src);
	let g = fract(src * 256.0);
	let b = fract(src * 65536.0);
	return vec3f(r, g, b);
}
struct TexLerpUnpackResult {
	result: vec3f,
	unpacked: vec3f
}
fn tex1Dlod_lerp(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> TexLerpUnpackResult {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let a = textureSampleLevel(tex, texSampler, tc, 0.0);
	let b = textureSampleLevel(tex, texSampler, tc_next, 0.0);
	let c = fract(tc.x * uniform.graphNumSamples);
	let unpackedA = unpack3NFloats(a.w);
	let unpackedB = unpack3NFloats(b.w);
	let w_out = mix(unpackedA, unpackedB, c);
	return TexLerpUnpackResult(mix(a.xyz, b.xyz, c), w_out);
}
const HASHSCALE4: vec4f = vec4f(1031.0, 0.1030, 0.0973, 0.1099);
fn hash41(p: f32) -> vec4f {
	var p4 = fract(vec4f(p) * HASHSCALE4);
	p4 = p4 + dot(p4, p4.wzxy + 19.19);
	return fract(vec4f((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	if (pcPosition.x > uniform.numParticles) {
		discard;
		return output;
	}
	readInput(input.vUv0.x);
	visMode = select(-1.0, 1.0, inShow);
	let rndFactor = hash41(pcPosition.x + uniform.seed);
	let particleRate = uniform.rate + uniform.rateDiv * rndFactor.x;
	outLife = inLife + uniform.delta;
	let nlife = clamp(outLife / uniform.lifetime, 0.0, 1.0);
	let lerpResult0 = tex1Dlod_lerp(internalTex0, internalTex0Sampler, vec2f(nlife, 0.0));
	var localVelocity = lerpResult0.result;
	let localVelocityDiv = lerpResult0.unpacked;
	let lerpResult1 = tex1Dlod_lerp(internalTex1, internalTex1Sampler, vec2f(nlife, 0.0));
	var velocity = lerpResult1.result;
	let velocityDiv = lerpResult1.unpacked;
	let lerpResult2 = tex1Dlod_lerp(internalTex2, internalTex2Sampler, vec2f(nlife, 0.0));
	let params = lerpResult2.result;
	let paramDiv = lerpResult2.unpacked;
	var rotSpeed = params.x;
	let rotSpeedDiv = paramDiv.y;
	let lerpResult3 = tex1Dlod_lerp(internalTex3, internalTex3Sampler, vec2f(nlife, 0.0));
	let radialParams = lerpResult3.result;
	let radialParamDiv = lerpResult3.unpacked;
	let radialSpeed = radialParams.x;
	let radialSpeedDiv = radialParamDiv.y;
	let respawn = inLife <= 0.0 || outLife >= uniform.lifetime;
	inPos = select(inPos, calcSpawnPosition(rndFactor.xyz, rndFactor.x), respawn);
	inAngle = select(inAngle, mix(uniform.startAngle, uniform.startAngle2, rndFactor.x), respawn);
	#ifndef LOCAL_SPACE
		var radialVel: vec3f = inPos - uniform.emitterPos;
	#else
		var radialVel: vec3f = inPos;
	#endif
	radialVel = select(vec3f(0.0), radialSpeed * normalize(radialVel), dot(radialVel, radialVel) > 1.0E-8);
	radialVel = radialVel + (radialSpeedDiv * vec3f(2.0) - vec3f(1.0)) * uniform.radialSpeedDivMult * rndFactor.xyz;
	localVelocity = localVelocity + (localVelocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.localVelocityDivMult * rndFactor.xyz;
	velocity = velocity + (velocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.velocityDivMult * rndFactor.xyz;
	rotSpeed = rotSpeed + (rotSpeedDiv * 2.0 - 1.0) * uniform.rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(&localVelocity, rndFactor.xyz);
	#ifndef LOCAL_SPACE
		outVel = uniform.emitterMatrix * localVelocity + (radialVel + velocity) * uniform.emitterScale;
	#else
		outVel = (localVelocity + radialVel) / uniform.emitterScale + uniform.emitterMatrixInv * velocity;
	#endif
	outPos = inPos + outVel * uniform.delta;
	outAngle = inAngle + rotSpeed * uniform.delta;
`,particle_billboardVS:`
	let rotationResult = rotateWithMatrix(quadXY, inAngle);
	let rotatedQuadXY = rotationResult.rotatedVec;
	rotMatrix = rotationResult.matrix;
	var localPos = billboard(particlePos, rotatedQuadXY);
`,particle_blendAddPS:`
	dBlendModeFogFactor = 0.0;
	rgb = rgb * saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) {
		discard;
	}	
`,particle_blendMultiplyPS:`
	rgb = mix(vec3f(1.0), rgb, a);
	if ((rgb.r + rgb.g + rgb.b) > 2.99) {
		discard;
	}
`,particle_blendNormalPS:`
	if (a < 0.01) {
		discard;
	}
`,particle_cpuVS:`
attribute particle_vertexData: vec4f;
attribute particle_vertexData2: vec4f;
attribute particle_vertexData3: vec4f;
attribute particle_vertexData4: f32;
#ifndef USE_MESH
	attribute particle_vertexData5: vec2f;
#else
	attribute particle_vertexData5: vec4f;
#endif
uniform matrix_viewProjection: mat4x4f;
uniform matrix_model: mat4x4f;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
uniform matrix_normal: mat3x3f;
uniform matrix_viewInverse: mat4x4f;
uniform numParticles: f32;
uniform lifetime: f32;
uniform stretch: f32;
uniform seed: f32;
uniform wrapBounds: vec3f;
uniform emitterScale: vec3f;
uniform faceTangent: vec3f;
uniform faceBinorm: vec3f;
#ifdef PARTICLE_GPU
	var internalTex0: texture_2d<f32>;
	var internalTex0Sampler: sampler;
	var internalTex1: texture_2d<f32>;
	var internalTex1Sampler: sampler;
	var internalTex2: texture_2d<f32>;
	var internalTex2Sampler: sampler;
#endif
uniform emitterPos: vec3f;
varying texCoordsAlphaLife: vec4f;
struct RotateResult {
	rotatedVec: vec2f,
	matrix: mat2x2f
}
fn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {
	let c = cos(pRotation);
	let s = sin(pRotation);
	let m = mat2x2f(vec2f(c, s), vec2f(-s, c));
	return RotateResult(m * quadXY, m);
}
fn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
fn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;
	return pos;
}
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	var particlePos = input.particle_vertexData.xyz;
	let inPos = particlePos;
	let vertPos = input.particle_vertexData3.xyz;
	var inVel = vec3f(input.particle_vertexData2.w, input.particle_vertexData3.w, input.particle_vertexData5.x);
	let id = floor(input.particle_vertexData4);
	let rndFactor = fract(sin(id + 1.0 + uniform.seed));
	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	#ifdef LOCAL_SPACE
		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);
		inVel = modelRotation * inVel;
	#endif
	let velocityV = safeNormalize((mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz) * inVel).xy);
	let quadXY = vertPos.xy;
	#ifdef USE_MESH
		output.texCoordsAlphaLife = vec4f(input.particle_vertexData5.zw, input.particle_vertexData2.z, input.particle_vertexData.w);
	#else
		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, input.particle_vertexData2.z, input.particle_vertexData.w);
	#endif
	var rotMatrix: mat2x2f;
	let inAngle = input.particle_vertexData2.x;
	var particlePosMoved = vec3f(0.0);
	let meshLocalPos = input.particle_vertexData3.xyz;
`,particle_cpu_endVS:`
	localPos = localPos * input.particle_vertexData2.y * emitterScale;
	localPos = localPos + particlePos;
	output.position = uniform.matrix_viewProjection * vec4f(localPos, 1.0);
`,particle_customFaceVS:`
	let rotationResult = rotateWithMatrix(quadXY, inAngle);
	let rotatedQuadXY = rotationResult.rotatedVec;
	rotMatrix = rotationResult.matrix;
	var localPos = customFace(particlePos, rotatedQuadXY);
`,particle_endPS:`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	output.color = vec4f(rgb, a);
	return output;
}
`,particle_endVS:`
	localPos = localPos * scale * uniform.emitterScale;
	localPos = localPos + particlePos;
	#ifdef SCREEN_SPACE
		output.position = vec4f(localPos.x, localPos.y, 0.0, 1.0);
	#else
		output.position = uniform.matrix_viewProjection * vec4f(localPos.xyz, 1.0);
	#endif
`,particle_halflambertPS:`
	var negNormal: vec3f = normal * 0.5 + 0.5;
	var posNormal: vec3f = -normal * 0.5 + 0.5;
	negNormal = negNormal * negNormal;
	posNormal = posNormal * posNormal;
`,particle_initVS:`
attribute particle_vertexData: vec4f;
#if defined(USE_MESH)
	#if defined(USE_MESH_UV)
		attribute particle_uv: vec2f;
	#else
		var<private> particle_uv: vec2f = vec2f(0.0, 0.0);
	#endif
#endif
uniform matrix_viewProjection: mat4x4f;
uniform matrix_model: mat4x4f;
uniform matrix_normal: mat3x3f;
uniform matrix_viewInverse: mat4x4f;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
uniform numParticles: f32;
uniform numParticlesPot: f32;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
uniform stretch: f32;
uniform wrapBounds: vec3f;
uniform emitterScale: vec3f;
uniform emitterPos: vec3f;
uniform faceTangent: vec3f;
uniform faceBinorm: vec3f;
uniform rate: f32;
uniform rateDiv: f32;
uniform lifetime: f32;
uniform deltaRandomnessStatic: f32;
uniform scaleDivMult: f32;
uniform alphaDivMult: f32;
uniform seed: f32;
uniform delta: f32;
var particleTexOUT: texture_2d<f32>;
var particleTexOUTSampler: sampler;
var particleTexIN: texture_2d<f32>;
var particleTexINSampler: sampler;
#ifdef PARTICLE_GPU
	var internalTex0: texture_2d<f32>;
	var internalTex0Sampler: sampler;
	var internalTex1: texture_2d<f32>;
	var internalTex1Sampler: sampler;
	var internalTex2: texture_2d<f32>;
	var internalTex2Sampler: sampler;
#endif
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
varying texCoordsAlphaLife: vec4f;
var<private> inPos: vec3f;
var<private> inVel: vec3f;
var<private> inAngle: f32;
var<private> inShow: bool;
var<private> inLife: f32;
`,particle_lambertPS:`
	var negNormal: vec3f = max(normal, vec3(0.0));
	var posNormal: vec3f = max(-normal, vec3(0.0));
`,particle_lightingPS:`
	let light: vec3f = negNormal.x * uniform.lightCube[0] + posNormal.x * uniform.lightCube[1] +
					   negNormal.y * uniform.lightCube[2] + posNormal.y * uniform.lightCube[3] +
					   negNormal.z * uniform.lightCube[4] + posNormal.z * uniform.lightCube[5];
	rgb = rgb * light;
`,particle_localShiftVS:`
particlePos = (uniform.matrix_model * vec4f(particlePos, 1.0)).xyz;
`,particle_meshVS:`
var localPos = meshLocalPos;
let rotResultXY = rotateWithMatrix(localPos.xy, inAngle);
localPos = vec3f(rotResultXY.rotatedVec, localPos.z);
rotMatrix = rotResultXY.matrix;
let rotResultYZ = rotateWithMatrix(localPos.yz, inAngle);
localPos = vec3f(localPos.x, rotResultYZ.rotatedVec);
rotMatrix = rotResultYZ.matrix;
billboard(particlePos, quadXY);
`,particle_normalVS:`
output.Normal = normalize(localPos + uniform.matrix_viewInverse[2].xyz);
`,particle_normalMapPS:`
	let sampledNormal: vec4f = textureSample(normalMap, normalMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));
	let normalMap: vec3f = normalize(sampledNormal.xyz * 2.0 - 1.0);
	let ParticleMat = mat3x3<f32>(ParticleMat0, ParticleMat1, ParticleMat2);
	let normal: vec3f = ParticleMat * normalMap;
`,particle_pointAlongVS:`
	inAngle = atan2(velocityV.x, velocityV.y);
`,particle_simulationPS:`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`,particle_shaderPS:`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying Normal: vec3f;
		#endif
		#if NORMAL == MAP
			varying ParticleMat0: vec3f;
			varying ParticleMat1: vec3f;
			varying ParticleMat2: vec3f;
		#endif
		uniform lightCube: array<vec3f, 6>;
	#endif
	#ifdef SOFT
		varying vDepth: f32;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		var normalMap: texture_2d<f32>;
		var normalMapSampler: sampler;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		var normal: vec3f = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`,particle_shaderVS:`
	#ifdef ANIMTEX
		uniform animTexTilesParams: vec2f;
		uniform animTexParams: vec4f;
		uniform animTexIndexParams: vec2f;
	#endif
	#if NORMAL == MAP
		varying ParticleMat0: vec3f;
		varying ParticleMat1: vec3f;
		varying ParticleMat2: vec3f;
	#endif
	#if NORMAL == VERTEX
		varying Normal: vec3f;
	#endif
	#ifdef SOFT
		varying vDepth: f32;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	return output;
}
`,particle_softPS:`
	var depth: f32 = getLinearScreenDepthFrag();
	var particleDepth: f32 = vDepth;
	var depthDiff: f32 = saturate(abs(particleDepth - depth) * uniform.softening);
	a = a * depthDiff;
`,particle_softVS:`
	output.vDepth = getLinearDepth(localPos);
`,particle_stretchVS:`
	let moveDir: vec3f = inVel * uniform.stretch;
	var posPrev: vec3f = particlePos - moveDir;
	posPrev = posPrev + particlePosMoved;
	let viewRotationTemp: mat3x3f = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let centerToVertexV: vec2f = normalize((viewRotationTemp * localPos).xy);
	let interpolation: f32 = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,particle_TBNVS:`
	let rot3 = mat3x3f(
		vec3f(rotMatrix[0][0], rotMatrix[1][0], 0.0),
		vec3f(rotMatrix[0][1], rotMatrix[1][1], 0.0),
		vec3f(0.0, 0.0, 1.0)
	);
	let viewBasis = mat3x3f(
		-uniform.matrix_viewInverse[0].xyz,
		-uniform.matrix_viewInverse[1].xyz,
		uniform.matrix_viewInverse[2].xyz
	);
	let tempMat = viewBasis * rot3;
	output.ParticleMat0 = tempMat[0];
	output.ParticleMat1 = tempMat[1];
	output.ParticleMat2 = tempMat[2];
`,particle_wrapVS:`
	let origParticlePos: vec3f = particlePos;
	particlePos = particlePos - uniform.matrix_model[3].xyz;
	particlePos = (particlePos % uniform.wrapBounds) - uniform.wrapBounds * 0.5;
	particlePos = particlePos + uniform.matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`};function ba(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function eb(o,a){return(eb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var uD=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"],tb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="particlesystem",e.ComponentType=$x,e.DataType=aD,e.schema=uD,e.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},e.on("beforeremove",e.onBeforeRemove,e),e.app.systems.on("update",e.onUpdate,e),re.get(t.graphicsDevice,ue).add(oD),re.get(t.graphicsDevice,he).add(lD),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&eb(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){var r={};n=[];var s=this.propertyTypes;for(var l in(ba(e.mesh,$)||typeof e.mesh=="number")&&(e.meshAsset=e.mesh,delete e.mesh),e){if(e.hasOwnProperty(l)&&(n.push(l),r[l]=e[l]),s[l]==="vec3")Array.isArray(r[l])&&(r[l]=new E(r[l][0],r[l][1],r[l][2]));else if(s[l]==="curve"){if(!ba(r[l],cn)){var u=r[l].type;r[l]=new cn(r[l].keys),r[l].type=u}}else if(s[l]==="curveset"&&!ba(r[l],tr)){var c=r[l].type;r[l]=new tr(r[l].keys),r[l].type=c}r.layers&&Array.isArray(r.layers)&&(r.layers=r.layers.slice(0))}o.prototype.initializeComponentData.call(this,t,r,n)},i.cloneComponent=function(t,e){for(var n=t.particlesystem.data,r=this.schema,s={},l=0,u=r.length;l<u;l++){var c=r[l],h=n[c];ba(h,E)||ba(h,cn)||ba(h,tr)?(h=h.clone(),s[c]=h):c==="layers"?s.layers=n.layers.slice(0):h!=null&&(s[c]=h)}return this.addComponent(e,s)},i.onUpdate=function(t){for(var e=this.store,n=this.app.stats.particles,r=this.app.scene.layers,s=0;s<r.layerList.length;s++)r.layerList[s].requiresLightCube=!1;for(var l in e)if(e.hasOwnProperty(l)){var u=e[l],c=u.entity,h=u.data;if(h.enabled&&c.enabled){var f=c.particlesystem.emitter;if(!(f!=null&&f.meshInstance.visible))continue;if(f.lighting)for(var d=h.layers,p=0;p<d.length;p++){var _=r.getLayerById(d[p]);_&&(_.requiresLightCube=!0)}if(!h.paused){var g=0;if(f.simTime+=t,f.simTime>=f.fixedTimeStep&&(g=Math.floor(f.simTime/f.fixedTimeStep),f.simTime-=g*f.fixedTimeStep),g){g=Math.min(g,f.maxSubSteps);for(var y=0;y<g;y++)f.addTime(f.fixedTimeStep,!1);n._updatesPerFrame+=g,n._frameTime+=f._addTimeTime,f._addTimeTime=0}f.finishFrame()}}}},i.onBeforeRemove=function(t,e){e.onBeforeRemove()},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this)},a}(We);function nb(o,a){return(nb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var cD=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t){var e;return(e=o.call(this)||this).skin=i,e.skinInstance=t,e}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&nb(a,o),a}(lu),bc=function(){function o(){}return o.createCachedSkinInstance=function(a,i,t){var e=o.getCachedSkinInstance(a,i);return e||((e=new qs(a)).resolve(i,t),o.addCachedSkinInstance(a,i,e)),e},o.getCachedSkinInstance=function(a,i){var t=null,e=o._skinInstanceCache.get(i);if(e){var n=e.find(function(r){return r.skin===a});n&&(n.incRefCount(),t=n.skinInstance)}return t},o.addCachedSkinInstance=function(a,i,t){var e=o._skinInstanceCache.get(i);e||(e=[],o._skinInstanceCache.set(i,e));var n=e.find(function(r){return r.skin===a});n||(n=new cD(a,t),e.push(n)),n.incRefCount()},o.removeCachedSkinInstance=function(a){if(a){var i=a.rootBone;if(i){var t=o._skinInstanceCache.get(i);if(t){var e=t.findIndex(function(r){return r.skinInstance===a});if(e>=0){var n=t[e];n.decRefCount(),n.refCount===0&&(t.splice(e,1),t.length||o._skinInstanceCache.delete(i),a&&(a.destroy(),n.skinInstance=null))}}}}},o}();bc._skinInstanceCache=new Map;var Ta=function(){function o(t,e,n,r,s){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=t,this.parent=e,this._scope=s,this._registry=n,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=r.load,this._onAssetAdd=r.add,this._onAssetRemove=r.remove,this._onAssetUnload=r.unload}var a,i=o.prototype;return i._bind=function(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on("load:"+this.id,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once("add:"+this.id,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on("remove:"+this.id,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on("unload:"+this.id,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on("load:url:"+this.url,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once("add:url:"+this.url,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on("remove:url:"+this.url,this._onRemove,this)))},i._unbind=function(){var t,e,n,r,s,l,u;this.id&&((t=this._evtLoadById)==null||t.off(),this._evtLoadById=null,(e=this._evtAddById)==null||e.off(),this._evtAddById=null,(n=this._evtRemoveById)==null||n.off(),this._evtRemoveById=null,(r=this._evtUnloadById)==null||r.off(),this._evtUnloadById=null),this.url&&((s=this._evtLoadByUrl)==null||s.off(),this._evtLoadByUrl=null,(l=this._evtAddByUrl)==null||l.off(),this._evtAddByUrl=null,(u=this._evtRemoveByUrl)==null||u.off(),this._evtRemoveByUrl=null)},i._onLoad=function(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)},i._onAdd=function(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)},i._onRemove=function(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null},i._onUnload=function(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)},a=[{key:"id",get:function(){return this._id},set:function(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}},{key:"url",get:function(){return this._url},set:function(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function _l(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function ib(o,a){return(ib=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var rp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._type="asset",r._castShadows=!0,r._receiveShadows=!0,r._castShadowsLightmap=!0,r._lightmapped=!1,r._lightmapSizeMultiplier=1,r.isStatic=!1,r._batchGroupId=-1,r._layers=[0],r._renderStyle=0,r._meshInstances=[],r._customAabb=null,r._area=null,r._materialReferences=[],r._rootBone=null,r._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._evtSetMeshes=null,r._assetReference=new Ta("asset",r,e.app.assets,{add:r._onRenderAssetAdded,load:r._onRenderAssetLoad,remove:r._onRenderAssetRemove,unload:r._onRenderAssetUnload},r),r._material=e.defaultMaterial,n.on("remove",r.onRemoveChild,r),n.on("removehierarchy",r.onRemoveChild,r),n.on("insert",r.onInsertChild,r),n.on("inserthierarchy",r.onInsertChild,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ib(a,o);var i,t=a.prototype;return t.assignAsset=function(e){var n=_l(e,$)?e.id:e;this._assetReference.id=n},t.destroyMeshInstances=function(){var e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(var n=0;n<e.length;n++)e[n].destroy();this._meshInstances.length=0}},t.addToLayers=function(){for(var e=this.system.app.scene.layers,n=0;n<this._layers.length;n++){var r=e.getLayerById(this._layers[n]);r&&r.addMeshInstances(this._meshInstances)}},t.removeFromLayers=function(){if(this._meshInstances&&this._meshInstances.length)for(var e=this.system.app.scene.layers,n=0;n<this._layers.length;n++){var r=e.getLayerById(this._layers[n]);r&&r.removeMeshInstances(this._meshInstances)}},t.onRemoveChild=function(){this.removeFromLayers()},t.onInsertChild=function(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()},t.onRemove=function(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(var e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},t.onLayersChanged=function(e,n){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this._meshInstances)},t.onLayerRemoved=function(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this._meshInstances)},t.onEnable=function(){var e,n=this.system.app,r=n.scene,s=r.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=r.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));var l=this._type==="asset";this._meshInstances&&this._meshInstances.length?this.addToLayers():l&&this.asset&&this._onRenderAssetAdded();for(var u=0;u<this._materialReferences.length;u++)this._materialReferences[u].asset&&this.system.app.assets.load(this._materialReferences[u].asset);this._batchGroupId>=0&&((e=n.batcher)==null||e.insert(qe.RENDER,this.batchGroupId,this.entity))},t.onDisable=function(){var e,n,r,s,l=this.system.app,u=l.scene.layers;(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),u&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&((s=l.batcher)==null||s.remove(qe.RENDER,this.batchGroupId,this.entity)),this.removeFromLayers()},t.hide=function(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1},t.show=function(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0},t._onRenderAssetAdded=function(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))},t._onRenderAssetLoad=function(){if(this.destroyMeshInstances(),this._assetReference.asset){var e,n=this._assetReference.asset.resource;(e=this._evtSetMeshes)==null||e.off(),this._evtSetMeshes=n.on("set:meshes",this._onSetMeshes,this),n.meshes&&this._onSetMeshes(n.meshes)}},t._onSetMeshes=function(e){this._cloneMeshes(e)},t._clearSkinInstances=function(){for(var e=0;e<this._meshInstances.length;e++){var n=this._meshInstances[e];bc.removeCachedSkinInstance(n.skinInstance),n.skinInstance=null}},t._cloneSkinInstances=function(){if(this._meshInstances.length&&_l(this._rootBone,pe))for(var e=0;e<this._meshInstances.length;e++){var n=this._meshInstances[e],r=n.mesh;r.skin&&!n.skinInstance&&(n.skinInstance=bc.createCachedSkinInstance(r.skin,this._rootBone,this.entity))}},t._cloneMeshes=function(e){if(e&&e.length){for(var n=[],r=0;r<e.length;r++){var s=e[r],l=new De(s,this._materialReferences[r]&&this._materialReferences[r].asset&&this._materialReferences[r].asset.resource||this.system.defaultMaterial,this.entity);n.push(l),s.morph&&(l.morphInstance=new na(s.morph))}this.meshInstances=n,this._cloneSkinInstances()}},t._onRenderAssetUnload=function(){this._type==="asset"&&this.destroyMeshInstances()},t._onRenderAssetRemove=function(){var e;(e=this._evtSetMeshes)==null||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()},t._onMaterialAdded=function(e,n,r){r.resource?this._onMaterialLoad(e,n,r):this.enabled&&this.entity.enabled&&this.system.app.assets.load(r)},t._updateMainMaterial=function(e,n){e===0&&(this.material=n)},t._onMaterialLoad=function(e,n,r){this._meshInstances[e]&&(this._meshInstances[e].material=r.resource),this._updateMainMaterial(e,r.resource)},t._onMaterialRemove=function(e,n,r){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)},t._onMaterialUnload=function(e,n,r){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)},t.resolveDuplicatedEntityReferenceProperties=function(e,n){e.rootBone&&(this.rootBone=n[e.rootBone.getGuid()])},i=[{key:"renderStyle",get:function(){return this._renderStyle},set:function(e){this._renderStyle!==e&&(this._renderStyle=e,De._prepareRenderStyleForArray(this._meshInstances,e))}},{key:"customAabb",get:function(){return this._customAabb},set:function(e){this._customAabb=e;var n=this._meshInstances;if(n)for(var r=0;r<n.length;r++)n[r].setCustomAabb(this._customAabb)}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),e!=="asset")){var n=this._material;n&&n!==this.system.defaultMaterial||(n=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);var r=Xx(this.system.app.graphicsDevice,e);this._area=r.area,this.meshInstances=[new De(r.mesh,n||this.system.defaultMaterial,this.entity)]}}},{key:"meshInstances",get:function(){return this._meshInstances},set:function(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){for(var n=this._meshInstances,r=0;r<n.length;r++)n[r].node||(n[r].node=this.entity),n[r].castShadow=this._castShadows,n[r].receiveShadow=this._receiveShadows,n[r].renderStyle=this._renderStyle,n[r].setLightmapped(this._lightmapped),n[r].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped){this._lightmapped=e;var n=this._meshInstances;if(n)for(var r=0;r<n.length;r++)n[r].setLightmapped(e)}}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var n=this._meshInstances;if(n){var r=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(var l=0;l<r.length;l++){var u=s.layers.getLayerById(this.layers[l]);u&&u.removeShadowCasters(n)}for(var c=0;c<n.length;c++)n[c].castShadow=e;if(!this._castShadows&&e)for(var h=0;h<r.length;h++){var f=s.layers.getLayerById(r[h]);f&&f.addShadowCasters(n)}}this._castShadows=e}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e){this._receiveShadows=e;var n=this._meshInstances;if(n)for(var r=0;r<n.length;r++)n[r].receiveShadow=e}}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e}},{key:"layers",get:function(){return this._layers},set:function(e){var n,r=this.system.app.scene.layers;if(this._meshInstances)for(var s=0;s<this._layers.length;s++)(n=r.getLayerById(this._layers[s]))&&n.removeMeshInstances(this._meshInstances);this._layers.length=0;for(var l=0;l<e.length;l++)this._layers[l]=e[l];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(var u=0;u<this._layers.length;u++)(n=r.getLayerById(this._layers[u]))&&n.addMeshInstances(this._meshInstances)}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var n,r;this.entity.enabled&&this._batchGroupId>=0&&((n=this.system.app.batcher)==null||n.remove(qe.RENDER,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&((r=this.system.app.batcher)==null||r.insert(qe.RENDER,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}},{key:"material",get:function(){return this._material},set:function(e){if(this._material!==e&&(this._material=e,this._meshInstances&&this._type!=="asset"))for(var n=0;n<this._meshInstances.length;n++)this._meshInstances[n].material=e}},{key:"materialAssets",get:function(){return this._materialReferences.map(function(e){return e.id})},set:function(e){if(e===void 0&&(e=[]),this._materialReferences.length>e.length){for(var n=e.length;n<this._materialReferences.length;n++)this._materialReferences[n].id=null;this._materialReferences.length=e.length}for(var r=0;r<e.length;r++)if(this._materialReferences[r]||this._materialReferences.push(new Ta(r,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[r]){var s=_l(e[r],$)?e[r].id:e[r];this._materialReferences[r].id!==s&&(this._materialReferences[r].id=s),this._materialReferences[r].asset&&this._onMaterialAdded(r,this,this._materialReferences[r].asset)}else this._materialReferences[r].id=null,this._meshInstances[r]&&(this._meshInstances[r].material=this.system.defaultMaterial)}},{key:"asset",get:function(){return this._assetReference.id},set:function(e){var n=_l(e,$)?e.id:e;this._assetReference.id!==n&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=n,this._assetReference.asset&&this._onRenderAssetAdded())}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){if(this._rootBone!==e){var n=typeof e=="string";this._rootBone&&n&&this._rootBone.getGuid()===e||(this._rootBone&&this._clearSkinInstances(),_l(e,pe)?this._rootBone=e:n?(this._rootBone=this.system.app.getEntityFromIndex(e)||null,this._rootBone):this._rootBone=null,this._rootBone&&this._cloneSkinInstances())}}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),hD=function(){this.enabled=!0};function rb(o,a){return(rb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var sp=["enabled"],ls=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"],sb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="render",e.ComponentType=rp,e.DataType=hD,e.schema=sp,e.defaultMaterial=Ks(t.graphicsDevice),e.on("beforeremove",e.onRemove,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&rb(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){(e.batchGroupId===null||e.batchGroupId===void 0)&&(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(var r=0;r<ls.length;r++)e.hasOwnProperty(ls[r])&&(t[ls[r]]=e[ls[r]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Se(new E(e.aabbCenter),new E(e.aabbHalfExtents))),o.prototype.initializeComponentData.call(this,t,e,sp)},i.cloneComponent=function(t,e){for(var n={},r=0;r<ls.length;r++)n[ls[r]]=t.render[ls[r]];n.enabled=t.render.enabled,delete n.meshInstances;var s=this.addComponent(e,n),l=t.render.meshInstances,u=l.map(function(h){return h.mesh});s._onSetMeshes(u);for(var c=0;c<l.length;c++)s.meshInstances[c].material=l[c].material;return t.render.customAabb&&(s.customAabb=t.render.customAabb.clone()),s},i.onRemove=function(t,e){e.onRemove()},a}(We);de._buildAccessors(rp.prototype,sp);var ap=function(){function o(i,t){this._pool=[],this._count=0,this._constructor=i,this._resize(t)}var a=o.prototype;return a._resize=function(i){if(i>this._pool.length)for(var t=this._pool.length;t<i;t++)this._pool[t]=new this._constructor},a.allocate=function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},a.freeAll=function(){this._count=0},o}();function Ui(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function ab(o,a){return(ab=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var fD=new Z,dD=new Z,Tc=new E,tn=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._angularDamping=0,e._angularFactor=new E(1,1,1),e._angularVelocity=new E,e._body=null,e._friction=.5,e._group=2,e._linearDamping=0,e._linearFactor=new E(1,1,1),e._linearVelocity=new E,e._mask=65533,e._mass=1,e._restitution=0,e._rollingFriction=0,e._simulationEnabled=!1,e._type=Sa,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ab(a,o);var i,t=a.prototype;return t.createBody=function(){var e,n=this.entity;if(n.collision&&(e=n.collision.shape,n.trigger&&(n.trigger.destroy(),delete n.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);var r=this._type===Jt?this._mass:0;this._getEntityTransform(Vt);var s=this.system.createBody(r,e,Vt);if(s.setRestitution(this._restitution),s.setFriction(this._friction),s.setRollingFriction(this._rollingFriction),s.setDamping(this._linearDamping,this._angularDamping),this._type===Jt){var l=this._linearFactor;be.setValue(l.x,l.y,l.z),s.setLinearFactor(be);var u=this._angularFactor;be.setValue(u.x,u.y,u.z),s.setAngularFactor(be)}else this._type===pr&&(s.setCollisionFlags(2|s.getCollisionFlags()),s.setActivationState(4));s.entity=n,this.body=s,this.enabled&&n.enabled&&this.enableSimulation()}},t.isActive=function(){return!!this._body&&this._body.isActive()},t.activate=function(){this._body&&this._body.activate()},t.enableSimulation=function(){var e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){var n=this._body;if(n){switch(this.system.addBody(n,this._group,this._mask),this._type){case Jt:this.system._dynamic.push(this),n.forceActivationState(1),this.syncEntityToBody();break;case pr:this.system._kinematic.push(this),n.forceActivationState(4);break;case Sa:n.forceActivationState(1),this.syncEntityToBody()}e.collision.type==="compound"&&this.system._compounds.push(e.collision),n.activate(),this._simulationEnabled=!0}}},t.disableSimulation=function(){var e=this._body;if(e&&this._simulationEnabled){var n=this.system,r=n._compounds.indexOf(this.entity.collision);r>-1&&n._compounds.splice(r,1),(r=n._dynamic.indexOf(this))>-1&&n._dynamic.splice(r,1),(r=n._kinematic.indexOf(this))>-1&&n._kinematic.splice(r,1),n.removeBody(e),e.forceActivationState(5),this._simulationEnabled=!1}},t.applyForce=function(e,n,r,s,l,u){var c=this._body;c&&(c.activate(),Ui(e,E)?be.setValue(e.x,e.y,e.z):be.setValue(e,n,r),Ui(n,E)?xn.setValue(n.x,n.y,n.z):s!==void 0?xn.setValue(s,l,u):xn.setValue(0,0,0),c.applyForce(be,xn))},t.applyTorque=function(e,n,r){var s=this._body;s&&(s.activate(),Ui(e,E)?be.setValue(e.x,e.y,e.z):be.setValue(e,n,r),s.applyTorque(be))},t.applyImpulse=function(e,n,r,s,l,u){var c=this._body;c&&(c.activate(),Ui(e,E)?be.setValue(e.x,e.y,e.z):be.setValue(e,n,r),Ui(n,E)?xn.setValue(n.x,n.y,n.z):s!==void 0?xn.setValue(s,l,u):xn.setValue(0,0,0),c.applyImpulse(be,xn))},t.applyTorqueImpulse=function(e,n,r){var s=this._body;s&&(s.activate(),Ui(e,E)?be.setValue(e.x,e.y,e.z):be.setValue(e,n,r),s.applyTorqueImpulse(be))},t.isStatic=function(){return this._type===Sa},t.isStaticOrKinematic=function(){return this._type===Sa||this._type===pr},t.isKinematic=function(){return this._type===pr},t._getEntityTransform=function(e){var n=this.entity,r=n.collision;if(r){var s=r.getShapePosition(),l=r.getShapeRotation();be.setValue(s.x,s.y,s.z),Is.setValue(l.x,l.y,l.z,l.w)}else{var u=n.getPosition(),c=n.getRotation();be.setValue(u.x,u.y,u.z),Is.setValue(c.x,c.y,c.z,c.w)}e.setOrigin(be),e.setRotation(Is)},t.syncEntityToBody=function(){var e=this._body;if(e){if(this._getEntityTransform(Vt),e.setWorldTransform(Vt),this._type===pr){var n=e.getMotionState();n&&n.setWorldTransform(Vt)}e.activate()}},t._updateDynamic=function(){var e=this._body;if(e.isActive()){var n=e.getMotionState();if(n){var r=this.entity;n.getWorldTransform(Vt);var s=Vt.getOrigin(),l=Vt.getRotation(),u=r.collision;if(u&&u._hasOffset){var c=u.data.linearOffset,h=u.data.angularOffset,f=dD.copy(h).invert(),d=fD.set(l.x(),l.y(),l.z(),l.w()).mul(f);d.transformVector(c,Tc),r.setPosition(s.x()-Tc.x,s.y()-Tc.y,s.z()-Tc.z),r.setRotation(d)}else r.setPosition(s.x(),s.y(),s.z()),r.setRotation(l.x(),l.y(),l.z(),l.w())}}},t._updateKinematic=function(){var e=this._body.getMotionState();e&&(this._getEntityTransform(Vt),e.setWorldTransform(Vt))},t.teleport=function(e,n,r,s,l,u){Ui(e,E)?this.entity.setPosition(e):this.entity.setPosition(e,n,r),Ui(n,Z)?this.entity.setRotation(n):Ui(n,E)?this.entity.setEulerAngles(n):s!==void 0&&this.entity.setEulerAngles(s,l,u),this.syncEntityToBody()},t.onEnable=function(){this._body||this.createBody(),this.enableSimulation()},t.onDisable=function(){this.disableSimulation()},a.onLibraryLoaded=function(){typeof Ammo<"u"&&(Vt=new Ammo.btTransform,be=new Ammo.btVector3,xn=new Ammo.btVector3,Is=new Ammo.btQuaternion)},a.onAppDestroy=function(){Ammo.destroy(Vt),Ammo.destroy(be),Ammo.destroy(xn),Ammo.destroy(Is),Vt=null,be=null,xn=null,Is=null},i=[{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){!this._angularFactor.equals(e)&&(this._angularFactor.copy(e),this._body&&this._type===Jt&&(be.setValue(e.x,e.y,e.z),this._body.setAngularFactor(be)))}},{key:"angularVelocity",get:function(){if(this._body&&this._type===Jt){var e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity},set:function(e){this._body&&this._type===Jt&&(this._body.activate(),be.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(be),this._angularVelocity.copy(e))}},{key:"body",get:function(){return this._body},set:function(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}},{key:"group",get:function(){return this._group},set:function(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){!this._linearFactor.equals(e)&&(this._linearFactor.copy(e),this._body&&this._type===Jt&&(be.setValue(e.x,e.y,e.z),this._body.setLinearFactor(be)))}},{key:"linearVelocity",get:function(){if(this._body&&this._type===Jt){var e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity},set:function(e){this._body&&this._type===Jt&&(this._body.activate(),be.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(be),this._linearVelocity.copy(e))}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}},{key:"mass",get:function(){return this._mass},set:function(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===Jt)){var n=this.enabled&&this.entity.enabled;n&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,be),this._body.setMassProps(e,be),this._body.updateInertiaTensor(),n&&this.enableSimulation()}}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case Jt:this._group=1,this._mask=65535;break;case pr:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);tn.EVENT_CONTACT="contact",tn.EVENT_COLLISIONSTART="collisionstart",tn.EVENT_COLLISIONEND="collisionend",tn.EVENT_TRIGGERENTER="triggerenter",tn.EVENT_TRIGGERLEAVE="triggerleave",tn.order=-1;var pD=function(){this.enabled=!0};function ob(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function lb(o,a){return(lb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var op=function(o,a,i,t){this.entity=o,this.point=a,this.normal=i,this.hitFraction=t},ub=function(o,a,i){arguments.length!=0?(this.a=o,this.b=a,this.impulse=i.impulse,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new E,this.localPointB=new E,this.pointA=new E,this.pointB=new E,this.normal=new E)},cb=function(o,a,i,t,e,n){o===void 0&&(o=new E),a===void 0&&(a=new E),i===void 0&&(i=new E),t===void 0&&(t=new E),e===void 0&&(e=new E),n===void 0&&(n=0),this.localPoint=o,this.localPointOther=a,this.point=i,this.pointOther=t,this.normal=e,this.impulse=n},hb=function(o,a){this.other=o,this.contacts=a},fb=["enabled"],Ec=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).maxSubSteps=10,e.fixedTimeStep=1/60,e.gravity=new E(0,-9.81,0),e._gravityFloat32=new Float32Array(3),e._dynamic=[],e._kinematic=[],e._triggers=[],e._compounds=[],e.id="rigidbody",e._stats=t.stats.frame,e.ComponentType=tn,e.DataType=pD,e.contactPointPool=null,e.contactResultPool=null,e.singleContactResultPool=null,e.schema=fb,e.collisions={},e.frameCollisions={},e.on("beforeremove",e.onBeforeRemove,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&lb(a,o);var i=a.prototype;return i.onLibraryLoaded=function(){if(typeof Ammo<"u"){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}ci=new Ammo.btVector3,hi=new Ammo.btVector3,tn.onLibraryLoaded(),this.contactPointPool=new ap(cb,1),this.contactResultPool=new ap(hb,1),this.singleContactResultPool=new ap(ub,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)},i.initializeComponentData=function(t,e,n){for(var r,s=function(c,h){var f=typeof Symbol<"u"&&c[Symbol.iterator]||c["@@iterator"];if(f)return(f=f.call(c)).next.bind(f);if(Array.isArray(c)||(f=function(p,_){if(p){if(typeof p=="string")return ob(p,void 0);var g=Object.prototype.toString.call(p).slice(8,-1);if(g==="Object"&&p.constructor&&(g=p.constructor.name),g==="Map"||g==="Set")return Array.from(g);if(g==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(g))return ob(p,void 0)}}(c))){f&&(c=f);var d=0;return function(){return d>=c.length?{done:!0}:{done:!1,value:c[d++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"]);!(r=s()).done;){var l=r.value;if(e.hasOwnProperty(l)){var u=e[l];Array.isArray(u)?t[l]=new E(u[0],u[1],u[2]):t[l]=u}}o.prototype.initializeComponentData.call(this,t,e,["enabled"])},i.cloneComponent=function(t,e){var n=t.rigidbody,r={enabled:n.enabled,mass:n.mass,linearDamping:n.linearDamping,angularDamping:n.angularDamping,linearFactor:[n.linearFactor.x,n.linearFactor.y,n.linearFactor.z],angularFactor:[n.angularFactor.x,n.angularFactor.y,n.angularFactor.z],friction:n.friction,rollingFriction:n.rollingFriction,restitution:n.restitution,type:n.type,group:n.group,mask:n.mask};return this.addComponent(e,r)},i.onBeforeRemove=function(t,e){e.enabled&&(e.enabled=!1),e.body&&(this.destroyBody(e.body),e.body=null)},i.addBody=function(t,e,n){e!==void 0&&n!==void 0?this.dynamicsWorld.addRigidBody(t,e,n):this.dynamicsWorld.addRigidBody(t)},i.removeBody=function(t){this.dynamicsWorld.removeRigidBody(t)},i.createBody=function(t,e,n){var r=new Ammo.btVector3(0,0,0);t!==0&&e.calculateLocalInertia(t,r);var s=new Ammo.btDefaultMotionState(n),l=new Ammo.btRigidBodyConstructionInfo(t,s,e,r),u=new Ammo.btRigidBody(l);return Ammo.destroy(l),Ammo.destroy(r),u},i.destroyBody=function(t){var e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)},i.raycastFirst=function(t,e,n){if(n===void 0&&(n={}),n.filterTags||n.filterCallback)return n.sort=!0,this.raycastAll(t,e,n)[0]||null;var r=null;ci.setValue(t.x,t.y,t.z),hi.setValue(e.x,e.y,e.z);var s=new Ammo.ClosestRayResultCallback(ci,hi);if(typeof n.filterCollisionGroup=="number"&&s.set_m_collisionFilterGroup(n.filterCollisionGroup),typeof n.filterCollisionMask=="number"&&s.set_m_collisionFilterMask(n.filterCollisionMask),this.dynamicsWorld.rayTest(ci,hi,s),s.hasHit()){var l=s.get_m_collisionObject(),u=Ammo.castObject(l,Ammo.btRigidBody);if(u){var c=s.get_m_hitPointWorld(),h=s.get_m_hitNormalWorld();r=new op(u.entity,new E(c.x(),c.y(),c.z()),new E(h.x(),h.y(),h.z()),s.get_m_closestHitFraction())}}return Ammo.destroy(s),r},i.raycastAll=function(t,e,n){n===void 0&&(n={});var r=[];ci.setValue(t.x,t.y,t.z),hi.setValue(e.x,e.y,e.z);var s=new Ammo.AllHitsRayResultCallback(ci,hi);if(typeof n.filterCollisionGroup=="number"&&s.set_m_collisionFilterGroup(n.filterCollisionGroup),typeof n.filterCollisionMask=="number"&&s.set_m_collisionFilterMask(n.filterCollisionMask),this.dynamicsWorld.rayTest(ci,hi,s),s.hasHit()){for(var l=s.get_m_collisionObjects(),u=s.get_m_hitPointWorld(),c=s.get_m_hitNormalWorld(),h=s.get_m_hitFractions(),f=l.size(),d=0;d<f;d++){var p=Ammo.castObject(l.at(d),Ammo.btRigidBody);if(p&&p.entity){if(n.filterTags&&!(_=p.entity.tags).has.apply(_,[].concat(n.filterTags))||n.filterCallback&&!n.filterCallback(p.entity))continue;var _,g=u.at(d),y=c.at(d),v=new op(p.entity,new E(g.x(),g.y(),g.z()),new E(y.x(),y.y(),y.z()),h.at(d));r.push(v)}}n.sort&&r.sort(function(x,S){return x.hitFraction-S.hitFraction})}return Ammo.destroy(s),r},i._storeCollision=function(t,e){var n=!1,r=t.getGuid();return this.collisions[r]=this.collisions[r]||{others:[],entity:t},0>this.collisions[r].others.indexOf(e)&&(this.collisions[r].others.push(e),n=!0),this.frameCollisions[r]=this.frameCollisions[r]||{others:[],entity:t},this.frameCollisions[r].others.push(e),n},i._createContactPointFromAmmo=function(t){var e=t.get_m_localPointA(),n=t.get_m_localPointB(),r=t.getPositionWorldOnA(),s=t.getPositionWorldOnB(),l=t.get_m_normalWorldOnB(),u=this.contactPointPool.allocate();return u.localPoint.set(e.x(),e.y(),e.z()),u.localPointOther.set(n.x(),n.y(),n.z()),u.point.set(r.x(),r.y(),r.z()),u.pointOther.set(s.x(),s.y(),s.z()),u.normal.set(l.x(),l.y(),l.z()),u.impulse=t.getAppliedImpulse(),u},i._createReverseContactPointFromAmmo=function(t){var e=t.get_m_localPointA(),n=t.get_m_localPointB(),r=t.getPositionWorldOnA(),s=t.getPositionWorldOnB(),l=t.get_m_normalWorldOnB(),u=this.contactPointPool.allocate();return u.localPointOther.set(e.x(),e.y(),e.z()),u.localPoint.set(n.x(),n.y(),n.z()),u.pointOther.set(r.x(),r.y(),r.z()),u.point.set(s.x(),s.y(),s.z()),u.normal.set(l.x(),l.y(),l.z()),u.impulse=t.getAppliedImpulse(),u},i._createSingleContactResult=function(t,e,n){var r=this.singleContactResultPool.allocate();return r.a=t,r.b=e,r.localPointA=n.localPoint,r.localPointB=n.localPointOther,r.pointA=n.point,r.pointB=n.pointOther,r.normal=n.normal,r.impulse=n.impulse,r},i._createContactResult=function(t,e){var n=this.contactResultPool.allocate();return n.other=t,n.contacts=e,n},i._cleanOldCollisions=function(){for(var t in this.collisions)if(this.collisions.hasOwnProperty(t)){for(var e=this.frameCollisions[t],n=this.collisions[t],r=n.entity,s=r.collision,l=r.rigidbody,u=n.others,c=u.length;c--;){var h=u[c];(!e||0>e.others.indexOf(h))&&(u.splice(c,1),r.trigger?(s&&s.fire("triggerleave",h),h.rigidbody&&h.rigidbody.fire("triggerleave",r)):!h.trigger&&(l&&l.fire("collisionend",h),s&&s.fire("collisionend",h)))}u.length===0&&delete this.collisions[t]}},i._hasContactEvent=function(t){var e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;var n=t.rigidbody;return n&&(n.hasEvent("collisionstart")||n.hasEvent("collisionend")||n.hasEvent("contact"))},i._checkForCollisions=function(t,e){var n=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),r=n.getNumManifolds();this.frameCollisions={};for(var s=0;s<r;s++){var l=n.getManifoldByIndexInternal(s),u=l.getBody0(),c=l.getBody1(),h=Ammo.castObject(u,Ammo.btRigidBody),f=Ammo.castObject(c,Ammo.btRigidBody),d=h.entity,p=f.entity;if(d&&p){var _=h.getCollisionFlags(),g=f.getCollisionFlags(),y=l.getNumContacts(),v=[],x=[],S=void 0;if(y>0)if(4&_||4&g){var T=d.collision&&(d.collision.hasEvent("triggerenter")||d.collision.hasEvent("triggerleave")),b=p.collision&&(p.collision.hasEvent("triggerenter")||p.collision.hasEvent("triggerleave")),w=d.rigidbody&&(d.rigidbody.hasEvent("triggerenter")||d.rigidbody.hasEvent("triggerleave")),A=p.rigidbody&&(p.rigidbody.hasEvent("triggerenter")||p.rigidbody.hasEvent("triggerleave"));T&&(S=this._storeCollision(d,p))&&!(4&g)&&d.collision.fire("triggerenter",p),b&&(S=this._storeCollision(p,d))&&!(4&_)&&p.collision.fire("triggerenter",d),w&&(S||(S=this._storeCollision(p,d)),S&&d.rigidbody.fire("triggerenter",p)),A&&(S||(S=this._storeCollision(d,p)),S&&p.rigidbody.fire("triggerenter",d))}else{var C=this._hasContactEvent(d),L=this._hasContactEvent(p),I=this.hasEvent("contact");if(I||C||L){for(var P=0;P<y;P++){var M=l.getContactPoint(P),R=this._createContactPointFromAmmo(M);if(C||L){v.push(R);var k=this._createReverseContactPointFromAmmo(M);x.push(k)}if(I){var D=this._createSingleContactResult(d,p,R);this.fire("contact",D)}}if(C){var O=this._createContactResult(p,v);S=this._storeCollision(d,p),d.collision&&(d.collision.fire("contact",O),S&&d.collision.fire("collisionstart",O)),d.rigidbody&&(d.rigidbody.fire("contact",O),S&&d.rigidbody.fire("collisionstart",O))}if(L){var F=this._createContactResult(d,x);S=this._storeCollision(p,d),p.collision&&(p.collision.fire("contact",F),S&&p.collision.fire("collisionstart",F)),p.rigidbody&&(p.rigidbody.fire("contact",F),S&&p.rigidbody.fire("collisionstart",F))}}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()},i.onUpdate=function(t){this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;var e,n,r=this.dynamicsWorld.getGravity();(r.x()!==this._gravityFloat32[0]||r.y()!==this._gravityFloat32[1]||r.z()!==this._gravityFloat32[2])&&(r.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(r));var s=this._triggers;for(e=0,n=s.length;e<n;e++)s[e].updateTransform();var l=this._compounds;for(e=0,n=l.length;e<n;e++)l[e]._updateCompound();var u=this._kinematic;for(e=0,n=u.length;e<n;e++)u[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);var c=this._dynamic;for(e=0,n=c.length;e<n;e++)c[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this),typeof Ammo<"u"&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(ci),Ammo.destroy(hi),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,ci=null,hi=null,tn.onAppDestroy())},a}(We);Ec.EVENT_CONTACT="contact",de._buildAccessors(tn.prototype,fb);var us="none",db="blend";function pb(o,a){return(pb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var mb=new X,lp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._resolution=new G(640,320),r._referenceResolution=new G(640,320),r._scaleMode=us,r.scale=1,r._scaleBlend=.5,r._priority=0,r._screenSpace=!1,r.cull=r._screenSpace,r._screenMatrix=new X,r._elements=new Set,e.app.graphicsDevice.on("resizecanvas",r._onResize,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&pb(a,o);var i,t=a.prototype;return t.syncDrawOrder=function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},t._recurseDrawOrderSync=function(e,n){if(ve!=null&&typeof Symbol<"u"&&ve[Symbol.hasInstance]?!ve[Symbol.hasInstance](e):!Q(e,ve))return n;if(e.element){var r,s=e.element.drawOrder;e.element.drawOrder=n++,e.element._batchGroupId>=0&&s!==e.element.drawOrder&&((r=this.system.app.batcher)==null||r.markGroupDirty(e.element._batchGroupId))}e.particlesystem&&(e.particlesystem.drawOrder=n++);for(var l=e.children,u=0;u<l.length;u++)n=this._recurseDrawOrderSync(l[u],n);return n},t._processDrawOrderSync=function(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")},t._calcProjectionMatrix=function(){var e=this._resolution.x/this.scale,n=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,e,-n,0,1,-1),this._screenSpace||(mb.setScale(.5*e,.5*n,1),this._screenMatrix.mul2(mb,this._screenMatrix))},t._updateScale=function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},t._calcScale=function(e,n){var r=Math.log2((e.x||1)/n.x),s=Math.log2((e.y||1)/n.y);return Math.pow(2,r*(1-this._scaleBlend)+s*this._scaleBlend)},t._onResize=function(e,n){this._screenSpace&&(this._resolution.set(e,n),this.resolution=this._resolution)},t._bindElement=function(e){this._elements.add(e)},t._unbindElement=function(e){this._elements.delete(e)},t.onRemove=function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(function(e){return e._onScreenRemove()}),this._elements.clear(),this.off()},i=[{key:"resolution",get:function(){return this._resolution},set:function(e){var n=this;this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(function(r){return r._onScreenResize(n._resolution)})}},{key:"referenceResolution",get:function(){return this._scaleMode===us?this._resolution:this._referenceResolution},set:function(e){var n=this;this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(function(r){return r._onScreenResize(n._resolution)})}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(function(n){return n._onScreenSpaceChange()})}},{key:"scaleMode",get:function(){return this._scaleMode},set:function(e){e!==us&&e!==db&&(e=us),this._screenSpace||e===us||(e=us),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}},{key:"scaleBlend",get:function(){return this._scaleBlend},set:function(e){var n=this;this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(function(r){return r._onScreenResize(n._resolution)})}},{key:"priority",get:function(){return this._priority},set:function(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),mD=function(){this.enabled=!0};function _b(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function vb(o,a){return(vb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var up=["enabled"],gb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="screen",e.ComponentType=lp,e.DataType=mD,e.schema=up,e.windowResolution=new G,e._drawOrderSyncQueue=new qm,e.app.graphicsDevice.on("resizecanvas",e._onResize,e),e.app.systems.on("update",e._onUpdate,e),e.on("beforeremove",e.onRemoveComponent,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&vb(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){e.priority!==void 0&&(t.priority=e.priority),e.screenSpace!==void 0&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,e.scaleMode!==void 0&&(t.scaleMode=e.scaleMode),e.scaleBlend!==void 0&&(t.scaleBlend=e.scaleBlend),e.resolution!==void 0&&(_b(e.resolution,G)?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),e.referenceResolution!==void 0&&(_b(e.referenceResolution,G)?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),o.prototype.initializeComponentData.call(this,t,e,up)},i.destroy=function(){o.prototype.destroy.call(this),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)},i._onUpdate=function(t){var e=this.store;for(var n in e)e[n].entity.screen.update&&e[n].entity.screen.update(t)},i._onResize=function(t,e){this.windowResolution.x=t,this.windowResolution.y=e},i.cloneComponent=function(t,e){var n=t.screen;return this.addComponent(e,{enabled:n.enabled,screenSpace:n.screenSpace,scaleMode:n.scaleMode,resolution:n.resolution.clone(),referenceResolution:n.referenceResolution.clone()})},i.onRemoveComponent=function(t,e){e.onRemove()},i.processDrawOrderSyncQueue=function(){for(var t=this._drawOrderSyncQueue.list(),e=0;e<t.length;e++){var n=t[e];n.callback.call(n.scope)}this._drawOrderSyncQueue.clear()},i.queueDrawOrderSync=function(t,e,n){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:n})},a}(We);function yb(o,a){return(yb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}de._buildAccessors(lp.prototype,up);var vr=new G,Sb=new E,cs=new Gn,xb=new Yl,bb=new E,vl=new E,_D=new Z,vD={x:"y",y:"x"},Ea=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;if(r=o.call(this)||this,!e||(_t!=null&&typeof Symbol<"u"&&_t[Symbol.hasInstance]?!_t[Symbol.hasInstance](e):!Q(e,_t)))throw Error("Element was null or not an ElementComponent");if(n&&n!=="x"&&n!=="y")throw Error("Unrecognized axis: "+n);return r._element=e,r._app=e.system.app,r._axis=n||null,r._enabled=!0,r._dragScale=new E,r._dragStartMousePosition=new E,r._dragStartHandlePosition=new E,r._deltaMousePosition=new E,r._deltaHandlePosition=new E,r._isDragging=!1,r._toggleLifecycleListeners("on"),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&yb(a,o);var i,t=a.prototype;return t._toggleLifecycleListeners=function(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this)},t._toggleDragListeners=function(e){var n=e==="on";this._hasDragListeners&&n||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),fe.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=n)},t._onMouseDownOrTouchStart=function(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();var n=this._screenToLocal(e);n&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(n),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}},t._onMouseUpOrTouchEnd=function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},t._screenToLocal=function(e){return e.inputSource?cs.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),bb.copy(this._element.entity.forward).mulScalar(-1),xb.setFromPointNormal(this._element.entity.getPosition(),bb),xb.intersectsRay(cs,vl)?(_D.copy(this._element.entity.getRotation()).invert().transformVector(vl,vl),vl.mul(this._dragScale),vl):null},t._determineInputPosition=function(e){var n=this._app.graphicsDevice.maxPixelRatio;e.x!==void 0&&e.y!==void 0?(vr.x=e.x*n,vr.y=e.y*n):e.changedTouches&&(vr.x=e.changedTouches[0].x*n,vr.y=e.changedTouches[0].y*n)},t._chooseRayOriginAndDirection=function(){this._element.screen&&this._element.screen.screen.screenSpace?(cs.origin.set(vr.x,-vr.y,0),cs.direction.copy(E.FORWARD)):(Sb.copy(this._dragCamera.screenToWorld(vr.x,vr.y,1)),cs.origin.copy(this._dragCamera.entity.getPosition()),cs.direction.copy(Sb).sub(cs.origin).normalize())},t._calculateDragScale=function(){var e=this._element.entity.parent,n=this._element.screen&&this._element.screen.screen,r=n&&n.screenSpace,s=r?n.scale:1,l=this._dragScale;for(l.set(s,s,s);e&&(l.mul(e.getLocalScale()),e=e.parent,!r||!e.screen););l.x=1/l.x,l.y=1/l.y,l.z=0},t._onMove=function(e){var n=this._element,r=this._deltaMousePosition,s=this._deltaHandlePosition,l=this._axis;if(n&&this._isDragging&&this.enabled&&n.enabled&&n.entity.enabled){var u=this._screenToLocal(e);if(u){if(r.sub2(u,this._dragStartMousePosition),s.add2(this._dragStartHandlePosition,r),l){var c=n.entity.getLocalPosition(),h=vD[l];s[h]=c[h]}n.entity.setLocalPosition(s),this.fire("drag:move",s)}}},t.destroy=function(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")},i=[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"isDragging",get:function(){return this._isDragging}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function wc(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Tb(o,a){return(Tb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Ea.EVENT_DRAGSTART="drag:start",Ea.EVENT_DRAGEND="drag:end",Ea.EVENT_DRAGMOVE="drag:move";var gl=new G,cp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._viewportEntity=null,r._contentEntity=null,r._horizontalScrollbarEntity=null,r._verticalScrollbarEntity=null,r._evtElementRemove=null,r._evtViewportElementRemove=null,r._evtViewportResize=null,r._evtContentEntityElementAdd=null,r._evtContentElementRemove=null,r._evtContentResize=null,r._evtHorizontalScrollbarAdd=null,r._evtHorizontalScrollbarRemove=null,r._evtHorizontalScrollbarValue=null,r._evtVerticalScrollbarAdd=null,r._evtVerticalScrollbarRemove=null,r._evtVerticalScrollbarValue=null,r._scrollbarUpdateFlags={},r._scrollbarEntities={},r._prevContentSizes={},r._prevContentSizes[0]=null,r._prevContentSizes[1]=null,r._scroll=new G,r._velocity=new E,r._dragStartPosition=new E,r._disabledContentInput=!1,r._disabledContentInputEntities=[],r._toggleLifecycleListeners("on"),r._toggleElementListeners("on"),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Tb(a,o);var i,t=a.prototype;return t._setValue=function(e,n){var r=this.data,s=r[e];r[e]=n,this.fire("set",e,s,n)},t._toggleLifecycleListeners=function(e){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),this.entity[e]("element:add",this._onElementComponentAdd,this)},t._toggleElementListeners=function(e){this.entity.element&&(e==="on"&&this._hasElementListeners||(this.entity.element[e]("resize",this._syncAll,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners=e==="on"))},t._onElementComponentAdd=function(e){this._evtElementRemove=this.entity.element.once("beforeremove",this._onElementComponentRemove,this),this._toggleElementListeners("on")},t._onElementComponentRemove=function(e){var n;(n=this._evtElementRemove)==null||n.off(),this._evtElementRemove=null,this._toggleElementListeners("off")},t._viewportEntitySubscribe=function(){this._evtViewportEntityElementAdd=this._viewportEntity.on("element:add",this._onViewportElementGain,this),this._viewportEntity.element&&this._onViewportElementGain()},t._viewportEntityUnsubscribe=function(){var e,n;(e=this._evtViewportEntityElementAdd)==null||e.off(),this._evtViewportEntityElementAdd=null,(n=this._viewportEntity)!=null&&n.element&&this._onViewportElementLose()},t._viewportEntityElementSubscribe=function(){var e=this._viewportEntity.element;this._evtViewportElementRemove=e.once("beforeremove",this._onViewportElementLose,this),this._evtViewportResize=e.on("resize",this._syncAll,this)},t._viewportEntityElementUnsubscribe=function(){var e,n;(e=this._evtViewportElementRemove)==null||e.off(),this._evtViewportElementRemove=null,(n=this._evtViewportResize)==null||n.off(),this._evtViewportResize=null},t._onViewportElementGain=function(){this._viewportEntityElementSubscribe(),this._syncAll()},t._onViewportElementLose=function(){this._viewportEntityElementUnsubscribe()},t._contentEntitySubscribe=function(){this._evtContentEntityElementAdd=this._contentEntity.on("element:add",this._onContentElementGain,this),this._contentEntity.element&&this._onContentElementGain()},t._contentEntityUnsubscribe=function(){var e,n;(e=this._evtContentEntityElementAdd)==null||e.off(),this._evtContentEntityElementAdd=null,(n=this._contentEntity)!=null&&n.element&&this._onContentElementLose()},t._contentEntityElementSubscribe=function(){var e=this._contentEntity.element;this._evtContentElementRemove=e.once("beforeremove",this._onContentElementLose,this),this._evtContentResize=e.on("resize",this._syncAll,this)},t._contentEntityElementUnsubscribe=function(){var e,n;(e=this._evtContentElementRemove)==null||e.off(),this._evtContentElementRemove=null,(n=this._evtContentResize)==null||n.off(),this._evtContentResize=null},t._onContentElementGain=function(){this._contentEntityElementSubscribe(),this._destroyDragHelper(),this._contentDragHelper=new Ea(this._contentEntity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()},t._onContentElementLose=function(){this._contentEntityElementUnsubscribe(),this._destroyDragHelper()},t._onContentDragStart=function(){this._contentEntity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentEntity.getLocalPosition())},t._onContentDragEnd=function(){this._prevContentDragPosition=null,this._enableContentInput()},t._onContentDragMove=function(e){if(this._contentEntity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){var n=e.x-this._dragStartPosition.x,r=e.y-this._dragStartPosition.y;(Math.abs(n)>this.dragThreshold||Math.abs(r)>this.dragThreshold)&&this._disableContentInput()}},t._horizontalScrollbarEntitySubscribe=function(){this._evtHorizontalScrollbarAdd=this._horizontalScrollbarEntity.on("scrollbar:add",this._onHorizontalScrollbarGain,this),this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarGain()},t._verticalScrollbarEntitySubscribe=function(){this._evtVerticalScrollbarAdd=this._verticalScrollbarEntity.on("scrollbar:add",this._onVerticalScrollbarGain,this),this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarGain()},t._horizontalScrollbarEntityUnsubscribe=function(){var e;(e=this._evtHorizontalScrollbarAdd)==null||e.off(),this._evtHorizontalScrollbarAdd=null,this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarLose()},t._verticalScrollbarEntityUnsubscribe=function(){var e;(e=this._evtVerticalScrollbarAdd)==null||e.off(),this._evtVerticalScrollbarAdd=null,this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarLose()},t._onSetHorizontalScrollbarValue=function(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)},t._onSetVerticalScrollbarValue=function(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)},t._onHorizontalScrollbarGain=function(){var e,n=(e=this._horizontalScrollbarEntity)==null?void 0:e.scrollbar;this._evtHorizontalScrollbarRemove=n.on("beforeremove",this._onHorizontalScrollbarLose,this),this._evtHorizontalScrollbarValue=n.on("set:value",this._onSetHorizontalScrollbarValue,this),this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)},t._onVerticalScrollbarGain=function(){var e,n=(e=this._verticalScrollbarEntity)==null?void 0:e.scrollbar;this._evtVerticalScrollbarRemove=n.on("beforeremove",this._onVerticalScrollbarLose,this),this._evtVerticalScrollbarValue=n.on("set:value",this._onSetVerticalScrollbarValue,this),this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)},t._onHorizontalScrollbarLose=function(){var e,n;(e=this._evtHorizontalScrollbarRemove)==null||e.off(),this._evtHorizontalScrollbarRemove=null,(n=this._evtHorizontalScrollbarValue)==null||n.off(),this._evtHorizontalScrollbarValue=null},t._onVerticalScrollbarLose=function(){var e,n;(e=this._evtVerticalScrollbarRemove)==null||e.off(),this._evtVerticalScrollbarRemove=null,(n=this._evtVerticalScrollbarValue)==null||n.off(),this._evtVerticalScrollbarValue=null},t._onSetHorizontalScrollingEnabled=function(){this._syncScrollbarEnabledState(0)},t._onSetVerticalScrollingEnabled=function(){this._syncScrollbarEnabledState(1)},t._onSetScroll=function(e,n,r){r!==!1&&this._velocity.set(0,0,0);var s=this._updateAxis(e,"x",0),l=this._updateAxis(n,"y",1);(s||l)&&this.fire("set:scroll",this._scroll)},t._updateAxis=function(e,n,r){var s=e!==null&&Math.abs(e-this._scroll[n])>1e-5;return(s||this._isDragging()||e===0)&&(this._scroll[n]=this._determineNewScrollValue(e,n,r),this._syncContentPosition(r),this._syncScrollbarPosition(r)),s},t._determineNewScrollValue=function(e,n,r){if(!this._getScrollingEnabled(r))return this._scroll[n];switch(this.scrollMode){case 0:return U.clamp(e,0,this._getMaxScrollValue(r));case 1:return this._setVelocityFromOvershoot(e,n,r),e;default:return e}},t._syncAll=function(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)},t._syncContentPosition=function(e){if(this._contentEntity){var n=this._getAxis(e),r=this._getSign(e),s=this._prevContentSizes[e],l=this._getContentSize(e);if(s!==null&&Math.abs(s-l)>1e-4){var u=this._getMaxOffset(e,s),c=this._getMaxOffset(e,l);c===0?this._scroll[n]=1:this._scroll[n]=U.clamp(this._scroll[n]*u/c,0,1)}var h=this._scroll[n]*this._getMaxOffset(e),f=this._contentEntity.getLocalPosition();f[n]=h*r,this._contentEntity.setLocalPosition(f),this._prevContentSizes[e]=l}},t._syncScrollbarPosition=function(e){var n=this._scrollbarEntities[e];if(n!=null&&n.scrollbar){var r=this._getAxis(e);this._scrollbarUpdateFlags[e]=!0,n.scrollbar.value=this._scroll[r],n.scrollbar.handleSize=this._getScrollbarHandleSize(r,e),this._scrollbarUpdateFlags[e]=!1}},t._syncScrollbarEnabledState=function(e){var n=this._scrollbarEntities[e];if(n){var r=this._getScrollingEnabled(e);switch(this._getScrollbarVisibility(e)){case 0:n.enabled=r;return;case 1:n.enabled=r&&this._contentIsLargerThanViewport(e);return;default:n.enabled=r}}},t._contentIsLargerThanViewport=function(e){return this._getContentSize(e)>this._getViewportSize(e)},t._contentPositionToScrollValue=function(e){var n=this._getMaxOffset(0),r=this._getMaxOffset(1);return n===0?gl.x=0:gl.x=e.x/n,r===0?gl.y=0:gl.y=-(e.y/r),gl},t._getMaxOffset=function(e,n){n=n===void 0?this._getContentSize(e):n;var r=this._getViewportSize(e);return n<r?-this._getViewportSize(e):r-n},t._getMaxScrollValue=function(e){return+!!this._contentIsLargerThanViewport(e)},t._getScrollbarHandleSize=function(e,n){var r=this._getViewportSize(n),s=this._getContentSize(n);if(.001>Math.abs(s))return 1;var l=Math.min(r/s,1),u=this._toOvershoot(this._scroll[e],n);return u===0?l:l/(1+Math.abs(u))},t._getViewportSize=function(e){return this._getSize(e,this._viewportEntity)},t._getContentSize=function(e){return this._getSize(e,this._contentEntity)},t._getSize=function(e,n){return n!=null&&n.element?n.element[this._getCalculatedDimension(e)]:0},t._getScrollingEnabled=function(e){return e===0?this.horizontal:e===1?this.vertical:void 0},t._getScrollbarVisibility=function(e){return e===0?this.horizontalScrollbarVisibility:e===1?this.verticalScrollbarVisibility:void 0},t._getSign=function(e){return e===0?1:-1},t._getAxis=function(e){return e===0?"x":"y"},t._getCalculatedDimension=function(e){return e===0?"calculatedWidth":"calculatedHeight"},t._destroyDragHelper=function(){this._contentDragHelper&&this._contentDragHelper.destroy()},t.onUpdate=function(){this._contentEntity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))},t._updateVelocity=function(){if(!this._isDragging()){if(this.scrollMode===1&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){var e=this._contentEntity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentEntity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}},t._hasOvershoot=function(e,n){return Math.abs(this._toOvershoot(this.scroll[e],n))>.001},t._toOvershoot=function(e,n){var r=this._getMaxScrollValue(n);return e<0?e:e>r?e-r:0},t._setVelocityFromOvershoot=function(e,n,r){var s=this._toOvershoot(e,r)*this._getMaxOffset(r)*this._getSign(r);Math.abs(s)>0&&(this._velocity[n]=-s/(50*this.bounceAmount+1))},t._setVelocityFromContentPositionDelta=function(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())},t._setScrollFromContentPosition=function(e){var n=this._contentPositionToScrollValue(e);this._isDragging()&&(n=this._applyScrollValueTension(n)),this._onSetScroll(n.x,n.y,!1)},t._applyScrollValueTension=function(e){var n=this._getMaxScrollValue(0),r=this._toOvershoot(e.x,0);return r>0?e.x=n+ +Math.log10(1+r):r<0&&(e.x=-1*Math.log10(1-r)),n=this._getMaxScrollValue(1),(r=this._toOvershoot(e.y,1))>0?e.y=n+ +Math.log10(1+r):r<0&&(e.y=-1*Math.log10(1-r)),e},t._isDragging=function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},t._setScrollbarComponentsEnabled=function(e){var n,r;(n=this._horizontalScrollbarEntity)!=null&&n.scrollbar&&(this._horizontalScrollbarEntity.scrollbar.enabled=e),(r=this._verticalScrollbarEntity)!=null&&r.scrollbar&&(this._verticalScrollbarEntity.scrollbar.enabled=e)},t._setContentDraggingEnabled=function(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)},t._onMouseWheel=function(e){if(this.useMouseWheel&&((n=this._contentEntity)!=null&&n.element)){var n,r=e.event,s=r.deltaX/this._contentEntity.element.calculatedWidth*this.mouseWheelSensitivity.x,l=r.deltaY/this._contentEntity.element.calculatedHeight*this.mouseWheelSensitivity.y,u=U.clamp(this._scroll.x+s,0,this._getMaxScrollValue(0)),c=U.clamp(this._scroll.y+l,0,this._getMaxScrollValue(1));this.scroll=new G(u,c)}},t._enableContentInput=function(){for(;this._disabledContentInputEntities.length;){var e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1},t._disableContentInput=function(){var e=this,n=function(u){u.element&&u.element.useInput&&(e._disabledContentInputEntities.push(u),u.element.useInput=!1);for(var c=u.children,h=0,f=c.length;h<f;h++)n(c[h])};if(this._contentEntity)for(var r=this._contentEntity.children,s=0,l=r.length;s<l;s++)n(r[s]);this._disabledContentInput=!0},t.onEnable=function(){this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()},t.onDisable=function(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)},t.onRemove=function(){this._toggleLifecycleListeners("off"),this._toggleElementListeners("off"),this._destroyDragHelper()},t.resolveDuplicatedEntityReferenceProperties=function(e,n){e.viewportEntity&&(this.viewportEntity=n[e.viewportEntity.getGuid()]),e.contentEntity&&(this.contentEntity=n[e.contentEntity.getGuid()]),e.horizontalScrollbarEntity&&(this.horizontalScrollbarEntity=n[e.horizontalScrollbarEntity.getGuid()]),e.verticalScrollbarEntity&&(this.verticalScrollbarEntity=n[e.verticalScrollbarEntity.getGuid()])},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e)}},{key:"horizontal",get:function(){return this.data.horizontal},set:function(e){this._setValue("horizontal",e)}},{key:"vertical",get:function(){return this.data.vertical},set:function(e){this._setValue("vertical",e)}},{key:"scrollMode",get:function(){return this.data.scrollMode},set:function(e){this._setValue("scrollMode",e)}},{key:"bounceAmount",get:function(){return this.data.bounceAmount},set:function(e){this._setValue("bounceAmount",e)}},{key:"friction",get:function(){return this.data.friction},set:function(e){this._setValue("friction",e)}},{key:"dragThreshold",get:function(){return this.data.dragThreshold},set:function(e){this._setValue("dragThreshold",e)}},{key:"useMouseWheel",get:function(){return this.data.useMouseWheel},set:function(e){this._setValue("useMouseWheel",e)}},{key:"mouseWheelSensitivity",get:function(){return this.data.mouseWheelSensitivity},set:function(e){this._setValue("mouseWheelSensitivity",e)}},{key:"horizontalScrollbarVisibility",get:function(){return this.data.horizontalScrollbarVisibility},set:function(e){this._setValue("horizontalScrollbarVisibility",e)}},{key:"verticalScrollbarVisibility",get:function(){return this.data.verticalScrollbarVisibility},set:function(e){this._setValue("verticalScrollbarVisibility",e)}},{key:"viewportEntity",get:function(){return this._viewportEntity},set:function(e){if(this._viewportEntity!==e){var n=typeof e=="string";(!this._viewportEntity||!n||this._viewportEntity.getGuid()!==e)&&(this._viewportEntity&&this._viewportEntityUnsubscribe(),wc(e,pe)?this._viewportEntity=e:n?this._viewportEntity=this.system.app.getEntityFromIndex(e)||null:this._viewportEntity=null,this._viewportEntity&&this._viewportEntitySubscribe(),this._viewportEntity?this.data.viewportEntity=this._viewportEntity.getGuid():n&&e&&(this.data.viewportEntity=e))}}},{key:"contentEntity",get:function(){return this._contentEntity},set:function(e){if(this._contentEntity!==e){var n=typeof e=="string";(!this._contentEntity||!n||this._contentEntity.getGuid()!==e)&&(this._contentEntity&&this._contentEntityUnsubscribe(),wc(e,pe)?this._contentEntity=e:n?this._contentEntity=this.system.app.getEntityFromIndex(e)||null:this._contentEntity=null,this._contentEntity&&this._contentEntitySubscribe(),this._contentEntity?this.data.contentEntity=this._contentEntity.getGuid():n&&e&&(this.data.contentEntity=e))}}},{key:"horizontalScrollbarEntity",get:function(){return this._horizontalScrollbarEntity},set:function(e){if(this._horizontalScrollbarEntity!==e){var n=typeof e=="string";(!this._horizontalScrollbarEntity||!n||this._horizontalScrollbarEntity.getGuid()!==e)&&(this._horizontalScrollbarEntity&&this._horizontalScrollbarEntityUnsubscribe(),wc(e,pe)?this._horizontalScrollbarEntity=e:n?this._horizontalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._horizontalScrollbarEntity=null,this._scrollbarEntities[0]=this._horizontalScrollbarEntity,this._horizontalScrollbarEntity&&this._horizontalScrollbarEntitySubscribe(),this._horizontalScrollbarEntity?this.data.horizontalScrollbarEntity=this._horizontalScrollbarEntity.getGuid():n&&e&&(this.data.horizontalScrollbarEntity=e))}}},{key:"verticalScrollbarEntity",get:function(){return this._verticalScrollbarEntity},set:function(e){if(this._verticalScrollbarEntity!==e){var n=typeof e=="string";(!this._verticalScrollbarEntity||!n||this._verticalScrollbarEntity.getGuid()!==e)&&(this._verticalScrollbarEntity&&this._verticalScrollbarEntityUnsubscribe(),wc(e,pe)?this._verticalScrollbarEntity=e:n?this._verticalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._verticalScrollbarEntity=null,this._scrollbarEntities[1]=this._verticalScrollbarEntity,this._verticalScrollbarEntity&&this._verticalScrollbarEntitySubscribe(),this._verticalScrollbarEntity?this.data.verticalScrollbarEntity=this._verticalScrollbarEntity.getGuid():n&&e&&(this.data.verticalScrollbarEntity=e))}}},{key:"scroll",get:function(){return this._scroll},set:function(e){this._onSetScroll(e.x,e.y)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);cp.EVENT_SETSCROLL="set:scroll";var gD=function(){this.enabled=!0,this.dragThreshold=10,this.useMouseWheel=!0,this.mouseWheelSensitivity=new G(1,1),this.horizontalScrollbarVisibility=0,this.verticalScrollbarVisibility=0,this.viewportEntity=null,this.contentEntity=null,this.horizontalScrollbarEntity=null,this.verticalScrollbarEntity=null};function Eb(o,a){return(Eb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var wb=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"}],Ab=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="scrollview",e.ComponentType=cp,e.DataType=gD,e.schema=wb,e.on("beforeremove",e._onRemoveComponent,e),e.app.systems.on("update",e.onUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Eb(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){e.dragThreshold===void 0&&(e.dragThreshold=10),e.useMouseWheel===void 0&&(e.useMouseWheel=!0),e.mouseWheelSensitivity===void 0&&(e.mouseWheelSensitivity=new G(1,1)),o.prototype.initializeComponentData.call(this,t,e,wb),t.viewportEntity=e.viewportEntity,t.contentEntity=e.contentEntity,t.horizontalScrollbarEntity=e.horizontalScrollbarEntity,t.verticalScrollbarEntity=e.verticalScrollbarEntity},i.onUpdate=function(t){var e=this.store;for(var n in e){var r=e[n].entity,s=r.scrollview;s.enabled&&r.enabled&&s.onUpdate()}},i._onRemoveComponent=function(t,e){e.onRemove()},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this)},a}(We);function Cb(o,a){return(Cb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var hp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._handleEntity=null,r._evtHandleEntityElementAdd=null,r._evtHandleEntityChanges=[],r._toggleLifecycleListeners("on"),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Cb(a,o);var i,t=a.prototype;return t._setValue=function(e,n){var r=this.data,s=r[e];r[e]=n,this.fire("set",e,s,n)},t._toggleLifecycleListeners=function(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)},t._handleEntitySubscribe=function(){this._evtHandleEntityElementAdd=this._handleEntity.on("element:add",this._onHandleElementGain,this),this._handleEntity.element&&this._onHandleElementGain()},t._handleEntityUnsubscribe=function(){var e,n;(e=this._evtHandleEntityElementAdd)==null||e.off(),this._evtHandleEntityElementAdd=null,(n=this._handleEntity)!=null&&n.element&&this._onHandleElementLose()},t._handleEntityElementSubscribe=function(){var e=this._handleEntity.element,n=this._evtHandleEntityChanges;n.push(e.once("beforeremove",this._onHandleElementLose,this)),n.push(e.on("set:anchor",this._onSetHandleAlignment,this)),n.push(e.on("set:margin",this._onSetHandleAlignment,this)),n.push(e.on("set:pivot",this._onSetHandleAlignment,this))},t._handleEntityElementUnsubscribe=function(){for(var e=0;e<this._evtHandleEntityChanges.length;e++)this._evtHandleEntityChanges[e].off();this._evtHandleEntityChanges.length=0},t._onHandleElementGain=function(){this._handleEntityElementSubscribe(),this._destroyDragHelper(),this._handleDragHelper=new Ea(this._handleEntity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()},t._onHandleElementLose=function(){this._handleEntityElementUnsubscribe(),this._destroyDragHelper()},t._onHandleDrag=function(e){this._handleEntity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))},t._onSetValue=function(e,n,r){Math.abs(r-n)>1e-5&&(this.data.value=U.clamp(r,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},t._onSetHandleSize=function(e,n,r){Math.abs(r-n)>1e-5&&(this.data.handleSize=U.clamp(r,0,1),this._updateHandlePositionAndSize())},t._onSetHandleAlignment=function(){this._updateHandlePositionAndSize()},t._onSetOrientation=function(e,n,r){var s;r!==n&&((s=this._handleEntity)!=null&&s.element)&&(this._handleEntity.element[this._getOppositeDimension()]=0)},t._updateHandlePositionAndSize=function(){var e=this._handleEntity,n=e==null?void 0:e.element;if(e){var r=e.getLocalPosition();r[this._getAxis()]=this._getHandlePosition(),e.setLocalPosition(r)}n&&(n[this._getDimension()]=this._getHandleLength())},t._handlePositionToScrollValue=function(e){return e*this._getSign()/this._getUsableTrackLength()},t._scrollValueToHandlePosition=function(e){return e*this._getSign()*this._getUsableTrackLength()},t._getUsableTrackLength=function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},t._getTrackLength=function(){return this.entity.element?this.orientation===0?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},t._getHandleLength=function(){return this._getTrackLength()*this.handleSize},t._getHandlePosition=function(){return this._scrollValueToHandlePosition(this.value)},t._getSign=function(){return this.orientation===0?1:-1},t._getAxis=function(){return this.orientation===0?"x":"y"},t._getDimension=function(){return this.orientation===0?"width":"height"},t._getOppositeDimension=function(){return this.orientation===0?"height":"width"},t._destroyDragHelper=function(){this._handleDragHelper&&this._handleDragHelper.destroy()},t._setHandleDraggingEnabled=function(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)},t.onEnable=function(){this._setHandleDraggingEnabled(!0)},t.onDisable=function(){this._setHandleDraggingEnabled(!1)},t.onRemove=function(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")},t.resolveDuplicatedEntityReferenceProperties=function(e,n){e.handleEntity&&(this.handleEntity=n[e.handleEntity.getGuid()])},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e)}},{key:"orientation",get:function(){return this.data.orientation},set:function(e){this._setValue("orientation",e)}},{key:"value",get:function(){return this.data.value},set:function(e){this._setValue("value",e)}},{key:"handleSize",get:function(){return this.data.handleSize},set:function(e){this._setValue("handleSize",e)}},{key:"handleEntity",get:function(){return this._handleEntity},set:function(e){if(this._handleEntity!==e){var n=typeof e=="string";(!this._handleEntity||!n||this._handleEntity.getGuid()!==e)&&(this._handleEntity&&this._handleEntityUnsubscribe(),(pe!=null&&typeof Symbol<"u"&&pe[Symbol.hasInstance]?!!pe[Symbol.hasInstance](e):Q(e,pe))?this._handleEntity=e:n?this._handleEntity=this.system.app.getEntityFromIndex(e)||null:this._handleEntity=null,this._handleEntity&&this._handleEntitySubscribe(),this._handleEntity?this.data.handleEntity=this._handleEntity.getGuid():n&&e&&(this.data.handleEntity=e))}}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);hp.EVENT_SETVALUE="set:value";var yD=function(){this.enabled=!0,this.orientation=0,this.value=0,this.handleSize=0,this.handleEntity=null};function Pb(o,a){return(Pb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ib=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"}],Lb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="scrollbar",e.ComponentType=hp,e.DataType=yD,e.schema=Ib,e.on("add",e._onAddComponent,e),e.on("beforeremove",e._onRemoveComponent,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Pb(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){o.prototype.initializeComponentData.call(this,t,e,Ib),t.handleEntity=e.handleEntity},i._onAddComponent=function(t){t.fire("scrollbar:add")},i._onRemoveComponent=function(t,e){e.onRemove()},a}(We);function Db(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Mb(o,a){return(Mb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var vt={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new E,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},nn=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r){var s;return n===void 0&&(n="Untitled"),r===void 0&&(r={}),(s=o.call(this)||this).instances=[],s._component=e,s._assets=e.system.app.assets,s._manager=e.system.manager,s.name=n,s._volume=r.volume!==void 0?U.clamp(Number(r.volume)||0,0,1):1,s._pitch=r.pitch!==void 0?Math.max(.01,Number(r.pitch)||0):1,s._loop=!!(r.loop!==void 0&&r.loop),s._duration=r.duration>0?r.duration:null,s._startTime=Math.max(0,Number(r.startTime)||0),s._overlap=!!r.overlap,s._autoPlay=!!r.autoPlay,s._firstNode=null,s._lastNode=null,s._asset=r.asset,Db(s._asset,$)&&(s._asset=s._asset.id),s._onInstancePlayHandler=s._onInstancePlay.bind(s),s._onInstancePauseHandler=s._onInstancePause.bind(s),s._onInstanceResumeHandler=s._onInstanceResume.bind(s),s._onInstanceStopHandler=s._onInstanceStop.bind(s),s._onInstanceEndHandler=s._onInstanceEnd.bind(s),s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Mb(a,o);var i,t=a.prototype;return t.play=function(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{var n=function(r){var s=e._playWhenLoaded;e.sound=r,s&&e.play()};this.off("load",n),this.once("load",n),this.load()}return e}},t.pause=function(){for(var e=!1,n=this.instances,r=0,s=n.length;r<s;r++)n[r].pause()&&(e=!0);return e},t.resume=function(){for(var e=!1,n=this.instances,r=0,s=n.length;r<s;r++)n[r].resume()&&(e=!0);return e},t.stop=function(){for(var e=!1,n=this.instances,r=n.length;r--;)n[r].stop(),e=!0;return n.length=0,e},t.load=function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(!e){this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource)}},t.setExternalNodes=function(e,n){if(e&&(n||(n=e),this._firstNode=e,this._lastNode=n,!this._overlap))for(var r=this.instances,s=0,l=r.length;s<l;s++)r[s].setExternalNodes(e,n)},t.clearExternalNodes=function(){if(this._firstNode=null,this._lastNode=null,!this._overlap)for(var e=this.instances,n=0,r=e.length;n<r;n++)e[n].clearExternalNodes()},t.getExternalNodes=function(){return[this._firstNode,this._lastNode]},t._hasAsset=function(){return this._asset!=null},t._createInstance=function(){var e=null,n=this._component,r=null;if(this._hasAsset()){var s=this._assets.get(this._asset);s&&(r=s.resource)}return vt.volume=this._volume*n.volume,vt.pitch=this._pitch*n.pitch,vt.loop=this._loop,vt.startTime=this._startTime,vt.duration=this._duration,vt.onPlay=this._onInstancePlayHandler,vt.onPause=this._onInstancePauseHandler,vt.onResume=this._onInstanceResumeHandler,vt.onStop=this._onInstanceStopHandler,vt.onEnd=this._onInstanceEndHandler,n.positional?(vt.position.copy(n.entity.getPosition()),vt.maxDistance=n.maxDistance,vt.refDistance=n.refDistance,vt.rollOffFactor=n.rollOffFactor,vt.distanceModel=n.distanceModel,e=new zr(this._manager,r,vt)):e=new Yt(this._manager,r,vt),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},t._onInstancePlay=function(e){this.fire("play",e),this._component.fire("play",this,e)},t._onInstancePause=function(e){this.fire("pause",e),this._component.fire("pause",this,e)},t._onInstanceResume=function(e){this.fire("resume",e),this._component.fire("resume",this,e)},t._onInstanceStop=function(e){var n=this.instances.indexOf(e);n!==-1&&this.instances.splice(n,1),this.fire("stop",e),this._component.fire("stop",this,e)},t._onInstanceEnd=function(e){var n=this.instances.indexOf(e);n!==-1&&this.instances.splice(n,1),this.fire("end",e),this._component.fire("end",this,e)},t._onAssetAdd=function(e){this.load()},t._onAssetLoad=function(e){this.load()},t._onAssetRemoved=function(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()},t.updatePosition=function(e){for(var n=this.instances,r=0,s=n.length;r<s;r++)n[r].position=e},i=[{key:"asset",get:function(){return this._asset},set:function(e){var n=this._asset;if(n){this._assets.off("add:"+n,this._onAssetAdd,this);var r=this._assets.get(n);r&&r.off("remove",this._onAssetRemoved,this)}this._asset=e,Db(this._asset,$)&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._autoPlay=!!e}},{key:"duration",get:function(){var e=0;if(this._hasAsset()){var n=this._assets.get(this._asset);e=n!=null&&n.resource?n.resource.duration:0}return this._duration!=null?this._duration%(e||1):e},set:function(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap)for(var n=this.instances,r=0,s=n.length;r<s;r++)n[r].duration=this._duration}},{key:"isLoaded",get:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}},{key:"isPaused",get:function(){var e=this.instances,n=e.length;if(n===0)return!1;for(var r=0;r<n;r++)if(!e[r].isPaused)return!1;return!0}},{key:"isPlaying",get:function(){for(var e=this.instances,n=0,r=e.length;n<r;n++)if(e[n].isPlaying)return!0;return!1}},{key:"isStopped",get:function(){for(var e=this.instances,n=0,r=e.length;n<r;n++)if(!e[n].isStopped)return!1;return!0}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=!!e;for(var n=this.instances,r=0,s=n.length;r<s;r++)n[r].loop=this._loop}},{key:"overlap",get:function(){return this._overlap},set:function(e){this._overlap=!!e}},{key:"pitch",get:function(){return this._pitch},set:function(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap)for(var n=this.instances,r=0,s=n.length;r<s;r++)n[r].pitch=this.pitch*this._component.pitch}},{key:"startTime",get:function(){return this._startTime},set:function(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap)for(var n=this.instances,r=0,s=n.length;r<s;r++)n[r].startTime=this._startTime}},{key:"volume",get:function(){return this._volume},set:function(e){if(this._volume=U.clamp(Number(e)||0,0,1),!this._overlap)for(var n=this.instances,r=0,s=n.length;r<s;r++)n[r].volume=this._volume*this._component.volume}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Rb(o,a){return(Rb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}nn.EVENT_PLAY="play",nn.EVENT_PAUSE="pause",nn.EVENT_RESUME="resume",nn.EVENT_STOP="stop",nn.EVENT_END="end",nn.EVENT_LOAD="load";var gr=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._volume=1,e._pitch=1,e._positional=!0,e._refDistance=1,e._maxDistance=1e4,e._rollOffFactor=1,e._distanceModel=no,e._slots={},e._playingBeforeDisable={},e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Rb(a,o);var i,t=a.prototype;return t._updateSoundInstances=function(e,n,r){var s=this._slots;for(var l in s){var u=s[l];if(!u.overlap)for(var c=u.instances,h=0,f=c.length;h<f;h++)c[h][e]=r?u[e]*n:n}},t.onEnable=function(){if(!this.system._inTools){var e=this._slots,n=this._playingBeforeDisable;for(var r in e){var s=e[r];s.autoPlay&&s.isStopped?s.play():n[r]?s.resume():s.isLoaded||s.load()}}},t.onDisable=function(){var e=this._slots,n={};for(var r in e)!e[r].overlap&&e[r].isPlaying&&(e[r].pause(),n[r]=!0);this._playingBeforeDisable=n},t.onRemove=function(){this.off()},t.addSlot=function(e,n){var r=this._slots;if(r[e])return null;var s=new nn(this,e,n);return r[e]=s,s.autoPlay&&this.enabled&&this.entity.enabled&&s.play(),s},t.removeSlot=function(e){var n=this._slots;n[e]&&(n[e].stop(),delete n[e])},t.slot=function(e){return this._slots[e]},t._getSlotProperty=function(e,n){if(this.enabled&&this.entity.enabled){var r=this._slots[e];if(r)return r[n]}},t.isPlaying=function(e){return this._getSlotProperty(e,"isPlaying")||!1},t.isLoaded=function(e){return this._getSlotProperty(e,"isLoaded")||!1},t.isPaused=function(e){return this._getSlotProperty(e,"isPaused")||!1},t.isStopped=function(e){return this._getSlotProperty(e,"isStopped")||!1},t.play=function(e){if(!this.enabled||!this.entity.enabled)return null;var n=this._slots[e];return n?n.play():null},t.pause=function(e){var n=this._slots;if(e){var r=n[e];if(!r)return;r.pause()}else for(var s in n)n[s].pause()},t.resume=function(e){var n=this._slots;if(e){var r=n[e];if(!r)return;r.isPaused&&r.resume()}else for(var s in n)n[s].resume()},t.stop=function(e){var n=this._slots;if(e){var r=n[e];if(!r)return;r.stop()}else for(var s in n)n[s].stop()},i=[{key:"distanceModel",get:function(){return this._distanceModel},set:function(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}},{key:"refDistance",get:function(){return this._refDistance},set:function(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}},{key:"rollOffFactor",get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}},{key:"pitch",get:function(){return this._pitch},set:function(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}},{key:"positional",get:function(){return this._positional},set:function(e){this._positional=e;var n=this._slots;for(var r in n){var s=n[r];if(!s.overlap)for(var l=s.instances,u=l.length,c=u-1;c>=0;c--){var h=l[c].isPlaying||l[c].isSuspended,f=l[c].currentTime;h&&l[c].stop();var d=s._createInstance();h&&(d.play(),d.currentTime=f),l.push(d)}}}},{key:"slots",get:function(){return this._slots},set:function(e){var n,r=this._slots;if(r)for(var s in r)r[s].stop();var l={};for(var u in e)n=e[u],(nn!=null&&typeof Symbol<"u"&&nn[Symbol.hasInstance]?!!nn[Symbol.hasInstance](n):Q(n,nn))?l[e[u].name]=e[u]:e[u].name&&(l[e[u].name]=new nn(this,e[u].name,e[u]));this._slots=l,this.enabled&&this.entity.enabled&&this.onEnable()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);gr.EVENT_PLAY="play",gr.EVENT_PAUSE="pause",gr.EVENT_RESUME="resume",gr.EVENT_STOP="stop",gr.EVENT_END="end";var SD=function(){this.enabled=!0};function Ob(o,a){return(Ob=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var kb=["enabled"],Nb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this,e)||this).id="sound",n.ComponentType=gr,n.DataType=SD,n.schema=kb,n.manager=e.soundManager,n.app.systems.on("update",n.onUpdate,n),n.on("beforeremove",n.onBeforeRemove,n),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ob(a,o);var i,t=a.prototype;return t.initializeComponentData=function(e,n,r){r=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(var s=0;s<r.length;s++)n.hasOwnProperty(r[s])&&(e[r[s]]=n[r[s]]);o.prototype.initializeComponentData.call(this,e,n,["enabled"])},t.cloneComponent=function(e,n){var r=e.sound,s=r.slots,l={};for(var u in s){var c=s[u];l[u]={name:c.name,volume:c.volume,pitch:c.pitch,loop:c.loop,duration:c.duration,startTime:c.startTime,overlap:c.overlap,autoPlay:c.autoPlay,asset:c.asset}}var h={distanceModel:r.distanceModel,enabled:r.enabled,maxDistance:r.maxDistance,pitch:r.pitch,positional:r.positional,refDistance:r.refDistance,rollOffFactor:r.rollOffFactor,slots:l,volume:r.volume};return this.addComponent(n,h)},t.onUpdate=function(e){var n=this.store;for(var r in n)if(n.hasOwnProperty(r)){var s=n[r].entity;if(s.enabled){var l=s.sound;if(l.enabled&&l.positional){var u=s.getPosition(),c=l.slots;for(var h in c)c[h].updatePosition(u)}}}},t.onBeforeRemove=function(e,n){var r=n.slots;for(var s in r)r[s].overlap||r[s].stop();n.onRemove()},t.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this)},i=[{key:"volume",get:function(){return this.manager.volume},set:function(e){this.manager.volume=e}},{key:"context",get:function(){return Si()?this.manager.context:null}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(We);de._buildAccessors(gr.prototype,kb);var fp="simple",dp="animated";function Fb(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Ub(o,a){return(Ub=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var rn=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._evtSetMeshes=null,r._component=e,r._frame=0,r._sprite=null,r._spriteAsset=null,r.spriteAsset=n.spriteAsset,r.name=n.name,r.fps=n.fps||0,r.loop=n.loop||!1,r._playing=!1,r._paused=!1,r._time=0,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ub(a,o);var i,t=a.prototype;return t._onSpriteAssetAdded=function(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},t._bindSpriteAsset=function(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)},t._unbindSpriteAsset=function(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this))},t._onSpriteAssetLoad=function(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else{var n=e.data.textureAtlasAsset,r=this._component.system.app.assets;r.off("load:"+n,this._onTextureAtlasLoad,this),r.once("load:"+n,this._onTextureAtlasLoad,this)}else this.sprite=null},t._onTextureAtlasLoad=function(e){var n=this._spriteAsset;Fb(n,$)?this._onSpriteAssetLoad(n):this._onSpriteAssetLoad(this._component.system.app.assets.get(n))},t._onSpriteAssetRemove=function(e){this.sprite=null},t._onSpriteMeshesChange=function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},t._onSpritePpuChanged=function(){this._component.currentClip===this&&this.sprite.renderMode!==0&&this._component._showFrame(this.frame)},t._update=function(e){if(this.fps!==0&&this._playing&&!this._paused&&this._sprite){var n=this.fps<0?-1:1,r=this._time+e*this._component.speed*n,s=this.duration,l=r>s||r<0;this._setTime(r);var u=this.frame;(u=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/s):0)!==this._frame&&this._setFrame(u),l&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}},t._setTime=function(e){this._time=e;var n=this.duration;this._time<0?this.loop?this._time=this._time%n+n:this._time=0:this._time>n&&(this.loop?this._time%=n:this._time=n)},t._setFrame=function(e){this._sprite?this._frame=U.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)},t._destroy=function(){if(this._spriteAsset){var e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset))}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)},t.play=function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},t.pause=function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},t.resume=function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},t.stop=function(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))},i=[{key:"duration",get:function(){if(this._sprite){var e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}},{key:"frame",get:function(){return this._frame},set:function(e){this._setFrame(e);var n=this.fps||Number.MIN_VALUE;this._setTime(this._frame/n)}},{key:"isPaused",get:function(){return this._paused}},{key:"isPlaying",get:function(){return this._playing}},{key:"sprite",get:function(){return this._sprite},set:function(e){var n,r;this._sprite&&((n=this._evtSetMeshes)==null||n.off(),this._evtSetMeshes=null,this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._evtSetMeshes=this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this&&(e&&e.atlas?(e.atlas.texture&&((r=this._component._meshInstance)&&(r.setParameter("texture_emissiveMap",e.atlas.texture),r.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((r=this._component._meshInstance)&&(r.deleteParameter("texture_emissiveMap"),r.deleteParameter("texture_opacityMap")),this._component._hideModel()))}},{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(e){var n=this._component.system.app.assets,r=e;if(Fb(e,$)&&(r=e.id),this._spriteAsset!==r){if(this._spriteAsset){var s=n.get(this._spriteAsset);s&&this._unbindSpriteAsset(s)}if(this._spriteAsset=r,this._spriteAsset){var l=n.get(this._spriteAsset);l?this._bindSpriteAsset(l):(this.sprite=null,n.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}},{key:"time",get:function(){return this._time},set:function(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Bb(o,a){return(Bb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}rn.EVENT_PLAY="play",rn.EVENT_PAUSE="pause",rn.EVENT_RESUME="resume",rn.EVENT_STOP="stop",rn.EVENT_END="end",rn.EVENT_LOOP="loop";var Vb="texture_emissiveMap",zb="texture_opacityMap",Gb="material_emissive",Hb="material_opacity",Bi=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._type=fp,r._material=e.defaultMaterial,r._color=new B(1,1,1,1),r._colorUniform=new Float32Array(3),r._speed=1,r._flipX=!1,r._flipY=!1,r._width=1,r._height=1,r._drawOrder=0,r._layers=[0],r._outerScale=new G(1,1),r._outerScaleUniform=new Float32Array(2),r._innerOffset=new q,r._innerOffsetUniform=new Float32Array(4),r._atlasRect=new q,r._atlasRectUniform=new Float32Array(4),r._batchGroupId=-1,r._batchGroup=null,r._node=new pe,r._model=new cr,r._model.graph=r._node,r._meshInstance=null,n.addChild(r._model.graph),r._model._entity=n,r._updateAabbFunc=r._updateAabb.bind(r),r._addedModel=!1,r._autoPlayClip=null,r._clips={},r._defaultClip=new rn(r,{name:r.entity.name,fps:0,loop:!1,spriteAsset:null}),r._currentClip=r._defaultClip,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Bb(a,o);var i,t=a.prototype;return t.onEnable=function(){var e,n=this.system.app,r=n.scene,s=r.layers;this._evtLayersChanged=r.on("set:layers",this._onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this._onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&((e=n.batcher)==null||e.insert(qe.SPRITE,this._batchGroupId,this.entity))},t.onDisable=function(){var e,n,r,s,l=this.system.app,u=l.scene.layers;(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,u&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this.stop(),this._hideModel(),this._batchGroupId>=0&&((s=l.batcher)==null||s.remove(qe.SPRITE,this._batchGroupId,this.entity))},t.onDestroy=function(){var e;for(var n in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[n]._destroy();this._clips=null,this._hideModel(),this._model=null,(e=this._node)==null||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)},t._showModel=function(){if(!this._addedModel&&this._meshInstance){for(var e=[this._meshInstance],n=0,r=this._layers.length;n<r;n++){var s=this.system.app.scene.layers.getLayerById(this._layers[n]);s&&s.addMeshInstances(e)}this._addedModel=!0}},t._hideModel=function(){if(this._addedModel&&this._meshInstance){for(var e=[this._meshInstance],n=0,r=this._layers.length;n<r;n++){var s=this.system.app.scene.layers.getLayerById(this._layers[n]);s&&s.removeMeshInstances(e)}this._addedModel=!1}},t._showFrame=function(e){if(this.sprite){var n,r=this.sprite.meshes[e];if(!r){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1);return}if(n=this.sprite.renderMode===1?this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===2?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,!this._meshInstance&&(this._meshInstance=new De(r,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(Gb,this._colorUniform),this._meshInstance.setParameter(Hb,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==n&&(this._meshInstance.material=n),this._meshInstance.mesh!==r&&(this._meshInstance.mesh=r,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(Vb,this.sprite.atlas.texture),this._meshInstance.setParameter(zb,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(Vb),this._meshInstance.deleteParameter(zb)),this.sprite.atlas&&(this.sprite.renderMode===1||this.sprite.renderMode===2)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;var s=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(s){var l=2/s.rect.z,u=2/s.rect.w;this._innerOffset.set(s.border.x*l,s.border.y*u,s.border.z*l,s.border.w*u);var c=this.sprite.atlas.texture;this._atlasRect.set(s.rect.x/c.width,s.rect.y/c.height,s.rect.z/c.width,s.rect.w/c.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()}},t._updateTransform=function(){var e=this.flipX?-1:1,n=this.flipY?-1:1,r=0,s=0;if(this.sprite&&(this.sprite.renderMode===1||this.sprite.renderMode===2)){var l=1,u=1;if(this.sprite.atlas){var c=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];c&&(l=c.rect.z,u=c.rect.w,r=(.5-c.pivot.x)*this._width,s=(.5-c.pivot.y)*this._height)}var h=l/this.sprite.pixelsPerUnit,f=u/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*h),Math.max(this._height,this._innerOffset.y*f)),e*=h,n*=f,this._outerScale.x/=h,this._outerScale.y/=f,e*=U.clamp(this._width/(this._innerOffset.x*h),1e-4,1),n*=U.clamp(this._height/(this._innerOffset.y*f),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(e,n,1),this._node.setLocalPosition(r,s,0)},t._updateAabb=function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e},t._tryAutoPlay=function(){if(this._autoPlayClip&&this.type===dp){var e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name)}},t._onLayersChanged=function(e,n){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()},t._onLayerAdded=function(e){!(0>this.layers.indexOf(e.id))&&this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])},t._onLayerRemoved=function(e){this._meshInstance&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this._meshInstance]))},t.removeModelFromLayers=function(){for(var e=0;e<this.layers.length;e++){var n=this.system.app.scene.layers.getLayerById(this.layers[e]);n&&n.removeMeshInstances([this._meshInstance])}},t.addClip=function(e){var n=new rn(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=n,n.name&&n.name===this._autoPlayClip&&this._tryAutoPlay(),n},t.removeClip=function(e){delete this._clips[e]},t.clip=function(e){return this._clips[e]},t.play=function(e){var n=this._clips[e],r=this._currentClip;return r&&r!==n&&(r._playing=!1),this._currentClip=n,this._currentClip&&(this._currentClip=n,this._currentClip.play()),n},t.pause=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},t.resume=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},t.stop=function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()},i=[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._type===fp?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===dp&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}},{key:"frame",get:function(){return this._currentClip.frame},set:function(e){this._currentClip.frame=e}},{key:"spriteAsset",get:function(){return this._defaultClip._spriteAsset},set:function(e){this._defaultClip.spriteAsset=e}},{key:"sprite",get:function(){return this._currentClip.sprite},set:function(e){this._currentClip.sprite=e}},{key:"material",get:function(){return this._material},set:function(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(Gb,this._colorUniform))}},{key:"opacity",get:function(){return this._color.a},set:function(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(Hb,e)}},{key:"clips",get:function(){return this._clips},set:function(e){if(!e){for(var n in this._clips)this.removeClip(n);return}for(var r in this._clips){var s=!1;for(var l in e)if(e[l].name===r){s=!0,this._clips[r].fps=e[l].fps,this._clips[r].loop=e[l].loop,e[l].hasOwnProperty("sprite")?this._clips[r].sprite=e[l].sprite:e[l].hasOwnProperty("spriteAsset")&&(this._clips[r].spriteAsset=e[l].spriteAsset);break}s||this.removeClip(r)}for(var u in e)this._clips[e[u].name]||this.addClip(e[u]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}},{key:"currentClip",get:function(){return this._currentClip}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(this.sprite.renderMode===2||this.sprite.renderMode===1)&&this._updateTransform())}},{key:"height",get:function(){return this._height},set:function(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(this.sprite.renderMode===2||this.sprite.renderMode===1)&&this._updateTransform())}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var n,r,s=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&s>=0&&((n=this.system.app.batcher)==null||n.remove(qe.SPRITE,s,this.entity)),this.entity.enabled&&e>=0?(r=this.system.app.batcher)==null||r.insert(qe.SPRITE,e,this.entity):s>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}},{key:"autoPlayClip",get:function(){return this._autoPlayClip},set:function(e){this._autoPlayClip=(rn!=null&&typeof Symbol<"u"&&rn[Symbol.hasInstance]?rn[Symbol.hasInstance](e):Q(e,rn))?e.name:e,this._tryAutoPlay()}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}},{key:"layers",get:function(){return this._layers},set:function(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}},{key:"aabb",get:function(){return this._meshInstance?this._meshInstance.aabb:null}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);Bi.EVENT_PLAY="play",Bi.EVENT_PAUSE="pause",Bi.EVENT_RESUME="resume",Bi.EVENT_STOP="stop",Bi.EVENT_END="end",Bi.EVENT_LOOP="loop";var xD=function(){this.enabled=!0};function Wb(o,a){return(Wb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var jb=["enabled"],Xb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this,e)||this).id="sprite",n.ComponentType=Bi,n.DataType=xD,n.schema=jb,n._defaultTexture=null,n._defaultMaterial=null,n._default9SlicedMaterialSlicedMode=null,n._default9SlicedMaterialTiledMode=null,n.app.systems.on("update",n.onUpdate,n),n.on("beforeremove",n.onBeforeRemove,n),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Wb(a,o);var i,t=a.prototype;return t.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},t.initializeComponentData=function(e,n,r){if(n.enabled!==void 0&&(e.enabled=n.enabled),e.type=n.type,n.layers&&Array.isArray(n.layers)&&(e.layers=n.layers.slice(0)),n.drawOrder!==void 0&&(e.drawOrder=n.drawOrder),n.color!==void 0){var s,l,u;u=n.color,(B!=null&&typeof Symbol<"u"&&B[Symbol.hasInstance]?!!B[Symbol.hasInstance](u):Q(u,B))?e.color.set(n.color.r,n.color.g,n.color.b,(s=n.opacity)!=null?s:1):e.color.set(n.color[0],n.color[1],n.color[2],(l=n.opacity)!=null?l:1),e.color=e.color}if(n.opacity!==void 0&&(e.opacity=n.opacity),n.flipX!==void 0&&(e.flipX=n.flipX),n.flipY!==void 0&&(e.flipY=n.flipY),n.width!==void 0&&(e.width=n.width),n.height!==void 0&&(e.height=n.height),n.spriteAsset!==void 0&&(e.spriteAsset=n.spriteAsset),n.sprite&&(e.sprite=n.sprite),n.frame!==void 0&&(e.frame=n.frame),n.clips)for(var c in n.clips)e.addClip(n.clips[c]);n.speed!==void 0&&(e.speed=n.speed),n.autoPlayClip&&(e.autoPlayClip=n.autoPlayClip),e.batchGroupId=n.batchGroupId===void 0||n.batchGroupId===null?-1:n.batchGroupId,o.prototype.initializeComponentData.call(this,e,n,r)},t.cloneComponent=function(e,n){var r=e.sprite;return this.addComponent(n,{enabled:r.enabled,type:r.type,spriteAsset:r.spriteAsset,sprite:r.sprite,width:r.width,height:r.height,frame:r.frame,color:r.color.clone(),opacity:r.opacity,flipX:r.flipX,flipY:r.flipY,speed:r.speed,clips:r.clips,autoPlayClip:r.autoPlayClip,batchGroupId:r.batchGroupId,drawOrder:r.drawOrder,layers:r.layers.slice(0)})},t.onUpdate=function(e){var n=this.store;for(var r in n)if(n.hasOwnProperty(r)){var s=n[r];if(s.data.enabled&&s.entity.enabled){var l=s.entity.sprite;l._currentClip&&l._currentClip._update(e)}}},t.onBeforeRemove=function(e,n){n.onDestroy()},i=[{key:"defaultMaterial",get:function(){if(!this._defaultMaterial){var e=new ee(this.app.graphicsDevice,{width:1,height:1,format:20,name:"sprite"}),n=new Uint8Array(e.lock());n[0]=n[1]=n[2]=n[3]=255,e.unlock();var r=new it;r.diffuse.set(0,0,0),r.emissive.set(1,1,1),r.emissiveMap=e,r.opacityMap=e,r.opacityMapChannel="a",r.useLighting=!1,r.useTonemap=!1,r.useFog=!1,r.useSkybox=!1,r.blendType=4,r.depthWrite=!1,r.pixelSnap=!1,r.cull=0,r.update(),this._defaultTexture=e,this._defaultMaterial=r}return this._defaultMaterial},set:function(e){this._defaultMaterial=e}},{key:"default9SlicedMaterialSlicedMode",get:function(){if(!this._default9SlicedMaterialSlicedMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode},set:function(e){this._default9SlicedMaterialSlicedMode=e}},{key:"default9SlicedMaterialTiledMode",get:function(){if(!this._default9SlicedMaterialTiledMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode},set:function(e){this._default9SlicedMaterialTiledMode=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(We);function Yb(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function qb(o,a){return(qb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}de._buildAccessors(Bi.prototype,jb);var hs=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._oldState=!0,r._size=new E,r.on("set_enabled",r._onSetEnabled,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&qb(a,o);var i,t=a.prototype;return t.onEnable=function(){this._checkState()},t.onDisable=function(){this._checkState()},t._onSetEnabled=function(e,n,r){this._checkState()},t._checkState=function(){var e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))},t._onBeforeRemove=function(){this.fire("remove")},i=[{key:"size",get:function(){return this._size},set:function(e){Yb(e,E)?this._size.copy(e):Yb(e,Array)&&e.length>=3&&this.size.set(e[0],e[1],e[2])}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);hs.EVENT_ENABLE="enable",hs.EVENT_DISABLE="disable",hs.EVENT_STATE="state",hs.EVENT_REMOVE="remove";var bD=function(){this.enabled=!0};function Kb(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function Zb(o,a){return(Zb=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Qb=["enabled"],Jb=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="zone",e.ComponentType=hs,e.DataType=bD,e.schema=Qb,e.on("beforeremove",e._onBeforeRemove,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Zb(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,e.size&&(Kb(e.size,E)?t.size.copy(e.size):Kb(e.size,Array)&&e.size.length>=3&&t.size.set(e.size[0],e.size[1],e.size[2]))},i.cloneComponent=function(t,e){var n={enabled:t.zone.enabled,size:t.zone.size};return this.addComponent(e,n)},i._onBeforeRemove=function(t,e){e._onBeforeRemove()},a}(We);de._buildAccessors(hs.prototype,Qb);var TD=function(o,a){this.effect=o,this.inputTarget=a,this.outputTarget=null,this.name=o.constructor.name},$b=function(){function o(i,t){this.app=i,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}var a=o.prototype;return a._allocateColorBuffer=function(i,t){var e,n,r=this.camera.rect,s=this.destinationRenderTarget,l=this.app.graphicsDevice,u=Math.floor(r.z*((e=s==null?void 0:s.width)!=null?e:l.width)),c=Math.floor(r.w*((n=s==null?void 0:s.height)!=null?n:l.height));return new ee(l,{name:t,format:i,width:u,height:c,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})},a._createOffscreenTarget=function(i,t){var e,n,r=this.app.graphicsDevice,s=((e=this.destinationRenderTarget)!=null?e:r.backBuffer).isColorBufferSrgb(0),l=(n=t&&r.getRenderableHdrFormat([12,14],!0))!=null?n:s?20:7,u=this.camera.entity.name+"-posteffect-"+this.effects.length;return new Ee({colorBuffer:this._allocateColorBuffer(l,u),depth:i,stencil:i&&this.app.graphicsDevice.supportsStencil,samples:i?r.samples:1})},a._resizeOffscreenTarget=function(i){var t=i.colorBuffer.format,e=i.colorBuffer.name;i.destroyFrameBuffers(),i.destroyTextureBuffers(),i._colorBuffer=this._allocateColorBuffer(t,e),i._colorBuffers=[i._colorBuffer]},a._destroyOffscreenTarget=function(i){i.destroyTextureBuffers(),i.destroy()},a.addEffect=function(i){var t=this.effects,e=t.length===0,n=this._createOffscreenTarget(e,i.hdr),r=new TD(i,n);t.push(r),this._sourceTarget=r.inputTarget,t.length>1&&(t[t.length-2].outputTarget=r.inputTarget),this._newPostEffect=i,i.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0},a.removeEffect=function(i){for(var t=-1,e=0,n=this.effects.length;e<n;e++)if(this.effects[e].effect===i){t=e;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&i.needsDepthBuffer&&this._releaseDepthMap(),this.effects.length===0&&this.disable()},a._requestDepthMaps=function(){for(var i=0,t=this.effects.length;i<t;i++){var e=this.effects[i].effect;this._newPostEffect!==e&&e.needsDepthBuffer&&this._requestDepthMap()}},a._releaseDepthMaps=function(){for(var i=0,t=this.effects.length;i<t;i++)this.effects[i].effect.needsDepthBuffer&&this._releaseDepthMap()},a._requestDepthMap=function(){var i=this.app.scene.layers.getLayerById(1);i&&(i.incrementCounter(),this.camera.requestSceneDepthMap(!0))},a._releaseDepthMap=function(){var i=this.app.scene.layers.getLayerById(1);i&&(i.decrementCounter(),this.camera.requestSceneDepthMap(!1))},a.destroy=function(){for(var i=0,t=this.effects.length;i<t;i++)this.effects[i].inputTarget.destroy();this.effects.length=0,this.disable()},a.enable=function(){var i=this;!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=function(){if(i.enabled){var t=null,e=i.effects.length;if(e)for(var n=0;n<e;n++){var r=i.effects[n],s=r.outputTarget;n===e-1&&(t=i.camera.rect,i.destinationRenderTarget&&(s=i.destinationRenderTarget)),r.effect.render(r.inputTarget,s,t)}}})},a.disable=function(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)},a._onCanvasResized=function(i,t){var e,n,r=this.camera.rect,s=this.destinationRenderTarget;i=(e=s==null?void 0:s.width)!=null?e:i,t=(n=s==null?void 0:s.height)!=null?n:t,this.camera.camera.aspectRatio=i*r.z/(t*r.w),this.resizeRenderTargets()},a.resizeRenderTargets=function(){for(var i,t,e=this.app.graphicsDevice,n=this.destinationRenderTarget,r=(i=n==null?void 0:n.width)!=null?i:e.width,s=(t=n==null?void 0:n.height)!=null?t:e.height,l=this.camera.rect,u=Math.floor(l.z*r),c=Math.floor(l.w*s),h=this.effects,f=0,d=h.length;f<d;f++){var p=h[f];(p.inputTarget.width!==u||p.inputTarget.height!==c)&&this._resizeOffscreenTarget(p.inputTarget)}},a.onCameraRectChanged=function(i,t,e){this.enabled&&this.resizeRenderTargets()},o}();function eT(o,a){return(eT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Vi=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this).onPostprocessing=null,r._renderSceneDepthMap=0,r._renderSceneColorMap=0,r._sceneDepthMapRequested=!1,r._sceneColorMapRequested=!1,r._priority=0,r._disablePostEffectsLayer=4,r._camera=new Eu,r._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._camera.node=n,r._postEffects=new $b(e.app,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&eT(a,o);var i,t=a.prototype;return t.setShaderPass=function(e){var n=Ti.get(this.system.app.graphicsDevice),r=e?n.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=r,r.index},t.getShaderPass=function(){var e;return(e=this._camera.shaderPassInfo)==null?void 0:e.name},t._enableDepthLayer=function(e){if(this.layers.find(function(r){return r===1})){var n=this.system.app.scene.layers.getLayerById(1);e?n==null||n.incrementCounter():n==null||n.decrementCounter()}else if(e)return!1;return!0},t.requestSceneColorMap=function(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty()},t.requestSceneDepthMap=function(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty()},t.dirtyLayerCompositionCameras=function(){this.system.app.scene.layers._dirty=!0},t.screenToWorld=function(e,n,r,s){var l=this.system.app.graphicsDevice.clientRect,u=l.width,c=l.height;return this._camera.screenToWorld(e,n,r,u,c,s)},t.worldToScreen=function(e,n){var r=this.system.app.graphicsDevice.clientRect,s=r.width,l=r.height;return this._camera.worldToScreen(e,s,l,n)},t.onAppPrerender=function(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0},t.addCameraToLayers=function(){for(var e=this.layers,n=0;n<e.length;n++){var r=this.system.app.scene.layers.getLayerById(e[n]);r&&r.addCamera(this)}},t.removeCameraFromLayers=function(){for(var e=this.layers,n=0;n<e.length;n++){var r=this.system.app.scene.layers.getLayerById(e[n]);r&&r.removeCamera(this)}},t.onLayersChanged=function(e,n){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){0>this.layers.indexOf(e.id)||e.addCamera(this)},t.onLayerRemoved=function(e){0>this.layers.indexOf(e.id)||e.removeCamera(this)},t.onEnable=function(){var e,n,r,s=this.system.app.scene,l=s.layers;this.system.addCamera(this),(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=s.on("set:layers",this.onLayersChanged,this),l&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=l.on("add",this.onLayerAdded,this),(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=l.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()},t.onDisable=function(){var e,n,r,s=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,s&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this.system.removeCamera(this)},t.onRemove=function(){this.onDisable(),this.off(),this.camera.destroy()},t.calculateAspectRatio=function(e){var n=this.system.app.graphicsDevice,r=e?e.width:n.width,s=e?e.height:n.height;return r*this.rect.z/(s*this.rect.w)},t.frameUpdate=function(e){this.aspectRatioMode===0&&(this.aspectRatio=this.calculateAspectRatio(e))},t.startXr=function(e,n,r){this.system.app.xr.start(this,e,n,r)},t.endXr=function(e){if(!this._camera.xr){e&&e(Error("Camera is not in XR"));return}this._camera.xr.end(e)},t.copy=function(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter},i=[{key:"renderPasses",get:function(){return this._camera.renderPasses},set:function(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}},{key:"shaderParams",get:function(){return this._camera.shaderParams}},{key:"gammaCorrection",get:function(){return this.camera.shaderParams.gammaCorrection},set:function(e){this.camera.shaderParams.gammaCorrection=e}},{key:"toneMapping",get:function(){return this.camera.shaderParams.toneMapping},set:function(e){this.camera.shaderParams.toneMapping=e}},{key:"fog",get:function(){return this._camera.fogParams},set:function(e){this._camera.fogParams=e}},{key:"aperture",get:function(){return this._camera.aperture},set:function(e){this._camera.aperture=e}},{key:"aspectRatio",get:function(){return this._camera.aspectRatio},set:function(e){this._camera.aspectRatio=e}},{key:"aspectRatioMode",get:function(){return this._camera.aspectRatioMode},set:function(e){this._camera.aspectRatioMode=e}},{key:"calculateProjection",get:function(){return this._camera.calculateProjection},set:function(e){this._camera.calculateProjection=e}},{key:"calculateTransform",get:function(){return this._camera.calculateTransform},set:function(e){this._camera.calculateTransform=e}},{key:"camera",get:function(){return this._camera}},{key:"clearColor",get:function(){return this._camera.clearColor},set:function(e){this._camera.clearColor=e}},{key:"clearColorBuffer",get:function(){return this._camera.clearColorBuffer},set:function(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}},{key:"clearDepthBuffer",get:function(){return this._camera.clearDepthBuffer},set:function(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}},{key:"clearStencilBuffer",get:function(){return this._camera.clearStencilBuffer},set:function(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}},{key:"cullFaces",get:function(){return this._camera.cullFaces},set:function(e){this._camera.cullFaces=e}},{key:"disablePostEffectsLayer",get:function(){return this._disablePostEffectsLayer},set:function(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}},{key:"farClip",get:function(){return this._camera.farClip},set:function(e){this._camera.farClip=e}},{key:"flipFaces",get:function(){return this._camera.flipFaces},set:function(e){this._camera.flipFaces=e}},{key:"fov",get:function(){return this._camera.fov},set:function(e){this._camera.fov=e}},{key:"frustum",get:function(){return this._camera.frustum}},{key:"frustumCulling",get:function(){return this._camera.frustumCulling},set:function(e){this._camera.frustumCulling=e}},{key:"horizontalFov",get:function(){return this._camera.horizontalFov},set:function(e){this._camera.horizontalFov=e}},{key:"layers",get:function(){return this._camera.layers},set:function(e){var n=this,r=this._camera.layers,s=this.system.app.scene;r.forEach(function(l){var u=s.layers.getLayerById(l);u==null||u.removeCamera(n)}),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach(function(l){var u=s.layers.getLayerById(l);u==null||u.addCamera(n)}),this.fire("set:layers")}},{key:"layersSet",get:function(){return this._camera.layersSet}},{key:"jitter",get:function(){return this._camera.jitter},set:function(e){this._camera.jitter=e}},{key:"nearClip",get:function(){return this._camera.nearClip},set:function(e){this._camera.nearClip=e}},{key:"orthoHeight",get:function(){return this._camera.orthoHeight},set:function(e){this._camera.orthoHeight=e}},{key:"postEffects",get:function(){return this._postEffects}},{key:"postEffectsEnabled",get:function(){return this._postEffects.enabled}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this.dirtyLayerCompositionCameras()}},{key:"projection",get:function(){return this._camera.projection},set:function(e){this._camera.projection=e}},{key:"projectionMatrix",get:function(){return this._camera.projectionMatrix}},{key:"rect",get:function(){return this._camera.rect},set:function(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}},{key:"renderSceneColorMap",get:function(){return this._renderSceneColorMap>0},set:function(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}},{key:"renderSceneDepthMap",get:function(){return this._renderSceneDepthMap>0},set:function(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}},{key:"renderTarget",get:function(){return this._camera.renderTarget},set:function(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}},{key:"scissorRect",get:function(){return this._camera.scissorRect},set:function(e){this._camera.scissorRect=e}},{key:"sensitivity",get:function(){return this._camera.sensitivity},set:function(e){this._camera.sensitivity=e}},{key:"shutter",get:function(){return this._camera.shutter},set:function(e){this._camera.shutter=e}},{key:"viewMatrix",get:function(){return this._camera.viewMatrix}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),ED=function(){this.enabled=!0};function tT(o,a){return(tT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var nT=["enabled"],iT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).cameras=[],e.id="camera",e.ComponentType=Vi,e.DataType=ED,e.schema=nT,e.on("beforeremove",e.onBeforeRemove,e),e.app.on("prerender",e.onAppPrerender,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&tT(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){n=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(var r=0;r<n.length;r++){var s=n[r];if(e.hasOwnProperty(s)){var l=e[s];switch(s){case"rect":case"scissorRect":Array.isArray(l)?t[s]=new q(l[0],l[1],l[2],l[3]):t[s]=l;break;case"clearColor":Array.isArray(l)?t[s]=new B(l[0],l[1],l[2],l[3]):t[s]=l;break;default:t[s]=l}}}o.prototype.initializeComponentData.call(this,t,e,["enabled"])},i.cloneComponent=function(t,e){var n=t.camera;return this.addComponent(e,{aspectRatio:n.aspectRatio,aspectRatioMode:n.aspectRatioMode,calculateProjection:n.calculateProjection,calculateTransform:n.calculateTransform,clearColor:n.clearColor,clearColorBuffer:n.clearColorBuffer,clearDepthBuffer:n.clearDepthBuffer,clearStencilBuffer:n.clearStencilBuffer,renderSceneDepthMap:n.renderSceneDepthMap,renderSceneColorMap:n.renderSceneColorMap,cullFaces:n.cullFaces,enabled:n.enabled,farClip:n.farClip,flipFaces:n.flipFaces,fov:n.fov,frustumCulling:n.frustumCulling,horizontalFov:n.horizontalFov,layers:n.layers,renderTarget:n.renderTarget,nearClip:n.nearClip,orthoHeight:n.orthoHeight,projection:n.projection,priority:n.priority,rect:n.rect,scissorRect:n.scissorRect,aperture:n.aperture,sensitivity:n.sensitivity,shutter:n.shutter,gammaCorrection:n.gammaCorrection,toneMapping:n.toneMapping})},i.onBeforeRemove=function(t,e){this.removeCamera(e),e.onRemove()},i.onAppPrerender=function(){for(var t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()},i.addCamera=function(t){this.cameras.push(t),Vo(this.cameras)},i.removeCamera=function(t){var e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),Vo(this.cameras))},i.destroy=function(){this.app.off("prerender",this.onAppPrerender,this),o.prototype.destroy.call(this)},a}(We);de._buildAccessors(Vi.prototype,nT);var rT=function(){this.enabled=!0,this.type="directional",this.color=new B(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16},yl=Object.keys(new rT);function sT(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function aT(o,a){return(aT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var oT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._evtLayersChanged=null,e._evtLayerAdded=null,e._evtLayerRemoved=null,e._cookieAsset=null,e._cookieAssetId=null,e._cookieAssetAdd=!1,e._cookieMatrix=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&aT(a,o);var i,t=a.prototype;return t._setValue=function(e,n,r,s){var l=this.data,u=l[e];(s||u!==n)&&(l[e]=n,r&&r.call(this,n,u))},t.addLightToLayers=function(){for(var e=0;e<this.layers.length;e++){var n=this.system.app.scene.layers.getLayerById(this.layers[e]);n&&(n.addLight(this),this.light.addLayer(n))}},t.removeLightFromLayers=function(){for(var e=0;e<this.layers.length;e++){var n=this.system.app.scene.layers.getLayerById(this.layers[e]);n&&(n.removeLight(this),this.light.removeLayer(n))}},t.onLayersChanged=function(e,n){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))},t.onLayerRemoved=function(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))},t.refreshProperties=function(){for(var e=0;e<yl.length;e++){var n=yl[e];this[n]=this[n]}this.enabled&&this.entity.enabled&&this.onEnable()},t.onCookieAssetSet=function(){var e=!1;this._cookieAsset.type!=="cubemap"||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,e=!0),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},t.onCookieAssetAdd=function(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},t.onCookieAssetLoad=function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},t.onCookieAssetRemove=function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},t.onEnable=function(){var e=this.system.app.scene,n=e.layers;this.light.enabled=!0,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),n&&(this._evtLayerAdded=n.on("add",this.onLayerAdded,this),this._evtLayerRemoved=n.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},t.onDisable=function(){var e,n,r,s=this.system.app.scene.layers;this.light.enabled=!1,(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,s&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this.removeLightFromLayers()},t.onRemove=function(){this.onDisable(),this.light.destroy(),this.cookieAsset=null},i=[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}},{key:"enabled",get:function(){return this.data.enabled},set:function(e){this._setValue("enabled",e,function(n,r){this.onSetEnabled(null,r,n)})}},{key:"light",get:function(){return this.data.light},set:function(e){this._setValue("light",e)}},{key:"type",get:function(){return this.data.type},set:function(e){this._setValue("type",e,function(n,r){this.system.changeType(this,r,n),this.refreshProperties()})}},{key:"color",get:function(){return this.data.color},set:function(e){this._setValue("color",e,function(n,r){this.light.setColor(n)},!0)}},{key:"intensity",get:function(){return this.data.intensity},set:function(e){this._setValue("intensity",e,function(n,r){this.light.intensity=n})}},{key:"luminance",get:function(){return this.data.luminance},set:function(e){this._setValue("luminance",e,function(n,r){this.light.luminance=n})}},{key:"shape",get:function(){return this.data.shape},set:function(e){this._setValue("shape",e,function(n,r){this.light.shape=n})}},{key:"affectSpecularity",get:function(){return this.data.affectSpecularity},set:function(e){this._setValue("affectSpecularity",e,function(n,r){this.light.affectSpecularity=n})}},{key:"castShadows",get:function(){return this.data.castShadows},set:function(e){this._setValue("castShadows",e,function(n,r){this.light.castShadows=n})}},{key:"shadowDistance",get:function(){return this.data.shadowDistance},set:function(e){this._setValue("shadowDistance",e,function(n,r){this.light.shadowDistance=n})}},{key:"shadowIntensity",get:function(){return this.data.shadowIntensity},set:function(e){this._setValue("shadowIntensity",e,function(n,r){this.light.shadowIntensity=n})}},{key:"shadowResolution",get:function(){return this.data.shadowResolution},set:function(e){this._setValue("shadowResolution",e,function(n,r){this.light.shadowResolution=n})}},{key:"shadowBias",get:function(){return this.data.shadowBias},set:function(e){this._setValue("shadowBias",e,function(n,r){this.light.shadowBias=-.01*U.clamp(n,0,1)})}},{key:"numCascades",get:function(){return this.data.numCascades},set:function(e){this._setValue("numCascades",e,function(n,r){this.light.numCascades=U.clamp(Math.floor(n),1,4)})}},{key:"cascadeBlend",get:function(){return this.data.cascadeBlend},set:function(e){this._setValue("cascadeBlend",e,function(n,r){this.light.cascadeBlend=U.clamp(n,0,1)})}},{key:"bakeNumSamples",get:function(){return this.data.bakeNumSamples},set:function(e){this._setValue("bakeNumSamples",e,function(n,r){this.light.bakeNumSamples=U.clamp(Math.floor(n),1,255)})}},{key:"bakeArea",get:function(){return this.data.bakeArea},set:function(e){this._setValue("bakeArea",e,function(n,r){this.light.bakeArea=U.clamp(n,0,180)})}},{key:"cascadeDistribution",get:function(){return this.data.cascadeDistribution},set:function(e){this._setValue("cascadeDistribution",e,function(n,r){this.light.cascadeDistribution=U.clamp(n,0,1)})}},{key:"normalOffsetBias",get:function(){return this.data.normalOffsetBias},set:function(e){this._setValue("normalOffsetBias",e,function(n,r){this.light.normalOffsetBias=U.clamp(n,0,1)})}},{key:"range",get:function(){return this.data.range},set:function(e){this._setValue("range",e,function(n,r){this.light.attenuationEnd=n})}},{key:"innerConeAngle",get:function(){return this.data.innerConeAngle},set:function(e){this._setValue("innerConeAngle",e,function(n,r){this.light.innerConeAngle=n})}},{key:"outerConeAngle",get:function(){return this.data.outerConeAngle},set:function(e){this._setValue("outerConeAngle",e,function(n,r){this.light.outerConeAngle=n})}},{key:"falloffMode",get:function(){return this.data.falloffMode},set:function(e){this._setValue("falloffMode",e,function(n,r){this.light.falloffMode=n})}},{key:"shadowType",get:function(){return this.data.shadowType},set:function(e){this._setValue("shadowType",e,function(n,r){this.light.shadowType=n})}},{key:"vsmBlurSize",get:function(){return this.data.vsmBlurSize},set:function(e){this._setValue("vsmBlurSize",e,function(n,r){this.light.vsmBlurSize=n})}},{key:"vsmBlurMode",get:function(){return this.data.vsmBlurMode},set:function(e){this._setValue("vsmBlurMode",e,function(n,r){this.light.vsmBlurMode=n})}},{key:"vsmBias",get:function(){return this.data.vsmBias},set:function(e){this._setValue("vsmBias",e,function(n,r){this.light.vsmBias=U.clamp(n,0,1)})}},{key:"cookieAsset",get:function(){return this.data.cookieAsset},set:function(e){this._setValue("cookieAsset",e,function(n,r){if(!(this._cookieAssetId&&(sT(n,$)&&n.id===this._cookieAssetId||n===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,sT(n,$))this.data.cookieAsset=n.id,this._cookieAssetId=n.id,this.onCookieAssetAdd(n);else if(typeof n=="number"){this._cookieAssetId=n;var s=this.system.app.assets.get(n);s?this.onCookieAssetAdd(s):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}})}},{key:"cookie",get:function(){return this.data.cookie},set:function(e){this._setValue("cookie",e,function(n,r){this.light.cookie=n})}},{key:"cookieIntensity",get:function(){return this.data.cookieIntensity},set:function(e){this._setValue("cookieIntensity",e,function(n,r){this.light.cookieIntensity=U.clamp(n,0,1)})}},{key:"cookieFalloff",get:function(){return this.data.cookieFalloff},set:function(e){this._setValue("cookieFalloff",e,function(n,r){this.light.cookieFalloff=n})}},{key:"cookieChannel",get:function(){return this.data.cookieChannel},set:function(e){this._setValue("cookieChannel",e,function(n,r){this.light.cookieChannel=n})}},{key:"cookieAngle",get:function(){return this.data.cookieAngle},set:function(e){this._setValue("cookieAngle",e,function(n,r){if(n!==0||this.cookieScale!==null){this._cookieMatrix||(this._cookieMatrix=new q);var s=1,l=1;this.cookieScale&&(s=this.cookieScale.x,l=this.cookieScale.y);var u=Math.cos(n*U.DEG_TO_RAD),c=Math.sin(n*U.DEG_TO_RAD);this._cookieMatrix.set(u/s,-c/s,c/l,u/l),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})}},{key:"cookieScale",get:function(){return this.data.cookieScale},set:function(e){this._setValue("cookieScale",e,function(n,r){if(n!==null||this.cookieAngle!==0){this._cookieMatrix||(this._cookieMatrix=new q);var s=n.x,l=n.y,u=Math.cos(this.cookieAngle*U.DEG_TO_RAD),c=Math.sin(this.cookieAngle*U.DEG_TO_RAD);this._cookieMatrix.set(u/s,-c/s,c/l,u/l),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0)}},{key:"cookieOffset",get:function(){return this.data.cookieOffset},set:function(e){this._setValue("cookieOffset",e,function(n,r){this.light.cookieOffset=n},!0)}},{key:"shadowUpdateMode",get:function(){return this.data.shadowUpdateMode},set:function(e){this._setValue("shadowUpdateMode",e,function(n,r){this.light.shadowUpdateMode=n},!0)}},{key:"mask",get:function(){return this.data.mask},set:function(e){this._setValue("mask",e,function(n,r){this.light.mask=n})}},{key:"affectDynamic",get:function(){return this.data.affectDynamic},set:function(e){this._setValue("affectDynamic",e,function(n,r){n?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})}},{key:"affectLightmapped",get:function(){return this.data.affectLightmapped},set:function(e){this._setValue("affectLightmapped",e,function(n,r){n?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})}},{key:"bake",get:function(){return this.data.bake},set:function(e){this._setValue("bake",e,function(n,r){n?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()})}},{key:"bakeDir",get:function(){return this.data.bakeDir},set:function(e){this._setValue("bakeDir",e,function(n,r){this.light.bakeDir=n})}},{key:"isStatic",get:function(){return this.data.isStatic},set:function(e){this._setValue("isStatic",e,function(n,r){this.light.isStatic=n})}},{key:"layers",get:function(){return this.data.layers},set:function(e){this._setValue("layers",e,function(n,r){for(var s=0;s<r.length;s++){var l=this.system.app.scene.layers.getLayerById(r[s]);l&&(l.removeLight(this),this.light.removeLayer(l))}for(var u=0;u<n.length;u++){var c=this.system.app.scene.layers.getLayerById(n[u]);c&&this.enabled&&this.entity.enabled&&(c.addLight(this),this.light.addLayer(c))}})}},{key:"shadowUpdateOverrides",get:function(){return this.light.shadowUpdateOverrides},set:function(e){this.light.shadowUpdateOverrides=e}},{key:"shadowSamples",get:function(){return this.light.shadowSamples},set:function(e){this.light.shadowSamples=e}},{key:"shadowBlockerSamples",get:function(){return this.light.shadowBlockerSamples},set:function(e){this.light.shadowBlockerSamples=e}},{key:"penumbraSize",get:function(){return this.light.penumbraSize},set:function(e){this.light.penumbraSize=e}},{key:"penumbraFalloff",get:function(){return this.light.penumbraFalloff},set:function(e){this.light.penumbraFalloff=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);function lT(){return(lT=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function uT(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function cT(o,a){return(cT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var hT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="light",e.ComponentType=oT,e.DataType=rT,e.on("beforeremove",e._onRemoveComponent,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&cT(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e){var n=lT({},e);n.type||(n.type=t.data.type),t.data.type=n.type,n.layers&&Array.isArray(n.layers)&&(n.layers=n.layers.slice(0)),n.color&&Array.isArray(n.color)&&(n.color=new B(n.color[0],n.color[1],n.color[2])),n.cookieOffset&&uT(n.cookieOffset,Array)&&(n.cookieOffset=new G(n.cookieOffset[0],n.cookieOffset[1])),n.cookieScale&&uT(n.cookieScale,Array)&&(n.cookieScale=new G(n.cookieScale[0],n.cookieScale[1])),n.enable&&(n.enabled=n.enable),n.shape||(n.shape=0);var r=new od(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);r.type=ad[n.type],r._node=t.entity,t.data.light=r,o.prototype.initializeComponentData.call(this,t,n,yl)},i._onRemoveComponent=function(t,e){e.onRemove()},i.cloneComponent=function(t,e){for(var n,r=t.light,s=[],l=0;l<yl.length;l++)(n=yl[l])!=="light"&&(r[n]&&r[n].clone?s[n]=r[n].clone():s[n]=r[n]);return this.addComponent(e,s)},i.changeType=function(t,e,n){e!==n&&(t.light.type=ad[n])},a}(We);function Dn(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var wD=["x","y","z","w"],AD=[void 0,void 0,G,E,q];function wa(o,a,i,t){switch(a.type){case"boolean":return!!i;case"number":if(typeof i=="number")break;if(typeof i=="string"){var e,n=parseInt(i,10);return isNaN(n)?null:n}return typeof i=="boolean"?0+i:null;case"json":var r,s={};if(Array.isArray(a.schema)){i&&(i===void 0?"undefined":(r=i)&&typeof Symbol<"u"&&r.constructor===Symbol?"symbol":typeof r)=="object"||(i={});for(var l=0;l<a.schema.length;l++){var u=a.schema[l];if(u.name)if(u.array){s[u.name]=[];for(var c=Array.isArray(i[u.name])?i[u.name]:[],h=0;h<c.length;h++)s[u.name].push(wa(o,u,c[h]))}else{var f=i.hasOwnProperty(u.name)?i[u.name]:u.default;s[u.name]=wa(o,u,f)}}}return s;case"asset":if(Dn(i,$))break;return typeof i=="number"?o.assets.get(i)||null:typeof i=="string"&&o.assets.get(parseInt(i,10))||null;case"entity":if(Dn(i,pe))break;return typeof i=="string"?o.getEntityFromIndex(i):null;case"rgb":case"rgba":if(Dn(i,B))return Dn(t,B)?(t.copy(i),t):i.clone();if(Dn(i,Array)&&i.length>=3&&i.length<=4){for(var d=0;d<i.length;d++)if(typeof i[d]!="number")return null;return t||(t=new B),t.r=i[0],t.g=i[1],t.b=i[2],t.a=i.length===3?1:i[3],t}return typeof i=="string"&&/#(?:[0-9a-f]{2}){3,4}/i.test(i)?(t||(t=new B),t.fromString(i),t):null;case"vec2":case"vec3":case"vec4":var p=parseInt(a.type.slice(3),10),_=AD[p];if(Dn(i,_))return Dn(t,_)?(t.copy(i),t):i.clone();if(Dn(i,Array)&&i.length===p){for(var g=0;g<i.length;g++)if(typeof i[g]!="number")return null;t||(t=new _);for(var y=0;y<p;y++)t[wD[y]]=i[y];return t}return null;case"curve":if(i)return Dn(i,cn)||Dn(i,tr)?e=i.clone():(e=new(Dn(i.keys[0],Array)?tr:cn)(i.keys)).type=i.type,e}return i}function fT(o,a,i,t){return a.array?i.map(function(e,n){return wa(o,a,e,t?t[n]:null)}):wa(o,a,i,t)}function dT(o,a,i,t){if(i)for(var e in a){var n=a[e],r=i[e];r!==void 0&&(t[e]=fT(o,n,r,t[e]))}}var yr=function(){function o(i){this.scriptType=i,this.index={}}var a=o.prototype;return a.add=function(i,t){this.index[i]||o.reservedNames.has(i)||(this.index[i]=t,Object.defineProperty(this.scriptType.prototype,i,{get:function(){return this.__attributes[i]},set:function(e){var n="attr",r="attr:"+i,s=this.__attributes[i],l=s;if(s&&t.type!=="json"&&t.type!=="entity"&&s.clone&&(this.hasEvent(n)||this.hasEvent(r))&&(l=s.clone()),t.array){if(this.__attributes[i]=[],e)for(var u=0,c=e.length;u<c;u++)this.__attributes[i].push(wa(this.app,t,e[u],s?s[u]:null))}else this.__attributes[i]=wa(this.app,t,e,s);this.fire(n,i,this.__attributes[i],l),this.fire(r,this.__attributes[i],l)}}))},a.remove=function(i){return!!this.index[i]&&(delete this.index[i],delete this.scriptType.prototype[i],!0)},a.has=function(i){return!!this.index[i]},a.get=function(i){return this.index[i]||null},o}();yr.assignAttributesToScript=dT,yr.attributeToValue=fT,yr.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);var pp="initialize",mp="postInitialize";function pT(o,a){for(var i=0;i<a.length;i++){var t=a[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(o,t.key,t)}}function mT(o,a){return(mT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ot=function(o){var a,i;if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function t(e){var n;return(n=o.call(this)||this).initScript(e),n}return t.prototype=Object.create(o&&o.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),o&&mT(t,o),t.prototype.initScript=function(e){var n=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled=typeof e.enabled!="boolean"||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=n,this.__executionOrder=-1},i=[{key:"scriptName",get:function(){return this.__name}}],a=[{key:"enabled",get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,pp)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,mp)))}}],pT(t.prototype,a),i&&pT(t,i),t}(se);ot.EVENT_ENABLE="enable",ot.EVENT_DISABLE="disable",ot.EVENT_STATE="state",ot.EVENT_DESTROY="destroy",ot.EVENT_ATTR="attr",ot.EVENT_ERROR="error",ot.__name=null,ot.__getScriptName=_T;var CD=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function _T(o){if(typeof o=="function"){if(o.scriptName)return o.scriptName;if("name"in Function.prototype)return o.name;if(o===Function||o===Function.prototype.constructor)return"Function";var a=(""+o).match(CD);return a?a[1]:void 0}}function vT(o,a){return(vT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var zi=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).initScriptType(t),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&vT(a,o);var i=a.prototype;return i.initScript=function(t){ot.prototype.initScript.call(this,t),this.__attributes={},this.__attributesRaw=t.attributes||{}},i.initScriptType=function(t){this.initScript(t)},i.__initializeAttributes=function(t){if(t||this.__attributesRaw){for(var e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null}},a.extend=function(t){for(var e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])},function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(a,[{key:"attributes",get:function(){return this.hasOwnProperty("__attributes")||(this.__attributes=new yr(this)),this.__attributes}}]),a}(ot);function Sr(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function gT(o,a){return(gT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function yT(o){return o&&typeof Symbol<"u"&&o.constructor===Symbol?"symbol":typeof o}var ti=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._attributeDataMap=new Map,r._scripts=[],r._updateList=new Qa({sortBy:"__executionOrder"}),r._postUpdateList=new Qa({sortBy:"__executionOrder"}),r._scriptsIndex={},r._destroyedScripts=[],r._destroyed=!1,r._scriptsData=null,r._oldState=!0,r._enabled=!0,r._beingEnabled=!1,r._isLoopingThroughScripts=!1,r._executionOrder=-1,r.on("set_enabled",r._onSetEnabled,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&gT(a,o);var i,t=a.prototype;return t.onEnable=function(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1},t.onDisable=function(){this._checkState()},t.onPostStateChange=function(){for(var e=this._beginLooping(),n=0,r=this.scripts.length;n<r;n++){var s=this.scripts[n];s._initialized&&!s._postInitialized&&s.enabled&&(s._postInitialized=!0,s.postInitialize&&this._scriptMethod(s,mp))}this._endLooping(e)},t._beginLooping=function(){var e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e},t._endLooping=function(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()},t._onSetEnabled=function(e,n,r){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1},t._checkState=function(){var e,n=this,r=this.enabled&&this.entity.enabled;if(r!==this._oldState){this._oldState=r,this.fire(r?"enable":"disable"),this.fire("state",r),r?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);for(var s=this._beginLooping(),l=0,u=this.scripts.length;l<u;l++)e=this,function(c,h){var f=e.scripts[c];f.once("preInitialize",function(){n.initializeAttributes(f)}),f.enabled=f._enabled}(l);this._endLooping(s)}},t._onBeforeRemove=function(){this.fire("remove");for(var e=this._beginLooping(),n=0;n<this.scripts.length;n++){var r=this.scripts[n];r&&this.destroy(r.__scriptType.__name)}this._endLooping(e)},t._removeDestroyedScripts=function(){var e=this._destroyedScripts.length;if(e){for(var n=0;n<e;n++){var r=this._destroyedScripts[n];this._removeScriptInstance(r)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}},t._onInitializeAttributes=function(){for(var e=0,n=this.scripts.length;e<n;e++){var r=this.scripts[e];this.initializeAttributes(r)}},t.initializeAttributes=function(e){if(Sr(e,zi))e.__initializeAttributes();else{var n,r=e.__scriptType.__name,s=this._attributeDataMap.get(r);if(!s)return;var l=(n=this.system.app.scripts)==null?void 0:n.getSchema(r);dT(this.system.app,l.attributes,s,e)}},t._scriptMethod=function(e,n,r){e[n](r)},t._onInitialize=function(){for(var e=this._scripts,n=this._beginLooping(),r=0,s=e.length;r<s;r++){var l=e[r];!l._initialized&&l.enabled&&(l._initialized=!0,l.initialize&&this._scriptMethod(l,pp))}this._endLooping(n)},t._onPostInitialize=function(){this.onPostStateChange()},t._onUpdate=function(e){var n=this._updateList;if(n.length){var r=this._beginLooping();for(n.loopIndex=0;n.loopIndex<n.length;n.loopIndex++){var s=n.items[n.loopIndex];s.enabled&&this._scriptMethod(s,"update",e)}this._endLooping(r)}},t._onPostUpdate=function(e){var n=this._postUpdateList;if(n.length){var r=this._beginLooping();for(n.loopIndex=0;n.loopIndex<n.length;n.loopIndex++){var s=n.items[n.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",e)}this._endLooping(r)}},t._insertScriptInstance=function(e,n,r){n===-1?(this._scripts.push(e),e.__executionOrder=r,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(n,0,e),e.__executionOrder=n,this._resetExecutionOrder(n+1,r+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))},t._removeScriptInstance=function(e){var n=this._scripts.indexOf(e);return n===-1||(this._scripts.splice(n,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),n},t._resetExecutionOrder=function(e,n){for(var r=e;r<n;r++)this._scripts[r].__executionOrder=r},t._resolveEntityScriptAttribute=function(e,n,r,s,l,u){if(e.array){var c=r.length;if(c){for(var h=r.slice(),f=0;f<c;f++){var d=Sr(h[f],ve)?h[f].getGuid():h[f];u[d]&&(h[f]=s?u[d].getGuid():u[d])}l[n]=h}}else{if(Sr(r,ve))r=r.getGuid();else if(typeof r!="string")return;u[r]&&(l[n]=u[r])}},t.has=function(e){if(typeof e=="string")return!!this._scriptsIndex[e];if(!e)return!1;var n=e.__name,r=this._scriptsIndex[n];return Sr(r&&r.instance,e)},t.get=function(e){if(typeof e=="string"){var n=this._scriptsIndex[e];return n?n.instance:null}if(!e)return null;var r=e.__name,s=this._scriptsIndex[r],l=s&&s.instance;return Sr(l,e)?l:null},t.create=function(e,n){n===void 0&&(n={});var r=this,s=e,l=e;if(typeof s=="string")s=this.system.app.scripts.get(s);else if(s){var u,c,h,f=(h=_T(s))[0].toLowerCase()+h.substring(1);Sr(s.prototype,zi)||s.scriptName,(u=s).__name!=null||(u.__name=(c=s.scriptName)!=null?c:f),l=s.__name}if(s){if(!this._scriptsIndex[l]||!this._scriptsIndex[l].instance){var d=new s({app:this.system.app,entity:this.entity,enabled:!n.hasOwnProperty("enabled")||n.enabled,attributes:n.attributes||{}});n.properties&&yT(n.properties)==="object"&&Object.assign(d,n.properties),Sr(d,zi)||this._attributeDataMap.set(l,n.attributes);var p=this._scripts.length,_=-1;return typeof n.ind=="number"&&n.ind!==-1&&p>n.ind&&(_=n.ind),this._insertScriptInstance(d,_,p),this._scriptsIndex[l]={instance:d,onSwap:function(){r.swap(l)}},this[l]=d,n.preloading||this.initializeAttributes(d),this.fire("create",l,d),this.fire("create:"+l,d),this.system.app.scripts.on("swap:"+l,this._scriptsIndex[l].onSwap),!n.preloading&&(d.enabled&&!d._initialized&&(d._initialized=!0,d.initialize&&this._scriptMethod(d,pp)),d.enabled&&!d._postInitialized&&(d._postInitialized=!0,d.postInitialize&&this._scriptMethod(d,mp))),d}}else this._scriptsIndex[l]={awaiting:!0,ind:this._scripts.length};return null},t.destroy=function(e){var n=e,r=e;typeof r=="string"?r=this.system.app.scripts.get(r):r&&(n=r.__name);var s=this._scriptsIndex[n];if(delete this._scriptsIndex[n],!s)return!1;this._attributeDataMap.delete(n);var l=s.instance;if(l&&!l._destroyed)if(l.enabled=!1,l._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(l);else{var u=this._removeScriptInstance(l);u>=0&&this._resetExecutionOrder(u,this._scripts.length)}return this.system.app.scripts.off("swap:"+n,s.onSwap),delete this[n],this.fire("destroy",n,l||null),this.fire("destroy:"+n,l||null),l&&l.fire("destroy"),!0},t.swap=function(e){var n=e,r=e;typeof r=="string"?r=this.system.app.scripts.get(r):r&&(n=r.__name);var s=this._scriptsIndex[n];if(!s||!s.instance)return!1;var l=s.instance,u=this._scripts.indexOf(l),c=new r({app:this.system.app,entity:this.entity,enabled:l.enabled,attributes:l.__attributes});return!!c.swap&&(this.initializeAttributes(c),this._scripts[u]=c,this._scriptsIndex[n].instance=c,this[n]=c,c.__executionOrder=u,l.update&&this._updateList.remove(l),l.postUpdate&&this._postUpdateList.remove(l),c.update&&this._updateList.insert(c),c.postUpdate&&this._postUpdateList.insert(c),this._scriptMethod(c,"swap",l),this.fire("swap",n,c),this.fire("swap:"+n,c),!0)},t.resolveDuplicatedEntityReferenceProperties=function(e,n){var r=this.entity.script;for(var s in e._scriptsIndex){var l=this.system.app.scripts.get(s);if(l){var u=e._scriptsIndex[s];if(u&&u.instance){var c=r[s].__attributesRaw,h=r[s].__attributes;if(c||h){var f=!!c,d=u.instance.__attributes;for(var p in d)if(d[p]){var _=l.attributes.get(p);if(_){if(_.type==="entity")this._resolveEntityScriptAttribute(_,p,d[p],f,c||h,n);else if(_.type==="json"&&Array.isArray(_.schema))for(var g=d[p],y=c?c[p]:h[p],v=0;v<_.schema.length;v++){var x=_.schema[v];if(x.type==="entity")if(_.array)for(var S=0;S<g.length;S++)this._resolveEntityScriptAttribute(x,x.name,g[S][x.name],f,y[S],n);else this._resolveEntityScriptAttribute(x,x.name,g[x.name],f,y,n)}}}}}}}},t.move=function(e,n){var r=this._scripts.length;if(n>=r||n<0)return!1;var s=e,l=e;typeof l!="string"?l=e.__name:s=null;var u=this._scriptsIndex[l];if(!u||!u.instance)return!1;var c=u.instance;if(s&&!Sr(c,s))return!1;var h=this._scripts.indexOf(c);return h!==-1&&h!==n&&(this._scripts.splice(n,0,this._scripts.splice(h,1)[0]),this._resetExecutionOrder(0,r),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",l,c,n,h),this.fire("move:"+l,c,n,h),!0)},i=[{key:"scripts",get:function(){return this._scripts},set:function(e){var n,r=this;for(var s in this._scriptsData=e,e)n=this,function(l){if(e.hasOwnProperty(l)){var u=n._scriptsIndex[l];if(u&&(typeof e[l].enabled=="boolean"&&(u.once("preInitialize",function(){r.initializeAttributes(u)}),u.enabled=!!e[l].enabled),yT(e[l].attributes)==="object")){for(var c in e[l].attributes)if(!yr.reservedNames.has(c)){if(!u.__attributes.hasOwnProperty(c)){var h=n.system.app.scripts.get(l);h&&h.attributes.add(c,{})}u[c]=e[l].attributes[c]}}}}(s)}},{key:"enabled",get:function(){return this._enabled},set:function(e){var n=this._enabled;this._enabled=e,this.fire("set","enabled",n,e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de);ti.EVENT_CREATE="create",ti.EVENT_DESTROY="destroy",ti.EVENT_ENABLE="enable",ti.EVENT_DISABLE="disable",ti.EVENT_REMOVE="remove",ti.EVENT_STATE="state",ti.EVENT_MOVE="move",ti.EVENT_ERROR="error";var PD=function(){this.enabled=!0};function ST(o,a){return(ST=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ac=0,xT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="script",e.ComponentType=ti,e.DataType=PD,e._components=new Qa({sortBy:"_executionOrder"}),e._enabledComponents=new Qa({sortBy:"_executionOrder"}),e.preloading=!0,e.on("beforeremove",e._onBeforeRemove,e),e.app.systems.on("initialize",e._onInitialize,e),e.app.systems.on("postInitialize",e._onPostInitialize,e),e.app.systems.on("update",e._onUpdate,e),e.app.systems.on("postUpdate",e._onPostUpdate,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ST(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e){if(t._executionOrder=Ac++,this._components.append(t),Ac>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(var n=0;n<e.order.length;n++)t.create(e.order[n],{enabled:e.scripts[e.order[n]].enabled,attributes:e.scripts[e.order[n]].attributes,preloading:this.preloading})}},i.cloneComponent=function(t,e){for(var n=[],r={},s=0;s<t.script._scripts.length;s++){var l,u=t.script._scripts[s],c=u.__scriptType.__name;n.push(c);var h=((l=t.script._attributeDataMap)==null?void 0:l.get(c))||{};for(var f in u.__attributes)h[f]=u.__attributes[f];r[c]={enabled:u._enabled,attributes:h}}for(var d in t.script._scriptsIndex)d.awaiting&&n.splice(d.ind,0,d);var p={enabled:t.script.enabled,order:n,scripts:r};return this.addComponent(e,p)},i._resetExecutionOrder=function(){Ac=0;for(var t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=Ac++},i._callComponentMethod=function(t,e,n){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](n)},i._onInitialize=function(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")},i._onPostInitialize=function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},i._onUpdate=function(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)},i._onPostUpdate=function(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)},i._addComponentToEnabled=function(t){this._enabledComponents.insert(t)},i._removeComponentFromEnabled=function(t){this._enabledComponents.remove(t)},i._onBeforeRemove=function(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)},i.destroy=function(){o.prototype.destroy.call(this),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)},a}(We);function bT(o,a){return(bT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var _p=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._layers=[0],r._instance=null,r._materialTmp=null,r._customAabb=null,r._evtLayersChanged=null,r._evtLayerAdded=null,r._evtLayerRemoved=null,r._castShadows=!1,r._assetReference=new Ta("asset",r,e.app.assets,{add:r._onGSplatAssetAdded,load:r._onGSplatAssetLoad,remove:r._onGSplatAssetRemove,unload:r._onGSplatAssetUnload},r),n.on("remove",r.onRemoveChild,r),n.on("removehierarchy",r.onRemoveChild,r),n.on("insert",r.onInsertChild,r),n.on("inserthierarchy",r.onInsertChild,r),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&bT(a,o);var i,t=a.prototype;return t.destroyInstance=function(){if(this._instance){var e;this.removeFromLayers(),(e=this._instance)==null||e.destroy(),this._instance=null}},t.addToLayers=function(){var e=(n=this.instance)==null?void 0:n.meshInstance;if(e)for(var n,r,s=this.system.app.scene.layers,l=0;l<this._layers.length;l++)(r=s.getLayerById(this._layers[l]))==null||r.addMeshInstances([e])},t.removeFromLayers=function(){var e=(n=this.instance)==null?void 0:n.meshInstance;if(e)for(var n,r,s=this.system.app.scene.layers,l=0;l<this._layers.length;l++)(r=s.getLayerById(this._layers[l]))==null||r.removeMeshInstances([e])},t.onRemoveChild=function(){this.removeFromLayers()},t.onInsertChild=function(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()},t.onRemove=function(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},t.onLayersChanged=function(e,n){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),n.on("add",this.onLayerAdded,this),n.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){!(0>this.layers.indexOf(e.id))&&this._instance&&e.addMeshInstances(this._instance.meshInstance)},t.onLayerRemoved=function(e){!(0>this.layers.indexOf(e.id))&&this._instance&&e.removeMeshInstances(this._instance.meshInstance)},t.onEnable=function(){var e=this.system.app.scene,n=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),n&&(this._evtLayerAdded=n.on("add",this.onLayerAdded,this),this._evtLayerRemoved=n.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()},t.onDisable=function(){var e,n,r,s=this.system.app.scene.layers;(e=this._evtLayersChanged)==null||e.off(),this._evtLayersChanged=null,s&&((n=this._evtLayerAdded)==null||n.off(),this._evtLayerAdded=null,(r=this._evtLayerRemoved)==null||r.off(),this._evtLayerRemoved=null),this.removeFromLayers()},t.hide=function(){this._instance&&(this._instance.meshInstance.visible=!1)},t.show=function(){this._instance&&(this._instance.meshInstance.visible=!0)},t._onGSplatAssetAdded=function(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))},t._onGSplatAssetLoad=function(){this.destroyInstance();var e=this._assetReference.asset;e&&(this.instance=new ES(e.resource,this._materialTmp),this._materialTmp=null,this.customAabb=this.instance.resource.aabb.clone())},t._onGSplatAssetUnload=function(){this.destroyInstance()},t._onGSplatAssetRemove=function(){this._onGSplatAssetUnload()},i=[{key:"customAabb",get:function(){return this._customAabb},set:function(e){var n,r;this._customAabb=e,(r=this._instance)==null||(n=r.meshInstance)==null||n.setCustomAabb(this._customAabb)}},{key:"instance",get:function(){return this._instance},set:function(e){if(this.destroyInstance(),this._instance=e,this._instance){var n=this._instance.meshInstance;n.node||(n.node=this.entity),n.castShadow=this._castShadows,n.setCustomAabb(this._customAabb),this.enabled&&this.entity.enabled&&this.addToLayers()}}},{key:"material",get:function(){var e,n,r;return(r=(n=(e=this._instance)==null?void 0:e.material)!=null?n:this._materialTmp)!=null?r:null},set:function(e){this._instance?this._instance.material=e:this._materialTmp=e}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var n,r=(n=this.instance)==null?void 0:n.meshInstance;if(r){var s=this.layers,l=this.system.app.scene;if(this._castShadows&&!e)for(var u=0;u<s.length;u++){var c=l.layers.getLayerById(this.layers[u]);c&&c.removeShadowCasters([r])}if(r.castShadow=e,!this._castShadows&&e)for(var h=0;h<s.length;h++){var f=l.layers.getLayerById(s[h]);f&&f.addShadowCasters([r])}}this._castShadows=e}}},{key:"layers",get:function(){return this._layers},set:function(e){this.removeFromLayers(),this._layers.length=0;for(var n=0;n<e.length;n++)this._layers[n]=e[n];this.enabled&&this.entity.enabled&&this.addToLayers()}},{key:"asset",get:function(){return this._assetReference.id},set:function(e){var n=($!=null&&typeof Symbol<"u"&&$[Symbol.hasInstance]?$[Symbol.hasInstance](e):Q(e,$))?e.id:e;this._assetReference.id!==n&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=n,this._assetReference.asset&&this._onGSplatAssetAdded())}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(de),ID=function(){this.enabled=!0};function TT(o,a){return(TT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var vp=["enabled"],Sl=["castShadows","asset","layers","material"],ET=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t)||this).id="gsplat",e.ComponentType=_p,e.DataType=ID,e.schema=vp,e.on("beforeremove",e.onRemove,e),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&TT(a,o);var i=a.prototype;return i.initializeComponentData=function(t,e,n){e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(var r=0;r<Sl.length;r++)e.hasOwnProperty(Sl[r])&&(t[Sl[r]]=e[Sl[r]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Se(new E(e.aabbCenter),new E(e.aabbHalfExtents))),o.prototype.initializeComponentData.call(this,t,e,vp)},i.cloneComponent=function(t,e){var n=t.gsplat,r={};Sl.forEach(function(l){l==="material"?r[l]=n[l].clone():r[l]=n[l]}),r.enabled=n.enabled;var s=this.addComponent(e,r);return n.customAabb&&(s.customAabb=n.customAabb.clone()),s},i.onRemove=function(t,e){e.onRemove()},a}(We);function wT(o,a){return(wT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}de._buildAccessors(_p.prototype,vp);var gp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){var e;return e=o.apply(this,arguments)||this,e._meshes=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&wT(a,o);var i,t=a.prototype;return t.destroy=function(){this.meshes=null},t.decRefMeshes=function(){var e,n=this;(e=this._meshes)==null||e.forEach(function(r,s){r&&(r.decRefCount(),r.refCount<1&&(r.destroy(),n._meshes[s]=null))})},t.incRefMeshes=function(){var e;(e=this._meshes)==null||e.forEach(function(n){n==null||n.incRefCount()})},i=[{key:"meshes",get:function(){return this._meshes},set:function(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function AT(o,a){return(AT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Cc(o){if(this.resource){var a=o.resource,i=a.renders&&a.renders[this.data.renderIndex];i&&(this.resource.meshes=i.resource.meshes)}}function CT(o){this.registry.off("load:"+o.id,Cc,this),this.registry.on("load:"+o.id,Cc,this),this.registry.off("remove:"+o.id,PT,this),this.registry.once("remove:"+o.id,PT,this),o.resource?Cc.call(this,o):this.registry.load(o)}function PT(o){this.registry.off("load:"+o.id,Cc,this),this.resource&&this.resource.destroy()}gp.EVENT_SETMESHES="set:meshes";var IT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"render")||this)._registry=t.assets,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&AT(a,o);var i=a.prototype;return i.open=function(t,e){return new gp},i.patch=function(t,e){if(t.data.containerAsset){var n=e.get(t.data.containerAsset);if(!n)return void e.once("add:"+t.data.containerAsset,CT,t);CT.call(t,n)}},a}(Oe),yp=function(){var o;function a(i,t,e,n){this._paths=i,this._input=t,this._output=e,this._interpolation=n}return o=[{key:"paths",get:function(){return this._paths}},{key:"input",get:function(){return this._input}},{key:"output",get:function(){return this._output}},{key:"interpolation",get:function(){return this._interpolation}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),xl=function(){var o;function a(i,t){this._components=i,this._data=t}return o=[{key:"components",get:function(){return this._components}},{key:"data",get:function(){return this._data}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function LD(o,a){var i,t=function(h,f){switch(f){case i.DT_INT8:return new Int8Array(h.buffer,h.byteOffset,h.byteLength);case i.DT_INT16:return new Int16Array(h.buffer,h.byteOffset,h.byteLength/2);case i.DT_INT32:return new Int32Array(h.buffer,h.byteOffset,h.byteLength/4);case i.DT_UINT8:return new Uint8Array(h.buffer,h.byteOffset,h.byteLength);case i.DT_UINT16:return new Uint16Array(h.buffer,h.byteOffset,h.byteLength/2);case i.DT_UINT32:return new Uint32Array(h.buffer,h.byteOffset,h.byteLength/4);case i.DT_FLOAT32:return new Float32Array(h.buffer,h.byteOffset,h.byteLength/4)}return null},e=function(h){switch(h){case i.DT_INT8:break;case i.DT_INT16:return 2;case i.DT_INT32:return 4;case i.DT_UINT8:break;case i.DT_UINT16:return 2;case i.DT_UINT32:case i.DT_FLOAT32:return 4}return 1},n=function(h){return h.num_components()*e(h.data_type())},r={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},s=function(h,f){for(var d=function(k,D,O){k[0]=D[0]-O[0],k[1]=D[1]-O[1],k[2]=D[2]-O[2]},p=function(k,D){var O=k[D+0],F=k[D+1],N=k[D+2],j=1/Math.sqrt(O*O+F*F+N*N);k[D+0]*=j,k[D+1]*=j,k[D+2]*=j},_=function(k,D,O){for(var F=0;F<3;++F)k[F]=D[O+F]},g=f.length/3,y=h.length/3,v=new Float32Array(h.length),x=[0,0,0],S=[0,0,0],T=[0,0,0],b=[0,0,0],w=[0,0,0],A=[0,0,0],C=0;C<g;++C){var L=3*f[3*C+0],I=3*f[3*C+1],P=3*f[3*C+2];_(x,h,L),_(S,h,I),_(T,h,P),d(b,S,x),d(w,T,x),A[0]=b[1]*w[2]-w[1]*b[2],A[1]=b[2]*w[0]-w[2]*b[0],A[2]=b[0]*w[1]-w[0]*b[1],p(A,0);for(var M=0;M<3;++M)v[L+M]+=A[M],v[I+M]+=A[M],v[P+M]+=A[M]}for(var R=0;R<y;++R)p(v,3*R);return new Uint8Array(v.buffer)},l=function(h){var f={},d=new i.DecoderBuffer;d.Init(h,h.length);var p=new i.Decoder;if(p.GetEncodedGeometryType(d)!==i.TRIANGULAR_MESH)return f.error="Failed to decode draco mesh: not a mesh",f;var _=new i.Mesh,g=p.DecodeBufferToMesh(d,_);if(!g||!g.ok()||i.getPointer(_)===0)return f.error="Failed to decode draco asset",f;var y=3*_.num_faces(),v=65535>=_.num_points(),x=y*(v?2:4),S=i._malloc(x);v?(p.GetTrianglesUInt16Array(_,x,S),f.indices=new Uint16Array(i.HEAPU16.buffer,S,y).slice().buffer):(p.GetTrianglesUInt32Array(_,x,S),f.indices=new Uint32Array(i.HEAPU32.buffer,S,y).slice().buffer),i._free(S);for(var T=[],b=0;b<_.num_attributes();++b)T.push(p.GetAttribute(_,b));T.sort(function(Y,W){var ie,te;return((ie=r[Y.attribute_type()])!=null?ie:r.length)-((te=r[W.attribute_type()])!=null?te:r.length)}),f.attributes=T.map(function(Y){return Y.unique_id()});var w=0,A=T.map(function(Y){var W=w;return w+=4*Math.ceil(n(Y)/4),W}),C=T.some(function(Y){return Y.attribute_type()===1}),L=A[1];if(!C){for(var I=1;I<A.length;++I)A[I]+=12;w+=12}f.vertices=new ArrayBuffer(_.num_points()*w);for(var P=new Uint8Array(f.vertices),M=0;M<_.num_attributes();++M){var R=T[M],k=n(R),D=_.num_points()*k,O=i._malloc(D);p.GetAttributeDataArrayForAllPoints(_,R,R.data_type(),D,O);for(var F=new Uint8Array(i.HEAPU8.buffer,O,D),N=0;N<_.num_points();++N)for(var j=0;j<k;++j)P[N*w+A[M]+j]=F[N*k+j];if(!C&&R.attribute_type()===0)for(var z=s(t(F,R.data_type()),v?new Uint16Array(f.indices):new Uint32Array(f.indices)),V=0;V<_.num_points();++V)for(var H=0;H<12;++H)P[V*w+L+H]=z[12*V+H];i._free(O)}return i.destroy(_),i.destroy(p),i.destroy(d),f},u=function(h){var f=l(new Uint8Array(h.buffer));self.postMessage({jobId:h.jobId,error:f.error,indices:f.indices,vertices:f.vertices,attributes:f.attributes},[f.indices,f.vertices].filter(function(d){return d!=null}))},c=[];self.onmessage=function(h){var f=h.data;switch(f.type){case"init":self.DracoDecoderModule({instantiateWasm:function(d,p){return WebAssembly.instantiate(f.module,d).then(function(_){return p(_)}).catch(function(_){}),{}}}).then(function(d){i=d,c.forEach(function(p){return u(p)})});break;case"decodeMesh":i?u(f):c.push(f)}}}var DD=function(){function o(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=function(i,t){i.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}var a=o.prototype;return a.init=function(i){var t=this;for(i.forEach(function(s){s.addEventListener("message",function(l){var u=l.data,c=t.jobCallbacks.get(u.jobId);if(c&&c(u.error,{indices:u.indices,vertices:u.vertices,attributes:u.attributes}),t.jobCallbacks.delete(u.jobId),t.jobQueue.length>0){var h=t.jobQueue.shift();t.run(s,h)}else{var f=t.workers[2].indexOf(s);if(f!==-1)t.workers[2].splice(f,1),t.workers[1].push(s);else{var d=t.workers[1].indexOf(s);d!==-1&&(t.workers[1].splice(d,1),t.workers[0].push(s))}}})}),this.workers[0]=i;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){var e=this.jobQueue.shift();if(this.workers[0].length>0){var n=this.workers[0].shift();this.workers[1].push(n),this.run(n,e)}else{var r=this.workers[1].shift();this.workers[2].push(r),this.run(r,e)}}},a.enqueueJob=function(i,t){var e={jobId:this.jobId++,buffer:i};if(this.jobCallbacks.set(e.jobId,t),this.workers[0].length>0){var n=this.workers[0].shift();this.workers[1].push(n),this.run(n,e)}else if(this.workers[1].length>0){var r=this.workers[1].shift();this.workers[2].push(r),this.run(r,e)}else this.jobQueue.push(e)},o}(),MD=function(o){var a=function(){return fetch(o).then(function(i){return i.arrayBuffer()}).then(function(i){return WebAssembly.compile(i)})};return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(o)).catch(function(i){return a()}):a()},LT=function(o){if(Gl)return!0;if(!o)if(Ph)o=Ph;else{var a,i=Rh.getConfig("DracoDecoderModule");o=i?{jsUrl:i.glueUrl,wasmUrl:i.wasmUrl,numWorkers:i.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!!o.jsUrl&&!!o.wasmUrl&&(Gl=new DD,Promise.all([(a=o.jsUrl,new Promise(function(t,e){Fe.get(a,{cache:!0,responseType:"text",retry:!0,maxRetries:3},function(n,r){n?e(n):t(r)})})),MD(o.wasmUrl)]).then(function(t){for(var e=t[0],n=t[1],r=new Blob([["/* draco */",e,"/* worker */",`(
`+LD.toString()+`
)()

`].join(`
`)],{type:"application/javascript"}),s=URL.createObjectURL(r),l=Math.max(1,Math.min(16,o.numWorkers||1)),u=[],c=0;c<l;++c){var h=new Worker(s);h.postMessage({type:"init",module:n}),u.push(h)}Gl.init(u)}),!0)};function DT(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function MT(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function Pc(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function RT(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return DT(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return DT(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var RD=function(){function o(){}return o.prototype.destroy=function(){this.renders&&this.renders.forEach(function(a){a.meshes=null})},o}(),OT=function(o){return/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(o)},bl=function(o){switch(o){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Ic=function(o){switch(o){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},OD=function(o){switch(o){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},kD=function(o){switch(o){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},Lc={POSITION:oe,NORMAL:bt,TANGENT:hn,COLOR_0:st,JOINTS_0:Pt,WEIGHTS_0:fn,TEXCOORD_0:mt,TEXCOORD_1:Hn,TEXCOORD_2:Dr,TEXCOORD_3:Mr,TEXCOORD_4:Rr,TEXCOORD_5:Or,TEXCOORD_6:kr,TEXCOORD_7:Nr},kT=((Ct={})[oe]=0,Ct[bt]=1,Ct[hn]=2,Ct[st]=3,Ct[Pt]=4,Ct[fn]=5,Ct[mt]=6,Ct[Hn]=7,Ct[Dr]=8,Ct[Mr]=9,Ct[Rr]=10,Ct[Or]=11,Ct[kr]=12,Ct[Nr]=13,Ct),ND=function(o){switch(o){case 0:return function(a){return Math.max(a/127,-1)};case 1:return function(a){return a/255};case 2:return function(a){return Math.max(a/32767,-1)};case 3:return function(a){return a/65535};default:return function(a){return a}}},Sp=function(o,a,i){for(var t=ND(i),e=a.length,n=0;n<e;++n)o[n]=t(a[n]);return o},fs=function(o,a,i){i===void 0&&(i=!1);var t,e=bl(o.type),n=kD(o.componentType);if(!n)return null;if(o.sparse){var r=o.sparse,s=fs(Object.assign({count:r.count,type:"SCALAR"},r.indices),a,!0),l=fs(Object.assign({count:r.count,type:o.type,componentType:o.componentType},r.values),a,!0);t=o.hasOwnProperty("bufferView")?fs({bufferView:o.bufferView,byteOffset:o.byteOffset,componentType:o.componentType,count:o.count,type:o.type},a,!0).slice():new n(o.count*e);for(var u=0;u<r.count;++u)for(var c=s[u],h=0;h<e;++h)t[c*e+h]=l[u*e+h]}else if(o.hasOwnProperty("bufferView")){var f=a[o.bufferView];if(i&&f.hasOwnProperty("byteStride")){for(var d=e*n.BYTES_PER_ELEMENT,p=new ArrayBuffer(o.count*d),_=new Uint8Array(p),g=0,y=0;y<o.count;++y)for(var v=(o.byteOffset||0)+y*f.byteStride,x=0;x<d;++x)_[g++]=f[v++];t=new n(p)}else t=new n(f.buffer,f.byteOffset+(o.byteOffset||0),o.count*e)}else t=new n(o.count*e);return t},Aa=function(o,a){var i=fs(o,a,!0);if(Pc(i,Float32Array)||!o.normalized)return i;var t=new Float32Array(i.length);return Sp(t,i,Ic(o.componentType)),t},xp=function(o){var a=o.min,i=o.max;if(!a||!i)return null;if(o.normalized){var t=Ic(o.componentType);a=Sp([],a,t),i=Sp([],i,t)}return new Se(new E((i[0]+a[0])*.5,(i[1]+a[1])*.5,(i[2]+a[2])*.5),new E((i[0]-a[0])*.5,(i[1]-a[1])*.5,(i[2]-a[2])*.5))},NT=function(o){if(!o.hasOwnProperty("mode"))return 4;switch(o.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},FD=function(o){for(var a=new Uint16Array(o),i=0;i<o;i++)a[i]=i;return a},UD=function(o,a){var i,t=o[oe];if(t&&t.components===3){if(t.size!==t.stride){var e=t.stride/Ns[t.type],n=new Ur[t.type](t.buffer,t.offset,t.count*e);i=new Ur[t.type](3*t.count);for(var r=0;r<t.count;++r)i[3*r+0]=n[r*e+0],i[3*r+1]=n[r*e+1],i[3*r+2]=n[r*e+2]}else i=new Ur[t.type](t.buffer,t.offset,3*t.count);var s=t.count;a||(a=FD(s));var l=dd(i,a),u=new Float32Array(l.length);u.set(l),o[bt]={buffer:u.buffer,size:12,offset:0,stride:12,count:s,components:3,type:6}}},BD=function(o){var a=new ee(o.device,o);return a._levels=function(i){for(var t=[],e=0;e<i._levels.length;++e){var n=[];if(i.cubemap)for(var r=0;r<6;++r)n.push(i._levels[e][r]);else n=i._levels[e];t.push(n)}return t}(o),a},VD=function(o){var a=new $(""+o.name+"_clone",o.type,o.file,o.data,o.options);return a.loaded=!0,a.resource=BD(o.resource),o.registry.add(a),a},zD=function(o,a){var i,t,e,n,r,s,l,u,c,h=a[oe];if(!h)return null;var f=h.count,d=[];for(var p in a)if(a.hasOwnProperty(p)){var _={semantic:p,components:a[p].components,type:a[p].type,normalize:!!a[p].normalize};!Ot.isElementValid(o,_)&&_.components++,d.push(_)}d.sort(function(w,A){return kT[w.semantic]-kT[A.semantic]});var g=new Ot(o,d),y=!0;for(i=0;i<g.elements.length;++i)if(s=(n=a[(r=g.elements[i]).name]).offset-h.offset,n.buffer!==h.buffer||n.stride!==r.stride||n.size!==r.size||s!==r.offset){y=!1;break}var v=new Rt(o,g,f),x=new Uint32Array(v.lock());if(y)l=new Uint32Array(h.buffer,h.offset,f*v.format.size/4),x.set(l);else for(i=0;i<v.format.elements.length;++i){u=(r=v.format.elements[i]).stride/4,c=(n=a[r.name]).stride/4,l=new Uint32Array(n.buffer,n.offset,(n.count-1)*c+(n.size+3)/4);var S=0,T=r.offset/4,b=Math.floor((n.size+3)/4);for(t=0;t<f;++t){for(e=0;e<b;++e)x[T+e]=l[S+e];S+=c,T+=u}}return v.unlock(),v},GD=function(o,a,i,t,e,n){var r={},s=[];for(var l in a)a.hasOwnProperty(l)&&Lc.hasOwnProperty(l)&&(r[l]=a[l],s.push(l+":"+a[l]));s.sort();var u=s.join(),c=n[u];if(!c){var h={};for(var f in r){var d=t[a[f]],p=fs(d,e),_=e[d.bufferView],g=Lc[f],y=bl(d.type)*OD(d.componentType),v=_&&_.hasOwnProperty("byteStride")?_.byteStride:y;h[g]={buffer:p.buffer,size:y,offset:p.byteOffset,stride:v,count:d.count,components:bl(d.type),type:Ic(d.componentType),normalize:d.normalized}}h.hasOwnProperty(bt)||UD(h,i),c=zD(o,h),n[u]=c}return c},HD=function(o,a,i,t,e,n){var r,s,l,u=a.joints,c=u.length,h=[];if(a.hasOwnProperty("inverseBindMatrices")){var f=fs(i[a.inverseBindMatrices],t,!0),d=[];for(r=0;r<c;r++){for(s=0;s<16;s++)d[s]=f[16*r+s];(l=new X).set(d),h.push(l)}}else for(r=0;r<c;r++)l=new X,h.push(l);var p=[];for(r=0;r<c;r++)p[r]=e[u[r]].name;var _=p.join("#"),g=n.get(_);return g||(g=new vd(o,h,p),n.set(_,g)),g},WD=function(o,a,i,t,e,n,r){var s=new ye(o);s.aabb=xp(i[a.attributes.POSITION]);for(var l,u,c=[],h=RT(Object.entries(a.attributes));!(u=h()).done;){var f,d=u.value,p=d[0],_=i[d[1]],g=Lc[p],y=Ic(_.componentType);c.push({semantic:g,components:bl(_.type),type:y,normalize:(f=_.normalized)!=null?f:g===st&&(y===1||y===3)})}if(r.push(new Promise(function(S,T){var b,w=a.extensions.KHR_draco_mesh_compression;b=t[w.bufferView].slice().buffer,LT()&&Gl.enqueueJob(b,function(A,C){if(A)T(A);else{for(var L,I,P={},M=RT(Object.entries(w.attributes));!(I=M()).done;){var R=I.value,k=R[0],D=R[1];P[Lc[k]]=C.attributes.indexOf(D)}c.sort(function(V,H){return P[V.semantic]-P[H.semantic]}),(L=a.attributes)!=null&&L.NORMAL||c.splice(1,0,{semantic:"NORMAL",components:3,type:6});var O=new Ot(o,c),F=C.vertices.byteLength/O.size,N=C.indices.byteLength/(F<=65535?2:4),j=new Rt(o,O,F,{data:C.vertices}),z=new Yn(o,F<=65535?1:2,N,0,C.indices);s.vertexBuffer=j,s.indexBuffer[0]=z,s.primitive[0].type=NT(a),s.primitive[0].base=0,s.primitive[0].count=z?N:F,s.primitive[0].indexed=!!z,S()}})})),a==null||(l=a.extensions)==null?void 0:l.KHR_materials_variants){var v=a.extensions.KHR_materials_variants,x={};v.mappings.forEach(function(S){S.variants.forEach(function(T){x[T]=S.material})}),e[s.id]=x}return n[s.id]=a.material,s},jD=function(o,a,i,t,e,n,r,s,l){var u=[];return a.primitives.forEach(function(c){var h;if((h=c.extensions)!=null&&h.KHR_draco_mesh_compression)u.push(WD(o,c,i,t,n,r,l));else{var f=c.hasOwnProperty("indices")?fs(i[c.indices],t,!0):null,d=GD(o,c.attributes,f,i,t,e),p=NT(c),_=new ye(o);if(_.vertexBuffer=d,_.primitive[0].type=p,_.primitive[0].base=0,_.primitive[0].indexed=f!==null,f!==null){(g=Pc(f,Uint8Array)?0:Pc(f,Uint16Array)?1:2)==0&&o.isWebGPU&&(g=1,f=new Uint16Array(f));var g,y=new Yn(o,g,f.length,0,f);_.indexBuffer[0]=y,_.primitive[0].count=f.length}else _.primitive[0].count=d.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){var v=c.extensions.KHR_materials_variants,x={};v.mappings.forEach(function(b){b.variants.forEach(function(w){x[w]=b.material})}),n[_.id]=x}r[_.id]=c.material;var S=i[c.attributes.POSITION];if(_.aabb=xp(S),c.hasOwnProperty("targets")){var T=[];c.targets.forEach(function(b,w){var A={};b.hasOwnProperty("POSITION")&&(A.deltaPositions=Aa(S=i[b.POSITION],t),A.aabb=xp(S)),b.hasOwnProperty("NORMAL")&&(A.deltaNormals=Aa(S=i[b.NORMAL],t)),a.hasOwnProperty("extras")&&a.extras.hasOwnProperty("targetNames")?A.name=a.extras.targetNames[w]:A.name=w.toString(10),a.hasOwnProperty("weights")&&(A.defaultWeight=a.weights[w]),A.preserveData=s.morphPreserveData,T.push(new ud(A))}),_.morph=new ku(T,o,{preferHighPrecision:s.morphPreferHighPrecision})}u.push(_)}}),u},lt=function(o,a,i){var t,e,n=o.texCoord;if(n)for(e=0;e<i.length;++e)a[""+i[e]+"MapUv"]=n;var r=(t=o.extensions)==null?void 0:t.KHR_texture_transform;if(r){var s=r.offset||[0,0],l=r.scale||[1,1],u=r.rotation?-r.rotation*U.RAD_TO_DEG:0,c=new G(l[0],l[1]),h=new G(s[0],1-l[1]-s[1]);for(e=0;e<i.length;++e)a[""+i[e]+"MapTiling"]=c,a[""+i[e]+"MapOffset"]=h,a[""+i[e]+"MapRotation"]=u}},XD=function(o,a,i){var t,e;if(o.hasOwnProperty("diffuseFactor")?(t=o.diffuseFactor,a.diffuse.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2)),a.opacity=t[3]):(a.diffuse.set(1,1,1),a.opacity=1),o.hasOwnProperty("diffuseTexture")){var n=o.diffuseTexture;a.diffuseMap=e=i[n.index],a.diffuseMapChannel="rgb",a.opacityMap=e,a.opacityMapChannel="a",lt(n,a,["diffuse","opacity"])}if(a.useMetalness=!1,o.hasOwnProperty("specularFactor")?(t=o.specularFactor,a.specular.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))):a.specular.set(1,1,1),o.hasOwnProperty("glossinessFactor")?a.gloss=o.glossinessFactor:a.gloss=1,o.hasOwnProperty("specularGlossinessTexture")){var r=o.specularGlossinessTexture;a.specularMap=a.glossMap=i[r.index],a.specularMapChannel="rgb",a.glossMapChannel="a",lt(r,a,["gloss","metalness"])}},YD=function(o,a,i){if(o.hasOwnProperty("clearcoatFactor")?a.clearCoat=.25*o.clearcoatFactor:a.clearCoat=0,o.hasOwnProperty("clearcoatTexture")){var t=o.clearcoatTexture;a.clearCoatMap=i[t.index],a.clearCoatMapChannel="r",lt(t,a,["clearCoat"])}if(o.hasOwnProperty("clearcoatRoughnessFactor")?a.clearCoatGloss=o.clearcoatRoughnessFactor:a.clearCoatGloss=0,o.hasOwnProperty("clearcoatRoughnessTexture")){var e=o.clearcoatRoughnessTexture;a.clearCoatGlossMap=i[e.index],a.clearCoatGlossMapChannel="g",lt(e,a,["clearCoatGloss"])}if(o.hasOwnProperty("clearcoatNormalTexture")){var n=o.clearcoatNormalTexture;a.clearCoatNormalMap=i[n.index],lt(n,a,["clearCoatNormal"]),n.hasOwnProperty("scale")?a.clearCoatBumpiness=n.scale:a.clearCoatBumpiness=1}a.clearCoatGlossInvert=!0},qD=function(o,a,i){a.useLighting=!1,a.emissive.copy(a.diffuse),a.emissiveMap=a.diffuseMap,a.emissiveMapUv=a.diffuseMapUv,a.emissiveMapTiling.copy(a.diffuseMapTiling),a.emissiveMapOffset.copy(a.diffuseMapOffset),a.emissiveMapRotation=a.diffuseMapRotation,a.emissiveMapChannel=a.diffuseMapChannel,a.emissiveVertexColor=a.diffuseVertexColor,a.emissiveVertexColorChannel=a.diffuseVertexColorChannel,a.useLighting=!1,a.useSkybox=!1,a.diffuse.set(1,1,1),a.diffuseMap=null,a.diffuseVertexColor=!1},KD=function(o,a,i){if(a.useMetalnessSpecularColor=!0,o.hasOwnProperty("specularColorTexture")&&(a.specularMap=i[o.specularColorTexture.index],a.specularMapChannel="rgb",lt(o.specularColorTexture,a,["specular"])),o.hasOwnProperty("specularColorFactor")){var t=o.specularColorFactor;a.specular.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))}else a.specular.set(1,1,1);o.hasOwnProperty("specularFactor")?a.specularityFactor=o.specularFactor:a.specularityFactor=1,o.hasOwnProperty("specularTexture")&&(a.specularityFactorMapChannel="a",a.specularityFactorMap=i[o.specularTexture.index],lt(o.specularTexture,a,["specularityFactor"]))},ZD=function(o,a,i){o.hasOwnProperty("ior")&&(a.refractionIndex=1/o.ior)},QD=function(o,a,i){o.hasOwnProperty("dispersion")&&(a.dispersion=o.dispersion)},JD=function(o,a,i){a.blendType=2,a.useDynamicRefraction=!0,o.hasOwnProperty("transmissionFactor")&&(a.refraction=o.transmissionFactor),o.hasOwnProperty("transmissionTexture")&&(a.refractionMapChannel="r",a.refractionMap=i[o.transmissionTexture.index],lt(o.transmissionTexture,a,["refraction"]))},$D=function(o,a,i){if(a.useSheen=!0,o.hasOwnProperty("sheenColorFactor")){var t=o.sheenColorFactor;a.sheen.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))}else a.sheen.set(1,1,1);o.hasOwnProperty("sheenColorTexture")&&(a.sheenMap=i[o.sheenColorTexture.index],lt(o.sheenColorTexture,a,["sheen"])),a.sheenGloss=o.hasOwnProperty("sheenRoughnessFactor")?o.sheenRoughnessFactor:0,o.hasOwnProperty("sheenRoughnessTexture")&&(a.sheenGlossMap=i[o.sheenRoughnessTexture.index],a.sheenGlossMapChannel="a",lt(o.sheenRoughnessTexture,a,["sheenGloss"])),a.sheenGlossInvert=!0},eM=function(o,a,i){if(a.blendType=2,a.useDynamicRefraction=!0,o.hasOwnProperty("thicknessFactor")&&(a.thickness=o.thicknessFactor),o.hasOwnProperty("thicknessTexture")&&(a.thicknessMap=i[o.thicknessTexture.index],a.thicknessMapChannel="g",lt(o.thicknessTexture,a,["thickness"])),o.hasOwnProperty("attenuationDistance")&&(a.attenuationDistance=o.attenuationDistance),o.hasOwnProperty("attenuationColor")){var t=o.attenuationColor;a.attenuation.set(Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2))}},tM=function(o,a,i){o.hasOwnProperty("emissiveStrength")&&(a.emissiveIntensity=o.emissiveStrength)},nM=function(o,a,i){a.useIridescence=!0,o.hasOwnProperty("iridescenceFactor")&&(a.iridescence=o.iridescenceFactor),o.hasOwnProperty("iridescenceTexture")&&(a.iridescenceMapChannel="r",a.iridescenceMap=i[o.iridescenceTexture.index],lt(o.iridescenceTexture,a,["iridescence"])),o.hasOwnProperty("iridescenceIor")&&(a.iridescenceRefractionIndex=o.iridescenceIor),o.hasOwnProperty("iridescenceThicknessMinimum")&&(a.iridescenceThicknessMin=o.iridescenceThicknessMinimum),o.hasOwnProperty("iridescenceThicknessMaximum")&&(a.iridescenceThicknessMax=o.iridescenceThicknessMaximum),o.hasOwnProperty("iridescenceThicknessTexture")&&(a.iridescenceThicknessMapChannel="g",a.iridescenceThicknessMap=i[o.iridescenceThicknessTexture.index],lt(o.iridescenceThicknessTexture,a,["iridescenceThickness"]))},iM=function(o,a,i){if(a.enableGGXSpecular=!0,o.hasOwnProperty("anisotropyStrength")?a.anisotropyIntensity=o.anisotropyStrength:a.anisotropyIntensity=0,o.hasOwnProperty("anisotropyTexture")){var t=o.anisotropyTexture;a.anisotropyMap=i[t.index],lt(t,a,["anisotropy"])}o.hasOwnProperty("anisotropyRotation")?a.anisotropyRotation=o.anisotropyRotation*U.RAD_TO_DEG:a.anisotropyRotation=0},FT=function(o,a){var i,t,e=new it;if(o.hasOwnProperty("name")&&(e.name=o.name),e.occludeSpecular=1,e.diffuseVertexColor=!0,e.specularTint=!0,e.specularVertexColor=!0,e.specular.set(1,1,1),e.gloss=1,e.glossInvert=!0,e.useMetalness=!0,o.hasOwnProperty("pbrMetallicRoughness")){var n=o.pbrMetallicRoughness;if(n.hasOwnProperty("baseColorFactor")&&(i=n.baseColorFactor,e.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),e.opacity=i[3]),n.hasOwnProperty("baseColorTexture")){var r=n.baseColorTexture;e.diffuseMap=t=a[r.index],e.diffuseMapChannel="rgb",e.opacityMap=t,e.opacityMapChannel="a",lt(r,e,["diffuse","opacity"])}if(n.hasOwnProperty("metallicFactor")&&(e.metalness=n.metallicFactor),n.hasOwnProperty("roughnessFactor")&&(e.gloss=n.roughnessFactor),n.hasOwnProperty("metallicRoughnessTexture")){var s=n.metallicRoughnessTexture;e.metalnessMap=e.glossMap=a[s.index],e.metalnessMapChannel="b",e.glossMapChannel="g",lt(s,e,["gloss","metalness"])}}if(o.hasOwnProperty("normalTexture")){var l=o.normalTexture;e.normalMap=a[l.index],lt(l,e,["normal"]),l.hasOwnProperty("scale")&&(e.bumpiness=l.scale)}if(o.hasOwnProperty("occlusionTexture")){var u=o.occlusionTexture;e.aoMap=a[u.index],e.aoMapChannel="r",lt(u,e,["ao"])}if(o.hasOwnProperty("emissiveFactor")&&(i=o.emissiveFactor,e.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))),o.hasOwnProperty("emissiveTexture")){var c=o.emissiveTexture;e.emissiveMap=a[c.index],lt(c,e,["emissive"])}if(o.hasOwnProperty("alphaMode"))switch(o.alphaMode){case"MASK":e.blendType=3,o.hasOwnProperty("alphaCutoff")?e.alphaTest=o.alphaCutoff:e.alphaTest=.5;break;case"BLEND":e.blendType=2,e.depthWrite=!1;break;default:e.blendType=3}else e.blendType=3;o.hasOwnProperty("doubleSided")?(e.twoSidedLighting=o.doubleSided,e.cull=+!o.doubleSided):(e.twoSidedLighting=!1,e.cull=1);var h={KHR_materials_clearcoat:YD,KHR_materials_emissive_strength:tM,KHR_materials_ior:ZD,KHR_materials_dispersion:QD,KHR_materials_iridescence:nM,KHR_materials_pbrSpecularGlossiness:XD,KHR_materials_sheen:$D,KHR_materials_specular:KD,KHR_materials_transmission:JD,KHR_materials_unlit:qD,KHR_materials_volume:eM,KHR_materials_anisotropy:iM};if(o.hasOwnProperty("extensions"))for(var f in o.extensions){var d=h[f];d!==void 0&&d(o.extensions[f],e,a)}return e.update(),e},rM=function(o,a,i,t,e,n,r){var s,l,u=function(H){return new xl(bl(H.type),Aa(H,t))},c={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},f={},d={},p=1;for(s=0;s<o.samplers.length;++s){var _=o.samplers[s];h.hasOwnProperty(_.input)||(h[_.input]=u(i[_.input])),f.hasOwnProperty(_.output)||(f[_.output]=u(i[_.output]));var g=_.hasOwnProperty("interpolation")&&c.hasOwnProperty(_.interpolation)?c[_.interpolation]:1,y={paths:[],input:_.input,output:_.output,interpolation:g};d[s]=y}var v=[],x={translation:"localPosition",rotation:"localRotation",scale:"localScale"};for(s=0;s<o.channels.length;++s){var S=o.channels[s],T=S.target,b=d[S.sampler],w=e[T.node],A=r[T.node],C=function(H){for(var Y=[];H;)Y.unshift(H.name),H=H.parent;return Y}(w);T.path.startsWith("weights")?(function(H,Y,W){var ie,te=f[H.output];if(te){if(n&&n[Y.mesh]){var ae=n[Y.mesh];ae.hasOwnProperty("extras")&&ae.extras.hasOwnProperty("targetNames")&&(ie=ae.extras.targetNames)}for(var _e=te.data,xe=_e.length/h[H.input].data.length,je=_e.length/xe,Qe=4*je,rt=new ArrayBuffer(Qe*xe),Pe=0;Pe<xe;Pe++){for(var wt=new Float32Array(rt,Qe*Pe,je),tt=0;tt<je;tt++)wt[tt]=_e[tt*xe+Pe];var At=new xl(1,wt),K=ie!=null&&ie[Pe]?"name."+ie[Pe]:Pe;f[-p]=At;var dt={paths:[{entityPath:W,component:"graph",propertyPath:["weight."+K]}],input:H.input,output:-p,interpolation:H.interpolation};p++,d["morphCurve-"+s+"-"+Pe]=dt}}}(b,A,C),d[S.sampler].morphCurve=!0):b.paths.push({entityPath:C,component:"graph",propertyPath:[x[T.path]]})}var L=[],I=[],P=[];for(var M in h)L.push(h[M]),h[M]=L.length-1;for(var R in f)I.push(f[R]),f[R]=I.length-1;for(var k in d){var D=d[k];!D.morphCurve&&(P.push(new yp(D.paths,h[D.input],f[D.output],D.interpolation)),D.paths.length>0&&D.paths[0].propertyPath[0]==="localRotation"&&D.interpolation!==2&&v.push(P[P.length-1].output))}v.sort();var O=null;for(s=0;s<v.length;++s){var F=v[s];if(s===0||F!==O){if((l=I[F]).components===4)for(var N=l.data,j=N.length-4,z=0;z<j;z+=4)N[z+0]*N[z+4]+N[z+1]*N[z+5]+N[z+2]*N[z+6]+N[z+3]*N[z+7]<0&&(N[z+4]*=-1,N[z+5]*=-1,N[z+6]*=-1,N[z+7]*=-1);O=F}}var V=0;for(s=0;s<L.length;s++)V=Math.max(V,(l=L[s]._data).length===0?0:l[l.length-1]);return new Qt(o.hasOwnProperty("name")?o.name:"animation_"+a,V,L,I,P)},Dc=new X,Ca=new E,sM=function(o,a,i){var t=new pe;if(o.hasOwnProperty("name")&&o.name.length>0?t.name=o.name:t.name="node_"+a,o.hasOwnProperty("matrix")&&(Dc.data.set(o.matrix),Dc.getTranslation(Ca),t.setLocalPosition(Ca),Dc.getEulerAngles(Ca),t.setLocalEulerAngles(Ca),Dc.getScale(Ca),t.setLocalScale(Ca)),o.hasOwnProperty("rotation")){var e=o.rotation;t.setLocalRotation(e[0],e[1],e[2],e[3])}if(o.hasOwnProperty("translation")){var n=o.translation;t.setLocalPosition(n[0],n[1],n[2])}if(o.hasOwnProperty("scale")){var r=o.scale;t.setLocalScale(r[0],r[1],r[2])}return o.hasOwnProperty("extensions")&&o.extensions.EXT_mesh_gpu_instancing&&i.set(o,{ext:o.extensions.EXT_mesh_gpu_instancing}),t},aM=function(o,a){var i=+(o.type==="orthographic"),t=i===1?o.orthographic:o.perspective,e={enabled:!1,projection:i,nearClip:t.znear,aspectRatioMode:0};t.zfar&&(e.farClip=t.zfar),i===1?(e.orthoHeight=.5*t.ymag,t.ymag&&(e.aspectRatioMode=1,e.aspectRatio=t.xmag/t.ymag)):(e.fov=t.yfov*U.RAD_TO_DEG,t.aspectRatio&&(e.aspectRatioMode=1,e.aspectRatio=t.aspectRatio));var n=new ve(o.name);return n.addComponent("camera",e),n},oM=function(o,a){var i={enabled:!1,type:o.type==="point"?"omni":o.type,color:o.hasOwnProperty("color")?new B(o.color):B.WHITE,range:o.hasOwnProperty("range")?o.range:9999,falloffMode:1,intensity:o.hasOwnProperty("intensity")?U.clamp(o.intensity,0,2):1};o.hasOwnProperty("spot")&&(i.innerConeAngle=o.spot.hasOwnProperty("innerConeAngle")?o.spot.innerConeAngle*U.RAD_TO_DEG:0,i.outerConeAngle=o.spot.hasOwnProperty("outerConeAngle")?o.spot.outerConeAngle*U.RAD_TO_DEG:Math.PI/4),o.hasOwnProperty("intensity")&&(i.luminance=o.intensity*od.getLightUnitConversion(ad[i.type],i.outerConeAngle,i.innerConeAngle));var t=new ve(a.name);return t.rotateLocal(90,0,0),t.addComponent("light",i),t},lM=function(o,a,i,t){if(!a.hasOwnProperty("skins")||a.skins.length===0)return[];var e=new Map;return a.skins.map(function(n){return HD(o,n,a.accessors,t,i,e)})},uM=function(o,a,i,t){var e,n,r,s={},l={},u={},c=[];return{meshes:!t.skipMeshes&&(!(a==null||(e=a.meshes)==null)&&e.length)&&(!(a==null||(n=a.accessors)==null)&&n.length)&&(!(a==null||(r=a.bufferViews)==null)&&r.length)?a.meshes.map(function(h){return jD(o,h,a.accessors,i,s,l,u,t,c)}):[],meshVariants:l,meshDefaultMaterials:u,promises:c}},cM=function(o,a,i){if(!o.hasOwnProperty("materials")||o.materials.length===0)return[];var t,e,n,r,s=i==null||(t=i.material)==null?void 0:t.preprocess,l=(r=i==null||(e=i.material)==null?void 0:e.process)!=null?r:FT,u=i==null||(n=i.material)==null?void 0:n.postprocess;return o.materials.map(function(c){s&&s(c);var h=l(c,a);return u&&u(c,h),h})},hM=function(o){if(!o.hasOwnProperty("extensions")||!o.extensions.hasOwnProperty("KHR_materials_variants"))return null;for(var a=o.extensions.KHR_materials_variants.variants,i={},t=0;t<a.length;t++)i[a[t].name]=t;return i},fM=function(o,a,i,t){if(!o.hasOwnProperty("animations")||o.animations.length===0)return[];var e,n,r=t==null||(e=t.animation)==null?void 0:e.preprocess,s=t==null||(n=t.animation)==null?void 0:n.postprocess;return o.animations.map(function(l,u){r&&r(l);var c=rM(l,u,o.accessors,i,a,o.meshes,o.nodes);return s&&s(l,c),c})},dM=function(o,a,i,t){var e=a.accessors;i.forEach(function(n,r){var s,l,u,c=n.ext.attributes;c.hasOwnProperty("TRANSLATION")&&(s=Aa(e[c.TRANSLATION],t)),c.hasOwnProperty("ROTATION")&&(l=Aa(e[c.ROTATION],t)),c.hasOwnProperty("SCALE")&&(u=Aa(e[c.SCALE],t));var h=(s?s.length/3:0)||(l?l.length/4:0)||(u?u.length/3:0);if(h){for(var f=new Float32Array(16*h),d=new E,p=new Z,_=new E(1,1,1),g=new X,y=0,v=0;v<h;v++){var x=3*v;if(s&&d.set(s[x],s[x+1],s[x+2]),l){var S=4*v;p.set(l[S],l[S+1],l[S+2],l[S+3])}u&&_.set(u[x],u[x+1],u[x+2]),g.setTRS(d,p,_);for(var T=0;T<16;T++)f[y++]=g.data[T]}n.matrices=f}})},pM=function(o,a,i){if(!o.hasOwnProperty("nodes")||o.nodes.length===0)return[];for(var t,e,n,r,s=a==null||(t=a.node)==null?void 0:t.preprocess,l=(r=a==null||(e=a.node)==null?void 0:e.process)!=null?r:sM,u=a==null||(n=a.node)==null?void 0:n.postprocess,c=o.nodes.map(function(y,v){s&&s(y);var x=l(y,v,i);return u&&u(y,x),x}),h=0;h<o.nodes.length;++h){var f=o.nodes[h];if(f.hasOwnProperty("children"))for(var d=c[h],p={},_=0;_<f.children.length;++_){var g=c[f.children[_]];g.parent||(p.hasOwnProperty(g.name)?g.name+=p[g.name]++:p[g.name]=1,d.addChild(g))}}return c},mM=function(o,a){var i,t=[],e=o.scenes.length;if(e===1&&((i=o.scenes[0].nodes)==null?void 0:i.length)===1){var n=o.scenes[0].nodes[0];t.push(a[n])}else for(var r=0;r<e;r++){var s=o.scenes[r];if(s.nodes){for(var l=new pe(s.name),u=0;u<s.nodes.length;u++){var c=a[s.nodes[u]];l.addChild(c)}t.push(l)}}return t},_M=function(o,a,i){var t=null;if(o.hasOwnProperty("nodes")&&o.hasOwnProperty("cameras")&&o.cameras.length>0){var e,n,r,s,l=i==null||(e=i.camera)==null?void 0:e.preprocess,u=(s=i==null||(n=i.camera)==null?void 0:n.process)!=null?s:aM,c=i==null||(r=i.camera)==null?void 0:r.postprocess;o.nodes.forEach(function(h,f){if(h.hasOwnProperty("camera")){var d=o.cameras[h.camera];if(d){l&&l(d);var p=u(d,a[f]);c&&c(d,p),p&&(t||(t=new Map),t.set(h,p))}}})}return t},vM=function(o,a,i){var t=null;if(o.hasOwnProperty("nodes")&&o.hasOwnProperty("extensions")&&o.extensions.hasOwnProperty("KHR_lights_punctual")&&o.extensions.KHR_lights_punctual.hasOwnProperty("lights")){var e=o.extensions.KHR_lights_punctual.lights;if(e.length){var n,r,s,l,u=i==null||(n=i.light)==null?void 0:n.preprocess,c=(l=i==null||(r=i.light)==null?void 0:r.process)!=null?l:oM,h=i==null||(s=i.light)==null?void 0:s.postprocess;o.nodes.forEach(function(f,d){if(f.hasOwnProperty("extensions")&&f.extensions.hasOwnProperty("KHR_lights_punctual")&&f.extensions.KHR_lights_punctual.hasOwnProperty("light")){var p=e[f.extensions.KHR_lights_punctual.light];if(p){u&&u(p);var _=c(p,a[d]);h&&h(p,_),_&&(t||(t=new Map),t.set(f,_))}}})}}return t},gM=function(o,a,i){o.nodes.forEach(function(t){t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&a[t.mesh].meshes.forEach(function(e){e.skin=i[t.skin]})})},yM=(Rm=function(o,a,i,t,e){var n,r,s,l,u,c,h,f,d,p,_,g,y,v,x,S,T,b,w,A,C,L,I;return function(P,M){var R,k,D,O={label:0,sent:function(){if(1&D[0])throw D[1];return D[1]},trys:[],ops:[]},F=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return F.next=N(0),F.throw=N(1),F.return=N(2),typeof Symbol=="function"&&(F[Symbol.iterator]=function(){return this}),F;function N(j){return function(z){var V=[j,z];if(R)throw TypeError("Generator is already executing.");for(;F&&(F=0,V[0]&&(O=0)),O;)try{if(R=1,k&&(D=2&V[0]?k.return:V[0]?k.throw||((D=k.return)&&D.call(k),0):k.next)&&!(D=D.call(k,V[1])).done)return D;switch(k=0,D&&(V=[2&V[0],D.value]),V[0]){case 0:case 1:D=V;break;case 4:return O.label++,{value:V[1],done:!1};case 5:O.label++,k=V[1],V=[0];continue;case 7:V=O.ops.pop(),O.trys.pop();continue;default:if(!(D=(D=O.trys).length>0&&D[D.length-1])&&(V[0]===6||V[0]===2)){O=0;continue}if(V[0]===3&&(!D||V[1]>D[0]&&V[1]<D[3])){O.label=V[1];break}if(V[0]===6&&O.label<D[1]){O.label=D[1],D=V;break}if(D&&O.label<D[2]){O.label=D[2],O.ops.push(V);break}D[2]&&O.ops.pop(),O.trys.pop();continue}V=M.call(P,O)}catch(H){V=[6,H],k=0}finally{R=D=0}if(5&V[0])throw V[1];return{value:V[0]?V[1]:void 0,done:!0}}}}(this,function(P){switch(P.label){case 0:return s=e==null||(n=e.global)==null?void 0:n.preprocess,l=e==null||(r=e.global)==null?void 0:r.postprocess,s&&s(a),a.asset&&a.asset.generator,c=pM(a,e,u=new Map),h=mM(a,c),f=vM(a,c,e),d=_M(a,c,e),p=hM(a),[4,Promise.all(i)];case 1:return y=(g=uM(o,a,_=P.sent(),e)).meshes,v=g.meshVariants,x=g.meshDefaultMaterials,S=g.promises,T=fM(a,c,_,e),dM(o,a,u,_),[4,Promise.all(t)];case 2:for(L=0,w=cM(a,(b=P.sent()).map(function(M){return M.resource}),e),A=lM(o,a,c,_),C=[];L<y.length;L++)C[L]=new gp,C[L].meshes=y[L];return gM(a,C,A),(I=new RD).gltf=a,I.nodes=c,I.scenes=h,I.animations=T,I.textures=b,I.materials=w,I.variants=p,I.meshVariants=v,I.meshDefaultMaterials=x,I.renders=C,I.skins=A,I.lights=f,I.cameras=d,I.nodeInstancingMap=u,l&&l(a,I),[4,Promise.all(S)];case 3:return P.sent(),[2,I]}})},function(){var o=this,a=arguments;return new Promise(function(i,t){var e=Rm.apply(o,a);function n(s){MT(e,i,t,n,r,"next",s)}function r(s){MT(e,i,t,n,r,"throw",s)}n(void 0)})}),SM=function(o,a){var i=function(e,n){switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return n}},t=function(e,n){switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return n}};o&&(o.minFilter=i((a=a??{}).minFilter,5),o.magFilter=i(a.magFilter,1),o.addressU=t(a.wrapS,0),o.addressV=t(a.wrapT,0))},xM=0,Pa=function(o){var a,i,t,e,n,r;return(r=(n=(i=o.extensions)==null||(a=i.KHR_texture_basisu)==null?void 0:a.source)!=null?n:(e=o.extensions)==null||(t=e.EXT_texture_webp)==null?void 0:t.source)!=null?r:o.source},bM=function(o,a,i,t,e){if(!o.images||o.images.length===0)return[];var n,r,s,l,u=e==null||(r=e.image)==null?void 0:r.preprocess,c=e==null||(s=e.image)==null?void 0:s.processAsync,h=e==null||(l=e.image)==null?void 0:l.postprocess,f={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},d=function(_,g,y,v,x,S){return new Promise(function(T,b){var w=function(A){var C=(_.name||"gltf-texture")+"-"+xM++,L={url:g||C};if(A&&(L.contents=A.slice(0).buffer),v){var I=f[v];I&&(L.filename=L.url+"."+I)}var P=new $(C,"texture",L,{srgb:S},x);P.on("load",function(M){return T(M)}),P.on("error",function(M){return b(M)}),t.add(P),t.load(P)};y?y.then(function(A){return w(A)}):w(null)})},p=(n=new Set,o.hasOwnProperty("materials")&&o.materials.forEach(function(_){if(_.hasOwnProperty("pbrMetallicRoughness")){var g=_.pbrMetallicRoughness;if(g.hasOwnProperty("baseColorTexture")){var y=o.textures[g.baseColorTexture.index];n.add(Pa(y))}}if(_.hasOwnProperty("emissiveTexture")){var v=o.textures[_.emissiveTexture.index];n.add(Pa(v))}if(_.hasOwnProperty("extensions")){var x=_.extensions.KHR_materials_sheen;if(x&&x.hasOwnProperty("sheenColorTexture")){var S=o.textures[x.sheenColorTexture.index];n.add(Pa(S))}var T=_.extensions.KHR_materials_pbrSpecularGlossiness;if(T&&T.hasOwnProperty("specularGlossinessTexture")){var b=o.textures[T.specularGlossinessTexture.index];n.add(Pa(b))}var w=_.extensions.KHR_materials_specular;if(w&&w.hasOwnProperty("specularColorTexture")){var A=o.textures[w.specularColorTexture.index];n.add(Pa(A))}}}),n);return o.images.map(function(_,g){var y;return u&&u(_),y=(y=new Promise(c?function(v,x){c(_,function(S,T){S?x(S):v(T)})}:function(v){v(null)})).then(function(v){var x,S=p.has(g);return v||(_.hasOwnProperty("uri")?OT(_.uri)?d(_,_.uri,null,(x=_.uri).substring(x.indexOf(":")+1,x.indexOf(";")),null,S):d(_,Qr.test(_.uri)?_.uri:ce.join(i,_.uri),null,null,{crossOrigin:"anonymous"},S):_.hasOwnProperty("bufferView")&&_.hasOwnProperty("mimeType")?d(_,null,a[_.bufferView],_.mimeType,null,S):Promise.reject(Error("Invalid image found in gltf (neither uri or bufferView found). index="+g)))}),h&&(y=y.then(function(v){return h(_,v),v})),y})},TM=function(o,a,i){if(!(!(o==null||(t=o.images)==null)&&t.length)||!(!(o==null||(e=o.textures)==null)&&e.length))return[];var t,e,n,r,s,l=i==null||(n=i.texture)==null?void 0:n.preprocess,u=i==null||(r=i.texture)==null?void 0:r.processAsync,c=i==null||(s=i.texture)==null?void 0:s.postprocess,h=new Set;return o.textures.map(function(f){var d;return l&&l(f),d=(d=new Promise(u?function(p,_){u(f,o.images,function(g,y){g?_(g):p(y)})}:function(p){p(null)})).then(function(p){p=p??Pa(f);var _=h.has(p);return h.add(p),a[p].then(function(g){var y,v=_?VD(g):g;return SM(v.resource,((y=o.samplers)!=null?y:[])[f.sampler]),v})}),c&&(d=d.then(function(p){return c(f,p),p})),d})},EM=function(o,a,i,t){if(!o.buffers||o.buffers.length===0)return[];var e,n,r,s=t==null||(e=t.buffer)==null?void 0:e.preprocess,l=t==null||(n=t.buffer)==null?void 0:n.processAsync,u=t==null||(r=t.buffer)==null?void 0:r.postprocess;return o.buffers.map(function(c,h){var f;return s&&s(c),f=(f=new Promise(l?function(d,p){l(c,function(_,g){_?p(_):d(g)})}:function(d){d(null)})).then(function(d){if(d)return d;if(c.hasOwnProperty("uri")){if(OT(c.uri)){for(var p=atob(c.uri.split(",")[1]),_=new Uint8Array(p.length),g=0;g<p.length;g++)_[g]=p.charCodeAt(g);return _}return new Promise(function(y,v){Fe.get(Qr.test(c.uri)?c.uri:ce.join(i,c.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(x,S){x?v(x):y(new Uint8Array(S))})})}return a}),u&&(f=f.then(function(d){return u(o.buffers[h],d),d})),f})},wM=function(o,a){var i=JSON.parse(function(t){if(typeof TextDecoder<"u")return new TextDecoder().decode(t);for(var e="",n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return decodeURIComponent(escape(e))}(o));if(i.asset&&i.asset.version&&2>parseFloat(i.asset.version))return void a("Invalid gltf version. Expected version 2.0 or above but found version '"+i.asset.version+"'.");a(null,i)},AM=function(o,a){var i=Pc(o,ArrayBuffer)?new DataView(o):new DataView(o.buffer,o.byteOffset,o.byteLength),t=i.getUint32(0,!0),e=i.getUint32(4,!0),n=i.getUint32(8,!0);if(t!==1179937895)return void a("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+t.toString(16));if(e!==2)return void a("Invalid version number found in glb header. Expected 2, found "+e);if(n<=0||n>i.byteLength)return void a("Invalid length found in glb header. Found "+n);for(var r=[],s=12;s<n;){var l=i.getUint32(s,!0);s+l+8>i.byteLength&&a("Invalid chunk length found in glb. Found "+l);var u=i.getUint32(s+4,!0),c=new Uint8Array(i.buffer,i.byteOffset+s+8,l);r.push({length:l,type:u,data:c}),s+=l+8}return r.length!==1&&r.length!==2?void a("Invalid number of chunks found in glb file."):r[0].type!==1313821514?void a("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):r.length>1&&r[1].type!==5130562?void a("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):void a(null,{gltfChunk:r[0].data,binaryChunk:r.length===2?r[1].data:null})},CM=function(o,a,i){var t;o&&o.toLowerCase().endsWith(".glb")||(t=new Uint8Array(a))[0]===103&&t[1]===108&&t[2]===84&&t[3]===70?AM(a,i):i(null,{gltfChunk:a,binaryChunk:null})},PM=function(o,a,i){var t,e,n,r,s=[],l=i==null||(t=i.bufferView)==null?void 0:t.preprocess,u=i==null||(e=i.bufferView)==null?void 0:e.processAsync,c=i==null||(n=i.bufferView)==null?void 0:n.postprocess;if(!((r=o.bufferViews)!=null&&r.length))return s;for(var h=0;h<o.bufferViews.length;++h)(function(f){var d=o.bufferViews[f];l&&l(d);var p=void 0;p=(p=new Promise(u?function(_,g){u(d,a,function(y,v){y?g(y):_(v)})}:function(_){_(null)})).then(function(_){return _||a[d.buffer].then(function(g){return new Uint8Array(g.buffer,g.byteOffset+(d.byteOffset||0),d.byteLength)})}),d.hasOwnProperty("byteStride")&&(p=p.then(function(_){return _.byteStride=d.byteStride,_})),c&&(p=p.then(function(_){return c(d,_),_})),s.push(p)})(h);return s},Mc=function(){function o(){}return o.parse=function(a,i,t,e,n,r,s){CM(a,t,function(l,u){if(l)return void s(l);wM(u.gltfChunk,function(c,h){if(c)return void s(c);var f=EM(h,u.binaryChunk,i,r),d=PM(h,f,r),p=bM(h,d,i,n,r),_=TM(h,p,r);yM(e,h,d,_,r).then(function(g){return s(null,g)}).catch(function(g){return s(g)})})})},o.createDefaultMaterial=function(){return FT({name:"defaultGlbMaterial"},[])},o}();function UT(o,a){return(UT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var BT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"animation")||this).device=t.graphicsDevice,e.assets=t.assets,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&UT(a,o);var i=a.prototype;return i.load=function(t,e,n){var r=this;typeof t=="string"&&(t={load:t,original:t});var s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(ce.getExtension(t.original).toLowerCase()===".glb"?s.responseType=Tt.ResponseType.ARRAY_BUFFER:s.responseType=Tt.ResponseType.JSON),Fe.get(t.load,s,function(l,u){if(l)e("Error loading animation resource: "+t.original+" ["+l+"]");else if(ce.getExtension(t.original).toLowerCase()===".glb"){var c;Mc.parse("filename.glb","",u,r.device,r.assets,(c=n==null?void 0:n.options)!=null?c:{},function(h,f){if(h)e(h);else{var d,p=f.animations;if(!(n==null||(d=n.data)==null)&&d.events)for(var _=0;_<p.length;_++)p[_].events=new zd(Object.values(n.data.events));f.destroy(),e(null,p)}})}else e(null,r["_parseAnimationV"+u.animation.version](u))})},i.open=function(t,e,n){return e},i._parseAnimationV3=function(t){var e=t.animation,n=new gd;n.name=e.name,n.duration=e.duration;for(var r=0;r<e.nodes.length;r++){var s=new Hu,l=e.nodes[r];s._name=l.name;for(var u=0;u<l.keys.length;u++){var c=l.keys[u],h=c.time,f=c.pos,d=c.rot,p=c.scale,_=new Gu(h,new E(f[0],f[1],f[2]),new Z().setFromEulerAngles(d[0],d[1],d[2]),new E(p[0],p[1],p[2]));s._keys.push(_)}n.addNode(s)}return n},i._parseAnimationV4=function(t){var e=t.animation,n=new gd;n.name=e.name,n.duration=e.duration;for(var r=0;r<e.nodes.length;r++){var s=new Hu,l=e.nodes[r];s._name=l.name;for(var u=l.defaults.p,c=l.defaults.r,h=l.defaults.s,f=0;f<l.keys.length;f++){var d=l.keys[f],p=d.t,_=u||d.p,g=c||d.r,y=h||d.s,v=new Gu(p,new E(_[0],_[1],_[2]),new Z().setFromEulerAngles(g[0],g[1],g[2]),new E(y[0],y[1],y[2]));s._keys.push(v)}n.addNode(s)}return n},a}(Oe);function VT(o,a){return(VT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var zT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){return o.call(this,t,"animclip")||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&VT(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(n.responseType=Tt.ResponseType.JSON),Fe.get(t.load,n,function(r,s){r?e("Error loading animation clip resource: "+t.original+" ["+r+"]"):e(null,s)})},i.open=function(t,e){return new Qt(e.name,e.duration,e.inputs.map(function(n){return new xl(1,n)}),e.outputs.map(function(n){return new xl(n.components,n.data)}),e.curves.map(function(n){return new yp([n.path],n.inputIndex,n.outputIndex,n.interpolation)}))},a}(Oe);function GT(o,a){return(GT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var HT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){return o.call(this,t,"animstategraph")||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&GT(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(n.responseType=Tt.ResponseType.JSON),Fe.get(t.load,n,function(r,s){r?e("Error loading animation state graph resource: "+t.original+" ["+r+"]"):e(null,s)})},i.open=function(t,e){return new ol(e)},a}(Oe);function WT(o,a){return(WT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var bp=function(){if(typeof window>"u")return!1;var o=window.navigator.userAgent,a=o.indexOf("MSIE ");if(a>0)return parseInt(o.substring(a+5,o.indexOf(".",a)),10);if(o.indexOf("Trident/")>0){var i=o.indexOf("rv:");return parseInt(o.substring(i+3,o.indexOf(".",i)),10)}return!1}(),IM=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"],jT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"audio")||this).manager=t.soundManager,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&WT(a,o);var i=a.prototype;return i._isSupported=function(t){var e=ce.getExtension(t);return IM.indexOf(e)>-1},i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n=function(r){var s="Error loading audio url: "+t.original;r&&(s+=": "+(r.message||r)),e(s)};if(this._createSound){if(!this._isSupported(t.original))return void n("Audio format for "+t.original+" not supported");this._createSound(t.load,function(r){e(null,new Uv(r))},n)}else n(null)},i._createSound=function(t,e,n){if(Si()){var r=this.manager;if(!r.context)return void n("Audio manager has no audio context");var s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.startsWith("blob:")||t.startsWith("data:"))&&(s.responseType=Tt.ResponseType.ARRAY_BUFFER),Fe.get(t,s,function(c,h){if(c)return void n(c);r.context.decodeAudioData(h,e,n)})}else{var l=null;try{l=new Audio}catch{n("No support for Audio element");return}bp&&document.body.appendChild(l);var u=function(){l.removeEventListener("canplaythrough",u),bp&&document.body.removeChild(l),e(l)};l.onerror=function(){l.onerror=null,bp&&document.body.removeChild(l),n()},l.addEventListener("canplaythrough",u),l.src=t}},a}(Oe);function XT(o,a){return(XT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var YT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){return o.call(this,t,"binary")||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&XT(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),Fe.get(t.load,{responseType:Tt.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e("Error loading binary resource: "+t.original+" ["+n+"]"):e(null,r)})},i.openBinary=function(t){return t.buffer},a}(Oe);function qT(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Tp(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return qT(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return qT(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var KT=function(){function o(t,e,n,r){for(var s=function(p,_,g){var y=o.createAsset(e.name,p,_,g);return n.add(y),y},l=[],u=0;u<t.renders.length;++u)l.push(s("render",t.renders[u],u));for(var c=[],h=0;h<t.materials.length;++h)c.push(s("material",t.materials[h],h));for(var f=[],d=0;d<t.animations.length;++d)f.push(s("animation",t.animations[d],d));this.data=t,this._model=null,this._assetName=e.name,this._assets=n,this._defaultMaterial=r,this.renders=l,this.materials=c,this.textures=t.textures,this.animations=f}var a,i=o.prototype;return i.instantiateModelEntity=function(t){var e=new ve(void 0,this._assets._loader._app);return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e},i.instantiateRenderEntity=function(t){for(var e,n=this,r=this._defaultMaterial,s=[],l=function(d,p,_,g,y,v,x,S){var T=y[_.id],b=new De(_,T===void 0?r:g[T]);_.morph&&(b.morphInstance=new na(_.morph)),x.hasOwnProperty("skin")&&s.push({meshInstance:b,rootBone:d,entity:p});var w=S.get(x);if(w){var A=w.matrices,C=Ot.getDefaultInstancingFormat(_.device),L=new Rt(_.device,C,A.length/16,{data:A});b.setInstancing(L),b.instancingData._destroyVertexBuffer=!0}return b},u=function(d,p,_){var g=new ve(void 0,n._assets._loader._app);p._cloneInternal(g),d||(d=g);for(var y=null,v=null,x=0;x<_.nodes.length;x++)if(_.nodes[x]===p){var S=_.gltf.nodes[x];if(S.hasOwnProperty("mesh")){var T=_.renders[S.mesh].meshes;v=n.renders[S.mesh];for(var b=0;b<T.length;b++){var w=T[b];if(w){var A=l(d,g,w,_.materials,_.meshDefaultMaterials,_.skins,S,_.nodeInstancingMap);y||(y=[]),y.push(A)}}}if(_.lights){var C=_.lights.get(S);C&&g.addChild(C.clone())}if(_.cameras){var L=_.cameras.get(S);L&&L.camera.system.cloneComponent(L,g)}}y&&(g.addComponent("render",Object.assign({type:"asset",meshInstances:y},t)),g.render.assignAsset(v));for(var I=p.children,P=0;P<I.length;P++){var M=u(d,I[P],_);g.addChild(M)}return g},c=[],h=Tp(this.data.scenes);!(e=h()).done;){var f=e.value;c.push(u(null,f,this.data))}return s.forEach(function(d){d.meshInstance.skinInstance=bc.createCachedSkinInstance(d.meshInstance.mesh.skin,d.rootBone,d.entity),d.meshInstance.node.render.rootBone=d.rootBone}),o.createSceneHierarchy(c,ve)},i.getMaterialVariants=function(){return this.data.variants?Object.keys(this.data.variants):[]},i.applyMaterialVariant=function(t,e){var n=e?this.data.variants[e]:null;if(n!==void 0)for(var r=t.findComponents("render"),s=0;s<r.length;s++){var l=r[s];this._applyMaterialVariant(n,l.meshInstances)}},i.applyMaterialVariantInstances=function(t,e){var n=e?this.data.variants[e]:null;n!==void 0&&this._applyMaterialVariant(n,t)},i._applyMaterialVariant=function(t,e){var n=this;e.forEach(function(r){if(t===null)r.material=n._defaultMaterial;else{var s=n.data.meshVariants[r.mesh.id];s&&(r.material=n.data.materials[s[t]])}})},i.destroy=function(){var t=this._assets,e=function(r){t.remove(r),r.unload()},n=function(r){r.forEach(function(s){e(s)})};this.animations&&(n(this.animations),this.animations=null),this.textures&&(n(this.textures),this.textures=null),this.materials&&(n(this.materials),this.materials=null),this.renders&&(n(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null},o.createAsset=function(t,e,n,r){var s=new $(t+"/"+e+"/"+r,e,{url:""});return s.resource=n,s.loaded=!0,s},o.createSceneHierarchy=function(t,e){var n=null;if(t.length===1)n=t[0];else{n=new e("SceneGroup");for(var r,s=Tp(t);!(r=s()).done;){var l=r.value;n.addChild(l)}}return n},o.createModel=function(t,e){for(var n,r=new cr,s=[],l=Tp(t.skins);!(n=l()).done;){var u=n.value,c=new qs(u);c.bones=u.bones,s.push(c)}r.graph=o.createSceneHierarchy(t.scenes,pe);for(var h=0;h<t.nodes.length;h++){var f=t.nodes[h];if(f.root===r.graph){var d=t.gltf.nodes[h];if(d.hasOwnProperty("mesh"))for(var p=t.renders[d.mesh].meshes,_=0;_<p.length;_++){var g=p[_];g&&function(y,v,x,S,T,b,w){var A=t.meshDefaultMaterials[v.id],C=new De(v,A===void 0?e:T[A],b);if(v.morph){var L=new na(v.morph);C.morphInstance=L,y.morphInstances.push(L)}if(w.hasOwnProperty("skin")){var I=w.skin;v.skin=x[I];var P=S[I];C.skinInstance=P,y.skinInstances.push(P)}y.meshInstances.push(C)}(r,g,t.skins,s,t.materials,f,d)}}}return r},a=[{key:"model",get:function(){if(!this._model){var t=o.createModel(this.data,this._defaultMaterial),e=o.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),LM=function(){function o(i,t,e){this._device=i,this._assets=t,this._defaultMaterial=Mc.createDefaultMaterial(),this.maxRetries=e}var a=o.prototype;return a._getUrlWithoutParams=function(i){return i.indexOf("?")>=0?i.split("?")[0]:i},a.load=function(i,t,e){var n=this;$.fetchArrayBuffer(i.load,function(r,s){r?t(r):Mc.parse(n._getUrlWithoutParams(i.original),ce.extractPath(i.load),s,n._device,e.registry,e.options,function(l,u){l?t(l):t(null,new KT(u,e,n._assets,n._defaultMaterial))})},e,this.maxRetries)},a.open=function(i,t,e){return t},a.patch=function(i,t){},o}();function ZT(o,a){return(ZT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var DM=function(){function o(){}var a=o.prototype;return a.instantiateModelEntity=function(i){return null},a.instantiateRenderEntity=function(i){return null},a.getMaterialVariants=function(){return null},a.applyMaterialVariant=function(i,t){},a.applyMaterialVariantInstances=function(i,t){},o}(),QT=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this,e,"container")||this).glbContainerParser=new LM(e.graphicsDevice,e.assets,0),n.parsers={},n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ZT(a,o);var i,t=a.prototype;return t._getUrlWithoutParams=function(e){return e.indexOf("?")>=0?e.split("?")[0]:e},t._getParser=function(e){var n=e?ce.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[n]||this.glbContainerParser},t.load=function(e,n,r){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,n,r)},t.open=function(e,n,r){return this._getParser(e).open(e,n,r)},i=[{key:"maxRetries",get:function(){return this.glbContainerParser.maxRetries},set:function(e){for(var n in this.glbContainerParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(n)&&(this.parsers[n].maxRetries=e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Oe);function JT(o,a){return(JT=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var $T=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"css")||this).decoder=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&JT(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e("Error loading css resource: "+t.original+" ["+n+"]"):e(null,r)})},i.openBinary=function(t){return this.decoder!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(t)},a}(Oe);function eE(o,a){return(eE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var tE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"cubemap")||this)._device=t.graphicsDevice,e._registry=t.assets,e._loader=t.loader,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&eE(a,o);var i=a.prototype;return i.load=function(t,e,n){this.loadAssets(n,e)},i.open=function(t,e,n){return n?n.resource:null},i.patch=function(t,e){this.loadAssets(t,function(n,r){n&&(e.fire("error",t),e.fire("error:"+t.id,n,t),t.fire("error",t))})},i.getAssetIds=function(t){var e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(var n=0;n<6;++n)e[n+1]=t.data.textures[n];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e},i.compareAssetIds=function(t,e){return t&&e?parseInt(t,10)===t||typeof t=="string"?t===e:t.url===e.url:t!==null==(e!==null)},i.update=function(t,e,n){var r=t.data||{},s=t._handlerState.assets,l=t._resources,u=[null,null,null,null,null,null,null],c=function(){return r.hasOwnProperty("type")?r.type:r.hasOwnProperty("rgbm")?r.rgbm?Wn:Wt:null};if(t.loaded&&n[0]===s[0])u[1]=l[1]||null,u[2]=l[2]||null,u[3]=l[3]||null,u[4]=l[4]||null,u[5]=l[5]||null,u[6]=l[6]||null;else if(n[0])if((f=n[0].resource).cubemap)for(p=0;p<6;++p)u[p+1]=new ee(this._device,{name:t.name+"_prelitCubemap"+(f.width>>p),cubemap:!0,type:c()||f.type,width:f.width>>p,height:f.height>>p,format:f.format,levels:[f._levels[p]],addressU:1,addressV:1,mipmaps:p===0});else u[1]=f;var h=n.slice(1);if(t.loaded&&this.cmpArrays(h,s.slice(1)))u[0]=l[0]||null;else if(h.indexOf(null)===-1){var f,d,p,_,g=h.map(function(S){return S.resource}),y=[];for(d=0;d<g[0]._levels.length;++d)y.push(g.map(function(S){return S._levels[d]}));var v=g[0].format,x=new ee(this._device,{name:""+t.name+"_faces",cubemap:!0,type:c()||g[0].type,width:g[0].width,height:g[0].height,format:v===6?7:v,mipmaps:(_=r.mipmaps)==null||_,levels:y,minFilter:r.hasOwnProperty("minFilter")?r.minFilter:g[0].minFilter,magFilter:r.hasOwnProperty("magFilter")?r.magFilter:g[0].magFilter,anisotropy:r.hasOwnProperty("anisotropy")?r.anisotropy:1,addressU:1,addressV:1});u[0]=x}if(!this.cmpArrays(u,l))for(p=0,t.resources=u,t._handlerState.assetIds=e,t._handlerState.assets=n;p<l.length;++p)l[p]!==null&&u.indexOf(l[p])===-1&&l[p].destroy();for(p=0;p<s.length;++p)s[p]!==null&&n.indexOf(s[p])===-1&&s[p].unload()},i.cmpArrays=function(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0},i.resolveId=function(t){var e=parseInt(t,10);return e===t||e.toString()===t?e:t},i.loadAssets=function(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var n,r=this,s=r.getAssetIds(t),l=[null,null,null,null,null,null,null],u=t._handlerState.assetIds,c=t._handlerState.assets,h=r._registry,f=7,d=function(S,T){l[S]=T,--f==0&&(r.update(t,s,l),e(null,t.resources))},p=function(S,T,b){e(T)},_=function(S,T){T.loaded?d(S,T):(h.once("load:"+T.id,d.bind(r,S)),h.once("error:"+T.id,p.bind(r,S)),T.loading||h.load(T))},g=0;g<7;++g){var y=this.resolveId(s[g]);if(y)if(r.compareAssetIds(y,u[g]))_(g,c[g]);else if(parseInt(y,10)===y)(n=h.get(y))?_(g,n):setTimeout((function(S,T){var b=h.get(T);b?_(S,b):p(S,"failed to find dependent cubemap asset="+T)}).bind(null,g,y));else{var v=typeof y=="string"?{url:y,filename:y}:y,x=v.url.search(".dds")===-1?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;n=new $(t.name+"_part_"+g,"texture",v,x),h.add(n),_(g,n)}else d(g,null)}},a}(Oe);function nE(o,a){return(nE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var iE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i){return o.call(this,i,"folder")||this}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&nE(a,o),a.prototype.load=function(i,t){t(null,null)},a}(Oe),Ep=function(){var o;function a(i,t){this.type=t&&t.type||pc,this.em=1,this.textures=i,this.intensity=0,this._data=null,this.data=t}return o=[{key:"data",get:function(){return this._data},set:function(i){if(this._data=i,i&&(this._data.intensity!==void 0&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars))for(var t in this._data.chars)this._data.chars[t].map=0}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function rE(o,a){return(rE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function wp(o){return o.version<3&&(o.version<2&&(o.info.maps=o.info.maps||[{width:o.info.width,height:o.info.height}]),o.chars=Object.keys(o.chars||{}).reduce(function(a,i){var t=o.chars[i],e=t.letter!==void 0?t.letter:er.fromCodePoint(i);return o.version<2&&(t.map=t.map||0),a[e]=t,a},{}),o.version=3),o}var sE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"font")||this)._loader=t.loader,e.maxRetries=0,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&rE(a,o);var i=a.prototype;return i.load=function(t,e,n){typeof t=="string"&&(t={load:t,original:t});var r=this;ce.getExtension(t.original)===".json"?Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,l){if(s)e("Error loading font resource: "+t.original+" ["+s+"]");else{var u=wp(l);r._loadTextures(t.load.replace(".json",".png"),u,function(c,h){c?e(c):e(null,{data:u,textures:h})})}}):(n&&n.data&&(n.data=wp(n.data)),this._loadTextures(t.load,n&&n.data,e))},i._loadTextures=function(t,e,n){for(var r=e.info.maps.length,s=0,l=null,u=Array(r),c=this._loader,h=function(d){var p=function(_,g){if(!l){if(_){l=_,n(_);return}g.upload(),u[d]=g,++s===r&&n(null,u)}};d===0?c.load(t,"texture",p):c.load(t.replace(".png",""+d+".png"),"texture",p)},f=0;f<r;f++)h(f)},i.open=function(t,e,n){return e.textures?new Ep(e.textures,e.data):new Ep(e,null)},i.patch=function(t,e){var n=t.resource;!n.data&&t.data?n.data=t.data:!t.data&&n.data&&(t.data=n.data),t.data&&(t.data=wp(t.data))},a}(Oe),MM=function(o,a,i,t,e,n){var r=function(x,S){var T=(1<<S)-1;return(x&T)/T},s=function(x,S){x.x=r(S>>>21,11),x.y=r(S>>>11,10),x.z=r(S,11)},l=function(x,S){x.x=r(S>>>24,8),x.y=r(S>>>16,8),x.z=r(S>>>8,8),x.w=r(S,8)},u=function(x,S){var T=1/(.5*Math.sqrt(2)),b=(r(S>>>20,10)-.5)*T,w=(r(S>>>10,10)-.5)*T,A=(r(S,10)-.5)*T,C=Math.sqrt(1-(b*b+w*w+A*A));switch(S>>>30){case 0:x.set(b,w,A,C);break;case 1:x.set(C,w,A,b);break;case 2:x.set(w,C,A,b);break;case 3:x.set(w,A,C,b)}},c=function(x,S,T){return x*(1-T)+S*T},h=o.chunkData,f=o.chunkSize,d=o.vertexData,p=o.shData0,_=o.shData1,g=o.shData2,y=o.shBands,v=[3,8,15][y-1];this.read=function(x){var S=Math.floor(x/256)*f;if(a&&(s(a,d[4*x+0]),a.x=c(h[S+0],h[S+3],a.x),a.y=c(h[S+1],h[S+4],a.y),a.z=c(h[S+2],h[S+5],a.z)),i&&u(i,d[4*x+1]),t&&(s(t,d[4*x+2]),t.x=c(h[S+6],h[S+9],t.x),t.y=c(h[S+7],h[S+10],t.y),t.z=c(h[S+8],h[S+11],t.z)),e&&(l(e,d[4*x+3]),f>12&&(e.x=c(h[S+12],h[S+15],e.x),e.y=c(h[S+13],h[S+16],e.y),e.z=c(h[S+14],h[S+17],e.z))),n&&y>0)for(var T=[p,_,g],b=0;b<3;++b)for(var w=0;w<15;++w)n[15*b+w]=w<v?T[b][16*x+w]*(8/255)-4:0}},RM=function(){function o(){}var a,i=o.prototype;return i.createIter=function(t,e,n,r,s){return new MM(this,t,e,n,r,s)},i.calcAabb=function(t){for(var e=this.chunkData,n=this.numChunks,r=this.chunkSize,s=Math.exp(Math.max(e[9],e[10],e[11])),l=e[0]-s,u=e[1]-s,c=e[2]-s,h=e[3]+s,f=e[4]+s,d=e[5]+s,p=1;p<n;++p){var _=p*r;s=Math.exp(Math.max(e[_+9],e[_+10],e[_+11])),l=Math.min(l,e[_+0]-s),u=Math.min(u,e[_+1]-s),c=Math.min(c,e[_+2]-s),h=Math.max(h,e[_+3]+s),f=Math.max(f,e[_+4]+s),d=Math.max(d,e[_+5]+s)}return t.center.set((l+h)*.5,(u+f)*.5,(c+d)*.5),t.halfExtents.set((h-l)*.5,(f-u)*.5,(d-c)*.5),!0},i.getCenters=function(t){for(var e,n,r,s,l,u,c=this.vertexData,h=this.chunkData,f=this.numChunks,d=this.chunkSize,p=0;p<f;++p){var _=p*d;e=h[_+0],n=h[_+1],r=h[_+2],s=h[_+3],l=h[_+4],u=h[_+5];for(var g=Math.min(this.numSplats,(p+1)*256),y=256*p;y<g;++y){var v=c[4*y],x=(v>>>21)/2047,S=(v>>>11&1023)/1023,T=(2047&v)/2047;t[3*y+0]=(1-x)*e+x*s,t[3*y+1]=(1-S)*n+S*l,t[3*y+2]=(1-T)*r+T*u}}},i.getChunks=function(t){for(var e,n,r,s,l,u,c=this.chunkData,h=this.numChunks,f=this.chunkSize,d=0;d<h;++d){var p=d*f;e=c[p+0],n=c[p+1],r=c[p+2],s=c[p+3],l=c[p+4],u=c[p+5],t[6*d+0]=e,t[6*d+1]=n,t[6*d+2]=r,t[6*d+3]=s,t[6*d+4]=l,t[6*d+5]=u}},i.calcFocalPoint=function(t){var e=this.chunkData,n=this.numChunks,r=this.chunkSize;t.x=0,t.y=0,t.z=0;for(var s=0;s<n;++s){var l=s*r;t.x+=e[l+0]+e[l+3],t.y+=e[l+1]+e[l+4],t.z+=e[l+2]+e[l+5]}t.mulScalar(.5/n)},i.decompress=function(){var t=this,e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],n=this.shBands;if(n>0){for(var r=[],s=0;s<45;++s)r.push("f_rest_"+s);e.splice.apply(e,[].concat([e.indexOf("f_dc_0")+1,0],r))}var l={};e.forEach(function(y){l[y]=new Float32Array(t.numSplats)});for(var u=new E,c=new Z,h=new E,f=new q,d=n>0?new Float32Array(45):null,p=this.createIter(u,c,h,f,d),_=0;_<this.numSplats;++_)if(p.read(_),l.x[_]=u.x,l.y[_]=u.y,l.z[_]=u.z,l.rot_1[_]=c.x,l.rot_2[_]=c.y,l.rot_3[_]=c.z,l.rot_0[_]=c.w,l.scale_0[_]=h.x,l.scale_1[_]=h.y,l.scale_2[_]=h.z,l.f_dc_0[_]=(f.x-.5)/.28209479177387814,l.f_dc_1[_]=(f.y-.5)/.28209479177387814,l.f_dc_2[_]=(f.z-.5)/.28209479177387814,l.opacity[_]=f.w<=0?-40:f.w>=1?40:-Math.log(1/f.w-1),d)for(var g=0;g<45;++g)l["f_rest_"+g][_]=d[g];return new qo([{name:"vertex",count:this.numSplats,properties:e.map(function(y){return{name:y,type:"float",byteSize:4,storage:l[y]}})}],this.comments)},a=[{key:"isCompressed",get:function(){return!0}},{key:"numChunks",get:function(){return Math.ceil(this.numSplats/256)}},{key:"chunkSize",get:function(){return this.chunkData.length/this.numChunks}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function aE(o,a){return(aE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var OM=function(o,a,i,t,e){for(var n=0;n<e;++n)for(var r=0;r<t;++r)o[n*a+r]=i[n*t+r]},kM=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n=o.call(this,t,e)||this,r=e.chunkData,s=e.chunkSize,l=e.numChunks,u=e.numSplats,c=e.vertexData,h=e.shBands;n.chunks=new Float32Array(6*l),e.getChunks(n.chunks),n.packedTexture=n.createTexture("packedData",49,n.evalTextureSize(u),c);var f=n.evalTextureSize(l);f.x*=5,n.chunkTexture=n.createTexture("chunkData",14,f);var d=n.chunkTexture.lock();if(OM(d,20,r,s,l),s===12)for(var p=0;p<l;++p)d[20*p+15]=1,d[20*p+16]=1,d[20*p+17]=1;if(n.chunkTexture.unlock(),h>0){var _=n.evalTextureSize(u);n.shTexture0=n.createTexture("shTexture0",49,_,new Uint32Array(e.shData0.buffer)),n.shTexture1=n.createTexture("shTexture1",49,_,new Uint32Array(e.shData1.buffer)),n.shTexture2=n.createTexture("shTexture2",49,_,new Uint32Array(e.shData2.buffer))}else n.shTexture0=null,n.shTexture1=null,n.shTexture2=null;return n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&aE(a,o);var i=a.prototype;return i.destroy=function(){var t,e,n,r,s;(t=this.packedTexture)==null||t.destroy(),(e=this.chunkTexture)==null||e.destroy(),(n=this.shTexture0)==null||n.destroy(),(r=this.shTexture1)==null||r.destroy(),(s=this.shTexture2)==null||s.destroy(),o.prototype.destroy.call(this)},i.configureMaterial=function(t){t.setDefine("GSPLAT_COMPRESSED_DATA",!0),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0)},i.evalTextureSize=function(t){var e=Math.ceil(Math.sqrt(t)),n=Math.ceil(t/e);return new G(e,n)},a}(Qu);function oE(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function xr(o){return function(){var a=this,i=arguments;return new Promise(function(t,e){var n=o.apply(a,i);function r(l){oE(n,t,e,r,s,"next",l)}function s(l){oE(n,t,e,r,s,"throw",l)}r(void 0)})}}function br(o,a){var i,t,e,n={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]},r=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return r.next=s(0),r.throw=s(1),r.return=s(2),typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function s(l){return function(u){var c=[l,u];if(i)throw TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(n=0)),n;)try{if(i=1,t&&(e=2&c[0]?t.return:c[0]?t.throw||((e=t.return)&&e.call(t),0):t.next)&&!(e=e.call(t,c[1])).done)return e;switch(t=0,e&&(c=[2&c[0],e.value]),c[0]){case 0:case 1:e=c;break;case 4:return n.label++,{value:c[1],done:!1};case 5:n.label++,t=c[1],c=[0];continue;case 7:c=n.ops.pop(),n.trys.pop();continue;default:if(!(e=(e=n.trys).length>0&&e[e.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!e||c[1]>e[0]&&c[1]<e[3])){n.label=c[1];break}if(c[0]===6&&n.label<e[1]){n.label=e[1],e=c;break}if(e&&n.label<e[2]){n.label=e[2],n.ops.push(c);break}e[2]&&n.ops.pop(),n.trys.pop();continue}c=a.call(o,n)}catch(h){c=[6,h],t=0}finally{i=e=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var lE=new Uint8Array([112,108,121,10]),uE=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),Ap=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]),NM=function(){function o(t,e){this.head=0,this.tail=0,this.reader=t,this.progressFunc=e}var a,i=o.prototype;return i.read=function(){var t=this;return xr(function(){var e,n;return br(this,function(r){switch(r.label){case 0:return[4,t.reader.read()];case 1:if(n=(e=r.sent()).value,e.done)throw Error("Stream finished before end of header");return t.push(n),t.progressFunc==null||t.progressFunc.call(t,n.byteLength),[2]}})})()},i.push=function(t){if(this.data){var e=this.tail-this.head,n=e+t.length;if(this.data.length>=n)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(t,e),this.head=0,this.tail=n):(this.data.set(t,this.tail),this.tail+=t.length);else{var r=new Uint8Array(n);this.head>0||this.tail<this.data.length?r.set(this.data.subarray(this.head,this.tail),0):r.set(this.data,0),r.set(t,e),this.data=r,this.view=new DataView(this.data.buffer),this.head=0,this.tail=n}}else this.data=t,this.view=new DataView(this.data.buffer),this.tail=t.length},i.compact=function(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)},i.getInt8=function(){var t=this.view.getInt8(this.head);return this.head++,t},i.getUint8=function(){var t=this.view.getUint8(this.head);return this.head++,t},i.getInt16=function(){var t=this.view.getInt16(this.head,!0);return this.head+=2,t},i.getUint16=function(){var t=this.view.getUint16(this.head,!0);return this.head+=2,t},i.getInt32=function(){var t=this.view.getInt32(this.head,!0);return this.head+=4,t},i.getUint32=function(){var t=this.view.getUint32(this.head,!0);return this.head+=4,t},i.getFloat32=function(){var t=this.view.getFloat32(this.head,!0);return this.head+=4,t},i.getFloat64=function(){var t=this.view.getFloat64(this.head,!0);return this.head+=8,t},a=[{key:"remaining",get:function(){return this.tail-this.head}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),FM=function(o){for(var a,i=[],t=[],e=1;e<o.length;++e){var n=o[e].split(" ");switch(n[0]){case"comment":t.push(n.slice(1).join(" "));break;case"format":a=n[1];break;case"element":i.push({name:n[1],count:parseInt(n[2],10),properties:[]});break;case"property":if(!Ap.has(n[1]))throw Error("Unrecognized property data type '"+n[1]+"' in ply header");i[i.length-1].properties.push({type:n[1],name:n[2],storage:null,byteSize:Ap.get(n[1]).BYTES_PER_ELEMENT});break;default:throw Error("Unrecognized header value '"+n[0]+"' in ply header")}}return{elements:i,format:a,comments:t}},UM=function(o){var a=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],i=["packed_position","packed_rotation","packed_scale","packed_color"],t=Array(45).fill("").map(function(n,r){return"f_rest_"+r}),e=function(){return o[0].name==="chunk"&&o[0].properties.every(function(n,r){return n.name===a[r]&&n.type==="float"})&&o[1].name==="vertex"&&o[1].properties.every(function(n,r){return n.name===i[r]&&n.type==="uint"})};return o.length===2&&e()||o.length===3&&e()&&o[2].name==="sh"&&[9,24,45].indexOf(o[2].properties.length)!==-1&&o[2].properties.every(function(n,r){return n.name===t[r]&&n.type==="uchar"})},BM=xr(function(o,a,i){var t,e,n,r,s,l,u,c,h,f,d,p,_,g,y,v,x,S;return br(this,function(T){switch(T.label){case 0:var b,w,A;return(t=new RM).comments=i,e=a[0].count,n=a[0].properties.length,w=Math.ceil(Math.sqrt(b=r=a[1].count)),A=Math.ceil(b/w),s=w*A,t.numSplats=r,t.chunkData=new Float32Array(e*n),t.vertexData=new Uint32Array(4*s),[4,(l=xr(function(C,L){var I,P,M,R,k;return br(this,function(D){switch(D.label){case 0:I=new Uint8Array(C),P=0,D.label=1;case 1:if(!(P<L))return[3,5];D.label=2;case 2:return o.remaining!==0?[3,4]:[4,o.read()];case 3:return D.sent(),[3,2];case 4:for(k=0,M=Math.min(L-P,o.remaining),R=o.data;k<M;++k)I[P++]=R[o.head++];return[3,1];case 5:return[2]}})}))(t.chunkData.buffer,e*n*4)];case 1:return T.sent(),[4,l(t.vertexData.buffer,4*r*4)];case 2:if(T.sent(),a.length!==3)return[3,7];c=new Uint8Array(u=16*s),h=new Uint8Array(u),f=new Uint8Array(u),d=1024,p=a[2].properties.length/3,_=new Uint8Array(d*p*3),g=0,T.label=3;case 3:return g<t.numSplats?(y=Math.min(d,t.numSplats-g),[4,l(_.buffer,y*p*3)]):[3,6];case 4:for(T.sent(),v=0;v<y;++v)for(x=0;x<15;++x)S=(g+v)*16+x,x<p?(c[S]=_[(3*v+0)*p+x],h[S]=_[(3*v+1)*p+x],f[S]=_[(3*v+2)*p+x]):(c[S]=127,h[S]=127,f[S]=127);T.label=5;case 5:return g+=d,[3,3];case 6:return t.shData0=c,t.shData1=h,t.shData2=f,t.shBands={3:1,8:2,15:3}[p],[3,8];case 7:t.shBands=0,T.label=8;case 8:return[2,t]}})}),VM=xr(function(o,a,i){var t,e,n,r,s,l,u,c,h,f,d,p;return br(this,function(_){switch(_.label){case 0:n=(e=(t=a[0]).properties).length,r=e.map(function(g){return g.storage}),s=e.reduce(function(g,y){return g+y.byteSize},0),l=0,(c=function(){var g=o.data.buffer;(u==null?void 0:u.buffer)!==g&&(u=new Float32Array(g,0,g.byteLength/4))})(),_.label=1;case 1:if(!(l<t.count))return[3,5];_.label=2;case 2:return o.remaining<s?[4,o.read()]:[3,4];case 3:return _.sent(),c(),[3,2];case 4:for(f=0,h=Math.min(t.count-l,Math.floor(o.remaining/s));f<n;++f)for(p=0,d=r[f];p<h;++p)d[p+l]=u[p*n+f];return l+=h,o.head+=h*s,[3,1];case 5:return[2,new qo(a,i)]}})}),zM=xr(function(o,a,i){var t,e,n,r,s,l,u,c;return br(this,function(h){switch(h.label){case 0:t=0,h.label=1;case 1:if(!(t<a.length))return[3,7];n=(e=a[t]).properties.reduce(function(f,d){return f+d.byteSize},0),r=e.properties.map(function(f){if(!f.storage)return function(d){d.head+=f.byteSize};switch(f.type){case"char":return function(d,p){f.storage[p]=d.getInt8()};case"uchar":return function(d,p){f.storage[p]=d.getUint8()};case"short":return function(d,p){f.storage[p]=d.getInt16()};case"ushort":return function(d,p){f.storage[p]=d.getUint16()};case"int":return function(d,p){f.storage[p]=d.getInt32()};case"uint":return function(d,p){f.storage[p]=d.getUint32()};case"float":return function(d,p){f.storage[p]=d.getFloat32()};case"double":return function(d,p){f.storage[p]=d.getFloat64()};default:throw Error("Unsupported property data type '"+f.type+"' in ply header")}}),s=0,h.label=2;case 2:if(!(s<e.count))return[3,6];h.label=3;case 3:return o.remaining<n?[4,o.read()]:[3,5];case 4:return h.sent(),[3,3];case 5:for(u=0,l=Math.min(e.count-s,Math.floor(o.remaining/n));u<l;++u){for(c=0;c<e.properties.length;++c)r[c](o,s);s++}return[3,2];case 6:return++t,[3,1];case 7:return[2,new qo(a,i)]}})}),GM=xr(function(o,a,i){var t,e,n,r,s,l,u,c;return br(this,function(h){switch(h.label){case 0:a===void 0&&(a=null),i===void 0&&(i=null),t=function(f,d){var p,_,g=f.length-d.length;for(p=0;p<=g;++p){for(_=0;_<d.length&&f[p+_]===d[_];++_);if(_===d.length)return p}return-1},e=function(f,d){if(f.length<d.length)return!1;for(var p=0;p<d.length;++p)if(f[p]!==d[p])return!1;return!0},n=new NM(o,i),h.label=1;case 1:return[4,n.read()];case 2:if(h.sent(),n.tail>=lE.length&&!e(n.data,lE))throw Error("Invalid ply header");return(r=t(n.data,uE))!==-1?[3,3]:[3,1];case 3:if(l=(s=FM(new TextDecoder("ascii").decode(n.data.subarray(0,r)).split(`
`))).elements,u=s.format,c=s.comments,u!=="binary_little_endian")throw Error("Unsupported ply format");return n.head=r+uE.length,n.compact(),[4,xr(function(){return br(this,function(f){switch(f.label){case 0:return UM(l)?[4,BM(n,l,c)]:[3,2];case 1:case 3:case 5:return[2,f.sent()];case 2:return l.forEach(function(d){d.properties.forEach(function(p){var _=Ap.get(p.type);if(_){var g=!a||a(p.name)?new _(d.count):null;p.storage=g}})}),l.length===1&&l[0].name==="vertex"&&l[0].properties.every(function(d){return d.type==="float"})?[4,VM(n,l,c)]:[3,4];case 4:return[4,zM(n,l,c)]}})})()];case 4:return[2,h.sent()]}})}),HM=function(o){return!0},WM=function(){function o(i,t){this.app=i,this.maxRetries=t}var a=o.prototype;return a.load=function(i,t,e){var n=this;return xr(function(){var r,s,l,u,c,h,f,d,p;return br(this,function(_){switch(_.label){case 0:return _.trys.push([0,5,,6]),[4,(s=(r=e.file)==null?void 0:r.contents)!=null?s:fetch(i.load)];case 1:return!(l=_.sent())||!l.body?(t("Error loading resource",null),[3,4]):[3,2];case 2:return c=parseInt((u=l.headers.get("content-length"))!=null?u:"0",10),h=0,[4,GM(l.body.getReader(),(f=e.data.elementFilter)!=null?f:HM,function(g){h+=g,e&&e.fire("progress",h,c)})];case 3:!(d=_.sent()).isCompressed&&((p=e.data.reorder)==null||p)&&d.reorderData(),t(null,d.isCompressed&&!e.data.decompress?new kM(n.app.graphicsDevice,d):new Ju(n.app.graphicsDevice,d.isCompressed?d.decompress():d)),_.label=4;case 4:return[3,6];case 5:return t(_.sent(),null),[3,6];case 6:return[2]}})})()},a.open=function(i,t){return t},o}();function cE(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}var jM=function(){function o(i,t){this.app=i,this.maxRetries=t}var a=o.prototype;return a.loadTextures=function(i,t,e,n){var r,s=this;return(r=function(){var l,u,c,h,f,d,p,_,g,y,v,x,S,T;return function(b,w){var A,C,L,I={label:0,sent:function(){if(1&L[0])throw L[1];return L[1]},trys:[],ops:[]},P=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return P.next=M(0),P.throw=M(1),P.return=M(2),typeof Symbol=="function"&&(P[Symbol.iterator]=function(){return this}),P;function M(R){return function(k){var D=[R,k];if(A)throw TypeError("Generator is already executing.");for(;P&&(P=0,D[0]&&(I=0)),I;)try{if(A=1,C&&(L=2&D[0]?C.return:D[0]?C.throw||((L=C.return)&&L.call(C),0):C.next)&&!(L=L.call(C,D[1])).done)return L;switch(C=0,L&&(D=[2&D[0],L.value]),D[0]){case 0:case 1:L=D;break;case 4:return I.label++,{value:D[1],done:!1};case 5:I.label++,C=D[1],D=[0];continue;case 7:D=I.ops.pop(),I.trys.pop();continue;default:if(!(L=(L=I.trys).length>0&&L[L.length-1])&&(D[0]===6||D[0]===2)){I=0;continue}if(D[0]===3&&(!L||D[1]>L[0]&&D[1]<L[3])){I.label=D[1];break}if(D[0]===6&&I.label<L[1]){I.label=L[1],L=D;break}if(L&&I.label<L[2]){I.label=L[2],I.ops.push(D);break}L[2]&&I.ops.pop(),I.trys.pop();continue}D=w.call(b,I)}catch(O){D=[6,O],C=0}finally{A=L=0}if(5&D[0])throw D[1];return{value:D[0]?D[1]:void 0,done:!0}}}}(this,function(b){switch(b.label){case 0:return p=s.app.assets,_={},g=[],["means","quats","scales","sh0","shN"].forEach(function(w){var A,C,L=(C=(A=n[w])==null?void 0:A.files)!=null?C:[];_[w]=L.map(function(I){var P,M,R,k=new $(I,"texture",{url:(R=(M=e.options)==null||(P=M.mapUrl)==null?void 0:P.call(M,I))!=null?R:new URL(I,new URL(i.load,window.location.href).toString()).toString(),filename:I},{mipmaps:!1}),D=new Promise(function(O,F){k.on("load",function(){return O(null)}),k.on("error",function(N){return F(N)})});return p.add(k),p.load(k),g.push(D),k})}),[4,Promise.allSettled(g)];case 1:return b.sent(),(y=new PS).meta=n,y.numSplats=n.means.shape[0],y.means_l=_.means[0].resource,y.means_u=_.means[1].resource,y.quats=_.quats[0].resource,y.scales=_.scales[0].resource,y.sh0=_.sh0[0].resource,y.sh_centroids=(u=_.shN)==null||(l=u[0])==null?void 0:l.resource,y.sh_labels=(h=_.shN)==null||(c=h[1])==null?void 0:c.resource,(v=(f=e.data)==null?void 0:f.reorder)==null||v?[4,y.reorderData()]:[3,3];case 2:b.sent(),b.label=3;case 3:return(d=e.data)!=null&&d.decompress?(S=Ju.bind,T=[void 0,s.app.graphicsDevice],[4,y.decompress()]):[3,5];case 4:return x=new(S.apply(Ju,T.concat([b.sent()]))),[3,6];case 5:x=new LS(s.app.graphicsDevice,y),b.label=6;case 6:return t(null,x),[2]}})},function(){var l=this,u=arguments;return new Promise(function(c,h){var f=r.apply(l,u);function d(_){cE(f,c,h,d,p,"next",_)}function p(_){cE(f,c,h,d,p,"throw",_)}d(void 0)})})()},a.load=function(i,t,e){var n,r=this;if((n=e.data)!=null&&n.means)this.loadTextures(i,t,e,e.data);else{typeof i=="string"&&(i={load:i,original:i});var s={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:Tt.ResponseType.JSON};Fe.get(i.load,s,function(l,u){l?t("Error loading gsplat meta: "+i.original+" ["+l+"]"):r.loadTextures(i,t,e,u)})}},o}();function hE(o,a){return(hE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var fE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"gsplat")||this).parsers={ply:new WM(t,3),json:new jM(t,3)},e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&hE(a,o);var i=a.prototype;return i._getUrlWithoutParams=function(t){return t.indexOf("?")>=0?t.split("?")[0]:t},i._getParser=function(t){var e=ce.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.parsers.ply},i.load=function(t,e,n){typeof t=="string"&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,n)},i.open=function(t,e,n){return e},a}(Oe),Cp=function(){function o(){}return o.setCompressedPRS=function(a,i,t){var e,n,r=t.singleVecs,s=i.___1;s||(e=t.tripleVecs,n=i.___2);var l=s?s[0]:e[n];a.setLocalPosition(r[l],r[l+1],r[l+2]),l=s?s[1]:e[n+1],a.setLocalEulerAngles(r[l],r[l+1],r[l+2]),l=s?s[2]:e[n+2],a.setLocalScale(r[l],r[l+1],r[l+2])},o.oneCharToKey=function(a,i){var t=a.charCodeAt(0)-i.fieldFirstCode;return i.fieldArray[t]},o.multCharToKey=function(a,i){for(var t=0,e=0;e<a.length;e++)t=t*i.fieldCodeBase+a.charCodeAt(e)-i.fieldFirstCode;return i.fieldArray[t]},o}(),XM=function(){function o(i,t){this._node=i,this._data=t}var a=o.prototype;return a.run=function(){var i=Object.prototype.toString.call(this._node);return i==="[object Object]"?this._handleMap():i==="[object Array]"?this._handleArray():this._result=this._node,this._result},a._handleMap=function(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)},a._handleKey=function(i){var t=i,e=i.length;e===1?t=Cp.oneCharToKey(i,this._data):e===2&&(t=Cp.multCharToKey(i,this._data)),this._result[t]=new o(this._node[i],this._data).run()},a._handleArray=function(){this._result=[],this._node.forEach(this._handleArElt,this)},a._handleArElt=function(i){var t=new o(i,this._data).run();this._result.push(t)},o}(),Pp=function(){function o(i,t){this._app=i,this._isTemplate=t}var a=o.prototype;return a.parse=function(i){var t={},e=null,n=i.compressedFormat;for(var r in n&&!i.entDecompressed&&(i.entDecompressed=!0,i.entities=new XM(i.entities,n).run()),i.entities){var s=i.entities[r],l=this._createEntity(s,n);t[r]=l,s.parent===null&&(e=l)}for(var u in i.entities)for(var c=t[u],h=i.entities[u].children,f=h.length,d=0;d<f;d++){var p=t[h[d]];p&&c.addChild(p)}return this._openComponentData(e,i.entities),e},a._createEntity=function(i,t){var e,n=new ve(i.name,this._app);if(n.setGuid(i.resource_id),this._setPosRotScale(n,i,t),n._enabled=(e=i.enabled)==null||e,this._isTemplate?n._template=!0:n._enabledInHierarchy=n._enabled,n.template=i.template,i.tags)for(var r=0;r<i.tags.length;r++)n.tags.add(i.tags[r]);return n},a._setPosRotScale=function(i,t,e){if(e)Cp.setCompressedPRS(i,t,e);else{var n=t.position,r=t.rotation,s=t.scale;i.setLocalPosition(n[0],n[1],n[2]),i.setLocalEulerAngles(r[0],r[1],r[2]),i.setLocalScale(s[0],s[1],s[2])}},a._openComponentData=function(i,t){for(var e=this._app.systems.list,n=e.length,r=t[i.getGuid()],s=0;s<n;s++){var l=e[s],u=r.components[l.id];u&&l.addComponent(i,u)}n=r.children.length;for(var c=i._children,h=0;h<n;h++)c[h]&&(c[h]=this._openComponentData(c[h],t));return i},o}(),Ip=function(){function o(){}return o.load=function(a,i,t){typeof a=="string"&&(a={load:a,original:a}),Fe.get(a.load,{retry:i>0,maxRetries:i},function(e,n){if(e){var r="Error while loading scene JSON "+a.original;e.message?(r+=": "+e.message,e.stack&&(r+=`
`+e.stack)):r+=": "+e,t(r)}else t(e,n)})},o}();function dE(o,a){return(dE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var pE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){return o.call(this,t,"hierarchy")||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&dE(a,o);var i=a.prototype;return i.load=function(t,e){Ip.load(t,this.maxRetries,e)},i.open=function(t,e){this._app.systems.script.preloading=!0;var n=new Pp(this._app,!1).parse(e);return this._app.systems.script.preloading=!1,n},a}(Oe);function mE(o,a){return(mE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var _E=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"html")||this).decoder=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&mE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e("Error loading html resource: "+t.original+" ["+n+"]"):e(null,r)})},i.openBinary=function(t){return this.decoder!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(t)},a}(Oe);function vE(o,a){return(vE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var gE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"json")||this).decoder=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&vE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(n.responseType=Tt.ResponseType.JSON),Fe.get(t.load,n,function(r,s){r?e("Error loading JSON resource: "+t.original+" ["+r+"]"):e(null,s)})},i.openBinary=function(t){return this.decoder!=null||(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(t))},a}(Oe);function ds(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var YM=function(){function o(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7])}}var a=o.prototype;return a.setInvalid=function(i,t){this.valid=!1,this.removeInvalid&&delete t[i]},a.validate=function(i){var t=i.mappingFormat==="path";for(var e in i){var n=ha[e];if(!n){UI[e]?delete i[e]:this.valid=!1;continue}if(n.startsWith("enum")){var r=n.split(":")[1];this.enumValidators[r]&&!this.enumValidators[r](i[e])&&this.setInvalid(e,i)}else if(n==="number")typeof i[e]!="number"&&this.setInvalid(e,i);else if(n==="boolean")typeof i[e]!="boolean"&&this.setInvalid(e,i);else if(n==="string")typeof i[e]!="string"&&this.setInvalid(e,i);else if(n==="vec2")ds(i[e],Array)&&i[e].length===2||this.setInvalid(e,i);else if(n==="rgb")ds(i[e],Array)&&i[e].length===3||this.setInvalid(e,i);else if(n==="texture")t?typeof i[e]=="string"||i[e]===null||ds(i[e],ee)||this.setInvalid(e,i):typeof i[e]=="number"||i[e]===null||ds(i[e],ee)||this.setInvalid(e,i);else if(n==="boundingbox")i[e].center&&ds(i[e].center,Array)&&i[e].center.length===3||this.setInvalid(e,i),i[e].halfExtents&&ds(i[e].halfExtents,Array)&&i[e].halfExtents.length===3||this.setInvalid(e,i);else if(n==="cubemap")typeof i[e]=="number"||i[e]===null||i[e]===void 0||ds(i[e],ee)&&i[e].cubemap||this.setInvalid(e,i);else if(n==="chunks")for(var s=Object.keys(i[e]),l=0;l<s.length;l++)typeof i[e][s[l]]!="string"&&this.setInvalid(s[l],i[e])}return i.validated=!0,this.valid},a._createEnumValidator=function(i){return function(t){return i.indexOf(t)>=0}},o}();function Rc(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var yE=function(){function o(){this._validator=null}var a=o.prototype;return a.parse=function(i){var t=this.migrate(i),e=this._validate(t),n=new it;return this.initialize(n,e),n},a.initialize=function(i,t){if(t.validated||(t=this._validate(t)),t.chunks&&t.chunks&&Object.keys(t.chunks).length>0){var e=i.shaderChunks.glsl;Object.entries(t.chunks).forEach(function(c){var h=c[0],f=c[1];return e.set(h,f)})}for(var n in t){var r=ha[n],s=t[n];if(r==="vec2")i[n]=new G(s[0],s[1]);else if(r==="rgb")i[n]=new B(s[0],s[1],s[2]);else if(r==="texture")Rc(s,ee)?i[n]=s:Rc(i[n],ee)&&typeof s=="number"&&s>0||(i[n]=null);else if(r==="cubemap")Rc(s,ee)?i[n]=s:Rc(i[n],ee)&&typeof s=="number"&&s>0||(i[n]=null),n!=="cubeMap"||s||(i.prefilteredCubemaps=null);else if(r==="boundingbox"){var l=new E(s.center[0],s.center[1],s.center[2]),u=new E(s.halfExtents[0],s.halfExtents[1],s.halfExtents[2]);i[n]=new Se(l,u)}else i[n]=t[n]}i.update()},a.migrate=function(i){i.shader&&delete i.shader,i.mapping_format&&(i.mappingFormat=i.mapping_format,delete i.mapping_format);var t,e=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["specularMapTint","specularTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<e.length;t++){var n=e[t][0],r=e[t][1];i[n]!==void 0&&(i[r]===void 0&&(i[r]=i[n]),delete i[n])}var s=["fresnelFactor","shadowSampleType"];for(t=0;t<s.length;t++){var l=s[t];i.hasOwnProperty(l)&&delete i[l]}return i},a._validate=function(i){return i.validated||(this._validator||(this._validator=new YM),this._validator.validate(i)),i},o}();function SE(o,a){return(SE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var qM={aoMap:"white",aoDetailMap:"white",diffuseMap:"gray",diffuseDetailMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",normalDetailMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",thicknessMap:"black",iridescenceMap:"black",iridescenceThicknessMap:"black",envAtlas:"black",anisotropyMap:"black"},xE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"material")||this)._assets=t.assets,e._device=t.graphicsDevice,e._parser=new yE,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&SE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e&&e("Error loading material: "+t.original+" ["+n+"]"):e&&(r._engine=!0,e(null,r))})},i.open=function(t,e){var n=this._parser.parse(e);return e._engine&&(n._data=e,delete e._engine),n},i.patch=function(t,e){t.resource._data&&(t._data=t.resource._data,delete t.resource._data),t.data.name=t.name,t.resource.name=t.name,this._bindAndAssignAssets(t,e),t.off("unload",this._onAssetUnload,this),t.on("unload",this._onAssetUnload,this)},i._onAssetUnload=function(t){delete t.data.parameters,delete t.data.chunks,delete t.data.name},i._assignTexture=function(t,e,n){e.resource[t]=n},i._getPlaceholderTexture=function(t){var e=qM[t];return Vr(this._device,e)},i._assignPlaceholderTexture=function(t,e){e.resource[t]=this._getPlaceholderTexture(t)},i._onTextureLoad=function(t,e,n){this._assignTexture(t,e,n.resource),e.resource.update()},i._onTextureAdd=function(t,e,n){this._assets.load(n)},i._onTextureRemoveOrUnload=function(t,e,n){var r=e.resource;r&&e.resource[t]===n.resource&&(this._assignPlaceholderTexture(t,e),r.update())},i._assignCubemap=function(t,e,n){if(e.resource[t]=n[0],t==="cubeMap"){var r=n.slice(1);r.every(function(s){return s})?e.resource.prefilteredCubemaps=r:r[0]&&(e.resource.envAtlas=r[0])}},i._onCubemapLoad=function(t,e,n){this._assignCubemap(t,e,n.resources),this._parser.initialize(e.resource,e.data)},i._onCubemapAdd=function(t,e,n){this._assets.load(n)},i._onCubemapRemoveOrUnload=function(t,e,n){var r=e.resource;e.data.prefilteredCubeMap128===n.resources[1]&&(this._assignCubemap(t,e,[null,null,null,null,null,null,null]),r.update())},i._bindAndAssignAssets=function(t,e){var n,r,s,l=this._parser.migrate(t.data),u=t.resource,c=l.mappingFormat==="path";for(n=0;n<fa.length;n++){r=fa[n],s=u._assetReferences[r];var h=l[r],f=u[r],d=f===this._getPlaceholderTexture(r),p=l.validated;h&&(!f||!p||d)?(s||(s=new Ta(r,t,e,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),u._assetReferences[r]=s),c?s.url=t.getAbsoluteUrl(h):s.id=h,s.asset&&(s.asset.resource?this._assignTexture(r,t,s.asset.resource):this._assignPlaceholderTexture(r,t),e.load(s.asset))):s&&(c?s.url=null:s.id=null)}for(n=0;n<Xu.length;n++)r=Xu[n],s=u._assetReferences[r],l[r]&&!t.data.prefilteredCubeMap128&&(s||(s=new Ta(r,t,e,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),u._assetReferences[r]=s),c?s.url=l[r]:s.id=l[r],s.asset&&(s.asset.loaded&&this._assignCubemap(r,t,s.asset.resources),e.load(s.asset)));this._parser.initialize(u,l)},a}(Oe),KM=function(){function o(a){this._device=a.device,this._defaultMaterial=a.defaultMaterial,this._assets=a.assets}return o.prototype.parse=function(a,i,t){var e,n=this;Mc.parse("filename.glb","",a,this._device,this._assets,(e=t==null?void 0:t.options)!=null?e:{},function(r,s){if(r)i(r);else{var l=KT.createModel(s,n._defaultMaterial);s.destroy(),i(null,l)}})},o}(),ZM={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},QM={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6},JM=function(){function o(i){this._device=i.device,this._defaultMaterial=i.defaultMaterial}var a=o.prototype;return a.parse=function(i,t){var e=i.model;if(!e)return void t(null,null);if(e.version<=1)return void t("JsonModelParser#parse: Trying to parse unsupported model format.");var n=this._parseNodes(i),r=this._parseSkins(i,n),s=this._parseVertexBuffers(i),l=this._parseIndexBuffers(i,s),u=this._parseMorphs(i,n,s),c=this._parseMeshes(i,r.skins,u.morphs,s,l.buffer,l.data),h=this._parseMeshInstances(i,n,c,r.skins,r.instances,u.morphs,u.instances),f=new cr;f.graph=n[0],f.meshInstances=h,f.skinInstances=r.instances,f.morphInstances=u.instances,f.getGraph().syncHierarchy(),t(null,f)},a._parseNodes=function(i){var t,e=i.model,n=[];for(t=0;t<e.nodes.length;t++){var r=e.nodes[t],s=new pe(r.name);s.setLocalPosition(r.position[0],r.position[1],r.position[2]),s.setLocalEulerAngles(r.rotation[0],r.rotation[1],r.rotation[2]),s.setLocalScale(r.scale[0],r.scale[1],r.scale[2]),s.scaleCompensation=!!r.scaleCompensation,n.push(s)}for(t=1;t<e.parents.length;t++)n[e.parents[t]].addChild(n[t]);return n},a._parseSkins=function(i,t){var e,n,r=i.model,s=[],l=[];for(e=0;e<r.skins.length;e++){var u=r.skins[e],c=[];for(n=0;n<u.inverseBindMatrices.length;n++){var h=u.inverseBindMatrices[n];c[n]=new X().set(h)}var f=new vd(this._device,c,u.boneNames);s.push(f);var d=new qs(f),p=[];for(n=0;n<f.boneNames.length;n++){var _=f.boneNames[n],g=t[0].findByName(_);p.push(g)}d.bones=p,l.push(d)}return{skins:s,instances:l}},a._getMorphVertexCount=function(i,t,e){for(var n=0;n<i.meshes.length;n++){var r=i.meshes[n];if(r.morph===t)return e[r.vertices].numVertices}},a._parseMorphs=function(i,t,e){var n,r,s,l,u,c,h=i.model,f=[],d=[];if(h.morphs){var p=function(A,C,L){for(var I=new Float32Array(3*L),P=0;P<C.length;P++){var M=3*C[P];I[M]=A[3*P],I[M+1]=A[3*P+1],I[M+2]=A[3*P+2]}return I};for(n=0;n<h.morphs.length;n++){for(r=0,l=h.morphs[n].targets,c=[],s=this._getMorphVertexCount(h,n,e);r<l.length;r++){var _=l[r].aabb,g=_.min,y=_.max,v=new Se(new E((y[0]+g[0])*.5,(y[1]+g[1])*.5,(y[2]+g[2])*.5),new E((y[0]-g[0])*.5,(y[1]-g[1])*.5,(y[2]-g[2])*.5)),x=l[r].indices,S=l[r].deltaPositions,T=l[r].deltaNormals;x&&(S=p(S,x,s),T=p(T,x,s)),u=new ud({deltaPositions:S,deltaNormals:T,name:l[r].name,aabb:v}),c.push(u)}var b=new ku(c,this._device);f.push(b);var w=new na(b);d.push(w)}}return{morphs:f,instances:d}},a._parseVertexBuffers=function(i){for(var t=i.model,e=[],n={position:oe,normal:bt,tangent:hn,blendWeight:fn,blendIndices:Pt,color:st,texCoord0:mt,texCoord1:Hn,texCoord2:Dr,texCoord3:Mr,texCoord4:Rr,texCoord5:Or,texCoord6:kr,texCoord7:Nr},r=0;r<t.vertices.length;r++){var s=t.vertices[r],l=[];for(var u in s){var c=s[u];l.push({semantic:n[u],components:c.components,type:QM[c.type],normalize:n[u]===st})}for(var h=new Ot(this._device,l),f=s.position.data.length/s.position.components,d=new Rt(this._device,h,f),p=new js(d),_=0;_<f;_++){for(var g in s){var y=s[g];switch(y.components){case 1:p.element[n[g]].set(y.data[_]);break;case 2:p.element[n[g]].set(y.data[2*_],1-y.data[2*_+1]);break;case 3:p.element[n[g]].set(y.data[3*_],y.data[3*_+1],y.data[3*_+2]);break;case 4:p.element[n[g]].set(y.data[4*_],y.data[4*_+1],y.data[4*_+2],y.data[4*_+3])}}p.next()}p.end(),e.push(d)}return e},a._parseIndexBuffers=function(i,t){var e,n=i.model,r=null,s=null,l=0;for(e=0;e<n.meshes.length;e++){var u=n.meshes[e];u.indices!==void 0&&(l+=u.indices.length)}var c=0;for(e=0;e<t.length;e++)c=Math.max(c,t[e].numVertices);return l>0&&(s=c>65535?new Uint32Array((r=new Yn(this._device,2,l)).lock()):new Uint16Array((r=new Yn(this._device,1,l)).lock())),{buffer:r,data:s}},a._parseMeshes=function(i,t,e,n,r,s){for(var l=i.model,u=[],c=0,h=0;h<l.meshes.length;h++){var f=l.meshes[h],d=f.aabb,p=d.min,_=d.max,g=new Se(new E((_[0]+p[0])*.5,(_[1]+p[1])*.5,(_[2]+p[2])*.5),new E((_[0]-p[0])*.5,(_[1]-p[1])*.5,(_[2]-p[2])*.5)),y=f.indices!==void 0,v=new ye(this._device);v.vertexBuffer=n[f.vertices],v.indexBuffer[0]=y?r:null,v.primitive[0].type=ZM[f.type],v.primitive[0].base=y?f.base+c:f.base,v.primitive[0].count=f.count,v.primitive[0].indexed=y,v.skin=f.skin!==void 0?t[f.skin]:null,v.morph=f.morph!==void 0?e[f.morph]:null,v.aabb=g,y&&(s.set(f.indices,c),c+=f.indices.length),u.push(v)}return r!==null&&r.unlock(),u},a._parseMeshInstances=function(i,t,e,n,r,s,l){var u,c=i.model,h=[];for(u=0;u<c.meshInstances.length;u++){var f=c.meshInstances[u],d=t[f.node],p=e[f.mesh],_=new De(p,this._defaultMaterial,d);p.skin&&(_.skinInstance=r[n.indexOf(p.skin)]),p.morph&&(_.morphInstance=l[s.indexOf(p.morph)]),h.push(_)}return h},o}();function bE(o,a){return(bE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var TE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"model")||this)._parsers=[],e.device=t.graphicsDevice,e.assets=t.assets,e.defaultMaterial=Ks(e.device),e.addParser(new JM(e),function(n,r){return ce.getExtension(n)===".json"}),e.addParser(new KM(e),function(n,r){return ce.getExtension(n)===".glb"}),e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&bE(a,o);var i=a.prototype;return i.load=function(t,e,n){var r=this;typeof t=="string"&&(t={load:t,original:t});var s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(ce.getExtension(t.original).toLowerCase()===".glb"?s.responseType=Tt.ResponseType.ARRAY_BUFFER:s.responseType=Tt.ResponseType.JSON),Fe.get(t.load,s,function(l,u){if(e)if(l)e("Error loading model: "+t.original+" ["+l+"]");else{for(var c=0;c<r._parsers.length;c++){var h=r._parsers[c];if(h.decider(t.original,u))return void h.parser.parse(u,function(f,d){f?e(f):e(null,d)},n)}e("No parsers found")}})},i.open=function(t,e){return e},i.patch=function(t,e){if(t.resource){var n=t.data,r=this;t.resource.meshInstances.forEach(function(s,l){if(n.mapping){var u,c=function(p){p.resource?s.material=p.resource:(p.once("load",c),e.load(p)),p.once("remove",function(_){s.material===_.resource&&(s.material=r.defaultMaterial)})};if(!n.mapping[l]){s.material=r.defaultMaterial;return}var h=n.mapping[l].material,f=n.mapping[l].path;if(h!==void 0)h?(u=e.get(h))?c(u):e.once("add:"+h,c):s.material=r.defaultMaterial;else if(f){var d=t.getAbsoluteUrl(n.mapping[l].path);(u=e.getByUrl(d))?c(u):e.once("add:url:"+d,c)}}})}},i.addParser=function(t,e){this._parsers.push({parser:t,decider:e})},a}(Oe);function EE(o,a){return(EE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var wE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){return o.call(this,t,"scene")||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&EE(a,o);var i=a.prototype;return i.load=function(t,e){Ip.load(t,this.maxRetries,e)},i.open=function(t,e){this._app.systems.script.preloading=!0;var n=new Pp(this._app,!1).parse(e),r=this._app.scene;return r.root=n,this._app.applySceneSettings(e.settings),this._app.systems.script.preloading=!1,r},a}(Oe),Ia=function(){function o(){}return o.push=function(a){o._types.push(a)},o}();Ia._types=[];var Lp=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);function AE(o,a){if(Lp.has(o))throw Error("Script name '"+o+"' is reserved, please rename the script");var i=function(t){se.prototype.initEventHandler.call(this),zi.prototype.initScriptType.call(this,t)};return i.prototype=Object.create(zi.prototype),i.prototype.constructor=i,i.extend=zi.extend,i.attributes=new yr(i),Dp(i,o,a),i}var CE={};function Dp(o,a,i){var t;if(typeof o!="function")throw Error("script class: '"+o+"' must be a constructor function (i.e. class).");if(t=o.prototype,ot!=null&&typeof Symbol<"u"&&ot[Symbol.hasInstance]?!ot[Symbol.hasInstance](t):!Q(t,ot))throw Error("script class: '"+zi.__getScriptName(o)+"' does not extend pc.Script.");if(a=a||o.__name||zi.__getScriptName(o),Lp.has(a))throw Error("script name: '"+a+"' is reserved, please change script name");o.__name=a,(i?i.scripts:Pn.getApplication().scripts).add(o),Ia.push(o)}function PE(o,a){return(PE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}yr.reservedNames.forEach(function(o,a,i){CE[o]=1}),AE.reservedAttributes=CE;var IE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"script")||this)._scripts={},e._cache={},e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&PE(a,o);var i=a.prototype;return i.clearCache=function(){for(var t in this._cache){var e=this._cache[t],n=e.parentNode;n&&n.removeChild(e)}this._cache={}},i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n=this;Id.app=this._app;var r=(t.load,function(l,u,c){if(l)e(l);else{for(var h={},f=0;f<Ia._types.length;f++)h[Ia._types[f].name]=Ia._types[f];Ia._types.length=0,e(null,h,c);var d=u.split("&hash=")[0];delete n._loader._cache[Dd.makeKey(d,"script")]}}),s=t.load.split("?")[0];s.endsWith(".mjs")?this._loadModule(s,r):this._loadScript(t.load,r)},i.open=function(t,e){return e},i.patch=function(t,e){},i._loadScript=function(t,e){var n=document.head,r=document.createElement("script");this._cache[t]=r,r.async=!1,r.addEventListener("error",function(l){e("Script: "+l.target.src+" failed to load")},!1);var s=!1;r.onload=r.onreadystatechange=function(){s||this.readyState&&this.readyState!=="loaded"&&this.readyState!=="complete"||(s=!0,e(null,t,r))},r.src=t,n.appendChild(r)},i._loadModule=function(t,e){var n=this,r=fe.browser&&window.location.origin!=="null"?window.location.origin+window.location.pathname:typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:Ih&&Ih.tagName.toUpperCase()==="SCRIPT"&&Ih.src||new URL("playcanvas.js",document.baseURI).href,s=new URL(t,r);Function("modulePath","return import(modulePath)")(s.toString()).then(function(l){var u=s.pathname.split("/").pop(),c=(g=n._app.assets.find(u,"script"))==null||(_=g.data)==null?void 0:_.scripts;for(var h in l){var f=l[h];if(d=f.prototype,ot!=null&&typeof Symbol<"u"&&ot[Symbol.hasInstance]?!!ot[Symbol.hasInstance](d):Q(d,ot)){var d,p,_,g,y,v=(p=f.name)[0].toLowerCase()+p.substring(1);f.scriptName;var x=(y=f.scriptName)!=null?y:v;Dp(f,x),c&&n._app.scripts.addSchema(x,c[x])}}e(null,t,null)}).catch(function(l){e(l)})},a}(Oe);function LE(o,a){return(LE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var DE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"shader")||this).decoder=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&LE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e("Error loading shader resource: "+t.original+" ["+n+"]"):e(null,r)})},i.openBinary=function(t){return this.decoder!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(t)},a}(Oe);function ME(o,a){return(ME=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Mp(o){this.resource&&(this.resource.atlas=o.resource)}function Rp(o){this.registry.load(o)}var RE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"sprite")||this)._assets=t.assets,e._device=t.graphicsDevice,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ME(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),ce.getExtension(t.original)===".json"&&Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e(n):e(null,r)})},i.open=function(t,e){var n=new Ky(this._device);return t&&(n.__data=e),n},i.patch=function(t,e){var n=t.resource;if(n.__data&&(t.data.pixelsPerUnit=n.__data.pixelsPerUnit,t.data.renderMode=n.__data.renderMode,t.data.frameKeys=n.__data.frameKeys,n.__data.textureAtlasAsset)){var r=e.getByUrl(n.__data.textureAtlasAsset);r&&(t.data.textureAtlasAsset=r.id)}n.startUpdate(),n.renderMode=t.data.renderMode,n.pixelsPerUnit=t.data.pixelsPerUnit,n.frameKeys=t.data.frameKeys,this._updateAtlas(t),n.endUpdate(),t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)},i._updateAtlas=function(t){var e=t.resource;if(!t.data.textureAtlasAsset){e.atlas=null;return}this._assets.off("load:"+t.data.textureAtlasAsset,Mp,t),this._assets.on("load:"+t.data.textureAtlasAsset,Mp,t);var n=this._assets.get(t.data.textureAtlasAsset);n&&n.resource?e.atlas=n.resource:n?this._assets.load(n):(this._assets.off("add:"+t.data.textureAtlasAsset,Rp,t),this._assets.on("add:"+t.data.textureAtlasAsset,Rp,t))},i._onAssetChange=function(t,e,n,r){e==="data"&&n&&n.textureAtlasAsset&&r&&n.textureAtlasAsset!==r.textureAtlasAsset&&(this._assets.off("load:"+r.textureAtlasAsset,Mp,t),this._assets.off("add:"+r.textureAtlasAsset,Rp,t))},a}(Oe),Op=function(){function o(i,t){this._templateRoot=null,this._app=i,this._data=t}var a=o.prototype;return a.instantiate=function(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()},a._parseTemplate=function(){var i=new Pp(this._app,!0);this._templateRoot=i.parse(this._data)},o}();function OE(o,a){return(OE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var kE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"template")||this).decoder=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&OE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n={retry:this.maxRetries>0,maxRetries:this.maxRetries};Fe.get(t.load,n,function(r,s){r?e("Error requesting template: "+t.original):e(r,s)})},i.open=function(t,e){return new Op(this._app,e)},i.openBinary=function(t){return this.decoder!=null||(this.decoder=new TextDecoder("utf-8")),new Op(this._app,JSON.parse(this.decoder.decode(t)))},a}(Oe);function NE(o,a){return(NE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var FE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"text")||this).decoder=null,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&NE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t}),Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){n?e("Error loading text resource: "+t.original+" ["+n+"]"):e(null,r)})},i.openBinary=function(t){return this.decoder!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(t)},a}(Oe);function UE(o,a){return(UE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Oc={repeat:0,clamp:1,mirror:2},kc={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},$M=/^data\.frames\.(\d+)$/,BE=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this,t,"textureatlas")||this)._loader=t.loader,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&UE(a,o);var i=a.prototype;return i.load=function(t,e){typeof t=="string"&&(t={load:t,original:t});var n=this,r=this._loader.getHandler("texture");ce.getExtension(t.original)===".json"?Fe.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,l){if(s)e(s);else{var u=t.original.replace(".json",".png");n._loader.load(u,"texture",function(c,h){c?e(c):e(null,{data:l,texture:h})})}}):r.load(t,e)},i.open=function(t,e,n){var r=new Qy;if(e.texture&&e.data)r.texture=e.texture,r.__data=e.data;else{var s=this._loader.getHandler("texture").open(t,e,n);if(!s)return null;r.texture=s}return r},i.patch=function(t,e){if(t.resource){t.resource.__data&&(t.resource.__data.minfilter!==void 0&&(t.data.minfilter=t.resource.__data.minfilter),t.resource.__data.magfilter!==void 0&&(t.data.magfilter=t.resource.__data.magfilter),t.resource.__data.addressu!==void 0&&(t.data.addressu=t.resource.__data.addressu),t.resource.__data.addressv!==void 0&&(t.data.addressv=t.resource.__data.addressv),t.resource.__data.mipmaps!==void 0&&(t.data.mipmaps=t.resource.__data.mipmaps),t.resource.__data.anisotropy!==void 0&&(t.data.anisotropy=t.resource.__data.anisotropy),t.resource.__data.rgbm!==void 0&&(t.data.rgbm=!!t.resource.__data.rgbm),t.data.frames=t.resource.__data.frames,delete t.resource.__data);var n=t.resource.texture;if(n&&(n.name=t.name,t.data.hasOwnProperty("minfilter")&&n.minFilter!==kc[t.data.minfilter]&&(n.minFilter=kc[t.data.minfilter]),t.data.hasOwnProperty("magfilter")&&n.magFilter!==kc[t.data.magfilter]&&(n.magFilter=kc[t.data.magfilter]),t.data.hasOwnProperty("addressu")&&n.addressU!==Oc[t.data.addressu]&&(n.addressU=Oc[t.data.addressu]),t.data.hasOwnProperty("addressv")&&n.addressV!==Oc[t.data.addressv]&&(n.addressV=Oc[t.data.addressv]),t.data.hasOwnProperty("mipmaps")&&n.mipmaps!==t.data.mipmaps&&(n.mipmaps=t.data.mipmaps),t.data.hasOwnProperty("anisotropy")&&n.anisotropy!==t.data.anisotropy&&(n.anisotropy=t.data.anisotropy),t.data.hasOwnProperty("rgbm"))){var r=t.data.rgbm?Wn:Wt;n.type!==r&&(n.type=r)}t.resource.texture=n;var s={};for(var l in t.data.frames){var u=t.data.frames[l];s[l]={rect:new q(u.rect),pivot:new G(u.pivot),border:new q(u.border)}}t.resource.frames=s,t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}},i._onAssetChange=function(t,e,n){var r;if(e==="data"||e==="data.frames"){var s={};for(var l in n.frames)r=n.frames[l],s[l]={rect:new q(r.rect),pivot:new G(r.pivot),border:new q(r.border)};t.resource.frames=s}else{var u=e.match($M);if(u){var c=u[1];n?(t.resource.frames[c]?((r=t.resource.frames[c]).rect.set(n.rect[0],n.rect[1],n.rect[2],n.rect[3]),r.pivot.set(n.pivot[0],n.pivot[1]),r.border.set(n.border[0],n.border[1],n.border[2],n.border[3])):t.resource.frames[c]={rect:new q(n.rect),pivot:new G(n.pivot),border:new q(n.border)},t.resource.fire("set:frame",c,t.resource.frames[c])):t.resource.frames[c]&&(delete t.resource.frames[c],t.resource.fire("remove:frame",c))}}},a}(Oe);function eR(){var o,a,i,t={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},e={astc:t.cTFASTC_4x4,dxt:t.cTFBC1,etc1:t.cTFETC1,etc2:t.cTFETC1,pvr:t.cTFPVRTC1_4_RGB,atc:t.cTFATC_RGB,none:t.cTFRGB565},n={astc:t.cTFASTC_4x4,dxt:t.cTFBC3,etc1:t.cTFRGBA4444,etc2:t.cTFETC2,pvr:t.cTFPVRTC1_4_RGBA,atc:t.cTFATC_RGBA_INTERPOLATED_ALPHA,none:t.cTFRGBA4444},r={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},s=function(v,x){switch(v){case t.cTFETC1:return x.formats.etc2?r.ETC2_RGB:r.ETC1;case t.cTFETC2:return r.ETC2_RGBA;case t.cTFBC1:return r.DXT1;case t.cTFBC3:return r.DXT5;case t.cTFPVRTC1_4_RGB:return r.PVRTC_4BPP_RGB_1;case t.cTFPVRTC1_4_RGBA:return r.PVRTC_4BPP_RGBA_1;case t.cTFASTC_4x4:return r.ASTC_4x4;case t.cTFATC_RGB:return r.ATC_RGB;case t.cTFATC_RGBA_INTERPOLATED_ALPHA:return r.ATC_RGBA;case t.cTFRGBA32:return r.R8_G8_B8_A8;case t.cTFRGB565:return r.R5_G6_B5;case t.cTFRGBA4444:return r.R4_G4_B4_A4}},l=function(v){for(var x=0;x<v.length;x+=4){var S=v[x+3],T=v[x+1];v[x+0]=S,v[x+2]=function(b,w){var A=.00784313725490196*b-1,C=2/255*w-1;return Math.max(0,Math.min(255,Math.floor((Math.sqrt(1-Math.min(1,A*A+C*C))+1)*127.5)))}(S,T),v[x+3]=255}return v},u=function(v){for(var x=new Uint16Array(v.length/4),S=0;S<v.length;S+=4){var T=v[S+0],b=v[S+1],w=v[S+2];x[S/4]=(248&T)<<8|(252&b)<<3|w>>3}return x},c=function(){return typeof performance<"u"?performance.now():0},h=function(v,x,S){if(S){if(v.formats.astc)return"astc"}else if(x){if(v.formats.etc2)return"etc2"}else{if(v.formats.etc2)return"etc2";if(v.formats.etc1)return"etc1"}for(var T=x?i:a,b=0;b<T.length;++b){var w=T[b];if(v.formats[w])return w}return"none"},f=function(v,x,S){switch(S){case t.cTFETC1:case t.cTFETC2:return!0;case t.cTFBC1:case t.cTFBC3:return(3&v)==0&&(3&x)==0;case t.cTFPVRTC1_4_RGB:case t.cTFPVRTC1_4_RGBA:return(v&v-1)==0&&(x&x-1)==0;case t.cTFASTC_4x4:case t.cTFATC_RGB:case t.cTFATC_RGBA_INTERPOLATED_ALPHA:return!0}return!1},d=function(v,x,S){if(!o.KTX2File)throw Error("Basis transcoder module does not include support for KTX2.");var T,b,w=c(),A=new o.KTX2File(new Uint8Array(x)),C=A.getWidth(),L=A.getHeight(),I=A.getLevels(),P=!!A.getHasAlpha(),M=A.isUASTC&&A.isUASTC();if(!C||!L||!I)throw A.close(),A.delete(),Error("Invalid image dimensions url="+v+" width="+C+" height="+L+" levels="+I);var R=h(S.deviceDetails,P,M),k=!!S.isGGGR&&R==="pvr";if(k?T=t.cTFRGBA32:f(C,L,T=P?n[R]:e[R])||(T=P?t.cTFRGBA32:t.cTFRGB565),!A.startTranscoding())throw A.close(),A.delete(),Error("Failed to start transcoding url="+v);for(var D=[],O=0;O<I;++O){var F=new Uint8Array(A.getImageTranscodedSizeInBytes(O,0,0,T));if(!A.transcodeImage(F,O,0,0,T,0,-1,-1))throw A.close(),A.delete(),Error("Failed to transcode image url="+v);var N=T===t.cTFRGB565||T===t.cTFRGBA4444;D.push(N?new Uint16Array(F.buffer):F)}if(A.close(),A.delete(),k)for(b=0,T=t.cTFRGB565;b<D.length;++b)D[b]=u(l(D[b]));return{format:s(T,S.deviceDetails),width:C,height:L,levels:D,cubemap:!1,transcodeTime:c()-w,url:v,unswizzledGGGR:k}},p=function(v,x,S){var T,b,w=c(),A=new o.BasisFile(new Uint8Array(x)),C=A.getImageWidth(0,0),L=A.getImageHeight(0,0),I=A.getNumImages(),P=A.getNumLevels(0),M=!!A.getHasAlpha(),R=A.isUASTC&&A.isUASTC();if(!C||!L||!I||!P)throw A.close(),A.delete(),Error("Invalid image dimensions url="+v+" width="+C+" height="+L+" images="+I+" levels="+P);var k=h(S.deviceDetails,M,R),D=!!S.isGGGR&&k==="pvr";if(D?T=t.cTFRGBA32:f(C,L,T=M?n[k]:e[k])||(T=M?t.cTFRGBA32:t.cTFRGB565),!A.startTranscoding())throw A.close(),A.delete(),Error("Failed to start transcoding url="+v);for(var O=[],F=0;F<P;++F){var N=A.getImageTranscodedSizeInBytes(0,F,T),j=new Uint8Array(N);if(!A.transcodeImage(j,0,F,T,0,0))if(F===P-1&&N===O[F-1].buffer.byteLength)j.set(new Uint8Array(O[F-1].buffer));else throw A.close(),A.delete(),Error("Failed to transcode image url="+v);var z=T===t.cTFRGB565||T===t.cTFRGBA4444;O.push(z?new Uint16Array(j.buffer):j)}if(A.close(),A.delete(),D)for(b=0,T=t.cTFRGB565;b<O.length;++b)O[b]=u(l(O[b]));return{format:s(T,S.deviceDetails),width:C,height:L,levels:O,cubemap:!1,transcodeTime:c()-w,url:v,unswizzledGGGR:D}},_=function(v,x,S){try{var T=S.isKTX2?d(v,x,S):p(v,x,S);T.levels=T.levels.map(function(b){return b.buffer}),self.postMessage({url:v,data:T},T.levels)}catch(b){self.postMessage({url:v,err:b},null)}},g=function(v,x){self.BASIS(v.module?{instantiateWasm:function(S,T){return WebAssembly.instantiate(v.module,S).then(function(b){T(b)}).catch(function(b){}),{}}}:null).then(function(S){S.initializeBasis(),o=S,a=v.rgbPriority,i=v.rgbaPriority,x(null)})},y=[];self.onmessage=function(v){var x=v.data;switch(x.type){case"init":g(x.config,function(){for(var S=0;S<y.length;++S)_(y[S].url,y[S].data,y[S].options);y.length=0});break;case"transcode":o?_(x.url,x.data,x.options):y.push(x)}}}function kp(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var tR=function(o,a){var i=function(l,u){a(null,{workerUrl:URL.createObjectURL(new Blob([["/* basis */",l,"","("+eR.toString()+`)()

`].join(`
`)],{type:"application/javascript"})),module:u,rgbPriority:o.rgbPriority,rgbaPriority:o.rgbaPriority})},t={cache:!0,responseType:"text",retry:o.maxRetries>0,maxRetries:o.maxRetries};if(o.glueUrl&&o.wasmUrl&&function(){try{var l;if((typeof WebAssembly>"u"?"undefined":(l=WebAssembly)&&typeof Symbol<"u"&&l.constructor===Symbol?"symbol":typeof l)=="object"&&typeof WebAssembly.instantiate=="function"){var u=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(kp(u,WebAssembly.Module))return kp(new WebAssembly.Instance(u),WebAssembly.Instance)}}catch{}return!1}()){var e=null,n=null;Fe.get(o.glueUrl,t,function(l,u){l?a(l):n?i(u,n):e=u});var r=fetch(o.wasmUrl),s=function(){r.then(function(l){return l.arrayBuffer()}).then(function(l){return WebAssembly.compile(l)}).then(function(l){e?i(e,l):n=l}).catch(function(l){a(l,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(r).then(function(l){e?i(e,l):n=l}).catch(function(l){s()}):s()}else Fe.get(o.fallbackUrl,t,function(l,u){l?a(l,null):i(u,null)})},nR=function(){function o(){this.callbacks={},this.queue=[],this.clients=[]}var a=o.prototype;return a.enqueueJob=function(i,t,e,n){if(this.callbacks.hasOwnProperty(i))this.callbacks[i].push(e);else{this.callbacks[i]=[e];var r={url:i,data:t,options:n};this.clients.length>0?this.clients.shift().run(r):this.queue.push(r)}},a.enqueueClient=function(i){this.queue.length>0?i.run(this.queue.shift()):this.clients.push(i)},a.handleResponse=function(i,t,e){var n=this.callbacks[i];if(t)for(var r=0;r<n.length;++r)n[r](t);else{e.format===3||e.format===5?e.levels=e.levels.map(function(l){return new Uint16Array(l)}):e.levels=e.levels.map(function(l){return new Uint8Array(l)});for(var s=0;s<n.length;++s)n[s](null,e)}delete this.callbacks[i]},o}(),iR=function(){function o(a,i,t){var e=this;this.queue=a,this.worker=new Worker(i.workerUrl),this.worker.addEventListener("message",function(n){var r=n.data;e.queue.handleResponse(r.url,r.err,r.data),e.eager||e.queue.enqueueClient(e)}),this.worker.postMessage({type:"init",config:i}),this.eager=t}return o.prototype.run=function(a){var i=[];kp(a.data,ArrayBuffer)&&i.push(a.data),this.worker.postMessage({type:"transcode",url:a.url,format:a.format,data:a.data,options:a.options},i),this.eager&&this.queue.enqueueClient(this)},o}(),rR=["etc2","etc1","astc","dxt","pvr","atc"],sR=["astc","dxt","etc2","pvr","atc"],Np=new nR,VE=null,Fp=!1;function zE(o){if(!Fp){if(o){if(o.lazyInit){VE=o;return}}else o=VE||{};if(!o.glueUrl||!o.wasmUrl||!o.fallbackUrl){var a=Rh.getConfig("BASIS");a&&(o={glueUrl:a.glueUrl,wasmUrl:a.wasmUrl,fallbackUrl:a.fallbackUrl,numWorkers:a.numWorkers})}if(o.glueUrl||o.wasmUrl||o.fallbackUrl){Fp=!0;var i=Math.max(1,Math.min(16,o.numWorkers||1)),t=o.numWorkers===1||!o.hasOwnProperty("eagerWorkers")||o.eagerWorkers;o.rgbPriority=o.rgbPriority||rR,o.rgbaPriority=o.rgbaPriority||sR,o.maxRetries=o.hasOwnProperty("maxRetries")?o.maxRetries:5,tR(o,function(e,n){if(!e)for(var r=0;r<i;++r)Np.enqueueClient(new iR(Np,n,t))})}}}var Up=null;function GE(o,a,i,t,e){return zE(),Up||(Up={formats:{astc:!!o.extCompressedTextureASTC,atc:!!o.extCompressedTextureATC,dxt:!!o.extCompressedTextureS3TC,etc1:!!o.extCompressedTextureETC1,etc2:!!o.extCompressedTextureETC,pvr:!!o.extCompressedTexturePVRTC}}),Np.enqueueJob(a,i,t,{deviceDetails:Up,isGGGR:!!(e!=null&&e.isGGGR),isKTX2:!!(e!=null&&e.isKTX2)}),Fp}var La=function(){function o(){}var a=o.prototype;return a.load=function(i,t,e){throw Error("not implemented")},a.open=function(i,t,e){throw Error("not implemented")},o}();function HE(){return(HE=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function WE(o,a){return(WE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var aR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this)||this).device=e,n.maxRetries=0,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&WE(a,o);var i=a.prototype;return i.load=function(t,e,n){var r=this.device,s=function(l){var u,c,h;GE(r,t.load,l,e,{isGGGR:((n==null||(h=n.file)==null||(c=h.variants)==null||(u=c.basis)==null?void 0:u.opt)&8)!=0})||e("Basis module not found. Asset ["+n.name+"]("+n.getFileUrl()+") basis texture variant will not be loaded.")};$.fetchArrayBuffer(t.load,function(l,u){l?e(l):s(u)},n,this.maxRetries)},i.open=function(t,e,n,r){r===void 0&&(r={});var s=r.srgb?so(e.format):e.format,l=new ee(n,HE({name:t,addressU:+!!e.cubemap,addressV:+!!e.cubemap,width:e.width,height:e.height,format:s,cubemap:e.cubemap,levels:e.levels},r));return l.upload(),l},a}(La);function jE(){return(jE=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function XE(o,a){return(XE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var oR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this)||this).crossOrigin=t.prefix?"anonymous":null,n.maxRetries=0,n.device=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&XE(a,o);var i=a.prototype;return i.load=function(t,e,n){var r,s,l=!!(!(n==null||(r=n.file)==null)&&r.contents);if(l){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([n.file.contents]),e);t={load:URL.createObjectURL(new Blob([n.file.contents])),original:t.original}}var u=function(c,h){l&&URL.revokeObjectURL(t.load),e(c,h)};n&&n.options&&n.options.hasOwnProperty("crossOrigin")?s=n.options.crossOrigin:Qr.test(t.load)&&(s=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(t.load,t.original,s,u):this._loadImage(t.load,t.original,s,u)},i.open=function(t,e,n,r){r===void 0&&(r={});var s=new ee(n,jE({name:t,width:e.width,height:e.height,format:r.srgb?20:7},r));return s.setSource(e),s},i._loadImage=function(t,e,n,r){var s,l=new Image;n&&(l.crossOrigin=n);var u=0,c=this.maxRetries;l.onload=function(){r(null,l)},l.onerror=function(){if(!s)if(c>0&&++u<=c){var h=100*Math.pow(2,u),f=t.indexOf("?")>=0?"&":"?";s=setTimeout(function(){l.src=t+f+"retry="+Date.now(),s=null},h)}else r("Error loading Texture from: '"+e+"'")},l.src=t},i._loadImageBitmap=function(t,e,n,r){var s=this,l={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Fe.get(t,l,function(u,c){u?r(u):s._loadImageBitmapFromBlob(c,r)})},i._loadImageBitmapFromBlob=function(t,e){createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(function(n){return e(null,n)}).catch(function(n){return e(n)})},a}(La);function YE(){return(YE=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function qE(o,a){return(qE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var lR={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12},uR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this).maxRetries=0,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&qE(a,o);var i=a.prototype;return i.load=function(t,e,n){$.fetchArrayBuffer(t.load,e,n,this.maxRetries)},i.open=function(t,e,n,r){r===void 0&&(r={});var s=this.parse(e);if(!s)return null;var l=r.srgb?so(s.format):s.format,u=new ee(n,YE({name:t,addressU:+!!s.cubemap,addressV:+!!s.cubemap,width:s.width,height:s.height,format:l,cubemap:s.cubemap,levels:s.levels},r));return u.upload(),u},i.parse=function(t){var e=new Uint32Array(t);if(e[0]!==1481919403||e[1]!==3140563232||e[2]!==169478669)return null;var n={endianness:e[3],glType:e[4],glTypeSize:e[5],glFormat:e[6],glInternalFormat:e[7],glBaseInternalFormat:e[8],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(n.pixelDepth>1||n.numberOfArrayElements!==0)return null;var r=lR[n.glInternalFormat];if(r===void 0)return null;for(var s=16+n.bytesOfKeyValueData/4,l=n.numberOfFaces>1,u=[],c=0;c<(n.numberOfMipmapLevels||1);c++){var h,f=e[s++];l&&u.push([]);for(var d=l?u[c]:u,p=0;p<(l?6:1);++p)d.push((h=4*s,r===18?new Uint32Array(t,h,f/4):new Uint8Array(t,h,f))),s+=f+3>>2}return{format:r,width:n.pixelWidth,height:n.pixelHeight,levels:u,cubemap:l}},a}(La);function KE(){return(KE=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function ZE(o,a){return(ZE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var cR={KHR_DF_MODEL_UASTC:166},hR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this)||this).maxRetries=0,n.device=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ZE(a,o);var i=a.prototype;return i.load=function(t,e,n){var r=this;$.fetchArrayBuffer(t.load,function(s,l){s?e(s,l):r.parse(l,t,e,n)},n,this.maxRetries)},i.open=function(t,e,n,r){r===void 0&&(r={});var s=r.srgb?so(e.format):e.format,l=new ee(n,KE({name:t,addressU:+!!e.cubemap,addressV:+!!e.cubemap,width:e.width,height:e.height,format:s,cubemap:e.cubemap,levels:e.levels},r));return l.upload(),l},i.parse=function(t,e,n,r){var s,l,u,c=new Oh(t),h=[c.readU32be(),c.readU32be(),c.readU32be()];if(h[0]!==2873840728||h[1]!==540160187||h[2]!==218765834)return null;for(var f={vkFormat:c.readU32(),typeSize:c.readU32(),pixelWidth:c.readU32(),pixelHeight:c.readU32(),pixelDepth:c.readU32(),layerCount:c.readU32(),faceCount:c.readU32(),levelCount:c.readU32(),supercompressionScheme:c.readU32()},d={dfdByteOffset:c.readU32(),dfdByteLength:c.readU32(),kvdByteOffset:c.readU32(),kvdByteLength:c.readU32(),sgdByteOffset:c.readU64(),sgdByteLength:c.readU64()},p=[],_=0;_<Math.max(1,f.levelCount);++_)p.push({byteOffset:c.readU64(),byteLength:c.readU64(),uncompressedByteLength:c.readU64()});if(c.readU32()!==d.kvdByteOffset-d.dfdByteOffset)return null;c.skip(8);var g=c.readU8();c.skip(d.dfdByteLength-9),c.skip(d.kvdByteLength),f.supercompressionScheme===1||g===cR.KHR_DF_MODEL_UASTC?GE(this.device,e.load,t,n,{isGGGR:((r==null||(u=r.file)==null||(l=u.variants)==null||(s=l.basis)==null?void 0:s.opt)&8)!=0,isKTX2:!0})||n("Basis module not found. Asset ["+r.name+"]("+r.getFileUrl()+") basis texture variant will not be loaded."):n("unsupported KTX2 pixel format")},a}(La);function QE(){return(QE=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function JE(o,a){return(JE=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var fR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this).maxRetries=0,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&JE(a,o);var i=a.prototype;return i.load=function(t,e,n){$.fetchArrayBuffer(t.load,e,n,this.maxRetries)},i.open=function(t,e,n,r){r===void 0&&(r={});var s,l,u=new Uint32Array(e,0,32),c=u[4],h=u[3],f=Math.max(u[7],1),d=u[20]===4,p=u[21],_=u[22],g=u[28]===65024,y=!1,v=!1,x=!1,S=!1,T=null,b=1;if(d?p===827611204?(T=8,y=!0):p===894720068?(T=10,y=!0):p===113?(T=12,b=2):p===116?(T=14,b=4):p===826496069?(T=21,y=!0,v=!0):p===825438800||p===825504336?(T=p===825438800?24:25,y=!0,x=!0):(p===825439312||p===825504848)&&(T=p===825439312?26:27,y=!0,S=!0):_===32&&(T=7),!T)return new ee(n,{width:4,height:4,format:6,name:"dds-legacy-empty"});s=new ee(n,QE({name:t,addressU:+!!g,addressV:+!!g,width:c,height:h,format:T,cubemap:g,mipmaps:f>1},r));for(var w=128,A=g?6:1,C=p===827611204?8:16,L=0;L<A;L++)for(var I=c,P=h,M=0;M<f;M++){l=y?v?Math.floor((I+3)/4)*Math.floor((P+3)/4)*8:x?Math.max(I,16)*Math.max(P,8)/4:S?Math.max(I,8)*Math.max(P,8)/2:Math.floor((I+4-1)/4)*Math.floor((P+4-1)/4)*C:I*P*4;var R=T===14?new Float32Array(e,w,l):T===12?new Uint16Array(e,w,l):new Uint8Array(e,w,l);g?(s._levels[M]||(s._levels[M]=[]),s._levels[M][L]=R):s._levels[M]=R,w+=l*b,I=Math.max(.5*I,1),P=Math.max(.5*P,1)}return s.upload(),s},a}(La);function $E(){return($E=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(o[t]=i[t])}return o}).apply(this,arguments)}function ew(o,a){return(ew=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var dR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){var e;return(e=o.call(this)||this).maxRetries=0,e}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ew(a,o);var i=a.prototype;return i.load=function(t,e,n){$.fetchArrayBuffer(t.load,e,n,this.maxRetries),n.data&&!n.data.type&&(n.data.type=ao)},i.open=function(t,e,n,r){r===void 0&&(r={});var s=this.parse(e);if(!s)return null;var l=new ee(n,$E({name:t,addressU:0,addressV:1,minFilter:0,magFilter:0,width:s.width,height:s.height,levels:s.levels,format:7,type:ao,mipmaps:!1},r));return l.upload(),l},i.parse=function(t){var e=new Oh(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;for(var n={};;){var r=e.readLine();if(r.length===0)break;var s=r.split("=");s.length===2&&(n[s[0]]=s[1])}if(!n.hasOwnProperty("FORMAT"))return null;var l=e.readLine().split(" ");if(l.length!==4)return null;var u=parseInt(l[1],10),c=parseInt(l[3],10),h=this._readPixels(e,c,u,l[0]==="-Y");return h?{width:c,height:u,levels:[h]}:null},i._readPixels=function(t,e,n,r){if(e<8||e>32767)return this._readPixelsFlat(t,e,n);var s,l,u,c,h,f,d=[0,0,0,0];if(t.readArray(d),d[0]!==2||d[1]!==2||(128&d[2])!=0)return t.skip(-4),this._readPixelsFlat(t,e,n);var p=new Uint8Array(new ArrayBuffer(e*n*4)),_=r?0:4*e*(n-1);for(l=0;l<n;++l){if(l&&t.readArray(d),(d[2]<<8)+d[3]!==e)return null;for(c=0;c<4;++c)for(s=0;s<e;)if((h=t.readU8())>128){if(s+(h-=128)>e)return null;for(u=0,f=t.readU8();u<h;++u)p[_+c+4*s++]=f}else{if(h===0||s+h>e)return null;for(u=0;u<h;++u)p[_+c+4*s++]=t.readU8()}_+=4*e*(r?1:-1)}return p},i._readPixelsFlat=function(t,e,n){return t.remainingBytes===e*n*4?new Uint8Array(t.arraybuffer,t.offset):null},a}(La);function tw(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Bp(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function nw(o,a){return(nw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var iw={repeat:0,clamp:1,mirror:2},rw={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},pR={default:Wt,rgbm:Wn,rgbe:ao,rgbp:Os,swizzleGGGR:ks},mR=function(o){var a,i=En.calcMipLevelsCount(o._width,o._height);if(!(o._format!==7&&o._format!==14||o._volume||o._compressed||o._levels.length===1||o._levels.length===i||Bp(a=o._cubemap?o._levels[0][0]:o._levels[0],HTMLCanvasElement)||Bp(a,HTMLImageElement)||Bp(a,HTMLVideoElement))){for(var t=function(u,c,h){for(var f=Math.max(1,u>>1),d=Math.max(1,c>>1),p=new h.constructor(f*d*4),_=Math.floor(u/f),g=Math.floor(c/d),y=_*g,v=0;v<d;++v)for(var x=0;x<f;++x)for(var S=0;S<4;++S){for(var T=0,b=0;b<g;++b)for(var w=0;w<_;++w)T+=h[(x*_+w+(v*g+b)*u)*4+S];p[(x+v*f)*4+S]=T/y}return p},e=o._levels.length;e<i;++e){var n=Math.max(1,o._width>>e-1),r=Math.max(1,o._height>>e-1);if(o._cubemap){for(var s=[],l=0;l<6;++l)s.push(t(n,r,o._levels[e-1][l]));o._levels.push(s)}else o._levels.push(t(n,r,o._levels[e-1]))}o._levelsUpdated=o._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}},sw=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n=o.call(this,e,"texture")||this,r=e.assets,s=e.graphicsDevice;return n._device=s,n._assets=r,n.imgParser=new oR(r,s),n.parsers={dds:new fR(r),ktx:new uR(r),ktx2:new hR(r,s),basis:new aR(r,s),hdr:new dR(r)},n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&nw(a,o);var i,t=a.prototype;return t._getUrlWithoutParams=function(e){return e.indexOf("?")>=0?e.split("?")[0]:e},t._getParser=function(e){var n=ce.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[n]||this.imgParser},t._getTextureOptions=function(e){var n={};if(e){((r=e.name)==null?void 0:r.length)>0&&(n.name=e.name);var r,s=e.data;s.hasOwnProperty("minfilter")&&(n.minFilter=rw[s.minfilter]),s.hasOwnProperty("magfilter")&&(n.magFilter=rw[s.magfilter]),s.hasOwnProperty("addressu")&&(n.addressU=iw[s.addressu]),s.hasOwnProperty("addressv")&&(n.addressV=iw[s.addressv]),s.hasOwnProperty("mipmaps")&&(n.mipmaps=s.mipmaps),s.hasOwnProperty("anisotropy")&&(n.anisotropy=s.anisotropy),s.hasOwnProperty("flipY")&&(n.flipY=!!s.flipY),s.hasOwnProperty("srgb")&&(n.srgb=!!s.srgb),n.type=Wt,s.hasOwnProperty("type")?n.type=pR[s.type]:s.hasOwnProperty("rgbm")&&s.rgbm?n.type=Wn:e.file&&8&e.file.opt&&(n.type=ks)}return n},t.load=function(e,n,r){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,n,r)},t.open=function(e,n,r){if(e){var s=this._getTextureOptions(r),l=this._getParser(e).open(e,n,this._device,s);return l===null?l=new ee(this._device,{width:4,height:4,format:6}):(mR(l),n.unswizzledGGGR&&(r.file.variants.basis.opt&=-9)),l}},t.patch=function(e,n){var r=e.resource;if(r)for(var s,l=this._getTextureOptions(e),u=function(h,f){var d=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(d)return(d=d.call(h)).next.bind(d);if(Array.isArray(h)||(d=function(_,g){if(_){if(typeof _=="string")return tw(_,void 0);var y=Object.prototype.toString.call(_).slice(8,-1);if(y==="Object"&&_.constructor&&(y=_.constructor.name),y==="Map"||y==="Set")return Array.from(y);if(y==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(y))return tw(_,void 0)}}(h))){d&&(h=d);var p=0;return function(){return p>=h.length?{done:!0}:{done:!1,value:h[p++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Object.keys(l));!(s=u()).done;){var c=s.value;r[c]=l[c]}},i=[{key:"crossOrigin",get:function(){return this.imgParser.crossOrigin},set:function(e){this.imgParser.crossOrigin=e}},{key:"maxRetries",get:function(){return this.imgParser.maxRetries},set:function(e){for(var n in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(n)&&(this.parsers[n].maxRetries=e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Oe),aw="inline",ow="immersive-vr",Da="immersive-ar",Vp="viewer",lw="left",uw="cpu-optimized",zp="gpu-optimized",Gp="luminance-alpha",Hp="unsigned-short",Wp="float32",cw=function(){var o;function a(i){this._supported=fe.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=i}return o=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}},{key:"state",get:function(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}},{key:"root",get:function(){return this._root},set:function(i){this._supported&&!this._manager.active&&(this._root=i)}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}();function hw(o,a){return(hw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Nc=[],fw=[],Fc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r){var s;return r===void 0&&(r=null),(s=o.call(this)||this).manager=t,s._xrHitTestSource=e,s._transient=n,s._inputSource=r,s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&hw(a,o);var i=a.prototype;return i.remove=function(){if(this._xrHitTestSource){var t=this.manager.hitTest.sources,e=t.indexOf(this);e!==-1&&t.splice(e,1),this.onStop()}},i.onStop=function(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)},i.update=function(t){if(this._transient)for(var e=t.getHitTestResultsForTransientInput(this._xrHitTestSource),n=0;n<e.length;n++){var r=e[n];if(r.results.length){var s=void 0;r.inputSource&&(s=this.manager.input._getByInputSource(r.inputSource)),this.updateHitResults(r.results,s)}}else{var l=t.getHitTestResults(this._xrHitTestSource);if(!l.length)return;this.updateHitResults(l)}},i.updateHitResults=function(t,e){if(!this._inputSource||this._inputSource===e){var n,r,s,l=(n=Nc.pop())!=null?n:new E;e?l.copy(e.getOrigin()):l.copy(this.manager.camera.getPosition());for(var u=1/0,c=null,h=(r=Nc.pop())!=null?r:new E,f=(s=fw.pop())!=null?s:new Z,d=0;d<t.length;d++){var p=t[d].getPose(this.manager._referenceSpace),_=l.distance(p.transform.position);_>=u||(u=_,c=t[d],h.copy(p.transform.position),f.copy(p.transform.orientation))}this.fire("result",h,f,e||this._inputSource,c),this.manager.hitTest.fire("result",this,h,f,e||this._inputSource,c),Nc.push(l),Nc.push(h),fw.push(f)}},a}(se);function dw(o,a){return(dw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Fc.EVENT_REMOVE="remove",Fc.EVENT_RESULT="result";var Tr=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._supported=fe.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),n._available=!1,n._checkingAvailability=!1,n.sources=[],n.manager=e,n._supported&&(n.manager.on("start",n._onSessionStart,n),n.manager.on("end",n._onSessionEnd,n)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&dw(a,o);var i,t=a.prototype;return t._onSessionStart=function(){var e=this;if(this.manager.session.enabledFeatures){var n=this.manager.session.enabledFeatures.indexOf("hit-test")!==-1;if(!n)return;this._available=n,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace(Vp).then(function(r){e.manager.session.requestHitTestSource({space:r}).then(function(s){s.cancel(),e.manager.active&&(e._available=!0,e.fire("available"))}).catch(function(){})}).catch(function(){}))},t._onSessionEnd=function(){if(this._available){this._available=!1;for(var e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}},t.start=function(e){var n,r=this;if(e===void 0&&(e={}),!this._supported){e.callback==null||e.callback.call(e,Error("XR HitTest is not supported"),null);return}if(!this._available){e.callback==null||e.callback.call(e,Error("XR HitTest is not available"),null);return}e.profile||e.spaceType||(e.spaceType=Vp);var s=e.offsetRay;s&&(n=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0)));var l=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(function(u){if(!r.manager.session){var c=Error("XR Session is not started (2)");l&&l(c),r.fire("error",c);return}r.manager.session.requestHitTestSource({space:u,entityTypes:e.entityTypes||void 0,offsetRay:n}).then(function(h){r._onHitTestSource(h,!1,e.inputSource,l)}).catch(function(h){l&&l(h),r.fire("error",h)})}).catch(function(u){l&&l(u),r.fire("error",u)}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:n}).then(function(u){r._onHitTestSource(u,!0,e.inputSource,l)}).catch(function(u){l&&l(u),r.fire("error",u)})},t._onHitTestSource=function(e,n,r,s){if(!this.manager.session){e.cancel();var l=Error("XR Session is not started (3)");s&&s(l),this.fire("error",l);return}var u=new Fc(this.manager,e,n,r??null);this.sources.push(u),s&&s(null,u),this.fire("add",u)},t.update=function(e){if(this._available)for(var n=0;n<this.sources.length;n++)this.sources[n].update(e)},i=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function pw(o,a){return(pw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Tr.EVENT_AVAILABLE="available",Tr.EVENT_UNAVAILABLE="unavailable",Tr.EVENT_ADD="add",Tr.EVENT_REMOVE="remove",Tr.EVENT_RESULT="result",Tr.EVENT_ERROR="error";var Uc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._bitmap=null,r._measuredWidth=0,r._trackable=!1,r._tracking=!1,r._emulated=!1,r._pose=null,r._position=new E,r._rotation=new Z,r._image=e,r._width=n,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&pw(a,o);var i,t=a.prototype;return t.prepare=function(){var e=this;return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(function(n){return e._bitmap=n,{image:e._bitmap,widthInMeters:e._width}})},t.destroy=function(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)},t.getPosition=function(){return this._pose&&this._position.copy(this._pose.transform.position),this._position},t.getRotation=function(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation},i=[{key:"image",get:function(){return this._image}},{key:"width",get:function(){return this._width},set:function(e){this._width=e}},{key:"trackable",get:function(){return this._trackable}},{key:"tracking",get:function(){return this._tracking}},{key:"emulated",get:function(){return this._emulated}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function mw(o,a){return(mw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Uc.EVENT_TRACKED="tracked",Uc.EVENT_UNTRACKED="untracked";var jp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._supported=fe.browser&&!!window.XRImageTrackingResult,n._available=!1,n._images=[],n._manager=e,n._supported&&(n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&mw(a,o);var i,t=a.prototype;return t.add=function(e,n){if(!this._supported||this._manager.active)return null;var r=new Uc(e,n);return this._images.push(r),r},t.remove=function(e){if(!this._manager.active){var n=this._images.indexOf(e);n!==-1&&(e.destroy(),this._images.splice(n,1))}},t._onSessionStart=function(){var e=this;this._manager.session.getTrackedImageScores().then(function(n){e._available=!0;for(var r=0;r<n.length;r++)e._images[r]._trackable=n[r]==="trackable"}).catch(function(n){e._available=!1,e.fire("error",n)})},t._onSessionEnd=function(){this._available=!1;for(var e=0;e<this._images.length;e++){var n=this._images[e];n._pose=null,n._measuredWidth=0,n._tracking&&(n._tracking=!1,n.fire("untracked"))}},t.prepareImages=function(e){this._images.length?Promise.all(this._images.map(function(n){return n.prepare()})).then(function(n){e(null,n)}).catch(function(n){e(n,null)}):e(null,null)},t.update=function(e){if(this._available){for(var n=e.getImageTrackingResults(),r={},s=0;s<n.length;s++){r[n[s].index]=n[s];var l=this._images[n[s].index];l._emulated=n[s].trackingState==="emulated",l._measuredWidth=n[s].measuredWidthInMeters,l._pose=e.getPose(n[s].imageSpace,this._manager._referenceSpace)}for(var u=0;u<this._images.length;u++)this._images[u]._tracking&&!r[u]?(this._images[u]._tracking=!1,this._images[u].fire("untracked")):!this._images[u]._tracking&&r[u]&&(this._images[u]._tracking=!0,this._images[u].fire("tracked"))}},i=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"images",get:function(){return this._images}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);jp.EVENT_ERROR="error";for(var _w=function(){var o;function a(i,t){this._joints=[],this._tip=null,this._index=i,this._hand=t,this._hand._fingers.push(this)}return o=[{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"joints",get:function(){return this._joints}},{key:"tip",get:function(){return this._tip}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),vw=fe.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],gw={},Xp=0;Xp<vw.length;Xp++)gw[vw[Xp]]=!0;var Yp=function(){function o(t,e,n,r){r===void 0&&(r=null),this._radius=null,this._localTransform=new X,this._worldTransform=new X,this._localPosition=new E,this._localRotation=new Z,this._position=new E,this._rotation=new Z,this._dirtyLocal=!0,this._index=t,this._id=e,this._hand=n,this._finger=r,this._wrist=e==="wrist",this._tip=this._finger&&!!gw[e]}var a,i=o.prototype;return i.update=function(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)},i._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,E.ONE));var t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},i.getPosition=function(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position},i.getRotation=function(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation},a=[{key:"id",get:function(){return this._id}},{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"finger",get:function(){return this._finger}},{key:"wrist",get:function(){return this._wrist}},{key:"tip",get:function(){return this._tip}},{key:"radius",get:function(){return this._radius||.005}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function yw(o,a){return(yw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Bc=[],ps=new E,Vc=new E,Sw=new E;fe.browser&&window.XRHand&&(Bc=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);var zc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){(n=o.call(this)||this)._tracking=!1,n._fingers=[],n._joints=[],n._jointsById={},n._tips=[],n._wrist=null;var n,r=e._xrInputSource.hand;if(n._manager=e._manager,n._inputSource=e,r.get("wrist")){var s=new Yp(0,"wrist",n,null);n._wrist=s,n._joints.push(s),n._jointsById.wrist=s}for(var l=0;l<Bc.length;l++)for(var u=new _w(l,n),c=0;c<Bc[l].length;c++){var h=Bc[l][c];if(r.get(h)){var f=new Yp(c,h,n,u);n._joints.push(f),n._jointsById[h]=f,f.tip&&(n._tips.push(f),u._tip=f),u._joints.push(f)}}return n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&yw(a,o);var i,t=a.prototype;return t.update=function(e){for(var n=this._inputSource._xrInputSource,r=0;r<this._joints.length;r++){var s=this._joints[r],l=n.hand.get(s._id);if(l){var u=void 0;if(e.session.visibilityState!=="hidden"&&(u=e.getJointPose(l,this._manager._referenceSpace)),u)s.update(u),s.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(s.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}var c=this._jointsById["thumb-metacarpal"],h=this._jointsById["thumb-tip"],f=this._jointsById["index-finger-phalanx-proximal"],d=this._jointsById["index-finger-tip"],p=this._jointsById["ring-finger-phalanx-proximal"],_=this._jointsById["pinky-finger-phalanx-proximal"];if(c&&h&&f&&d&&p&&_){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(h._localPosition,d._localPosition,.5);var g=c,y=_;if(this._inputSource.handedness===lw){var v=g;g=y,y=v}ps.sub2(g._localPosition,this._wrist._localPosition),Vc.sub2(y._localPosition,this._wrist._localPosition),Sw.cross(ps,Vc).normalize(),ps.lerp(f._localPosition,p._localPosition,.5),ps.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(Sw,ps,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))},t._fingerIsClosed=function(e){var n=this._fingers[e];return ps.sub2(n.joints[0]._localPosition,n.joints[1]._localPosition).normalize(),Vc.sub2(n.joints[2]._localPosition,n.joints[3]._localPosition).normalize(),-.8>ps.dot(Vc)},t.getJointById=function(e){return this._jointsById[e]||null},i=[{key:"fingers",get:function(){return this._fingers}},{key:"joints",get:function(){return this._joints}},{key:"tips",get:function(){return this._tips}},{key:"wrist",get:function(){return this._wrist}},{key:"tracking",get:function(){return this._tracking}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function xw(o,a){return(xw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}zc.EVENT_TRACKING="tracking",zc.EVENT_TRACKINGLOST="trackinglost";var bw=new E,Tw=new Z,_R=0,Lt=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._ray=new Gn,r._rayLocal=new Gn,r._grip=!1,r._hand=null,r._velocitiesAvailable=!1,r._velocitiesTimestamp=un(),r._localTransform=null,r._worldTransform=null,r._position=new E,r._rotation=new Z,r._localPosition=null,r._localPositionLast=null,r._localRotation=null,r._linearVelocity=null,r._dirtyLocal=!0,r._dirtyRay=!1,r._selecting=!1,r._squeezing=!1,r._elementInput=!0,r._elementEntity=null,r._hitTestSources=[],r._id=++_R,r._manager=e,r._xrInputSource=n,n.hand&&(r._hand=new zc(r)),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&xw(a,o);var i,t=a.prototype;return t.update=function(e){if(this._hand)this._hand.update(e);else{var n=this._xrInputSource.gripSpace;if(n){var r=e.getPose(n,this._manager._referenceSpace);if(r){this._grip||(this._grip=!0,this._localTransform=new X,this._worldTransform=new X,this._localPositionLast=new E,this._localPosition=new E,this._localRotation=new Z,this._linearVelocity=new E);var s=un(),l=(s-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=s,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(r.transform.position),this._localRotation.copy(r.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&r.linearVelocity?this._linearVelocity.copy(r.linearVelocity):l>0&&(bw.sub2(this._localPosition,this._localPositionLast).divScalar(l),this._linearVelocity.lerp(this._linearVelocity,bw,.15))}else this._velocitiesAvailable=!1}var u=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);u&&(this._dirtyRay=!0,this._rayLocal.origin.copy(u.transform.position),this._rayLocal.direction.set(0,0,-1),Tw.copy(u.transform.orientation),Tw.transformVector(this._rayLocal.direction,this._rayLocal.direction))}},t._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,E.ONE));var e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},t._updateRayTransforms=function(){var e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){var n=this._manager.camera.parent.getWorldTransform();n.getTranslation(this._position),this._rotation.setFromMat4(n),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))},t.getPosition=function(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null},t.getLocalPosition=function(){return this._localPosition},t.getRotation=function(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null},t.getLocalRotation=function(){return this._localRotation},t.getLinearVelocity=function(){return this._velocitiesAvailable?this._linearVelocity:null},t.getOrigin=function(){return this._updateRayTransforms(),this._ray.origin},t.getDirection=function(){return this._updateRayTransforms(),this._ray.direction},t.hitTestStart=function(e){var n=this;e===void 0&&(e={}),e.inputSource=this,e.profile=this._xrInputSource.profiles[0];var r=e.callback;e.callback=function(s,l){l&&n.onHitTestSourceAdd(l),r&&r(s,l)},this._manager.hitTest.start(e)},t.onHitTestSourceAdd=function(e){var n=this;this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",function(r,s,l,u){l===n&&n.fire("hittest:result",e,r,s,u)}),e.once("remove",function(){n.onHitTestSourceRemove(e),n.fire("hittest:remove",e)})},t.onHitTestSourceRemove=function(e){var n=this._hitTestSources.indexOf(e);n!==-1&&this._hitTestSources.splice(n,1)},i=[{key:"id",get:function(){return this._id}},{key:"inputSource",get:function(){return this._xrInputSource}},{key:"targetRayMode",get:function(){return this._xrInputSource.targetRayMode}},{key:"handedness",get:function(){return this._xrInputSource.handedness}},{key:"profiles",get:function(){return this._xrInputSource.profiles}},{key:"grip",get:function(){return this._grip}},{key:"hand",get:function(){return this._hand}},{key:"gamepad",get:function(){return this._xrInputSource.gamepad||null}},{key:"selecting",get:function(){return this._selecting}},{key:"squeezing",get:function(){return this._squeezing}},{key:"elementInput",get:function(){return this._elementInput},set:function(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}},{key:"elementEntity",get:function(){return this._elementEntity}},{key:"hitTestSources",get:function(){return this._hitTestSources}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Ew(o,a){return(Ew=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Lt.EVENT_REMOVE="remove",Lt.EVENT_SELECT="select",Lt.EVENT_SELECTSTART="selectstart",Lt.EVENT_SELECTEND="selectend",Lt.EVENT_SQUEEZE="squeeze",Lt.EVENT_SQUEEZESTART="squeezestart",Lt.EVENT_SQUEEZEEND="squeezeend",Lt.EVENT_HITTESTADD="hittest:add",Lt.EVENT_HITTESTREMOVE="hittest:remove",Lt.EVENT_HITTESTRESULT="hittest:result";var ni=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n,r,s;return(n=o.call(this)||this)._inputSources=[],n.velocitiesSupported=!1,n.manager=e,n.velocitiesSupported=!!(fe.browser&&(!((s=window.XRPose)==null||(r=s.prototype)==null)&&r.hasOwnProperty("linearVelocity"))),n._onInputSourcesChangeEvt=function(l){n._onInputSourcesChange(l)},n.manager.on("start",n._onSessionStart,n),n.manager.on("end",n._onSessionEnd,n),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ew(a,o);var i,t=a.prototype;return t._onSessionStart=function(){var e=this,n=this.manager.session;n.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),n.addEventListener("select",function(l){var u=e._getByInputSource(l.inputSource);u.update(l.frame),u.fire("select",l),e.fire("select",u,l)}),n.addEventListener("selectstart",function(l){var u=e._getByInputSource(l.inputSource);u.update(l.frame),u._selecting=!0,u.fire("selectstart",l),e.fire("selectstart",u,l)}),n.addEventListener("selectend",function(l){var u=e._getByInputSource(l.inputSource);u.update(l.frame),u._selecting=!1,u.fire("selectend",l),e.fire("selectend",u,l)}),n.addEventListener("squeeze",function(l){var u=e._getByInputSource(l.inputSource);u.update(l.frame),u.fire("squeeze",l),e.fire("squeeze",u,l)}),n.addEventListener("squeezestart",function(l){var u=e._getByInputSource(l.inputSource);u.update(l.frame),u._squeezing=!0,u.fire("squeezestart",l),e.fire("squeezestart",u,l)}),n.addEventListener("squeezeend",function(l){var u=e._getByInputSource(l.inputSource);u.update(l.frame),u._squeezing=!1,u.fire("squeezeend",l),e.fire("squeezeend",u,l)});for(var r=n.inputSources,s=0;s<r.length;s++)this._addInputSource(r[s])},t._onSessionEnd=function(){for(var e=this._inputSources.length;e--;){var n=this._inputSources[e];this._inputSources.splice(e,1),n.fire("remove"),this.fire("remove",n)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)},t._onInputSourcesChange=function(e){for(var n=0;n<e.removed.length;n++)this._removeInputSource(e.removed[n]);for(var r=0;r<e.added.length;r++)this._addInputSource(e.added[r])},t._getByInputSource=function(e){for(var n=0;n<this._inputSources.length;n++)if(this._inputSources[n].inputSource===e)return this._inputSources[n];return null},t._addInputSource=function(e){if(!this._getByInputSource(e)){var n=new Lt(this.manager,e);this._inputSources.push(n),this.fire("add",n)}},t._removeInputSource=function(e){for(var n=0;n<this._inputSources.length;n++)if(this._inputSources[n].inputSource===e){var r=this._inputSources[n];this._inputSources.splice(n,1);for(var s=r.hitTestSources.length;s--;)r.hitTestSources[s].remove();r.fire("remove"),this.fire("remove",r);return}},t.update=function(e){for(var n=0;n<this._inputSources.length;n++)this._inputSources[n].update(e)},i=[{key:"inputSources",get:function(){return this._inputSources}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function ww(o,a){return(ww=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}ni.EVENT_ADD="add",ni.EVENT_REMOVE="remove",ni.EVENT_SELECT="select",ni.EVENT_SELECTSTART="selectstart",ni.EVENT_SELECTEND="selectend",ni.EVENT_SQUEEZE="squeeze",ni.EVENT_SQUEEZESTART="squeezestart",ni.EVENT_SQUEEZEEND="squeezeend";var Ma=new E,Aw=new E,qp=new X,Cw=new X,Gc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._supported=!1,n._available=!1,n._lightProbeRequested=!1,n._lightProbe=null,n._intensity=0,n._rotation=new Z,n._color=new B,n._sphericalHarmonics=new Float32Array(27),n._manager=e,n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&ww(a,o);var i,t=a.prototype;return t._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=!0)},t._onSessionEnd=function(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null},t.start=function(){var e,n=this;if(this._manager.session||(e=Error("XR session is not running")),e||this._manager.type===Da||(e=Error("XR session type is not AR")),e||this._supported||(e=Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=Error("light estimation is already requested")),e)return void this.fire("error",e);this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(function(r){var s=n._lightProbeRequested;n._lightProbeRequested=!1,n._manager.active?s&&(n._lightProbe=r):n.fire("error",Error("XR session is not active"))}).catch(function(r){n._lightProbeRequested=!1,n.fire("error",r)})},t.end=function(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1},t.update=function(e){if(this._lightProbe){var n=e.getLightEstimate(this._lightProbe);if(n){this._available||(this._available=!0,this.fire("available"));var r=n.primaryLightIntensity;this._intensity=Math.max(1,Math.max(r.x,Math.max(r.y,r.z))),Ma.copy(r).mulScalar(1/this._intensity),this._color.set(Ma.x,Ma.y,Ma.z),Ma.set(0,0,0),Aw.copy(n.primaryLightDirection),qp.setLookAt(Aw,Ma,E.UP),Cw.setFromAxisAngle(E.RIGHT,90),qp.mul(Cw),this._rotation.setFromMat4(qp),this._sphericalHarmonics.set(n.sphericalHarmonicsCoefficients)}}},i=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"intensity",get:function(){return this._available?this._intensity:null}},{key:"color",get:function(){return this._available?this._color:null}},{key:"rotation",get:function(){return this._available?this._rotation:null}},{key:"sphericalHarmonics",get:function(){return this._available?this._sphericalHarmonics:null}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Pw(o,a){return(Pw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Gc.EVENT_AVAILABLE="available",Gc.EVENT_ERROR="error";var vR=0,Hc=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._position=new E,r._rotation=new Z,r._id=++vR,r._planeDetection=e,r._xrPlane=n,r._lastChangedTime=n.lastChangedTime,r._orientation=n.orientation,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Pw(a,o);var i,t=a.prototype;return t.destroy=function(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))},t.update=function(e){var n=this._planeDetection._manager,r=e.getPose(this._xrPlane.planeSpace,n._referenceSpace);r&&(this._position.copy(r.transform.position),this._rotation.copy(r.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))},t.getPosition=function(){return this._position},t.getRotation=function(){return this._rotation},i=[{key:"id",get:function(){return this._id}},{key:"orientation",get:function(){return this._orientation}},{key:"points",get:function(){return this._xrPlane.polygon}},{key:"label",get:function(){return this._xrPlane.semanticLabel||""}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Iw(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Lw(o,a){return(Lw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Dw(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return Iw(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Iw(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Hc.EVENT_REMOVE="remove",Hc.EVENT_CHANGE="change";var Ra=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._supported=fe.browser&&!!window.XRPlane,n._available=!1,n._planesIndex=new Map,n._planes=[],n._manager=e,n._supported&&(n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Lw(a,o);var i,t=a.prototype;return t._onSessionStart=function(){this._manager.session.enabledFeatures&&this._manager.session.enabledFeatures.indexOf("plane-detection")!==-1&&(this._available=!0,this.fire("available"))},t._onSessionEnd=function(){for(var e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))},t.update=function(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedPlanes.size)return;this._available=!0,this.fire("available")}for(var n,r=e.detectedPlanes,s=Dw(this._planesIndex);!(n=s()).done;){var l=n.value,u=l[0],c=l[1];r.has(u)||(this._planesIndex.delete(u),this._planes.splice(this._planes.indexOf(c),1),c.destroy(),this.fire("remove",c))}for(var h,f=Dw(r);!(h=f()).done;){var d=h.value,p=this._planesIndex.get(d);p?p.update(e):(p=new Hc(this,d),this._planesIndex.set(d,p),this._planes.push(p),p.update(e),this.fire("add",p))}},i=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"planes",get:function(){return this._planes}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Mw(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Rw(o,a){return(Rw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Ow(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return Mw(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Mw(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Ra.EVENT_AVAILABLE="available",Ra.EVENT_UNAVAILABLE="unavailable",Ra.EVENT_ADD="add",Ra.EVENT_REMOVE="remove";var Oa=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r){var s;return r===void 0&&(r=null),(s=o.call(this)||this)._position=new E,s._rotation=new Z,s._uuid=null,s._uuidRequests=null,s._anchors=e,s._xrAnchor=n,s._uuid=r,s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Rw(a,o);var i,t=a.prototype;return t.destroy=function(){if(this._xrAnchor){var e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}},t.update=function(e){if(this._xrAnchor){var n=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(n){if(this._position.equals(n.transform.position)&&this._rotation.equals(n.transform.orientation))return;this._position.copy(n.transform.position),this._rotation.copy(n.transform.orientation),this.fire("change")}}},t.getPosition=function(){return this._position},t.getRotation=function(){return this._rotation},t.persist=function(e){var n=this;if(!this._anchors.persistence){e==null||e(Error("Persistent Anchors are not supported"),null);return}if(this._uuid){e==null||e(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(function(r){n._uuid=r,n._anchors._indexByUuid.set(n._uuid,n),e==null||e(null,r);for(var s,l=Ow(n._uuidRequests);!(s=l()).done;)(0,s.value)(null,r);n._uuidRequests=null,n.fire("persist",r)}).catch(function(r){e==null||e(r,null);for(var s,l=Ow(n._uuidRequests);!(s=l()).done;)(0,s.value)(r,null);n._uuidRequests=null})},t.forget=function(e){var n=this;if(!this._uuid){e==null||e(Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,function(r){n._uuid=null,e==null||e(r),n.fire("forget")})},i=[{key:"uuid",get:function(){return this._uuid}},{key:"persistent",get:function(){return!!this._uuid}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function kw(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Nw(o,a){return(Nw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Fw(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return kw(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return kw(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Oa.EVENT_DESTROY="destroy",Oa.EVENT_CHANGE="change",Oa.EVENT_PERSIST="persist",Oa.EVENT_FORGET="forget";var ms=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n,r,s;return(n=o.call(this)||this)._supported=fe.browser&&!!window.XRAnchor,n._available=!1,n._checkingAvailability=!1,n._persistence=fe.browser&&!!(!((s=window)==null||(r=s.XRSession)==null)&&r.prototype.restorePersistentAnchor),n._creationQueue=[],n._index=new Map,n._indexByUuid=new Map,n._list=[],n._callbacksAnchors=new Map,n.manager=e,n._supported&&(n.manager.on("start",n._onSessionStart,n),n.manager.on("end",n._onSessionEnd,n)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Nw(a,o);var i,t=a.prototype;return t._onSessionStart=function(){var e,n=((e=this.manager.session.enabledFeatures)==null?void 0:e.indexOf("anchors"))>=0;n&&(this._available=n,this.fire("available"))},t._onSessionEnd=function(){if(this._available){this._available=!1;for(var e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();for(var n=this._list.length;n--;)this._list[n].destroy();this._list.length=0,this.fire("unavailable")}},t._createAnchor=function(e,n){n===void 0&&(n=null);var r=new Oa(this,e,n);return this._index.set(e,r),n&&this._indexByUuid.set(n,r),this._list.push(r),r.once("destroy",this._onAnchorDestroy,this),r},t._onAnchorDestroy=function(e,n){this._index.delete(e),n.uuid&&this._indexByUuid.delete(n.uuid);var r=this._list.indexOf(n);r!==-1&&this._list.splice(r,1),this.fire("destroy",n)},t.create=function(e,n,r){var s,l=this;if(!this._available){r==null||r(Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&((s=XRHitTestResult)!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?s[Symbol.hasInstance](e):Q(e,s))){if(r=n,!this._supported){r==null||r(Error("Anchors API is not supported"),null);return}if(!e.createAnchor){r==null||r(Error("Creating Anchor from Hit Test is not supported"),null);return}e.createAnchor().then(function(u){var c=l._createAnchor(u);r==null||r(null,c),l.fire("add",c)}).catch(function(u){r==null||r(u,null),l.fire("error",u)})}else this._creationQueue.push({transform:new XRRigidTransform(e,n),callback:r})},t.restore=function(e,n){var r=this;if(!this._available){n==null||n(Error("Anchors API is not available"),null);return}if(!this._persistence){n==null||n(Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){n==null||n(Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(function(s){var l=r._createAnchor(s,e);n==null||n(null,l),r.fire("add",l)}).catch(function(s){n==null||n(s,null),r.fire("error",s)})},t.forget=function(e,n){var r=this;if(!this._available){n==null||n(Error("Anchors API is not available"));return}if(!this._persistence){n==null||n(Error("Anchor Persistence is not supported"));return}if(!this.manager.active){n==null||n(Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(function(){n==null||n(null)}).catch(function(s){n==null||n(s),r.fire("error",s)})},t.update=function(e){var n=this;if(!this._available){this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=!0,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(function(x){x.delete(),n.manager.active&&(n._available=!0,n.fire("available"))}).catch(function(){}));return}if(this._creationQueue.length){for(var r,s=0;s<this._creationQueue.length;s++)r=this,function(x){var S=r._creationQueue[x];e.createAnchor(S.transform,r.manager._referenceSpace).then(function(T){S.callback&&n._callbacksAnchors.set(T,S.callback)}).catch(function(T){S.callback&&S.callback(T,null),n.fire("error",T)})}(s);this._creationQueue.length=0}for(var l,u=Fw(this._index);!(l=u()).done;){var c=l.value,h=c[0],f=c[1];e.trackedAnchors.has(h)||(this._index.delete(h),f.destroy())}for(var d=0;d<this._list.length;d++)this._list[d].update(e);for(var p,_=Fw(e.trackedAnchors);!(p=_()).done;){var g=p.value;if(!this._index.has(g)){try{g.anchorSpace}catch{continue}var y=this._createAnchor(g);y.update(e);var v=this._callbacksAnchors.get(g);v&&(this._callbacksAnchors.delete(g),v(null,y)),this.fire("add",y)}}},i=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"persistence",get:function(){return this._persistence}},{key:"uuids",get:function(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}},{key:"list",get:function(){return this._list}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Uw(o,a){return(Uw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}ms.EVENT_AVAILABLE="available",ms.EVENT_UNAVAILABLE="unavailable",ms.EVENT_ERROR="error",ms.EVENT_ADD="add",ms.EVENT_DESTROY="destroy";var Kp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._lastChanged=0,r._position=new E,r._rotation=new Z,r._meshDetection=e,r._xrMesh=n,r._lastChanged=r._xrMesh.lastChangedTime,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Uw(a,o);var i,t=a.prototype;return t.destroy=function(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))},t.update=function(e){var n=this._meshDetection._manager,r=e.getPose(this._xrMesh.meshSpace,n._referenceSpace);r&&(this._position.copy(r.transform.position),this._rotation.copy(r.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))},t.getPosition=function(){return this._position},t.getRotation=function(){return this._rotation},i=[{key:"xrMesh",get:function(){return this._xrMesh}},{key:"label",get:function(){return this._xrMesh.semanticLabel||""}},{key:"vertices",get:function(){return this._xrMesh.vertices}},{key:"indices",get:function(){return this._xrMesh.indices}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Bw(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Vw(o,a){return(Vw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Zp(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return Bw(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Bw(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Kp.EVENT_REMOVE="remove",Kp.EVENT_CHANGE="change";var ka=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._supported=fe.browser&&!!window.XRMesh,n._available=!1,n._index=new Map,n._list=[],n._manager=e,n._supported&&(n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Vw(a,o);var i,t=a.prototype;return t.update=function(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedMeshes.size)return;this._available=!0,this.fire("available")}for(var n,r=Zp(e.detectedMeshes);!(n=r()).done;){var s=n.value,l=this._index.get(s);l?l.update(e):(l=new Kp(this,s),this._index.set(s,l),this._list.push(l),l.update(e),this.fire("add",l))}for(var u,c=Zp(this._index.values());!(u=c()).done;){var h=u.value;e.detectedMeshes.has(h.xrMesh)||this._removeMesh(h)}},t._removeMesh=function(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)},t._onSessionStart=function(){if(this._manager.session.enabledFeatures){var e=this._manager.session.enabledFeatures.indexOf("mesh-detection")!==-1;e&&(this._available=e,this.fire("available"))}},t._onSessionEnd=function(){if(this._available){this._available=!1;for(var e,n=Zp(this._index.values());!(e=n()).done;){var r=e.value;this._removeMesh(r)}this.fire("unavailable")}},i=[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"meshes",get:function(){return this._list}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function zw(o,a){return(zw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}ka.EVENT_AVAILABLE="available",ka.EVENT_UNAVAILABLE="unavailable",ka.EVENT_ADD="add",ka.EVENT_REMOVE="remove";var Qp=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r){(s=o.call(this)||this)._positionData=new Float32Array(3),s._viewport=new q,s._projMat=new X,s._projViewOffMat=new X,s._viewMat=new X,s._viewOffMat=new X,s._viewMat3=new zt,s._viewInvMat=new X,s._viewInvOffMat=new X,s._xrCamera=null,s._textureColor=null,s._textureDepth=null,s._depthInfo=null,s._emptyDepthBuffer=new Uint8Array(32),s._depthMatrix=new X,s._manager=e,s._xrView=n;var s,l=s._manager.app.graphicsDevice;if(s._manager.views.supportedColor&&(s._xrCamera=s._xrView.camera,s._manager.views.availableColor&&s._xrCamera&&(s._textureColor=new ee(l,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:s._xrCamera.width,height:s._xrCamera.height,name:"XrView-"+s._xrView.eye+"-Color"}))),s._manager.views.supportedDepth&&s._manager.views.availableDepth){var u=+!s._manager.views.depthGpuOptimized;s._textureDepth=new ee(l,{format:s._manager.views.depthPixelFormat,arrayLength:r===1?0:r,mipmaps:!1,addressU:1,addressV:1,minFilter:u,magFilter:u,width:4,height:4,name:"XrView-"+s._xrView.eye+"-Depth"});for(var c=0;c<s._textureDepth._levels.length;c++)s._textureDepth._levels[c]=s._emptyDepthBuffer;s._textureDepth.upload()}return(s._textureColor||s._textureDepth)&&l.on("devicelost",s._onDeviceLost,s),s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&zw(a,o);var i,t=a.prototype;return t.update=function(e,n){this._xrView=n,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);var r=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=r.x,this._viewport.y=r.y,this._viewport.z=r.width,this._viewport.w=r.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)},t._updateTextureColor=function(){if(this._manager.views.availableColor&&this._xrCamera&&this._textureColor){var e=this._manager.webglBinding;if(e){var n=e.getCameraImage(this._xrCamera);if(n){var r=this._manager.app.graphicsDevice,s=r.gl;if(this._frameBufferSource){var l=s.COLOR_ATTACHMENT0,u=this._xrCamera.width,c=this._xrCamera.height;r.setFramebuffer(this._frameBufferSource),s.framebufferTexture2D(s.FRAMEBUFFER,l,s.TEXTURE_2D,n,0),r.setFramebuffer(this._frameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,l,s.TEXTURE_2D,this._textureColor.impl._glTexture,0),s.bindFramebuffer(s.READ_FRAMEBUFFER,this._frameBufferSource),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this._frameBuffer),s.blitFramebuffer(0,c,u,0,0,0,u,c,s.COLOR_BUFFER_BIT,s.NEAREST)}else this._frameBufferSource=s.createFramebuffer(),this._frameBuffer=s.createFramebuffer()}}}},t._updateDepth=function(e){if(this._manager.views.availableDepth&&this._textureDepth){var n,r,s=this._manager.views.depthGpuOptimized,l=s?this._manager.webglBinding:e;if(!l){this._depthInfo=null;return}var u=l.getDepthInformation(this._xrView);if(!u){this._depthInfo=null;return}var c=!this._depthInfo!=!u;this._depthInfo=u;var h=((n=this._depthInfo)==null?void 0:n.width)||4,f=((r=this._depthInfo)==null?void 0:r.height)||4,d=!1;if((this._textureDepth.width!==h||this._textureDepth.height!==f)&&(this._textureDepth._width=h,this._textureDepth._height=f,c=!0,d=!0),c&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(s){if(this._depthInfo.texture){var p=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,this._depthInfo.textureType==="texture-array"?this._textureDepth.impl._glTarget=p.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=p.TEXTURE_2D,this._manager.views.depthPixelFormat){case 15:this._textureDepth.impl._glInternalFormat=p.R32F,this._textureDepth.impl._glPixelType=p.FLOAT,this._textureDepth.impl._glFormat=p.RED;break;case 16:this._textureDepth.impl._glInternalFormat=p.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=p.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=p.DEPTH_COMPONENT}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();d&&this.fire("depth:resize",h,f)}},t.updateTransforms=function(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]},t._onDeviceLost=function(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null},t.getDepth=function(e,n){var r,s;return this._manager.views.depthGpuOptimized?null:(s=(r=this._depthInfo)==null?void 0:r.getDepthInMeters(e,n))!=null?s:null},t.destroy=function(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){var e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}},i=[{key:"textureColor",get:function(){return this._textureColor}},{key:"textureDepth",get:function(){return this._textureDepth}},{key:"depthUvMatrix",get:function(){return this._depthMatrix}},{key:"depthValueToMeters",get:function(){var e;return((e=this._depthInfo)==null?void 0:e.rawValueToMeters)||0}},{key:"eye",get:function(){return this._xrView.eye}},{key:"viewport",get:function(){return this._viewport}},{key:"projMat",get:function(){return this._projMat}},{key:"projViewOffMat",get:function(){return this._projViewOffMat}},{key:"viewOffMat",get:function(){return this._viewOffMat}},{key:"viewInvOffMat",get:function(){return this._viewInvOffMat}},{key:"viewMat3",get:function(){return this._viewMat3}},{key:"positionData",get:function(){return this._positionData}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Gw(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function Hw(o,a){return(Hw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function Jp(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return Gw(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Gw(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Qp.EVENT_DEPTHRESIZE="depth:resize";var Tl=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n,r;return(n=o.call(this)||this)._index=new Map,n._indexTmp=new Map,n._list=[],n._supportedColor=fe.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,n._supportedDepth=fe.browser&&!!window.XRDepthInformation,n._availableColor=!1,n._availableDepth=!1,n._depthUsage="",n._depthFormat="",(r={})[Gp]=2,r[Hp]=16,r[Wp]=15,n._depthFormats=r,n._manager=e,n._manager.on("start",n._onSessionStart,n),n._manager.on("end",n._onSessionEnd,n),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Hw(a,o);var i,t=a.prototype;return t.update=function(e,n){for(var r=0;r<n.length;r++)this._indexTmp.set(n[r].eye,n[r]);for(var s,l=Jp(this._indexTmp);!(s=l()).done;){var u=s.value,c=u[0],h=u[1],f=this._index.get(c);f?f.update(e,h):(f=new Qp(this._manager,h,n.length),this._index.set(c,f),this._list.push(f),f.update(e,h),this.fire("add",f))}for(var d,p=Jp(this._index);!(d=p()).done;){var _=d.value,g=_[0],y=_[1];if(!this._indexTmp.has(g)){y.destroy(),this._index.delete(g);var v=this._list.indexOf(y);v!==-1&&this._list.splice(v,1),this.fire("remove",y)}}this._indexTmp.clear()},t.get=function(e){return this._index.get(e)||null},t._onSessionStart=function(){if(this._manager.type===Da&&this._manager.session.enabledFeatures&&(this._availableColor=this._manager.session.enabledFeatures.indexOf("camera-access")!==-1,this._availableDepth=this._manager.session.enabledFeatures.indexOf("depth-sensing")!==-1,this._availableDepth)){var e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}},t._onSessionEnd=function(){for(var e,n=Jp(this._index.values());!(e=n()).done;)e.value.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0},i=[{key:"list",get:function(){return this._list}},{key:"supportedColor",get:function(){return this._supportedColor}},{key:"supportedDepth",get:function(){return this._supportedDepth}},{key:"availableColor",get:function(){return this._availableColor}},{key:"availableDepth",get:function(){return this._availableDepth}},{key:"depthUsage",get:function(){return this._depthUsage}},{key:"depthGpuOptimized",get:function(){return this._depthUsage===zp}},{key:"depthFormat",get:function(){return this._depthFormat}},{key:"depthPixelFormat",get:function(){var e;return(e=this._depthFormats[this._depthFormat])!=null?e:null}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function Ww(o,a){return(Ww=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}Tl.EVENT_ADD="add",Tl.EVENT_REMOVE="remove";var _s=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){var n;return(n=o.call(this)||this)._supported=fe.browser&&!!navigator.xr,n._available={},n._type=null,n._spaceType=null,n._session=null,n._baseLayer=null,n.webglBinding=null,n._referenceSpace=null,n._camera=null,n._localPosition=new E,n._localRotation=new Z,n._depthNear=.1,n._depthFar=1e3,n._supportedFrameRates=null,n._width=0,n._height=0,n._framebufferScaleFactor=1,n.app=e,n._available[aw]=!1,n._available[ow]=!1,n._available[Da]=!1,n.views=new Tl(n),n.domOverlay=new cw(n),n.hitTest=new Tr(n),n.imageTracking=new jp(n),n.planeDetection=new Ra(n),n.meshDetection=new ka(n),n.input=new ni(n),n.lightEstimation=new Gc(n),n.anchors=new ms(n),n.views=new Tl(n),n._supported&&(navigator.xr.addEventListener("devicechange",function(){n._deviceAvailabilityCheck()}),n._deviceAvailabilityCheck(),n.app.graphicsDevice.on("devicelost",n._onDeviceLost,n),n.app.graphicsDevice.on("devicerestored",n._onDeviceRestored,n)),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Ww(a,o);var i,t=a.prototype;return t.destroy=function(){},t.start=function(e,n,r,s){var l,u=this,c=s;if((s===void 0?"undefined":s&&typeof Symbol<"u"&&s.constructor===Symbol?"symbol":typeof s)=="object"&&(c=s.callback),!this._available[n]){c&&c(Error("XR is not available"));return}if(this._session){c&&c(Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=n,this._spaceType=r,this._framebufferScaleFactor=(l=s==null?void 0:s.framebufferScaleFactor)!=null?l:1,this._setClipPlanes(e.nearClip,e.farClip);var h={requiredFeatures:[r],optionalFeatures:[]},f=this.app.graphicsDevice;f!=null&&f.isWebGPU&&h.requiredFeatures.push("webgpu");var d=f==null?void 0:f.isWebGL2;if(n===Da){if(h.optionalFeatures.push("light-estimation"),h.optionalFeatures.push("hit-test"),s&&(s.imageTracking&&this.imageTracking.supported&&h.optionalFeatures.push("image-tracking"),s.planeDetection&&h.optionalFeatures.push("plane-detection"),s.meshDetection&&h.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(h.optionalFeatures.push("dom-overlay"),h.domOverlay={root:this.domOverlay.root}),s&&s.anchors&&this.anchors.supported&&h.optionalFeatures.push("anchors"),s&&s.depthSensing&&this.views.supportedDepth){h.optionalFeatures.push("depth-sensing");var p=[],_=[];if(p.push(zp,uw),_.push(Wp,Gp,Hp),s.depthSensing.usagePreference){var g=p.indexOf(s.depthSensing.usagePreference);g!==-1&&p.splice(g,1),p.unshift(s.depthSensing.usagePreference)}if(s.depthSensing.dataFormatPreference){var y=_.indexOf(s.depthSensing.dataFormatPreference);y!==-1&&_.splice(y,1),_.unshift(s.depthSensing.dataFormatPreference)}h.depthSensing={usagePreference:p,dataFormatPreference:_}}d&&s&&s.cameraColor&&this.views.supportedColor&&h.optionalFeatures.push("camera-access")}h.optionalFeatures.push("hand-tracking"),s&&s.optionalFeatures&&(h.optionalFeatures=h.optionalFeatures.concat(s.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(function(v,x){if(v){c&&c(v),u.fire("error",v);return}x!==null&&(h.trackedImages=x),u._onStartOptionsReady(n,r,h,c)}):this._onStartOptionsReady(n,r,h,c)},t._onStartOptionsReady=function(e,n,r,s){var l=this;navigator.xr.requestSession(e,r).then(function(u){l._onSessionStart(u,n,s)}).catch(function(u){l._camera.camera.xr=null,l._camera=null,l._type=null,l._spaceType=null,s&&s(u),l.fire("error",u)})},t.end=function(e){if(!this._session){e&&e(Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end()},t.isAvailable=function(e){return this._available[e]},t._deviceAvailabilityCheck=function(){for(var e in this._available)this._sessionSupportCheck(e)},t.initiateRoomCapture=function(e){return this._session?this._session.initiateRoomCapture?void this._session.initiateRoomCapture().then(function(){e&&e(null)}).catch(function(n){e&&e(n)}):void e(Error("Session does not support manual room capture")):void e(Error("Session is not active"))},t.updateTargetFrameRate=function(e,n){var r;if(!((r=this._session)!=null&&r.updateTargetFrameRate)){n==null||n(Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(function(){n==null||n()}).catch(function(s){n==null||n(s)})},t._sessionSupportCheck=function(e){var n=this;navigator.xr.isSessionSupported(e).then(function(r){n._available[e]!==r&&(n._available[e]=r,n.fire("available",e,r),n.fire("available:"+e,r))}).catch(function(r){n.fire("error",r)})},t._onSessionStart=function(e,n,r){var s=this,l=!1;this._session=e;var u=function(){s.fire("visibility:change",e.visibilityState)},c=function(){s._setClipPlanes(s._camera.nearClip,s._camera.farClip)},h=function(){s._camera&&(s._camera.off("set_nearClip",c),s._camera.off("set_farClip",c),s._camera.camera.xr=null,s._camera=null),e.removeEventListener("end",h),e.removeEventListener("visibilitychange",u),l||s.fire("end"),s._session=null,s._referenceSpace=null,s._width=0,s._height=0,s._type=null,s._spaceType=null,s.app.systems&&s.app.tick()};e.addEventListener("end",h),e.addEventListener("visibilitychange",u),this._camera.on("set_nearClip",c),this._camera.on("set_farClip",c),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",function(){var f;s.fire("frameratechange",(f=s._session)==null?void 0:f.frameRate)}),e.requestReferenceSpace(n).then(function(f){s._referenceSpace=f,s.app.tick(),r&&r(null),s.fire("start")}).catch(function(f){l=!0,e.end(),r&&r(f),s.fire("error",f)})},t._setClipPlanes=function(e,n){(this._depthNear!==e||this._depthFar!==n)&&(this._depthNear=e,this._depthFar=n,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))},t._createBaseLayer=function(){var e=this.app.graphicsDevice,n=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:n,antialias:!1}),(e==null?void 0:e.isWebGL2)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(r){this.fire("error",r)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})},t._onDeviceLost=function(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))},t._onDeviceRestored=function(){var e=this;this._session&&setTimeout(function(){e.app.graphicsDevice.gl.makeXRCompatible().then(function(){e._createBaseLayer()}).catch(function(n){e.fire("error",n)})},0)},t.update=function(e){if(!this._session)return!1;var n=e.session.renderState.baseLayer.framebufferWidth,r=e.session.renderState.baseLayer.framebufferHeight;(this._width!==n||this._height!==r)&&(this._width=n,this._height=r,this.app.graphicsDevice.setResolution(n,r));var s=e.getViewerPose(this._referenceSpace);if(!s)return!1;var l=this.views.list.length;this.views.update(e,s.views);var u=s.transform.position,c=s.transform.orientation;if(this._localPosition.set(u.x,u.y,u.z),this._localRotation.set(c.x,c.y,c.z,c.w),l===0&&this.views.list.length>0){var h=new X,f=this.views.list[0];h.copy(f.projMat);var d=h.data,p=2*Math.atan(1/d[5])*180/Math.PI,_=d[5]/d[0],g=d[14]/(d[10]+1),y=d[14]/(d[10]-1);this._camera.camera.setXrProperties({aspectRatio:_,farClip:g,fov:p,horizontalFov:!1,nearClip:y})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===Da&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0},i=[{key:"supported",get:function(){return this._supported}},{key:"active",get:function(){return!!this._session}},{key:"type",get:function(){return this._type}},{key:"spaceType",get:function(){return this._spaceType}},{key:"session",get:function(){return this._session}},{key:"frameRate",get:function(){var e,n;return(n=(e=this._session)==null?void 0:e.frameRate)!=null?n:null}},{key:"supportedFrameRates",get:function(){return this._supportedFrameRates}},{key:"framebufferScaleFactor",get:function(){return this._framebufferScaleFactor}},{key:"fixedFoveation",get:function(){var e,n;return(n=(e=this._baseLayer)==null?void 0:e.fixedFoveation)!=null?n:null},set:function(e){var n,r;((r=(n=this._baseLayer)==null?void 0:n.fixedFoveation)!=null?r:null)!==null&&(this.app.graphicsDevice.samples,this._baseLayer.fixedFoveation=e)}},{key:"camera",get:function(){return this._camera?this._camera.entity:null}},{key:"visibilityState",get:function(){return this._session?this._session.visibilityState:null}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function jw(o,a){return(jw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}_s.EVENT_AVAILABLE="available",_s.EVENT_START="start",_s.EVENT_END="end",_s.EVENT_UPDATE="update",_s.EVENT_ERROR="error";var gR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){e===void 0&&(e={});var n,r=o.call(this,t)||this,s=new a0;return s.graphicsDevice=(n=e.graphicsDevice)!=null?n:r.createDevice(t,e),r.addComponentSystems(s),r.addResourceHandles(s),s.elementInput=e.elementInput,s.keyboard=e.keyboard,s.mouse=e.mouse,s.touch=e.touch,s.gamepads=e.gamepads,s.scriptPrefix=e.scriptPrefix,s.assetPrefix=e.assetPrefix,s.scriptsOrder=e.scriptsOrder,s.soundManager=new Fv,s.lightmapper=f0,s.batchManager=Ag,s.xr=_s,r.init(s),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&jw(a,o);var i=a.prototype;return i.createDevice=function(t,e){return e.graphicsDeviceOptions||(e.graphicsDeviceOptions={}),fe.browser&&navigator.xr&&(e.graphicsDeviceOptions.xrCompatible=!0),e.graphicsDeviceOptions.alpha=e.graphicsDeviceOptions.alpha||!1,new vf(t,e.graphicsDeviceOptions)},i.addComponentSystems=function(t){t.componentSystems=[Ec,_x,Ox,k0,Q0,Qx,sb,iT,hT,xT,Nb,tx,tb,gb,Lx,lx,Ab,Lb,Xb,jx,Ux,Jb,ET]},i.addResourceHandles=function(t){t.resourceHandlers=[IT,BT,zT,HT,TE,xE,sw,FE,gE,jT,IE,wE,tE,_E,$T,DE,pE,iE,sE,YT,BE,RE,kE,QT,fE]},a}(Pn);function Xw(o,a){return(Xw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var yR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this)||this)._assets=new Set,n._loadingAssets=new Set,n._waitingAssets=new Set,n._loading=!1,n._loaded=!1,n._failed=[],n._registry=e,t.forEach(function(r){if($!=null&&typeof Symbol<"u"&&$[Symbol.hasInstance]?$[Symbol.hasInstance](r):Q(r,$))r.registry||(r.registry=e),n._assets.add(r);else{var s=e.get(r);s?n._assets.add(s):n._waitForAsset(r)}}),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Xw(a,o);var i=a.prototype;return i.destroy=function(){var t=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(function(e){t._registry.off("add:"+e,t._onAddAsset)}),this.off("progress"),this.off("load")},i._assetHasDependencies=function(t){var e;return t.type==="model"&&((e=t.file)==null?void 0:e.url)&&t.file.url&&t.file.url.match(/.json$/g)},i.load=function(t,e){var n=this;if(!this._loading){this._loading=!0,this._callback=t,this._scope=e,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);var r=!1;this._assets.forEach(function(s){s.loaded||(r=!0,n._assetHasDependencies(s)&&n._registry.loadFromUrl(s.file.url,s.type,function(l,u){if(l)return void n._onError(l,s);n._onLoad(s)}),n._loadingAssets.add(s),n._registry.add(s))}),this._loadingAssets.forEach(function(s){n._assetHasDependencies(s)||n._registry.load(s)}),r||this._waitingAssets.size!==0||this._loadingComplete()}},i.ready=function(t,e){e===void 0&&(e=this),this._loaded?t.call(e,Array.from(this._assets)):this.once("load",function(n){t.call(e,n)})},i._loadingComplete=function(){this._loaded||(this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))))},i._onLoad=function(t){var e=this;this._loadingAssets.has(t)&&(this.fire("progress",t),this._loadingAssets.delete(t)),this._loadingAssets.size===0&&setTimeout(function(){e._loadingComplete()},0)},i._onError=function(t,e){var n=this;this._loadingAssets.has(e)&&(this._failed.push(e),this._loadingAssets.delete(e)),this._loadingAssets.size===0&&setTimeout(function(){n._loadingComplete()},0)},i._onAddAsset=function(t){this._waitingAssets.delete(t),this._assets.add(t),t.loaded||(this._loadingAssets.add(t),this._registry.load(t))},i._waitForAsset=function(t){this._waitingAssets.add(t),this._registry.once("add:"+t,this._onAddAsset,this)},a}(se);function Yw(o,a){return(Yw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var SR=function(){function o(i,t,e,n){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.texture=new ee(i,{name:n,format:20,width:t,height:e,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:!0})}var a=o.prototype;return a.destroy=function(){this.texture.destroy()},a.clear=function(i){var t=this.canvas,e=t.width,n=t.height;this.ctx.clearRect(0,0,e,n),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,e,n)},o}(),xR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return n===void 0&&(n={}),(r=o.call(this)||this).type="bitmap",r.app=e,r.intensity=0,r.fontWeight=n.fontWeight||"normal",r.fontSize=parseInt(n.fontSize,10),r.glyphSize=r.fontSize,r.fontName=n.fontName||"Arial",r.color=n.color||new B(1,1,1),r.padding=n.padding||0,r.width=Math.min(4096,n.width||512),r.height=Math.min(4096,n.height||512),r.atlases=[],r.chars="",r.data={},r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Yw(a,o);var i,t=a.prototype;return t.createTextures=function(e){var n=this._normalizeCharsSet(e);if(n.length!==this.chars.length)return void this._renderAtlas(n);for(var r=0;r<n.length;r++)if(n[r]!==this.chars[r])return void this._renderAtlas(n)},t.updateTextures=function(e){for(var n=this._normalizeCharsSet(e),r=[],s=0;s<n.length;s++){var l=n[s];this.data.chars[l]||r.push(l)}r.length>0&&this._renderAtlas(this.chars.concat(r))},t.destroy=function(){this.atlases.forEach(function(e){return e.destroy()}),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null},t._colorToRgbString=function(e,n){var r=Math.round(255*e.r),s=Math.round(255*e.g),l=Math.round(255*e.b);return n?"rgba("+r+", "+s+", "+l+", "+e.a+")":"rgb("+r+", "+s+", "+l+")"},t.renderCharacter=function(e,n,r,s,l){e.fillStyle=l,e.fillText(n,r,s)},t._getAtlas=function(e){return e>=this.atlases.length&&(this.atlases[e]=new SR(this.app.graphicsDevice,this.width,this.height,"font-atlas-"+this.fontName+"-"+e)),this.atlases[e]},t._renderAtlas=function(e){this.chars=e;var n=this.width,r=this.height,s=this._colorToRgbString(this.color,!1),l=this.color.a;this.color.a=1/255;var u=this._colorToRgbString(this.color,!0);this.color.a=l;var c=0,h=this._getAtlas(c++);h.clear(u),this.data=this._createJson(this.chars,this.fontName,n,r);for(var f=er.getSymbols(this.chars.join("")),d=0,p=0,_={},g=0;g<f.length;g++){var y=f[g];_[y]=this._getTextMetrics(y),d=Math.max(d,_[y].height),p=Math.max(p,_[y].descent)}this.glyphSize=Math.max(this.glyphSize,d);for(var v=this.glyphSize+2*this.padding,x=this.glyphSize+2*this.padding,S=this.glyphSize/2+this.padding,T=x-p-this.padding,b=0,w=0,A=0;A<f.length;A++){var C=f[A],L=er.getCodePoint(f[A]),I=this.fontSize;h.ctx.font=this.fontWeight+" "+I.toString()+"px "+this.fontName,h.ctx.textAlign="center",h.ctx.textBaseline="alphabetic";var P=h.ctx.measureText(C).width;P>I&&(I=this.fontSize*this.fontSize/P,h.ctx.font=this.fontWeight+" "+I.toString()+"px "+this.fontName,P=this.fontSize),this.renderCharacter(h.ctx,C,b+S,w+T,s);var M=this.padding+(this.glyphSize-P)/2,R=-this.padding+_[C].descent-p,k=P;this._addChar(this.data,C,L,b,w,v,x,M,R,k,c-1,n,r),(b+=v)+v>n&&(b=0,(w+=x)+x>r&&((h=this._getAtlas(c++)).clear(u),w=0))}this.atlases.splice(c).forEach(function(D){return D.destroy()}),this.atlases.forEach(function(D){return D.texture.upload()}),this.fire("render")},t._createJson=function(e,n,r,s){return{version:3,intensity:this.intensity,info:{face:n,width:r,height:s,maps:[{width:r,height:s}]},chars:{}}},t._addChar=function(e,n,r,s,l,u,c,h,f,d,p,_,g){e.info.maps.length<p+1&&e.info.maps.push({width:_,height:g});var y=this.fontSize/32;e.chars[n]={id:r,letter:n,x:s,y:l,width:u,height:c,xadvance:d/y,xoffset:h/y,yoffset:(f+this.padding)/y,scale:y,range:1,map:p,bounds:[0,0,u/y,c/y]}},t._normalizeCharsSet=function(e){var n=this.app.systems.element.getUnicodeConverter();n&&(e=n(e));for(var r={},s=er.getSymbols(e),l=0;l<s.length;l++){var u=s[l];r[u]||(r[u]=u)}return Object.keys(r).sort()},t._getTextMetrics=function(e){var n=document.createElement("span");n.id="content-span",n.innerHTML=e;var r=document.createElement("div");r.id="content-block",r.style.display="inline-block",r.style.width="1px",r.style.height="0px";var s=document.createElement("div");s.appendChild(n),s.appendChild(r),s.style.font=this.fontSize+"px "+this.fontName,document.body.appendChild(s);var l=-1,u=-1,c=-1;try{r.style["vertical-align"]="baseline",l=r.offsetTop-n.offsetTop,r.style["vertical-align"]="bottom",u=(c=r.offsetTop-n.offsetTop)-l}finally{document.body.removeChild(s)}return{ascent:l,descent:u,height:c}},i=[{key:"textures",get:function(){return this.atlases.map(function(e){return e.texture})}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);function qw(o,a){return(qw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Wc=[],bR=[[],[],[]],TR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e){var n;return(n=o.call(this,t)||this).viewBindGroups=[],n.renderer=e,n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&qw(a,o);var i=a.prototype;return i.destroy=function(){this.viewBindGroups.forEach(function(t){t.defaultUniformBuffer.destroy(),t.destroy()}),this.viewBindGroups.length=0},i.update=function(t,e,n,r){this.camera=t,this.scene=e,this.layers=n,this.mapping=r},i.execute=function(){for(var t=this.device,e=this.renderer,n=this.camera,r=this.scene,s=this.layers,l=this.mapping,u=this.renderTarget,c=r.layers.layerList,h=r.layers.subLayerEnabled,f=r.layers.subLayerList,d=0;d<c.length;d++){var p=c[d];if(!(s&&0>s.indexOf(p))&&p.enabled&&h[d]&&p.camerasSet.has(n.camera)){var _=f[d];p._clearDepthBuffer&&e.clear(n.camera,!1,!0,!1);for(var g=p.meshInstances,y=0;y<g.length;y++){var v=g[y];v.pick&&v.transparent===_&&(Wc.push(v),l.set(v.id,v))}Wc.length>0&&(r.clusteredLightingEnabled&&e.worldClustersAllocator.empty.activate(),e.setCameraUniforms(n.camera,u),t.supportsUniformBuffers&&e.setupViewUniformBuffers(this.viewBindGroups,e.viewUniformFormat,e.viewBindGroupFormat,null),e.renderForward(n.camera,u,Wc,bR,3,function(x){t.setBlendState(ge.NOBLEND)}),Wc.length=0)}}},a}(ct),$p=new Set,ER=new q,wR=function(){function o(i,t,e){var n=this;this.renderTarget=null,this.mapping=new Map,this.deviceValid=!0,this.renderer=i.renderer,this.device=i.graphicsDevice,this.renderPass=new TR(this.device,i.renderer),this.width=0,this.height=0,this.resize(t,e),this.device.on("destroy",function(){n.deviceValid=!1})}var a=o.prototype;return a.getSelection=function(i,t,e,n){e===void 0&&(e=1),n===void 0&&(n=1);var r=this.device;if(r.isWebGPU)return[];t=this.renderTarget.height-(t+n);var s=this.sanitizeRect(i,t,e,n);r.setRenderTarget(this.renderTarget),r.updateBegin();var l=new Uint8Array(4*s.z*s.w);return r.readPixels(s.x,s.y,s.z,s.w,l),r.updateEnd(),this.decodePixels(l,this.mapping)},a.getSelectionAsync=function(i,t,e,n){var r,s=this;e===void 0&&(e=1),n===void 0&&(n=1),(r=this.device)!=null&&r.isWebGL2&&(t=this.renderTarget.height-(t+n));var l=this.sanitizeRect(i,t,e,n);return this.renderTarget.colorBuffer.read(l.x,l.y,l.z,l.w,{renderTarget:this.renderTarget,immediate:!0}).then(function(u){return s.decodePixels(u,s.mapping)})},a.sanitizeRect=function(i,t,e,n){var r=this.renderTarget.width,s=this.renderTarget.height;return i=U.clamp(Math.floor(i),0,r-1),t=U.clamp(Math.floor(t),0,s-1),e=Math.min(e=Math.floor(Math.max(e,1)),r-i),n=Math.min(n=Math.floor(Math.max(n,1)),s-t),ER.set(i,t,e,n)},a.decodePixels=function(i,t){var e=[];if(this.deviceValid){for(var n=i.length,r=0;r<n;r+=4){var s=i[r+0],l=i[r+1],u=i[r+2],c=(i[r+3]<<24|s<<16|l<<8|u)>>>0;c!==4294967295&&$p.add(t.get(c))}$p.forEach(function(h){h&&e.push(h)}),$p.clear()}return e},a.allocateRenderTarget=function(){var i=new ee(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new Ee({colorBuffer:i,depth:!0})},a.releaseRenderTarget=function(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)},a.prepare=function(i,t,e){n=e,(Ye!=null&&typeof Symbol<"u"&&Ye[Symbol.hasInstance]?Ye[Symbol.hasInstance](n):Q(n,Ye))&&(e=[e]),this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();var n,r=this.renderPass;r.init(this.renderTarget),r.colorOps.clearValue=B.WHITE,r.colorOps.clear=!0,r.depthStencilOps.clearDepth=!0,r.update(i,t,e,this.mapping),r.render()},a.resize=function(i,t){this.width=Math.floor(i),this.height=Math.floor(t)},o}();function Kw(o,a){return(Kw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var AR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t){return o.call(this,t,"scenesettings")||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&Kw(a,o);var i=a.prototype;return i.load=function(t,e){Ip.load(t,this.maxRetries,e)},i.open=function(t,e){return e.settings},a}(Oe);function em(o,a){if(typeof a!="function"&&a!==null)throw TypeError("Super expression must either be null or a function");o.prototype=Object.create(a&&a.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),a&&Zw(o,a)}function Zw(o,a){return(Zw=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var tm=new E,Qw=new E,ii=new Gn,El=new Gn,nm=new Gn;ii.end=new E,El.end=new E,nm.end=new E;var Na=new E,jc=new E,im=new E,Jw=new E,rm=new E,Xc=new E,Yc=new E,qc=new E,Kc=new E,sm=new E,CR=new E,Fa=new E,wl=new E,Zc=new E,Qc=new E,Al=new E,$w=new E,eA=new E,tA=new E,nA=new E,PR=new q;function iA(o,a,i){return CR.cross(o,a).dot(i)}var Jc=function(){function o(a,i,t){this.event=a,this.element=i,this.camera=t,this._stopPropagation=!1}return o.prototype.stopPropagation=function(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())},o}(),Ua=function(o){function a(i,t,e,n,r,s,l){var u;return(u=o.call(this,i,t,e)||this).x=n,u.y=r,u.ctrlKey=i.ctrlKey||!1,u.altKey=i.altKey||!1,u.shiftKey=i.shiftKey||!1,u.metaKey=i.metaKey||!1,u.button=i.button,yi.isPointerLocked()?(u.dx=i.movementX||i.webkitMovementX||i.mozMovementX||0,u.dy=i.movementY||i.webkitMovementY||i.mozMovementY||0):(u.dx=n-s,u.dy=r-l),u.wheelDelta=0,i.type==="wheel"&&(i.deltaY>0?u.wheelDelta=1:i.deltaY<0&&(u.wheelDelta=-1)),u}return em(a,o),a}(Jc),Ba=function(o){function a(i,t,e,n,r,s){var l;return(l=o.call(this,i,t,e)||this).touches=i.touches,l.changedTouches=i.changedTouches,l.x=n,l.y=r,l.touch=s,l}return em(a,o),a}(Jc),Gi=function(o){function a(i,t,e,n){var r;return(r=o.call(this,i,t,e)||this).inputSource=n,r}return em(a,o),a}(Jc),rA=function(){function o(t,e){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!e||e.useMouse!==!1,this._useTouch=!e||e.useTouch!==!1,this._useXr=!e||e.useXr!==!1,this._selectEventsAttached=!1,fe.touch&&(this._clickedEntities={}),this.attach(t)}var a,i=o.prototype;return i.attach=function(t){this._attached&&(this._attached=!1,this.detach()),this._target=t,this._attached=!0;var e=!!fe.passiveEvents&&{passive:!0};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)),this._useTouch&&fe.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,e),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()},i.attachSelectEvents=function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},i.detach=function(){if(this._attached){this._attached=!1;var t=!!fe.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,t),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}},i.addElement=function(t){this._elements.indexOf(t)===-1&&this._elements.push(t)},i.removeElement=function(t){var e=this._elements.indexOf(t);e!==-1&&this._elements.splice(e,1)},i._handleUp=function(t){this._enabled&&(yi.isPointerLocked()||(this._calcMouseCoords(t),this._onElementMouseEvent("mouseup",t)))},i._handleDown=function(t){this._enabled&&(yi.isPointerLocked()||(this._calcMouseCoords(t),this._onElementMouseEvent("mousedown",t)))},i._handleMove=function(t){this._enabled&&(this._calcMouseCoords(t),this._onElementMouseEvent("mousemove",t),this._lastX=Qi,this._lastY=Ji)},i._handleWheel=function(t){this._enabled&&(this._calcMouseCoords(t),this._onElementMouseEvent("mousewheel",t))},i._determineTouchedElements=function(t){for(var e={},n=this.app.systems.camera.cameras,r=n.length-1;r>=0;r--){for(var s=n[r],l=0,u=t.changedTouches.length,c=0;c<u;c++){if(e[t.changedTouches[c].identifier]){l++;continue}var h=bo(t.changedTouches[c]),f=this._getTargetElementByCoords(s,h.x,h.y);f&&(l++,e[t.changedTouches[c].identifier]={element:f,camera:s,x:h.x,y:h.y})}if(l===u)break}return e},i._handleTouchStart=function(t){if(this._enabled){for(var e=this._determineTouchedElements(t),n=0,r=t.changedTouches.length;n<r;n++){var s=t.changedTouches[n],l=e[s.identifier],u=this._touchedElements[s.identifier];l&&(!u||l.element!==u.element)&&(this._fireEvent(t.type,new Ba(t,l.element,l.camera,l.x,l.y,s)),this._touchesForWhichTouchLeaveHasFired[s.identifier]=!1)}for(var c in e)this._touchedElements[c]=e[c]}},i._handleTouchEnd=function(t){if(this._enabled){var e=this.app.systems.camera.cameras;for(var n in this._clickedEntities)delete this._clickedEntities[n];for(var r=0,s=t.changedTouches.length;r<s;r++){var l=t.changedTouches[r],u=this._touchedElements[l.identifier];if(u){var c=u.element,h=u.camera,f=u.x,d=u.y;delete this._touchedElements[l.identifier],delete this._touchesForWhichTouchLeaveHasFired[l.identifier];for(var p=bo(l),_=e.length-1;_>=0;_--)this._getTargetElementByCoords(e[_],p.x,p.y)!==c||this._clickedEntities[c.entity.getGuid()]||(this._fireEvent("click",new Ba(t,c,h,f,d,l)),this._clickedEntities[c.entity.getGuid()]=Date.now());this._fireEvent(t.type,new Ba(t,c,h,f,d,l))}}}},i._handleTouchMove=function(t){if(t.preventDefault(),this._enabled)for(var e=this._determineTouchedElements(t),n=0,r=t.changedTouches.length;n<r;n++){var s=t.changedTouches[n],l=e[s.identifier],u=this._touchedElements[s.identifier];if(u){var c=bo(s);l&&l.element===u.element||this._touchesForWhichTouchLeaveHasFired[s.identifier]||(this._fireEvent("touchleave",new Ba(t,u.element,u.camera,c.x,c.y,s)),this._touchesForWhichTouchLeaveHasFired[s.identifier]=!0),this._fireEvent("touchmove",new Ba(t,u.element,u.camera,c.x,c.y,s))}}},i._onElementMouseEvent=function(t,e){var n,r=null,s=this._hoveredElement;this._hoveredElement=null;for(var l=this.app.systems.camera.cameras,u=l.length-1;u>=0&&(n=l[u],!(r=this._getTargetElementByCoords(n,Qi,Ji)));u--);if(this._hoveredElement=r,(t==="mousemove"||t==="mouseup")&&this._pressedElement?this._fireEvent(t,new Ua(e,this._pressedElement,n,Qi,Ji,this._lastX,this._lastY)):r&&(this._fireEvent(t,new Ua(e,r,n,Qi,Ji,this._lastX,this._lastY)),t==="mousedown"&&(this._pressedElement=r)),s!==this._hoveredElement&&(s&&this._fireEvent("mouseleave",new Ua(e,s,n,Qi,Ji,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Ua(e,this._hoveredElement,n,Qi,Ji,this._lastX,this._lastY))),t==="mouseup"&&this._pressedElement){if(this._pressedElement===this._hoveredElement){var c=this._hoveredElement.entity.getGuid(),h=!this._clickedEntities;if(this._clickedEntities){var f=this._clickedEntities[c]||0;h=Date.now()-f>300,delete this._clickedEntities[c]}h&&this._fireEvent("click",new Ua(e,this._hoveredElement,n,Qi,Ji,this._lastX,this._lastY))}this._pressedElement=null}},i._onXrStart=function(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)},i._onXrEnd=function(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)},i._onXrUpdate=function(){if(this._enabled)for(var t=this.app.xr.input.inputSources,e=0;e<t.length;e++)this._onElementSelectEvent("selectmove",t[e],null)},i._onXrInputRemove=function(t){var e=this._selectedElements[t.id];e&&(t._elementEntity=null,this._fireEvent("selectleave",new Gi(null,e,null,t))),delete this._selectedElements[t.id],delete this._selectedPressedElements[t.id]},i._onSelectStart=function(t,e){this._enabled&&this._onElementSelectEvent("selectstart",t,e)},i._onSelectEnd=function(t,e){this._enabled&&this._onElementSelectEvent("selectend",t,e)},i._onElementSelectEvent=function(t,e,n){var r,s,l,u=this._selectedElements[e.id],c=this.app.systems.camera.cameras;if(e.elementInput){nm.set(e.getOrigin(),e.getDirection());for(var h=c.length-1;h>=0&&(l=c[h],!(r=this._getTargetElementByRay(nm,l)));h--);}e._elementEntity=r||null,r?(this._selectedElements[e.id]=r,s=r):delete this._selectedElements[e.id],u!==s&&(u&&this._fireEvent("selectleave",new Gi(n,u,l,e)),s&&this._fireEvent("selectenter",new Gi(n,s,l,e)));var f=this._selectedPressedElements[e.id];t==="selectmove"&&f&&this._fireEvent("selectmove",new Gi(n,f,l,e)),t==="selectstart"&&(this._selectedPressedElements[e.id]=s,s&&this._fireEvent("selectstart",new Gi(n,s,l,e))),!e.elementInput&&f&&(delete this._selectedPressedElements[e.id],u&&this._fireEvent("selectend",new Gi(n,f,l,e))),t==="selectend"&&e.elementInput&&(delete this._selectedPressedElements[e.id],f&&this._fireEvent("selectend",new Gi(n,f,l,e)),f&&f===u&&this._fireEvent("click",new Gi(n,f,l,e)))},i._fireEvent=function(t,e){for(var n=e.element;n.fire(t,e),!e._stopPropagation&&n.entity.parent&&(n=n.entity.parent.element););},i._calcMouseCoords=function(t){var e=this._target.getBoundingClientRect(),n=Math.floor(e.left),r=Math.floor(e.top);Qi=t.clientX-n,Ji=t.clientY-r},i._sortElements=function(t,e){var n=this.app.scene.layers.sortTransparentLayers(t.layers,e.layers);return n!==0?n:t.screen&&!e.screen?-1:!t.screen&&e.screen?1:t.screen||e.screen?t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?-1:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?1:e.drawOrder-t.drawOrder:0},i._getTargetElementByCoords=function(t,e,n){var r=this._calculateRayScreen(e,n,t,ii)?ii:null,s=this._calculateRay3d(e,n,t,El)?El:null;return this._getTargetElement(t,r,s)},i._getTargetElementByRay=function(t,e){ii.origin.copy(t.origin),ii.direction.copy(t.direction),ii.end.copy(ii.direction).mulScalar(2*e.farClip).add(ii.origin);var n=e.worldToScreen(ii.origin,tm),r=this._calculateRayScreen(n.x,n.y,e,El)?El:null;return this._getTargetElement(e,r,ii)},i._getTargetElement=function(t,e,n){var r=null,s=1/0;this._elements.sort(this._sortHandler);for(var l=0,u=this._elements.length;l<u;l++){var c=this._elements[l];if(c.layers.some(function(f){return t.layersSet.has(f)}))if(c.screen&&c.screen.screen.screenSpace){if(!e)continue;if(this._checkElement(e,c,!0)>=0){r=c;break}}else{if(!n)continue;var h=this._checkElement(n,c,!1);if(h>=0&&(h<s&&(r=c,s=h),c.screen)){r=c;break}}}return r},i._calculateRayScreen=function(t,e,n,r){var s=this.app.graphicsDevice.width,l=this.app.graphicsDevice.height,u=n.rect.z*s,c=n.rect.w*l,h=n.rect.x*s,f=(1-n.rect.y)*l,d=f-c,p=t*s/this._target.clientWidth,_=e*l/this._target.clientHeight;return p>=h&&p<=h+u&&_<=f&&_>=d&&(p=s*(p-h)/u,_=l*(_-d)/c,_=l-_,r.origin.set(p,_,1),r.direction.set(0,0,-1),r.end.copy(r.direction).mulScalar(2).add(r.origin),!0)},i._calculateRay3d=function(t,e,n,r){var s=this._target.clientWidth,l=this._target.clientHeight,u=n.rect.z*s,c=n.rect.w*l,h=n.rect.x*s,f=(1-n.rect.y)*l,d=f-c,p=t,_=e;return t>=h&&t<=h+u&&e<=f&&_>=d&&(p=s*(p-h)/u,_=l*(_-d)/c,n.screenToWorld(p,_,n.nearClip,tm),n.screenToWorld(p,_,n.farClip,Qw),r.origin.copy(tm),r.direction.set(0,0,-1),r.end.copy(Qw),!0)},i._checkElement=function(t,e,n){if(e.maskedBy&&0>this._checkElement(t,e.maskedBy.element,n))return-1;var r=n?o.calculateScaleToScreen(e):o.calculateScaleToWorld(e),s=o.buildHitCorners(e,n?e.screenCorners:e.worldCorners,r);return function(l,u,c){Na.sub2(u,l),jc.sub2(c[0],l),im.sub2(c[1],l),Jw.sub2(c[2],l),Xc.cross(Jw,Na);var h,f,d=jc.dot(Xc);if(d>=0){if((h=-im.dot(Xc))<0||(f=iA(Na,im,jc))<0)return-1;var p=1/(h+d+f);Yc.copy(c[0]).mulScalar(h*p),qc.copy(c[1]).mulScalar(d*p),Kc.copy(c[2]).mulScalar(f*p),sm.copy(Yc).add(qc).add(Kc)}else{if(rm.sub2(c[3],l),(h=rm.dot(Xc))<0||(f=iA(Na,jc,rm))<0)return-1;var _=1/(h+(d=-d)+f);Yc.copy(c[0]).mulScalar(h*_),qc.copy(c[3]).mulScalar(d*_),Kc.copy(c[2]).mulScalar(f*_),sm.copy(Yc).add(qc).add(Kc)}return 1e-8>Na.sub2(c[0],c[2]).lengthSq()||1e-8>Na.sub2(c[1],c[3]).lengthSq()?-1:sm.sub(l).lengthSq()}(t.origin,t.end,s)},o.buildHitCorners=function(t,e,n){var r=e;if(t.entity&&t.entity.button){var s=t.entity.button.hitPadding||PR;wl.copy(t.entity.up),Zc.copy(wl).mulScalar(-1),Al.copy(t.entity.right),Qc.copy(Al).mulScalar(-1),wl.mulScalar(s.w*n.y),Zc.mulScalar(s.y*n.y),Al.mulScalar(s.z*n.x),Qc.mulScalar(s.x*n.x),$w.copy(r[0]).add(Zc).add(Qc),eA.copy(r[1]).add(Zc).add(Al),tA.copy(r[2]).add(wl).add(Al),nA.copy(r[3]).add(wl).add(Qc),r=[$w,eA,tA,nA]}if(n.x<0){var l=r[2].x,u=r[0].x;r[0].x=l,r[1].x=u,r[2].x=u,r[3].x=l}if(n.y<0){var c=r[2].y,h=r[0].y;r[0].y=c,r[1].y=c,r[2].y=h,r[3].y=h}if(n.z<0){var f=r[2].x,d=r[2].y,p=r[2].z;r[2].x=r[0].x,r[2].y=r[0].y,r[2].z=r[0].z,r[0].x=f,r[0].y=d,r[0].z=p}return r},o.calculateScaleToScreen=function(t){var e=t.entity,n=t.screen.screen.scale;for(Fa.set(n,n,n);e&&!e.screen;)Fa.mul(e.getLocalScale()),e=e.parent;return Fa},o.calculateScaleToWorld=function(t){var e=t.entity;for(Fa.set(1,1,1);e;)Fa.mul(e.getLocalScale()),e=e.parent;return Fa},a=[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"app",get:function(){return this._app||xt},set:function(t){this._app=t}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();G.prototype.scale=G.prototype.mulScalar,E.prototype.scale=E.prototype.mulScalar,q.prototype.scale=q.prototype.mulScalar;var IR=new q;Object.defineProperties(Ee.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(o){}}}),Object.defineProperty(Ot,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(ee.prototype,{rgbm:{get:function(){return this.type===Wn},set:function(o){this.type=o?Wn:Wt}},swizzleGGGR:{get:function(){return this.type===ks},set:function(o){this.type=o?ks:Wt}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(Ie.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(Ie.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(Ie.prototype,"textureFloatHighPrecision",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"extBlendMinmax",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"extTextureHalfFloat",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"extTextureLod",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"textureHalfFloatFilterable",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"supportsMrt",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"supportsVolumeTextures",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"supportsInstancing",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"textureHalfFloatUpdatable",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"extTextureFloat",{get:function(){return!0}}),Object.defineProperty(Ie.prototype,"extStandardDerivatives",{get:function(){return!0}}),ge.DEFAULT=Object.freeze(new ge);var Ze=new ge,Hi=new Xe;Ie.prototype.setBlendFunction=function(o,a){var i=this.blendState;Ze.copy(i),Ze.setColorBlend(i.colorOp,o,a),Ze.setAlphaBlend(i.alphaOp,o,a),this.setBlendState(Ze)},Ie.prototype.setBlendFunctionSeparate=function(o,a,i,t){var e=this.blendState;Ze.copy(e),Ze.setColorBlend(e.colorOp,o,a),Ze.setAlphaBlend(e.alphaOp,i,t),this.setBlendState(Ze)},Ie.prototype.setBlendEquation=function(o){var a=this.blendState;Ze.copy(a),Ze.setColorBlend(o,a.colorSrcFactor,a.colorDstFactor),Ze.setAlphaBlend(o,a.alphaSrcFactor,a.alphaDstFactor),this.setBlendState(Ze)},Ie.prototype.setBlendEquationSeparate=function(o,a){var i=this.blendState;Ze.copy(i),Ze.setColorBlend(o,i.colorSrcFactor,i.colorDstFactor),Ze.setAlphaBlend(a,i.alphaSrcFactor,i.alphaDstFactor),this.setBlendState(Ze)},Ie.prototype.setColorWrite=function(o,a,i,t){var e=this.blendState;Ze.copy(e),Ze.setColorWrite(o,a,i,t),this.setBlendState(Ze)},Ie.prototype.getBlending=function(){return this.blendState.blend},Ie.prototype.setBlending=function(o){Ze.copy(this.blendState),Ze.blend=o,this.setBlendState(Ze)},Ie.prototype.setDepthWrite=function(o){Hi.copy(this.depthState),Hi.write=o,this.setDepthState(Hi)},Ie.prototype.setDepthFunc=function(o){Hi.copy(this.depthState),Hi.func=o,this.setDepthState(Hi)},Ie.prototype.setDepthTest=function(o){Hi.copy(this.depthState),Hi.test=o,this.setDepthState(Hi)},Ie.prototype.getCullMode=function(){return this.cullMode};var LR=new Proxy({},{get:function(o,a){return re.get(xt.graphicsDevice,ue).get(a)},set:function(o,a,i){return re.get(xt.graphicsDevice,ue).set(a,i),!0}});function gt(o,a,i){Object.defineProperty(o.prototype,a,{set:function(t){},get:function(){}})}function Mn(o,a){Object.defineProperty(it.prototype,a,{get:function(){return this[o]},set:function(i){this[o]=i}})}function $c(o){Object.defineProperty(it.prototype,o,{get:function(){return!0},set:function(a){}})}function sA(o,a){o!=="pass"&&Object.defineProperty(Zr.prototype,o,{get:function(){return this.litOptions[a||o]},set:function(i){this.litOptions[a||o]=i}})}Object.defineProperty($e.prototype,"defaultMaterial",{get:function(){return Ks(xt.graphicsDevice)}}),Object.defineProperty($e.prototype,"fogColor",{set:function(o){this.fog.color=o},get:function(){return this.fog.color}}),Object.defineProperty($e.prototype,"fogEnd",{set:function(o){this.fog.end=o},get:function(){return this.fog.end}}),Object.defineProperty($e.prototype,"fogStart",{set:function(o){this.fog.start=o},get:function(){return this.fog.start}}),Object.defineProperty($e.prototype,"fogDensity",{set:function(o){this.fog.density=o},get:function(){return this.fog.density}}),Object.defineProperty($e.prototype,"toneMapping",{set:function(o){},get:function(){}}),Object.defineProperty($e.prototype,"gammaCorrection",{set:function(o){},get:function(){}}),Object.defineProperty($e.prototype,"rendering",{set:function(o){},get:function(){}}),Object.defineProperty(Ru.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty($e.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach(function(o,a){Object.defineProperty($e.prototype,"skyboxPrefiltered"+o,{get:function(){return this._prefilteredCubemaps[a]},set:function(i){this._prefilteredCubemaps[a]=i,this.updateShaders=!0}})}),Object.defineProperty($e.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),gt(Ye,"renderTarget"),gt(Ye,"onPreCull"),gt(Ye,"onPreRender"),gt(Ye,"onPreRenderOpaque"),gt(Ye,"onPreRenderTransparent"),gt(Ye,"onPostCull"),gt(Ye,"onPostRender"),gt(Ye,"onPostRenderOpaque"),gt(Ye,"onPostRenderTransparent"),gt(Ye,"onDrawCall"),gt(Ye,"layerReference"),gt(Vi,"onPreCull"),gt(Vi,"onPostCull"),gt(Vi,"onPreRender"),gt(Vi,"onPostRender"),gt(Vi,"onPreRenderLayer"),gt(Vi,"onPostRenderLayer"),id.prototype.renderComposition=function(o){xt.renderComposition(o)},De.prototype.syncAabb=function(){},ku.prototype.getTarget=function(o){return this.targets[o]},pe.prototype.getChildren=function(){return this.children},pe.prototype.getName=function(){return this.name},pe.prototype.getPath=function(){return this.path},pe.prototype.getRoot=function(){return this.root},pe.prototype.getParent=function(){return this.parent},pe.prototype.setName=function(o){this.name=o},Object.defineProperty(Ci.prototype,"shader",{set:function(o){},get:function(){return null}}),Object.defineProperty(Ci.prototype,"blend",{set:function(o){this.blendState.blend=o},get:function(){return this.blendState.blend}}),Object.defineProperty(it.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(o){this.gloss=.01*o}}),Object.defineProperty(it.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(o){this.useTonemap=o}}),Object.defineProperty(it.prototype,"anisotropy",{get:function(){var o=Math.sign(Math.cos(this.anisotropyRotation*U.DEG_TO_RAD*2));return this.anisotropyIntensity*o},set:function(o){this.anisotropyIntensity=Math.abs(o),o>=0?this.anisotropyRotation=0:this.anisotropyRotation=90}}),$c("sheenTint"),$c("diffuseTint"),$c("emissiveTint"),$c("ambientTint"),Mn("specularTint","specularMapTint"),Mn("aoVertexColor","aoMapVertexColor"),Mn("diffuseVertexColor","diffuseMapVertexColor"),Mn("specularVertexColor","specularMapVertexColor"),Mn("emissiveVertexColor","emissiveMapVertexColor"),Mn("metalnessVertexColor","metalnessMapVertexColor"),Mn("glossVertexColor","glossMapVertexColor"),Mn("opacityVertexColor","opacityMapVertexColor"),Mn("lightVertexColor","lightMapVertexColor"),Mn("sheenGloss","sheenGlossiess"),Mn("clearCoatGloss","clearCostGlossiness"),sA("refraction","useRefraction");var aA=Object.getOwnPropertyNames(new Wo);for(var DR in aA)sA(aA[DR]);Jr.prototype.getAssetById=function(o){return this.get(o)},Object.defineProperty(Lt.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(Lt.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(Lt.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(rA.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(Xs.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Pn.prototype.isFullscreen=function(){return!!document.fullscreenElement},Pn.prototype.enableFullscreen=function(o,a,i){o=o||this.graphicsDevice.canvas;var t=function(){a(),document.removeEventListener("fullscreenchange",t)},e=function(){i(),document.removeEventListener("fullscreenerror",e)};a&&document.addEventListener("fullscreenchange",t,!1),i&&document.addEventListener("fullscreenerror",e,!1),o.requestFullscreen?o.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},Pn.prototype.disableFullscreen=function(o){var a=function(){o(),document.removeEventListener("fullscreenchange",a)};o&&document.addEventListener("fullscreenchange",a,!1),document.exitFullscreen()},Pn.prototype.getSceneUrl=function(o){var a=this.scenes.find(o);return a?a.url:null},Pn.prototype.loadScene=function(o,a){this.scenes.loadScene(o,a)},Pn.prototype.loadSceneHierarchy=function(o,a){this.scenes.loadSceneHierarchy(o,a)},Pn.prototype.loadSceneSettings=function(o,a){this.scenes.loadSceneSettings(o,a)},Sc.prototype.setVisible=function(o){this.enabled=o},Object.defineProperty(tn.prototype,"bodyType",{get:function(){return this.type},set:function(o){this.type=o}}),tn.prototype.syncBodyToEntity=function(){this._updateDynamic()},Ec.prototype.setGravity=function(){arguments.length==1?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};var MR=function(){function o(t){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,t.on("frameupdate",this.begin.bind(this,"update")),t.on("framerender",this.mark.bind(this,"render")),t.on("frameend",this.mark.bind(this,"other"))}var a,i=o.prototype;return i.begin=function(t){if(this.enabled){this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);var e=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=e,this._frameIndex=0,this.mark(t)}},i.mark=function(t){if(this.enabled){var e=un();if(this._frameIndex>0){var n=this._frameTimings[this._frameIndex-1];n[1]=e-n[1]}else if(this._timings.length>0){var r=this._timings[this._timings.length-1];r[1]=e-r[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([t,e]);else{var s=this._frameTimings[this._frameIndex];s[0]=t,s[1]=e}this._frameIndex++}},a=[{key:"timings",get:function(){return this._timings.slice(0,-1).map(function(t){return t[1]})}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),RR=function(){var o;function a(i){this.device=i,i.gpuProfiler.enabled=!0,this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}return o=[{key:"timings",get:function(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),OR=function(){var o;function a(i,t,e,n,r){var s=this;this.app=i,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=n,this.decimalPlaces=e,this.multiplier=r||1,i.on("frameupdate",function(l){for(var u,c,h=0;h<s.statNames.length;h++)s.values[h]=(u=s.statNames[h],c=s.app.stats,u.split(".").reduce(function(f,d){return f?f[d]:null},c||s)*s.multiplier)})}return o=[{key:"timings",get:function(){return this.values}}],function(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,n.key,n)}}(a.prototype,o),a}(),am=function(){function o(i,t,e,n,r){this.app=t,this.name=i,this.device=t.graphicsDevice,this.timer=r,this.watermark=e,this.enabled=!1,this.textRefreshRate=n,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}var a=o.prototype;return a.destroy=function(){this.app.off("frameupdate",this.update,this)},a.loseContext=function(){this.timer&&typeof this.timer.loseContext=="function"&&this.timer.loseContext()},a.update=function(i){var t=this.timer.timings,e=t.reduce(function(l,u){return l+u},0);if(this.avgTotal+=e,this.avgTimer+=i,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){for(var n=0,r=1.5*this.watermark,s=0;s<t.length;++s)n+=Math.floor(t[s]/r*255),this.sample[s]=n;this.sample[3]=this.watermark/r*255,this.texture.lock().set(this.sample,(this.cursor+this.yOffset*this.texture.width)*4),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}},a.render=function(i,t,e,n,r){i.quad(t+n,e,-n,r,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-n,0,this.texture,0)},o}(),kR=function(){function o(i,t){var e=function(f){f.font='10px "Lucida Console", Monaco, monospace',f.textAlign="left",f.textBaseline="alphabetic"},n=document.createElement("canvas"),r=n.getContext("2d",{alpha:!0});e(r);var s=new Map,l=5,u=5;t.forEach(function(f){var d=r.measureText(f),p=Math.ceil(-d.actualBoundingBoxLeft),_=Math.ceil(d.actualBoundingBoxRight),g=Math.ceil(d.actualBoundingBoxAscent),y=Math.ceil(d.actualBoundingBoxDescent),v=p+_;l+v+5>=512&&(l=5,u+=16),s.set(f,{l:p,r:_,a:g,d:y,w:v,h:g+y,x:l,y:u}),l+=v+5}),n.width=512,n.height=U.nextPowerOfTwo(u+16+5),e(r),r.fillStyle="rgb(0, 0, 0)",r.fillRect(0,0,n.width,n.height),s.forEach(function(f,d){r.fillStyle=d==="."||d.length===1&&d.charCodeAt(0)>=48&&57>=d.charCodeAt(0)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",r.fillText(d,f.x-f.l,f.y+f.a)}),this.placements=s;for(var c=r.getImageData(0,0,n.width,n.height).data,h=0;h<c.length;h+=4)c[h+3]=c[h+0],c[h+0]=255,c[h+1]=255,c[h+2]=255;this.texture=new ee(i,{name:"mini-stats-word-atlas",width:n.width,height:n.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[c]})}var a=o.prototype;return a.destroy=function(){this.texture.destroy(),this.texture=null},a.render=function(i,t,e,n){var r=this.placements.get(t);return r?(i.quad(e+r.l-1,n-r.d+1,r.w+2,r.h+2,r.x-1,this.texture.height-r.y-r.h-1,void 0,void 0,this.texture,1),r.w):0},o}(),NR=function(){function o(i,t){t===void 0&&(t=512);for(var e=new Ot(i,[{semantic:oe,components:3,type:6},{semantic:mt,components:4,type:6}]),n=new Uint16Array(6*t),r=0;r<t;++r)n[6*r+0]=4*r,n[6*r+1]=4*r+1,n[6*r+2]=4*r+2,n[6*r+3]=4*r,n[6*r+4]=4*r+2,n[6*r+5]=4*r+3;this.device=i,this.buffer=new Rt(i,e,4*t,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new Yn(i,1,6*t,0,n),this.prim={type:4,indexed:!0,base:0,count:0},this.quads=0,this.mesh=new ye(i),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];var s=new hr({uniqueName:"MiniStats",vertexGLSL:`
	attribute vec3 vertex_position;
	attribute vec4 vertex_texCoord0;
	varying vec4 uv0;
	varying float wordFlag;
	void main(void) {
		gl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		uv0 = vertex_texCoord0;
		wordFlag = vertex_position.z;
	}
`,fragmentGLSL:`
	varying vec4 uv0;
	varying float wordFlag;
	uniform vec4 clr;
	uniform sampler2D graphTex;
	uniform sampler2D wordsTex;
	void main (void) {
		vec4 graphSample = texture2D(graphTex, uv0.xy);
		vec4 graph;
		if (uv0.w < graphSample.r)
			graph = vec4(0.7, 0.2, 0.2, 1.0);
		else if (uv0.w < graphSample.g)
			graph = vec4(0.2, 0.7, 0.2, 1.0);
		else if (uv0.w < graphSample.b)
			graph = vec4(0.2, 0.2, 0.7, 1.0);
		else
			graph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));
		vec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));
		gl_FragColor = mix(graph, words, wordFlag) * clr;
	}
`,vertexWGSL:`
	attribute vertex_position: vec3f;
	attribute vertex_texCoord0: vec4f;
	varying uv0: vec4f;
	varying wordFlag: f32;
	@vertex fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		output.uv0 = input.vertex_texCoord0;
		output.wordFlag = input.vertex_position.z;
		return output;
	}
`,fragmentWGSL:`
	varying uv0: vec4f;
	varying wordFlag: f32;
	uniform clr: vec4f;
	var graphTex : texture_2d<f32>;
	var graphTex_sampler : sampler;
	var wordsTex : texture_2d<f32>;
	var wordsTex_sampler : sampler;
	@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var uv0: vec4f = input.uv0;
		var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);
		var graph: vec4f;
		if (uv0.w < graphSample.r) {
			graph = vec4f(0.7, 0.2, 0.2, 1.0);
		} else if (uv0.w < graphSample.g) {
			graph = vec4f(0.2, 0.7, 0.2, 1.0);
		} else if (uv0.w < graphSample.b) {
			graph = vec4f(0.2, 0.2, 0.7, 1.0);
		} else {
			graph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));
		}
		var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));
		var output: FragmentOutput;
		output.color = mix(graph, words, input.wordFlag) * uniform.clr;
		return output;
	}
`,attributes:{vertex_position:oe,vertex_texCoord0:mt}});this.material=s,s.cull=0,s.depthState=Xe.NODEPTH,s.blendState=new ge(!0,0,6,8,0,1,1),s.update(),this.meshInstance=new De(this.mesh,s,new pe("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:i.width,height:i.height}}var a=o.prototype;return a.quad=function(i,t,e,n,r,s,l,u,c,h){h===void 0&&(h=0);var f=this.targetSize.width,d=this.targetSize.height,p=i/f,_=t/d,g=(i+e)/f,y=(t+n)/d,v=c.width,x=c.height,S=r/v,T=s/x,b=(r+(l??e))/v,w=(s+(u??n))/x;this.data.set([p,_,h,S,T,0,0,g,_,h,b,T,1,0,g,y,h,b,w,1,1,p,y,h,S,w,0,1],28*this.quads),this.quads++,this.prim.count+=6},a.startFrame=function(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight},a.render=function(i,t,e,n,r,s){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(r,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",e),this.material.setParameter("wordsTex",n),i.drawMeshInstance(this.meshInstance,t)},o}(),FR=function(){function o(t,e){var n=this,r=t.graphicsDevice;e=e||o.getDefaultOptions(),this.initGraphs(t,r,e);var s=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map(function(u){return u.name})).concat(e.stats?e.stats.map(function(u){return u.unitsName}):[]).filter(function(u){return!!u}));this.wordAtlas=new kR(r,s),this.sizes=e.sizes,this._activeSizeIndex=e.startSizeIndex;var l=document.createElement("div");l.setAttribute("id","mini-stats"),l.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(l),l.addEventListener("mouseenter",function(u){n.opacity=1}),l.addEventListener("mouseleave",function(u){n.opacity=.7}),l.addEventListener("click",function(u){u.preventDefault(),n._enabled&&(n.activeSizeIndex=(n.activeSizeIndex+1)%n.sizes.length,n.resize(n.sizes[n.activeSizeIndex].width,n.sizes[n.activeSizeIndex].height,n.sizes[n.activeSizeIndex].graphs))}),r.on("resizecanvas",this.updateDiv,this),r.on("losecontext",this.loseContext,this),t.on("postrender",this.postRender,this),this.app=t,this.drawLayer=t.scene.layers.getLayerById(4),this.device=r,this.render2d=new NR(r),this.div=l,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}var a,i=o.prototype;return i.destroy=function(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(function(t){return t.destroy()}),this.wordAtlas.destroy(),this.texture.destroy()},i.initGraphs=function(t,e,n){var r=this;if(this.graphs=[],n.cpu.enabled){var s=new MR(t),l=new am("CPU",t,n.cpu.watermark,n.textRefreshRate,s);this.graphs.push(l)}if(n.gpu.enabled){var u=new RR(e),c=new am("GPU",t,n.gpu.watermark,n.textRefreshRate,u);this.graphs.push(c)}n.stats&&n.stats.forEach(function(f){var d=new OR(t,f.stats,f.decimalPlaces,f.unitsName,f.multiplier),p=new am(f.name,t,f.watermark,n.textRefreshRate,d);r.graphs.push(p)});var h=n.sizes.reduce(function(f,d){return d.width>f?d.width:f},0);this.texture=new ee(e,{name:"mini-stats-graph-texture",width:U.nextPowerOfTwo(h),height:U.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach(function(f,d){f.texture=r.texture,f.yOffset=d})},i.render=function(){var t=this.graphs,e=this.wordAtlas,n=this.render2d,r=this.width,s=this.height,l=this.gspacing;n.startFrame();for(var u=0;u<t.length;++u){var c=t[u],h=u*(s+l);c.render(n,0,h,r,s);var f=1;h+=s-13,f+=e.render(n,c.name,f,h)+10;for(var d=c.timingText,p=0;p<d.length;++p)f+=e.render(n,d[p],f,h);c.timer.unitsName&&(f+=3,e.render(n,c.timer.unitsName,f,h))}n.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,s)},i.resize=function(t,e,n){for(var r=this.graphs,s=0;s<r.length;++s)r[s].enabled=n;this.width=t,this.height=e,this.updateDiv()},i.updateDiv=function(){var t=this.device.canvas.getBoundingClientRect();this.div.style.left=""+t.left+"px",this.div.style.bottom=""+(window.innerHeight-t.bottom)+"px",this.div.style.width=""+this.width+"px",this.div.style.height=""+this.overallHeight+"px"},i.loseContext=function(){this.graphs.forEach(function(t){return t.loseContext()})},i.postRender=function(){this._enabled&&this.render()},o.getDefaultOptions=function(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}},a=[{key:"activeSizeIndex",get:function(){return this._activeSizeIndex},set:function(t){this._activeSizeIndex=t,this.gspacing=this.sizes[t].spacing,this.resize(this.sizes[t].width,this.sizes[t].height,this.sizes[t].graphs)}},{key:"opacity",get:function(){return this.clr[3]},set:function(t){this.clr[3]=t}},{key:"overallHeight",get:function(){var t=this.graphs,e=this.gspacing;return this.height*t.length+e*(t.length-1)}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(t!==this._enabled){this._enabled=t;for(var e=0;e<this.graphs.length;++e)this.graphs[e].enabled=t,this.graphs[e].timer.enabled=t}}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function oA(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var Va=new Float32Array(2),eh=new B,UR=function(){function o(i,t,e){var n=this;e===void 0&&(e=-1),this.app=i,this.renderingLayer=t??i.scene.layers.getLayerByName("Immediate"),this.rt=this.createRenderTarget("OutlineTexture",1,1,!0),this.outlineCameraEntity=new ve("OutlineCamera"),this.outlineCameraEntity.addComponent("camera",{layers:[this.renderingLayer.id],priority:e,clearColor:new B(0,0,0,0),renderTarget:this.rt}),this.outlineShaderPass=this.outlineCameraEntity.camera.setShaderPass("OutlineShaderPass"),this.postRender=function(s){n.outlineCameraEntity.camera===s&&n.onPostRender()},i.scene.on("postrender",this.postRender),this.app.root.addChild(this.outlineCameraEntity),this.tempRt=this.createRenderTarget("OutlineTempTexture",1,1,!1),this.blendState=new ge(!0,0,6,8);var r=this.app.graphicsDevice;this.shaderExtend=Te.createShader(r,{uniqueName:"OutlineExtendShader",attributes:{vertex_position:oe},vertexGLSL:re.get(r,ue).get("fullscreenQuadVS"),fragmentGLSL:`
	varying vec2 vUv0;
	uniform vec2 uOffset;
	uniform float uSrcMultiplier;
	uniform sampler2D source;
	void main(void)
	{
		vec4 pixel;
		vec4 texel = texture2D(source, vUv0);
		vec4 firstTexel = texel;
		float diff = texel.a * uSrcMultiplier;
		pixel = texture2D(source, vUv0 + uOffset * -2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * -1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
	   gl_FragColor = vec4(texel.rgb, min(diff, 1.0));
	}
`}),this.shaderBlend=Te.createShader(r,{uniqueName:"OutlineBlendShader",attributes:{vertex_position:oe},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"}),this.quadRenderer=new Ys(this.shaderBlend),this.whiteTex=new ee(r,{name:"OutlineWhiteTexture",width:1,height:1,format:20,mipmaps:!1}),this.whiteTex.lock().set(new Uint8Array([255,255,255,255])),this.whiteTex.unlock()}var a=o.prototype;return a.destroy=function(){var i;this.whiteTex.destroy(),this.whiteTex=null,this.outlineCameraEntity.destroy(),this.outlineCameraEntity=null,this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null,this.tempRt.destroyTextureBuffers(),this.tempRt.destroy(),this.tempRt=null,this.app.scene.off("postrender",this.postRender),(i=this.quadRenderer)==null||i.destroy(),this.quadRenderer=null},a.getMeshInstances=function(i,t){var e=[];return i&&((t?i.findComponents("render"):i.render?[i.render]:[]).forEach(function(n){n.meshInstances&&e.push.apply(e,[].concat(n.meshInstances))}),(t?i.findComponents("model"):i.model?[i.model]:[]).forEach(function(n){n.meshInstances&&e.push.apply(e,[].concat(n.meshInstances))})),e},a.addEntity=function(i,t,e){var n=this;e===void 0&&(e=!0);var r=this.getMeshInstances(i,e);r.forEach(function(s){if(oA(s.material,it)){var l=n.outlineShaderPass;s.material.onUpdateShader=function(c){if(c.pass===l){var h=new Zr;return h.defines=c.defines,h.opacityMap=c.opacityMap,h.opacityMapUv=c.opacityMapUv,h.opacityMapChannel=c.opacityMapChannel,h.opacityMapTransform=c.opacityMapTransform,h.opacityVertexColor=c.opacityVertexColor,h.opacityVertexColorChannel=c.opacityVertexColorChannel,h.litOptions.vertexColors=c.litOptions.vertexColors,h.litOptions.alphaTest=c.litOptions.alphaTest,h.litOptions.skin=c.litOptions.skin,h.litOptions.batch=c.litOptions.batch,h.litOptions.useInstancing=c.litOptions.useInstancing,h.litOptions.useMorphPosition=c.litOptions.useMorphPosition,h.litOptions.useMorphNormal=c.litOptions.useMorphNormal,h.litOptions.useMorphTextureBasedInt=c.litOptions.useMorphTextureBasedInt,h.litOptions.opacityFadesSpecular=c.litOptions.opacityFadesSpecular,h}return c},eh.linear(t);var u=new Float32Array([eh.r,eh.g,eh.b]);s.setParameter("material_emissive",u,1<<n.outlineShaderPass),s.setParameter("texture_emissiveMap",n.whiteTex,1<<n.outlineShaderPass)}}),this.renderingLayer.addMeshInstances(r,!0)},a.removeEntity=function(i,t){t===void 0&&(t=!0);var e=this.getMeshInstances(i,t);this.renderingLayer.removeMeshInstances(e),e.forEach(function(n){oA(n.material,it)&&(n.material.onUpdateShader=null,n.deleteParameter("material_emissive"))})},a.removeAllEntities=function(){this.renderingLayer.clearMeshInstances()},a.blendOutlines=function(){var i=this.app.graphicsDevice;i.scope.resolve("source").setValue(this.rt.colorBuffer),i.setDepthState(Xe.NODEPTH),i.setCullMode(0),i.setBlendState(this.blendState),this.quadRenderer.render()},a.onPostRender=function(){var i=this.app.graphicsDevice,t=i.scope.resolve("uOffset"),e=i.scope.resolve("source"),n=i.scope.resolve("uSrcMultiplier"),r=this.rt,s=this.tempRt,l=this.shaderExtend,u=r.width,c=r.height;Va[0]=1/u/2,Va[1]=0,t.setValue(Va),e.setValue(r.colorBuffer),n.setValue(0),kt(i,s,l),Va[0]=0,Va[1]=1/c/2,t.setValue(Va),e.setValue(s.colorBuffer),n.setValue(1),kt(i,r,l)},a.createRenderTarget=function(i,t,e,n){return new Ee({colorBuffer:new ee(this.app.graphicsDevice,{name:i,width:t,height:e,format:20,mipmaps:!1,addressU:1,addressV:1,minFilter:5,magFilter:1}),depth:n,flipY:this.app.graphicsDevice.isWebGPU})},a.updateRenderTarget=function(i){var t,e,n,r,s=(n=(t=i.renderTarget)==null?void 0:t.width)!=null?n:this.app.graphicsDevice.width,l=(r=(e=i.renderTarget)==null?void 0:e.height)!=null?r:this.app.graphicsDevice.height,u=this.outlineCameraEntity.camera;u.renderTarget&&u.renderTarget.width===s&&u.renderTarget.height===l||(this.rt.resize(s,l),this.tempRt.resize(s,l))},a.frameUpdate=function(i,t,e){var n=this,r=i.camera;this.updateRenderTarget(r);var s=this.app.scene.on("prerender:layer",function(u,c,h){r===u&&h===e&&c===t&&(n.blendOutlines(),s.off())});this.outlineCameraEntity.setLocalPosition(i.getPosition()),this.outlineCameraEntity.setLocalRotation(i.getRotation());var l=this.outlineCameraEntity.camera;l.projection=r.projection,l.horizontalFov=r.horizontalFov,l.fov=r.fov,l.orthoHeight=r.orthoHeight,l.nearClip=r.nearClip,l.farClip=r.farClip},o}();function th(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var lA=function(){function o(){}var a=o.prototype;return a.textureToCanvas=function(i,t){t===void 0&&(t={});var e=i.getSource();if(typeof HTMLImageElement<"u"&&th(e,HTMLImageElement)||typeof HTMLCanvasElement<"u"&&th(e,HTMLCanvasElement)||typeof OffscreenCanvas<"u"&&th(e,OffscreenCanvas)||typeof ImageBitmap<"u"&&th(e,ImageBitmap)){var n=this.calcTextureSize(e.width,e.height,t.maxTextureSize),r=n.width,s=n.height,l=document.createElement("canvas");l.width=r,l.height=s;var u=l.getContext("2d");if(u===null)return Promise.resolve(void 0);if(u.drawImage(e,0,0,l.width,l.height),t.color){for(var c=t.color,h=c.r,f=c.g,d=c.b,p=u.getImageData(0,0,r,s),_=p.data,g=0;g<_.length;g+=4)_[g+0]=_[g+0]*h,_[g+1]=_[g+1]*f,_[g+2]=_[g+2]*d;u.putImageData(p,0,0)}return Promise.resolve(l)}var y=i.device,v=this.calcTextureSize(i.width,i.height,t.maxTextureSize),x=v.width,S=v.height,T=new ee(y,{name:"ExtractedTexture",width:x,height:S,format:io(i.format)?7:i.format,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),b=new Ee({colorBuffer:T,depth:!1}),w=Te.createShader(y,{uniqueName:"ShaderCoreExporterBlit",attributes:{vertex_position:oe},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"});return y.scope.resolve("source").setValue(i),y.setBlendState(ge.NOBLEND),kt(y,b,w),T.read(0,0,x,S,{renderTarget:b,immediate:!0}).then(function(A){T.destroy(),b.destroy();var C=new Uint8ClampedArray(x*S*4);C.set(A);var L=new ImageData(C,x,S),I=document.createElement("canvas");I.width=x,I.height=S;var P=I.getContext("2d");return P?(P.putImageData(L,0,0),Promise.resolve(I)):Promise.resolve(void 0)})},a.calcTextureSize=function(i,t,e){if(e){var n=Math.min(e/Math.max(i,t),1);i=Math.round(i*n),t=Math.round(t*n)}return{width:i,height:t}},o}(),ut=Uint8Array,sn=Uint16Array,om=Int32Array,lm=new ut([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),um=new ut([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),uA=new ut([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),cA=function(o,a){for(var i=new sn(31),t=0;t<31;++t)i[t]=a+=1<<o[t-1];for(var e=new om(i[30]),t=1;t<30;++t)for(var n=i[t];n<i[t+1];++n)e[n]=n-i[t]<<5|t;return{b:i,r:e}},hA=cA(lm,2),BR=hA.b,cm=hA.r;BR[28]=258,cm[258]=28;for(var fA=cA(um,0).r,hm=new sn(32768),ze=0;ze<32768;++ze){var vs=(43690&ze)>>1|(21845&ze)<<1;vs=(61680&(vs=(52428&vs)>>2|(13107&vs)<<2))>>4|(3855&vs)<<4,hm[ze]=((65280&vs)>>8|(255&vs)<<8)>>1}for(var gs=function(a,i,t){for(var e,n=a.length,r=0,s=new sn(i);r<n;++r)a[r]&&++s[a[r]-1];var l=new sn(i);for(r=1;r<i;++r)l[r]=l[r-1]+s[r-1]<<1;if(t){e=new sn(1<<i);var u=15-i;for(r=0;r<n;++r)if(a[r])for(var c=r<<4|a[r],h=i-a[r],f=l[a[r]-1]++<<h,d=f|(1<<h)-1;f<=d;++f)e[hm[f]>>u]=c}else for(r=0,e=new sn(n);r<n;++r)a[r]&&(e[r]=hm[l[a[r]-1]++]>>15-a[r]);return e},Er=new ut(288),ze=0;ze<144;++ze)Er[ze]=8;for(var ze=144;ze<256;++ze)Er[ze]=9;for(var ze=256;ze<280;++ze)Er[ze]=7;for(var ze=280;ze<288;++ze)Er[ze]=8;for(var Cl=new ut(32),ze=0;ze<32;++ze)Cl[ze]=5;var VR=gs(Er,9,0);gs(Er,9,1);var zR=gs(Cl,5,0);gs(Cl,5,1);var dA=function(o){return(o+7)/8|0},pA=function(o,a,i){return(i==null||i>o.length)&&(i=o.length),new ut(o.subarray(a,i))},GR=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],nh=function(o,a,i){var t=Error(a||GR[o]);if(t.code=o,Error.captureStackTrace&&Error.captureStackTrace(t,nh),!i)throw t;return t},Wi=function(o,a,i){i<<=7&a;var t=a/8|0;o[t]|=i,o[t+1]|=i>>8},Pl=function(o,a,i){i<<=7&a;var t=a/8|0;o[t]|=i,o[t+1]|=i>>8,o[t+2]|=i>>16},fm=function(o,a){for(var i=[],t=0;t<o.length;++t)o[t]&&i.push({s:t,f:o[t]});var e=i.length,n=i.slice();if(!e)return{t:gA,l:0};if(e==1){var r=new ut(i[0].s+1);return r[i[0].s]=1,{t:r,l:1}}i.sort(function(T,b){return T.f-b.f}),i.push({s:-1,f:25001});var s=i[0],l=i[1],u=0,c=1,h=2;for(i[0]={s:-1,f:s.f+l.f,l:s,r:l};c!=e-1;)s=i[i[u].f<i[h].f?u++:h++],l=i[u!=c&&i[u].f<i[h].f?u++:h++],i[c++]={s:-1,f:s.f+l.f,l:s,r:l};for(var f=n[0].s,t=1;t<e;++t)n[t].s>f&&(f=n[t].s);var d=new sn(f+1),p=dm(i[c-1],d,0);if(p>a){var t=0,_=0,g=p-a,y=1<<g;for(n.sort(function(b,w){return d[w.s]-d[b.s]||b.f-w.f});t<e;++t){var v=n[t].s;if(d[v]>a)_+=y-(1<<p-d[v]),d[v]=a;else break}for(_>>=g;_>0;){var x=n[t].s;d[x]<a?_-=1<<a-d[x]++-1:++t}for(;t>=0&&_;--t){var S=n[t].s;d[S]==a&&(--d[S],++_)}p=a}return{t:new ut(d),l:p}},dm=function(o,a,i){return o.s==-1?Math.max(dm(o.l,a,i+1),dm(o.r,a,i+1)):a[o.s]=i},mA=function(o){for(var a=o.length;a&&!o[--a];);for(var i=new sn(++a),t=0,e=o[0],n=1,r=function(l){i[t++]=l},s=1;s<=a;++s)if(o[s]==e&&s!=a)++n;else{if(!e&&n>2){for(;n>138;n-=138)r(32754);n>2&&(r(n>10?n-11<<5|28690:n-3<<5|12305),n=0)}else if(n>3){for(r(e),--n;n>6;n-=6)r(8304);n>2&&(r(n-3<<5|8208),n=0)}for(;n--;)r(e);n=1,e=o[s]}return{c:i.subarray(0,t),n:a}},Il=function(o,a){for(var i=0,t=0;t<a.length;++t)i+=o[t]*a[t];return i},_A=function(o,a,i){var t=i.length,e=dA(a+2);o[e]=255&t,o[e+1]=t>>8,o[e+2]=255^o[e],o[e+3]=255^o[e+1];for(var n=0;n<t;++n)o[e+n+4]=i[n];return(e+4+t)*8},vA=function(o,a,i,t,e,n,r,s,l,u,c){Wi(a,c++,i),++e[256];for(var h,f,d,p,_=fm(e,15),g=_.t,y=_.l,v=fm(n,15),x=v.t,S=v.l,T=mA(g),b=T.c,w=T.n,A=mA(x),C=A.c,L=A.n,I=new sn(19),P=0;P<b.length;++P)++I[31&b[P]];for(var P=0;P<C.length;++P)++I[31&C[P]];for(var M=fm(I,7),R=M.t,k=M.l,D=19;D>4&&!R[uA[D-1]];--D);var O=u+5<<3,F=Il(e,Er)+Il(n,Cl)+r,N=Il(e,g)+Il(n,x)+r+14+3*D+Il(I,R)+2*I[16]+3*I[17]+7*I[18];if(l>=0&&O<=F&&O<=N)return _A(a,c,o.subarray(l,l+u));if(Wi(a,c,1+(N<F)),c+=2,N<F){h=gs(g,y,0),f=g,d=gs(x,S,0),p=x;var j=gs(R,k,0);Wi(a,c,w-257),Wi(a,c+5,L-1),Wi(a,c+10,D-4),c+=14;for(var P=0;P<D;++P)Wi(a,c+3*P,R[uA[P]]);c+=3*D;for(var z=[b,C],V=0;V<2;++V)for(var H=z[V],P=0;P<H.length;++P){var Y=31&H[P];Wi(a,c,j[Y]),c+=R[Y],Y>15&&(Wi(a,c,H[P]>>5&127),c+=H[P]>>12)}}else h=VR,f=Er,d=zR,p=Cl;for(var P=0;P<s;++P){var W=t[P];if(W>255){var Y=W>>18&31;Pl(a,c,h[Y+257]),c+=f[Y+257],Y>7&&(Wi(a,c,W>>23&31),c+=lm[Y]);var ie=31&W;Pl(a,c,d[ie]),c+=p[ie],ie>3&&(Pl(a,c,W>>5&8191),c+=um[ie])}else Pl(a,c,h[W]),c+=f[W]}return Pl(a,c,h[256]),c+f[256]},HR=new om([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),gA=new ut(0),WR=function(o,a,i,t,e,n){var r=n.z||o.length,s=new ut(t+r+5*(1+Math.ceil(r/7e3))+e),l=s.subarray(t,s.length-e),u=n.l,c=7&(n.r||0);if(a){c&&(l[0]=n.r>>3);for(var h=HR[a-1],f=h>>13,d=8191&h,p=(1<<i)-1,_=n.p||new sn(32768),g=n.h||new sn(p+1),y=Math.ceil(i/3),v=2*y,x=function(Pe){return(o[Pe]^o[Pe+1]<<y^o[Pe+2]<<v)&p},S=new om(25e3),T=new sn(288),b=new sn(32),w=0,A=0,C=n.i||0,L=0,I=n.w||0,P=0;C+2<r;++C){var M=x(C),R=32767&C,k=g[M];if(_[R]=k,g[M]=R,I<=C){var D=r-C;if((w>7e3||L>24576)&&(D>423||!u)){c=vA(o,l,0,S,T,b,A,L,P,C-P,c),L=w=A=0,P=C;for(var O=0;O<286;++O)T[O]=0;for(var O=0;O<30;++O)b[O]=0}var F=2,N=0,j=d,z=R-k&32767;if(D>2&&M==x(C-z))for(var V=Math.min(f,D)-1,H=Math.min(32767,C),Y=Math.min(258,D);z<=H&&--j&&R!=k;){if(o[C+F]==o[C+F-z]){for(var W=0;W<Y&&o[C+W]==o[C+W-z];++W);if(W>F){if(F=W,N=z,W>V)break;for(var ie=Math.min(z,W-2),te=0,O=0;O<ie;++O){var ae=C-z+O&32767,_e=_[ae],xe=ae-_e&32767;xe>te&&(te=xe,k=ae)}}}k=_[R=k],z+=R-k&32767}if(N){S[L++]=268435456|cm[F]<<18|fA[N];var je=31&cm[F],Qe=31&fA[N];A+=lm[je]+um[Qe],++T[257+je],++b[Qe],I=C+F,++w}else S[L++]=o[C],++T[o[C]]}}for(C=Math.max(C,I);C<r;++C)S[L++]=o[C],++T[o[C]];c=vA(o,l,u,S,T,b,A,L,P,C-P,c),u||(n.r=7&c|l[c/8|0]<<3,c-=7,n.h=g,n.p=_,n.i=C,n.w=I)}else{for(var C=n.w||0;C<r+u;C+=65535){var rt=C+65535;rt>=r&&(l[c/8|0]=u,rt=r),c=_A(l,c+1,o.subarray(C,rt))}n.i=r}return pA(s,0,t+dA(c)+e)},jR=function(){for(var o=new Int32Array(256),a=0;a<256;++a){for(var i=a,t=9;--t;)i=(1&i&&-306674912)^i>>>1;o[a]=i}return o}(),XR=function(){var o=-1;return{p:function(a){for(var i=o,t=0;t<a.length;++t)i=jR[255&i^a[t]]^i>>>8;o=i},d:function(){return~o}}},YR=function(o,a,i,t,e){if(!e&&(e={l:1},a.dictionary)){var n=a.dictionary.subarray(-32768),r=new ut(n.length+o.length);r.set(n),r.set(o,n.length),o=r,e.w=n.length}return WR(o,a.level==null?6:a.level,a.mem==null?e.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(o.length)))):20:12+a.mem,i,t,e)},yA=function(o,a){var i={};for(var t in o)i[t]=o[t];for(var t in a)i[t]=a[t];return i},yt=function(o,a,i){for(;i;++a)o[a]=i,i>>>=8},SA=function(o,a,i,t){for(var e in o){var n,r=o[e],s=a+e,l=t;Array.isArray(r)&&(l=yA(t,r[1]),r=r[0]),n=r,(ut!=null&&typeof Symbol<"u"&&ut[Symbol.hasInstance]?!!ut[Symbol.hasInstance](n):Q(n,ut))?i[s]=[r,l]:(i[s+="/"]=[new ut(0),l],SA(r,s,i,t))}},xA=typeof TextEncoder<"u"&&new TextEncoder,qR=typeof TextDecoder<"u"&&new TextDecoder;try{qR.decode(gA,{stream:!0})}catch{}function pm(o,a){if(xA)return xA.encode(o);for(var r,i=o.length,t=new ut(o.length+(o.length>>1)),e=0,n=function(u){t[e++]=u},r=0;r<i;++r){if(e+5>t.length){var s=new ut(e+8+(i-r<<1));s.set(t),t=s}var l=o.charCodeAt(r);l<128||a?n(l):(l<2048?n(192|l>>6):(l>55295&&l<57344?(n(240|(l=65536+(1047552&l)|1023&o.charCodeAt(++r))>>18),n(128|l>>12&63)):n(224|l>>12),n(128|l>>6&63)),n(128|63&l))}return pA(t,0,e)}var mm=function(o){var a=0;if(o)for(var i in o){var t=o[i].length;t>65535&&nh(9),a+=t+4}return a},bA=function(o,a,i,t,e,n,r,s){var l=t.length,u=i.extra,c=s&&s.length,h=mm(u);yt(o,a,r!=null?33639248:67324752),a+=4,r!=null&&(o[a++]=20,o[a++]=i.os),o[a]=20,a+=2,o[a++]=i.flag<<1|(n<0&&8),o[a++]=e&&8,o[a++]=255&i.compression,o[a++]=i.compression>>8;var f=new Date(i.mtime==null?Date.now():i.mtime),d=f.getFullYear()-1980;if((d<0||d>119)&&nh(10),yt(o,a,d<<25|f.getMonth()+1<<21|f.getDate()<<16|f.getHours()<<11|f.getMinutes()<<5|f.getSeconds()>>1),a+=4,n!=-1&&(yt(o,a,i.crc),yt(o,a+4,n<0?-n-2:n),yt(o,a+8,i.size)),yt(o,a+12,l),yt(o,a+14,h),a+=16,r!=null&&(yt(o,a,c),yt(o,a+6,i.attrs),yt(o,a+10,r),a+=14),o.set(t,a),a+=l,h)for(var p in u){var _=u[p],g=_.length;yt(o,a,+p),yt(o,a+2,g),o.set(_,a+4),a+=4+g}return c&&(o.set(s,a),a+=c),a},KR=function(o,a,i,t,e){yt(o,a,101010256),yt(o,a+8,i),yt(o,a+10,i),yt(o,a+12,t),yt(o,a+16,e)};function TA(o,a){return(TA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var EA="root",wA=function(o,a,i){return"                    "+o+" inputs:"+a+" = "+i},ZR=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&TA(a,o);var i=a.prototype;return i.init=function(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set},i.done=function(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null},i.build=function(t,e){var n,r=this;e===void 0&&(e={}),this.init(),this.addFile(null,EA);var s=[];t&&t.findComponents("render").forEach(function(d){s.push.apply(s,[].concat(d.meshInstances))});var l="";s.forEach(function(d){l+=r.buildMeshInstance(d)}),l+=`
def "Materials"
{
    `+this.materials.join(`
`)+`
}
`,this.addFile(null,EA,"",l);for(var u={maxTextureSize:e.maxTextureSize},c=Array.from(this.textureMap.keys()),h=[],f=0;f<c.length;f++)n=this,function(d){var p=c[d];h.push(n.textureToCanvas(p,u).then(function(_){return _?new Promise(function(g){return _.toBlob(g,"image/png",1)}).then(function(g){return g.arrayBuffer()}):new Promise(function(g){return g(null)})}))}(f);return Promise.all(h).then(function(d){d.forEach(function(_,g){var y=c[g],v=r.getTextureFileIds(y);r.files[v.fileName]=new Uint8Array(_)}),r.alignFiles();var p=function(_,g){g||(g={});var y={},v=[];SA(_,"",y,g);var x=0,S=0;for(var T in y){var b=y[T],w=b[0],A=b[1],C=8*(A.level!=0),L=pm(T),I=L.length,P=A.comment,M=P&&pm(P),R=M&&M.length,k=mm(A.extra);I>65535&&nh(11);var D=C?YR(w,A||{},0,0):w,O=D.length,F=XR();F.p(w),v.push(yA(A,{size:w.length,crc:F.d(),c:D,f:L,m:M,u:I!=T.length||M&&P.length!=R,o:x,compression:C})),x+=30+I+k+O,S+=76+2*(I+k)+(R||0)+O}for(var N=new ut(S+22),j=x,z=S-x,V=0;V<v.length;++V){var L=v[V];bA(N,L.o,L,L.f,L.u,L.c.length);var H=30+L.f.length+mm(L.extra);N.set(L.c,L.o+H),bA(N,x,L,L.f,L.u,L.c.length,L.o,L.m),x+=16+H+(L.m?L.m.length:0)}return KR(N,x,v.length,z,j),N}(r.files,{level:0});return r.done(),p})},i.alignFiles=function(){var t=0;for(var e in this.files){var n=this.files[e],r=63&(t+=34+e.length);if(r!==4){var s=new Uint8Array(64-r);this.files[e]=[n,{extra:{12345:s}}]}t=n.length}},i.getFileIds=function(t,e,n,r){r===void 0&&(r="usda");var s=(t?""+t+"/":"")+e+"."+r;return{name:e,fileName:s,refName:"@./"+s+"@</"+n+">"}},i.getTextureFileIds=function(t){return this.getFileIds("texture","Texture_"+t.id,"Texture","png")},i.addFile=function(t,e,n,r){n===void 0&&(n=""),r===void 0&&(r="");var s=null;r&&(s=pm(r=`#usda 1.0
(
    customLayerData = {
        string creator = "PlayCanvas UsdzExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)

`+r));var l=this.getFileIds(t,e,n);return this.files[l.fileName]=s,l.refName},i.getMaterialRef=function(t){var e=this.materialMap.get(t);return e||(e=this.buildMaterial(t),this.materialMap.set(t,e)),e},i.getMeshRef=function(t){var e=this.meshMap.get(t);return e||(e=this.buildMesh(t),this.meshMap.set(t,e)),e},i.buildArray2=function(t){for(var e=[],n=t.length,r=0;r<n;r+=2)e.push("("+t[r]+", "+(1-t[r+1])+")");return e.join(", ")},i.buildArray3=function(t){for(var e=[],n=t.length,r=0;r<n;r+=3)e.push("("+t[r]+", "+t[r+1]+", "+t[r+2]+")");return e.join(", ")},i.buildMat4=function(t){for(var e=t.data,n=[],r=0;r<16;r+=4)n.push("("+e[r]+", "+e[r+1]+", "+e[r+2]+", "+e[r+3]+")");return"( "+n.join(", ")+" )"},i.buildMaterial=function(t){var e=this,n="Material_"+t.id,r="/Materials/"+n,s=function(f){return"<"+r+f+">"},l=[],u=[],c=function(f,d,p,_,g,y,v){y===void 0&&(y=!1),v===void 0&&(v=!1);var x=t[f];if(x){var S=e.getTextureFileIds(x);e.textureMap.set(x,S.refName);var T=t[""+f+"Channel"]||"rgb",b=s("/"+S.name+"_"+g+".outputs:"+T);l.push(wA(p,""+_+".connect",b)),y&&t.alphaTest;var w=t[""+f+"Tiling"],A=t[""+f+"Offset"],C=t[""+f+"Rotation"],L=t[""+f+"Uv"]===1?"st1":"st",I=v&&d?d:B.WHITE;u.push(`
                def Shader "Transform2d_`+g+`" (
                    sdrMetadata = {
                        string role = "math"
                    }
                )
                {
                    uniform token info:id = "UsdTransform2d"
                    float2 inputs:in.connect = `+s("/uvReader_"+L+".outputs:result")+`
                    float inputs:rotation = `+C+`
                    float2 inputs:scale = (`+w.x+", "+w.y+`)
                    float2 inputs:translation = (`+A.x+", "+A.y+`)
                    float2 outputs:result
                }

                def Shader "Texture_`+x.id+"_"+g+`"
                {
                    uniform token info:id = "UsdUVTexture"
                    asset inputs:file = @`+S.fileName+`@
                    float2 inputs:st.connect = `+s("/Transform2d_"+g+".outputs:result")+`
                    token inputs:wrapS = "repeat"
                    token inputs:wrapT = "repeat"
                    float4 inputs:scale = (`+I.r+", "+I.g+", "+I.b+", "+I.a+`)
                    float outputs:r
                    float outputs:g
                    float outputs:b
                    float3 outputs:rgb
                    float outputs:a
                }
            `)}else if(d){var P=p==="float"?""+d:"("+d.r+", "+d.g+", "+d.b+")";l.push(wA(p,_,P))}};c("diffuseMap",t.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(t.transparent||t.alphaTest>0)&&c("opacityMap",t.opacity,"float","opacity","opacity",!0),c("normalMap",null,"normal3f","normal","normal"),c("emissiveMap",t.emissive,"color3f","emissiveColor","emissive",!1,!0),c("aoMap",null,"float","occlusion","occlusion"),c("metalnessMap",t.metalness,"float","metallic","metallic"),c("glossMap",t.gloss,"float","roughness","roughness");var h=`
            def Material "`+n+`"
            {
                def Shader "PreviewSurface"
                {
                    uniform token info:id = "UsdPreviewSurface"
`+l.join(`
`)+`
                    int inputs:useSpecularWorkflow = 0
                    token outputs:surface
                }

                token outputs:surface.connect = `+s("/PreviewSurface.outputs:surface")+`

                def Shader "uvReader_st"
                {
                    uniform token info:id = "UsdPrimvarReader_float2"
                    token inputs:varname = "st"
                    float2 inputs:fallback = (0.0, 0.0)
                    float2 outputs:result
                }

                def Shader "uvReader_st1"
                {
                    uniform token info:id = "UsdPrimvarReader_float2"
                    token inputs:varname = "st1"
                    float2 inputs:fallback = (0.0, 0.0)
                    float2 outputs:result
                }

                `+u.join(`
`)+`
            }
        `;return this.materials.push(h),s("")},i.buildMesh=function(t){var e=[],n=[],r=[],s=[],l=[];t.getVertexStream(oe,e),t.getVertexStream(bt,r),t.getVertexStream(mt,s),t.getVertexStream(Hn,l),t.getIndices(n);var u=n.length||e.length,c=Array(u/3).fill(3).join(", ");if(!n.length)for(var h=0;h<u;h++)n[h]=h;var f=e.length/3;r=r.length?r:Array(3*f).fill(0),s=s.length?s:Array(2*f).fill(0),l=l.length?l:Array(2*f).fill(0),e=this.buildArray3(e),r=this.buildArray3(r);var d=`
def "Mesh"
{
    def Mesh "Mesh"
    {
        int[] faceVertexCounts = [`+c+`]
        int[] faceVertexIndices = [`+n+`]
        normal3f[] normals = [`+r+`] (
            interpolation = "vertex"
        )
        point3f[] points = [`+e+`]
        texCoord2f[] primvars:st = [`+(s=this.buildArray2(s))+`] (
            interpolation = "vertex"
        )
        texCoord2f[] primvars:st1 = [`+(l=this.buildArray2(l))+`] (
            interpolation = "vertex"
        )
        uniform token subdivisionScheme = "none"
    }
}
`;return this.addFile("mesh","Mesh_"+t.id,"Mesh",d)},i.buildMeshInstance=function(t){for(var e=this.getMeshRef(t.mesh),n=this.getMaterialRef(t.material),r=this.buildMat4(t.node.getWorldTransform()),s=t.node.name.replace(/[^a-z0-9]/gi,"_"),l=s;this.nodeNames.has(l);)l=s+"_"+Math.random().toString(36).slice(2,7);return this.nodeNames.add(l),`
def Xform "`+l+`" (
    prepend references = `+e+`
)
{
    matrix4d xformOp:transform = `+r+`
    uniform token[] xformOpOrder = ["xformOp:transform"]

    rel material:binding = `+n+`
}
`},a}(lA);function AA(o,a){(a==null||a>o.length)&&(a=o.length);for(var i=0,t=Array(a);i<a;i++)t[i]=o[i];return t}function CA(o,a,i,t,e,n,r){try{var s=o[n](r),l=s.value}catch(u){i(u);return}s.done?a(l):Promise.resolve(l).then(t,e)}function Ll(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}function PA(o,a){return(PA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}function IA(o,a){var i=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(i)return(i=i.call(o)).next.bind(i);if(Array.isArray(o)||(i=function(e,n){if(e){if(typeof e=="string")return AA(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return AA(e,void 0)}}(o))||a){i&&(o=i);var t=0;return function(){return t>=o.length?{done:!0}:{done:!1,value:o[t++]}}}throw TypeError("Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var QR=function(o){switch(o){case 0:return 5121;case 1:return 5123;case 2:return 5125}return 0},LA=function(o){switch(o){case 0:return 5120;case 1:return 5121;case 2:return 5122;case 3:return 5123;case 4:return 5124;case 5:return 5125;case 6:return 5126}return 0},JR=function(o){switch(o){case 1:return"SCALAR";case 2:return"VEC2";case 3:return"VEC3";case 4:return"VEC4"}return 0},$R=function(o){switch(o){case oe:return"POSITION";case bt:return"NORMAL";case hn:return"TANGENT";case st:return"COLOR_0";case Pt:return"JOINTS_0";case fn:return"WEIGHTS_0";case mt:return"TEXCOORD_0";case Hn:return"TEXCOORD_1";case Dr:return"TEXCOORD_2";case Mr:return"TEXCOORD_3";case Rr:return"TEXCOORD_4";case Or:return"TEXCOORD_5";case kr:return"TEXCOORD_6";case Nr:return"TEXCOORD_7"}return""},DA=function(o){switch(o){case 0:return 9728;case 1:return 9729;case 2:return 9984;case 4:return 9985;case 3:return 9986;case 5:return 9987}return 0},MA=function(o){switch(o){case 1:return 33071;case 2:return 33648;case 0:return 10497}return 0},RA=["diffuseMap","colorMap","normalMap","metalnessMap","emissiveMap"],e3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(){return o.apply(this,arguments)||this}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&PA(a,o);var i=a.prototype;return i.collectResources=function(t){var e={buffers:[],cameras:[],entities:[],materials:[],skins:[],textures:[],entityMeshInstances:[],bufferViewMap:new Map,compressableTexture:new Set},n=e.materials,r=e.buffers,s=e.entityMeshInstances,l=e.textures;t.forEach(function(c){e.entities.push(c)});var u=function(c){c.forEach(function(h){var f=h.material;0>n.indexOf(f)&&(e.materials.push(f),RA.forEach(function(v){var x=f[v];x&&0>l.indexOf(x)&&(v!=="normalMap"&&e.compressableTexture.add(x),l.push(x))}));var d=h.node,p=s.find(function(v){return v.node===d});p||(p={node:d,meshInstances:[]},s.push(p)),p.meshInstances.push(h);var _=h.mesh,g=_.vertexBuffer;0>r.indexOf(g)&&r.unshift(g);var y=_.indexBuffer[0];0>r.indexOf(y)&&r.push(y),_.skin&&0>e.skins.indexOf(_.skin)&&e.skins.push(_.skin)})};return e.entities.forEach(function(c){c.camera&&e.cameras.push(c.camera),c.render&&c.render.enabled&&u(c.render.meshInstances),c.model&&c.model.enabled&&c.model.meshInstances&&u(c.model.meshInstances)}),e},i.writeBufferViews=function(t,e){e.bufferViews=[];for(var n,r=IA(t.buffers);!(n=r()).done;){var s=n.value;a.writeBufferView(t,e,s)}},i.writeCameras=function(t,e){t.cameras.length>0&&(e.cameras=t.cameras.map(function(n){var r=n.projection,s=n.nearClip,l=n.farClip,u={};if(r===1)u.type="orthographic",u.orthographic={xmag:1,ymag:1,znear:s,zfar:l};else{var c=n.fov;u.type="perspective",u.perspective={yfov:c*Math.PI/180,znear:s,zfar:l}}return u}))},i.attachTexture=function(t,e,n,r,s,l){var u=e[s];if(u){var c,h,f=t.textures.indexOf(u);n[r]={index:f};var d=e[""+s+"Tiling"],p=e[""+s+"Offset"],_=e[""+s+"Rotation"];(d&&!d.equals(G.ONE)||p&&!p.equals(G.ZERO)||_!==0)&&(n[r].extensions={KHR_texture_transform:{}},l.extensionsUsed=(c=l.extensionsUsed)!=null?c:[],0>l.extensionsUsed.indexOf("KHR_texture_transform")&&l.extensionsUsed.push("KHR_texture_transform"),l.extensionsRequired=(h=l.extensionsRequired)!=null?h:[],0>l.extensionsRequired.indexOf("KHR_texture_transform")&&l.extensionsRequired.push("KHR_texture_transform"),d&&!d.equals(G.ONE)&&(n[r].extensions.KHR_texture_transform.scale=[d.x,d.y]),p&&!p.equals(G.ZERO)&&(n[r].extensions.KHR_texture_transform.offset=[p.x,p.y-1+d.y]),_!==0&&(n[r].extensions.KHR_texture_transform.rotation=_*U.DEG_TO_RAD))}},i.writeStandardMaterial=function(t,e,n,r){var s=e.diffuse,l=e.emissive,u=e.opacity,c=e.metalness,h=e.gloss,f=e.glossInvert,d=n.pbrMetallicRoughness;s.equals(B.WHITE)&&u===1||(d.baseColorFactor=[s.r,s.g,s.b,u]),c!==1&&(d.metallicFactor=c);var p=f?h:1-h;p!==1&&(d.roughnessFactor=p),this.attachTexture(t,e,d,"baseColorTexture","diffuseMap",r),this.attachTexture(t,e,d,"metallicRoughnessTexture","metalnessMap",r),l.equals(B.BLACK)||(n.emissiveFactor=[l.r,l.g,l.b])},i.writeMaterials=function(t,e){var n=this;t.materials.length>0&&(e.materials=t.materials.map(function(r){var s=r.name,l=r.blendType,u=r.cull,c=r.alphaTest,h={pbrMetallicRoughness:{}};return s&&s.length>0&&(h.name=s),Ll(r,it)&&n.writeStandardMaterial(t,r,h,e),l===2?h.alphaMode="BLEND":l===3&&c!==0&&(h.alphaMode="MASK",h.alphaCutoff=c),u===0&&(h.doubleSided=!0),n.attachTexture(t,r,h,"normalTexture","normalMap",e),n.attachTexture(t,r,h,"occlusionTexture","aoMap",e),n.attachTexture(t,r,h,"emissiveTexture","emissiveMap",e),h}))},i.writeNodes=function(t,e){t.entities.length>0&&(e.nodes=t.entities.map(function(n){var r=n.name,s=n.getLocalPosition(),l=n.getLocalRotation(),u=n.getLocalScale(),c={};r&&r.length>0&&(c.name=r),s.equals(E.ZERO)||(c.translation=[s.x,s.y,s.z]),l.equals(Z.IDENTITY)||(c.rotation=[l.x,l.y,l.z,l.w]),u.equals(E.ONE)||(c.scale=[u.x,u.y,u.z]),n.camera&&n.camera.enabled&&(c.camera=t.cameras.indexOf(n.camera));var h=t.entityMeshInstances.find(function(d){return d.node===n});if(h){c.mesh=t.entityMeshInstances.indexOf(h);var f=h.meshInstances[0];f&&f.mesh.skin&&(c.skin=t.skins.indexOf(f.mesh.skin))}return n.children.length>0&&(c.children=[],n.children.forEach(function(d){c.children.push(t.entities.indexOf(d))})),c}))},i.writeMeshes=function(t,e,n){t.entityMeshInstances.length>0&&(e.accessors=[],e.meshes=[],t.entityMeshInstances.forEach(function(r){var s={primitives:[]};r.meshInstances.forEach(function(l){var u=a.createPrimitive(t,e,l.mesh,n);u.material=t.materials.indexOf(l.material),s.primitives.push(u)}),e.meshes.push(s)}))},i.writeSkins=function(t,e){t.skins.length>0&&(e.skins=t.skins.map(function(n){for(var r=new Float32Array(16*n.inverseBindPose.length),s=0;s<n.inverseBindPose.length;s++){var l=n.inverseBindPose[s];r.set(l.data,16*s)}var u=r.buffer;a.writeBufferView(t,e,u),t.buffers.push(u);var c={bufferView:t.bufferViewMap.get(u)[0],componentType:LA(6),count:n.inverseBindPose.length,type:"MAT4"};return{inverseBindMatrices:e.accessors.push(c)-1,joints:n.boneNames.map(function(h){var f=t.entities.find(function(d){return d.name===h});return t.entities.indexOf(f)})}}))},i.convertTextures=function(t,e){var n=this,r={maxTextureSize:e.maxTextureSize},s=[];return t.forEach(function(l){var u=n.textureToCanvas(l,r);u.then(function(c){return new Promise(function(h){return h(c)})}),s.push(u)}),s},i.writeTextures=function(t,e,n,r){for(var s,l=function(d){var p=c[d],_=e[d],g=function(y){for(var v=y.getContext("2d").getImageData(0,0,y.width,y.height).data,x=3;x<v.length;x+=4)if(v[x]<255)return!0;return!1}(_)||!t.compressableTexture.has(p)?"image/png":"image/jpeg";h.push(s.getBlob(_,g).then(function(y){var v=new FileReader;return v.readAsArrayBuffer(y),new Promise(function(x){v.onloadend=function(){x(v)}})}).then(function(y){var v=u.getPaddedArrayBuffer(y.result);a.writeBufferView(t,n,v),t.buffers.push(v);var x=t.bufferViewMap.get(v);n.images[d]={mimeType:g,bufferView:x[0]},n.samplers[d]={minFilter:DA(p.minFilter),magFilter:DA(p.magFilter),wrapS:MA(p.addressU),wrapT:MA(p.addressV)},n.textures[d]={sampler:d,source:d}}))},u=this,c=t.textures,h=[],f=0;f<e.length;f++)s=this,l(f);return Promise.all(h)},i.getBlob=function(t,e){if(t.toBlob!==void 0)return new Promise(function(r){t.toBlob(r,e)});var n=1;return e==="image/jpeg"&&(n=.92),t.convertToBlob({type:e,quality:n})},i.getPaddedArrayBuffer=function(t,e){e===void 0&&(e=0);var n=U.roundUp(t.byteLength,4);if(n!==t.byteLength){var r=new Uint8Array(n);if(r.set(new Uint8Array(t)),e!==0)for(var s=t.byteLength;s<n;s++)r[s]=e;return r.buffer}return t},i.buildJson=function(t,e){var n,r=this.convertTextures(t.textures,e),s=this;return Promise.all(r).then((n=function(l){var u;return function(c,h){var f,d,p,_={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]},g=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return g.next=y(0),g.throw=y(1),g.return=y(2),typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g;function y(v){return function(x){var S=[v,x];if(f)throw TypeError("Generator is already executing.");for(;g&&(g=0,S[0]&&(_=0)),_;)try{if(f=1,d&&(p=2&S[0]?d.return:S[0]?d.throw||((p=d.return)&&p.call(d),0):d.next)&&!(p=p.call(d,S[1])).done)return p;switch(d=0,p&&(S=[2&S[0],p.value]),S[0]){case 0:case 1:p=S;break;case 4:return _.label++,{value:S[1],done:!1};case 5:_.label++,d=S[1],S=[0];continue;case 7:S=_.ops.pop(),_.trys.pop();continue;default:if(!(p=(p=_.trys).length>0&&p[p.length-1])&&(S[0]===6||S[0]===2)){_=0;continue}if(S[0]===3&&(!p||S[1]>p[0]&&S[1]<p[3])){_.label=S[1];break}if(S[0]===6&&_.label<p[1]){_.label=p[1],p=S;break}if(p&&_.label<p[2]){_.label=p[2],_.ops.push(S);break}p[2]&&_.ops.pop(),_.trys.pop();continue}S=h.call(c,_)}catch(T){S=[6,T],d=0}finally{f=p=0}if(5&S[0])throw S[1];return{value:S[0]?S[1]:void 0,done:!0}}}}(this,function(c){switch(c.label){case 0:return u={asset:{version:"2.0",generator:"PlayCanvas GltfExporter"},scenes:[{nodes:[0]}],images:[],samplers:[],textures:[],scene:0},s.writeBufferViews(t,u),s.writeCameras(t,u),s.writeMeshes(t,u,e),s.writeMaterials(t,u),s.writeNodes(t,u,e),s.writeSkins(t,u),[4,s.writeTextures(t,l,u,e)];case 1:return c.sent(),u.images.length||delete u.images,u.samplers.length||delete u.samplers,u.textures.length||delete u.textures,[2,u]}})},function(){var l=this,u=arguments;return new Promise(function(c,h){var f=n.apply(l,u);function d(_){CA(f,c,h,d,p,"next",_)}function p(_){CA(f,c,h,d,p,"throw",_)}d(void 0)})}))},i.build=function(t,e){e===void 0&&(e={});var n=this.collectResources(t);return this.buildJson(n,e).then(function(r){var s=new TextEncoder().encode(JSON.stringify(r)),l=s.length,u=4-(3&l)&3,c=r.buffers.reduce(function(g,y){return U.roundUp(g+y.byteLength,4)},0),h=20+l+u;c>0&&(h+=8+c);var f=new ArrayBuffer(h),d=new DataView(f);d.setUint32(0,1179937895,!0),d.setUint32(4,2,!0),d.setUint32(8,h,!0),d.setUint32(12,l+u,!0),d.setUint32(16,1313821514,!0);var p=20;new Uint8Array(f,20,l).set(s),p+=l;for(var _=0;_<u;_++)d.setUint8(p+_,32);return p+=u,c>0&&(d.setUint32(p,c,!0),d.setUint32(p+4,5130562,!0),p+=8,n.buffers.forEach(function(g){var y,v=n.bufferViewMap.get(g)[0],x=r.bufferViews[v].byteOffset;if(Ll(g,ArrayBuffer))y=new Uint8Array(g);else{var S=g.lock();y=Ll(S,ArrayBuffer)?new Uint8Array(S):new Uint8Array(S.buffer,S.byteOffset,S.byteLength)}new Uint8Array(f,p+x,y.byteLength).set(y)})),Promise.resolve(f)})},a.writeBufferView=function(t,e,n){e.buffers=(h=e.buffers)!=null?h:[],e.buffers[0]=(f=e.buffers[0])!=null?f:{byteLength:0};var r=e.buffers[0];r.byteLength=U.roundUp(r.byteLength,4);var s=r.byteLength,l=function(T,b,w,A){var C={buffer:0,byteLength:b,byteOffset:w};return(T===34962||T===34963)&&(C.target=T),A!==void 0&&(C.byteStride=A),e.bufferViews.push(C)-1};if(Ll(n,Rt)){d=n.lock();var u=n.getFormat();if(u.interleaved){var c=l(34962,d.byteLength,s,u.size);t.bufferViewMap.set(n,[c])}else{for(var h,f,d,p,_=[],g=IA(u.elements);!(p=g()).done;){var y=p.value,v=l(34962,y.size*u.vertexCount,s+y.offset,y.size);_.push(v)}t.bufferViewMap.set(n,_)}}else if(Ll(n,Yn)){var x=l(34963,(d=n.lock()).byteLength,s);t.bufferViewMap.set(n,[x])}else{var S=l(void 0,(d=n).byteLength,s);t.bufferViewMap.set(n,[S])}r.byteLength+=d.byteLength},a.createPrimitive=function(t,e,n,r){r===void 0&&(r={});var s={attributes:{}},l=n.vertexBuffer,u=l.format,c=u.interleaved,h=u.elements,f=l.getNumVertices();h.forEach(function(g,y){var v=$R(g.name);if(r.stripUnusedAttributes){var x=!0;if(v.startsWith("TEXCOORD_")){var S=parseInt(v.split("_")[1],10);x=t.materials.some(function(I){return RA.some(function(P){var M;return I[P]&&(S===0||((M=I[""+P+"Tiling"])==null?void 0:M.uv)===S)})})}if(v==="COLOR_0"&&(x=t.materials.some(function(I){return I.vertexColors})),v==="TANGENT"&&(x=t.materials.some(function(I){return I.normalMap})),(v==="JOINTS_0"||v==="WEIGHTS_0")&&(x=t.entityMeshInstances.some(function(I){return I.meshInstances.some(function(P){return P.mesh.skin})})),!x)return}var T=t.bufferViewMap.get(l);T||(a.writeBufferView(t,e,l),t.buffers.push(l),T=t.bufferViewMap.get(l));var b={bufferView:T[c?0:y],byteOffset:c?g.offset:0,componentType:LA(g.dataType),type:JR(g.numComponents),count:f},w=e.accessors.push(b)-1;if(s.attributes[v]=w,g.name===oe){var A=[];n.getPositions(A);var C=new E,L=new E;Se.computeMinMax(A,C,L),b.min=[C.x,C.y,C.z],b.max=[L.x,L.y,L.z]}});var d=n.indexBuffer[0];if(d){var p=t.bufferViewMap.get(d);p||(a.writeBufferView(t,e,d),t.buffers.push(d),p=t.bufferViewMap.get(d));var _={bufferView:p[0],componentType:QR(d.getFormat()),count:d.getNumIndices(),type:"SCALAR"};s.indices=e.accessors.push(_)-1}return s},a}(lA),ys="none",OA="lighting",kA="combine";function NA(o,a){return(NA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ih=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){n===void 0&&(n={}),(r=o.call(this,t)||this).sourceTexture=e,r.premultiplyTexture=n.premultiplyTexture,re.get(t,ue).set("downsamplePS",`
uniform sampler2D sourceTexture;
uniform vec2 sourceInvResolution;
varying vec2 uv0;
#ifdef PREMULTIPLY
	uniform sampler2D premultiplyTexture;
#endif
void main()
{
	vec3 e = texture2D (sourceTexture, uv0).rgb;
	#ifdef BOXFILTER
		vec3 value = e;
		#ifdef PREMULTIPLY
			float premultiply = texture2D(premultiplyTexture, uv0).{PREMULTIPLY_SRC_CHANNEL};
			value *= vec3(premultiply);
		#endif
	#else
		float x = sourceInvResolution.x;
		float y = sourceInvResolution.y;
		vec3 a = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y + 2.0 * y)).rgb;
		vec3 b = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y + 2.0 * y)).rgb;
		vec3 c = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y + 2.0 * y)).rgb;
		vec3 d = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y)).rgb;
		vec3 f = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y)).rgb;
		vec3 g = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y - 2.0 * y)).rgb;
		vec3 h = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y - 2.0 * y)).rgb;
		vec3 i = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y - 2.0 * y)).rgb;
		vec3 j = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
		vec3 k = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
		vec3 l = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
		vec3 m = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
		vec3 value = e * 0.125;
		value += (a + c + g + i) * 0.03125;
		value += (b + d + f + h) * 0.0625;
		value += (j + k + l + m) * 0.125;
	#endif
	#ifdef REMOVE_INVALID
		value = max(value, vec3(0.0));
	#endif
	gl_FragColor = vec4(value, 1.0);
}
`),re.get(t,he).set("downsamplePS",`
var sourceTexture: texture_2d<f32>;
var sourceTextureSampler: sampler;
uniform sourceInvResolution: vec2f;
varying uv0: vec2f;
#ifdef PREMULTIPLY
	var premultiplyTexture: texture_2d<f32>;
	var premultiplyTextureSampler: sampler;
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, input.uv0).rgb;
	#ifdef BOXFILTER
		var value: vec3f = e;
		#ifdef PREMULTIPLY
			let premultiply: f32 = textureSample(premultiplyTexture, premultiplyTextureSampler, input.uv0).{PREMULTIPLY_SRC_CHANNEL};
			value = value * vec3f(premultiply);
		#endif
	#else
		let x: f32 = uniform.sourceInvResolution.x;
		let y: f32 = uniform.sourceInvResolution.y;
		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y + 2.0 * y)).rgb;
		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y + 2.0 * y)).rgb;
		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y + 2.0 * y)).rgb;
		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y)).rgb;
		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y)).rgb;
		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y - 2.0 * y)).rgb;
		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y - 2.0 * y)).rgb;
		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y - 2.0 * y)).rgb;
		let j: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;
		let k: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;
		let l: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;
		let m: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;
		var value: vec3f = e * 0.125;
		value = value + (a + c + g + i) * 0.03125;
		value = value + (b + d + f + h) * 0.0625;
		value = value + (j + k + l + m) * 0.125;
	#endif
	#ifdef REMOVE_INVALID
		value = max(value, vec3f(0.0));
	#endif
	output.color = vec4f(value, 1.0);
	return output;
}
`);var r,s,l,u,c=(s=n.boxFilter)!=null&&s,h=(c?"Box":"")+"-"+(n.premultiplyTexture?"Premultiply":"")+"-"+((l=n.premultiplySrcChannel)!=null?l:"")+"-"+(n.removeInvalid?"RemoveInvalid":""),f=new Map;return c&&f.set("BOXFILTER",""),n.premultiplyTexture&&f.set("PREMULTIPLY",""),n.removeInvalid&&f.set("REMOVE_INVALID",""),f.set("{PREMULTIPLY_SRC_CHANNEL}",(u=n.premultiplySrcChannel)!=null?u:"x"),r.shader=Te.createShader(t,{uniqueName:"DownSampleShader:"+h,attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"downsamplePS",fragmentDefines:f}),r.sourceTextureId=t.scope.resolve("sourceTexture"),r.premultiplyTextureId=t.scope.resolve("premultiplyTexture"),r.sourceInvResolutionId=t.scope.resolve("sourceInvResolution"),r.sourceInvResolutionValue=new Float32Array(2),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&NA(a,o);var i=a.prototype;return i.setSourceTexture=function(t){this._sourceTexture=t,this.options.resizeSource=t},i.execute=function(){this.sourceTextureId.setValue(this.sourceTexture),this.premultiplyTexture&&this.premultiplyTextureId.setValue(this.premultiplyTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),o.prototype.execute.call(this)},a}(Oi);function FA(o,a){return(FA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var UA=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t){var e;return(e=o.call(this,i)||this).sourceTexture=t,re.get(i,ue).set("upsamplePS",`
	uniform sampler2D sourceTexture;
	uniform vec2 sourceInvResolution;
	varying vec2 uv0;
	void main()
	{
		float x = sourceInvResolution.x;
		float y = sourceInvResolution.y;
		vec3 a = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
		vec3 b = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y + y)).rgb;
		vec3 c = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
		vec3 d = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y)).rgb;
		vec3 e = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y)).rgb;
		vec3 f = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y)).rgb;
		vec3 g = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
		vec3 h = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y - y)).rgb;
		vec3 i = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
		vec3 value = e * 4.0;
		value += (b + d + f + h) * 2.0;
		value += (a + c + g + i);
		value *= 1.0 / 16.0;
		gl_FragColor = vec4(value, 1.0);
	}
`),re.get(i,he).set("upsamplePS",`
	var sourceTexture: texture_2d<f32>;
	var sourceTextureSampler: sampler;
	uniform sourceInvResolution: vec2f;
	varying uv0: vec2f;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let x: f32 = uniform.sourceInvResolution.x;
		let y: f32 = uniform.sourceInvResolution.y;
		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;
		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y + y)).rgb;
		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;
		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y)).rgb;
		let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y)).rgb;
		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y)).rgb;
		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;
		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y - y)).rgb;
		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;
		var value: vec3f = e * 4.0;
		value = value + (b + d + f + h) * 2.0;
		value = value + (a + c + g + i);
		value = value * (1.0 / 16.0);
		output.color = vec4f(value, 1.0);
		return output;
	}
`),e.shader=Te.createShader(i,{uniqueName:"UpSampleShader",attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"upsamplePS"}),e.sourceTextureId=i.scope.resolve("sourceTexture"),e.sourceInvResolutionId=i.scope.resolve("sourceInvResolution"),e.sourceInvResolutionValue=new Float32Array(2),e}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&FA(a,o),a.prototype.execute=function(){this.sourceTextureId.setValue(this.sourceTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),o.prototype.execute.call(this)},a}(Oi);function BA(o,a){return(BA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var VA=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){var r;return(r=o.call(this,t)||this).blurLevel=16,r.renderTargets=[],r._sourceTexture=e,r.textureFormat=n,r.bloomRenderTarget=r.createRenderTarget(0),r.bloomTexture=r.bloomRenderTarget.colorBuffer,r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&BA(a,o);var i=a.prototype;return i.destroy=function(){this.destroyRenderPasses(),this.destroyRenderTargets()},i.destroyRenderTargets=function(t){t===void 0&&(t=0);for(var e=t;e<this.renderTargets.length;e++){var n=this.renderTargets[e];n.destroyTextureBuffers(),n.destroy()}this.renderTargets.length=0},i.destroyRenderPasses=function(){for(var t=0;t<this.beforePasses.length;t++)this.beforePasses[t].destroy();this.beforePasses.length=0},i.createRenderTarget=function(t){return new Ee({depth:!1,colorBuffer:new ee(this.device,{name:"BloomTexture"+t,width:1,height:1,format:this.textureFormat,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1})})},i.createRenderTargets=function(t){for(var e=0;e<t;e++){var n=e===0?this.bloomRenderTarget:this.createRenderTarget(e);this.renderTargets.push(n)}},i.calcMipLevels=function(t,e,n){return Math.floor(Math.log2(Math.min(t,e))-Math.log2(n))},i.createRenderPasses=function(t){for(var e=this.device,n=this._sourceTexture,r=0;r<t;r++){var s=new ih(e,n),l=this.renderTargets[r];s.init(l,{resizeSource:n,scaleX:.5,scaleY:.5}),s.setClearColor(B.BLACK),this.beforePasses.push(s),n=l.colorBuffer}n=this.renderTargets[t-1].colorBuffer;for(var u=t-2;u>=0;u--){var c=new UA(e,n),h=this.renderTargets[u];c.init(h),c.blendState=ge.ADDBLEND,this.beforePasses.push(c),n=h.colorBuffer}},i.onDisable=function(){var t;(t=this.renderTargets[0])==null||t.resize(1,1),this.destroyRenderPasses(),this.destroyRenderTargets(1)},i.frameUpdate=function(){o.prototype.frameUpdate.call(this);var t=this.calcMipLevels(this._sourceTexture.width,this._sourceTexture.height,1),e=U.clamp(t,1,this.blurLevel);this.renderTargets.length!==e&&(this.destroyRenderPasses(),this.destroyRenderTargets(1),this.createRenderTargets(e),this.createRenderPasses(e))},a}(ct),t3={composePS:`
	#include "tonemappingPS"
	#include "gammaPS"
	varying vec2 uv0;
	uniform sampler2D sceneTexture;
	uniform vec2 sceneTextureInvRes;
	#include "composeBloomPS"
	#include "composeDofPS"
	#include "composeSsaoPS"
	#include "composeGradingPS"
	#include "composeVignettePS"
	#include "composeFringingPS"
	#include "composeCasPS"
	#include "composeColorLutPS"
	void main() {
		vec2 uv = uv0;
		#ifdef TAA
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		#endif
		vec4 scene = texture2DLod(sceneTexture, uv, 0.0);
		vec3 result = scene.rgb;
		#ifdef CAS
			result = applyCas(result, uv, sharpness);
		#endif
		#ifdef DOF
			result = applyDof(result, uv0);
		#endif
		#ifdef SSAO_TEXTURE
			result = applySsao(result, uv0);
		#endif
		#ifdef FRINGING
			result = applyFringing(result, uv);
		#endif
		#ifdef BLOOM
			result = applyBloom(result, uv0);
		#endif
		#ifdef GRADING
			result = applyGrading(result);
		#endif
		result = toneMap(result);
		#ifdef COLOR_LUT
			result = applyColorLUT(result);
		#endif
		#ifdef VIGNETTE
			result = applyVignette(result, uv);
		#endif
		#ifdef DEBUG_COMPOSE
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom
				result = dBloom * bloomIntensity;
			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc
				result = vec3(dCoc, 0.0);
			#elif defined(DOF) && DEBUG_COMPOSE == dofblur
				result = dBlur;
			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao
				result = vec3(dSsao);
			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette
				result = vec3(dVignette);
			#endif
		#endif
		result = gammaCorrectOutput(result);
		gl_FragColor = vec4(result, scene.a);
	}
`,composeBloomPS:`
	#ifdef BLOOM
		uniform sampler2D bloomTexture;
		uniform float bloomIntensity;
		
		vec3 dBloom;
		
		vec3 applyBloom(vec3 color, vec2 uv) {
			dBloom = texture2DLod(bloomTexture, uv, 0.0).rgb;
			return color + dBloom * bloomIntensity;
		}
	#endif
`,composeDofPS:`
	#ifdef DOF
		uniform sampler2D cocTexture;
		uniform sampler2D blurTexture;
		
		vec2 dCoc;
		vec3 dBlur;
		vec3 getDofBlur(vec2 uv) {
			dCoc = texture2DLod(cocTexture, uv, 0.0).rg;
			#if DOF_UPSCALE
				vec2 blurTexelSize = 1.0 / vec2(textureSize(blurTexture, 0));
				vec3 bilinearBlur = vec3(0.0);
				float totalWeight = 0.0;
				for (int i = -1; i <= 1; i++) {
					for (int j = -1; j <= 1; j++) {
						vec2 offset = vec2(i, j) * blurTexelSize;
						vec2 cocSample = texture2DLod(cocTexture, uv + offset, 0.0).rg;
						vec3 blurSample = texture2DLod(blurTexture, uv + offset, 0.0).rgb;
						float cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				dBlur = bilinearBlur;
				return bilinearBlur;
			#else
				dBlur = texture2DLod(blurTexture, uv, 0.0).rgb;
				return dBlur;
			#endif
		}
		vec3 applyDof(vec3 color, vec2 uv) {
			vec3 blur = getDofBlur(uv);
			return mix(color, blur, dCoc.r + dCoc.g);
		}
	#endif
`,composeSsaoPS:`
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		uniform sampler2D ssaoTexture;
		
		float dSsao;
		
		vec3 applySsao(vec3 color, vec2 uv) {
			dSsao = texture2DLod(ssaoTexture, uv, 0.0).r;
			
			#ifdef SSAO
				return color * dSsao;
			#else
				return color;
			#endif
		}
	#endif
`,composeGradingPS:`
	#ifdef GRADING
		uniform vec3 brightnessContrastSaturation;
		uniform vec3 tint;
		vec3 colorGradingHDR(vec3 color, float brt, float sat, float con) {
			color *= tint;
			color = color * brt;
			float grey = dot(color, vec3(0.3, 0.59, 0.11));
			grey = grey / max(1.0, max(color.r, max(color.g, color.b)));
			color = mix(vec3(grey), color, sat);
			return mix(vec3(0.5), color, con);
		}
		vec3 applyGrading(vec3 color) {
			return colorGradingHDR(color, 
				brightnessContrastSaturation.x, 
				brightnessContrastSaturation.z, 
				brightnessContrastSaturation.y);
		}
	#endif
`,composeVignettePS:`
	#ifdef VIGNETTE
		uniform vec4 vignetterParams;
		
		float dVignette;
		
		float calcVignette(vec2 uv) {
			float inner = vignetterParams.x;
			float outer = vignetterParams.y;
			float curvature = vignetterParams.z;
			float intensity = vignetterParams.w;
			vec2 curve = pow(abs(uv * 2.0 -1.0), vec2(1.0 / curvature));
			float edge = pow(length(curve), curvature);
			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);
			return dVignette;
		}
		vec3 applyVignette(vec3 color, vec2 uv) {
			return color * calcVignette(uv);
		}
	#endif
`,composeFringingPS:`
	#ifdef FRINGING
		uniform float fringingIntensity;
		vec3 applyFringing(vec3 color, vec2 uv) {
			vec2 centerDistance = uv - 0.5;
			vec2 offset = fringingIntensity * pow(centerDistance, vec2(2.0, 2.0));
			color.r = texture2D(sceneTexture, uv - offset).r;
			color.b = texture2D(sceneTexture, uv + offset).b;
			return color;
		}
	#endif
`,composeCasPS:`
	#ifdef CAS
		uniform float sharpness;
		float maxComponent(float x, float y, float z) { return max(x, max(y, z)); }
		vec3 toSDR(vec3 c) { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		vec3 toHDR(vec3 c) { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		vec3 applyCas(vec3 color, vec2 uv, float sharpness) {
			float x = sceneTextureInvRes.x;
			float y = sceneTextureInvRes.y;
			vec3 a = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, -y), 0.0).rgb);
			vec3 b = toSDR(texture2DLod(sceneTexture, uv + vec2(-x, 0.0), 0.0).rgb);
			vec3 c = toSDR(color.rgb);
			vec3 d = toSDR(texture2DLod(sceneTexture, uv + vec2(x, 0.0), 0.0).rgb);
			vec3 e = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, y), 0.0).rgb);
			float min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			float max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			float sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			float w = sharpening_amount * sharpness;
			vec3 res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, 0.0);
			return toHDR(res);
		}
	#endif
`,composeColorLutPS:`
	#ifdef COLOR_LUT
		uniform sampler2D colorLUT;
		uniform vec4 colorLUTParams;
		vec3 applyColorLUT(vec3 color) {
			vec3 c = clamp(color, 0.0, 1.0);
			float width = colorLUTParams.x;
			float height = colorLUTParams.y;
			float maxColor = colorLUTParams.z;
			float cell = c.b * maxColor;
			float cell_l = floor(cell);
			float cell_h = ceil(cell);
			float half_px_x = 0.5 / width;
			float half_px_y = 0.5 / height;
			float r_offset = half_px_x + c.r / height * (maxColor / height);
			float g_offset = half_px_y + c.g * (maxColor / height);
			vec2 uv_l = vec2(cell_l / height + r_offset, g_offset);
			vec2 uv_h = vec2(cell_h / height + r_offset, g_offset);
			vec3 color_l = texture2DLod(colorLUT, uv_l, 0.0).rgb;
			vec3 color_h = texture2DLod(colorLUT, uv_h, 0.0).rgb;
			vec3 lutColor = mix(color_l, color_h, fract(cell));
			return mix(color, lutColor, colorLUTParams.w);
		}
	#endif
`},n3={composePS:`
	#include "tonemappingPS"
	#include "gammaPS"
	varying uv0: vec2f;
	var sceneTexture: texture_2d<f32>;
	var sceneTextureSampler: sampler;
	uniform sceneTextureInvRes: vec2f;
	#include "composeBloomPS"
	#include "composeDofPS"
	#include "composeSsaoPS"
	#include "composeGradingPS"
	#include "composeVignettePS"
	#include "composeFringingPS"
	#include "composeCasPS"
	#include "composeColorLutPS"
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = uv0;
		#ifdef TAA
			uv.y = 1.0 - uv.y;
		#endif
		let scene = textureSampleLevel(sceneTexture, sceneTextureSampler, uv, 0.0);
		var result = scene.rgb;
		#ifdef CAS
			result = applyCas(result, uv, uniform.sharpness);
		#endif
		#ifdef DOF
			result = applyDof(result, uv0);
		#endif
		#ifdef SSAO_TEXTURE
			result = applySsao(result, uv0);
		#endif
		#ifdef FRINGING
			result = applyFringing(result, uv);
		#endif
		#ifdef BLOOM
			result = applyBloom(result, uv0);
		#endif
		#ifdef GRADING
			result = applyGrading(result);
		#endif
		result = toneMap(result);
		#ifdef COLOR_LUT
			result = applyColorLUT(result);
		#endif
		#ifdef VIGNETTE
			result = applyVignette(result, uv);
		#endif
		#ifdef DEBUG_COMPOSE
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom
				result = dBloom * uniform.bloomIntensity;
			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc
				result = vec3f(dCoc, 0.0);
			#elif defined(DOF) && DEBUG_COMPOSE == dofblur
				result = dBlur;
			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao
				result = vec3f(dSsao);
			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette
				result = vec3f(dVignette);
			#endif
		#endif
		result = gammaCorrectOutput(result);
		output.color = vec4f(result, scene.a);
		return output;
	}
`,composeBloomPS:`
	#ifdef BLOOM
		var bloomTexture: texture_2d<f32>;
		var bloomTextureSampler: sampler;
		uniform bloomIntensity: f32;
		
		var<private> dBloom: vec3f;
		
		fn applyBloom(color: vec3f, uv: vec2f) -> vec3f {
			dBloom = textureSampleLevel(bloomTexture, bloomTextureSampler, uv, 0.0).rgb;
			return color + dBloom * uniform.bloomIntensity;
		}
	#endif
`,composeDofPS:`
	#ifdef DOF
		var cocTexture: texture_2d<f32>;
		var cocTextureSampler: sampler;
		var blurTexture: texture_2d<f32>;
		var blurTextureSampler: sampler;
		
		var<private> dCoc: vec2f;
		var<private> dBlur: vec3f;
		fn getDofBlur(uv: vec2f) -> vec3f {
			dCoc = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).rg;
			#if DOF_UPSCALE
				let blurTexelSize = 1.0 / vec2f(textureDimensions(blurTexture, 0));
				var bilinearBlur = vec3f(0.0);
				var totalWeight = 0.0;
				for (var i = -1; i <= 1; i++) {
					for (var j = -1; j <= 1; j++) {
						let offset = vec2f(f32(i), f32(j)) * blurTexelSize;
						let cocSample = textureSampleLevel(cocTexture, cocTextureSampler, uv + offset, 0.0).rg;
						let blurSample = textureSampleLevel(blurTexture, blurTextureSampler, uv + offset, 0.0).rgb;
						let cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				dBlur = bilinearBlur;
				return bilinearBlur;
			#else
				dBlur = textureSampleLevel(blurTexture, blurTextureSampler, uv, 0.0).rgb;
				return dBlur;
			#endif
		}
		fn applyDof(color: vec3f, uv: vec2f) -> vec3f {
			let blur = getDofBlur(uv);
			return mix(color, blur, dCoc.r + dCoc.g);
		}
	#endif
`,composeSsaoPS:`
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		var ssaoTexture: texture_2d<f32>;
		var ssaoTextureSampler: sampler;
		
		var<private> dSsao: f32;
		
		fn applySsao(color: vec3f, uv: vec2f) -> vec3f {
			dSsao = textureSampleLevel(ssaoTexture, ssaoTextureSampler, uv, 0.0).r;
			
			#ifdef SSAO
				return color * dSsao;
			#else
				return color;
			#endif
		}
	#endif
`,composeGradingPS:`
	#ifdef GRADING
		uniform brightnessContrastSaturation: vec3f;
		uniform tint: vec3f;
		fn colorGradingHDR(color: vec3f, brt: f32, sat: f32, con: f32) -> vec3f {
			var colorOut = color * uniform.tint;
			colorOut = colorOut * brt;
			let grey = dot(colorOut, vec3f(0.3, 0.59, 0.11));
			let normalizedGrey = grey / max(1.0, max(colorOut.r, max(colorOut.g, colorOut.b)));
			colorOut = mix(vec3f(normalizedGrey), colorOut, sat);
			return mix(vec3f(0.5), colorOut, con);
		}
		fn applyGrading(color: vec3f) -> vec3f {
			return colorGradingHDR(color, 
				uniform.brightnessContrastSaturation.x, 
				uniform.brightnessContrastSaturation.z, 
				uniform.brightnessContrastSaturation.y);
		}
	#endif
`,composeVignettePS:`
	#ifdef VIGNETTE
		uniform vignetterParams: vec4f;
		
		var<private> dVignette: f32;
		
		fn calcVignette(uv: vec2f) -> f32 {
			let inner = uniform.vignetterParams.x;
			let outer = uniform.vignetterParams.y;
			let curvature = uniform.vignetterParams.z;
			let intensity = uniform.vignetterParams.w;
			let curve = pow(abs(uv * 2.0 - 1.0), vec2f(1.0 / curvature));
			let edge = pow(length(curve), curvature);
			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);
			return dVignette;
		}
		fn applyVignette(color: vec3f, uv: vec2f) -> vec3f {
			return color * calcVignette(uv);
		}
	#endif
`,composeFringingPS:`
	#ifdef FRINGING
		uniform fringingIntensity: f32;
		fn applyFringing(color: vec3f, uv: vec2f) -> vec3f {
			let centerDistance = uv - 0.5;
			let offset = uniform.fringingIntensity * pow(centerDistance, vec2f(2.0));
			var colorOut = color;
			colorOut.r = textureSample(sceneTexture, sceneTextureSampler, uv - offset).r;
			colorOut.b = textureSample(sceneTexture, sceneTextureSampler, uv + offset).b;
			return colorOut;
		}
	#endif
`,composeCasPS:`
	#ifdef CAS
		uniform sharpness: f32;
		fn maxComponent(x: f32, y: f32, z: f32) -> f32 { return max(x, max(y, z)); }
		fn toSDR(c: vec3f) -> vec3f { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		fn toHDR(c: vec3f) -> vec3f { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		fn applyCas(color: vec3f, uv: vec2f, sharpness: f32) -> vec3f {
			let x = uniform.sceneTextureInvRes.x;
			let y = uniform.sceneTextureInvRes.y;
			let a = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, -y), 0.0).rgb);
			let b = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(-x, 0.0), 0.0).rgb);
			let c = toSDR(color.rgb);
			let d = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(x, 0.0), 0.0).rgb);
			let e = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, y), 0.0).rgb);
			let min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			let max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			let sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			let w = sharpening_amount * uniform.sharpness;
			var res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, vec3f(0.0));
			return toHDR(res);
		}
	#endif
`,composeColorLutPS:`
	#ifdef COLOR_LUT
		var colorLUT: texture_2d<f32>;
		var colorLUTSampler: sampler;
		uniform colorLUTParams: vec4f;
		fn applyColorLUT(color: vec3f) -> vec3f {
			var c: vec3f = clamp(color, vec3f(0.0), vec3f(1.0));
			let width: f32 = uniform.colorLUTParams.x;
			let height: f32 = uniform.colorLUTParams.y;
			let maxColor: f32 = uniform.colorLUTParams.z;
			let cell: f32 = c.b * maxColor;
			let cell_l: f32 = floor(cell);
			let cell_h: f32 = ceil(cell);
			let half_px_x: f32 = 0.5 / width;
			let half_px_y: f32 = 0.5 / height;
			let r_offset: f32 = half_px_x + c.r / height * (maxColor / height);
			let g_offset: f32 = half_px_y + c.g * (maxColor / height);
			let uv_l: vec2f = vec2f(cell_l / height + r_offset, g_offset);
			let uv_h: vec2f = vec2f(cell_h / height + r_offset, g_offset);
			let color_l: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_l, 0.0).rgb;
			let color_h: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_h, 0.0).rgb;
			let lutColor: vec3f = mix(color_l, color_h, fract(cell));
			return mix(color, lutColor, uniform.colorLUTParams.w);
		}
	#endif
`};function zA(o,a){return(zA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var GA=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){(n=o.call(this,e)||this).sceneTexture=null,n.bloomIntensity=.01,n._bloomTexture=null,n._cocTexture=null,n.blurTexture=null,n.blurTextureUpscale=!1,n._ssaoTexture=null,n._toneMapping=0,n._gradingEnabled=!1,n.gradingSaturation=1,n.gradingContrast=1,n.gradingBrightness=1,n.gradingTint=new B(1,1,1,1),n._shaderDirty=!0,n._vignetteEnabled=!1,n.vignetteInner=.5,n.vignetteOuter=1,n.vignetteCurvature=.5,n.vignetteIntensity=.3,n._fringingEnabled=!1,n.fringingIntensity=10,n._taaEnabled=!1,n._sharpness=.5,n._gammaCorrection=1,n._colorLUT=null,n.colorLUTIntensity=1,n._key="",n._debug=null,re.get(e,ue).add(t3),re.get(e,he).add(n3);var n,r=e.scope;return n.sceneTextureId=r.resolve("sceneTexture"),n.bloomTextureId=r.resolve("bloomTexture"),n.cocTextureId=r.resolve("cocTexture"),n.ssaoTextureId=r.resolve("ssaoTexture"),n.blurTextureId=r.resolve("blurTexture"),n.bloomIntensityId=r.resolve("bloomIntensity"),n.bcsId=r.resolve("brightnessContrastSaturation"),n.tintId=r.resolve("tint"),n.vignetterParamsId=r.resolve("vignetterParams"),n.fringingIntensityId=r.resolve("fringingIntensity"),n.sceneTextureInvResId=r.resolve("sceneTextureInvRes"),n.sceneTextureInvResValue=new Float32Array(2),n.sharpnessId=r.resolve("sharpness"),n.colorLUTId=r.resolve("colorLUT"),n.colorLUTParams=new Float32Array(4),n.colorLUTParamsId=r.resolve("colorLUTParams"),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&zA(a,o);var i,t=a.prototype;return t.postInit=function(){this.setClearColor(B.BLACK),this.setClearDepth(1),this.setClearStencil(0)},t.frameUpdate=function(){var e=+!((n=this.renderTarget)!=null?n:this.device.backBuffer).isColorBufferSrgb(0);if(this._gammaCorrection!==e&&(this._gammaCorrection=e,this._shaderDirty=!0),this._shaderDirty){this._shaderDirty=!1;var n,r,s=Lf[this._gammaCorrection],l=""+this.toneMapping+"-"+s+"-"+(this.bloomTexture?"bloom":"nobloom")+"-"+(this.cocTexture?"dof":"nodof")+"-"+(this.blurTextureUpscale?"dofupscale":"")+"-"+(this.ssaoTexture?"ssao":"nossao")+"-"+(this.gradingEnabled?"grading":"nograding")+"-"+(this.colorLUT?"colorlut":"nocolorlut")+"-"+(this.vignetteEnabled?"vignette":"novignette")+"-"+(this.fringingEnabled?"fringing":"nofringing")+"-"+(this.taaEnabled?"taa":"notaa")+"-"+(this.isSharpnessEnabled?"cas":"nocas")+"-"+((r=this._debug)!=null?r:"");if(this._key!==l){this._key=l;var u=new Map;u.set("TONEMAP",gu[this.toneMapping]),u.set("GAMMA",s),this.bloomTexture&&u.set("BLOOM",!0),this.cocTexture&&u.set("DOF",!0),this.blurTextureUpscale&&u.set("DOF_UPSCALE",!0),this.ssaoTexture&&u.set("SSAO",!0),this.gradingEnabled&&u.set("GRADING",!0),this.colorLUT&&u.set("COLOR_LUT",!0),this.vignetteEnabled&&u.set("VIGNETTE",!0),this.fringingEnabled&&u.set("FRINGING",!0),this.taaEnabled&&u.set("TAA",!0),this.isSharpnessEnabled&&u.set("CAS",!0),this._debug&&u.set("DEBUG_COMPOSE",this._debug);var c=new Map(re.get(this.device,this.device.isWebGPU?he:ue));this.shader=Te.createShader(this.device,{uniqueName:"ComposeShader-"+l,attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"composePS",fragmentDefines:u,fragmentIncludes:c})}}},t.execute=function(){this.sceneTextureId.setValue(this.sceneTexture),this.sceneTextureInvResValue[0]=1/this.sceneTexture.width,this.sceneTextureInvResValue[1]=1/this.sceneTexture.height,this.sceneTextureInvResId.setValue(this.sceneTextureInvResValue),this._bloomTexture&&(this.bloomTextureId.setValue(this._bloomTexture),this.bloomIntensityId.setValue(this.bloomIntensity)),this._cocTexture&&(this.cocTextureId.setValue(this._cocTexture),this.blurTextureId.setValue(this.blurTexture)),this._ssaoTexture&&this.ssaoTextureId.setValue(this._ssaoTexture),this._gradingEnabled&&(this.bcsId.setValue([this.gradingBrightness,this.gradingContrast,this.gradingSaturation]),this.tintId.setValue([this.gradingTint.r,this.gradingTint.g,this.gradingTint.b]));var e=this._colorLUT;e&&(this.colorLUTParams[0]=e.width,this.colorLUTParams[1]=e.height,this.colorLUTParams[2]=e.height-1,this.colorLUTParams[3]=this.colorLUTIntensity,this.colorLUTParamsId.setValue(this.colorLUTParams),this.colorLUTId.setValue(e)),this._vignetteEnabled&&this.vignetterParamsId.setValue([this.vignetteInner,this.vignetteOuter,this.vignetteCurvature,this.vignetteIntensity]),this._fringingEnabled&&this.fringingIntensityId.setValue(this.fringingIntensity/1024),this.isSharpnessEnabled&&this.sharpnessId.setValue(U.lerp(-.125,-.2,this.sharpness)),o.prototype.execute.call(this)},i=[{key:"debug",get:function(){return this._debug},set:function(e){this._debug!==e&&(this._debug=e,this._shaderDirty=!0)}},{key:"colorLUT",get:function(){return this._colorLUT},set:function(e){this._colorLUT!==e&&(this._colorLUT=e,this._shaderDirty=!0)}},{key:"bloomTexture",get:function(){return this._bloomTexture},set:function(e){this._bloomTexture!==e&&(this._bloomTexture=e,this._shaderDirty=!0)}},{key:"cocTexture",get:function(){return this._cocTexture},set:function(e){this._cocTexture!==e&&(this._cocTexture=e,this._shaderDirty=!0)}},{key:"ssaoTexture",get:function(){return this._ssaoTexture},set:function(e){this._ssaoTexture!==e&&(this._ssaoTexture=e,this._shaderDirty=!0)}},{key:"taaEnabled",get:function(){return this._taaEnabled},set:function(e){this._taaEnabled!==e&&(this._taaEnabled=e,this._shaderDirty=!0)}},{key:"gradingEnabled",get:function(){return this._gradingEnabled},set:function(e){this._gradingEnabled!==e&&(this._gradingEnabled=e,this._shaderDirty=!0)}},{key:"vignetteEnabled",get:function(){return this._vignetteEnabled},set:function(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._shaderDirty=!0)}},{key:"fringingEnabled",get:function(){return this._fringingEnabled},set:function(e){this._fringingEnabled!==e&&(this._fringingEnabled=e,this._shaderDirty=!0)}},{key:"toneMapping",get:function(){return this._toneMapping},set:function(e){this._toneMapping!==e&&(this._toneMapping=e,this._shaderDirty=!0)}},{key:"sharpness",get:function(){return this._sharpness},set:function(e){this._sharpness!==e&&(this._sharpness=e,this._shaderDirty=!0)}},{key:"isSharpnessEnabled",get:function(){return this._sharpness>0}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Oi);function HA(o,a){return(HA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var WA=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n){(r=o.call(this,t)||this).historyIndex=0,r.historyTexture=null,r.historyTextures=[],r.historyRenderTargets=[],r.sourceTexture=e,r.cameraComponent=n,re.get(t,ue).set("sampleCatmullRomPS",`
vec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {
	vec2 samplePos = uv * texSize;
	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;
	vec2 f = samplePos - texPos1;
	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));
	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);
	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));
	vec2 w3 = f * f * (-0.5 + 0.5 * f);
	vec2 w12 = w1 + w2;
	vec2 offset12 = w2 / (w1 + w2);
	vec2 texPos0 = (texPos1 - 1.0) / texSize;
	vec2 texPos3 = (texPos1 + 2.0) / texSize;
	vec2 texPos12 = (texPos1 + offset12) / texSize;
	vec4 result = vec4(0.0);
	result += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`),re.get(t,he).set("sampleCatmullRomPS",`
fn SampleTextureCatmullRom(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, texSize: vec2f) -> vec4f {
	let samplePos: vec2f = uv * texSize;
	let texPos1: vec2f = floor(samplePos - 0.5) + 0.5;
	let f: vec2f = samplePos - texPos1;
	let w0: vec2f = f * (-0.5 + f * (1.0 - 0.5 * f));
	let w1: vec2f = 1.0 + f * f * (-2.5 + 1.5 * f);
	let w2: vec2f = f * (0.5 + f * (2.0 - 1.5 * f));
	let w3: vec2f = f * f * (-0.5 + 0.5 * f);
	let w12: vec2f = w1 + w2;
	let offset12: vec2f = w2 / w12;
	let texPos0: vec2f = (texPos1 - 1.0) / texSize;
	let texPos3: vec2f = (texPos1 + 2.0) / texSize;
	let texPos12: vec2f = (texPos1 + offset12) / texSize;
	var result: vec4f = vec4f(0.0);
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`),re.get(t,ue).set("taaResolvePS",`
	#include  "sampleCatmullRomPS"
	#include  "screenDepthPS"
	uniform sampler2D sourceTexture;
	uniform sampler2D historyTexture;
	uniform mat4 matrix_viewProjectionPrevious;
	uniform mat4 matrix_viewProjectionInverse;
	uniform vec4 jitters;
	uniform vec2 textureSize;
	varying vec2 uv0;
	vec2 reproject(vec2 uv, float depth) {
		#ifndef WEBGPU
			depth = depth * 2.0 - 1.0;
		#endif
		vec4 ndc = vec4(uv * 2.0 - 1.0, depth, 1.0);
		ndc.xy -= jitters.xy;
		vec4 worldPosition = matrix_viewProjectionInverse * ndc;
		worldPosition /= worldPosition.w;
		vec4 screenPrevious = matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	vec4 colorClamp(vec2 uv, vec4 historyColor) {
		vec3 minColor = vec3(9999.0);
		vec3 maxColor = vec3(-9999.0);
		for(float x = -1.0; x <= 1.0; ++x) {
			for(float y = -1.0; y <= 1.0; ++y) {
				vec3 color = texture2D(sourceTexture, uv + vec2(x, y) / textureSize).rgb;
				minColor = min(minColor, color);
				maxColor = max(maxColor, color);
			}
		}
		vec3 clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4(clamped, historyColor.a);
	}
	void main()
	{
		vec2 uv = uv0;
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		vec4 srcColor = texture2D(sourceTexture, uv);
		float linearDepth = getLinearScreenDepth(uv0);
		float depth = delinearizeDepth(linearDepth);
		vec2 historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			vec4 historyColor = SampleTextureCatmullRom(TEXTURE_PASS(historyTexture), historyUv, textureSize);
		#else
			vec4 historyColor = texture2D(historyTexture, historyUv);
		#endif
		vec4 historyColorClamped = colorClamp(uv, historyColor);
		float mixFactor = (historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0) ?
			1.0 : 0.05;
		gl_FragColor = mix(historyColorClamped, srcColor, mixFactor);
	}
`),re.get(t,he).set("taaResolvePS",`
	#include "sampleCatmullRomPS"
	#include "screenDepthPS"
	var sourceTexture: texture_2d<f32>;
	var sourceTextureSampler: sampler;
	var historyTexture: texture_2d<f32>;
	var historyTextureSampler: sampler;
	uniform matrix_viewProjectionPrevious: mat4x4f;
	uniform matrix_viewProjectionInverse: mat4x4f;
	uniform jitters: vec4f;
	uniform textureSize: vec2f;
	varying uv0: vec2f;
	fn reproject(uv: vec2f, depth: f32) -> vec2f {
		var ndc = vec4f(uv * 2.0 - 1.0, depth, 1.0);
		ndc = vec4f(ndc.xy - uniform.jitters.xy, ndc.zw);
		var worldPosition = uniform.matrix_viewProjectionInverse * ndc;
		worldPosition = worldPosition / worldPosition.w;
		let screenPrevious = uniform.matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	fn colorClamp(uv: vec2f, historyColor: vec4f) -> vec4f {
		var minColor = vec3f(9999.0);
		var maxColor = vec3f(-9999.0);
		for (var ix: i32 = -1; ix <= 1; ix = ix + 1) {
			for (var iy: i32 = -1; iy <= 1; iy = iy + 1) {
				let color_sample = textureSample(sourceTexture, sourceTextureSampler, uv + vec2f(f32(ix), f32(iy)) / uniform.textureSize).rgb;
				minColor = min(minColor, color_sample);
				maxColor = max(maxColor, color_sample);
			}
		}
		let clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4f(clamped, historyColor.a);
	}
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = input.uv0;
		uv.y = 1.0 - uv.y;
		let srcColor = textureSample(sourceTexture, sourceTextureSampler, uv);
		let linearDepth = getLinearScreenDepth(uv0);
		let depth = delinearizeDepth(linearDepth);
		let historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			var historyColor: vec4f = SampleTextureCatmullRom(historyTexture, historyTextureSampler, historyUv, uniform.textureSize);
		#else
			var historyColor: vec4f = textureSample(historyTexture, historyTextureSampler, historyUv);
		#endif
		let historyColorClamped = colorClamp(uv, historyColor);
		let mixFactor_condition = historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0;
		let mixFactor = select(0.05, 1.0, mixFactor_condition);
		output.color = mix(historyColorClamped, srcColor, mixFactor);
		return output;
	}
`);var r,s=new Map;s.set("QUALITY_HIGH",!0),Te.addScreenDepthChunkDefines(t,n.shaderParams,s),r.shader=Te.createShader(t,{uniqueName:"TaaResolveShader",attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"taaResolvePS",fragmentDefines:s});var l=t.scope;return r.sourceTextureId=l.resolve("sourceTexture"),r.textureSizeId=l.resolve("textureSize"),r.textureSize=new Float32Array(2),r.historyTextureId=l.resolve("historyTexture"),r.viewProjPrevId=l.resolve("matrix_viewProjectionPrevious"),r.viewProjInvId=l.resolve("matrix_viewProjectionInverse"),r.jittersId=l.resolve("jitters"),r.cameraParams=new Float32Array(4),r.cameraParamsId=l.resolve("camera_params"),r.setup(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&HA(a,o);var i=a.prototype;return i.destroy=function(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)},i.setup=function(){for(var t=0;t<2;++t)this.historyTextures[t]=new ee(this.device,{name:"TAA-History-"+t,width:4,height:4,format:this.sourceTexture.format,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),this.historyRenderTargets[t]=new Ee({colorBuffer:this.historyTextures[t],depth:!1});this.historyTexture=this.historyTextures[0],this.init(this.historyRenderTargets[0],{resizeSource:this.sourceTexture})},i.before=function(){this.sourceTextureId.setValue(this.sourceTexture),this.historyTextureId.setValue(this.historyTextures[1-this.historyIndex]),this.textureSize[0]=this.sourceTexture.width,this.textureSize[1]=this.sourceTexture.height,this.textureSizeId.setValue(this.textureSize);var t=this.cameraComponent.camera;this.viewProjPrevId.setValue(t._viewProjPrevious.data),this.viewProjInvId.setValue(t._viewProjInverse.data),this.jittersId.setValue(t._jitters);var e=t._farClip;this.cameraParams[0]=1/e,this.cameraParams[1]=e,this.cameraParams[2]=t._nearClip,this.cameraParams[3]=+(t.projection===1),this.cameraParamsId.setValue(this.cameraParams)},i.update=function(){return this.historyIndex=1-this.historyIndex,this.historyTexture=this.historyTextures[this.historyIndex],this.renderTarget=this.historyRenderTargets[this.historyIndex],this.historyTexture},a}(Oi);function jA(o,a){return(jA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var i3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e){(n=o.call(this,i)||this).cameraComponent=t,re.get(i,ue).set("cocPS",`
	#include "screenDepthPS"
	varying vec2 uv0;
	uniform vec3 params;
	void main()
	{
		float depth = getLinearScreenDepth(uv0);
		float focusDistance = params.x;
		float focusRange = params.y;
		float invRange = params.z;
		float farRange = focusDistance + focusRange * 0.5;
		
		float cocFar = min((depth - farRange) * invRange, 1.0);
		#ifdef NEAR_BLUR
			float nearRange = focusDistance - focusRange * 0.5;
			float cocNear = min((nearRange - depth) * invRange, 1.0);
		#else
			float cocNear = 0.0;
		#endif
		gl_FragColor = vec4(cocFar, cocNear, 0.0, 0.0);
	}
`),re.get(i,he).set("cocPS",`
#include "screenDepthPS"
varying uv0: vec2f;
uniform params: vec3f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let depth: f32 = getLinearScreenDepth(uv0);
	let focusDistance: f32 = uniform.params.x;
	let focusRange: f32 = uniform.params.y;
	let invRange: f32 = uniform.params.z;
	let farRange: f32 = focusDistance + focusRange * 0.5;
	let cocFar: f32 = min((depth - farRange) * invRange, 1.0);
	#ifdef NEAR_BLUR
		let nearRange: f32 = focusDistance - focusRange * 0.5;
		var cocNear: f32 = min((nearRange - depth) * invRange, 1.0);
	#else
		var cocNear: f32 = 0.0;
	#endif
	output.color = vec4f(cocFar, cocNear, 0.0, 0.0);
	return output;
}
`);var n,r=new Map;return e&&r.set("NEAR_BLUR",""),Te.addScreenDepthChunkDefines(i,t.shaderParams,r),n.shader=Te.createShader(i,{uniqueName:"CocShader-"+e,attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"cocPS",fragmentDefines:r}),n.paramsId=i.scope.resolve("params"),n.paramsValue=new Float32Array(3),n.cameraParams=new Float32Array(4),n.cameraParamsId=i.scope.resolve("camera_params"),n}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&jA(a,o),a.prototype.execute=function(){var i=this.paramsValue,t=this.focusRange;i[0]=this.focusDistance+.001,i[1]=t,i[2]=1/t,this.paramsId.setValue(i);var e=this.cameraComponent.camera,n=e._farClip;this.cameraParams[0]=1/n,this.cameraParams[1]=n,this.cameraParams[2]=e._nearClip,this.cameraParams[3]=+(e.projection===1),this.cameraParamsId.setValue(this.cameraParams),o.prototype.execute.call(this)},a}(Oi);function XA(o,a){return(XA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var r3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r,s){(l=o.call(this,e)||this).blurRadiusNear=1,l.blurRadiusFar=1,l._blurRings=3,l._blurRingPoints=3,l.nearTexture=n,l.farTexture=r,l.cocTexture=s,re.get(e,ue).set("dofBlurPS",`
	#if defined(NEAR_BLUR)
		uniform sampler2D nearTexture;
	#endif
	uniform sampler2D farTexture;
	uniform sampler2D cocTexture;
	uniform vec2 kernel[{KERNEL_COUNT}];
	uniform float blurRadiusNear;
	uniform float blurRadiusFar;
	varying vec2 uv0;
	void main()
	{
		vec2 coc = texture2D(cocTexture, uv0).rg;
		float cocFar = coc.r;
		vec3 sum = vec3(0.0, 0.0, 0.0);
		#if defined(NEAR_BLUR)
			float cocNear = coc.g;
			if (cocNear > 0.0001) {
				ivec2 nearTextureSize = textureSize(nearTexture, 0);
				vec2 step = cocNear * blurRadiusNear / vec2(nearTextureSize);
				for (int i = 0; i < {KERNEL_COUNT}; i++) {
					vec2 uv = uv0 + step * kernel[i];
					vec3 tap = texture2DLod(nearTexture, uv, 0.0).rgb;
					sum += tap.rgb;
				}
				sum *= float({INV_KERNEL_COUNT});
			} else
		#endif
			
			if (cocFar > 0.0001) {
			ivec2 farTextureSize = textureSize(farTexture, 0);
			vec2 step = cocFar * blurRadiusFar / vec2(farTextureSize);
			float sumCoC = 0.0; 
			for (int i = 0; i < {KERNEL_COUNT}; i++) {
				vec2 uv = uv0 + step * kernel[i];
				vec3 tap = texture2DLod(farTexture, uv, 0.0).rgb;
				float cocThis = texture2DLod(cocTexture, uv, 0.0).r;
				tap *= cocThis;
				sumCoC += cocThis;
				sum += tap;
			}
			if (sumCoC > 0.0)
				sum /= sumCoC;
			sum /= cocFar;
		}
		pcFragColor0 = vec4(sum, 1.0);
	}
`),re.get(e,he).set("dofBlurPS",`
#if defined(NEAR_BLUR)
	var nearTexture: texture_2d<f32>;
	var nearTextureSampler: sampler;
#endif
var farTexture: texture_2d<f32>;
var farTextureSampler: sampler;
var cocTexture: texture_2d<f32>;
var cocTextureSampler: sampler;
uniform kernel: array<vec2f, {KERNEL_COUNT}>;
uniform blurRadiusNear: f32;
uniform blurRadiusFar: f32;
varying uv0: vec2f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let coc: vec2f = textureSample(cocTexture, cocTextureSampler, input.uv0).rg;
	let cocFar: f32 = coc.r;
	var sum: vec3f = vec3f(0.0, 0.0, 0.0);
	#if defined(NEAR_BLUR)
		let cocNear: f32 = coc.g;
		if (cocNear > 0.0001) {
			let nearTextureSize: vec2f = vec2f(textureDimensions(nearTexture, 0));
			let step: vec2f = cocNear * uniform.blurRadiusNear / nearTextureSize;
			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {
				let uv: vec2f = uv0 + step * uniform.kernel[i].element;
				let tap: vec3f = textureSampleLevel(nearTexture, nearTextureSampler, uv, 0.0).rgb;
				sum = sum + tap;
			}
			sum = sum * f32({INV_KERNEL_COUNT});
		} else
	#endif
		if (cocFar > 0.0001) {
			let farTextureSize: vec2f = vec2f(textureDimensions(farTexture, 0));
			let step: vec2f = cocFar * uniform.blurRadiusFar / farTextureSize;
			var sumCoC: f32 = 0.0;
			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {
				let uv: vec2f = uv0 + step * uniform.kernel[i].element;
				var tap: vec3f = textureSampleLevel(farTexture, farTextureSampler, uv, 0.0).rgb;
				let cocThis: f32 = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).r;
				tap = tap * cocThis;
				sumCoC = sumCoC + cocThis;
				sum = sum + tap;
			}
			if (sumCoC > 0.0) {
				sum = sum / sumCoC;
			}
			sum = sum / cocFar;
		}
	output.color = vec4f(sum, 1.0);
	return output;
}
`);var l,u=e.scope;return l.kernelId=u.resolve("kernel[0]"),l.kernelCountId=u.resolve("kernelCount"),l.blurRadiusNearId=u.resolve("blurRadiusNear"),l.blurRadiusFarId=u.resolve("blurRadiusFar"),l.nearTextureId=u.resolve("nearTexture"),l.farTextureId=u.resolve("farTexture"),l.cocTextureId=u.resolve("cocTexture"),l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&XA(a,o);var i,t=a.prototype;return t.createShader=function(){this.kernel=new Float32Array(e_.concentric(this.blurRings,this.blurRingPoints));var e=this.kernel.length>>1,n=this.nearTexture!==null,r=new Map;r.set("{KERNEL_COUNT}",e),r.set("{INV_KERNEL_COUNT}",1/e),n&&r.set("NEAR_BLUR",""),this.shader=Te.createShader(this.device,{uniqueName:"DofBlurShader-"+e+"-"+(n?"nearBlur":"noNearBlur"),attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"dofBlurPS",fragmentDefines:r})},t.execute=function(){this.shader||this.createShader(),this.nearTextureId.setValue(this.nearTexture),this.farTextureId.setValue(this.farTexture),this.cocTextureId.setValue(this.cocTexture),this.kernelId.setValue(this.kernel),this.kernelCountId.setValue(this.kernel.length>>1),this.blurRadiusNearId.setValue(this.blurRadiusNear),this.blurRadiusFarId.setValue(this.blurRadiusFar),o.prototype.execute.call(this)},i=[{key:"blurRings",get:function(){return this._blurRings},set:function(e){this._blurRings!==e&&(this._blurRings=e,this.shader=null)}},{key:"blurRingPoints",get:function(){return this._blurRingPoints},set:function(e){this._blurRingPoints!==e&&(this._blurRingPoints=e,this.shader=null)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Oi);function YA(o,a){return(YA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var qA=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s,l){(u=o.call(this,t)||this).focusDistance=100,u.focusRange=50,u.blurRadius=1,u.blurRings=3,u.blurRingPoints=3,u.highQuality=!0,u.cocTexture=null,u.blurTexture=null,u.cocPass=null,u.farPass=null,u.blurPass=null,u.highQuality=s,u.cocPass=u.setupCocPass(t,e,n,l),u.beforePasses.push(u.cocPass);var u,c=s?n:r;return u.farPass=u.setupFarPass(t,c,.5),u.beforePasses.push(u.farPass),u.blurPass=u.setupBlurPass(t,r,l,s?2:.5),u.beforePasses.push(u.blurPass),u}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&YA(a,o);var i=a.prototype;return i.destroy=function(){this.destroyRenderPasses(),this.cocPass=null,this.farPass=null,this.blurPass=null,this.destroyRT(this.cocRT),this.destroyRT(this.farRt),this.destroyRT(this.blurRt),this.cocRT=null,this.farRt=null,this.blurRt=null},i.destroyRenderPasses=function(){for(var t=0;t<this.beforePasses.length;t++)this.beforePasses[t].destroy();this.beforePasses.length=0},i.destroyRT=function(t){t&&(t.destroyTextureBuffers(),t.destroy())},i.setupCocPass=function(t,e,n,r){this.cocRT=this.createRenderTarget("CoCTexture",r?53:52),this.cocTexture=this.cocRT.colorBuffer;var s=new i3(t,e,r);return s.init(this.cocRT,{resizeSource:n}),s.setClearColor(B.BLACK),s},i.setupFarPass=function(t,e,n){this.farRt=this.createRenderTarget("FarDofTexture",e.format);var r=new ih(t,e,{boxFilter:!0,premultiplyTexture:this.cocTexture,premultiplySrcChannel:"r"});return r.init(this.farRt,{resizeSource:e,scaleX:n,scaleY:n}),r.setClearColor(B.BLACK),r},i.setupBlurPass=function(t,e,n,r){var s,l=(s=this.farRt)==null?void 0:s.colorBuffer;this.blurRt=this.createRenderTarget("DofBlurTexture",e.format),this.blurTexture=this.blurRt.colorBuffer;var u=new r3(t,n?e:null,l,this.cocTexture);return u.init(this.blurRt,{resizeSource:e,scaleX:r,scaleY:r}),u.setClearColor(B.BLACK),u},i.createTexture=function(t,e){return new ee(this.device,{name:t,width:1,height:1,format:e,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1})},i.createRenderTarget=function(t,e){return new Ee({colorBuffer:this.createTexture(t,e),depth:!1,stencil:!1})},i.frameUpdate=function(){o.prototype.frameUpdate.call(this),this.cocPass.focusDistance=this.focusDistance,this.cocPass.focusRange=this.focusRange,this.blurPass.blurRadiusNear=this.blurRadius,this.blurPass.blurRadiusFar=this.blurRadius*(this.highQuality?1:.5),this.blurPass.blurRings=this.blurRings,this.blurPass.blurRingPoints=this.blurRingPoints},a}(ct);function KA(o,a){return(KA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var _m=[],ZA=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(t,e,n,r,s){var l;return(l=o.call(this,t)||this).viewBindGroups=[],l.linearDepthClearValue=new B(0,0,0,0),l.scene=e,l.renderer=n,l.camera=r,l.setupRenderTarget(s),l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&KA(a,o);var i=a.prototype;return i.destroy=function(){var t,e;o.prototype.destroy.call(this),(t=this.renderTarget)==null||t.destroy(),this.renderTarget=null,(e=this.linearDepthTexture)==null||e.destroy(),this.linearDepthTexture=null,this.viewBindGroups.forEach(function(n){n.defaultUniformBuffer.destroy(),n.destroy()}),this.viewBindGroups.length=0},i.setupRenderTarget=function(t){var e=this.device;this.linearDepthFormat=e.textureFloatRenderable?15:7,this.linearDepthTexture=new ee(e,{name:"SceneLinearDepthTexture",width:1,height:1,format:this.linearDepthFormat,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});var n=new Ee({name:"PrepassRT",colorBuffer:this.linearDepthTexture,depth:!0,samples:1});this.camera.shaderParams.sceneDepthMapLinear=!0,this.init(n,t)},i.after=function(){this.device.scope.resolve("uSceneDepthMap").setValue(this.linearDepthTexture)},i.execute=function(){for(var t=this.renderer,e=this.scene,n=this.renderTarget,r=this.camera.camera,s=e.layers.layerList,l=e.layers.subLayerEnabled,u=e.layers.subLayerList,c=0;c<s.length;c++){var h=s[c];if(h.id===1)break;if(h.enabled&&l[c]&&h.camerasSet.has(r)){for(var f=h.getCulledInstances(r),d=u[c]?f.transparent:f.opaque,p=0;p<d.length;p++){var _,g=d[p];(_=g.material)!=null&&_.depthWrite&&_m.push(g)}t.renderForwardLayer(r,n,null,void 0,1,this.viewBindGroups,{meshInstances:_m}),_m.length=0}}},i.frameUpdate=function(){o.prototype.frameUpdate.call(this);var t,e=this.camera;if(this.setClearDepth(e.clearDepthBuffer?1:void 0),e.clearDepthBuffer){var n=e.farClip-Number.MIN_VALUE;t=this.linearDepthClearValue,this.linearDepthFormat===15?t.r=n:pi.float2RGBA8(n,t)}this.setClearColor(t)},a}(ct);function QA(o,a){return(QA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var vm=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(i,t,e,n){(r=o.call(this,i)||this).sourceTexture=t,re.get(i,ue).set("depthAwareBlurPS",`
	#include "screenDepthPS"
	varying vec2 uv0;
	uniform sampler2D sourceTexture;
	uniform vec2 sourceInvResolution;
	uniform int filterSize;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	mediump float bilateralWeight(in mediump float depth, in mediump float sampleDepth) {
		mediump float diff = (sampleDepth - depth);
		return max(0.0, 1.0 - diff * diff);
	}
	void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {
		mediump float color = texture2D(sourceTexture, position).r;
		mediump float textureDepth = -getLinearScreenDepth(position);
	
		mediump float bilateral = bilateralWeight(depth, textureDepth);
		bilateral *= weight;
		sum += color * bilateral;
		totalWeight += bilateral;
	}
	void main() {
		mediump float depth = -getLinearScreenDepth(uv0);
		mediump float totalWeight = 1.0;
		mediump float color = texture2D(sourceTexture, uv0 ).r;
		mediump float sum = color * totalWeight;
		for (mediump int i = -filterSize; i <= filterSize; i++) {
			mediump float weight = 1.0;
			#ifdef HORIZONTAL
				vec2 offset = vec2(i, 0) * sourceInvResolution;
			#else
				vec2 offset = vec2(0, i) * sourceInvResolution;
			#endif
			tap(sum, totalWeight, weight, depth, uv0 + offset);
		}
		mediump float ao = sum / totalWeight;
		gl_FragColor.r = ao;
	}
`),re.get(i,he).set("depthAwareBlurPS",`
#include "screenDepthPS"
varying uv0: vec2f;
var sourceTexture: texture_2d<f32>;
var sourceTextureSampler: sampler;
uniform sourceInvResolution: vec2f;
uniform filterSize: i32;
fn random(w: vec2f) -> f32 {
	const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);
	return fract(m.z * fract(dot(w, m.xy)));
}
fn bilateralWeight(depth: f32, sampleDepth: f32) -> f32 {
	let diff: f32 = (sampleDepth - depth);
	return max(0.0, 1.0 - diff * diff);
}
fn tap(sum_ptr: ptr<function, f32>, totalWeight_ptr: ptr<function, f32>, weight: f32, depth: f32, position: vec2f) {
	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, position).r;
	let textureDepth: f32 = -getLinearScreenDepth(position);
	let bilateral: f32 = bilateralWeight(depth, textureDepth) * weight;
	*sum_ptr = *sum_ptr + color * bilateral;
	*totalWeight_ptr = *totalWeight_ptr + bilateral;
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let depth: f32 = -getLinearScreenDepth(input.uv0);
	var totalWeight: f32 = 1.0;
	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, input.uv0 ).r;
	var sum: f32 = color * totalWeight;
	for (var i: i32 = -uniform.filterSize; i <= uniform.filterSize; i = i + 1) {
		let weight: f32 = 1.0;
		#ifdef HORIZONTAL
			var offset: vec2f = vec2f(f32(i), 0.0) * uniform.sourceInvResolution;
		#else
			var offset: vec2f = vec2f(0.0, f32(i)) * uniform.sourceInvResolution;
		#endif
		tap(&sum, &totalWeight, weight, depth, input.uv0 + offset);
	}
	let ao: f32 = sum / totalWeight;
	output.color = vec4f(ao, ao, ao, 1.0);
	return output;
}
`);var r,s=new Map;n&&s.set("HORIZONTAL",""),Te.addScreenDepthChunkDefines(i,e.shaderParams,s),r.shader=Te.createShader(i,{uniqueName:"DepthAware"+(n?"Horizontal":"Vertical")+"BlurShader",attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"depthAwareBlurPS",fragmentDefines:s});var l=r.device.scope;return r.sourceTextureId=l.resolve("sourceTexture"),r.sourceInvResolutionId=l.resolve("sourceInvResolution"),r.sourceInvResolutionValue=new Float32Array(2),r.filterSizeId=l.resolve("filterSize"),r}return a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&QA(a,o),a.prototype.execute=function(){this.filterSizeId.setValue(4),this.sourceTextureId.setValue(this.sourceTexture);var i=this.sourceTexture,t=i.width,e=i.height;this.sourceInvResolutionValue[0]=1/t,this.sourceInvResolutionValue[1]=1/e,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),o.prototype.execute.call(this)},a}(Oi);function JA(o,a){return(JA=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var $A=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r,s){(l=o.call(this,e)||this).radius=5,l.intensity=1,l.power=1,l.sampleCount=10,l.minAngle=5,l.randomize=!1,l._scale=1,l._blueNoise=new qg(19),l.sourceTexture=n,l.cameraComponent=r,re.get(e,ue).set("ssaoPS",`
	#include "screenDepthPS"
	
	varying vec2 uv0;
	uniform vec2 uInvResolution;
	uniform float uAspect;
	#define saturate(x) clamp(x,0.0,1.0)
	highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {
		return -v.z;
	}
	highp float getViewSpaceZFromW(const mat4 p, const float w) {
		return -w;
	}
	const float kLog2LodRate = 3.0;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	highp vec2 getFragCoord() {
		return gl_FragCoord.xy;
	}
	highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {
		return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);
	}
	highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {
		return normalize(cross(dpdx, dpdy));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position) {
		return faceNormal(dFdx(position), dFdy(position));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {
		highp vec2 uvdx = uv + vec2(uInvResolution.x, 0.0);
		highp vec2 uvdy = uv + vec2(0.0, uInvResolution.y);
		highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		highp vec3 dpdx = px - position;
		highp vec3 dpdy = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform vec2 uSampleCount;
	uniform float uSpiralTurns;
	#define PI (3.14159)
	mediump vec3 tapLocation(mediump float i, const mediump float noise) {
		mediump float offset = ((2.0 * PI) * 2.4) * noise;
		mediump float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(cos(angle), sin(angle), radius * radius);
	}
	highp vec2 startPosition(const float noise) {
		float angle = ((2.0 * PI) * 2.4) * noise;
		return vec2(cos(angle), sin(angle));
	}
	uniform vec2 uAngleIncCosSin;
	highp mat2 tapAngleStep() {
		highp vec2 t = uAngleIncCosSin;
		return mat2(t.x, t.y, -t.y, t.x);
	}
	mediump vec3 tapLocationFast(mediump float i, mediump vec2 p, const mediump float noise) {
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(p, radius * radius);
	}
	uniform float uMaxLevel;
	uniform float uInvRadiusSquared;
	uniform float uMinHorizonAngleSineSquared;
	uniform float uBias;
	uniform float uPeak2;
	void computeAmbientOcclusionSAO(inout mediump float occlusion, mediump float i, mediump float ssDiskRadius,
			const highp vec2 uv, const highp vec3 origin, const mediump vec3 normal,
			const mediump vec2 tapPosition, const float noise) {
		mediump vec3 tap = tapLocationFast(i, tapPosition, noise);
		mediump float ssRadius = max(1.0, tap.z * ssDiskRadius);
		mediump vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uInvResolution;
		mediump float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));
		highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);
		highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		vec3 v = p - origin;
		float vv = dot(v, v);
		float vn = dot(v, normal);
		mediump float w = max(0.0, 1.0 - vv * uInvRadiusSquared);
		w = w * w;
		w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);
		occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);
	}
	uniform float uProjectionScaleRadius;
	uniform float uIntensity;
	uniform float uRandomize;
	float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {
		float noise = random(getFragCoord()) + uRandomize;
		highp vec2 tapPosition = startPosition(noise);
		highp mat2 angleStep = tapAngleStep();
		float ssDiskRadius = -(uProjectionScaleRadius / origin.z);
		float occlusion = 0.0;
		for (float i = 0.0; i < uSampleCount.x; i += 1.0) {
			computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform float uPower;
	void main() {
		highp vec2 uv = uv0;
		highp float depth = -getLinearScreenDepth(uv0);
		highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);
		vec3 normal = computeViewSpaceNormal(origin, uv);
		float occlusion = 0.0;
		if (uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		float ao = max(0.0, 1.0 - occlusion * uIntensity);
		ao = pow(ao, uPower);
		gl_FragColor = vec4(ao, ao, ao, 1.0);
	}
`),re.get(e,he).set("ssaoPS",`
	#include "screenDepthPS"
	varying uv0: vec2f;
	uniform uInvResolution: vec2f;
	uniform uAspect: f32;
	fn getWFromProjectionMatrix(p: mat4x4f, v: vec3f) -> f32 {
		return -v.z;
	}
	fn getViewSpaceZFromW(p: mat4x4f, w: f32) -> f32 {
		return -w;
	}
	const kLog2LodRate: f32 = 3.0;
	fn random(w: vec2f) -> f32 {
		const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	fn getFragCoord() -> vec2f {
		return pcPosition.xy;
	}
	fn computeViewSpacePositionFromDepth(uv: vec2f, linearDepth: f32) -> vec3f {
		return vec3f((0.5 - uv) * vec2f(uniform.uAspect, 1.0) * linearDepth, linearDepth);
	}
	fn faceNormal(dpdx: vec3f, dpdy: vec3f) -> vec3f {
		return normalize(cross(dpdx, dpdy));
	}
	fn computeViewSpaceNormalDeriv(position: vec3f) -> vec3f {
		return faceNormal(dpdx(position), dpdy(position));
	}
	fn computeViewSpaceNormalDepth(position: vec3f, uv: vec2f) -> vec3f {
		let uvdx: vec2f = uv + vec2f(uniform.uInvResolution.x, 0.0);
		let uvdy: vec2f = uv + vec2f(0.0, uniform.uInvResolution.y);
		let px: vec3f = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		let py: vec3f = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		let dpdx: vec3f = px - position;
		let dpdy: vec3f = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform uSampleCount: vec2f;
	uniform uSpiralTurns: f32;
	const PI: f32 = 3.14159;
	fn tapLocation(i: f32, noise: f32) -> vec3f {
		let offset: f32 = ((2.0 * PI) * 2.4) * noise;
		let angle: f32 = ((i * uniform.uSampleCount.y) * uniform.uSpiralTurns) * (2.0 * PI) + offset;
		let radius: f32 = (i + noise + 0.5) * uniform.uSampleCount.y;
		return vec3f(cos(angle), sin(angle), radius * radius);
	}
	fn startPosition(noise: f32) -> vec2f {
		let angle: f32 = ((2.0 * PI) * 2.4) * noise;
		return vec2f(cos(angle), sin(angle));
	}
	uniform uAngleIncCosSin: vec2f;
	fn tapAngleStep() -> mat2x2f {
		let t: vec2f = uniform.uAngleIncCosSin;
		return mat2x2f(vec2f(t.x, t.y), vec2f(-t.y, t.x));
	}
	fn tapLocationFast(i: f32, p: vec2f, noise_in: f32) -> vec3f {
		let radius: f32 = (i + noise_in + 0.5) * uniform.uSampleCount.y;
		return vec3f(p.x, p.y, radius * radius);
	}
	uniform uMaxLevel: f32;
	uniform uInvRadiusSquared: f32;
	uniform uMinHorizonAngleSineSquared: f32;
	uniform uBias: f32;
	uniform uPeak2: f32;
	fn computeAmbientOcclusionSAO(occlusion_ptr: ptr<function, f32>, i: f32, ssDiskRadius: f32,
			uv: vec2f, origin: vec3f, normal: vec3f,
			tapPosition: vec2f, noise: f32) {
		let tap: vec3f = tapLocationFast(i, tapPosition, noise);
		let ssRadius: f32 = max(1.0, tap.z * ssDiskRadius);
		let uvSamplePos: vec2f = uv + (ssRadius * tap.xy) * uniform.uInvResolution;
		let level: f32 = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, uniform.uMaxLevel);
		let occlusionDepth: f32 = -getLinearScreenDepth(uvSamplePos);
		let p: vec3f = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		let v: vec3f = p - origin;
		let vv: f32 = dot(v, v);
		let vn: f32 = dot(v, normal);
		var w_val: f32 = max(0.0, 1.0 - vv * uniform.uInvRadiusSquared);
		w_val = w_val * w_val;
		w_val = w_val * step(vv * uniform.uMinHorizonAngleSineSquared, vn * vn);
		*occlusion_ptr = *occlusion_ptr + w_val * max(0.0, vn + origin.z * uniform.uBias) / (vv + uniform.uPeak2);
	}
	uniform uProjectionScaleRadius: f32;
	uniform uIntensity: f32;
	uniform uRandomize: f32;
	fn scalableAmbientObscurance(uv: vec2f, origin: vec3f, normal: vec3f) -> f32 {
		let noise: f32 = random(getFragCoord()) + uniform.uRandomize;
		var tapPosition: vec2f = startPosition(noise);
		let angleStep: mat2x2f = tapAngleStep();
		let ssDiskRadius: f32 = -(uniform.uProjectionScaleRadius / origin.z);
		var occlusion: f32 = 0.0;
		for (var i: i32 = 0; i < i32(uniform.uSampleCount.x); i = i + 1) {
			computeAmbientOcclusionSAO(&occlusion, f32(i), ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform uPower: f32;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let uv: vec2f = input.uv0;
		let depth: f32 = -getLinearScreenDepth(input.uv0);
		let origin: vec3f = computeViewSpacePositionFromDepth(uv, depth);
		let normal: vec3f = computeViewSpaceNormalDepth(origin, uv);
		var occlusion: f32 = 0.0;
		if (uniform.uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		var ao: f32 = max(0.0, 1.0 - occlusion * uniform.uIntensity);
		ao = pow(ao, uniform.uPower);
		output.color = vec4f(ao, ao, ao, 1.0);
		return output;
	}
`);var l,u=new Map;Te.addScreenDepthChunkDefines(e,r.shaderParams,u),l.shader=Te.createShader(e,{uniqueName:"SsaoShader",attributes:{aPosition:oe},vertexChunk:"quadVS",fragmentChunk:"ssaoPS",fragmentDefines:u});var c=l.createRenderTarget("SsaoFinalTexture");l.ssaoTexture=c.colorBuffer,l.init(c,{resizeSource:l.sourceTexture});var h=new B(0,0,0,0);if(l.setClearColor(h),s){var f=l.createRenderTarget("SsaoTempTexture"),d=new vm(e,c.colorBuffer,r,!0);d.init(f,{resizeSource:c.colorBuffer}),d.setClearColor(h);var p=new vm(e,f.colorBuffer,r,!1);p.init(c,{resizeSource:c.colorBuffer}),p.setClearColor(h),l.afterPasses.push(d),l.afterPasses.push(p)}return l.ssaoTextureId=e.scope.resolve("ssaoTexture"),l.ssaoTextureSizeInvId=e.scope.resolve("ssaoTextureSizeInv"),l}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&JA(a,o);var i,t=a.prototype;return t.destroy=function(){var e,n;if((e=this.renderTarget)==null||e.destroyTextureBuffers(),(n=this.renderTarget)==null||n.destroy(),this.renderTarget=null,this.afterPasses.length>0){var r=this.afterPasses[0].renderTarget;r==null||r.destroyTextureBuffers(),r==null||r.destroy()}this.afterPasses.forEach(function(s){return s.destroy()}),this.afterPasses.length=0,o.prototype.destroy.call(this)},t.createRenderTarget=function(e){return new Ee({depth:!1,colorBuffer:new ee(this.device,{name:e,width:1,height:1,format:52,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})})},t.execute=function(){var e=this.device,n=this.sourceTexture,r=this.sampleCount,s=this.minAngle,l=this.scale,u=this.renderTarget.colorBuffer,c=u.width,h=u.height,f=e.scope;f.resolve("uAspect").setValue(c/h),f.resolve("uInvResolution").setValue([1/c,1/h]),f.resolve("uSampleCount").setValue([r,1/r]);var d=Math.sin(s*Math.PI/180);f.resolve("uMinHorizonAngleSineSquared").setValue(d*d);var p=1/(r-.5)*62.82,_=this.radius/l,g=.1*_,y=2*g*6.282*this.intensity/r,v=.5*n.height;f.resolve("uSpiralTurns").setValue(10),f.resolve("uAngleIncCosSin").setValue([Math.cos(p),Math.sin(p)]),f.resolve("uMaxLevel").setValue(0),f.resolve("uInvRadiusSquared").setValue(1/(_*_)),f.resolve("uBias").setValue(.001),f.resolve("uPeak2").setValue(g*g),f.resolve("uIntensity").setValue(y),f.resolve("uPower").setValue(this.power),f.resolve("uProjectionScaleRadius").setValue(v*_),f.resolve("uRandomize").setValue(this.randomize?this._blueNoise.value():0),o.prototype.execute.call(this)},t.after=function(){this.ssaoTextureId.setValue(this.ssaoTexture);var e=this.sourceTexture;this.ssaoTextureSizeInvId.setValue([1/e.width,1/e.height])},i=[{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.scaleX=e,this.scaleY=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Oi);function eC(o,a){return(eC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var gm=function(){this.stencil=!1,this.samples=1,this.sceneColorMap=!1,this.lastGrabLayerId=2,this.lastGrabLayerIsTransparent=!1,this.lastSceneLayerId=3,this.lastSceneLayerIsTransparent=!0,this.taaEnabled=!1,this.bloomEnabled=!1,this.ssaoType=ys,this.ssaoBlurEnabled=!0,this.prepassEnabled=!1,this.dofEnabled=!1,this.dofNearBlur=!1,this.dofHighQuality=!0},s3=new gm,tC=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n,r){var s;return r===void 0&&(r={}),(s=o.call(this,e.graphicsDevice)||this)._renderTargetScale=1,s.layersDirty=!1,s.rt=null,s.app=e,s.cameraComponent=n,s.options=s.sanitizeOptions(r),s.setupRenderPasses(s.options),s}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&eC(a,o);var i,t=a.prototype;return t.destroy=function(){this.reset()},t.reset=function(){this.sceneTexture=null,this.sceneTextureHalf=null,this.rt&&(this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null),this.rtHalf&&(this.rtHalf.destroyTextureBuffers(),this.rtHalf.destroy(),this.rtHalf=null),this.beforePasses.forEach(function(e){return e.destroy()}),this.beforePasses.length=0,this.prePass=null,this.scenePass=null,this.scenePassTransparent=null,this.colorGrabPass=null,this.composePass=null,this.bloomPass=null,this.ssaoPass=null,this.taaPass=null,this.afterPass=null,this.scenePassHalf=null,this.dofPass=null},t.sanitizeOptions=function(e){return((e=Object.assign({},s3,e)).taaEnabled||e.ssaoType!==ys||e.dofEnabled)&&(e.prepassEnabled=!0),e},t.needsReset=function(e){var n,r,s=this.options;return e.ssaoType!==s.ssaoType||e.ssaoBlurEnabled!==s.ssaoBlurEnabled||e.taaEnabled!==s.taaEnabled||e.samples!==s.samples||e.stencil!==s.stencil||e.bloomEnabled!==s.bloomEnabled||e.prepassEnabled!==s.prepassEnabled||e.sceneColorMap!==s.sceneColorMap||e.dofEnabled!==s.dofEnabled||e.dofNearBlur!==s.dofNearBlur||e.dofHighQuality!==s.dofHighQuality||(n=e.formats)!==(r=s.formats)&&(!(Array.isArray(n)&&Array.isArray(r))||n.length!==r.length||!n.every(function(l,u){return l===r[u]}))},t.update=function(e){e=this.sanitizeOptions(e),(this.needsReset(e)||this.layersDirty)&&(this.layersDirty=!1,this.reset()),this.options=e,this.sceneTexture||this.setupRenderPasses(this.options)},t.createRenderTarget=function(e,n,r,s,l){return new Ee({colorBuffer:new ee(this.device,{name:e,width:4,height:4,format:this.hdrFormat,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),depth:n,stencil:r,samples:s,flipY:l})},t.setupRenderPasses=function(e){var n=this.device,r=this.cameraComponent,s=r.renderTarget;this.hdrFormat=n.getRenderableHdrFormat(e.formats,!0,e.samples)||7,this._bloomEnabled=e.bloomEnabled&&this.hdrFormat!==7,this._sceneHalfEnabled=this._bloomEnabled||e.dofEnabled,r.shaderParams.ssaoEnabled=e.ssaoType===OA;var l=!!(s!=null&&s.flipY);this.rt=this.createRenderTarget("SceneColor",!0,e.stencil,e.samples,l),this.sceneTexture=this.rt.colorBuffer,this._sceneHalfEnabled&&(this.rtHalf=this.createRenderTarget("SceneColorHalf",!1,!1,1,l),this.sceneTextureHalf=this.rtHalf.colorBuffer),this.sceneOptions={resizeSource:s,scaleX:this.renderTargetScale,scaleY:this.renderTargetScale},this.createPasses(e);var u=this.collectPasses();this.beforePasses=u.filter(function(c){return c!=null})},t.collectPasses=function(){return[this.prePass,this.ssaoPass,this.scenePass,this.colorGrabPass,this.scenePassTransparent,this.taaPass,this.scenePassHalf,this.bloomPass,this.dofPass,this.composePass,this.afterPass]},t.createPasses=function(e){this.setupScenePrepass(e),this.setupSsaoPass(e);var n=this.setupScenePass(e),r=this.setupTaaPass(e);this.setupSceneHalfPass(e,r),this.setupBloomPass(e,this.sceneTextureHalf),this.setupDofPass(e,this.sceneTexture,this.sceneTextureHalf),this.setupComposePass(e),this.setupAfterPass(e,n)},t.setupScenePrepass=function(e){if(e.prepassEnabled){var n=this.app,r=this.device,s=this.cameraComponent,l=n.scene,u=n.renderer;this.prePass=new ZA(r,l,u,s,this.sceneOptions)}},t.setupScenePassSettings=function(e){e.gammaCorrection=0,e.toneMapping=6},t.setupScenePass=function(e){var n=this.app,r=this.device,s=this.cameraComponent,l=n.scene,u=n.renderer,c=l.layers;this.scenePass=new Uo(r,c,l,u),this.setupScenePassSettings(this.scenePass),this.scenePass.init(this.rt,this.sceneOptions);var h=e.sceneColorMap?e.lastGrabLayerId:e.lastSceneLayerId,f=e.sceneColorMap?e.lastGrabLayerIsTransparent:e.lastSceneLayerIsTransparent,d={lastAddedIndex:0,clearRenderTarget:!0};return d.lastAddedIndex=this.scenePass.addLayers(c,s,d.lastAddedIndex,d.clearRenderTarget,h,f),d.clearRenderTarget=!1,e.sceneColorMap&&(this.colorGrabPass=new Bf(r),this.colorGrabPass.source=this.rt,this.scenePassTransparent=new Uo(r,c,l,u),this.setupScenePassSettings(this.scenePassTransparent),this.scenePassTransparent.init(this.rt),d.lastAddedIndex=this.scenePassTransparent.addLayers(c,s,d.lastAddedIndex,d.clearRenderTarget,e.lastSceneLayerId,e.lastSceneLayerIsTransparent),this.scenePassTransparent.rendersAnything||(this.scenePassTransparent.destroy(),this.scenePassTransparent=null),this.scenePassTransparent&&e.prepassEnabled&&(this.scenePassTransparent.depthStencilOps.storeDepth=!0)),d},t.setupSsaoPass=function(e){var n=e.ssaoBlurEnabled,r=e.ssaoType,s=this.device,l=this.cameraComponent;r!==ys&&(this.ssaoPass=new $A(s,this.sceneTexture,l,n))},t.setupSceneHalfPass=function(e,n){this._sceneHalfEnabled&&(this.scenePassHalf=new ih(this.device,this.sceneTexture,{boxFilter:!0,removeInvalid:!0}),this.scenePassHalf.name="RenderPassSceneHalf",this.scenePassHalf.init(this.rtHalf,{resizeSource:n,scaleX:.5,scaleY:.5}),this.scenePassHalf.setClearColor(B.BLACK))},t.setupBloomPass=function(e,n){this._bloomEnabled&&(this.bloomPass=new VA(this.device,n,this.hdrFormat))},t.setupDofPass=function(e,n,r){e.dofEnabled&&(this.dofPass=new qA(this.device,this.cameraComponent,n,r,e.dofHighQuality,e.dofNearBlur))},t.setupTaaPass=function(e){var n=this.sceneTexture;return e.taaEnabled&&(this.taaPass=new WA(this.device,this.sceneTexture,this.cameraComponent),n=this.taaPass.historyTexture),n},t.setupComposePass=function(e){this.composePass=new GA(this.device),this.composePass.bloomTexture=(n=this.bloomPass)==null?void 0:n.bloomTexture,this.composePass.taaEnabled=e.taaEnabled,this.composePass.cocTexture=(r=this.dofPass)==null?void 0:r.cocTexture,this.composePass.blurTexture=(s=this.dofPass)==null?void 0:s.blurTexture,this.composePass.blurTextureUpscale=!((l=this.dofPass)!=null&&l.highQuality);var n,r,s,l,u=this.cameraComponent.renderTarget;this.composePass.init(u),this.composePass.ssaoTexture=e.ssaoType===kA?this.ssaoPass.ssaoTexture:null},t.setupAfterPass=function(e,n){var r=this.app,s=this.cameraComponent,l=r.scene,u=r.renderer,c=l.layers,h=s.renderTarget;this.afterPass=new Uo(this.device,c,l,u),this.afterPass.init(h),this.afterPass.addLayers(c,s,n.lastAddedIndex,n.clearRenderTarget)},t.frameUpdate=function(){this.layersDirty&&this.update(this.options),o.prototype.frameUpdate.call(this);var e,n,r,s=(r=(e=this.taaPass)==null?void 0:e.update())!=null?r:this.rt.colorBuffer;this.composePass.sceneTexture=s,(n=this.scenePassHalf)==null||n.setSourceTexture(s)},i=[{key:"renderTargetScale",get:function(){return this._renderTargetScale},set:function(e){this._renderTargetScale=e,this.scenePass&&(this.scenePass.scaleX=e,this.scenePass.scaleY=e)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(ct),a3=function(){function o(t,e){var n=this;this._enabled=!0,this.rendering={renderFormats:[18,12,14],stencil:!1,renderTargetScale:1,samples:1,sceneColorMap:!1,sceneDepthMap:!1,toneMapping:0,sharpness:0},this.ssao={type:ys,blurEnabled:!0,randomize:!1,intensity:.5,radius:30,samples:12,power:6,minAngle:10,scale:1},this.bloom={intensity:0,blurLevel:16},this.grading={enabled:!1,brightness:1,contrast:1,saturation:1,tint:new B(1,1,1,1)},this.colorLUT={texture:null,intensity:1},this.vignette={intensity:0,inner:.5,outer:1,curvature:.5},this.taa={enabled:!1,jitter:1},this.fringing={intensity:0},this.dof={enabled:!1,nearBlur:!1,focusDistance:100,focusRange:10,blurRadius:3,blurRings:4,blurRingPoints:5,highQuality:!0},this.debug=null,this.options=new gm,this.renderPassCamera=null,this.app=t,this.cameraComponent=e,this.updateOptions(),this.enable(),this.cameraLayersChanged=e.on("set:layers",function(){n.renderPassCamera&&(n.renderPassCamera.layersDirty=!0)})}var a,i=o.prototype;return i.destroy=function(){this.disable(),this.cameraLayersChanged.off()},i.enable=function(){this.renderPassCamera=this.createRenderPass(),this.cameraComponent.renderPasses=[this.renderPassCamera]},i.disable=function(){var t,e=this.cameraComponent;(t=e.renderPasses)==null||t.forEach(function(n){n.destroy()}),e.renderPasses=[],e.rendering=null,e.jitter=0,e.shaderParams.ssaoEnabled=!1,this.renderPassCamera=null},i.createRenderPass=function(){return new tC(this.app,this.cameraComponent,this.options)},i.updateOptions=function(){var t=this.options,e=this.rendering,n=this.bloom,r=this.taa,s=this.ssao;t.stencil=e.stencil,t.samples=e.samples,t.sceneColorMap=e.sceneColorMap,t.prepassEnabled=e.sceneDepthMap,t.bloomEnabled=n.intensity>0,t.taaEnabled=r.enabled,t.ssaoType=s.type,t.ssaoBlurEnabled=s.blurEnabled,t.formats=e.renderFormats.slice(),t.dofEnabled=this.dof.enabled,t.dofNearBlur=this.dof.nearBlur,t.dofHighQuality=this.dof.highQuality},i.update=function(){if(this._enabled){var t=this.cameraComponent,e=this.options,n=this.renderPassCamera,r=this.rendering,s=this.bloom,l=this.grading,u=this.vignette,c=this.fringing,h=this.taa,f=this.ssao;this.updateOptions(),n.update(e);var d=n.composePass,p=n.bloomPass,_=n.ssaoPass,g=n.dofPass;n.renderTargetScale=U.clamp(r.renderTargetScale,.1,1),d.toneMapping=r.toneMapping,d.sharpness=r.sharpness,e.bloomEnabled&&p&&(d.bloomIntensity=s.intensity,p.blurLevel=s.blurLevel),e.dofEnabled&&(g.focusDistance=this.dof.focusDistance,g.focusRange=this.dof.focusRange,g.blurRadius=this.dof.blurRadius,g.blurRings=this.dof.blurRings,g.blurRingPoints=this.dof.blurRingPoints),e.ssaoType!==ys&&(_.intensity=f.intensity,_.power=f.power,_.radius=f.radius,_.sampleCount=f.samples,_.minAngle=f.minAngle,_.scale=f.scale,_.randomize=f.randomize),d.gradingEnabled=l.enabled,l.enabled&&(d.gradingSaturation=l.saturation,d.gradingBrightness=l.brightness,d.gradingContrast=l.contrast,d.gradingTint=l.tint),d.colorLUT=this.colorLUT.texture,d.colorLUTIntensity=this.colorLUT.intensity,d.vignetteEnabled=u.intensity>0,d.vignetteEnabled&&(d.vignetteInner=u.inner,d.vignetteOuter=u.outer,d.vignetteCurvature=u.curvature,d.vignetteIntensity=u.intensity),d.fringingEnabled=c.intensity>0,d.fringingEnabled&&(d.fringingIntensity=c.intensity),t.jitter=h.enabled?h.jitter:0,d.debug=this.debug,d.debug==="ssao"&&e.ssaoType===ys&&(d.debug=null),d.debug!=="vignette"||d.vignetteEnabled||(d.debug=null)}},a=[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?this.enable():this.disable(),this._enabled=t)}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}(),za="local",ym="world",Rn="face";function nC(o,a){return(nC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ut=new E,iC=new E,o3=new X,l3=new X,rh=new Gn,St=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this)||this)._size=1,r._scale=1,r._coordSpace=ym,r.nodes=[],r.intersectShapes=[],r._camera=e,r._app=e.system.app,r._device=r._app.graphicsDevice,r._layer=n,e.layers=e.layers.concat(n.id),r.root=new ve("gizmo"),r._app.root.addChild(r.root),r.root.enabled=!1,r._updateScale(),r._onPointerDown=r._onPointerDown.bind(r),r._onPointerMove=r._onPointerMove.bind(r),r._onPointerUp=r._onPointerUp.bind(r),r._device.canvas.addEventListener("pointerdown",r._onPointerDown),r._device.canvas.addEventListener("pointermove",r._onPointerMove),r._device.canvas.addEventListener("pointerup",r._onPointerUp),r._app.on("update",function(){r._updatePosition(),r._updateRotation(),r._updateScale()}),r._app.on("destroy",function(){return r.destroy()}),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&nC(a,o);var i,t=a.prototype;return t._onPointerDown=function(e){if(this.root.enabled&&!document.pointerLockElement){var n=this._getSelection(e.offsetX,e.offsetY);n[0]&&(e.preventDefault(),e.stopPropagation()),this._device.canvas.setPointerCapture(e.pointerId),this.fire(a.EVENT_POINTERDOWN,e.offsetX,e.offsetY,n[0])}},t._onPointerMove=function(e){if(this.root.enabled&&!document.pointerLockElement){var n=this._getSelection(e.offsetX,e.offsetY);n[0]&&(e.preventDefault(),e.stopPropagation()),this.fire(a.EVENT_POINTERMOVE,e.offsetX,e.offsetY,n[0])}},t._onPointerUp=function(e){if(this.root.enabled&&!document.pointerLockElement){var n=this._getSelection(e.offsetX,e.offsetY);n[0]&&(e.preventDefault(),e.stopPropagation()),this._device.canvas.releasePointerCapture(e.pointerId),this.fire(a.EVENT_POINTERUP,e.offsetX,e.offsetY,n[0])}},t._updatePosition=function(){Ut.set(0,0,0);for(var e=0;e<this.nodes.length;e++){var n=this.nodes[e];Ut.add(n.getPosition())}Ut.mulScalar(1/(this.nodes.length||1)),1e-6>Ut.distance(this.root.getPosition())||(this.root.setPosition(Ut),this.fire(a.EVENT_POSITIONUPDATE,Ut))},t._updateRotation=function(){Ut.set(0,0,0),this._coordSpace===za&&this.nodes.length!==0&&Ut.copy(this.nodes[this.nodes.length-1].getEulerAngles()),1e-6>Ut.distance(this.root.getEulerAngles())||(this.root.setEulerAngles(Ut),this.fire(a.EVENT_ROTATIONUPDATE,Ut))},t._updateScale=function(){if(this._camera.projection===0){var e=this.root.getPosition(),n=this._camera.entity.getPosition(),r=e.distance(n);this._scale=Math.tan(.5*this._camera.fov*U.DEG_TO_RAD)*r*.3}else this._scale=.32*this._camera.orthoHeight;this._scale=Math.max(this._scale*this._size,1e-4),1e-6>Math.abs(this._scale-this.root.getLocalScale().x)||(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(a.EVENT_SCALEUPDATE,this._scale))},t._getSelection=function(e,n){for(var r=this._camera.screenToWorld(e,n,0),s=this._camera.screenToWorld(e,n,this._camera.farClip-this._camera.nearClip),l=Ut.copy(s).sub(r).normalize(),u=[],c=0;c<this.intersectShapes.length;c++){var h=this.intersectShapes[c];if(!h.disabled&&h.entity.enabled)for(var f=h.entity.getWorldTransform(),d=0;d<h.triData.length;d++){var p=h.triData[d],_=p.tris,g=p.transform,y=p.priority,v=o3.copy(f).mul(g),x=l3.copy(v).invert();x.transformPoint(r,rh.origin),x.transformVector(l,rh.direction),rh.direction.normalize();for(var S=0;S<_.length;S++)_[S].intersectsRay(rh,Ut)&&u.push({dist:v.transformPoint(Ut).sub(r).length(),meshInstances:h.meshInstances,priority:y})}}return u.length?(u.sort(function(T,b){return T.priority!==0&&b.priority!==0?b.priority-T.priority:T.dist-b.dist}),u[0].meshInstances):[]},t.attach=function(e){if(e===void 0&&(e=[]),Array.isArray(e)){if(e.length===0)return;this.nodes=e}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(a.EVENT_NODESATTACH),this.root.enabled=!0,this.fire(a.EVENT_RENDERUPDATE)},t.detach=function(){this.root.enabled=!1,this.fire(a.EVENT_RENDERUPDATE),this.fire(a.EVENT_NODESDETACH),this.nodes=[]},t.destroy=function(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this.root.destroy()},a.createLayer=function(e,n,r){n===void 0&&(n="Gizmo");var s=new Ye({name:n,clearDepthBuffer:!0,opaqueSortMode:0,transparentSortMode:0});return e.scene.layers.insert(s,r??e.scene.layers.layerList.length),s},i=[{key:"layer",get:function(){return this._layer}},{key:"coordSpace",get:function(){return this._coordSpace},set:function(e){this._coordSpace=e??ym,this._updateRotation()}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._updateScale()}},{key:"facing",get:function(){if(this._camera.projection===0){var e=this.root.getPosition(),n=this._camera.entity.getPosition();return iC.sub2(n,e).normalize()}return iC.copy(this._camera.entity.forward).mulScalar(-1)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);St.EVENT_POINTERDOWN="pointer:down",St.EVENT_POINTERMOVE="pointer:move",St.EVENT_POINTERUP="pointer:up",St.EVENT_POSITIONUPDATE="position:update",St.EVENT_ROTATIONUPDATE="rotation:update",St.EVENT_SCALEUPDATE="scale:update",St.EVENT_NODESATTACH="nodes:attach",St.EVENT_NODESDETACH="nodes:detach",St.EVENT_RENDERUPDATE="render:update";var sh=Object.freeze(new B(1,.3,.3)),ah=Object.freeze(new B(.3,1,.3)),oh=Object.freeze(new B(.3,.3,1)),rC=Object.freeze(new B(1,1,.5)),sC=Object.freeze(new B(.5,.5,.5,.5));function aC(o,a){return(aC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Bt=new E,Ga=new E,u3=new Z,Ss=new Gn,oC=new Yl,lC=Object.keys(Bt),ht=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._colorAlpha=.6,r._meshColors={axis:{x:r._colorSemi(sh),y:r._colorSemi(ah),z:r._colorSemi(oh),xyz:r._colorSemi(B.WHITE),f:r._colorSemi(B.WHITE)},hover:{x:sh.clone(),y:ah.clone(),z:oh.clone(),xyz:B.WHITE.clone(),f:rC.clone()},disabled:sC.clone()},r._guideColors={x:sh.clone(),y:ah.clone(),z:oh.clone(),f:rC.clone()},r._rootStartPos=new E,r._rootStartRot=new Z,r._shading=!1,r._shapes={},r._shapeMap=new Map,r._hoverShape=null,r._hoverAxis="",r._hoverIsPlane=!1,r._noSelection=!1,r._selectedAxis="",r._selectedIsPlane=!1,r._selectionStartPoint=new E,r._dragging=!1,r._snap=!1,r.snapIncrement=1,r._app.on("prerender",function(){r.root.enabled&&r._drawGuideLines()}),r.on(St.EVENT_POINTERDOWN,function(s,l,u){var c=r._shapeMap.get(u);if((c==null||!c.disabled)&&!r._dragging){if(!u){r._noSelection=!0;return}r._selectedAxis=r._getAxis(u),r._selectedIsPlane=r._getIsPlane(u),r._rootStartPos.copy(r.root.getPosition()),r._rootStartRot.copy(r.root.getRotation());var h=r._screenToPoint(s,l);r._selectionStartPoint.copy(h),r._dragging=!0,r.fire(a.EVENT_TRANSFORMSTART,h,s,l)}}),r.on(St.EVENT_POINTERMOVE,function(s,l,u){var c=r._shapeMap.get(u);if((c==null||!c.disabled)&&(r._noSelection||r._hover(u),r._dragging)){var h=r._screenToPoint(s,l);r.fire(a.EVENT_TRANSFORMMOVE,h,s,l),r._hoverAxis="",r._hoverIsPlane=!1}}),r.on(St.EVENT_POINTERUP,function(s,l,u){r._noSelection=!1,r._hover(u),r._dragging&&(r._dragging=!1,r.fire(a.EVENT_TRANSFORMEND),r._selectedAxis="",r._selectedIsPlane=!1)}),r.on(St.EVENT_NODESDETACH,function(){r.snap=!1,r._hoverAxis="",r._hoverIsPlane=!1,r._hover(),r.fire(St.EVENT_POINTERUP)}),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&aC(a,o);var i,t=a.prototype;return t._colorSemi=function(e){var n;return n=this._colorAlpha,new B(e.r,e.g,e.b,n)},t._updateAxisColor=function(e,n){var r=new B(n.r,n.g,n.b),s=this._colorSemi(n);for(var l in this._guideColors[e].copy(r),this._meshColors.axis[e].copy(s),this._meshColors.hover[e].copy(r),this._shapes)this._shapes[l].hover(!!this._hoverAxis)},t._getAxis=function(e){return e?e.node.name.split(":")[1]:""},t._getIsPlane=function(e){return!!e&&e.node.name.indexOf("plane")!==-1},t._hover=function(e){if(!this._dragging){this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e);var n,r=e&&(n=this._shapeMap.get(e))!=null?n:null;r!==this._hoverShape&&(this._hoverShape&&(this._hoverShape.hover(!1),this._hoverShape=null),r&&(r.hover(!0),this._hoverShape=r),this.fire(St.EVENT_RENDERUPDATE))}},t._createRay=function(e){if(this._camera.projection===0)return Ss.origin.copy(this._camera.entity.getPosition()),Ss.direction.sub2(e,Ss.origin).normalize(),Ss;var n=this._camera.farClip-this._camera.nearClip;return Ss.origin.sub2(e,Bt.copy(this._camera.entity.forward).mulScalar(n)),Ss.direction.copy(this._camera.entity.forward),Ss},t._createPlane=function(e,n,r){var s=Bt.copy(this.facing),l=oC.normal.set(0,0,0);return n?l.copy(s):(l[e]=1,this._rootStartRot.transformVector(l,l),r&&(Ga.cross(l,s).normalize(),l.cross(Ga,l).normalize())),oC.setFromPointNormal(this._rootStartPos,l)},t._dirFromAxis=function(e,n){return e===Rn?n.copy(this._camera.entity.forward).mulScalar(-1):(n.set(0,0,0),n[e]=1),n},t._projectToAxis=function(e,n){Bt.set(0,0,0),Bt[n]=1,e.copy(Bt.mulScalar(Bt.dot(e)));var r=e[n];e.set(0,0,0),e[n]=r},t._screenToPoint=function(e,n,r,s){r===void 0&&(r=!1),s===void 0&&(s=!1);var l=this._camera.screenToWorld(e,n,1),u=this._selectedAxis,c=this._createRay(l),h=this._createPlane(u,r,s),f=new E;return h.intersectsRay(c,f),f},t._drawGuideLines=function(){for(var e=this.root.getPosition(),n=u3.copy(this.root.getRotation()),r=this._hoverAxis||this._selectedAxis,s=this._hoverIsPlane||this._selectedIsPlane,l=0;l<lC.length;l++){var u=lC[l];if(r==="xyz"){this._drawSpanLine(e,n,u);continue}s?u!==r&&this._drawSpanLine(e,n,u):u===r&&this._drawSpanLine(e,n,u)}},t._drawSpanLine=function(e,n,r){Bt.set(0,0,0),Bt[r]=1,Bt.mulScalar(this._camera.farClip-this._camera.nearClip),Ga.copy(Bt).mulScalar(-1),n.transformVector(Bt,Bt),n.transformVector(Ga,Ga),this._app.drawLine(Bt.add(e),Ga.add(e),this._guideColors[r],!0)},t._createTransform=function(){for(var e in this._shapes){var n=this._shapes[e];this.root.addChild(n.entity),this.intersectShapes.push(n);for(var r=0;r<n.meshInstances.length;r++)this._shapeMap.set(n.meshInstances[r],n)}},t.enableShape=function(e,n){this._shapes.hasOwnProperty(e)&&(this._shapes[e].disabled=!n)},t.isShapeEnabled=function(e){return!!this._shapes.hasOwnProperty(e)&&!this._shapes[e].disabled},t.destroy=function(){for(var e in o.prototype.destroy.call(this),this._shapes)this._shapes[e].destroy()},i=[{key:"shading",get:function(){return this._shading},set:function(e){for(var n in this._shading=this.root.enabled&&e,this._shapes)this._shapes[n].shading=this._shading}},{key:"snap",get:function(){return this._snap},set:function(e){this._snap=this.root.enabled&&e}},{key:"xAxisColor",get:function(){return this._meshColors.axis.x},set:function(e){this._updateAxisColor("x",e)}},{key:"yAxisColor",get:function(){return this._meshColors.axis.y},set:function(e){this._updateAxisColor("y",e)}},{key:"zAxisColor",get:function(){return this._meshColors.axis.z},set:function(e){this._updateAxisColor("z",e)}},{key:"colorAlpha",get:function(){return this._colorAlpha},set:function(e){for(var n in this._colorAlpha=U.clamp(e,0,1),this._meshColors.axis.x.copy(this._colorSemi(this._meshColors.axis.x)),this._meshColors.axis.y.copy(this._colorSemi(this._meshColors.axis.y)),this._meshColors.axis.z.copy(this._colorSemi(this._meshColors.axis.z)),this._meshColors.axis.xyz.copy(this._colorSemi(this._meshColors.axis.xyz)),this._meshColors.axis.f.copy(this._colorSemi(this._meshColors.axis.f)),this._shapes)this._shapes[n].hover(!!this._hoverAxis)}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(St);ht.EVENT_TRANSFORMSTART="transform:start",ht.EVENT_TRANSFORMMOVE="transform:move",ht.EVENT_TRANSFORMEND="transform:end";var uC=new E,cC=new E,hC=new E,wr=function(){function o(t,e){e===void 0&&(e=0),this._priority=0,this._transform=new X,this.tris=[],this.fromGeometry(t),this._priority=e}var a,i=o.prototype;return i.setTransform=function(t,e,n){t===void 0&&(t=new E),e===void 0&&(e=new Z),n===void 0&&(n=new E),this.transform.setTRS(t,e,n)},i.fromGeometry=function(t){if(!t||(Ft!=null&&typeof Symbol<"u"&&Ft[Symbol.hasInstance]?!Ft[Symbol.hasInstance](t):!Q(t,Ft)))throw Error("No geometry provided.");var e,n,r=(e=t.positions)!=null?e:[],s=(n=t.indices)!=null?n:[];this.tris=[];for(var l=0;l<s.length;l+=3){var u=s[l],c=s[l+1],h=s[l+2];uC.set(r[3*u],r[3*u+1],r[3*u+2]),cC.set(r[3*c],r[3*c+1],r[3*c+2]),hC.set(r[3*h],r[3*h+1],r[3*h+2]);var f=new i_(uC,cC,hC);this.tris.push(f)}},a=[{key:"transform",get:function(){return this._transform}},{key:"priority",get:function(){return this._priority}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function Sm(o,a){return a!=null&&typeof Symbol<"u"&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](o):Q(o,a)}var c3=new E(1,2,3),h3={box:fr,cone:Xo,cylinder:pa,plane:Yo,sphere:oa,torus:ma},f3={uniqueName:"axis-shape",attributes:{vertex_position:oe,vertex_color:st},vertexGLSL:`
		attribute vec3 vertex_position;
		attribute vec4 vertex_color;
		varying vec4 vColor;
		uniform mat4 matrix_model;
		uniform mat4 matrix_viewProjection;
		void main(void) {
			gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);
			gl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));
			vColor = vertex_color;
		}
	`,fragmentGLSL:`
		#include "gammaPS"
		precision highp float;
		varying vec4 vColor;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(vColor)), vColor.w);
		}
	`},xm=new Map,fC=new E,d3=new E,p3=new X,Dl=new Ft;Dl.positions=[],Dl.normals=[];var dC=function(o,a,i){if(!o.normals||!o.positions)return[];i&&(t=p3.copy(i).invert().transformVector(fC.copy(c3),fC).normalize()),o.colors=[];for(var t,e=[],n=o.positions.length/3,r=0;r<n;r++){var s=1;if(t){var l=o.normals[3*r],u=o.normals[3*r+1],c=o.normals[3*r+2],h=d3.set(l,u,c);s=.25*t.dot(h)+.75}e.push(s),o.colors.push(s*a.r*255,s*a.g*255,s*a.b*255,255*a.a)}return e},bm=function(o,a){for(var i=xm.get(o),t=[],e=0;e<i.length;e++)t.push(i[e]*a.r*255,i[e]*a.g*255,i[e]*a.b*255,255*a.a);o.setColors32(t),o.update()},Ha=function(){function o(t,e){var n,r,s,l,u,c,h;this._layers=[],this._shading=!0,this._defaultColor=B.WHITE,this._hoverColor=B.BLACK,this._disabledColor=sC,this._cull=1,this.triData=[],this.meshInstances=[],this.device=t,this.axis=(n=e.axis)!=null?n:"x",this._position=(r=e.position)!=null?r:new E,this._rotation=(s=e.rotation)!=null?s:new E,this._scale=(l=e.scale)!=null?l:new E(1,1,1),this._disabled=(u=e.disabled)!=null&&u,this._layers=(c=e.layers)!=null?c:this._layers,this._shading=(h=e.shading)!=null?h:this._shading,Sm(e.defaultColor,B)&&(this._defaultColor=e.defaultColor),Sm(e.hoverColor,B)&&(this._hoverColor=e.hoverColor),Sm(e.disabledColor,B)&&(this._disabledColor=e.disabledColor)}var a,i=o.prototype;return i._createRoot=function(t){this.entity=new ve(t+":"+this.axis),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale)},i._createMesh=function(t,e){e===void 0&&(e=!0);var n=dC(t,this._disabled?this._disabledColor:this._defaultColor,e?this.entity.getWorldTransform():void 0),r=ye.fromGeometry(this.device,t);return xm.set(r,n),r},i._createRenderComponent=function(t,e){var n=new hr(f3);n.cull=this._cull,n.blendType=2,n.update();for(var r=[],s=0;s<e.length;s++){var l=new De(e[s],n);l.cull=!1,r.push(l),this.meshInstances.push(l)}t.addComponent("render",{meshInstances:r,layers:this._layers,castShadows:!1})},i._addRenderMesh=function(t,e,n){var r=h3[e];if(!r)throw Error("Invalid primitive type.");this._createRenderComponent(t,[this._createMesh(new r,n)])},i.hover=function(t){if(!this._disabled)for(var e=0;e<this.meshInstances.length;e++){var n=t?this._hoverColor:this._defaultColor;bm(this.meshInstances[e].mesh,n)}},i.destroy=function(){this.entity.destroy()},a=[{key:"disabled",get:function(){return this._disabled},set:function(t){for(var e=0;e<this.meshInstances.length;e++)bm(this.meshInstances[e].mesh,t?this._disabledColor:this._defaultColor);this._disabled=t!=null&&t}},{key:"shading",get:function(){return this._shading},set:function(t){this._shading=t==null||t;for(var e=this._disabled?this._disabledColor:this._defaultColor,n=0;n<this.meshInstances.length;n++){var r=this.meshInstances[n].mesh;r.getPositions(Dl.positions),r.getNormals(Dl.normals);var s=dC(Dl,e,this._shading?this.entity.getWorldTransform():void 0);xm.set(r,s),bm(r,e)}}}],function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(o.prototype,a),o}();function pC(o,a){return(pC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Wa=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return n===void 0&&(n={}),(r=o.call(this,e,n)||this)._cull=0,r._size=.2,r._gap=.1,r._flipped=new E,r.triData=[new wr(new Yo)],r._createPlane(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&pC(a,o);var i,t=a.prototype;return t._getPosition=function(){var e=this._size/2+this._gap,n=new E(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e);return n[this.axis]=0,n},t._createPlane=function(){this._createRoot("plane"),this._updateTransform(),this._addRenderMesh(this.entity,"plane",this._shading)},t._updateTransform=function(){this.entity.setLocalPosition(this._getPosition()),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size)},i=[{key:"size",get:function(){return this._size},set:function(e){this._size=e??1,this._updateTransform()}},{key:"gap",get:function(){return this._gap},set:function(e){this._gap=e??0,this._updateTransform()}},{key:"flipped",get:function(){return this._flipped},set:function(e){1e-6>this._flipped.distance(e)||(this._flipped.copy(e),this.entity.setLocalPosition(this._getPosition()))}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ha);function mC(o,a){return(mC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var xs=new E,lh=new E,uh=new Z,Tm=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return n===void 0&&(n={}),(r=o.call(this,e,n)||this)._gap=0,r._lineThickness=.02,r._lineLength=.5,r._arrowThickness=.12,r._arrowLength=.18,r._tolerance=.1,r._flipped=!1,r.triData=[new wr(new Xo),new wr(new pa,1)],r._createArrow(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&mC(a,o);var i,t=a.prototype;return t._createArrow=function(){this._createRoot("arrow"),this._head=new ve("head:"+this.axis),this.entity.addChild(this._head),this._updateHead(),this._addRenderMesh(this._head,"cone",this._shading),this._line=new ve("line:"+this.axis),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)},t._updateHead=function(){xs.set(0,this._gap+.5*this._arrowLength+this._lineLength,0),uh.set(0,0,0,1),lh.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform(xs,uh,lh),this._head.setLocalPosition(0,this._gap+.5*this._arrowLength+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness)},t._updateLine=function(){xs.set(0,this._gap+.5*this._lineLength,0),uh.set(0,0,0,1),lh.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(xs,uh,lh),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)},i=[{key:"gap",get:function(){return this._gap},set:function(e){this._gap=e??0,this._updateHead(),this._updateLine()}},{key:"lineThickness",get:function(){return this._lineThickness},set:function(e){this._lineThickness=e??1,this._updateHead(),this._updateLine()}},{key:"lineLength",get:function(){return this._lineLength},set:function(e){this._lineLength=e??1,this._updateHead(),this._updateLine()}},{key:"arrowThickness",get:function(){return this._arrowThickness},set:function(e){this._arrowThickness=e??1,this._updateHead()}},{key:"arrowLength",get:function(){return this._arrowLength},set:function(e){this._arrowLength=e??1,this._updateHead()}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._updateLine()}},{key:"flipped",get:function(){return this._flipped},set:function(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(E.ZERO)?xs.set(0,0,180*!!this._flipped):xs.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(xs))}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ha);function _C(o,a){return(_C=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var m3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return n===void 0&&(n={}),(r=o.call(this,e,n)||this)._size=.12,r._tolerance=.05,r.triData=[new wr(new oa,2)],r._createCenter(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&_C(a,o);var i,t=a.prototype;return t._createCenter=function(){this._createRoot("sphereCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"sphere",this._shading)},t._updateTransform=function(){this.entity.setLocalScale(this._size,this._size,this._size)},i=[{key:"size",get:function(){return this._size},set:function(e){this._size=e??1,this._updateTransform()}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._updateTransform()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ha);function vC(o,a){return(vC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ft=new E,On=new E,_3=new E,gC=new Z,v3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._shapes={face:new m3(r._device,{axis:Rn,layers:[r._layer.id],shading:r._shading,defaultColor:r._meshColors.axis.xyz,hoverColor:r._meshColors.hover.xyz}),yz:new Wa(r._device,{axis:"x",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,-90),defaultColor:r._meshColors.axis.x,hoverColor:r._meshColors.hover.x}),xz:new Wa(r._device,{axis:"y",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,0),defaultColor:r._meshColors.axis.y,hoverColor:r._meshColors.hover.y}),xy:new Wa(r._device,{axis:"z",layers:[r._layer.id],shading:r._shading,rotation:new E(90,0,0),defaultColor:r._meshColors.axis.z,hoverColor:r._meshColors.hover.z}),x:new Tm(r._device,{axis:"x",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,-90),defaultColor:r._meshColors.axis.x,hoverColor:r._meshColors.hover.x}),y:new Tm(r._device,{axis:"y",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,0),defaultColor:r._meshColors.axis.y,hoverColor:r._meshColors.hover.y}),z:new Tm(r._device,{axis:"z",layers:[r._layer.id],shading:r._shading,rotation:new E(90,0,0),defaultColor:r._meshColors.axis.z,hoverColor:r._meshColors.hover.z})},r._nodeLocalPositions=new Map,r._nodePositions=new Map,r.snapIncrement=1,r.flipShapes=!0,r._createTransform(),r.on(ht.EVENT_TRANSFORMSTART,function(){r._storeNodePositions()}),r.on(ht.EVENT_TRANSFORMMOVE,function(s){var l=_3.copy(s).sub(r._selectionStartPoint);r.snap&&(l.mulScalar(1/r.snapIncrement),l.round(),l.mulScalar(r.snapIncrement)),r._setNodePositions(l)}),r.on(ht.EVENT_NODESDETACH,function(){r._nodeLocalPositions.clear(),r._nodePositions.clear()}),r._app.on("prerender",function(){r._shapesLookAtCamera()}),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&vC(a,o);var i,t=a.prototype;return t._setArrowProp=function(e,n){this._shapes.x[e]=n,this._shapes.y[e]=n,this._shapes.z[e]=n},t._setPlaneProp=function(e,n){this._shapes.yz[e]=n,this._shapes.xz[e]=n,this._shapes.xy[e]=n},t._shapesLookAtCamera=function(){var e=this.facing,n=e.dot(this.root.right);this._shapes.x.entity.enabled=.98>Math.abs(n),this.flipShapes&&(this._shapes.x.flipped=n<0),n=e.dot(this.root.up),this._shapes.y.entity.enabled=.98>Math.abs(n),this.flipShapes&&(this._shapes.y.flipped=n<0),n=e.dot(this.root.forward),this._shapes.z.entity.enabled=.98>Math.abs(n),this.flipShapes&&(this._shapes.z.flipped=n>0),ft.cross(e,this.root.right),this._shapes.yz.entity.enabled=.98>ft.length(),this.flipShapes&&(this._shapes.yz.flipped=On.set(0,+(0>ft.dot(this.root.forward)),+(0>ft.dot(this.root.up)))),ft.cross(e,this.root.forward),this._shapes.xy.entity.enabled=.98>ft.length(),this.flipShapes&&(this._shapes.xy.flipped=On.set(+(0>ft.dot(this.root.up)),+(ft.dot(this.root.right)>0),0)),ft.cross(e,this.root.up),this._shapes.xz.entity.enabled=.98>ft.length(),this.flipShapes&&(this._shapes.xz.flipped=On.set(+(ft.dot(this.root.forward)>0),0,+(ft.dot(this.root.right)>0)))},t._storeNodePositions=function(){for(var e=0;e<this.nodes.length;e++){var n=this.nodes[e];this._nodeLocalPositions.set(n,n.getLocalPosition().clone()),this._nodePositions.set(n,n.getPosition().clone())}},t._setNodePositions=function(e){for(var n=0;n<this.nodes.length;n++){var r=this.nodes[n];if(this._coordSpace===za){var s,l=this._nodeLocalPositions.get(r);if(!l)continue;ft.copy(e),(s=r.parent)==null||s.getWorldTransform().getScale(On),On.x=1/On.x,On.y=1/On.y,On.z=1/On.z,gC.copy(r.getLocalRotation()).transformVector(ft,ft),ft.mul(On),r.setLocalPosition(ft.add(l))}else{var u=this._nodePositions.get(r);if(!u)continue;r.setPosition(ft.copy(e).add(u))}}this._updatePosition()},t._screenToPoint=function(e,n){var r=this._camera.screenToWorld(e,n,1),s=this._selectedAxis,l=this._selectedIsPlane,u=this._createRay(r),c=this._createPlane(s,s===Rn,!l),h=new E;return c.intersectsRay(u,h),gC.copy(this._rootStartRot).invert().transformVector(h,h),l||s===Rn||this._projectToAxis(h,s),h},i=[{key:"axisGap",get:function(){return this._shapes.x.gap},set:function(e){this._setArrowProp("gap",e)}},{key:"axisLineThickness",get:function(){return this._shapes.x.lineThickness},set:function(e){this._setArrowProp("lineThickness",e)}},{key:"axisLineLength",get:function(){return this._shapes.x.lineLength},set:function(e){this._setArrowProp("lineLength",e)}},{key:"axisLineTolerance",get:function(){return this._shapes.x.tolerance},set:function(e){this._setArrowProp("tolerance",e)}},{key:"axisArrowThickness",get:function(){return this._shapes.x.arrowThickness},set:function(e){this._setArrowProp("arrowThickness",e)}},{key:"axisArrowLength",get:function(){return this._shapes.x.arrowLength},set:function(e){this._setArrowProp("arrowLength",e)}},{key:"axisPlaneSize",get:function(){return this._shapes.yz.size},set:function(e){this._setPlaneProp("size",e)}},{key:"axisPlaneGap",get:function(){return this._shapes.yz.gap},set:function(e){this._setPlaneProp("gap",e)}},{key:"axisCenterSize",get:function(){return this._shapes.face.size},set:function(e){this._shapes.face.size=e}},{key:"axisCenterTolerance",get:function(){return this._shapes.face.tolerance},set:function(e){this._shapes.face.tolerance=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(ht);function yC(o,a){return(yC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var ch=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r,s,l,u;return n===void 0&&(n={}),(r=o.call(this,e,n)||this)._tubeRadius=.01,r._ringRadius=.5,r._tolerance=.05,r._tubeRadius=(s=n.tubeRadius)!=null?s:r._tubeRadius,r._ringRadius=(l=n.ringRadius)!=null?l:r._ringRadius,r._sectorAngle=(u=n.sectorAngle)!=null?u:r._sectorAngle,r.triData=[new wr(r._createTorusGeometry())],r._createDisk(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&yC(a,o);var i,t=a.prototype;return t._createTorusGeometry=function(){return new ma({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:this._sectorAngle,segments:20})},t._createTorusMesh=function(e){var n=new ma({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:80});return this._createMesh(n,this._shading)},t._createDisk=function(){this._createRoot("disk"),this._createRenderComponent(this.entity,[this._createTorusMesh(this._sectorAngle),this._createTorusMesh(360)]),this.drag(!1)},t._updateTransform=function(){this.triData[0].fromGeometry(this._createTorusGeometry()),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360)},t.drag=function(e){this.meshInstances[0].visible=!e,this.meshInstances[1].visible=e},t.hide=function(e){if(e){this.meshInstances[0].visible=!1,this.meshInstances[1].visible=!1;return}this.drag(!1)},i=[{key:"tubeRadius",get:function(){return this._tubeRadius},set:function(e){this._tubeRadius=e??.1,this._updateTransform()}},{key:"ringRadius",get:function(){return this._ringRadius},set:function(e){this._ringRadius=e??.1,this._updateTransform()}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._updateTransform()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ha);function SC(o,a){return(SC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ce=new E,bs=new E,xC=new E,bC=new E,TC=new X,kn=new Z,hh=new Z,g3=new B(0,0,0,.3),y3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._shapes={z:new ch(r._device,{axis:"z",layers:[r._layer.id],shading:r._shading,rotation:new E(90,0,90),defaultColor:r._meshColors.axis.z,hoverColor:r._meshColors.hover.z,sectorAngle:180}),x:new ch(r._device,{axis:"x",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,-90),defaultColor:r._meshColors.axis.x,hoverColor:r._meshColors.hover.x,sectorAngle:180}),y:new ch(r._device,{axis:"y",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,0),defaultColor:r._meshColors.axis.y,hoverColor:r._meshColors.hover.y,sectorAngle:180}),face:new ch(r._device,{axis:Rn,layers:[r._layer.id],shading:r._shading,rotation:r._getLookAtEulerAngles(r._camera.entity.getPosition()),defaultColor:r._meshColors.axis.f,hoverColor:r._meshColors.hover.f,ringRadius:.55})},r._selectionStartAngle=0,r._nodeLocalRotations=new Map,r._nodeRotations=new Map,r._nodeOffsets=new Map,r._guideAngleStartColor=g3.clone(),r._guideAngleStart=new E,r._guideAngleEnd=new E,r.snapIncrement=5,r.orbitRotation=!1,r._createTransform(),r.on(ht.EVENT_TRANSFORMSTART,function(s,l,u){r._selectionStartAngle=r._calculateAngle(s,l,u),r._storeNodeRotations(),r._storeGuidePoints(),r._drag(!0)}),r.on(ht.EVENT_TRANSFORMMOVE,function(s,l,u){var c=r._selectedAxis,h=r._calculateAngle(s,l,u)-r._selectionStartAngle;r.snap&&(h=Math.round(h/r.snapIncrement)*r.snapIncrement),r._setNodeRotations(c,h),r._updateGuidePoints(h)}),r.on(ht.EVENT_TRANSFORMEND,function(){r._drag(!1)}),r.on(ht.EVENT_NODESDETACH,function(){r._nodeLocalRotations.clear(),r._nodeRotations.clear(),r._nodeOffsets.clear()}),r._app.on("prerender",function(){if(r._shapesLookAtCamera(),r._dragging){var s=r.root.getPosition();r._drawGuideAngleLine(s,r._selectedAxis,r._guideAngleStart,r._guideAngleStartColor),r._drawGuideAngleLine(s,r._selectedAxis,r._guideAngleEnd)}}),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&SC(a,o);var i,t=a.prototype;return t._setDiskProp=function(e,n){this._shapes.x[e]=n,this._shapes.y[e]=n,this._shapes.z[e]=n},t._storeGuidePoints=function(){var e=this.root.getPosition(),n=this._selectedAxis===Rn?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(n),this._guideAngleEnd.copy(this._guideAngleStart)},t._updateGuidePoints=function(e){var n=this._selectedAxis;n===Rn?Ce.copy(this.facing):(Ce.set(0,0,0),Ce[n]=1,this._rootStartRot.transformVector(Ce,Ce)),kn.setFromAxisAngle(Ce,e),kn.transformVector(this._guideAngleStart,this._guideAngleEnd)},t._drawGuideAngleLine=function(e,n,r,s){s===void 0&&(s=this._guideColors[n]),Ce.set(0,0,0),bs.copy(r).mulScalar(this._scale),this._app.drawLine(Ce.add(e),bs.add(e),s,!1,this._layer)},t._getLookAtEulerAngles=function(e){return Ce.set(0,0,0),TC.setLookAt(Ce,e,E.UP),kn.setFromMat4(TC),kn.getEulerAngles(Ce),Ce.x+=90,Ce},t._shapesLookAtCamera=function(){this._camera.projection===0?(this._shapes.face.entity.lookAt(this._camera.entity.getPosition()),this._shapes.face.entity.rotateLocal(90,0,0)):(kn.copy(this._camera.entity.getRotation()).getEulerAngles(Ce),this._shapes.face.entity.setEulerAngles(Ce),this._shapes.face.entity.rotateLocal(-90,0,0));var e=Ce.copy(this.facing);kn.copy(this.root.getRotation()).invert().transformVector(e,e);var n=Math.atan2(e.z,e.y)*U.RAD_TO_DEG;this._shapes.x.entity.setLocalEulerAngles(0,n-90,-90),n=Math.atan2(e.x,e.z)*U.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,n,0),n=Math.atan2(e.y,e.x)*U.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,n+90)},t._drag=function(e){for(var n in this._shapes){var r=this._shapes[n];n===this._selectedAxis?r.drag(e):r.hide(e)}this.fire(ht.EVENT_RENDERUPDATE)},t._storeNodeRotations=function(){for(var e=this.root.getPosition(),n=0;n<this.nodes.length;n++){var r=this.nodes[n];this._nodeLocalRotations.set(r,r.getLocalRotation().clone()),this._nodeRotations.set(r,r.getRotation().clone()),this._nodeOffsets.set(r,r.getPosition().clone().sub(e))}},t._setNodeRotations=function(e,n){var r=this.root.getPosition(),s=e===Rn;kn.setFromAxisAngle(this._dirFromAxis(e,Ce),n);for(var l=0;l<this.nodes.length;l++){var u=this.nodes[l];if(s||this._coordSpace!==za){var c=this._nodeRotations.get(u);if(!c)continue;var h=this._nodeOffsets.get(u);if(!h)continue;Ce.copy(h),kn.transformVector(Ce,Ce),hh.copy(kn).mul(c),u.setEulerAngles(hh.getEulerAngles()),u.setPosition(Ce.add(r))}else{var f=this._nodeLocalRotations.get(u);if(!f)continue;hh.copy(f).mul(kn),u.setLocalRotation(hh)}}this._coordSpace===za&&this._updateRotation()},t._screenToPoint=function(e,n){var r=this._camera.screenToWorld(e,n,1),s=this._selectedAxis,l=this._createRay(r),u=this._createPlane(s,s===Rn,!1),c=new E;return u.intersectsRay(l,c),c},t._calculateAngle=function(e,n,r){var s=this.root.getPosition(),l=this._selectedAxis,u=this._createPlane(l,l===Rn,!1),c=0,h=bs.copy(this.facing),f=u.normal.dot(h);return this.orbitRotation||Math.abs(f)>.9?(Ce.sub2(e,s),kn.copy(this._camera.entity.getRotation()).invert().transformVector(Ce,Ce),c=Math.sign(f)*Math.atan2(Ce.y,Ce.x)*U.RAD_TO_DEG):(Ce.copy(s),bs.cross(u.normal,h).normalize().add(s),this._camera.worldToScreen(Ce,xC),this._camera.worldToScreen(bs,bC),Ce.sub2(bC,xC).normalize(),bs.set(n,r,0),c=Ce.dot(bs)),c},i=[{key:"xyzTubeRadius",get:function(){return this._shapes.x.tubeRadius},set:function(e){this._setDiskProp("tubeRadius",e)}},{key:"xyzRingRadius",get:function(){return this._shapes.x.ringRadius},set:function(e){this._setDiskProp("ringRadius",e)}},{key:"faceTubeRadius",get:function(){return this._shapes.face.tubeRadius},set:function(e){this._shapes.face.tubeRadius=e}},{key:"faceRingRadius",get:function(){return this._shapes.face.ringRadius},set:function(e){this._shapes.face.ringRadius=e}},{key:"ringTolerance",get:function(){return this._shapes.x.tolerance},set:function(e){this._setDiskProp("tolerance",e),this._shapes.face.tolerance=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(ht);function EC(o,a){return(EC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var S3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return n===void 0&&(n={}),(r=o.call(this,e,n)||this)._size=.12,r._tolerance=.05,r.triData=[new wr(new fr,2)],r._createCenter(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&EC(a,o);var i,t=a.prototype;return t._createCenter=function(){this._createRoot("boxCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"box",this._shading)},t._updateTransform=function(){this.entity.setLocalScale(this._size,this._size,this._size)},i=[{key:"size",get:function(){return this._size},set:function(e){this._size=e??1,this._updateTransform()}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._updateTransform()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ha);function wC(o,a){return(wC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Ts=new E,fh=new E,dh=new Z,Em=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return n===void 0&&(n={}),(r=o.call(this,e,n)||this)._gap=0,r._lineThickness=.02,r._lineLength=.5,r._boxSize=.12,r._tolerance=.1,r._flipped=!1,r.triData=[new wr(new fr),new wr(new pa,1)],r._createBoxLine(),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&wC(a,o);var i,t=a.prototype;return t._createBoxLine=function(){this._createRoot("boxLine"),this._box=new ve("box:"+this.axis),this.entity.addChild(this._box),this._updateBox(),this._addRenderMesh(this._box,"box",this._shading),this._line=new ve("line:"+this.axis),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)},t._updateBox=function(){Ts.set(0,this._gap+.5*this._boxSize+this._lineLength,0),dh.set(0,0,0,1),fh.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(Ts,dh,fh),this._box.setLocalPosition(0,this._gap+.5*this._boxSize+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize)},t._updateLine=function(){Ts.set(0,this._gap+.5*this._lineLength,0),dh.set(0,0,0,1),fh.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(Ts,dh,fh),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)},i=[{key:"gap",get:function(){return this._gap},set:function(e){this._gap=e??0,this._updateLine(),this._updateBox()}},{key:"lineThickness",get:function(){return this._lineThickness},set:function(e){this._lineThickness=e??1,this._updateLine(),this._updateBox()}},{key:"lineLength",get:function(){return this._lineLength},set:function(e){this._lineLength=e??1,this._updateLine(),this._updateBox()}},{key:"boxSize",get:function(){return this._boxSize},set:function(e){this._boxSize=e??1,this._updateBox()}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._updateLine()}},{key:"flipped",get:function(){return this._flipped},set:function(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(E.ZERO)?Ts.set(0,0,180*!!this._flipped):Ts.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(Ts))}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(Ha);function AC(o,a){return(AC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var et=new E,ji=new E,x3=new E,b3=new Z,T3=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e,n){var r;return(r=o.call(this,e,n)||this)._shapes={xyz:new S3(r._device,{axis:"xyz",layers:[r._layer.id],shading:r._shading,defaultColor:r._meshColors.axis.xyz,hoverColor:r._meshColors.hover.xyz}),yz:new Wa(r._device,{axis:"x",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,-90),defaultColor:r._meshColors.axis.x,hoverColor:r._meshColors.hover.x}),xz:new Wa(r._device,{axis:"y",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,0),defaultColor:r._meshColors.axis.y,hoverColor:r._meshColors.hover.y}),xy:new Wa(r._device,{axis:"z",layers:[r._layer.id],shading:r._shading,rotation:new E(90,0,0),defaultColor:r._meshColors.axis.z,hoverColor:r._meshColors.hover.z}),x:new Em(r._device,{axis:"x",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,-90),defaultColor:r._meshColors.axis.x,hoverColor:r._meshColors.hover.x}),y:new Em(r._device,{axis:"y",layers:[r._layer.id],shading:r._shading,rotation:new E(0,0,0),defaultColor:r._meshColors.axis.y,hoverColor:r._meshColors.hover.y}),z:new Em(r._device,{axis:"z",layers:[r._layer.id],shading:r._shading,rotation:new E(90,0,0),defaultColor:r._meshColors.axis.z,hoverColor:r._meshColors.hover.z})},r._coordSpace=za,r._nodeScales=new Map,r._useUniformScaling=!1,r.snapIncrement=1,r.flipShapes=!0,r.lowerBoundScale=new E(-1/0,-1/0,-1/0),r._createTransform(),r.on(ht.EVENT_TRANSFORMSTART,function(){r._storeNodeScales()}),r.on(ht.EVENT_TRANSFORMMOVE,function(s){var l=x3.copy(s).sub(r._selectionStartPoint);r.snap&&(l.mulScalar(1/r.snapIncrement),l.round(),l.mulScalar(r.snapIncrement)),l.mulScalar(1/r._scale),r._setNodeScales(l.add(E.ONE))}),r.on(ht.EVENT_NODESDETACH,function(){r._nodeScales.clear()}),r._app.on("prerender",function(){r._shapesLookAtCamera()}),r}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&AC(a,o);var i,t=a.prototype;return t._setArrowProp=function(e,n){this._shapes.x[e]=n,this._shapes.y[e]=n,this._shapes.z[e]=n},t._setPlaneProp=function(e,n){this._shapes.yz[e]=n,this._shapes.xz[e]=n,this._shapes.xy[e]=n},t._shapesLookAtCamera=function(){var e=this.facing,n=e.dot(this.root.right);this._shapes.x.entity.enabled=.98>Math.abs(n),this.flipShapes&&(this._shapes.x.flipped=n<0),n=e.dot(this.root.up),this._shapes.y.entity.enabled=.98>Math.abs(n),this.flipShapes&&(this._shapes.y.flipped=n<0),n=e.dot(this.root.forward),this._shapes.z.entity.enabled=.98>Math.abs(n),this.flipShapes&&(this._shapes.z.flipped=n>0),et.cross(e,this.root.right),this._shapes.yz.entity.enabled=.98>et.length(),this.flipShapes&&(this._shapes.yz.flipped=ji.set(0,+(0>et.dot(this.root.forward)),+(0>et.dot(this.root.up)))),et.cross(e,this.root.forward),this._shapes.xy.entity.enabled=.98>et.length(),this.flipShapes&&(this._shapes.xy.flipped=ji.set(+(0>et.dot(this.root.up)),+(et.dot(this.root.right)>0),0)),et.cross(e,this.root.up),this._shapes.xz.entity.enabled=.98>et.length(),this.flipShapes&&(this._shapes.xz.flipped=ji.set(+(et.dot(this.root.forward)>0),0,+(et.dot(this.root.right)>0)))},t._storeNodeScales=function(){for(var e=0;e<this.nodes.length;e++){var n=this.nodes[e];this._nodeScales.set(n,n.getLocalScale().clone())}},t._setNodeScales=function(e){for(var n=0;n<this.nodes.length;n++){var r=this.nodes[n],s=this._nodeScales.get(r);s&&r.setLocalScale(et.copy(s).mul(e).max(this.lowerBoundScale))}},t._screenToPoint=function(e,n){var r=this.root.getPosition(),s=this._camera.screenToWorld(e,n,1),l=this._selectedAxis,u=this._selectedIsPlane,c=this._useUniformScaling&&u||l==="xyz",h=this._createRay(s),f=this._createPlane(l,c,!u),d=new E;if(f.intersectsRay(h,d),c){switch(l){case"x":et.copy(this.root.up),ji.copy(this.root.forward).mulScalar(-1);break;case"y":et.copy(this.root.right),ji.copy(this.root.forward).mulScalar(-1);break;case"z":et.copy(this.root.up),ji.copy(this.root.right);break;default:et.copy(this._camera.entity.up),ji.copy(this._camera.entity.right)}ji.add(et).normalize(),et.sub2(d,r);var p=et.length()*et.normalize().dot(ji);return d.set(p,p,p),l!=="xyz"&&(d[l]=1),d}return b3.copy(this._rootStartRot).invert().transformVector(d,d),u||this._projectToAxis(d,l),d},i=[{key:"coordSpace",get:function(){return this._coordSpace},set:function(e){}},{key:"uniform",get:function(){return this._useUniformScaling},set:function(e){this._useUniformScaling=e==null||e}},{key:"axisGap",get:function(){return this._shapes.x.gap},set:function(e){this._setArrowProp("gap",e)}},{key:"axisLineThickness",get:function(){return this._shapes.x.lineThickness},set:function(e){this._setArrowProp("lineThickness",e)}},{key:"axisLineLength",get:function(){return this._shapes.x.lineLength},set:function(e){this._setArrowProp("lineLength",e)}},{key:"axisLineTolerance",get:function(){return this._shapes.x.tolerance},set:function(e){this._setArrowProp("tolerance",e)}},{key:"axisBoxSize",get:function(){return this._shapes.x.boxSize},set:function(e){this._setArrowProp("boxSize",e)}},{key:"axisPlaneSize",get:function(){return this._shapes.yz.size},set:function(e){this._setPlaneProp("size",e)}},{key:"axisPlaneGap",get:function(){return this._shapes.yz.gap},set:function(e){this._setPlaneProp("gap",e)}},{key:"axisCenterSize",get:function(){return this._shapes.xyz.size},set:function(e){this._shapes.xyz.size=e}},{key:"axisCenterTolerance",get:function(){return this._shapes.xyz.tolerance},set:function(e){this._shapes.xyz.tolerance=e}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(ht);function CC(o,a){return(CC=Object.setPrototypeOf||function(i,t){return i.__proto__=t,i})(o,a)}var Xi=new E,Yi=new E,qi=new E,ph=new X,PC=function(o){if(typeof o!="function"&&o!==null)throw TypeError("Super expression must either be null or a function");function a(e){(n=o.call(this)||this)._size=0,n._anchor=new q(1,1,1,1),n._colorX=sh.clone(),n._colorY=ah.clone(),n._colorZ=oh.clone(),n._colorNeg=new B(.3,.3,.3),n._radius=10,n._textSize=10,n._lineThickness=2,n._lineLength=40,n.dom=document.createElement("div"),n.dom.id="view-cube-container",n.dom.style.cssText="position: absolute;margin: auto;pointer-events: none",document.body.appendChild(n.dom),n.anchor=e??n._anchor,n._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),n._svg.id="view-cube-svg",n._group=document.createElementNS(n._svg.namespaceURI,"g"),n._svg.appendChild(n._group),n._resize();var n,r=n._colorX.toString(!1),s=n._colorY.toString(!1),l=n._colorZ.toString(!1);return n._shapes={nx:n._circle(r),ny:n._circle(s),nz:n._circle(l),px:n._circle(r,!0,"X"),py:n._circle(s,!0,"Y"),pz:n._circle(l,!0,"Z"),xaxis:n._line(r),yaxis:n._line(s),zaxis:n._line(l)},n._shapes.px.children[0].addEventListener("pointerdown",function(){n.fire(a.EVENT_CAMERAALIGN,E.RIGHT)}),n._shapes.py.children[0].addEventListener("pointerdown",function(){n.fire(a.EVENT_CAMERAALIGN,E.UP)}),n._shapes.pz.children[0].addEventListener("pointerdown",function(){n.fire(a.EVENT_CAMERAALIGN,E.BACK)}),n._shapes.nx.children[0].addEventListener("pointerdown",function(){n.fire(a.EVENT_CAMERAALIGN,E.LEFT)}),n._shapes.ny.children[0].addEventListener("pointerdown",function(){n.fire(a.EVENT_CAMERAALIGN,E.DOWN)}),n._shapes.nz.children[0].addEventListener("pointerdown",function(){n.fire(a.EVENT_CAMERAALIGN,E.FORWARD)}),n.dom.appendChild(n._svg),n}a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),o&&CC(a,o);var i,t=a.prototype;return t._resize=function(){this._size=2*(this.lineLength+this.radius+this.lineThickness),this.dom.style.width=""+this._size+"px",this.dom.style.height=""+this._size+"px",this._svg.setAttribute("width",""+this._size),this._svg.setAttribute("height",""+this._size),this._group.setAttribute("transform","translate("+.5*this._size+", "+.5*this._size+")")},t._transform=function(e,n,r){e.setAttribute("transform","translate("+n*this._lineLength+", "+r*this._lineLength+")")},t._x2y2=function(e,n,r){e.setAttribute("x2",""+n*this._lineLength),e.setAttribute("y2",""+r*this._lineLength)},t._line=function(e){var n=document.createElementNS(this._svg.namespaceURI,"line");return n.setAttribute("stroke",e),n.setAttribute("stroke-width",""+this._lineThickness),this._group.appendChild(n),n},t._circle=function(e,n,r){n===void 0&&(n=!1);var s=document.createElementNS(this._svg.namespaceURI,"g"),l=document.createElementNS(this._svg.namespaceURI,"circle");if(l.setAttribute("fill",n?e:this._colorNeg.toString(!1)),l.setAttribute("stroke",e),l.setAttribute("stroke-width",""+this._lineThickness),l.setAttribute("r",""+this._radius),l.setAttribute("cx","0"),l.setAttribute("cy","0"),l.setAttribute("pointer-events","all"),s.appendChild(l),r){var u=document.createElementNS(this._svg.namespaceURI,"text");u.setAttribute("font-size",""+this._textSize),u.setAttribute("font-family","Arial"),u.setAttribute("font-weight","bold"),u.setAttribute("text-anchor","middle"),u.setAttribute("alignment-baseline","central"),u.textContent=r,s.appendChild(u)}return s.setAttribute("cursor","pointer"),this._group.appendChild(s),s},t.update=function(e){var n=this;if(this._size){ph.invert(e),ph.getX(Xi),ph.getY(Yi),ph.getZ(qi),this._transform(this._shapes.px,Xi.x,-Xi.y),this._transform(this._shapes.nx,-Xi.x,Xi.y),this._transform(this._shapes.py,Yi.x,-Yi.y),this._transform(this._shapes.ny,-Yi.x,Yi.y),this._transform(this._shapes.pz,qi.x,-qi.y),this._transform(this._shapes.nz,-qi.x,qi.y),this._x2y2(this._shapes.xaxis,Xi.x,-Xi.y),this._x2y2(this._shapes.yaxis,Yi.x,-Yi.y),this._x2y2(this._shapes.zaxis,qi.x,-qi.y);var r=[{n:["xaxis","px"],value:Xi.z},{n:["yaxis","py"],value:Yi.z},{n:["zaxis","pz"],value:qi.z},{n:["nx"],value:-Xi.z},{n:["ny"],value:-Yi.z},{n:["nz"],value:-qi.z}].sort(function(l,u){return l.value-u.value}),s=document.createDocumentFragment();r.forEach(function(l){l.n.forEach(function(u){s.appendChild(n._shapes[u])})}),this._group.appendChild(s)}},t.destroy=function(){this.dom.remove(),this.off()},i=[{key:"anchor",get:function(){return this._anchor},set:function(e){this._anchor.copy(e),this.dom.style.top=this._anchor.x?"0px":"auto",this.dom.style.right=this._anchor.y?"0px":"auto",this.dom.style.bottom=this._anchor.z?"0px":"auto",this.dom.style.left=this._anchor.w?"0px":"auto"}},{key:"colorX",get:function(){return this._colorX},set:function(e){this._colorX.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorX.toString(!1)),this._shapes.px.children[0].setAttribute("stroke",this._colorX.toString(!1)),this._shapes.nx.children[0].setAttribute("stroke",this._colorX.toString(!1)),this._shapes.xaxis.setAttribute("stroke",this._colorX.toString(!1))}},{key:"colorY",get:function(){return this._colorY},set:function(e){this._colorY.copy(e),this._shapes.py.children[0].setAttribute("fill",this._colorY.toString(!1)),this._shapes.py.children[0].setAttribute("stroke",this._colorY.toString(!1)),this._shapes.ny.children[0].setAttribute("stroke",this._colorY.toString(!1)),this._shapes.yaxis.setAttribute("stroke",this._colorY.toString(!1))}},{key:"colorZ",get:function(){return this._colorZ},set:function(e){this._colorZ.copy(e),this._shapes.pz.children[0].setAttribute("fill",this._colorZ.toString(!1)),this._shapes.pz.children[0].setAttribute("stroke",this._colorZ.toString(!1)),this._shapes.nz.children[0].setAttribute("stroke",this._colorZ.toString(!1)),this._shapes.zaxis.setAttribute("stroke",this._colorZ.toString(!1))}},{key:"colorNeg",get:function(){return this._colorNeg},set:function(e){this._colorNeg.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorNeg.toString(!1)),this._shapes.py.children[0].setAttribute("fill",this._colorNeg.toString(!1)),this._shapes.pz.children[0].setAttribute("fill",this._colorNeg.toString(!1))}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shapes.px.children[0].setAttribute("r",""+e),this._shapes.py.children[0].setAttribute("r",""+e),this._shapes.pz.children[0].setAttribute("r",""+e),this._shapes.nx.children[0].setAttribute("r",""+e),this._shapes.ny.children[0].setAttribute("r",""+e),this._shapes.nz.children[0].setAttribute("r",""+e),this._resize()}},{key:"textSize",get:function(){return this._textSize},set:function(e){this._textSize=e,this._shapes.px.children[1].setAttribute("font-size",""+e),this._shapes.py.children[1].setAttribute("font-size",""+e),this._shapes.pz.children[1].setAttribute("font-size",""+e)}},{key:"lineThickness",get:function(){return this._lineThickness},set:function(e){this._lineThickness=e,this._shapes.xaxis.setAttribute("stroke-width",""+e),this._shapes.yaxis.setAttribute("stroke-width",""+e),this._shapes.zaxis.setAttribute("stroke-width",""+e),this._shapes.px.children[0].setAttribute("stroke-width",""+e),this._shapes.py.children[0].setAttribute("stroke-width",""+e),this._shapes.pz.children[0].setAttribute("stroke-width",""+e),this._shapes.nx.children[0].setAttribute("stroke-width",""+e),this._shapes.ny.children[0].setAttribute("stroke-width",""+e),this._shapes.nz.children[0].setAttribute("stroke-width",""+e),this._resize()}},{key:"lineLength",get:function(){return this._lineLength},set:function(e){this._lineLength=e,this._resize()}}],function(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(a.prototype,i),a}(se);PC.EVENT_CAMERAALIGN="camera:align",m.ABSOLUTE_URL=Qr,m.ACTION_GAMEPAD=hu,m.ACTION_KEYBOARD=cu,m.ACTION_MOUSE=uu,m.ADDRESS_CLAMP_TO_EDGE=1,m.ADDRESS_MIRRORED_REPEAT=2,m.ADDRESS_REPEAT=0,m.AMBIENTSRC_AMBIENTSH=yu,m.AMBIENTSRC_CONSTANT=xu,m.AMBIENTSRC_ENVALATLAS=Su,m.ANIM_BLEND_1D="1D",m.ANIM_BLEND_2D_CARTESIAN=P0,m.ANIM_BLEND_2D_DIRECTIONAL=C0,m.ANIM_BLEND_DIRECT=I0,m.ANIM_CONTROL_STATES=nl,m.ANIM_EQUAL_TO=w0,m.ANIM_GREATER_THAN=x0,m.ANIM_GREATER_THAN_EQUAL_TO=T0,m.ANIM_INTERRUPTION_NEXT=g0,m.ANIM_INTERRUPTION_NEXT_PREV=S0,m.ANIM_INTERRUPTION_NONE=kd,m.ANIM_INTERRUPTION_PREV=v0,m.ANIM_INTERRUPTION_PREV_NEXT=y0,m.ANIM_LAYER_ADDITIVE=L0,m.ANIM_LAYER_OVERWRITE=Bd,m.ANIM_LESS_THAN=b0,m.ANIM_LESS_THAN_EQUAL_TO=E0,m.ANIM_NOT_EQUAL_TO=A0,m.ANIM_PARAMETER_BOOLEAN=Ud,m.ANIM_PARAMETER_FLOAT=Fd,m.ANIM_PARAMETER_INTEGER=Nd,m.ANIM_PARAMETER_TRIGGER=tl,m.ANIM_STATE_ANY="ANY",m.ANIM_STATE_END="END",m.ANIM_STATE_START=ya,m.ASPECT_AUTO=0,m.ASPECT_MANUAL=1,m.ASSET_ANIMATION="animation",m.ASSET_AUDIO="audio",m.ASSET_CONTAINER="container",m.ASSET_CSS="css",m.ASSET_CUBEMAP="cubemap",m.ASSET_HTML="html",m.ASSET_IMAGE="image",m.ASSET_JSON="json",m.ASSET_MATERIAL="material",m.ASSET_MODEL="model",m.ASSET_SCRIPT="script",m.ASSET_SHADER="shader",m.ASSET_TEXT="text",m.ASSET_TEXTURE="texture",m.ASSET_TEXTUREATLAS="textureatlas",m.AXIS_KEY="key",m.AXIS_MOUSE_X="mousex",m.AXIS_MOUSE_Y="mousey",m.AXIS_PAD_L_X="padlx",m.AXIS_PAD_L_Y="padly",m.AXIS_PAD_R_X="padrx",m.AXIS_PAD_R_Y="padry",m.AnimBinder=es,m.AnimClip=ac,m.AnimClipHandler=zT,m.AnimComponent=qd,m.AnimComponentLayer=X0,m.AnimComponentSystem=Q0,m.AnimController=H0,m.AnimCurve=yp,m.AnimData=xl,m.AnimEvaluator=Vd,m.AnimEvents=zd,m.AnimSnapshot=Od,m.AnimStateGraph=ol,m.AnimStateGraphHandler=HT,m.AnimTarget=oc,m.AnimTrack=Qt,m.Animation=gd,m.AnimationComponent=Hd,m.AnimationComponentSystem=k0,m.AnimationHandler=BT,m.AnimationKey=Gu,m.AnimationNode=Hu,m.AppBase=Pn,m.AppOptions=a0,m.Application=gR,m.Asset=$,m.AssetListLoader=yR,m.AssetReference=Ta,m.AssetRegistry=Jr,m.AudioHandler=jT,m.AudioListenerComponent=Zd,m.AudioListenerComponentSystem=tx,m.BAKE_COLOR=0,m.BAKE_COLORDIR=1,m.BINDGROUP_MESH=1,m.BINDGROUP_MESH_UB=2,m.BINDGROUP_VIEW=0,m.BLENDEQUATION_ADD=0,m.BLENDEQUATION_MAX=4,m.BLENDEQUATION_MIN=3,m.BLENDEQUATION_REVERSE_SUBTRACT=2,m.BLENDEQUATION_SUBTRACT=1,m.BLENDMODE_CONSTANT=11,m.BLENDMODE_CONSTANT_ALPHA=11,m.BLENDMODE_CONSTANT_COLOR=11,m.BLENDMODE_DST_ALPHA=9,m.BLENDMODE_DST_COLOR=4,m.BLENDMODE_ONE=1,m.BLENDMODE_ONE_MINUS_CONSTANT=12,m.BLENDMODE_ONE_MINUS_CONSTANT_ALPHA=12,m.BLENDMODE_ONE_MINUS_CONSTANT_COLOR=12,m.BLENDMODE_ONE_MINUS_DST_ALPHA=10,m.BLENDMODE_ONE_MINUS_DST_COLOR=5,m.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,m.BLENDMODE_ONE_MINUS_SRC_COLOR=3,m.BLENDMODE_SRC_ALPHA=6,m.BLENDMODE_SRC_ALPHA_SATURATE=7,m.BLENDMODE_SRC_COLOR=2,m.BLENDMODE_ZERO=0,m.BLEND_ADDITIVE=1,m.BLEND_ADDITIVEALPHA=6,m.BLEND_MAX=10,m.BLEND_MIN=9,m.BLEND_MULTIPLICATIVE=5,m.BLEND_MULTIPLICATIVE2X=7,m.BLEND_NONE=3,m.BLEND_NORMAL=2,m.BLEND_PREMULTIPLIED=4,m.BLEND_SCREEN=8,m.BLEND_SUBTRACTIVE=0,m.BLUR_BOX=0,m.BLUR_GAUSSIAN=1,m.BODYFLAG_KINEMATIC_OBJECT=2,m.BODYFLAG_NORESPONSE_OBJECT=4,m.BODYFLAG_STATIC_OBJECT=1,m.BODYGROUP_DEFAULT=1,m.BODYGROUP_DYNAMIC=1,m.BODYGROUP_ENGINE_1=8,m.BODYGROUP_ENGINE_2=32,m.BODYGROUP_ENGINE_3=64,m.BODYGROUP_KINEMATIC=4,m.BODYGROUP_NONE=0,m.BODYGROUP_STATIC=2,m.BODYGROUP_TRIGGER=16,m.BODYGROUP_USER_1=128,m.BODYGROUP_USER_2=256,m.BODYGROUP_USER_3=512,m.BODYGROUP_USER_4=1024,m.BODYGROUP_USER_5=2048,m.BODYGROUP_USER_6=4096,m.BODYGROUP_USER_7=8192,m.BODYGROUP_USER_8=16384,m.BODYMASK_ALL=65535,m.BODYMASK_NONE=0,m.BODYMASK_NOT_STATIC=65533,m.BODYMASK_NOT_STATIC_KINEMATIC=65529,m.BODYMASK_STATIC=2,m.BODYSTATE_ACTIVE_TAG=1,m.BODYSTATE_DISABLE_DEACTIVATION=4,m.BODYSTATE_DISABLE_SIMULATION=5,m.BODYSTATE_ISLAND_SLEEPING=2,m.BODYSTATE_WANTS_DEACTIVATION=3,m.BODYTYPE_DYNAMIC=Jt,m.BODYTYPE_KINEMATIC=pr,m.BODYTYPE_STATIC=Sa,m.BUFFERUSAGE_COPY_DST=8,m.BUFFERUSAGE_COPY_SRC=4,m.BUFFERUSAGE_INDEX=16,m.BUFFERUSAGE_INDIRECT=256,m.BUFFERUSAGE_READ=1,m.BUFFERUSAGE_STORAGE=128,m.BUFFERUSAGE_UNIFORM=64,m.BUFFERUSAGE_VERTEX=32,m.BUFFERUSAGE_WRITE=2,m.BUFFER_DYNAMIC=1,m.BUFFER_GPUDYNAMIC=3,m.BUFFER_STATIC=0,m.BUFFER_STREAM=2,m.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,m.BUTTON_TRANSITION_MODE_TINT=0,m.Batch=Of,m.BatchGroup=qe,m.BatchManager=Ag,m.BinaryHandler=YT,m.BindGroupFormat=Br,m.BindStorageBufferFormat=ef,m.BindStorageTextureFormat=__,m.BindTextureFormat=_o,m.BindUniformBufferFormat=mo,m.BlendState=ge,m.BoundingBox=Se,m.BoundingSphere=to,m.BoxGeometry=fr,m.Bundle=nc,m.BundleHandler=ZS,m.BundleRegistry=WS,m.ButtonComponent=at,m.ButtonComponentSystem=lx,m.CHUNKAPI_1_51="1.51",m.CHUNKAPI_1_55="1.55",m.CHUNKAPI_1_56="1.56",m.CHUNKAPI_1_57="1.57",m.CHUNKAPI_1_58="1.58",m.CHUNKAPI_1_60="1.60",m.CHUNKAPI_1_62="1.62",m.CHUNKAPI_1_65="1.65",m.CHUNKAPI_1_70="1.70",m.CHUNKAPI_2_1="2.1",m.CHUNKAPI_2_3="2.3",m.CHUNKAPI_2_5="2.5",m.CHUNKAPI_2_6="2.6",m.CHUNKAPI_2_7="2.7",m.CHUNKAPI_2_8="2.8",m.CLEARFLAG_COLOR=1,m.CLEARFLAG_DEPTH=2,m.CLEARFLAG_STENCIL=4,m.CUBEFACE_NEGX=1,m.CUBEFACE_NEGY=3,m.CUBEFACE_NEGZ=5,m.CUBEFACE_POSX=0,m.CUBEFACE_POSY=2,m.CUBEFACE_POSZ=4,m.CUBEPROJ_BOX=1,m.CUBEPROJ_NONE=0,m.CULLFACE_BACK=1,m.CULLFACE_FRONT=2,m.CULLFACE_FRONTANDBACK=3,m.CULLFACE_NONE=0,m.CURVE_LINEAR=0,m.CURVE_SMOOTHSTEP=1,m.CURVE_SPLINE=4,m.CURVE_STEP=5,m.Camera=Eu,m.CameraComponent=Vi,m.CameraComponentSystem=iT,m.CameraFrame=a3,m.CameraFrameOptions=gm,m.CanvasFont=xR,m.CapsuleGeometry=wd,m.ChunkUtils=Mi,m.CollisionComponent=ts,m.CollisionComponentSystem=_x,m.Color=B,m.Component=de,m.ComponentSystem=We,m.ComponentSystemRegistry=XS,m.Compute=L1,m.ConeGeometry=Xo,m.ContactPoint=cb,m.ContactResult=hb,m.ContainerHandler=QT,m.ContainerResource=DM,m.Controller=Q1,m.CssHandler=$T,m.CubemapHandler=tE,m.Curve=cn,m.CurveSet=tr,m.CylinderGeometry=pa,m.DETAILMODE_ADD="add",m.DETAILMODE_MAX="max",m.DETAILMODE_MIN="min",m.DETAILMODE_MUL="mul",m.DETAILMODE_OVERLAY="overlay",m.DETAILMODE_SCREEN="screen",m.DEVICETYPE_NULL=uo,m.DEVICETYPE_WEBGL2=lo,m.DEVICETYPE_WEBGPU=Jh,m.DISPLAYFORMAT_HDR="hdr",m.DISPLAYFORMAT_LDR="ldr",m.DISPLAYFORMAT_LDR_SRGB=co,m.DISTANCE_EXPONENTIAL=Gh,m.DISTANCE_INVERSE=Kl,m.DISTANCE_LINEAR=no,m.DITHER_BAYER8=Jv,m.DITHER_BLUENOISE=$v,m.DITHER_IGNNOISE=eg,m.DITHER_NONE=Kn,m.DefaultAnimBinder=Gd,m.DepthState=Xe,m.DomeGeometry=zy,m.ELEMENTTYPE_GROUP=ll,m.ELEMENTTYPE_IMAGE=hc,m.ELEMENTTYPE_TEXT=Qd,m.EMITTERSHAPE_BOX=0,m.EMITTERSHAPE_SPHERE=1,m.EVENT_GAMEPADCONNECTED="gamepadconnected",m.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected",m.EVENT_KEYDOWN="keydown",m.EVENT_KEYUP="keyup",m.EVENT_MOUSEDOWN="mousedown",m.EVENT_MOUSEMOVE="mousemove",m.EVENT_MOUSEUP="mouseup",m.EVENT_MOUSEWHEEL="mousewheel",m.EVENT_POSTCULL=og,m.EVENT_POSTRENDER=ig,m.EVENT_POSTRENDER_LAYER=sg,m.EVENT_PRECULL=ag,m.EVENT_PRERENDER=ng,m.EVENT_PRERENDER_LAYER=rg,m.EVENT_SELECT="select",m.EVENT_SELECTEND="selectend",m.EVENT_SELECTSTART="selectstart",m.EVENT_TOUCHCANCEL="touchcancel",m.EVENT_TOUCHEND="touchend",m.EVENT_TOUCHMOVE="touchmove",m.EVENT_TOUCHSTART="touchstart",m.ElementComponent=_t,m.ElementComponentSystem=Lx,m.ElementDragHelper=Ea,m.ElementInput=rA,m.ElementInputEvent=Jc,m.ElementMouseEvent=Ua,m.ElementSelectEvent=Gi,m.ElementTouchEvent=Ba,m.Entity=ve,m.EnvLighting=_d,m.EventHandle=jm,m.EventHandler=se,m.FILLMODE_FILL_WINDOW=DS,m.FILLMODE_KEEP_ASPECT=Cd,m.FILLMODE_NONE="NONE",m.FILTER_LINEAR=1,m.FILTER_LINEAR_MIPMAP_LINEAR=5,m.FILTER_LINEAR_MIPMAP_NEAREST=4,m.FILTER_NEAREST=0,m.FILTER_NEAREST_MIPMAP_LINEAR=3,m.FILTER_NEAREST_MIPMAP_NEAREST=2,m.FITMODE_CONTAIN=nx,m.FITMODE_COVER=ix,m.FITMODE_STRETCH=ul,m.FITTING_BOTH=3,m.FITTING_NONE=0,m.FITTING_SHRINK=2,m.FITTING_STRETCH=1,m.FOG_EXP="exp",m.FOG_EXP2="exp2",m.FOG_LINEAR=Gv,m.FOG_NONE=Gr,m.FONT_BITMAP=xx,m.FONT_MSDF=pc,m.FRESNEL_NONE=0,m.FRESNEL_SCHLICK=2,m.FUNC_ALWAYS=7,m.FUNC_EQUAL=2,m.FUNC_GREATER=4,m.FUNC_GREATEREQUAL=6,m.FUNC_LESS=1,m.FUNC_LESSEQUAL=3,m.FUNC_NEVER=0,m.FUNC_NOTEQUAL=5,m.FloatPacking=pi,m.FogParams=jy,m.FolderHandler=iE,m.Font=Ep,m.FontHandler=sE,m.ForwardRenderer=id,m.Frustum=t_,m.GAMMA_NONE=0,m.GAMMA_SRGB=1,m.GIZMOAXIS_FACE=Rn,m.GIZMOAXIS_X="x",m.GIZMOAXIS_XY="xy",m.GIZMOAXIS_XYZ="xyz",m.GIZMOAXIS_XZ="xz",m.GIZMOAXIS_Y="y",m.GIZMOAXIS_YZ="yz",m.GIZMOAXIS_Z="z",m.GIZMOSPACE_LOCAL=za,m.GIZMOSPACE_WORLD=ym,m.GSplatComponent=_p,m.GSplatComponentSystem=ET,m.GSplatData=qo,m.GSplatHandler=fE,m.GSplatInstance=ES,m.GSplatResource=Ju,m.GSplatResourceBase=Qu,m.GSplatSogsData=PS,m.GSplatSogsResource=LS,m.GamePads=Ef,m.Geometry=Ft,m.Gizmo=St,m.GltfExporter=e3,m.GraphNode=pe,m.GraphicsDevice=Ie,m.HierarchyHandler=pE,m.HtmlHandler=_E,m.Http=Tt,m.I18n=$r,m.INDEXFORMAT_UINT16=1,m.INDEXFORMAT_UINT32=2,m.INDEXFORMAT_UINT8=0,m.INTERPOLATION_CUBIC=2,m.INTERPOLATION_LINEAR=1,m.INTERPOLATION_STEP=0,m.ImageElement=vx,m.IndexBuffer=Yn,m.IndexedList=qm,m.JointComponent=gc,m.JointComponentSystem=Ox,m.JsonHandler=gE,m.JsonStandardMaterialParser=yE,m.KEY_0=48,m.KEY_1=49,m.KEY_2=50,m.KEY_3=51,m.KEY_4=52,m.KEY_5=53,m.KEY_6=54,m.KEY_7=55,m.KEY_8=56,m.KEY_9=57,m.KEY_A=65,m.KEY_ADD=107,m.KEY_ALT=18,m.KEY_B=66,m.KEY_BACKSPACE=8,m.KEY_BACK_SLASH=220,m.KEY_C=67,m.KEY_CAPS_LOCK=20,m.KEY_CLOSE_BRACKET=221,m.KEY_COMMA=188,m.KEY_CONTEXT_MENU=93,m.KEY_CONTROL=17,m.KEY_D=68,m.KEY_DECIMAL=110,m.KEY_DELETE=46,m.KEY_DIVIDE=111,m.KEY_DOWN=40,m.KEY_E=69,m.KEY_END=35,m.KEY_ENTER=13,m.KEY_EQUAL=61,m.KEY_ESCAPE=27,m.KEY_F=70,m.KEY_F1=112,m.KEY_F10=121,m.KEY_F11=122,m.KEY_F12=123,m.KEY_F2=113,m.KEY_F3=114,m.KEY_F4=115,m.KEY_F5=116,m.KEY_F6=117,m.KEY_F7=118,m.KEY_F8=119,m.KEY_F9=120,m.KEY_G=71,m.KEY_H=72,m.KEY_HOME=36,m.KEY_I=73,m.KEY_INSERT=45,m.KEY_J=74,m.KEY_K=75,m.KEY_L=76,m.KEY_LEFT=37,m.KEY_M=77,m.KEY_META=224,m.KEY_MULTIPLY=106,m.KEY_N=78,m.KEY_NUMPAD_0=96,m.KEY_NUMPAD_1=97,m.KEY_NUMPAD_2=98,m.KEY_NUMPAD_3=99,m.KEY_NUMPAD_4=100,m.KEY_NUMPAD_5=101,m.KEY_NUMPAD_6=102,m.KEY_NUMPAD_7=103,m.KEY_NUMPAD_8=104,m.KEY_NUMPAD_9=105,m.KEY_O=79,m.KEY_OPEN_BRACKET=219,m.KEY_P=80,m.KEY_PAGE_DOWN=34,m.KEY_PAGE_UP=33,m.KEY_PAUSE=19,m.KEY_PERIOD=190,m.KEY_PRINT_SCREEN=44,m.KEY_Q=81,m.KEY_R=82,m.KEY_RETURN=13,m.KEY_RIGHT=39,m.KEY_S=83,m.KEY_SEMICOLON=59,m.KEY_SEPARATOR=108,m.KEY_SHIFT=16,m.KEY_SLASH=191,m.KEY_SPACE=32,m.KEY_SUBTRACT=109,m.KEY_T=84,m.KEY_TAB=9,m.KEY_U=85,m.KEY_UP=38,m.KEY_V=86,m.KEY_W=87,m.KEY_WINDOWS=91,m.KEY_X=88,m.KEY_Y=89,m.KEY_Z=90,m.Kernel=e_,m.Key=Gu,m.Keyboard=pu,m.KeyboardEvent=yv,m.LAYERID_DEPTH=1,m.LAYERID_IMMEDIATE=3,m.LAYERID_SKYBOX=2,m.LAYERID_UI=4,m.LAYERID_WORLD=0,m.LAYER_GIZMO=1,m.LAYER_HUD=0,m.LAYER_WORLD=15,m.LIGHTFALLOFF_INVERSESQUARED=1,m.LIGHTFALLOFF_LINEAR=0,m.LIGHTSHAPE_DISK=2,m.LIGHTSHAPE_PUNCTUAL=0,m.LIGHTSHAPE_RECT=1,m.LIGHTSHAPE_SPHERE=3,m.LIGHTTYPE_COUNT=3,m.LIGHTTYPE_DIRECTIONAL=0,m.LIGHTTYPE_OMNI=1,m.LIGHTTYPE_POINT=1,m.LIGHTTYPE_SPOT=2,m.LIGHT_COLOR_DIVIDER=100,m.Layer=Ye,m.LayerComposition=Ru,m.LayoutCalculator=Vx,m.LayoutChildComponent=ep,m.LayoutChildComponentSystem=Ux,m.LayoutGroupComponent=ip,m.LayoutGroupComponentSystem=jx,m.Light=od,m.LightComponent=oT,m.LightComponentSystem=hT,m.LightingParams=ld,m.Lightmapper=f0,m.LitMaterial=NI,m.LitOptions=Wo,m.LitShaderOptions=Wo,m.LocalizedAsset=Sx,m.MASK_AFFECT_DYNAMIC=1,m.MASK_AFFECT_LIGHTMAPPED=2,m.MASK_BAKE=4,m.MOTION_FREE=ss,m.MOTION_LIMITED=as,m.MOTION_LOCKED=os,m.MOUSEBUTTON_LEFT=0,m.MOUSEBUTTON_MIDDLE=1,m.MOUSEBUTTON_NONE=-1,m.MOUSEBUTTON_RIGHT=2,m.Mat3=zt,m.Mat4=X,m.Material=Ci,m.MaterialHandler=xE,m.Mesh=ye,m.MeshInstance=De,m.MiniStats=FR,m.Model=cr,m.ModelComponent=Sc,m.ModelComponentSystem=Qx,m.ModelHandler=TE,m.Morph=ku,m.MorphInstance=na,m.MorphTarget=ud,m.Mouse=yi,m.MouseEvent=Xs,m.Node=Hu,m.NullGraphicsDevice=vv,m.ORIENTATION_HORIZONTAL=0,m.ORIENTATION_VERTICAL=1,m.OrientedBox=GC,m.OutlineRenderer=UR,m.PAD_1=0,m.PAD_2=1,m.PAD_3=2,m.PAD_4=3,m.PAD_DOWN=13,m.PAD_FACE_1=0,m.PAD_FACE_2=1,m.PAD_FACE_3=2,m.PAD_FACE_4=3,m.PAD_LEFT=14,m.PAD_L_SHOULDER_1=4,m.PAD_L_SHOULDER_2=6,m.PAD_L_STICK_BUTTON=10,m.PAD_L_STICK_X=0,m.PAD_L_STICK_Y=1,m.PAD_RIGHT=15,m.PAD_R_SHOULDER_1=5,m.PAD_R_SHOULDER_2=7,m.PAD_R_STICK_BUTTON=11,m.PAD_R_STICK_X=2,m.PAD_R_STICK_Y=3,m.PAD_SELECT=8,m.PAD_START=9,m.PAD_UP=12,m.PAD_VENDOR=16,m.PARTICLEMODE_CPU=1,m.PARTICLEMODE_GPU=0,m.PARTICLEORIENTATION_EMITTER=2,m.PARTICLEORIENTATION_SCREEN=0,m.PARTICLEORIENTATION_WORLD=1,m.PARTICLESORT_DISTANCE=1,m.PARTICLESORT_NEWER_FIRST=2,m.PARTICLESORT_NONE=0,m.PARTICLESORT_OLDER_FIRST=3,m.PIXELFORMAT_111110F=18,m.PIXELFORMAT_A8=0,m.PIXELFORMAT_ASTC_4x4=28,m.PIXELFORMAT_ASTC_4x4_SRGB=63,m.PIXELFORMAT_ATC_RGB=29,m.PIXELFORMAT_ATC_RGBA=30,m.PIXELFORMAT_BC6F=65,m.PIXELFORMAT_BC6UF=66,m.PIXELFORMAT_BC7=67,m.PIXELFORMAT_BC7_SRGBA=68,m.PIXELFORMAT_BGRA8=31,m.PIXELFORMAT_DEPTH=16,m.PIXELFORMAT_DEPTH16=69,m.PIXELFORMAT_DEPTHSTENCIL=17,m.PIXELFORMAT_DXT1=8,m.PIXELFORMAT_DXT1_SRGB=54,m.PIXELFORMAT_DXT3=9,m.PIXELFORMAT_DXT3_SRGBA=55,m.PIXELFORMAT_DXT5=10,m.PIXELFORMAT_DXT5_SRGBA=56,m.PIXELFORMAT_ETC1=21,m.PIXELFORMAT_ETC2_RGB=22,m.PIXELFORMAT_ETC2_RGBA=23,m.PIXELFORMAT_ETC2_SRGB=61,m.PIXELFORMAT_ETC2_SRGBA=62,m.PIXELFORMAT_L8=1,m.PIXELFORMAT_L8_A8=2,m.PIXELFORMAT_LA8=2,m.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,m.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,m.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,m.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,m.PIXELFORMAT_R16F=50,m.PIXELFORMAT_R16I=34,m.PIXELFORMAT_R16U=35,m.PIXELFORMAT_R32F=15,m.PIXELFORMAT_R32I=36,m.PIXELFORMAT_R32U=37,m.PIXELFORMAT_R4_G4_B4_A4=5,m.PIXELFORMAT_R5_G5_B5_A1=4,m.PIXELFORMAT_R5_G6_B5=3,m.PIXELFORMAT_R8=52,m.PIXELFORMAT_R8I=32,m.PIXELFORMAT_R8U=33,m.PIXELFORMAT_R8_G8_B8=6,m.PIXELFORMAT_R8_G8_B8_A8=7,m.PIXELFORMAT_RG16F=51,m.PIXELFORMAT_RG16I=40,m.PIXELFORMAT_RG16U=41,m.PIXELFORMAT_RG32I=42,m.PIXELFORMAT_RG32U=43,m.PIXELFORMAT_RG8=53,m.PIXELFORMAT_RG8I=38,m.PIXELFORMAT_RG8U=39,m.PIXELFORMAT_RGB16F=11,m.PIXELFORMAT_RGB32F=13,m.PIXELFORMAT_RGB565=3,m.PIXELFORMAT_RGB8=6,m.PIXELFORMAT_RGBA16F=12,m.PIXELFORMAT_RGBA16I=46,m.PIXELFORMAT_RGBA16U=47,m.PIXELFORMAT_RGBA32F=14,m.PIXELFORMAT_RGBA32I=48,m.PIXELFORMAT_RGBA32U=49,m.PIXELFORMAT_RGBA4=5,m.PIXELFORMAT_RGBA5551=4,m.PIXELFORMAT_RGBA8=7,m.PIXELFORMAT_RGBA8I=44,m.PIXELFORMAT_RGBA8U=45,m.PIXELFORMAT_SBGRA8=64,m.PIXELFORMAT_SRGB=19,m.PIXELFORMAT_SRGB8=19,m.PIXELFORMAT_SRGBA=20,m.PIXELFORMAT_SRGBA8=20,m.PRIMITIVE_LINELOOP=2,m.PRIMITIVE_LINES=1,m.PRIMITIVE_LINESTRIP=3,m.PRIMITIVE_POINTS=0,m.PRIMITIVE_TRIANGLES=4,m.PRIMITIVE_TRIFAN=6,m.PRIMITIVE_TRISTRIP=5,m.PROJECTION_ORTHOGRAPHIC=1,m.PROJECTION_PERSPECTIVE=0,m.ParticleEmitter=Oy,m.ParticleSystemComponent=$x,m.ParticleSystemComponentSystem=tb,m.Picker=wR,m.Plane=Yl,m.PlaneGeometry=Yo,m.PostEffect=Jy,m.PostEffectQueue=$b,m.ProgramLibrary=vS,m.QuadRender=Ys,m.Quat=Z,m.REFLECTIONSRC_CUBEMAP=Co,m.REFLECTIONSRC_ENVATLAS=wo,m.REFLECTIONSRC_ENVATLASHQ=Ao,m.REFLECTIONSRC_NONE=xi,m.REFLECTIONSRC_SPHEREMAP=Df,m.RENDERSTYLE_POINTS=2,m.RENDERSTYLE_SOLID=0,m.RENDERSTYLE_WIREFRAME=1,m.RESOLUTION_AUTO=Pd,m.RESOLUTION_FIXED=MS,m.RIGIDBODY_ACTIVE_TAG=1,m.RIGIDBODY_CF_KINEMATIC_OBJECT=2,m.RIGIDBODY_CF_NORESPONSE_OBJECT=4,m.RIGIDBODY_CF_STATIC_OBJECT=1,m.RIGIDBODY_DISABLE_DEACTIVATION=4,m.RIGIDBODY_DISABLE_SIMULATION=5,m.RIGIDBODY_ISLAND_SLEEPING=2,m.RIGIDBODY_TYPE_DYNAMIC=Jt,m.RIGIDBODY_TYPE_KINEMATIC=pr,m.RIGIDBODY_TYPE_STATIC=Sa,m.RIGIDBODY_WANTS_DEACTIVATION=3,m.Ray=Gn,m.RaycastResult=op,m.ReadStream=Oh,m.RenderComponent=rp,m.RenderComponentSystem=sb,m.RenderHandler=IT,m.RenderPass=ct,m.RenderPassBloom=VA,m.RenderPassCameraFrame=tC,m.RenderPassColorGrab=Bf,m.RenderPassCompose=GA,m.RenderPassDepthAwareBlur=vm,m.RenderPassDof=qA,m.RenderPassDownsample=ih,m.RenderPassForward=Uo,m.RenderPassPrepass=ZA,m.RenderPassShaderQuad=Oi,m.RenderPassSsao=$A,m.RenderPassTAA=WA,m.RenderPassUpsample=UA,m.RenderTarget=Ee,m.ResourceHandler=Oe,m.ResourceLoader=Dd,m.RigidBodyComponent=tn,m.RigidBodyComponentSystem=Ec,m.RotateGizmo=y3,m.SAMPLETYPE_DEPTH=2,m.SAMPLETYPE_FLOAT=0,m.SAMPLETYPE_INT=3,m.SAMPLETYPE_UINT=4,m.SAMPLETYPE_UNFILTERABLE_FLOAT=1,m.SCALEMODE_BLEND=db,m.SCALEMODE_NONE=us,m.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,m.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,m.SCROLL_MODE_BOUNCE=1,m.SCROLL_MODE_CLAMP=0,m.SCROLL_MODE_INFINITE=2,m.SEMANTIC_ATTR0=Zl,m.SEMANTIC_ATTR1=Ql,m.SEMANTIC_ATTR10=c_,m.SEMANTIC_ATTR11=h_,m.SEMANTIC_ATTR12=Jl,m.SEMANTIC_ATTR13=Rs,m.SEMANTIC_ATTR14=$l,m.SEMANTIC_ATTR15=Fr,m.SEMANTIC_ATTR2=jh,m.SEMANTIC_ATTR3=Xh,m.SEMANTIC_ATTR4=Yh,m.SEMANTIC_ATTR5=o_,m.SEMANTIC_ATTR6=l_,m.SEMANTIC_ATTR7=u_,m.SEMANTIC_ATTR8=Ds,m.SEMANTIC_ATTR9=Ms,m.SEMANTIC_BLENDINDICES=Pt,m.SEMANTIC_BLENDWEIGHT=fn,m.SEMANTIC_COLOR=st,m.SEMANTIC_NORMAL=bt,m.SEMANTIC_POSITION=oe,m.SEMANTIC_TANGENT=hn,m.SEMANTIC_TEXCOORD=Wh,m.SEMANTIC_TEXCOORD0=mt,m.SEMANTIC_TEXCOORD1=Hn,m.SEMANTIC_TEXCOORD2=Dr,m.SEMANTIC_TEXCOORD3=Mr,m.SEMANTIC_TEXCOORD4=Rr,m.SEMANTIC_TEXCOORD5=Or,m.SEMANTIC_TEXCOORD6=kr,m.SEMANTIC_TEXCOORD7=Nr,m.SHADERDEF_BATCH=16384,m.SHADERDEF_DIRLM=128,m.SHADERDEF_INSTANCING=32,m.SHADERDEF_LM=64,m.SHADERDEF_LMAMBIENT=4096,m.SHADERDEF_MORPH_NORMAL=2048,m.SHADERDEF_MORPH_POSITION=1024,m.SHADERDEF_MORPH_TEXTURE_BASED_INT=8192,m.SHADERDEF_NOSHADOW=1,m.SHADERDEF_SCREENSPACE=256,m.SHADERDEF_SKIN=2,m.SHADERDEF_TANGENTS=512,m.SHADERDEF_UV0=4,m.SHADERDEF_UV1=8,m.SHADERDEF_VCOLOR=16,m.SHADERLANGUAGE_GLSL=ue,m.SHADERLANGUAGE_WGSL=he,m.SHADERPASS_ALBEDO="debug_albedo",m.SHADERPASS_AO="debug_ao",m.SHADERPASS_EMISSION="debug_emission",m.SHADERPASS_FORWARD="forward",m.SHADERPASS_GLOSS="debug_gloss",m.SHADERPASS_LIGHTING="debug_lighting",m.SHADERPASS_METALNESS="debug_metalness",m.SHADERPASS_OPACITY="debug_opacity",m.SHADERPASS_SPECULARITY="debug_specularity",m.SHADERPASS_UV0="debug_uv0",m.SHADERPASS_WORLDNORMAL="debug_world_normal",m.SHADERSTAGE_COMPUTE=4,m.SHADERSTAGE_FRAGMENT=2,m.SHADERSTAGE_VERTEX=1,m.SHADERTAG_MATERIAL=1,m.SHADER_FORWARD=0,m.SHADER_PICK=3,m.SHADER_PREPASS=1,m.SHADER_SHADOW=2,m.SHADOWUPDATE_NONE=0,m.SHADOWUPDATE_REALTIME=2,m.SHADOWUPDATE_THISFRAME=1,m.SHADOW_PCF1=5,m.SHADOW_PCF1_16F=7,m.SHADOW_PCF1_32F=5,m.SHADOW_PCF3=0,m.SHADOW_PCF3_16F=8,m.SHADOW_PCF3_32F=0,m.SHADOW_PCF5=4,m.SHADOW_PCF5_16F=9,m.SHADOW_PCF5_32F=4,m.SHADOW_PCSS_32F=6,m.SHADOW_VSM16=2,m.SHADOW_VSM32=3,m.SHADOW_VSM_16F=2,m.SHADOW_VSM_32F=3,m.SKYTYPE_BOX="box",m.SKYTYPE_DOME=Qv,m.SKYTYPE_INFINITE=Po,m.SORTMODE_BACK2FRONT=3,m.SORTMODE_CUSTOM=5,m.SORTMODE_FRONT2BACK=4,m.SORTMODE_MANUAL=1,m.SORTMODE_MATERIALMESH=2,m.SORTMODE_NONE=0,m.SPECOCC_AO=1,m.SPECOCC_GLOSSDEPENDENT=2,m.SPECOCC_NONE=0,m.SPRITETYPE_ANIMATED=dp,m.SPRITETYPE_SIMPLE=fp,m.SPRITE_RENDERMODE_SIMPLE=0,m.SPRITE_RENDERMODE_SLICED=1,m.SPRITE_RENDERMODE_TILED=2,m.SSAOTYPE_COMBINE=kA,m.SSAOTYPE_LIGHTING=OA,m.SSAOTYPE_NONE=ys,m.STENCILOP_DECREMENT=5,m.STENCILOP_DECREMENTWRAP=6,m.STENCILOP_INCREMENT=3,m.STENCILOP_INCREMENTWRAP=4,m.STENCILOP_INVERT=7,m.STENCILOP_KEEP=0,m.STENCILOP_REPLACE=2,m.STENCILOP_ZERO=1,m.ScaleGizmo=T3,m.Scene=$e,m.SceneHandler=wE,m.SceneRegistry=r0,m.SceneRegistryItem=Md,m.SceneSettingsHandler=AR,m.ScopeId=y_,m.ScopeSpace=S_,m.ScreenComponent=lp,m.ScreenComponentSystem=gb,m.Script=ot,m.ScriptAttributes=yr,m.ScriptComponent=ti,m.ScriptComponentSystem=xT,m.ScriptHandler=IE,m.ScriptRegistry=e0,m.ScriptType=zi,m.ScrollViewComponent=cp,m.ScrollViewComponentSystem=Ab,m.ScrollbarComponent=hp,m.ScrollbarComponentSystem=Lb,m.Shader=rr,m.ShaderChunks=re,m.ShaderHandler=DE,m.ShaderMaterial=hr,m.ShaderPass=Ti,m.ShaderUtils=Te,m.SingleContactResult=ub,m.Skeleton=Wu,m.Skin=vd,m.SkinBatchInstance=kf,m.SkinInstance=qs,m.Sky=Gy,m.SortedLoopArray=Qa,m.Sound=Uv,m.SoundComponent=gr,m.SoundComponentSystem=Nb,m.SoundInstance=Yt,m.SoundInstance3d=zr,m.SoundManager=Fv,m.SoundSlot=nn,m.SphereGeometry=oa,m.Sprite=Ky,m.SpriteAnimationClip=rn,m.SpriteComponent=Bi,m.SpriteComponentSystem=Xb,m.SpriteHandler=RE,m.StandardMaterial=it,m.StandardMaterialOptions=Zr,m.StencilParameters=Xt,m.StorageBuffer=k1,m.TEXHINT_ASSET=2,m.TEXHINT_LIGHTMAP=3,m.TEXHINT_NONE=0,m.TEXHINT_SHADOWMAP=1,m.TEXPROPERTY_ADDRESS_U=4,m.TEXPROPERTY_ADDRESS_V=8,m.TEXPROPERTY_ADDRESS_W=16,m.TEXPROPERTY_ALL=255,m.TEXPROPERTY_ANISOTROPY=128,m.TEXPROPERTY_COMPARE_FUNC=64,m.TEXPROPERTY_COMPARE_ON_READ=32,m.TEXPROPERTY_MAG_FILTER=2,m.TEXPROPERTY_MIN_FILTER=1,m.TEXTUREDIMENSION_1D="1d",m.TEXTUREDIMENSION_2D="2d",m.TEXTUREDIMENSION_2D_ARRAY=jn,m.TEXTUREDIMENSION_3D="3d",m.TEXTUREDIMENSION_CUBE=Xn,m.TEXTUREDIMENSION_CUBE_ARRAY=oo,m.TEXTURELOCK_NONE=0,m.TEXTURELOCK_READ=1,m.TEXTURELOCK_WRITE=2,m.TEXTUREPROJECTION_CUBE=eu,m.TEXTUREPROJECTION_EQUIRECT=qh,m.TEXTUREPROJECTION_NONE=f_,m.TEXTUREPROJECTION_OCTAHEDRAL=d_,m.TEXTURETYPE_DEFAULT=Wt,m.TEXTURETYPE_RGBE=ao,m.TEXTURETYPE_RGBM=Wn,m.TEXTURETYPE_RGBP=Os,m.TEXTURETYPE_SWIZZLEGGGR=ks,m.TONEMAP_ACES=3,m.TONEMAP_ACES2=4,m.TONEMAP_FILMIC=1,m.TONEMAP_HEJL=2,m.TONEMAP_LINEAR=0,m.TONEMAP_NEUTRAL=5,m.TONEMAP_NONE=6,m.TRACEID_BINDGROUPFORMAT_ALLOC="BindGroupFormatAlloc",m.TRACEID_BINDGROUP_ALLOC="BindGroupAlloc",m.TRACEID_COMPUTEPIPELINE_ALLOC="ComputePipelineAlloc",m.TRACEID_ELEMENT="Element",m.TRACEID_GPU_TIMINGS=Vm,m.TRACEID_PIPELINELAYOUT_ALLOC="PipelineLayoutAlloc",m.TRACEID_RENDERPIPELINE_ALLOC="RenderPipelineAlloc",m.TRACEID_RENDER_ACTION="RenderAction",m.TRACEID_RENDER_FRAME="RenderFrame",m.TRACEID_RENDER_FRAME_TIME="RenderFrameTime",m.TRACEID_RENDER_PASS="RenderPass",m.TRACEID_RENDER_PASS_DETAIL="RenderPassDetail",m.TRACEID_RENDER_QUEUE="RenderQueue",m.TRACEID_RENDER_TARGET_ALLOC="RenderTargetAlloc",m.TRACEID_SHADER_ALLOC="ShaderAlloc",m.TRACEID_SHADER_COMPILE="ShaderCompile",m.TRACEID_TEXTURES="Textures",m.TRACEID_TEXTURE_ALLOC="TextureAlloc",m.TRACEID_VRAM_IB="VRAM.Ib",m.TRACEID_VRAM_SB="VRAM.Sb",m.TRACEID_VRAM_TEXTURE="VRAM.Texture",m.TRACEID_VRAM_VB="VRAM.Vb",m.TYPE_FLOAT16=7,m.TYPE_FLOAT32=6,m.TYPE_INT16=2,m.TYPE_INT32=4,m.TYPE_INT8=0,m.TYPE_UINT16=3,m.TYPE_UINT32=5,m.TYPE_UINT8=1,m.Tags=Ls,m.Template=Op,m.TemplateHandler=kE,m.TextElement=Ax,m.TextHandler=FE,m.Texture=ee,m.TextureAtlas=Qy,m.TextureAtlasHandler=BE,m.TextureHandler=sw,m.TextureUtils=En,m.TorusGeometry=ma,m.Touch=wf,m.TouchDevice=Eo,m.TouchEvent=To,m.Tracing=Wl,m.TransformFeedback=N1,m.TransformGizmo=ht,m.TranslateGizmo=v3,m.Tri=i_,m.UNIFORMTYPE_BOOL=0,m.UNIFORMTYPE_BOOLARRAY=32,m.UNIFORMTYPE_BVEC2=9,m.UNIFORMTYPE_BVEC2ARRAY=35,m.UNIFORMTYPE_BVEC3=10,m.UNIFORMTYPE_BVEC3ARRAY=38,m.UNIFORMTYPE_BVEC4=11,m.UNIFORMTYPE_BVEC4ARRAY=41,m.UNIFORMTYPE_FLOAT=2,m.UNIFORMTYPE_FLOATARRAY=17,m.UNIFORMTYPE_INT=1,m.UNIFORMTYPE_INTARRAY=30,m.UNIFORMTYPE_ITEXTURE2D=42,m.UNIFORMTYPE_ITEXTURE2D_ARRAY=48,m.UNIFORMTYPE_ITEXTURE3D=46,m.UNIFORMTYPE_ITEXTURECUBE=44,m.UNIFORMTYPE_IVEC2=6,m.UNIFORMTYPE_IVEC2ARRAY=33,m.UNIFORMTYPE_IVEC3=7,m.UNIFORMTYPE_IVEC3ARRAY=36,m.UNIFORMTYPE_IVEC4=8,m.UNIFORMTYPE_IVEC4ARRAY=39,m.UNIFORMTYPE_MAT2=12,m.UNIFORMTYPE_MAT3=13,m.UNIFORMTYPE_MAT4=14,m.UNIFORMTYPE_MAT4ARRAY=24,m.UNIFORMTYPE_TEXTURE2D=15,m.UNIFORMTYPE_TEXTURE2D_ARRAY=25,m.UNIFORMTYPE_TEXTURE2D_SHADOW=18,m.UNIFORMTYPE_TEXTURE3D=20,m.UNIFORMTYPE_TEXTURECUBE=16,m.UNIFORMTYPE_TEXTURECUBE_SHADOW=19,m.UNIFORMTYPE_UINT=26,m.UNIFORMTYPE_UINTARRAY=31,m.UNIFORMTYPE_UTEXTURE2D=43,m.UNIFORMTYPE_UTEXTURE2D_ARRAY=49,m.UNIFORMTYPE_UTEXTURE3D=47,m.UNIFORMTYPE_UTEXTURECUBE=45,m.UNIFORMTYPE_UVEC2=27,m.UNIFORMTYPE_UVEC2ARRAY=34,m.UNIFORMTYPE_UVEC3=28,m.UNIFORMTYPE_UVEC3ARRAY=37,m.UNIFORMTYPE_UVEC4=29,m.UNIFORMTYPE_UVEC4ARRAY=40,m.UNIFORMTYPE_VEC2=3,m.UNIFORMTYPE_VEC2ARRAY=21,m.UNIFORMTYPE_VEC3=4,m.UNIFORMTYPE_VEC3ARRAY=22,m.UNIFORMTYPE_VEC4=5,m.UNIFORMTYPE_VEC4ARRAY=23,m.UNIFORM_BUFFER_DEFAULT_SLOT_NAME=ho,m.UNUSED_UNIFORM_NAME=tu,m.URI=Hl,m.UniformBufferFormat=Gs,m.UniformFormat=Le,m.UsdzExporter=ZR,m.VIEW_CENTER=0,m.VIEW_LEFT=1,m.VIEW_RIGHT=2,m.Vec2=G,m.Vec3=E,m.Vec4=q,m.VertexBuffer=Rt,m.VertexFormat=Ot,m.VertexIterator=js,m.ViewCube=PC,m.WasmModule=Rh,m.WebglGraphicsDevice=vf,m.WebgpuGraphicsDevice=rv,m.WorldClusters=Iu,m.XRDEPTHSENSINGFORMAT_F32=Wp,m.XRDEPTHSENSINGFORMAT_L8A8=Gp,m.XRDEPTHSENSINGFORMAT_R16U=Hp,m.XRDEPTHSENSINGUSAGE_CPU=uw,m.XRDEPTHSENSINGUSAGE_GPU=zp,m.XREYE_LEFT="left",m.XREYE_NONE="none",m.XREYE_RIGHT="right",m.XRHAND_LEFT=lw,m.XRHAND_NONE="none",m.XRHAND_RIGHT="right",m.XRPAD_A=4,m.XRPAD_B=5,m.XRPAD_SQUEEZE=1,m.XRPAD_STICK_BUTTON=3,m.XRPAD_STICK_X=2,m.XRPAD_STICK_Y=3,m.XRPAD_TOUCHPAD_BUTTON=2,m.XRPAD_TOUCHPAD_X=0,m.XRPAD_TOUCHPAD_Y=1,m.XRPAD_TRIGGER=0,m.XRSPACE_BOUNDEDFLOOR="bounded-floor",m.XRSPACE_LOCAL="local",m.XRSPACE_LOCALFLOOR="local-floor",m.XRSPACE_UNBOUNDED="unbounded",m.XRSPACE_VIEWER=Vp,m.XRTARGETRAY_GAZE="gaze",m.XRTARGETRAY_POINTER="tracked-pointer",m.XRTARGETRAY_SCREEN="screen",m.XRTRACKABLE_MESH="mesh",m.XRTRACKABLE_PLANE="plane",m.XRTRACKABLE_POINT="point",m.XRTYPE_AR=Da,m.XRTYPE_INLINE=aw,m.XRTYPE_VR=ow,m.XrAnchor=Oa,m.XrAnchors=ms,m.XrDomOverlay=cw,m.XrFinger=_w,m.XrHand=zc,m.XrHitTest=Tr,m.XrHitTestSource=Fc,m.XrImageTracking=jp,m.XrInput=ni,m.XrInputSource=Lt,m.XrJoint=Yp,m.XrLightEstimation=Gc,m.XrManager=_s,m.XrMeshDetection=ka,m.XrPlane=Hc,m.XrPlaneDetection=Ra,m.XrTrackedImage=Uc,m.XrView=Qp,m.XrViews=Tl,m.ZoneComponent=hs,m.ZoneComponentSystem=Jb,m.ambientSrcNames=Kv,m.basisInitialize=zE,m.bindGroupNames=$h,m.blendNames=Pf,m.calculateNormals=dd,m.calculateTangents=Ri,m.createBox=function(o,a){return ye.fromGeometry(o,new fr(a))},m.createCapsule=function(o,a){return ye.fromGeometry(o,new wd(a))},m.createCone=function(o,a){return ye.fromGeometry(o,new Xo(a))},m.createCylinder=function(o,a){return ye.fromGeometry(o,new pa(a))},m.createGraphicsDevice=function(o,a){a===void 0&&(a={});var i=(n=a.deviceTypes)!=null?n:[];i.includes(lo)||i.push(lo),i.includes(uo)||i.push(uo),fe.browser&&navigator.xr&&((r=a).xrCompatible!=null||(r.xrCompatible=!0));for(var t=[],e=0;e<i.length;e++){var n,r,s,l,u=i[e];u===Jh&&(!((l=window)==null||(s=l.navigator)==null)&&s.gpu)&&t.push(function(){return new rv(o,a).initWebGpu(a.glslangUrl,a.twgslUrl)}),u===lo&&t.push(function(){return new vf(o,a)}),u===uo&&t.push(function(){return new vv(o,a)})}return new Promise(function(c,h){var f=0,d=function(){f>=t.length?h(Error("Failed to create a graphics device")):Promise.resolve(t[f++]()).then(function(p){p?c(p):d()}).catch(function(p){d()})};d()})},m.createMesh=function(o,a,i){i===void 0&&(i={});var t=new Ft;return t.positions=a,t.normals=i.normals,t.tangents=i.tangents,t.colors=i.colors,t.uvs=i.uvs,t.uvs1=i.uvs1,t.blendIndices=i.blendIndices,t.blendWeights=i.blendWeights,t.indices=i.indices,ye.fromGeometry(o,t,i)},m.createPlane=function(o,a){return ye.fromGeometry(o,new Yo(a))},m.createScript=AE,m.createShader=function(o,a,i,t,e){},m.createShaderFromCode=function(o,a,i,t,e,n,r){if(n===void 0&&(n=!1),r===void 0&&(r={}),typeof n=="boolean")r.useTransformFeedback=n;else{var s;(n===void 0?"undefined":(s=n)&&typeof Symbol<"u"&&s.constructor===Symbol?"symbol":typeof s)=="object"&&(r=Mf({},r,n))}var l=sr(o),u=l.getCachedShader(t);return u||(u=new rr(o,ir.createDefinition(o,Mf({},r,{name:t,vertexCode:a,fragmentCode:i,attributes:e}))),l.setCachedShader(t,u)),u},m.createSphere=function(o,a){return ye.fromGeometry(o,new oa(a))},m.createTorus=function(o,a){return ye.fromGeometry(o,new ma(a))},m.createURI=function(o){var a="";if((o.authority||o.scheme)&&(o.host||o.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(o.host&&o.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(o.path&&o.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return o.scheme&&(a+=""+o.scheme+":"),o.authority&&(a+="//"+o.authority),o.host&&(a+=o.host),o.path&&(a+=o.path),o.hostpath&&(a+=o.hostpath),o.query&&(a+="?"+o.query),o.fragment&&(a+="#"+o.fragment),a},m.cubemaProjectionNames=Xv,m.ditherNames=tg,m.dracoInitialize=function(o){o!=null&&o.lazyInit?Ph=o:LT(o)},m.drawFullscreenQuad=function(o,a,i,t,e){var n;if(e){var r=a?a.width:o.width,s=a?a.height:o.height;n=IR.set(e.x*r,e.y*s,e.z*r,e.w*s)}kt(o,a,t,n)},m.drawQuadWithShader=kt,m.extend=Ka,m.fresnelNames=Hv,m.gammaNames=Lf,m.getPixelFormatArrayType=Hh,m.getReservedScriptNames=function(){return Lp},m.getTouchTargetCoords=bo,m.guid=Gm,m.http=Fe,m.isCompressedPixelFormat=io,m.isIntegerPixelFormat=mi,m.isSrgbPixelFormat=ro,m.lightFalloffNames=jv,m.lightShapeNames=Wv,m.lightTypeNames=If,m.math=U,m.now=un,m.path=ce,m.pixelFormatGammaToLinear=s_,m.pixelFormatInfo=Ht,m.pixelFormatLinearToGamma=so,m.platform=fe,m.reflectionSrcNames=qv,m.registerScript=Dp,m.reprojectTexture=Jn,m.requiresManualGamma=a_,m.revision=zm,m.script=Id,m.semanticToLocation=me,m.shaderChunks=LR,m.shadowTypeInfo=qn,m.specularOcclusionNames=Yv,m.spriteRenderModeNames=Zv,m.string=er,m.tonemapNames=gu,m.typedArrayIndexFormats=fo,m.typedArrayIndexFormatsByteSize=p_,m.typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},m.typedArrayTypes=Ur,m.typedArrayTypesByteSize=Ns,m.uniformTypeToName=Kh,m.uniformTypeToNameMapWGSL=Qh,m.uniformTypeToNameWGSL=Zh,m.uniformTypeToStorage=HC,m.version=Dh,m.vertexTypesNames=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"]},(typeof bh>"u"?"undefined":(Lm=bh)&&typeof Symbol<"u"&&Lm.constructor===Symbol?"symbol":typeof Lm)=="object"&&typeof LC<"u"?xh(bh):typeof define=="function"&&define.amd?define(["exports"],xh):xh((Im=typeof globalThis<"u"?globalThis:Im||self).pc={})});export default O3();
